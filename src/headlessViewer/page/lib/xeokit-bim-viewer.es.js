var e = {};

// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

// resolves . and .. elements in a path array with directory names there
// must be no slashes, empty elements, or device names (c:\) in the array
// (so also no leading and trailing slashes - it does not distinguish
// relative and absolute paths)
function normalizeArray(parts, allowAboveRoot) {
  // if the path tries to go above the root, `up` ends up > 0
  var up = 0;
  for (var i = parts.length - 1; i >= 0; i--) {
    var last = parts[i];
    if (last === '.') {
      parts.splice(i, 1);
    } else if (last === '..') {
      parts.splice(i, 1);
      up++;
    } else if (up) {
      parts.splice(i, 1);
      up--;
    }
  }

  // if the path is allowed to go above the root, restore leading ..s
  if (allowAboveRoot) {
    for (; up--; up) {
      parts.unshift('..');
    }
  }

  return parts;
}

// Split a filename into [root, dir, basename, ext], unix version
// 'root' is just a slash, or nothing.
var splitPathRe =
    /^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;
var splitPath = function(filename) {
  return splitPathRe.exec(filename).slice(1);
};

// path.resolve([from ...], to)
// posix version
function resolve() {
  var resolvedPath = '',
      resolvedAbsolute = false;

  for (var i = arguments.length - 1; i >= -1 && !resolvedAbsolute; i--) {
    var path = (i >= 0) ? arguments[i] : '/';

    // Skip empty and invalid entries
    if (typeof path !== 'string') {
      throw new TypeError('Arguments to path.resolve must be strings');
    } else if (!path) {
      continue;
    }

    resolvedPath = path + '/' + resolvedPath;
    resolvedAbsolute = path.charAt(0) === '/';
  }

  // At this point the path should be resolved to a full absolute path, but
  // handle relative paths to be safe (might happen when process.cwd() fails)

  // Normalize the path
  resolvedPath = normalizeArray(filter(resolvedPath.split('/'), function(p) {
    return !!p;
  }), !resolvedAbsolute).join('/');

  return ((resolvedAbsolute ? '/' : '') + resolvedPath) || '.';
}
// path.normalize(path)
// posix version
function normalize(path) {
  var isPathAbsolute = isAbsolute(path),
      trailingSlash = substr(path, -1) === '/';

  // Normalize the path
  path = normalizeArray(filter(path.split('/'), function(p) {
    return !!p;
  }), !isPathAbsolute).join('/');

  if (!path && !isPathAbsolute) {
    path = '.';
  }
  if (path && trailingSlash) {
    path += '/';
  }

  return (isPathAbsolute ? '/' : '') + path;
}
// posix version
function isAbsolute(path) {
  return path.charAt(0) === '/';
}

// posix version
function join() {
  var paths = Array.prototype.slice.call(arguments, 0);
  return normalize(filter(paths, function(p, index) {
    if (typeof p !== 'string') {
      throw new TypeError('Arguments to path.join must be strings');
    }
    return p;
  }).join('/'));
}


// path.relative(from, to)
// posix version
function relative(from, to) {
  from = resolve(from).substr(1);
  to = resolve(to).substr(1);

  function trim(arr) {
    var start = 0;
    for (; start < arr.length; start++) {
      if (arr[start] !== '') break;
    }

    var end = arr.length - 1;
    for (; end >= 0; end--) {
      if (arr[end] !== '') break;
    }

    if (start > end) return [];
    return arr.slice(start, end - start + 1);
  }

  var fromParts = trim(from.split('/'));
  var toParts = trim(to.split('/'));

  var length = Math.min(fromParts.length, toParts.length);
  var samePartsLength = length;
  for (var i = 0; i < length; i++) {
    if (fromParts[i] !== toParts[i]) {
      samePartsLength = i;
      break;
    }
  }

  var outputParts = [];
  for (var i = samePartsLength; i < fromParts.length; i++) {
    outputParts.push('..');
  }

  outputParts = outputParts.concat(toParts.slice(samePartsLength));

  return outputParts.join('/');
}

var sep = '/';
var delimiter = ':';

function dirname(path) {
  var result = splitPath(path),
      root = result[0],
      dir = result[1];

  if (!root && !dir) {
    // No dirname whatsoever
    return '.';
  }

  if (dir) {
    // It has a dirname, strip trailing slash
    dir = dir.substr(0, dir.length - 1);
  }

  return root + dir;
}

function basename(path, ext) {
  var f = splitPath(path)[2];
  // TODO: make this comparison case-insensitive on windows?
  if (ext && f.substr(-1 * ext.length) === ext) {
    f = f.substr(0, f.length - ext.length);
  }
  return f;
}


function extname(path) {
  return splitPath(path)[3];
}
var t = {
  extname: extname,
  basename: basename,
  dirname: dirname,
  sep: sep,
  delimiter: delimiter,
  relative: relative,
  join: join,
  isAbsolute: isAbsolute,
  normalize: normalize,
  resolve: resolve
};
function filter (xs, f) {
    if (xs.filter) return xs.filter(f);
    var res = [];
    for (var i = 0; i < xs.length; i++) {
        if (f(xs[i], i, xs)) res.push(xs[i]);
    }
    return res;
}

// String.prototype.substr - negative index don't work in IE8
var substr = 'ab'.substr(-1) === 'b' ?
    function (str, start, len) { return str.substr(start, len) } :
    function (str, start, len) {
        if (start < 0) start = str.length + start;
        return str.substr(start, len);
    }
;

class s{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1;}addItem(){let e;if(2===arguments.length){const t=arguments[0];if(e=arguments[1],this.items[t])throw "ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const i=new s;class r{constructor(e){this.id=e,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0;}}class o{constructor(){this.items=[];}}class n{constructor(e,t,s,i,r){this.id=e,this.getTitle=t,this.doAction=s,this.getEnabled=i,this.getShown=r,this.itemElement=null,this.subMenu=null,this.enabled=!0;}}class a{constructor(e={}){this._id=i.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},!1!==e.hideOnMouseDown&&(document.addEventListener("mousedown",(e=>{e.target.classList.contains("xeokit-context-menu-item")||this.hide();})),document.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{e.target.classList.contains("xeokit-context-menu-item")||this.hide();})),e.items&&(this.items=e.items),this.context=e.context,this.enabled=!1!==e.enabled,this.hide();}on(e,t){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(t);}fire(e,t){const s=this._eventSubs[e];if(s)for(let e=0,i=s.length;e<i;e++)s[e](t);}set items(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI();}get items(){return this._itemsCfg}set enabled(e){(e=!!e)!==this._enabled&&(this._enabled=e,this._enabled||this.hide());}get enabled(){return this._enabled}set context(e){this._context=e;}get context(){return this._context}show(e,t){this._context?this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,t),this._shown=!0,this.fire("shown",{}))):console.error("ContextMenu cannot be shown without a context - set context first");}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}));}destroy(){this._context=null,this._clear(),null!==this._id&&(i.removeItem(this._id),this._id=null);}_clear(){for(let e=0,t=this._menuList.length;e<t;e++){const t=this._menuList[e].menuElement;t.parentElement.removeChild(t);}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={};}_parseItems(e){const t=e=>{const s=this._getNextId(),i=new r(s);for(let s=0,r=e.length;s<r;s++){const r=e[s],a=new o;i.groups.push(a);for(let e=0,s=r.length;e<s;e++){const s=r[e],o=s.items,h=o&&o.length>0,l=this._getNextId(),u=s.getTitle||(()=>s.title||""),c=s.doAction||s.callback||(()=>{}),p=s.getEnabled||(()=>!0),d=s.getShown||(()=>!0),f=new n(l,u,c,p,d);if(f.parentMenu=i,a.items.push(f),h){const e=t(o);f.subMenu=e,e.parentItem=f;}this._itemList.push(f),this._itemMap[f.id]=f;}}return this._menuList.push(i),this._menuMap[i.id]=i,i};this._rootMenu=t(e);}_getNextId(){return "ContextMenu_"+this._id+this._nextId++}_createUI(){const e=t=>{this._createMenuUI(t);const s=t.groups;for(let t=0,i=s.length;t<i;t++){const i=s[t].items;for(let t=0,s=i.length;t<s;t++){const s=i[t].subMenu;s&&e(s);}}};e(this._rootMenu);}_createMenuUI(e){const t=e.groups,s=[];if(s.push('<div class="xeokit-context-menu '+e.id+'" style="z-index:300000; position: absolute;">'),s.push("<ul>"),t)for(let e=0,i=t.length;e<i;e++){const r=e,o=i,n=t[e].items;if(n)for(let e=0,t=n.length;e<t;e++){const i=n[e],a=i.subMenu,h=i.title||"";a?s.push('<li id="'+i.id+'" class="xeokit-context-menu-item" style="'+(r===o-1||e<t-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+h+" [MORE]</li>"):s.push('<li id="'+i.id+'" class="xeokit-context-menu-item" style="'+(r===o-1||e<t-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+h+"</li>");}}s.push("</ul>"),s.push("</div>");const i=s.join("");document.body.insertAdjacentHTML("beforeend",i);const r=document.querySelector("."+e.id);e.menuElement=r,r.style["border-radius"]="4px",r.style.display="none",r.style["z-index"]=3e5,r.style.background="white",r.style.border="1px solid black",r.style["box-shadow"]="0 4px 5px 0 gray",r.oncontextmenu=e=>{e.preventDefault();};const o=this;let n=null;if(t)for(let e=0,s=t.length;e<s;e++){const s=t[e].items;if(s)for(let e=0,t=s.length;e<t;e++){const t=s[e],i=t.subMenu;t.itemElement=document.getElementById(t.id),t.itemElement?(t.itemElement.addEventListener("mouseenter",(e=>{if(e.preventDefault(),!1===t.enabled)return;const s=t.subMenu;if(!s)return void(n&&(o._hideMenu(n.id),n=null));n&&n.id!==s.id&&(o._hideMenu(n.id),n=null);const i=t.itemElement,r=s.menuElement,a=i.getBoundingClientRect();r.getBoundingClientRect();a.right+200>window.innerWidth?o._showMenu(s.id,a.left-200,a.top-1):o._showMenu(s.id,a.right-5,a.top-1),n=s;})),i||(t.itemElement.addEventListener("click",(e=>{e.preventDefault(),o.hide(),o._context&&!1!==t.enabled&&t.doAction&&t.doAction(o._context);})),t.itemElement.addEventListener("mouseenter",(e=>{e.preventDefault(),!1!==t.enabled&&t.doHover&&t.doHover(o._context);})))):console.error("ContextMenu item element not found: "+t.id);}}}_updateItemsTitles(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const t=this._itemList[e],s=t.itemElement;if(!s)continue;const i=t.getShown;if(!i||!i(this._context))continue;const r=t.getTitle(this._context);t.subMenu,s.innerText=r;}}_updateItemsEnabledStatus(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const t=this._itemList[e],s=t.itemElement;if(!s)continue;const i=t.getEnabled;if(!i)continue;const r=t.getShown;if(!r)continue;const o=r(this._context);if(t.shown=o,!o){s.style.visibility="hidden",s.style.height="0",s.style.padding="0";continue}s.style.visibility="visible",s.style.height="auto",s.style.padding=null;const n=i(this._context);t.enabled=n,n?s.classList.remove("disabled"):s.classList.add("disabled");}}_showMenu(e,t,s){const i=this._menuMap[e];if(!i)return void console.error("Menu not found: "+e);if(i.shown)return;const r=i.menuElement;r&&(this._showMenuElement(r,t,s),i.shown=!0);}_hideMenu(e){const t=this._menuMap[e];if(!t)return void console.error("Menu not found: "+e);if(!t.shown)return;const s=t.menuElement;s&&(this._hideMenuElement(s),t.shown=!1);}_hideAllMenus(){for(let e=0,t=this._menuList.length;e<t;e++){const t=this._menuList[e];this._hideMenu(t.id);}}_showMenuElement(e,t,s){e.style.display="block";const i=e.offsetHeight,r=e.offsetWidth;s+i>window.innerHeight&&(s=window.innerHeight-i),t+r>window.innerWidth&&(t=window.innerWidth-r),e.style.left=t+"px",e.style.top=s+"px";}_hideMenuElement(e){e.style.display="none";}}class h{constructor(e,t,s){this.id=s&&s.id?s.id:e,this.viewer=t,this._eventSubs={},t.addPlugin(this);}on(e,t){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(t);}fire(e,t){const s=this._eventSubs[e];if(s)for(let e=0,i=s.length;e<i;e++)s[e](t);}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`);}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`);}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`);}send(e,t){}destroy(){this.viewer.removePlugin(this);}}let l=!0,u=l?Float64Array:Float32Array;const c=new u(16),p=new u(16),d=new u(4),f={setDoublePrecisionEnabled(e){l=e,u=l?Float64Array:Float32Array;},getDoublePrecisionEnabled:()=>l,MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(e,t){const s=t.indexOf("#");return s===e.length&&t.startsWith(e)?t.substring(s+1):t},globalizeObjectId:(e,t)=>e+"#"+t,vec2:e=>new u(e||2),vec3:e=>new u(e||3),vec4:e=>new u(e||4),mat3:e=>new u(e||9),mat3ToMat4:(e,t=new u(16))=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),mat4:e=>new u(e||16),mat4ToMat3(e,t){},doublesToFloats(e,t,s){const i=new u(2);for(let r=0,o=e.length;r<o;r++)f.splitDouble(e[r],i),t[r]=i[0],s[r]=i[1];},splitDouble(e,t){const s=u.from([e])[0],i=e-s;t[0]=s,t[1]=i;},createUUID:(()=>{const e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return ()=>{const t=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return `${e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]}-${e[255&s]}${e[s>>8&255]}-${e[s>>16&15|64]}${e[s>>24&255]}-${e[63&i|128]}${e[i>>8&255]}-${e[i>>16&255]}${e[i>>24&255]}${e[255&r]}${e[r>>8&255]}${e[r>>16&255]}${e[r>>24&255]}`}})(),clamp:(e,t,s)=>Math.max(t,Math.min(s,e)),fmod(e,t){if(e<t)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},compareVec3:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2],negateVec3:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t),negateVec4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t),addVec4:(e,t,s)=>(s||(s=e),s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s),addVec4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]+t,s[1]=e[1]+t,s[2]=e[2]+t,s[3]=e[3]+t,s),addVec3:(e,t,s)=>(s||(s=e),s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s),addVec3Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]+t,s[1]=e[1]+t,s[2]=e[2]+t,s),subVec4:(e,t,s)=>(s||(s=e),s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s[3]=e[3]-t[3],s),subVec3:(e,t,s)=>(s||(s=e),s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s),subVec2:(e,t,s)=>(s||(s=e),s[0]=e[0]-t[0],s[1]=e[1]-t[1],s),geometricMeanVec2(...e){const t=new u(e[0]);for(let s=1;s<e.length;s++)t[0]+=e[s][0],t[1]+=e[s][1];return t[0]/=e.length,t[1]/=e.length,t},subVec4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]-t,s[1]=e[1]-t,s[2]=e[2]-t,s[3]=e[3]-t,s),subScalarVec4:(e,t,s)=>(s||(s=e),s[0]=t-e[0],s[1]=t-e[1],s[2]=t-e[2],s[3]=t-e[3],s),mulVec4:(e,t,s)=>(s||(s=e),s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s[3]=e[3]*t[3],s),mulVec4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s),mulVec3Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s),mulVec2Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]*t,s[1]=e[1]*t,s),divVec3:(e,t,s)=>(s||(s=e),s[0]=e[0]/t[0],s[1]=e[1]/t[1],s[2]=e[2]/t[2],s),divVec4:(e,t,s)=>(s||(s=e),s[0]=e[0]/t[0],s[1]=e[1]/t[1],s[2]=e[2]/t[2],s[3]=e[3]/t[3],s),divScalarVec3:(e,t,s)=>(s||(s=t),s[0]=e/t[0],s[1]=e/t[1],s[2]=e/t[2],s),divVec3Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]/t,s[1]=e[1]/t,s[2]=e[2]/t,s),divVec4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]/t,s[1]=e[1]/t,s[2]=e[2]/t,s[3]=e[3]/t,s),divScalarVec4:(e,t,s)=>(s||(s=t),s[0]=e/t[0],s[1]=e/t[1],s[2]=e/t[2],s[3]=e/t[3],s),dotVec4:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],cross3Vec4(e,t){const s=e[0],i=e[1],r=e[2],o=t[0],n=t[1],a=t[2];return [i*a-r*n,r*o-s*a,s*n-i*o,0]},cross3Vec3(e,t,s){s||(s=e);const i=e[0],r=e[1],o=e[2],n=t[0],a=t[1],h=t[2];return s[0]=r*h-o*a,s[1]=o*n-i*h,s[2]=i*a-r*n,s},sqLenVec4:e=>f.dotVec4(e,e),lenVec4:e=>Math.sqrt(f.sqLenVec4(e)),dotVec3:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],dotVec2:(e,t)=>e[0]*t[0]+e[1]*t[1],sqLenVec3:e=>f.dotVec3(e,e),sqLenVec2:e=>f.dotVec2(e,e),lenVec3:e=>Math.sqrt(f.sqLenVec3(e)),distVec3:(()=>{const e=new u(3);return (t,s)=>f.lenVec3(f.subVec3(t,s,e))})(),lenVec2:e=>Math.sqrt(f.sqLenVec2(e)),distVec2:(()=>{const e=new u(2);return (t,s)=>f.lenVec2(f.subVec2(t,s,e))})(),rcpVec3:(e,t)=>f.divScalarVec3(1,e,t),normalizeVec4(e,t){const s=1/f.lenVec4(e);return f.mulVec4Scalar(e,s,t)},normalizeVec3(e,t){const s=1/f.lenVec3(e);return f.mulVec3Scalar(e,s,t)},normalizeVec2(e,t){const s=1/f.lenVec2(e);return f.mulVec2Scalar(e,s,t)},angleVec3(e,t){let s=f.dotVec3(e,t)/Math.sqrt(f.sqLenVec3(e)*f.sqLenVec3(t));return s=s<-1?-1:s>1?1:s,Math.acos(s)},vec3FromMat4Scale:(()=>{const e=new u(3);return (t,s)=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],s[0]=f.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],s[1]=f.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],s[2]=f.lenVec3(e),s)})(),vecToArray:(()=>{function e(e){return Math.round(1e5*e)/1e5}return t=>{for(let s=0,i=(t=Array.prototype.slice.call(t)).length;s<i;s++)t[s]=e(t[s]);return t}})(),xyzArrayToObject:e=>({x:e[0],y:e[1],z:e[2]}),xyzObjectToArray:(e,t)=>((t=t||f.vec3())[0]=e.x,t[1]=e.y,t[2]=e.z,t),dupMat4:e=>e.slice(0,16),mat4To3:e=>[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]],m4s:e=>[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],setMat4ToZeroes:()=>f.m4s(0),setMat4ToOnes:()=>f.m4s(1),diagonalMat4v:e=>new u([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]),diagonalMat4c:(e,t,s,i)=>f.diagonalMat4v([e,t,s,i]),diagonalMat4s:e=>f.diagonalMat4c(e,e,e,e),identityMat4:(e=new u(16))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),identityMat3:(e=new u(9))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e),isIdentityMat4:e=>1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15],negateMat4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t),addMat4:(e,t,s)=>(s||(s=e),s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s[4]=e[4]+t[4],s[5]=e[5]+t[5],s[6]=e[6]+t[6],s[7]=e[7]+t[7],s[8]=e[8]+t[8],s[9]=e[9]+t[9],s[10]=e[10]+t[10],s[11]=e[11]+t[11],s[12]=e[12]+t[12],s[13]=e[13]+t[13],s[14]=e[14]+t[14],s[15]=e[15]+t[15],s),addMat4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]+t,s[1]=e[1]+t,s[2]=e[2]+t,s[3]=e[3]+t,s[4]=e[4]+t,s[5]=e[5]+t,s[6]=e[6]+t,s[7]=e[7]+t,s[8]=e[8]+t,s[9]=e[9]+t,s[10]=e[10]+t,s[11]=e[11]+t,s[12]=e[12]+t,s[13]=e[13]+t,s[14]=e[14]+t,s[15]=e[15]+t,s),addScalarMat4:(e,t,s)=>f.addMat4Scalar(t,e,s),subMat4:(e,t,s)=>(s||(s=e),s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s[3]=e[3]-t[3],s[4]=e[4]-t[4],s[5]=e[5]-t[5],s[6]=e[6]-t[6],s[7]=e[7]-t[7],s[8]=e[8]-t[8],s[9]=e[9]-t[9],s[10]=e[10]-t[10],s[11]=e[11]-t[11],s[12]=e[12]-t[12],s[13]=e[13]-t[13],s[14]=e[14]-t[14],s[15]=e[15]-t[15],s),subMat4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]-t,s[1]=e[1]-t,s[2]=e[2]-t,s[3]=e[3]-t,s[4]=e[4]-t,s[5]=e[5]-t,s[6]=e[6]-t,s[7]=e[7]-t,s[8]=e[8]-t,s[9]=e[9]-t,s[10]=e[10]-t,s[11]=e[11]-t,s[12]=e[12]-t,s[13]=e[13]-t,s[14]=e[14]-t,s[15]=e[15]-t,s),subScalarMat4:(e,t,s)=>(s||(s=t),s[0]=e-t[0],s[1]=e-t[1],s[2]=e-t[2],s[3]=e-t[3],s[4]=e-t[4],s[5]=e-t[5],s[6]=e-t[6],s[7]=e-t[7],s[8]=e-t[8],s[9]=e-t[9],s[10]=e-t[10],s[11]=e-t[11],s[12]=e-t[12],s[13]=e-t[13],s[14]=e-t[14],s[15]=e-t[15],s),mulMat4(e,t,s){s||(s=e);const i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],u=e[7],c=e[8],p=e[9],d=e[10],f=e[11],m=e[12],g=e[13],_=e[14],y=e[15],v=t[0],b=t[1],w=t[2],P=t[3],T=t[4],x=t[5],M=t[6],D=t[7],A=t[8],C=t[9],I=t[10],F=t[11],B=t[12],E=t[13],S=t[14],R=t[15];return s[0]=v*i+b*a+w*c+P*m,s[1]=v*r+b*h+w*p+P*g,s[2]=v*o+b*l+w*d+P*_,s[3]=v*n+b*u+w*f+P*y,s[4]=T*i+x*a+M*c+D*m,s[5]=T*r+x*h+M*p+D*g,s[6]=T*o+x*l+M*d+D*_,s[7]=T*n+x*u+M*f+D*y,s[8]=A*i+C*a+I*c+F*m,s[9]=A*r+C*h+I*p+F*g,s[10]=A*o+C*l+I*d+F*_,s[11]=A*n+C*u+I*f+F*y,s[12]=B*i+E*a+S*c+R*m,s[13]=B*r+E*h+S*p+R*g,s[14]=B*o+E*l+S*d+R*_,s[15]=B*n+E*u+S*f+R*y,s},mulMat3(e,t,s){s||(s=new u(9));const i=e[0],r=e[3],o=e[6],n=e[1],a=e[4],h=e[7],l=e[2],c=e[5],p=e[8],d=t[0],f=t[3],m=t[6],g=t[1],_=t[4],y=t[7],v=t[2],b=t[5],w=t[8];return s[0]=i*d+r*g+o*v,s[3]=i*f+r*_+o*b,s[6]=i*m+r*y+o*w,s[1]=n*d+a*g+h*v,s[4]=n*f+a*_+h*b,s[7]=n*m+a*y+h*w,s[2]=l*d+c*g+p*v,s[5]=l*f+c*_+p*b,s[8]=l*m+c*y+p*w,s},mulMat4Scalar:(e,t,s)=>(s||(s=e),s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s[4]=e[4]*t,s[5]=e[5]*t,s[6]=e[6]*t,s[7]=e[7]*t,s[8]=e[8]*t,s[9]=e[9]*t,s[10]=e[10]*t,s[11]=e[11]*t,s[12]=e[12]*t,s[13]=e[13]*t,s[14]=e[14]*t,s[15]=e[15]*t,s),mulMat4v4(e,t,s=f.vec4()){const i=t[0],r=t[1],o=t[2],n=t[3];return s[0]=e[0]*i+e[4]*r+e[8]*o+e[12]*n,s[1]=e[1]*i+e[5]*r+e[9]*o+e[13]*n,s[2]=e[2]*i+e[6]*r+e[10]*o+e[14]*n,s[3]=e[3]*i+e[7]*r+e[11]*o+e[15]*n,s},transposeMat4(e,t){const s=e[4],i=e[14],r=e[8],o=e[13],n=e[12],a=e[9];if(!t||e===t){const t=e[1],h=e[2],l=e[3],u=e[6],c=e[7],p=e[11];return e[1]=s,e[2]=r,e[3]=n,e[4]=t,e[6]=a,e[7]=o,e[8]=h,e[9]=u,e[11]=i,e[12]=l,e[13]=c,e[14]=p,e}return t[0]=e[0],t[1]=s,t[2]=r,t[3]=n,t[4]=e[1],t[5]=e[5],t[6]=a,t[7]=o,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=i,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3(e,t){if(t===e){const s=e[1],i=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=s,t[5]=e[7],t[6]=i,t[7]=r;}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4(e){const t=e[0],s=e[1],i=e[2],r=e[3],o=e[4],n=e[5],a=e[6],h=e[7],l=e[8],u=e[9],c=e[10],p=e[11],d=e[12],f=e[13],m=e[14],g=e[15];return d*u*a*r-l*f*a*r-d*n*c*r+o*f*c*r+l*n*m*r-o*u*m*r-d*u*i*h+l*f*i*h+d*s*c*h-t*f*c*h-l*s*m*h+t*u*m*h+d*n*i*p-o*f*i*p-d*s*a*p+t*f*a*p+o*s*m*p-t*n*m*p-l*n*i*g+o*u*i*g+l*s*a*g-t*u*a*g-o*s*c*g+t*n*c*g},inverseMat4(e,t){t||(t=e);const s=e[0],i=e[1],r=e[2],o=e[3],n=e[4],a=e[5],h=e[6],l=e[7],u=e[8],c=e[9],p=e[10],d=e[11],f=e[12],m=e[13],g=e[14],_=e[15],y=s*a-i*n,v=s*h-r*n,b=s*l-o*n,w=i*h-r*a,P=i*l-o*a,T=r*l-o*h,x=u*m-c*f,M=u*g-p*f,D=u*_-d*f,A=c*g-p*m,C=c*_-d*m,I=p*_-d*g,F=1/(y*I-v*C+b*A+w*D-P*M+T*x);return t[0]=(a*I-h*C+l*A)*F,t[1]=(-i*I+r*C-o*A)*F,t[2]=(m*T-g*P+_*w)*F,t[3]=(-c*T+p*P-d*w)*F,t[4]=(-n*I+h*D-l*M)*F,t[5]=(s*I-r*D+o*M)*F,t[6]=(-f*T+g*b-_*v)*F,t[7]=(u*T-p*b+d*v)*F,t[8]=(n*C-a*D+l*x)*F,t[9]=(-s*C+i*D-o*x)*F,t[10]=(f*P-m*b+_*y)*F,t[11]=(-u*P+c*b-d*y)*F,t[12]=(-n*A+a*M-h*x)*F,t[13]=(s*A-i*M+r*x)*F,t[14]=(-f*w+m*v-g*y)*F,t[15]=(u*w-c*v+p*y)*F,t},traceMat4:e=>e[0]+e[5]+e[10]+e[15],translationMat4v(e,t){const s=t||f.identityMat4();return s[12]=e[0],s[13]=e[1],s[14]=e[2],s},translationMat3v(e,t){const s=t||f.identityMat3();return s[6]=e[0],s[7]=e[1],s},translationMat4c:(()=>{const e=new u(3);return (t,s,i,r)=>(e[0]=t,e[1]=s,e[2]=i,f.translationMat4v(e,r))})(),translationMat4s:(e,t)=>f.translationMat4c(e,e,e,t),translateMat4v:(e,t)=>f.translateMat4c(e[0],e[1],e[2],t),translateMat4c(e,t,s,i){const r=i[3];i[0]+=r*e,i[1]+=r*t,i[2]+=r*s;const o=i[7];i[4]+=o*e,i[5]+=o*t,i[6]+=o*s;const n=i[11];i[8]+=n*e,i[9]+=n*t,i[10]+=n*s;const a=i[15];return i[12]+=a*e,i[13]+=a*t,i[14]+=a*s,i},setMat4Translation:(e,t,s)=>(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=t[0],s[13]=t[1],s[14]=t[2],s[15]=e[15],s),rotationMat4v(e,t,s){const i=f.normalizeVec4([t[0],t[1],t[2],0],[]),r=Math.sin(e),o=Math.cos(e),n=1-o,a=i[0],h=i[1],l=i[2];let u,c,p,d,m,g;return u=a*h,c=h*l,p=l*a,d=a*r,m=h*r,g=l*r,(s=s||f.mat4())[0]=n*a*a+o,s[1]=n*u+g,s[2]=n*p-m,s[3]=0,s[4]=n*u-g,s[5]=n*h*h+o,s[6]=n*c+d,s[7]=0,s[8]=n*p+m,s[9]=n*c-d,s[10]=n*l*l+o,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s},rotationMat4c:(e,t,s,i,r)=>f.rotationMat4v(e,[t,s,i],r),scalingMat4v:(e,t=f.identityMat4())=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scalingMat3v:(e,t=f.identityMat3())=>(t[0]=e[0],t[4]=e[1],t),scalingMat4c:(()=>{const e=new u(3);return (t,s,i,r)=>(e[0]=t,e[1]=s,e[2]=i,f.scalingMat4v(e,r))})(),scaleMat4c:(e,t,s,i)=>(i[0]*=e,i[4]*=t,i[8]*=s,i[1]*=e,i[5]*=t,i[9]*=s,i[2]*=e,i[6]*=t,i[10]*=s,i[3]*=e,i[7]*=t,i[11]*=s,i),scaleMat4v(e,t){const s=e[0],i=e[1],r=e[2];return t[0]*=s,t[4]*=i,t[8]*=r,t[1]*=s,t[5]*=i,t[9]*=r,t[2]*=s,t[6]*=i,t[10]*=r,t[3]*=s,t[7]*=i,t[11]*=r,t},scalingMat4s:e=>f.scalingMat4c(e,e,e),rotationTranslationMat4(e,t,s=f.mat4()){const i=e[0],r=e[1],o=e[2],n=e[3],a=i+i,h=r+r,l=o+o,u=i*a,c=i*h,p=i*l,d=r*h,m=r*l,g=o*l,_=n*a,y=n*h,v=n*l;return s[0]=1-(d+g),s[1]=c+v,s[2]=p-y,s[3]=0,s[4]=c-v,s[5]=1-(u+g),s[6]=m+_,s[7]=0,s[8]=p+y,s[9]=m-_,s[10]=1-(u+d),s[11]=0,s[12]=t[0],s[13]=t[1],s[14]=t[2],s[15]=1,s},mat4ToEuler(e,t,s=f.vec4()){const i=f.clamp,r=e[0],o=e[4],n=e[8],a=e[1],h=e[5],l=e[9],u=e[2],c=e[6],p=e[10];return "XYZ"===t?(s[1]=Math.asin(i(n,-1,1)),Math.abs(n)<.99999?(s[0]=Math.atan2(-l,p),s[2]=Math.atan2(-o,r)):(s[0]=Math.atan2(c,h),s[2]=0)):"YXZ"===t?(s[0]=Math.asin(-i(l,-1,1)),Math.abs(l)<.99999?(s[1]=Math.atan2(n,p),s[2]=Math.atan2(a,h)):(s[1]=Math.atan2(-u,r),s[2]=0)):"ZXY"===t?(s[0]=Math.asin(i(c,-1,1)),Math.abs(c)<.99999?(s[1]=Math.atan2(-u,p),s[2]=Math.atan2(-o,h)):(s[1]=0,s[2]=Math.atan2(a,r))):"ZYX"===t?(s[1]=Math.asin(-i(u,-1,1)),Math.abs(u)<.99999?(s[0]=Math.atan2(c,p),s[2]=Math.atan2(a,r)):(s[0]=0,s[2]=Math.atan2(-o,h))):"YZX"===t?(s[2]=Math.asin(i(a,-1,1)),Math.abs(a)<.99999?(s[0]=Math.atan2(-l,h),s[1]=Math.atan2(-u,r)):(s[0]=0,s[1]=Math.atan2(n,p))):"XZY"===t&&(s[2]=Math.asin(-i(o,-1,1)),Math.abs(o)<.99999?(s[0]=Math.atan2(c,h),s[1]=Math.atan2(n,r)):(s[0]=Math.atan2(-l,p),s[1]=0)),s},composeMat4:(e,t,s,i=f.mat4())=>(f.quaternionToRotationMat4(t,i),f.scaleMat4v(s,i),f.translateMat4v(e,i),i),decomposeMat4:(()=>{const e=new u(3),t=new u(16);return function(s,i,r,o){e[0]=s[0],e[1]=s[1],e[2]=s[2];let n=f.lenVec3(e);e[0]=s[4],e[1]=s[5],e[2]=s[6];const a=f.lenVec3(e);e[8]=s[8],e[9]=s[9],e[10]=s[10];const h=f.lenVec3(e);f.determinantMat4(s)<0&&(n=-n),i[0]=s[12],i[1]=s[13],i[2]=s[14],t.set(s);const l=1/n,u=1/a,c=1/h;return t[0]*=l,t[1]*=l,t[2]*=l,t[4]*=u,t[5]*=u,t[6]*=u,t[8]*=c,t[9]*=c,t[10]*=c,f.mat4ToQuaternion(t,r),o[0]=n,o[1]=a,o[2]=h,this}})(),getColMat4(e,t){const s=4*t;return [e[s],e[s+1],e[s+2],e[s+3]]},setRowMat4(e,t,s){e[t]=s[0],e[t+4]=s[1],e[t+8]=s[2],e[t+12]=s[3];},lookAtMat4v(e,t,s,i){i||(i=f.mat4());const r=e[0],o=e[1],n=e[2],a=s[0],h=s[1],l=s[2],u=t[0],c=t[1],p=t[2];if(r===u&&o===c&&n===p)return f.identityMat4();let d,m,g,_,y,v,b,w,P,T;return d=r-u,m=o-c,g=n-p,T=1/Math.sqrt(d*d+m*m+g*g),d*=T,m*=T,g*=T,_=h*g-l*m,y=l*d-a*g,v=a*m-h*d,T=Math.sqrt(_*_+y*y+v*v),T?(T=1/T,_*=T,y*=T,v*=T):(_=0,y=0,v=0),b=m*v-g*y,w=g*_-d*v,P=d*y-m*_,T=Math.sqrt(b*b+w*w+P*P),T?(T=1/T,b*=T,w*=T,P*=T):(b=0,w=0,P=0),i[0]=_,i[1]=b,i[2]=d,i[3]=0,i[4]=y,i[5]=w,i[6]=m,i[7]=0,i[8]=v,i[9]=P,i[10]=g,i[11]=0,i[12]=-(_*r+y*o+v*n),i[13]=-(b*r+w*o+P*n),i[14]=-(d*r+m*o+g*n),i[15]=1,i},lookAtMat4c:(e,t,s,i,r,o,n,a,h)=>f.lookAtMat4v([e,t,s],[i,r,o],[n,a,h],[]),orthoMat4c(e,t,s,i,r,o,n){n||(n=f.mat4());const a=t-e,h=i-s,l=o-r;return n[0]=2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/h,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/l,n[11]=0,n[12]=-(e+t)/a,n[13]=-(i+s)/h,n[14]=-(o+r)/l,n[15]=1,n},frustumMat4v(e,t,s){s||(s=f.mat4());const i=[e[0],e[1],e[2],0],r=[t[0],t[1],t[2],0];f.addVec4(r,i,c),f.subVec4(r,i,p);const o=2*i[2],n=p[0],a=p[1],h=p[2];return s[0]=o/n,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o/a,s[6]=0,s[7]=0,s[8]=c[0]/n,s[9]=c[1]/a,s[10]=-c[2]/h,s[11]=-1,s[12]=0,s[13]=0,s[14]=-o*r[2]/h,s[15]=0,s},frustumMat4(e,t,s,i,r,o,n){n||(n=f.mat4());const a=t-e,h=i-s,l=o-r;return n[0]=2*r/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/h,n[6]=0,n[7]=0,n[8]=(t+e)/a,n[9]=(i+s)/h,n[10]=-(o+r)/l,n[11]=-1,n[12]=0,n[13]=0,n[14]=-o*r*2/l,n[15]=0,n},perspectiveMat4(e,t,s,i,r){const o=[],n=[];return o[2]=s,n[2]=i,n[1]=o[2]*Math.tan(e/2),o[1]=-n[1],n[0]=n[1]*t,o[0]=-n[0],f.frustumMat4v(o,n,r)},compareMat4:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15],transformPoint3(e,t,s=f.vec3()){const i=t[0],r=t[1],o=t[2];return s[0]=e[0]*i+e[4]*r+e[8]*o+e[12],s[1]=e[1]*i+e[5]*r+e[9]*o+e[13],s[2]=e[2]*i+e[6]*r+e[10]*o+e[14],s},transformPoint4:(e,t,s=f.vec4())=>(s[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],s[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],s[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],s[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],s),transformPoints3(e,t,s){const i=s||[],r=t.length;let o,n,a,h;const l=e[0],u=e[1],c=e[2],p=e[3],d=e[4],f=e[5],m=e[6],g=e[7],_=e[8],y=e[9],v=e[10],b=e[11],w=e[12],P=e[13],T=e[14],x=e[15];let M;for(let e=0;e<r;++e)h=t[e],o=h[0],n=h[1],a=h[2],M=i[e]||(i[e]=[0,0,0]),M[0]=l*o+d*n+_*a+w,M[1]=u*o+f*n+y*a+P,M[2]=c*o+m*n+v*a+T,M[3]=p*o+g*n+b*a+x;return i.length=r,i},transformPositions3(e,t,s=t){let i;const r=t.length;let o,n,a;const h=e[0],l=e[1],u=e[2];e[3];const c=e[4],p=e[5],d=e[6];e[7];const f=e[8],m=e[9],g=e[10];e[11];const _=e[12],y=e[13],v=e[14];for(e[15],i=0;i<r;i+=3)o=t[i+0],n=t[i+1],a=t[i+2],s[i+0]=h*o+c*n+f*a+_,s[i+1]=l*o+p*n+m*a+y,s[i+2]=u*o+d*n+g*a+v;return s},transformPositions4(e,t,s=t){let i;const r=t.length;let o,n,a;const h=e[0],l=e[1],u=e[2],c=e[3],p=e[4],d=e[5],f=e[6],m=e[7],g=e[8],_=e[9],y=e[10],v=e[11],b=e[12],w=e[13],P=e[14],T=e[15];for(i=0;i<r;i+=4)o=t[i+0],n=t[i+1],a=t[i+2],s[i+0]=h*o+p*n+g*a+b,s[i+1]=l*o+d*n+_*a+w,s[i+2]=u*o+f*n+y*a+P,s[i+3]=c*o+m*n+v*a+T;return s},transformVec3(e,t,s){const i=t[0],r=t[1],o=t[2];return (s=s||this.vec3())[0]=e[0]*i+e[4]*r+e[8]*o,s[1]=e[1]*i+e[5]*r+e[9]*o,s[2]=e[2]*i+e[6]*r+e[10]*o,s},transformVec4(e,t,s){const i=t[0],r=t[1],o=t[2],n=t[3];return (s=s||f.vec4())[0]=e[0]*i+e[4]*r+e[8]*o+e[12]*n,s[1]=e[1]*i+e[5]*r+e[9]*o+e[13]*n,s[2]=e[2]*i+e[6]*r+e[10]*o+e[14]*n,s[3]=e[3]*i+e[7]*r+e[11]*o+e[15]*n,s},rotateVec2(e,t,s,i=e){const r=Math.cos(s),o=Math.sin(s),n=e[0]-t[0],a=e[1]-t[1];return i[0]=n*r-a*o+t[0],i[1]=n*o+a*r+t[1],e},rotateVec3X(e,t,s,i){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[0],o[1]=r[1]*Math.cos(s)-r[2]*Math.sin(s),o[2]=r[1]*Math.sin(s)+r[2]*Math.cos(s),i[0]=o[0]+t[0],i[1]=o[1]+t[1],i[2]=o[2]+t[2],i},rotateVec3Y(e,t,s,i){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[2]*Math.sin(s)+r[0]*Math.cos(s),o[1]=r[1],o[2]=r[2]*Math.cos(s)-r[0]*Math.sin(s),i[0]=o[0]+t[0],i[1]=o[1]+t[1],i[2]=o[2]+t[2],i},rotateVec3Z(e,t,s,i){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[0]*Math.cos(s)-r[1]*Math.sin(s),o[1]=r[0]*Math.sin(s)+r[1]*Math.cos(s),o[2]=r[2],i[0]=o[0]+t[0],i[1]=o[1]+t[1],i[2]=o[2]+t[2],i},projectVec4(e,t){const s=1/e[3];return (t=t||f.vec2())[0]=e[0]*s,t[1]=e[1]*s,t},unprojectVec3:(()=>{const e=new u(16),t=new u(16),s=new u(16);return function(i,r,o,n){return this.transformVec3(this.mulMat4(this.inverseMat4(r,e),this.inverseMat4(o,t),s),i,n)}})(),lerpVec3(e,t,s,i,r,o){const n=o||f.vec3(),a=(e-t)/(s-t);return n[0]=i[0]+a*(r[0]-i[0]),n[1]=i[1]+a*(r[1]-i[1]),n[2]=i[2]+a*(r[2]-i[2]),n},lerpMat4(e,t,s,i,r,o){const n=o||f.mat4(),a=(e-t)/(s-t);return n[0]=i[0]+a*(r[0]-i[0]),n[1]=i[1]+a*(r[1]-i[1]),n[2]=i[2]+a*(r[2]-i[2]),n[3]=i[3]+a*(r[3]-i[3]),n[4]=i[4]+a*(r[4]-i[4]),n[5]=i[5]+a*(r[5]-i[5]),n[6]=i[6]+a*(r[6]-i[6]),n[7]=i[7]+a*(r[7]-i[7]),n[8]=i[8]+a*(r[8]-i[8]),n[9]=i[9]+a*(r[9]-i[9]),n[10]=i[10]+a*(r[10]-i[10]),n[11]=i[11]+a*(r[11]-i[11]),n[12]=i[12]+a*(r[12]-i[12]),n[13]=i[13]+a*(r[13]-i[13]),n[14]=i[14]+a*(r[14]-i[14]),n[15]=i[15]+a*(r[15]-i[15]),n},flatten(e){const t=[];let s,i,r,o,n;for(s=0,i=e.length;s<i;s++)for(n=e[s],r=0,o=n.length;r<o;r++)t.push(n[r]);return t},identityQuaternion:(e=f.vec4())=>(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e),eulerToQuaternion(e,t,s=f.vec4()){const i=e[0]*f.DEGTORAD/2,r=e[1]*f.DEGTORAD/2,o=e[2]*f.DEGTORAD/2,n=Math.cos(i),a=Math.cos(r),h=Math.cos(o),l=Math.sin(i),u=Math.sin(r),c=Math.sin(o);return "XYZ"===t?(s[0]=l*a*h+n*u*c,s[1]=n*u*h-l*a*c,s[2]=n*a*c+l*u*h,s[3]=n*a*h-l*u*c):"YXZ"===t?(s[0]=l*a*h+n*u*c,s[1]=n*u*h-l*a*c,s[2]=n*a*c-l*u*h,s[3]=n*a*h+l*u*c):"ZXY"===t?(s[0]=l*a*h-n*u*c,s[1]=n*u*h+l*a*c,s[2]=n*a*c+l*u*h,s[3]=n*a*h-l*u*c):"ZYX"===t?(s[0]=l*a*h-n*u*c,s[1]=n*u*h+l*a*c,s[2]=n*a*c-l*u*h,s[3]=n*a*h+l*u*c):"YZX"===t?(s[0]=l*a*h+n*u*c,s[1]=n*u*h+l*a*c,s[2]=n*a*c-l*u*h,s[3]=n*a*h-l*u*c):"XZY"===t&&(s[0]=l*a*h-n*u*c,s[1]=n*u*h-l*a*c,s[2]=n*a*c+l*u*h,s[3]=n*a*h+l*u*c),s},mat4ToQuaternion(e,t=f.vec4()){const s=e[0],i=e[4],r=e[8],o=e[1],n=e[5],a=e[9],h=e[2],l=e[6],u=e[10];let c;const p=s+n+u;return p>0?(c=.5/Math.sqrt(p+1),t[3]=.25/c,t[0]=(l-a)*c,t[1]=(r-h)*c,t[2]=(o-i)*c):s>n&&s>u?(c=2*Math.sqrt(1+s-n-u),t[3]=(l-a)/c,t[0]=.25*c,t[1]=(i+o)/c,t[2]=(r+h)/c):n>u?(c=2*Math.sqrt(1+n-s-u),t[3]=(r-h)/c,t[0]=(i+o)/c,t[1]=.25*c,t[2]=(a+l)/c):(c=2*Math.sqrt(1+u-s-n),t[3]=(o-i)/c,t[0]=(r+h)/c,t[1]=(a+l)/c,t[2]=.25*c),t},vec3PairToQuaternion(e,t,s=f.vec4()){const i=Math.sqrt(f.dotVec3(e,e)*f.dotVec3(t,t));let r=i+f.dotVec3(e,t);return r<1e-8*i?(r=0,Math.abs(e[0])>Math.abs(e[2])?(s[0]=-e[1],s[1]=e[0],s[2]=0):(s[0]=0,s[1]=-e[2],s[2]=e[1])):f.cross3Vec3(e,t,s),s[3]=r,f.normalizeQuaternion(s)},angleAxisToQuaternion(e,t=f.vec4()){const s=e[3]/2,i=Math.sin(s);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(s),t},quaternionToEuler:(()=>{const e=new u(16);return (t,s,i)=>(i=i||f.vec3(),f.quaternionToRotationMat4(t,e),f.mat4ToEuler(e,s,i),i)})(),mulQuaternions(e,t,s=f.vec4()){const i=e[0],r=e[1],o=e[2],n=e[3],a=t[0],h=t[1],l=t[2],u=t[3];return s[0]=n*a+i*u+r*l-o*h,s[1]=n*h+r*u+o*a-i*l,s[2]=n*l+o*u+i*h-r*a,s[3]=n*u-i*a-r*h-o*l,s},vec3ApplyQuaternion(e,t,s=f.vec3()){const i=t[0],r=t[1],o=t[2],n=e[0],a=e[1],h=e[2],l=e[3],u=l*i+a*o-h*r,c=l*r+h*i-n*o,p=l*o+n*r-a*i,d=-n*i-a*r-h*o;return s[0]=u*l+d*-n+c*-h-p*-a,s[1]=c*l+d*-a+p*-n-u*-h,s[2]=p*l+d*-h+u*-a-c*-n,s},quaternionToMat4(e,t){t=f.identityMat4(t);const s=e[0],i=e[1],r=e[2],o=e[3],n=2*s,a=2*i,h=2*r,l=n*o,u=a*o,c=h*o,p=n*s,d=a*s,m=h*s,g=a*i,_=h*i,y=h*r;return t[0]=1-(g+y),t[1]=d+c,t[2]=m-u,t[4]=d-c,t[5]=1-(p+y),t[6]=_+l,t[8]=m+u,t[9]=_-l,t[10]=1-(p+g),t},quaternionToRotationMat4(e,t){const s=e[0],i=e[1],r=e[2],o=e[3],n=s+s,a=i+i,h=r+r,l=s*n,u=s*a,c=s*h,p=i*a,d=i*h,f=r*h,m=o*n,g=o*a,_=o*h;return t[0]=1-(p+f),t[4]=u-_,t[8]=c+g,t[1]=u+_,t[5]=1-(l+f),t[9]=d-m,t[2]=c-g,t[6]=d+m,t[10]=1-(l+p),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion(e,t=e){const s=f.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/s,t[1]=e[1]/s,t[2]=e[2]/s,t[3]=e[3]/s,t},conjugateQuaternion:(e,t=e)=>(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t),inverseQuaternion:(e,t)=>f.normalizeQuaternion(f.conjugateQuaternion(e,t)),quaternionToAngleAxis(e,t=f.vec4()){const s=(e=f.normalizeQuaternion(e,d))[3],i=2*Math.acos(s),r=Math.sqrt(1-s*s);return r<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t[3]=i,t},AABB3:e=>new u(e||6),AABB2:e=>new u(e||4),OBB3:e=>new u(e||32),OBB2:e=>new u(e||16),Sphere3:(e,t,s,i)=>new u([e,t,s,i]),transformOBB3(e,t,s=t){let i;const r=t.length;let o,n,a;const h=e[0],l=e[1],u=e[2],c=e[3],p=e[4],d=e[5],f=e[6],m=e[7],g=e[8],_=e[9],y=e[10],v=e[11],b=e[12],w=e[13],P=e[14],T=e[15];for(i=0;i<r;i+=4)o=t[i+0],n=t[i+1],a=t[i+2],s[i+0]=h*o+p*n+g*a+b,s[i+1]=l*o+d*n+_*a+w,s[i+2]=u*o+f*n+y*a+P,s[i+3]=c*o+m*n+v*a+T;return s},containsAABB3:function(e,t){return e[0]<=t[0]&&t[3]<=e[3]&&e[1]<=t[1]&&t[4]<=e[4]&&e[2]<=t[2]&&t[5]<=e[5]},getAABB3Diag:(()=>{const e=new u(3),t=new u(3),s=new u(3);return i=>(e[0]=i[0],e[1]=i[1],e[2]=i[2],t[0]=i[3],t[1]=i[4],t[2]=i[5],f.subVec3(t,e,s),Math.abs(f.lenVec3(s)))})(),getAABB3DiagPoint:(()=>{const e=new u(3),t=new u(3),s=new u(3);return (i,r)=>{e[0]=i[0],e[1]=i[1],e[2]=i[2],t[0]=i[3],t[1]=i[4],t[2]=i[5];const o=f.subVec3(t,e,s),n=r[0]-i[0],a=i[3]-r[0],h=r[1]-i[1],l=i[4]-r[1],u=r[2]-i[2],c=i[5]-r[2];return o[0]+=n>a?n:a,o[1]+=h>l?h:l,o[2]+=u>c?u:c,Math.abs(f.lenVec3(o))}})(),getAABB3Area:e=>(e[3]-e[0])*(e[4]-e[1])*(e[5]-e[2]),getAABB3Center(e,t){const s=t||f.vec3();return s[0]=(e[0]+e[3])/2,s[1]=(e[1]+e[4])/2,s[2]=(e[2]+e[5])/2,s},getAABB2Center(e,t){const s=t||f.vec2();return s[0]=(e[2]+e[0])/2,s[1]=(e[3]+e[1])/2,s},collapseAABB3:(e=f.AABB3())=>(e[0]=f.MAX_DOUBLE,e[1]=f.MAX_DOUBLE,e[2]=f.MAX_DOUBLE,e[3]=f.MIN_DOUBLE,e[4]=f.MIN_DOUBLE,e[5]=f.MIN_DOUBLE,e),AABB3ToOBB3:(e,t=f.OBB3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t),positions3ToAABB3:(()=>{const e=new u(3);return (t,s,i)=>{s=s||f.AABB3();let r,o,n,a=f.MAX_DOUBLE,h=f.MAX_DOUBLE,l=f.MAX_DOUBLE,u=f.MIN_DOUBLE,c=f.MIN_DOUBLE,p=f.MIN_DOUBLE;for(let s=0,d=t.length;s<d;s+=3)i?(e[0]=t[s+0],e[1]=t[s+1],e[2]=t[s+2],f.decompressPosition(e,i,e),r=e[0],o=e[1],n=e[2]):(r=t[s+0],o=t[s+1],n=t[s+2]),r<a&&(a=r),o<h&&(h=o),n<l&&(l=n),r>u&&(u=r),o>c&&(c=o),n>p&&(p=n);return s[0]=a,s[1]=h,s[2]=l,s[3]=u,s[4]=c,s[5]=p,s}})(),OBB3ToAABB3(e,t=f.AABB3()){let s,i,r,o=f.MAX_DOUBLE,n=f.MAX_DOUBLE,a=f.MAX_DOUBLE,h=f.MIN_DOUBLE,l=f.MIN_DOUBLE,u=f.MIN_DOUBLE;for(let t=0,c=e.length;t<c;t+=4)s=e[t+0],i=e[t+1],r=e[t+2],s<o&&(o=s),i<n&&(n=i),r<a&&(a=r),s>h&&(h=s),i>l&&(l=i),r>u&&(u=r);return t[0]=o,t[1]=n,t[2]=a,t[3]=h,t[4]=l,t[5]=u,t},points3ToAABB3(e,t=f.AABB3()){let s,i,r,o=f.MAX_DOUBLE,n=f.MAX_DOUBLE,a=f.MAX_DOUBLE,h=f.MIN_DOUBLE,l=f.MIN_DOUBLE,u=f.MIN_DOUBLE;for(let t=0,c=e.length;t<c;t++)s=e[t][0],i=e[t][1],r=e[t][2],s<o&&(o=s),i<n&&(n=i),r<a&&(a=r),s>h&&(h=s),i>l&&(l=i),r>u&&(u=r);return t[0]=o,t[1]=n,t[2]=a,t[3]=h,t[4]=l,t[5]=u,t},points3ToSphere3:(()=>{const e=new u(3);return (t,s)=>{s=s||f.vec4();let i,r=0,o=0,n=0;const a=t.length;for(i=0;i<a;i++)r+=t[i][0],o+=t[i][1],n+=t[i][2];s[0]=r/a,s[1]=o/a,s[2]=n/a;let h,l=0;for(i=0;i<a;i++)h=Math.abs(f.lenVec3(f.subVec3(t[i],s,e))),h>l&&(l=h);return s[3]=l,s}})(),positions3ToSphere3:(()=>{const e=new u(3),t=new u(3);return (s,i)=>{i=i||f.vec4();let r,o=0,n=0,a=0;const h=s.length;let l=0;for(r=0;r<h;r+=3)o+=s[r],n+=s[r+1],a+=s[r+2];const u=h/3;let c;for(i[0]=o/u,i[1]=n/u,i[2]=a/u,r=0;r<h;r+=3)e[0]=s[r],e[1]=s[r+1],e[2]=s[r+2],c=Math.abs(f.lenVec3(f.subVec3(e,i,t))),c>l&&(l=c);return i[3]=l,i}})(),OBB3ToSphere3:(()=>{const e=new u(3),t=new u(3);return (s,i)=>{i=i||f.vec4();let r,o=0,n=0,a=0;const h=s.length,l=h/4;for(r=0;r<h;r+=4)o+=s[r+0],n+=s[r+1],a+=s[r+2];i[0]=o/l,i[1]=n/l,i[2]=a/l;let u,c=0;for(r=0;r<h;r+=4)e[0]=s[r+0],e[1]=s[r+1],e[2]=s[r+2],u=Math.abs(f.lenVec3(f.subVec3(e,i,t))),u>c&&(c=u);return i[3]=c,i}})(),getSphere3Center:(e,t=f.vec3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),getPositionsCenter(e,t=f.vec3()){let s=0,i=0,r=0;for(var o=0,n=e.length;o<n;o+=3)s+=e[o+0],i+=e[o+1],r+=e[o+2];const a=e.length/3;return t[0]=s/a,t[1]=i/a,t[2]=r/a,t},expandAABB3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e),expandAABB3Point3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e),expandAABB3Points3(e,t){for(var s,i,r,o=0,n=t.length;o<n;o+=3)s=t[o],i=t[o+1],r=t[o+2],e[0]>s&&(e[0]=s),e[1]>i&&(e[1]=i),e[2]>r&&(e[2]=r),e[3]<s&&(e[3]=s),e[4]<i&&(e[4]=i),e[5]<r&&(e[5]=r);return e},collapseAABB2:(e=f.AABB2())=>(e[0]=f.MAX_DOUBLE,e[1]=f.MAX_DOUBLE,e[2]=f.MIN_DOUBLE,e[3]=f.MIN_DOUBLE,e),point3AABB3Intersect:(e,t)=>e[0]>t[0]||e[3]<t[0]||e[1]>t[1]||e[4]<t[1]||e[2]>t[2]||e[5]<t[2],planeAABB3Intersect(e,t,s){let i,r;e[0]>0?(i=e[0]*s[0],r=e[0]*s[3]):(i=e[0]*s[3],r=e[0]*s[0]),e[1]>0?(i+=e[1]*s[1],r+=e[1]*s[4]):(i+=e[1]*s[4],r+=e[1]*s[1]),e[2]>0?(i+=e[2]*s[2],r+=e[2]*s[5]):(i+=e[2]*s[5],r+=e[2]*s[2]);if(i<=-t&&r<=-t)return -1;return i>=-t&&r>=-t?1:0},OBB3ToAABB2(e,t=f.AABB2()){let s,i,r,o,n=f.MAX_DOUBLE,a=f.MAX_DOUBLE,h=f.MIN_DOUBLE,l=f.MIN_DOUBLE;for(let t=0,u=e.length;t<u;t+=4)s=e[t+0],i=e[t+1],r=e[t+3]||1,o=1/r,s*=o,i*=o,s<n&&(n=s),i<a&&(a=i),s>h&&(h=s),i>l&&(l=i);return t[0]=n,t[1]=a,t[2]=h,t[3]=l,t},expandAABB2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e),expandAABB2Point2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e),AABB2ToCanvas(e,t,s,i=e){const r=.5*(e[0]+1),o=.5*(e[1]+1),n=.5*(e[2]+1),a=.5*(e[3]+1);return i[0]=Math.floor(r*t),i[1]=s-Math.floor(a*s),i[2]=Math.floor(n*t),i[3]=s-Math.floor(o*s),i},tangentQuadraticBezier:(e,t,s,i)=>2*(1-e)*(s-t)+2*e*(i-s),tangentQuadraticBezier3:(e,t,s,i,r)=>-3*t*(1-e)*(1-e)+3*s*(1-e)*(1-e)-6*e*s*(1-e)+6*e*i*(1-e)-3*e*e*i+3*e*e*r,tangentSpline:e=>6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e),catmullRomInterpolate(e,t,s,i,r){const o=.5*(s-e),n=.5*(i-t),a=r*r;return (2*t-2*s+o+n)*(r*a)+(-3*t+3*s-2*o-n)*a+o*r+t},b2p0(e,t){const s=1-e;return s*s*t},b2p1:(e,t)=>2*(1-e)*e*t,b2p2:(e,t)=>e*e*t,b2(e,t,s,i){return this.b2p0(e,t)+this.b2p1(e,s)+this.b2p2(e,i)},b3p0(e,t){const s=1-e;return s*s*s*t},b3p1(e,t){const s=1-e;return 3*s*s*e*t},b3p2:(e,t)=>3*(1-e)*e*e*t,b3p3:(e,t)=>e*e*e*t,b3(e,t,s,i,r){return this.b3p0(e,t)+this.b3p1(e,s)+this.b3p2(e,i)+this.b3p3(e,r)},triangleNormal(e,t,s,i=f.vec3()){const r=t[0]-e[0],o=t[1]-e[1],n=t[2]-e[2],a=s[0]-e[0],h=s[1]-e[1],l=s[2]-e[2],u=o*l-n*h,c=n*a-r*l,p=r*h-o*a,d=Math.sqrt(u*u+c*c+p*p);return 0===d?(i[0]=0,i[1]=0,i[2]=0):(i[0]=u/d,i[1]=c/d,i[2]=p/d),i},rayTriangleIntersect:(()=>{const e=new u(3),t=new u(3),s=new u(3),i=new u(3),r=new u(3);return (o,n,a,h,l,u)=>{u=u||f.vec3();const c=f.subVec3(h,a,e),p=f.subVec3(l,a,t),d=f.cross3Vec3(n,p,s),m=f.dotVec3(c,d);if(m<1e-6)return null;const g=f.subVec3(o,a,i),_=f.dotVec3(g,d);if(_<0||_>m)return null;const y=f.cross3Vec3(g,c,r),v=f.dotVec3(n,y);if(v<0||_+v>m)return null;const b=f.dotVec3(p,y)/m;return u[0]=o[0]+b*n[0],u[1]=o[1]+b*n[1],u[2]=o[2]+b*n[2],u}})(),rayPlaneIntersect:(()=>{const e=new u(3),t=new u(3),s=new u(3),i=new u(3);return (r,o,n,a,h,l)=>{l=l||f.vec3(),o=f.normalizeVec3(o,e);const u=f.subVec3(a,n,t),c=f.subVec3(h,n,s),p=f.cross3Vec3(u,c,i);f.normalizeVec3(p,p);const d=-f.dotVec3(n,p),m=-(f.dotVec3(r,p)+d)/f.dotVec3(o,p);return l[0]=r[0]+m*o[0],l[1]=r[1]+m*o[1],l[2]=r[2]+m*o[2],l}})(),cartesianToBarycentric:(()=>{const e=new u(3),t=new u(3),s=new u(3);return (i,r,o,n,a)=>{const h=f.subVec3(n,r,e),l=f.subVec3(o,r,t),u=f.subVec3(i,r,s),c=f.dotVec3(h,h),p=f.dotVec3(h,l),d=f.dotVec3(h,u),m=f.dotVec3(l,l),g=f.dotVec3(l,u),_=c*m-p*p;if(0===_)return null;const y=1/_,v=(m*d-p*g)*y,b=(c*g-p*d)*y;return a[0]=1-v-b,a[1]=b,a[2]=v,a}})(),barycentricInsideTriangle(e){const t=e[1],s=e[2];return s>=0&&t>=0&&s+t<1},barycentricToCartesian(e,t,s,i,r=f.vec3()){const o=e[0],n=e[1],a=e[2];return r[0]=t[0]*o+s[0]*n+i[0]*a,r[1]=t[1]*o+s[1]*n+i[1]*a,r[2]=t[2]*o+s[2]*n+i[2]*a,r},mergeVertices(e,t,s,i){const r={},o=[],n=[],a=t?[]:null,h=s?[]:null,l=[];let u,c,p,d;const f=1e4;let m,g,_=0;for(m=0,g=e.length;m<g;m+=3)u=e[m],c=e[m+1],p=e[m+2],d=`${Math.round(u*f)}_${Math.round(c*f)}_${Math.round(p*f)}`,void 0===r[d]&&(r[d]=n.length/3,n.push(u),n.push(c),n.push(p),t&&(a.push(t[m]),a.push(t[m+1]),a.push(t[m+2])),s&&(h.push(s[_]),h.push(s[_+1]))),o[m/3]=r[d],_+=2;for(m=0,g=i.length;m<g;m++)l[m]=o[i[m]];const y={positions:n,indices:l};return a&&(y.normals=a),h&&(y.uv=h),y},buildNormals:(()=>{const e=new u(3),t=new u(3),s=new u(3),i=new u(3),r=new u(3),o=new u(3);return (n,a,h)=>{let l,u;const c=new Array(n.length/3);let p,d,m,g,_,y,v;for(l=0,u=a.length;l<u;l+=3){p=a[l],d=a[l+1],m=a[l+2],e[0]=n[3*p],e[1]=n[3*p+1],e[2]=n[3*p+2],t[0]=n[3*d],t[1]=n[3*d+1],t[2]=n[3*d+2],s[0]=n[3*m],s[1]=n[3*m+1],s[2]=n[3*m+2],f.subVec3(t,e,i),f.subVec3(s,e,r);const h=f.vec3();f.normalizeVec3(f.cross3Vec3(i,r,o),h),c[p]||(c[p]=[]),c[d]||(c[d]=[]),c[m]||(c[m]=[]),c[p].push(h),c[d].push(h),c[m].push(h);}for(h=h&&h.length===n.length?h:new Float32Array(n.length),l=0,u=c.length;l<u;l++){g=c[l].length,_=0,y=0,v=0;for(let e=0;e<g;e++)_+=c[l][e][0],y+=c[l][e][1],v+=c[l][e][2];h[3*l]=_/g,h[3*l+1]=y/g,h[3*l+2]=v/g;}return h}})(),buildTangents:(()=>{const e=new u(3),t=new u(3),s=new u(3),i=new u(3),r=new u(3),o=new u(3),n=new u(3);return (a,h,l)=>{const u=new Float32Array(a.length);for(let c=0;c<h.length;c+=3){let p=h[c];const d=a.subarray(3*p,3*p+3),m=l.subarray(2*p,2*p+2);p=h[c+1];const g=a.subarray(3*p,3*p+3),_=l.subarray(2*p,2*p+2);p=h[c+2];const y=a.subarray(3*p,3*p+3),v=l.subarray(2*p,2*p+2),b=f.subVec3(g,d,e),w=f.subVec3(y,d,t),P=f.subVec2(_,m,s),T=f.subVec2(v,m,i),x=1/(P[0]*T[1]-P[1]*T[0]),M=f.mulVec3Scalar(f.subVec3(f.mulVec3Scalar(b,T[1],r),f.mulVec3Scalar(w,P[1],o),n),x,o);let D;for(let e=0;e<3;e++)D=3*h[c+e],u[D]+=M[0],u[D+1]+=M[1],u[D+2]+=M[2];}return u}})(),buildPickTriangles(e,t,s){const i=t.length,r=s?new Uint16Array(9*i):new Float32Array(9*i),o=new Uint8Array(12*i);let n,a,h,l,u,c,p=0,d=0,f=0;for(let s=0;s<i;s+=3)c=p>>24&255,u=p>>16&255,l=p>>8&255,h=255&p,a=t[s],n=3*a,r[d++]=e[n],r[d++]=e[n+1],r[d++]=e[n+2],o[f++]=h,o[f++]=l,o[f++]=u,o[f++]=c,a=t[s+1],n=3*a,r[d++]=e[n],r[d++]=e[n+1],r[d++]=e[n+2],o[f++]=h,o[f++]=l,o[f++]=u,o[f++]=c,a=t[s+2],n=3*a,r[d++]=e[n],r[d++]=e[n+1],r[d++]=e[n+2],o[f++]=h,o[f++]=l,o[f++]=u,o[f++]=c,p++;return {positions:r,colors:o}},faceToVertexNormals(e,t,s={}){const i=s.smoothNormalsAngleThreshold||20,r={},o=[],n={};let a,h,l,u,c;const p=1e4;let d,m,g,_,y,v;for(m=0,_=e.length;m<_;m+=3){d=m/3,h=e[m],l=e[m+1],u=e[m+2],c=`${Math.round(h*p)}_${Math.round(l*p)}_${Math.round(u*p)}`,void 0===r[c]?r[c]=[d]:r[c].push(d);const s=f.normalizeVec3([t[m],t[m+1],t[m+2]]);o[d]=s,a=f.vec4([s[0],s[1],s[2],1]),n[d]=a;}for(c in r)if(r.hasOwnProperty(c)){const e=r[c],t=e.length;for(m=0;m<t;m++){const s=e[m];for(a=n[s],g=0;g<t;g++){if(m===g)continue;const t=e[g];y=o[s],v=o[t];Math.abs(f.angleVec3(y,v)/f.DEGTORAD)<i&&(a[0]+=v[0],a[1]+=v[1],a[2]+=v[2],a[3]+=1);}}}for(m=0,_=t.length;m<_;m+=3)a=n[m/3],t[m+0]=a[0]/a[3],t[m+1]=a[1]/a[3],t[m+2]=a[2]/a[3];},transformRay:(()=>{const e=new u(4),t=new u(4);return (s,i,r,o,n)=>{e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=1,f.transformVec4(s,e,t),o[0]=t[0],o[1]=t[1],o[2]=t[2],e[0]=r[0],e[1]=r[1],e[2]=r[2],f.transformVec3(s,e,t),f.normalizeVec3(t),n[0]=t[0],n[1]=t[1],n[2]=t[2];}})(),canvasPosToWorldRay:(()=>{const e=new u(16),t=new u(16),s=new u(4),i=new u(4),r=new u(4),o=new u(4);return (n,a,h,l,u,c)=>{const p=f.mulMat4(h,a,e),d=f.inverseMat4(p,t),m=n.width,g=n.height,_=(l[0]-m/2)/(m/2),y=-(l[1]-g/2)/(g/2);s[0]=_,s[1]=y,s[2]=-1,s[3]=1,f.transformVec4(d,s,i),f.mulVec4Scalar(i,1/i[3]),r[0]=_,r[1]=y,r[2]=1,r[3]=1,f.transformVec4(d,r,o),f.mulVec4Scalar(o,1/o[3]),u[0]=o[0],u[1]=o[1],u[2]=o[2],f.subVec3(o,i,c),f.normalizeVec3(c);}})(),canvasPosToLocalRay:(()=>{const e=new u(3),t=new u(3);return (s,i,r,o,n,a,h)=>{f.canvasPosToWorldRay(s,i,r,n,e,t),f.worldRayToLocalRay(o,e,t,a,h);}})(),worldRayToLocalRay:(()=>{const e=new u(16),t=new u(4),s=new u(4);return (i,r,o,n,a)=>{const h=f.inverseMat4(i,e);t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,f.transformVec4(h,t,s),n[0]=s[0],n[1]=s[1],n[2]=s[2],f.transformVec3(h,o,a);}})(),buildKDTree:(()=>{const e=new Float32Array;function t(s,i,r,o){const n=new u(6),a={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:n};let h,l;for(n[0]=n[1]=n[2]=Number.POSITIVE_INFINITY,n[3]=n[4]=n[5]=Number.NEGATIVE_INFINITY,h=0,l=s.length;h<l;++h){var c=3*s[h];for(let e=0;e<3;++e){const t=3*i[c+e];r[t]<n[0]&&(n[0]=r[t]),r[t]>n[3]&&(n[3]=r[t]),r[t+1]<n[1]&&(n[1]=r[t+1]),r[t+1]>n[4]&&(n[4]=r[t+1]),r[t+2]<n[2]&&(n[2]=r[t+2]),r[t+2]>n[5]&&(n[5]=r[t+2]);}}if(s.length<20||o>10)return a.triangles=s,a.leaf=!0,a;e[0]=n[3]-n[0],e[1]=n[4]-n[1],e[2]=n[5]-n[2];let p=0;e[1]>e[p]&&(p=1),e[2]>e[p]&&(p=2),a.splitDim=p;const d=(n[p]+n[p+3])/2,f=new Array(s.length);let m=0;const g=new Array(s.length);let _=0;for(h=0,l=s.length;h<l;++h){const e=i[c=3*s[h]],t=3*i[c+1],o=3*i[c+2];r[3*e+p]<=d||r[t+p]<=d||r[o+p]<=d?f[m++]=s[h]:g[_++]=s[h];}return f.length=m,g.length=_,a.left=t(f,i,r,o+1),a.right=t(g,i,r,o+1),a}return (e,s)=>{const i=e.length/3,r=new Array(i);for(let e=0;e<i;++e)r[e]=e;return t(r,e,s,0)}})(),decompressPosition(e,t,s){(s=s||e)[0]=e[0]*t[0]+t[12],s[1]=e[1]*t[5]+t[13],s[2]=e[2]*t[10]+t[14];},decompressPositions(e,t,s=new Float32Array(e.length)){for(let i=0,r=e.length;i<r;i+=3)s[i+0]=e[i+0]*t[0]+t[12],s[i+1]=e[i+1]*t[5]+t[13],s[i+2]=e[i+2]*t[10]+t[14];return s},decompressUV(e,t,s){s[0]=e[0]*t[0]+t[6],s[1]=e[1]*t[4]+t[7];},decompressUVs(e,t,s=new Float32Array(e.length)){for(let i=0,r=e.length;i<r;i+=3)s[i+0]=e[i+0]*t[0]+t[6],s[i+1]=e[i+1]*t[4]+t[7];return s},octDecodeVec2(e,t){let s=e[0],i=e[1];s=(2*s+1)/255,i=(2*i+1)/255;const r=1-Math.abs(s)-Math.abs(i);r<0&&(s=(1-Math.abs(i))*(s>=0?1:-1),i=(1-Math.abs(s))*(i>=0?1:-1));const o=Math.sqrt(s*s+i*i+r*r);return t[0]=s/o,t[1]=i/o,t[2]=r/o,t},octDecodeVec2s(e,t){for(let s=0,i=0,r=e.length;s<r;s+=2){let r=e[s+0],o=e[s+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);t[i+0]=r/a,t[i+1]=o/a,t[i+2]=n/a,i+=3;}return t}};f.buildEdgeIndices=function(){const e=[],t=[],s=[],i=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),h=new Uint16Array(3),l=f.vec3(),u=f.vec3(),c=f.vec3(),p=f.vec3(),d=f.vec3(),m=f.vec3(),g=f.vec3();return function(_,y,v,b){!function(r,o){const n={};let a,h,l,u;const c=Math.pow(10,4);let p,d,f=0;for(p=0,d=r.length;p<d;p+=3)a=r[p],h=r[p+1],l=r[p+2],u=Math.round(a*c)+"_"+Math.round(h*c)+"_"+Math.round(l*c),void 0===n[u]&&(n[u]=f/3,e[f++]=a,e[f++]=h,e[f++]=l),t[p/3]=n[u];for(p=0,d=o.length;p<d;p++)i[p]=t[o[p]],s[i[p]]=o[p];}(_,y),function(t,s){o=0;for(let _=0,y=t;_<y;_+=3){const t=3*i[_],y=3*i[_+1],v=3*i[_+2];s?(n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],a[0]=e[y],a[1]=e[y+1],a[2]=e[y+2],h[0]=e[v],h[1]=e[v+1],h[2]=e[v+2],f.decompressPosition(n,s,l),f.decompressPosition(a,s,u),f.decompressPosition(h,s,c)):(l[0]=e[t],l[1]=e[t+1],l[2]=e[t+2],u[0]=e[y],u[1]=e[y+1],u[2]=e[y+2],c[0]=e[v],c[1]=e[v+1],c[2]=e[v+2]),f.subVec3(c,u,p),f.subVec3(l,u,d),f.cross3Vec3(p,d,m),f.normalizeVec3(m,g);const b=r[o]||(r[o]={normal:f.vec3()});b.normal[0]=g[0],b.normal[1]=g[1],b.normal[2]=g[2],o++;}}(y.length,v);const w=[],P=Math.cos(f.DEGTORAD*b),T={};let x,M,D,A,C,I,F,B,E,S,R,O=!1;for(let e=0,t=y.length;e<t;e+=3){const t=e/3;for(let s=0;s<3;s++)x=i[e+s],M=i[e+(s+1)%3],D=Math.min(x,M),A=Math.max(x,M),C=D+","+A,void 0===T[C]?T[C]={index1:D,index2:A,face1:t,face2:void 0}:T[C].face2=t;}for(C in T)I=T[C],void 0!==I.face2&&(F=r[I.face1].normal,B=r[I.face2].normal,E=f.dotVec3(F,B),E>P)||(S=s[I.index1],R=s[I.index2],(!O&&S>65535||R>65535)&&(O=!0),w.push(S),w.push(R));return O?new Uint32Array(w):new Uint16Array(w)}}();class m{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0;}get length(){return this._length}shift(){if(this._index>=this._headLength){const e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}}const g={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var _=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(e){for(var t=[],s=e[0].charCodeAt(0),i=s+e[1],r=s;r<i;++r)t.push(r);return String.fromCharCode.apply(null,t)})).join("");function y(e,t){return (t&&4!==t?[0,6]:[0,6,12,18]).map((function(t){return _.substr(parseInt(e/(1<<t))%64,1)})).reverse().join("")}const v=function(){for(var e={},t=window.location.search.substring(1).split("&"),s=0;s<t.length;s++){var i=t[s].split("=");if(void 0===e[i[0]])e[i[0]]=decodeURIComponent(i[1]);else if("string"==typeof e[i[0]]){var r=[e[i[0]],decodeURIComponent(i[1])];e[i[0]]=r;}else e[i[0]].push(decodeURIComponent(i[1]));}return e}();const b={xmlToJson:function e(t,s){if(t.nodeType===t.TEXT_NODE){var i=t.nodeValue;if(null===i.match(/^\s+$/))return i}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var r={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var o=0;o<t.attributes.length;o++){var n=t.attributes[o];r[s[n.nodeName]||n.nodeName]=n.nodeValue;}for(var a=0;a<t.childNodes.length;a++){(o=e(t.childNodes[a],s))&&r.children.push(o);}return r}},clone:function(e){return JSON.parse(JSON.stringify(e))},compressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(t){return parseInt(e.substr(t,2),16)}));return y(t[0],2)+[1,4,7,10,13].map((function(e){return y((t[e]<<16)+(t[e+1]<<8)+t[e+2])})).join("")},findNodeOfType:function(e,t){var s=[],i=function(e){e.type===t&&s.push(e),(e.children||[]).forEach((function(e){i(e);}));};return i(e),s},timeout:function(e){return new Promise((function(t,s){setTimeout(t,e);}))},httpRequest:function(e){return new Promise((function(t,s){var i=new XMLHttpRequest;i.open(e.method||"GET",e.url,!0),i.onload=function(r){console.log(e.url,i.readyState,i.status),4===i.readyState&&(200===i.status?t(i.responseXML):s(i.statusText));},i.send(null);}))},loadJSON:function(e,t,s){var i=e=>{};t=t||i,s=s||i;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",e,!0),r.addEventListener("load",(function(e){var i=e.target.response;if(200===this.status){var r;try{r=JSON.parse(i);}catch(e){s(`utils.loadJSON(): Failed to parse JSON response - ${e}`);}t(r);}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{t(JSON.parse(i));}catch(e){s(`utils.loadJSON(): Failed to parse JSON response - ${e}`);}}else s(e);}),!1),r.addEventListener("error",(function(e){s(e);}),!1),r.send(null);},loadArraybuffer:function(e,t,s){var i=e=>{};t=t||i,s=s||i;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),s=new Uint8Array(e);for(var n=0;n<o.length;n++)s[n]=o.charCodeAt(n);window.setTimeout((function(){t(e);}),0);}catch(e){window.setTimeout((function(){s(e);}),0);}}else {const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onreadystatechange=function(){4===i.readyState&&(200===i.status?t(i.response):s("loadArrayBuffer error : "+i.response));},i.send(null);}},queryString:v,isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},isString:function(e){return "string"==typeof e||e instanceof String},isNumeric:function(e){return !isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return b.isString(e)||b.isNumeric(e)},isSameComponent:function(e,t){return !(!e||!t)&&(b.isNumeric(e)||b.isString(e)?`${e}`:e.id)===(b.isNumeric(t)||b.isString(t)?`${t}`:t.id)},isFunction:function(e){return "function"==typeof e},isObject:function(e){const t={}.constructor;return !!e&&e.constructor===t},copy:function(e){return b.apply(e,{})},apply:function(e,t){for(const s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return t},apply2:function(e,t){for(const s in e)e.hasOwnProperty(s)&&void 0!==e[s]&&null!==e[s]&&(t[s]=e[s]);return t},applyIf:function(e,t){for(const s in e)e.hasOwnProperty(s)&&(void 0!==t[s]&&null!==t[s]||(t[s]=e[s]));return t},isEmptyObject:function(e){for(const t in e)if(e.hasOwnProperty(t))return !1;return !0},inQuotes:function(e){return b.isNumeric(e)?`${e}`:`'${e}'`},concat:function(e,t){const s=new e.constructor(e.length+t.length);return s.set(e),s.set(t,e.length),s},flattenParentChildHierarchy:function(e){var t=[];return function e(s){s.id=s.uuid,delete s.oid,t.push(s);var i=s.children;if(i)for(var r=0,o=i.length;r<o;r++){i[r].parent=s.id,e(i[r]);}s.children=[];}(e),t}},w={},P=new s,T=new m,x={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},M=[];let D,A=0,C=0;const I=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(e){if(e.id){if(I.scenes[e.id])return void console.error(`[ERROR] Scene ${b.inQuotes(e.id)} already exists`)}else e.id=P.addItem({});I.scenes[e.id]=e;const t=e.ticksPerOcclusionTest,s=e.ticksPerRender;w[e.id]={ticksPerOcclusionTest:t,ticksPerRender:s,renderCountdown:s},g.components.scenes++,e.once("destroyed",(()=>{P.removeItem(e.id),delete I.scenes[e.id],delete w[e.id],g.components.scenes--;}));},this.clear=function(){let e;for(const t in I.scenes)I.scenes.hasOwnProperty(t)&&(e=I.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete I.scenes[e.id]));},this.scheduleTask=function(e,t){T.push(e),T.push(t);},this.runTasks=function(e=-1){let t,s,i=(new Date).getTime(),r=0;for(;T.length>0&&(e<0||i<e);)t=T.shift(),s=T.shift(),s?t.call(s):t(),i=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return T.length};},F=function(){let e=Date.now();if(A>0){D=e-A;var t=1e3/D;C+=t,M.push(t),M.length>=30&&(C-=M.shift()),g.frame.fps=Math.round(C/M.length);}!function(e){const t=I.runTasks(e+10),s=I.getNumTasks();g.frame.tasksRun=t,g.frame.tasksScheduled=s,g.frame.tasksBudget=10;}(e),function(e){for(var t in x.time=e,I.scenes)if(I.scenes.hasOwnProperty(t)){var s=I.scenes[t];x.sceneId=t,x.startTime=s.startTime,x.deltaTime=null!=x.prevTime?x.time-x.prevTime:0,s.fire("tick",x,!0);}x.prevTime=e;}(e),function(){const e=I.scenes,t=!1;let s,i,r,o,n;for(n in e)e.hasOwnProperty(n)&&(s=e[n],i=w[n],i||(i=w[n]={}),r=s.ticksPerOcclusionTest,i.ticksPerOcclusionTest!==r&&(i.ticksPerOcclusionTest=r,i.renderCountdown=r),--s.occlusionTestCountdown<=0&&(s.doOcclusionTest(),s.occlusionTestCountdown=r),o=s.ticksPerRender,i.ticksPerRender!==o&&(i.ticksPerRender=o,i.renderCountdown=o),0==--i.renderCountdown&&(s.render(t),i.renderCountdown=o));}(),A=e,void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(F):requestAnimationFrame(F);};void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(F):requestAnimationFrame(F);class B{get type(){return "Component"}get isComponent(){return !0}constructor(e=null,t={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=t.viewer;else {if("Scene"===e.type)this.scene=e;else {if(!(e instanceof B))throw "Invalid param: owner must be a Component";this.scene=e.scene;}this._owner=e,this._renderer=this.scene._renderer;}this._dontClear=!!t.dontClear,this._renderer=this.scene._renderer,this.meta=t.meta||{},this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this);}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty());}glResort(){this._renderer&&this._renderer.needStateSort();}get owner(){return this._owner}isType(e){return this.type===e}fire(e,t,s){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==s&&(this._events[e]=t||!0);const i=this._eventSubs[e];let r;if(i)for(const s in i)i.hasOwnProperty(s)&&(r=i[s],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--);}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new s),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();r[o]={callback:t,scope:i||this},this._subIdEvents[o]=e;const n=this._events[e];return void 0!==n&&t.call(i||this,n),o}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const s=this._eventSubs[t];s&&(delete s[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e);}}once(e,t,s){const i=this,r=this.on(e,(function(e){i.off(r),t.call(s||this,e);}),s);}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e);}_message(e){return " ["+this.type+" "+b.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e);}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e);}_attach(e){const t=e.name;if(!t)return void this.error("Component 'name' expected");let s=e.component;const i=e.sceneDefault,r=e.sceneSingleton,o=e.type,n=e.on,a=!1!==e.recompiles;if(s&&(b.isNumeric(s)||b.isString(s))){const e=s;if(s=this.scene.components[e],!s)return void this.error("Component not found: "+b.inQuotes(e))}if(!s)if(!0===r){const e=this.scene.types[o];for(const t in e)if(e.hasOwnProperty){s=e[t];break}if(!s)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===i&&(s=this.scene[t],!s))return this.error("Scene has no default component for '"+t+"'"),null;if(s){if(s.scene.id!==this.scene.id)return void this.error("Not in same scene: "+s.type+" "+b.inQuotes(s.id));if(o&&!s.isType(o))return void this.error("Expected a "+o+" type or subtype: "+s.type+" "+b.inQuotes(s.id))}this._attachments||(this._attachments={});const h=this._attached[t];let l,u,c;if(h){if(s&&h.id===s.id)return;const e=this._attachments[h.id];for(l=e.subs,u=0,c=l.length;u<c;u++)h.off(l[u]);delete this._attached[t],delete this._attachments[h.id];const i=e.params.onDetached;i&&(b.isFunction(i)?i(h):i.scope?i.callback.call(i.scope,h):i.callback(h)),e.managingLifecycle&&h.destroy();}if(s){const i={params:e,component:s,subs:[],managingLifecycle:false};i.subs.push(s.once("destroyed",(function(){i.params.component=null,this._attach(i.params);}),this)),a&&i.subs.push(s.on("dirty",(function(){this.fire("dirty",this);}),this)),this._attached[t]=s,this._attachments[s.id]=i;const r=e.onAttached;if(r&&(b.isFunction(r)?r(s):r.scope?r.callback.call(r.scope,s):r.callback(s)),n){let e,t,r,o;for(e in n)if(n.hasOwnProperty(e)){if(t=n[e],b.isFunction(t)?(r=t,o=null):(r=t.callback,o=t.scope),!r)continue;i.subs.push(s.on(e,r,o));}}}return a&&this.fire("dirty",this),this.fire(t,s),s}_checkComponent(e,t){if(!t.isComponent){if(!b.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(e===t.type){if(t.scene.id===this.scene.id)return t;this.error("Not in same scene: "+t.type);}else this.error("Expected a "+e+" Component");}_checkComponent2(e,t){if(!t.isComponent){if(!b.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(t.scene.id===this.scene.id){for(var s=0,i=e.length;s<i;s++)if(e[s]===t.type)return t;return this.error("Expected component types: "+e),null}this.error("Not in same scene: "+t.type);}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",(()=>{delete this._ownedComponents[e.id];}),this);}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():I.scheduleTask(this._doUpdate,this));}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update());}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(e)){this._ownedComponents[e].destroy(),delete this._ownedComponents[e];}}destroy(){if(this.destroyed)return;let e,t,s,i,r,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(t=this._attachments[e],s=t.component,i=t.subs,r=0,o=i.length;r<o;r++)s.off(i[r]);t.managingLifecycle&&s.destroy();}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(s=this._ownedComponents[e],s.destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1;}}const E=1,S=4,R=8,O=16,L=32,N=256,k=512,j=1024,G=2048,H=new Float32Array([0,0,0]),V=new Uint16Array([0,0,0]);class U{constructor(e,t,s,i,r,o){this._isObject=t,this.scene=e.scene,this.model=e,this.meshes=i,this._numTriangles=0;for(var n=0,a=this.meshes.length;n<a;n++){const e=this.meshes[n];e.parent=this,this._numTriangles+=e.numTriangles;}this.id=s,this.originalSystemId=f.unglobalizeObjectId(e.id,s),this._flags=r,this._aabb=o,this._offsetAABB=f.AABB3(o),this._offset=f.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._isObject&&e.scene._registerObject(this);}get isEntity(){return !0}get isModel(){return !1}get isObject(){return this._isObject}get aabb(){return this._offsetAABB}get numTriangles(){return this._numTriangles}get visible(){return this._getFlag(E)}set visible(e){if(!!(this._flags&E)!==e){this._flags=e?this._flags|E:this._flags&~E;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw();}}get highlighted(){return this._getFlag(k)}set highlighted(e){if(!!(this._flags&k)!==e){this._flags=e?this._flags|k:this._flags&~k;for(var t=0,s=this.meshes.length;t<s;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw();}}get xrayed(){return this._getFlag(N)}set xrayed(e){if(!!(this._flags&N)!==e){this._flags=e?this._flags|N:this._flags&~N;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw();}}get selected(){return this._getFlag(j)}set selected(e){if(!!(this._flags&j)!==e){this._flags=e?this._flags|j:this._flags&~j;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw();}}get edges(){return this._getFlag(G)}set edges(e){if(!!(this._flags&G)!==e){this._flags=e?this._flags|G:this._flags&~G;for(var t=0,s=this.meshes.length;t<s;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw();}}get culled(){return this._getFlag(S)}set culled(e){if(!!(this._flags&S)!==e){this._flags=e?this._flags|S:this._flags&~S;for(var t=0,s=this.meshes.length;t<s;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw();}}get clippable(){return this._getFlag(O)}set clippable(e){if(!!(this._flags&O)!==e){this._flags=e?this._flags|O:this._flags&~O;for(var t=0,s=this.meshes.length;t<s;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw();}}get collidable(){return this._getFlag(L)}set collidable(e){if(!!(this._flags&L)!==e){this._flags=e?this._flags|L:this._flags&~L;for(var t=0,s=this.meshes.length;t<s;t++)this.meshes[t]._setCollidable(this._flags);}}get pickable(){return this._getFlag(R)}set pickable(e){if(!!(this._flags&R)!==e){this._flags=e?this._flags|R:this._flags&~R;for(var t=0,s=this.meshes.length;t<s;t++)this.meshes[t]._setPickable(this._flags);}}get colorize(){if(0===this.meshes.length)return null;const e=this.meshes[0]._colorize;return H[0]=e[0]/255,H[1]=e[1]/255,H[2]=e[2]/255,H}set colorize(e){if(e){V[0]=Math.floor(255*e[0]),V[1]=Math.floor(255*e[1]),V[2]=Math.floor(255*e[2]);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(V);}else for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(null);if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t),this._colorizeUpdated=t;}this.model.glRedraw();}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(0===this.meshes.length)return;const t=null!=e,s=this.meshes[0]._colorize[3];let i=255;if(t){if(e<0?e=0:e>1&&(e=1),i=Math.floor(255*e),s===i)return}else if(i=255,s===i)return;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOpacity(i,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw();}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model._aabbDirty=!0,this.model.glRedraw();}get castsShadow(){return !1}set castsShadow(e){}get receivesShadow(){return !1}set receivesShadow(e){}get saoEnabled(){return this.model.saoEnabled}_getFlag(e){return !!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize(this._flags);}_finalize2(){for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2();}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._objectVisibilityUpdated(this,!1),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this._opacityUpdated&&this.scene._objectColorizeUpdated(this,!1),this._opacityUpdated&&this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._destroy();e._aabbDirty=!0;}}const z=f.vec3(),W=function(){const e=new Float32Array(16),t=new Float64Array(4),s=new Float64Array(4);return function(i,r,o){return o=o||e,t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,f.transformVec4(i,t,s),f.setMat4Translation(i,s,o),o}}();function X(e,t,s){const i=Float32Array.from([e[0]])[0],r=e[0]-i,o=Float32Array.from([e[1]])[0],n=e[1]-o,a=Float32Array.from([e[2]])[0],h=e[2]-a;t[0]=i,t[1]=o,t[2]=a,s[0]=r,s[1]=n,s[2]=h;}function Y(e,t,s,i=1e6){const r=f.getPositionsCenter(e,z),o=Math.round(r[0]/i)*i,n=Math.round(r[1]/i)*i,a=Math.round(r[2]/i)*i;s[0]=o,s[1]=n,s[2]=a;const h=0!==s[0]||0!==s[1]||0!==s[2];if(h)for(let s=0,i=e.length;s<i;s+=3)t[s+0]=e[s+0]-o,t[s+1]=e[s+1]-n,t[s+2]=e[s+2]-a;return h}function K(e,t,s,i){const r=f.dotVec3(t,s)+e,o=f.normalizeVec3(t,z);return f.mulVec3Scalar(o,-r,i),i}const J=f.vec4(),Z=f.vec4();var te=f.vec3(),se=f.vec3();const ae=f.vec3(),he=f.vec3(),le=f.vec3();class ce extends B{get type(){return "Spinner"}constructor(e,t={}){super(e,t),this._canvas=t.canvas,this._element=null,this._isCustom=!1,t.elementId&&(this._element=document.getElementById(t.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+t.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0;}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition();}_injectDefaultCSS(){const e="xeokit-spinner-css";if(document.getElementById(e))return;const t=document.createElement("style");t.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",t.id=e,document.body.appendChild(t);}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,t=this._element,s=t.style;s.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",s.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px";}set processes(e){if(e=e||0,this._processes===e)return;if(e<0)return;const t=this._processes;this._processes=e;const s=this._element;s&&(s.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes);}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e);}}const pe={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},de=document.createElement("canvas");if(de){const e=de.getContext("webgl",{antialias:!0})||de.getContext("experimental-webgl",{antialias:!0});pe.WEBGL=!!e,pe.WEBGL&&(pe.ANTIALIAS=e.getContextAttributes().antialias,e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?pe.FS_MAX_FLOAT_PRECISION="highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?pe.FS_MAX_FLOAT_PRECISION="mediump":pe.FS_MAX_FLOAT_PRECISION="lowp":pe.FS_MAX_FLOAT_PRECISION="mediump",pe.DEPTH_BUFFER_BITS=e.getParameter(e.DEPTH_BITS),pe.MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),pe.MAX_CUBE_MAP_SIZE=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),pe.MAX_RENDERBUFFER_SIZE=e.getParameter(e.MAX_RENDERBUFFER_SIZE),pe.MAX_TEXTURE_UNITS=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),pe.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),pe.MAX_VERTEX_ATTRIBS=e.getParameter(e.MAX_VERTEX_ATTRIBS),pe.MAX_VERTEX_UNIFORM_VECTORS=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),pe.MAX_FRAGMENT_UNIFORM_VECTORS=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),pe.MAX_VARYING_VECTORS=e.getParameter(e.MAX_VARYING_VECTORS),e.getSupportedExtensions().forEach((function(e){pe.SUPPORTED_EXTENSIONS[e]=!0;})));}const fe=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class me extends B{constructor(e,t={}){super(e,t),this._backgroundColor=f.vec3([t.backgroundColor?t.backgroundColor[0]:1,t.backgroundColor?t.backgroundColor[1]:1,t.backgroundColor?t.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!t.backgroundColorFromAmbientLight,this.canvas=t.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.optimizeResizeDetection=!0,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.resolutionScale=t.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(t);const s=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(e){console.time("webglcontextrestored"),s.scene._webglContextLost(),s.fire("webglcontextlost"),e.preventDefault();},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(e){s._initWebGL(),s.gl&&(s.scene._webglContextRestored(s.gl),s.fire("webglcontextrestored",s.gl),e.preventDefault()),console.timeEnd("webglcontextrestored");},!1);let i=null,r=null,o=null,n=null,a=null,h=null,l=null,u=null,c=0;this._tick=this.scene.on("tick",(()=>{if(c++,s._canvasSizeChanged=!1,s.optimizeResizeDetection&&c<10)return;c=0;const e=this.canvas,t=this._resolutionScale!==i,p=window.innerWidth!==r||window.innerHeight!==o,d=e.clientWidth!==n||e.clientHeight!==a,f=e.offsetLeft!==h||e.offsetTop!==l,m=e.parentElement;if(t||p||d||f||m!==u){if(s._canvasSizeChanged=!0,this._spinner._adjustPosition(),t||d||f){const s=e.clientWidth,i=e.clientHeight;if(t||d){let t,s=0;for(const e in I.scenes)I.scenes.hasOwnProperty(e)&&(t=I.scenes[e],s+=Math.round(t.canvas.canvas.clientWidth*this._resolutionScale*(t.canvas.canvas.clientHeight*this._resolutionScale)));g.memory.pixels=s,e.width=Math.round(e.clientWidth*this._resolutionScale),e.height=Math.round(e.clientHeight*this._resolutionScale);}const r=this.boundary;r[0]=e.offsetLeft,r[1]=e.offsetTop,r[2]=s,r[3]=i,t&&!d||this.fire("boundary",r),n=s,a=i;}t&&(i=this._resolutionScale),p&&(r=window.innerWidth,o=window.innerHeight),f&&(h=e.offsetLeft,l=e.offsetTop),u=m;}})),this._spinner=new ce(this.scene,{canvas:this.canvas,elementId:t.spinnerElementId});}get type(){return "Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(e){this._backgroundColorFromAmbientLight=!1!==e,this.glRedraw();}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw();}get resolutionScale(){return this._resolutionScale}set resolutionScale(e){if((e=e||1)===this._resolutionScale)return;this._resolutionScale=e;const t=this.canvas;t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale),this.glRedraw();}get spinner(){return this._spinner}_createCanvas(){const e="xeokit-canvas-"+f.createUUID(),t=document.getElementsByTagName("body")[0],s=document.createElement("div"),i=s.style;i.height="100%",i.width="100%",i.padding="0",i.margin="0",i.background="rgba(0,0,0,0);",i.float="left",i.left="0",i.top="0",i.position="absolute",i.opacity="1.0",i["z-index"]="-10000",s.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(s),this.canvas=document.getElementById(e);}_getElementXY(e){let t=0,s=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,s+=e.offsetTop-e.scrollTop,e=e.offsetParent;return {x:t,y:s}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<fe.length;e++)try{this.gl=this.canvas.getContext(fe[e],this.contextAttr);}catch(e){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl&&this.webgl2&&this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);}getSnapshot(e){throw "Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(e,t,s,i){return this.scene._renderer.readPixels(e,t,s,i)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext();}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy();}}class ge{constructor(e){this._scene=e,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset();}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1;}getRTCViewMatrix(e,t){let s=this._rtcViewMats[e];return s||(s=this._getNewMat(),W(this._scene.camera.viewMatrix,t,s),this._rtcViewMats[e]=s),s}getRTCPickViewMatrix(e,t){let s=this._rtcPickViewMats[e];if(!s){s=this._getNewMat();const i=this.pickViewMatrix||this._scene.camera.viewMatrix;W(i,t,s),this._rtcPickViewMats[e]=s;}return s}_getNewMat(){let e=this._matPool[this._matPoolNextFreeIndex];return e||(e=f.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}class _e{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset();}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1;}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1;}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1;}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1;}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1;}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1;}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1;}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1;}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1;}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1;}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1;}}class ye{constructor(e,t,s){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),this.handle){if(this.allocated=!0,e.shaderSource(this.handle,s),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const t=s.split("\n"),i=[];for(let e=0;e<t.length;e++)i.push(e+1+": "+t[e]+"\n");this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(i.join(""));}}else this.errors=["Failed to allocate"];}destroy(){}}class ve{constructor(e,t){this.bindTexture=function(s,i){return !!s.bind(i)&&(e.uniform1i(t,i),!0)};}}class be{constructor(e,t){this._gl=e,this.location=t;}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset));}}const we=new s({});function Pe(e){const t=[];let s,i;for(let r=0,o=e.length;r<o;r++)s=e[r],i=s.indexOf("/"),i>0&&"/"===s.charAt(i+1)&&(s=s.substring(0,i)),t.push(s);return t.join("\n")}function Te(e){console.error(e.join("\n"));}class xe{constructor(e,t){this.id=we.addItem({}),this.source=t,this.init(e);}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new ye(e,e.VERTEX_SHADER,Pe(this.source.vertex)),this._fragmentShader=new ye(e,e.FRAGMENT_SHADER,Pe(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void Te(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void Te(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void Te(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void Te(this.errors);let t,s,i,r,o;if(this.compiled=!0,this.handle=e.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void Te(this.errors);const n=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(s=0;s<n;++s)i=e.getActiveUniform(this.handle,s),i&&(r=i.name,"\0"===r[r.length-1]&&(r=r.substr(0,r.length-1)),o=e.getUniformLocation(this.handle,r),i.type===e.SAMPLER_2D||i.type===e.SAMPLER_CUBE||35682===i.type?this.samplers[r]=new ve(e,o):this.uniforms[r]=o);const a=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(s=0;s<a;s++)t=e.getActiveAttrib(this.handle,s),t&&(o=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new be(e,o));this.allocated=!0;}bind(){this.allocated&&this.gl.useProgram(this.handle);}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,s){if(!this.allocated)return !1;const i=this.samplers[e];return !!i&&i.bindTexture(t,s)}destroy(){this.allocated&&(we.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1);}}class Me{constructor(e,t,s,i,r,o,n,a,h){switch(this._gl=e,this.type=t,this.allocated=!1,s.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4;}this.usage=o,this.length=0,this.dataLength=i,this.numItems=0,this.itemSize=r,this.normalized=!!n,this.stride=a||0,this.offset=h||0,this._allocate(s);}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw "Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0);}setData(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)));}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle);}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null);}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1);}}class De{constructor(e,t){this.scene=e,this.aabb=f.AABB3(),this.origin=f.vec3(t),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1;}addMarker(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++;}markerWorldPosUpdated(e){if(!this.markers[e.id])return;const t=this.markerIndices[e.id];this.positions[3*t+0]=e.worldPos[0],this.positions[3*t+1]=e.worldPos[1],this.positions[3*t+2]=e.worldPos[2],this.positionsDirty=!0;}removeMarker(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--;}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes();}_buildMarkerList(){for(var e in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers;}_buildPositions(){let e=0;for(let t=0;t<this.numMarkers;t++)if(this.markerList[t]){const s=this.markerList[t].worldPos;this.positions[e++]=s[0],this.positions[e++]=s[1],this.positions[e++]=s[2],this.indices[t]=t;}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers;}_buildAABB(){const e=this.aabb;f.collapseAABB3(e),f.expandAABB3Points3(e,this.positions);const t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2];}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null;}const e=this.scene.canvas.gl,t=3*this.numMarkers,s=this.numMarkers;this.positionsBuf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new Me(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),s,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length;}_buildOcclusionTestList(){const e=this.scene.canvas,t=this.scene.camera.perspective.near,s=e.boundary,i=s[2],r=s[3];let o=0;this.lenOcclusionTestList=0;for(let e=0;e<this.numMarkers;e++){const s=this.markerList[e];if(s.viewPos[2]>-t){s._setVisible(!1);continue}const n=s.canvasPos,a=n[0],h=n[1];a+10<0||h+10<0||a-10>i||h-10>r?s._setVisible(!1):!s.entity||s.entity.visible?s.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=s,this.pixels[o++]=a,this.pixels[o++]=h):s._setVisible(!0):s._setVisible(!1);}}_updateActiveSectionPlanes(){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let s=0;s<t;s++){const t=e[s];if(t.active){const e=f.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return void(this.culledBySectionPlanes=!0);const i=0===e;this.sectionPlanesActive[s]=i;}else this.sectionPlanesActive[s]=!1;}this.culledBySectionPlanes=!1;}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy();}}const Ae=f.vec3([1,0,0]),Ce=f.vec3();class Ie{constructor(e,t){this._scene=e,this._renderBufferManager=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=e.camera.on("viewMatrix",(()=>{this._occlusionTestListDirty=!0;})),this._onCameraProjMatrix=e.camera.on("projMatrix",(()=>{this._occlusionTestListDirty=!0;})),this._onCanvasBoundary=e.canvas.on("boundary",(()=>{this._occlusionTestListDirty=!0;}));}addMarker(e){const t=e.origin.join();let s=this._occlusionLayers[t];s||(s=new De(this._scene,e.origin),this._occlusionLayers[s.originHash]=s,this._occlusionLayersListDirty=!0),s.addMarker(e),this._markersToOcclusionLayersMap[e.id]=s,this._occlusionTestListDirty=!0;}markerWorldPosUpdated(e){const t=this._markersToOcclusionLayersMap[e.id];if(!t)return void e.error("Marker has not been added to OcclusionTester");const s=e.origin.join();if(s!==t.originHash){1===t.numMarkers?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);let i=this._occlusionLayers[s];i||(i=new De(this._scene,e.origin),this._occlusionLayers[s]=t,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i;}else t.markerWorldPosUpdated(e);}removeMarker(e){const t=e.origin.join();let s=this._occlusionLayers[t];s&&(1===s.numMarkers?(s.destroy(),delete this._occlusionLayers[s.originHash],this._occlusionLayersListDirty=!0):s.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id]);}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].occlusionTestListDirty=!0;}this._occlusionTestListDirty=!1;}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear();}_buildOcclusionLayersList(){let e=0;for(let t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e;}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()};}_buildVertexShaderSource(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// OcclusionTester vertex shader"),s.push("in vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("vec4 worldPosition = vec4(position, 1.0); "),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&s.push("   vWorldPosition = worldPosition;"),s.push("   vec4 clipPos = projMatrix * viewPosition;"),s.push("   gl_PointSize = 20.0;"),e.logarithmicDepthBufferEnabled?s.push("vFragDepth = 1.0 + clipPos.w;"):s.push("clipPos.z += -0.001;"),s.push("   gl_Position = clipPos;"),s.push("}"),s}_buildFragmentShaderSource(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// OcclusionTester fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("if (sectionPlaneActive"+r+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),i.push("}"),i}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}drawMarkers(){const e=this._scene,t=e.canvas.gl,s=this._program,i=e._sectionPlanesState,r=e.camera,o=e.camera.project;if(s.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}for(let e=0,s=this._occlusionLayersList.length;e<s;e++){const s=this._occlusionLayersList[e];if(s.update(),s.culledBySectionPlanes)continue;const o=s.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,W(r.viewMatrix,o));const n=i.sectionPlanes.length;if(n>0){const e=i.sectionPlanes;for(let i=0;i<n;i++){const r=this._uSectionPlanes[i];if(r){const n=s.sectionPlanesActive[i];if(t.uniform1i(r.active,n?1:0),n){const s=e[i];t.uniform3fv(r.pos,K(s.dist,s.dir,o,Ce)),t.uniform3fv(r.dir,s.dir);}}}}this._aPosition.bindArrayBuffer(s.positionsBuf);const a=s.indicesBuf;a.bind(),t.drawElements(t.POINTS,a.numItems,a.itemType,0);}}doOcclusionTest(){{const e=this._scene.canvas.resolutionScale,t=255*Ae[0],s=255*Ae[1],i=255*Ae[2];for(let r=0,o=this._occlusionLayersList.length;r<o;r++){const o=this._occlusionLayersList[r];for(let r=0;r<o.lenOcclusionTestList;r++){const n=o.occlusionTestList[r],a=2*r,h=this._readPixelBuf.read(Math.round(o.pixels[a]*e),Math.round(o.pixels[a+1]*e)),l=h[0]===t&&h[1]===s&&h[2]===i;n._setVisible(l);}}}}unbindRenderBuf(){this._readPixelBuf.unbind();}destroy(){if(!this.destroyed){for(let e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].destroy();}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0;}}}const Fe=f.vec2();class Be{constructor(e){this._scene=e,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null;}render(e){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let e=!0;this._scene.camera.on("projMatrix",(function(){e=!0;}));const t=f.mat4();return ()=>(e&&f.inverseMat4(i.camera.projMatrix,t),t)})());const t=this._scene.canvas.gl,s=this._program,i=this._scene,r=i.sao,o=t.drawingBufferWidth,n=t.drawingBufferHeight,a=i.camera.project._state,h=a.near,l=a.far,u=a.matrix,c=this._getInverseProjectMat(),p=Math.random(),d="perspective"===i.camera.projection;Fe[0]=o,Fe[1]=n,t.viewport(0,0,o,n),t.clearColor(0,0,0,1),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.frontFace(t.CCW),t.clear(t.COLOR_BUFFER_BIT),s.bind(),t.uniform1f(this._uCameraNear,h),t.uniform1f(this._uCameraFar,l),t.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,u),t.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,c),t.uniform1i(this._uPerspective,d),t.uniform1f(this._uScale,r.scale*(l/5)),t.uniform1f(this._uIntensity,r.intensity),t.uniform1f(this._uBias,r.bias),t.uniform1f(this._uKernelRadius,r.kernelRadius),t.uniform1f(this._uMinResolution,r.minResolution),t.uniform2fv(this._uViewport,Fe),t.uniform1f(this._uRandomSeed,p);const m=e.getDepthTexture();s.bindTexture(this._uDepthTexture,m,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),t.drawElements(t.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0);}_build(){let e=!1;const t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),!e)return;const s=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new xe(s,{vertex:["#version 300 es\n                    precision highp float;\n                    precision highp int;\n                    \n                    in vec3 aPosition;\n                    in vec2 aUV;            \n                    \n                    out vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:[`#version 300 es      \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ${this._numSamples}\n                #define NUM_RINGS 4              \n            \n                in vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                out vec4 outColor;\n   \n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \toutColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }`]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const i=new Float32Array([1,1,0,1,0,0,1,0]),r=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new Me(s,s.ARRAY_BUFFER,r,r.length,3,s.STATIC_DRAW),this._uvBuf=new Me(s,s.ARRAY_BUFFER,i,i.length,2,s.STATIC_DRAW),this._indicesBuf=new Me(s,s.ELEMENT_ARRAY_BUFFER,o,o.length,1,s.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1;}destroy(){this._program&&(this._program.destroy(),this._program=null);}}const Ee=new Float32Array(ke(17,[0,1])),Se=new Float32Array(ke(17,[1,0])),Re=new Float32Array(function(e,t){const s=[];for(let i=0;i<=e;i++)s.push(Ne(i,t));return s}(17,4)),Oe=new Float32Array(2);class Le{constructor(e){this._scene=e,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init();}init(){const e=this._scene.canvas.gl;if(this._program=new xe(e,{vertex:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                in vec3 aPosition;\n                in vec2 aUV;\n                uniform vec2 uViewport;\n                out vec2 vUV;\n                out vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                in vec2        vUV;\n                in vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                out vec4 outColor;\n        \n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    outColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const t=new Float32Array([1,1,0,1,0,0,1,0]),s=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),i=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new Me(e,e.ARRAY_BUFFER,s,s.length,3,e.STATIC_DRAW),this._uvBuf=new Me(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new Me(e,e.ELEMENT_ARRAY_BUFFER,i,i.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV");}render(e,t,s){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let e=!0;this._scene.camera.on("projMatrix",(function(){e=!0;}));const t=f.mat4();return ()=>(e&&f.inverseMat4(o.camera.projMatrix,t),t)})());const i=this._scene.canvas.gl,r=this._program,o=this._scene,n=i.drawingBufferWidth,a=i.drawingBufferHeight,h=o.camera.project._state,l=h.near,u=h.far;i.viewport(0,0,n,a),i.clearColor(0,0,0,1),i.enable(i.DEPTH_TEST),i.disable(i.BLEND),i.frontFace(i.CCW),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),r.bind(),Oe[0]=n,Oe[1]=a,i.uniform2fv(this._uViewport,Oe),i.uniform1f(this._uCameraNear,l),i.uniform1f(this._uCameraFar,u),i.uniform1f(this._uDepthCutoff,.01),0===s?i.uniform2fv(this._uSampleOffsets,Se):i.uniform2fv(this._uSampleOffsets,Ee),i.uniform1fv(this._uSampleWeights,Re);const c=e.getDepthTexture(),p=t.getTexture();r.bindTexture(this._uDepthTexture,c,0),r.bindTexture(this._uOcclusionTexture,p,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0);}destroy(){this._program.destroy();}}function Ne(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)}function ke(e,t){const s=[];for(let i=0;i<=e;i++)s.push(t[0]*i),s.push(t[1]*i);return s}const je=function(){const e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return {saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const s=!!e.getContext("2d").getImageData,i=!!e.toDataURL,r=!!window.btoa,o=function(e){let s="";const i=e.width,r=e.height;s+="BM";let o=i*r*4+54;s+=t(o%256),o=Math.floor(o/256),s+=t(o%256),o=Math.floor(o/256),s+=t(o%256),o=Math.floor(o/256),s+=t(o%256),s+=t(0,0,0,0,54,0,0,0),s+=t(40,0,0,0);let n=i;s+=t(n%256),n=Math.floor(n/256),s+=t(n%256),n=Math.floor(n/256),s+=t(n%256),n=Math.floor(n/256),s+=t(n%256);let a=r;s+=t(a%256),a=Math.floor(a/256),s+=t(a%256),a=Math.floor(a/256),s+=t(a%256),a=Math.floor(a/256),s+=t(a%256),s+=t(1,0,32,0),s+=t(0,0,0,0);let h=i*r*4;s+=t(h%256),h=Math.floor(h/256),s+=t(h%256),h=Math.floor(h/256),s+=t(h%256),h=Math.floor(h/256),s+=t(h%256),s+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const l=e.data;let u,c,p,d,f="",m=r;do{for(p=i*(m-1)*4,d="",u=0;u<i;u++)c=4*u,d+=t(l[p+c+2],l[p+c+1],l[p+c],l[p+c+3]);f+=d;}while(--m);return function(e){let s,i,r="";if("string"==typeof e)r=e;else for(i=e,s=0;s<i.length;s++)r+=t(i[s]);return btoa(r)}(s+f)},n=function(e){window.open(e)||(document.location.href=e);},a=function(e,t){return "data:"+t+";base64,"+e},h=function(e){const t=document.createElement("img");return t.src=e,t},l=function(e,t,s,i){if(t&&s){const r=document.createElement("canvas");r.width=t,r.height=s,r.style.width=t+"px",r.style.height=s+"px";const o=r.getContext("2d");return i?(o.save(),o.scale(1,-1),o.imageSmoothingEnabled=!0,o.drawImage(e,0,0,e.width,e.height,0,0,t,-s),o.restore()):(o.imageSmoothingEnabled=!0,o.drawImage(e,0,0,e.width,e.height,0,0,t,s)),r}return e};return {saveAsPNG:function(e,t,s,r,o){if(!i)return !1;const a=l(e,s,r,o).toDataURL("image/png");return t?h(a):(n(a),!0)},saveAsJPEG:function(e,t,s,r,o){if(!i)return !1;const a="image/jpeg",u=l(e,s,r,o).toDataURL(a);return 5==u.indexOf(a)&&(t?h(u):(n(u),!0))},saveAsBMP:function(e,t,u,c,p){if(!(i&&s&&r))return !1;const d="image/bmp",f=function(e){const t=parseInt(e.width),s=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,s)}(l(e,u,c,p)),m=o(f);return t?h(a(m,d)):(n(a(m,d)),!0)}}}();class Ge{constructor(e,t,s){s=s||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=s.size,this._hasDepthTexture=!!s.depthTexture;}setSize(e){this.size=e;}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1;}bind(){if(this._touch(),this.bound)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0;}_touch(){let e,t;const s=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=s.drawingBufferWidth,t=s.drawingBufferHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;s.deleteTexture(this.buffer.texture),s.deleteFramebuffer(this.buffer.framebuf),s.deleteRenderbuffer(this.buffer.renderbuf);}const i=s.createTexture();let r;s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,s.UNSIGNED_BYTE,null),this._hasDepthTexture&&(r=s.createTexture(),s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT32F,e,t,0,s.DEPTH_COMPONENT,s.FLOAT,null));const o=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,o),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT32F,e,t);const n=s.createFramebuffer();if(s.bindFramebuffer(s.FRAMEBUFFER,n),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,i,0),this._hasDepthTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_2D,r,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,o),s.bindTexture(s.TEXTURE_2D,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,n),!s.isFramebuffer(n))throw "Invalid framebuffer";s.bindFramebuffer(s.FRAMEBUFFER,null);const a=s.checkFramebufferStatus(s.FRAMEBUFFER);switch(a){case s.FRAMEBUFFER_COMPLETE:break;case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw "Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw "Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw "Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case s.FRAMEBUFFER_UNSUPPORTED:throw "Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw "Incomplete framebuffer: "+a}this.buffer={framebuf:n,renderbuf:o,texture:i,depthTexture:r,width:e,height:t},this.bound=!1;}clear(){if(!this.bound)throw "Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);}read(e,t){const s=e,i=this.gl.drawingBufferHeight-t,r=new Uint8Array(4),o=this.gl;return o.readPixels(s,i,1,1,o.RGBA,o.UNSIGNED_BYTE,r),r}readImage(e){const t=this.gl,s=this._getImageDataCache(),i=s.pixelData,r=s.canvas,o=s.imageData,n=s.context;t.readPixels(0,0,this.buffer.width,this.buffer.height,t.RGBA,t.UNSIGNED_BYTE,i),o.data.set(i),n.putImageData(o,0,0);const a=e.width||r.width,h=e.height||r.height,l=e.format||"jpeg",u=!0;let c;switch(l){case"jpeg":c=je.saveAsJPEG(r,!0,a,h,u);break;case"png":c=je.saveAsPNG(r,!0,a,h,u);break;case"bmp":c=je.saveAsBMP(r,!0,a,h,u);break;default:console.error("Unsupported image format: '"+l+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),c=je.saveAsJPEG(r,!0,a,h,u);}return c.src}_getImageDataCache(){const e=this.buffer.width,t=this.buffer.height;let s=this._imageDataCache;if(s&&(s.width===e&&s.height===t||(this._imageDataCache=null,s=null)),!s){const i=document.createElement("canvas");i.width=e,i.height=t;const r=i.getContext("2d"),o=r.createImageData(e,t);s={pixelData:new Uint8Array(e*t*4),canvas:i,context:r,imageData:o,width:e,height:t},this._imageDataCache=s;}return s}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1;}getTexture(){const e=this;return this._texture||(this._texture={renderBuffer:this,bind:function(t){return !(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null));}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return !(!e.buffer||!e.buffer.depthTexture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0)},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null));}})}destroy(){if(this.allocated){const e=this.gl;e.deleteTexture(this.buffer.texture),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1;}this._imageDataCache=null,this._texture=null,this._depthTexture=null;}}class He{constructor(e){this.scene=e,this._renderBuffersBasic={},this._renderBuffersScaled={};}getRenderBuffer(e,t){const s=1===this.scene.canvas.resolutionScale?this._renderBuffersBasic:this._renderBuffersScaled;let i=s[e];return i||(i=new Ge(this.scene.canvas.canvas,this.scene.canvas.gl,t),s[e]=i),i}destroy(){for(let e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(let e in this._renderBuffersScaled)this._renderBuffersScaled[e].destroy();}}function Ve(e,t){if(void 0===e._cachedExtensions&&(e._cachedExtensions={}),void 0!==e._cachedExtensions[t])return e._cachedExtensions[t];let s;switch(t){case"WEBGL_depth_texture":s=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":s=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":s=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":s=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:s=e.getExtension(t);}return e._cachedExtensions[t]=s,s}const Ue=function(e,t){t=t||{};const i=new ge(e),r=e.canvas.canvas,o=e.canvas.gl,n=!!t.transparent,a=t.alphaDepthMask,h=new s({});let l={},u={},c=!0,p=!0,d=!0,m=!0,_=!0,y=!0,v=!0,b=!0;const w=new He(e);let P=!1;const T=new Be(e),x=new Le(e);function M(){c&&(!function(){for(let e in l)if(l.hasOwnProperty(e)){const t=l[e],s=t.drawableMap,i=t.drawableListPreCull;let r=0;for(let e in s)s.hasOwnProperty(e)&&(i[r++]=s[e]);i.length=r;}}(),c=!1,p=!0),p&&(!function(){for(let e in l)if(l.hasOwnProperty(e)){const t=l[e];t.isStateSortable&&t.drawableListPreCull.sort(t.stateSortCompare);}}(),p=!1,d=!0),d&&function(){for(let e in l)if(l.hasOwnProperty(e)){const t=l[e],s=t.drawableListPreCull,i=t.drawableList;let r=0;for(let e=0,t=s.length;e<t;e++){const t=s[e];t.rebuildRenderFlags(),t.renderFlags.culled||(i[r++]=t);}i.length=r;}}();}function D(e){if(!e.castsShadow)return;const t=e.getShadowRenderBuf();if(t){t.bind(),i.reset(),i.backfaces=!0,i.frontface=!0,i.shadowViewMatrix=e.getShadowViewMatrix(),i.shadowProjMatrix=e.getShadowProjMatrix(),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,1),o.enable(o.DEPTH_TEST),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in l)if(l.hasOwnProperty(e)){const t=l[e].drawableList;for(let e=0,s=t.length;e<s;e++){const s=t[e];!1!==s.visible&&s.castsShadow&&s.drawShadow&&(s.renderFlags.colorOpaque&&s.drawShadow(i));}}t.unbind();}}this._occlusionTester=null,this.capabilities={astcSupported:!!Ve(o,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!Ve(o,"WEBGL_compressed_texture_etc"),dxtSupported:!!Ve(o,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!Ve(o,"EXT_texture_compression_bptc"),pvrtcSupported:!(!Ve(o,"WEBGL_compressed_texture_pvrtc")&&!Ve(o,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(e){m=e,d=!0;},this.setEdgesEnabled=function(e){_=e,d=!0;},this.setSAOEnabled=function(e){y=e,d=!0;},this.setPBREnabled=function(e){v=e,d=!0;},this.setColorTextureEnabled=function(e){b=e,d=!0;},this.needStateSort=function(){p=!0;},this.shadowsDirty=function(){},this.imageDirty=function(){d=!0;},this.webglContextLost=function(){},this.webglContextRestored=function(e){T.init(),x.init(),d=!0;},this.addDrawable=function(e,t){const s=t.type;if(!s)return void console.error("Renderer#addDrawable() : drawable with ID "+e+" has no 'type' - ignoring");let i=l[s];i||(i={type:t.type,count:0,isStateSortable:t.isStateSortable,stateSortCompare:t.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},l[s]=i),i.count++,i.drawableMap[e]=t,u[e]=t,c=!0;},this.removeDrawable=function(e){const t=u[e];if(!t)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+e+" - ignoring");const s=t.type,i=l[s];--i.count<=0?delete l[s]:delete i.drawableMap[e],delete u[e],c=!0;},this.getPickID=function(e){return h.addItem(e)},this.putPickID=function(e){h.removeItem(e);},this.clear=function(t){if(o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),n)o.clearColor(1,1,1,1);else {const t=e.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():e.canvas.backgroundColor;o.clearColor(t[0],t[1],t[2],1);}o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);},this.needsRender=function(){return d||c||p},this.render=function(t){(t=t||{}).force&&(d=!0),M(),d&&(!function(t){const s=e.sao;y&&s.possible&&function(t){const s=e.sao,r=w.getRenderBuffer("saoDepth",{depthTexture:!0});r.bind(),r.clear(),function(e){i.reset(),i.pass=e.pass,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),!1!==e.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in l)if(l.hasOwnProperty(e)){const t=l[e].drawableList;for(let e=0,s=t.length;e<s;e++){const s=t[e];!0!==s.culled&&!1!==s.visible&&s.drawDepth&&(s.renderFlags.colorOpaque&&s.drawDepth(i));}}}(t),r.unbind();const n=w.getRenderBuffer("saoOcclusion");if(n.bind(),n.clear(),T.render(r),n.unbind(),s.blur){const e=w.getRenderBuffer("saoOcclusion2");e.bind(),e.clear(),x.render(r,n,0),e.unbind(),n.bind(),n.clear(),x.render(r,e,1),n.unbind();}}(t);(function(){let t=e._lightsState.lights;for(let e=0,s=t.length;e<s;e++){const s=t[e];s.castsShadow&&D(s);}})(),A(t);}(t),g.frame.frameCount++,d=!1);};const A=function(){const t=[],s=[],r=[],h=[],u=[],c=[],p=[],d=[],f=[],P=[],T=[],x=[],M=[],D=[],A=[],C=[];return function(I){const F=e._lightsState.getAmbientColorAndIntensity();if(i.reset(),i.pass=I.pass,i.withSAO=!1,i.pbrEnabled=v&&!!e.pbrEnabled,i.colorTextureEnabled=b&&!!e.colorTextureEnabled,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),n)o.clearColor(0,0,0,0);else {const t=e.canvas.backgroundColorFromAmbientLight?F:e.canvas.backgroundColor;o.clearColor(t[0],t[1],t[2],1);}o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),o.lineWidth(1),i.lineWidth=1;const B=e.sao.possible;if(y&&B){const e=w.getRenderBuffer("saoOcclusion");i.occlusionTexture=e?e.getTexture():null;}else i.occlusionTexture=null;let E,S,R;const O=Date.now();!1!==I.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);let L=0,N=0,k=0,j=0,G=0,H=0,V=0,U=0,z=0,W=0,X=0,Y=0,K=0,J=0,Z=0,Q=0;for(let e in l)if(l.hasOwnProperty(e)){const o=l[e].drawableList;for(E=0,S=o.length;E<S;E++){if(R=o[E],!0===R.culled||!1===R.visible)continue;const e=R.renderFlags;e.colorOpaque&&(y&&B&&R.saoEnabled?t[L++]=R:R.drawColorOpaque(i)),m&&e.colorTransparent&&(r[k++]=R),e.xrayedSilhouetteTransparent&&(p[V++]=R),e.xrayedSilhouetteOpaque&&(u[G++]=R),e.highlightedSilhouetteTransparent&&(T[X++]=R),e.highlightedSilhouetteOpaque&&(f[z++]=R),e.selectedSilhouetteTransparent&&(A[Z++]=R),e.selectedSilhouetteOpaque&&(M[K++]=R),_&&(e.edgesOpaque&&(s[N++]=R),e.edgesTransparent&&(h[j++]=R)),e.selectedEdgesTransparent&&(C[Q++]=R),e.selectedEdgesOpaque&&(D[J++]=R),e.xrayedEdgesTransparent&&(d[U++]=R),e.xrayedEdgesOpaque&&(c[H++]=R),e.highlightedEdgesTransparent&&(x[Y++]=R),e.highlightedEdgesOpaque&&(P[W++]=R);}}if(L>0)for(i.withSAO=!0,E=0;E<L;E++)t[E].drawColorOpaque(i);if(N>0)for(E=0;E<N;E++)s[E].drawEdgesColorOpaque(i);if(G>0)for(E=0;E<G;E++)u[E].drawSilhouetteXRayed(i);if(H>0)for(E=0;E<H;E++)c[E].drawEdgesXRayed(i);if(V>0||U>0||k>0||j>0){if(o.enable(o.CULL_FACE),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):(o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,a||o.depthMask(!1),(k>0||j>0)&&o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),j>0)for(E=0;E<j;E++)R=h[E],R.drawEdgesColorTransparent(i);if(k>0)for(E=0;E<k;E++)R=r[E],R.drawColorTransparent(i);if(U>0)for(E=0;E<U;E++)d[E].drawEdgesXRayed(i);if(V>0)for(E=0;E<V;E++)p[E].drawSilhouetteXRayed(i);o.disable(o.BLEND),a||o.depthMask(!0);}if(z>0||W>0){if(i.lastProgramId=null,e.highlightMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),W>0)for(E=0;E<W;E++)P[E].drawEdgesHighlighted(i);if(z>0)for(E=0;E<z;E++)f[E].drawSilhouetteHighlighted(i);}if(X>0||Y>0||z>0){if(i.lastProgramId=null,e.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.enable(o.CULL_FACE),Y>0)for(E=0;E<Y;E++)x[E].drawEdgesHighlighted(i);if(X>0)for(E=0;E<X;E++)T[E].drawSilhouetteHighlighted(i);o.disable(o.BLEND);}if(K>0||J>0){if(i.lastProgramId=null,e.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),J>0)for(E=0;E<J;E++)D[E].drawEdgesSelected(i);if(K>0)for(E=0;E<K;E++)M[E].drawSilhouetteSelected(i);}if(Z>0||Q>0){if(i.lastProgramId=null,e.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),Q>0)for(E=0;E<Q;E++)C[E].drawEdgesSelected(i);if(Z>0)for(E=0;E<Z;E++)A[E].drawSilhouetteSelected(i);o.disable(o.BLEND);}const q=Date.now(),$=g.frame;$.renderTime=(q-O)/1e3,$.drawElements=i.drawElements,$.drawArrays=i.drawArrays,$.useProgram=i.useProgram,$.bindTexture=i.bindTexture,$.bindArray=i.bindArray;const ee=pe.MAX_TEXTURE_IMAGE_UNITS;for(let e=0;e<ee;e++)o.activeTexture(o.TEXTURE0+e);o.bindTexture(o.TEXTURE_CUBE_MAP,null),o.bindTexture(o.TEXTURE_2D,null);const te=pe.MAX_VERTEX_ATTRIBS;for(let e=0;e<te;e++)o.disableVertexAttribArray(e);}}();this.pick=function(){const t=f.vec3(),s=f.mat4(),n=f.mat4(),a=f.vec3(),u=f.vec3([0,1,0]),c=new _e,p=f.vec2(),d=f.vec3(),m=f.vec3(),g=f.vec3(),_=f.vec3(),y=f.vec3();return function(v,b=c){let P;b.reset(),M();let T=null,x=null;if(b.pickSurface=v.pickSurface,v.canvasPos)d[0]=v.canvasPos[0],d[1]=v.canvasPos[1],T=e.camera.viewMatrix,x=e.camera.projMatrix,b.canvasPos=v.canvasPos;else {const i=f.frustumMat4(-1,1,-1,1,.01,e.camera.project.far,s);v.matrix?(T=v.matrix,x=i):(m.set(v.origin||[0,0,0]),g.set(v.direction||[0,0,1]),P=f.addVec3(m,g,t),a[0]=Math.random(),a[1]=Math.random(),a[2]=Math.random(),f.normalizeVec3(a),f.cross3Vec3(g,a,u),T=f.lookAtMat4v(m,P,u,n),x=i,b.origin=m,b.direction=g),d[0]=.5*r.clientWidth,d[1]=.5*r.clientHeight;}const D=w.getRenderBuffer("pick");D.bind();const A=function(t,s,r,n,a){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=r,i.pickProjMatrix=n,i.pickInvisible=!!a.pickInvisible,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const u=a.includeEntityIds,c=a.excludeEntityIds;for(let e in l)if(l.hasOwnProperty(e)){const t=l[e].drawableList;for(let e=0,s=t.length;e<s;e++){const s=t[e];!s.drawPickMesh||!0===s.culled||!0!==a.pickInvisible&&!1===s.visible||!1===s.pickable||(u&&!u[s.id]||c&&c[s.id]||s.drawPickMesh(i));}}const p=e.canvas.resolutionScale,d=t.read(Math.round(s[0]*p),Math.round(s[1]*p));let f=d[0]+256*d[1]+256*d[2]*256+256*d[3]*256*256;if(f<0)return;return h.items[f]}(D,d,T,x,v);if(!A)return D.unbind(),null;const I=A.delegatePickedEntity?A.delegatePickedEntity():A;return I?(v.pickSurface&&(v.pickSurfacePrecision&&e.pickSurfacePrecisionEnabled?(v.canvasPos&&f.canvasPosToWorldRay(e.canvas.canvas,T,x,d,m,g),A.precisionRayPickSurface(m,g,_,y)&&(b.worldPos=_,!1!==v.pickSurfaceNormal&&(b.worldNormal=y),b.pickSurfacePrecision=!0)):A.canPickTriangle&&A.canPickTriangle()?(!function(t,s,r,n,a,h){if(!s.drawPickTriangles)return;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=n,i.pickProjMatrix=a,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),s.drawPickTriangles(i);const l=e.canvas.resolutionScale,u=t.read(Math.round(r[0]*l),Math.round(r[1]*l));let c=u[0]+256*u[1]+256*u[2]*256+256*u[3]*256*256;c*=3,h.primIndex=c;}(D,A,d,T,x,b),A.pickTriangleSurface(T,x,b),b.pickSurfacePrecision=!1):A.canPickWorldPos&&A.canPickWorldPos()&&(p[0]=e.camera.project.near,p[1]=e.camera.project.far,C(D,A,d,T,x,p,b),!1!==v.pickSurfaceNormal&&function(t,s,r,n,a,h){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=n,i.pickProjMatrix=a,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),s.drawPickNormals(i);const l=e.canvas.resolutionScale,u=t.read(Math.round(r[0]*l),Math.round(r[1]*l)),c=[u[0]/256-.5,u[1]/256-.5,u[2]/256-.5];f.normalizeVec3(c),h.worldNormal=c;}(D,A,d,T,x,b),b.pickSurfacePrecision=!1)),D.unbind(),b.entity=I,b):(D.unbind(),null)}}();const C=function(){const t=f.vec4(),s=f.vec4(),n=f.vec4(),a=f.vec4(),h=f.vec4(),l=f.mat4(),u=f.mat4(),c=f.mat4();return function(p,d,m,g,_,y,v){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=g,i.pickProjMatrix=_,i.pickZNear=y[0],i.pickZFar=y[1],o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),d.drawPickDepths(i);const b=e.canvas.resolutionScale,w=function(e){const t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256],s=[1/16777216,1/65536,1/256,1];return f.dotVec4(t,s)}(p.read(Math.round(m[0]*b),Math.round(m[1]*b))),P=(m[0]-r.clientWidth/2)/(r.clientWidth/2),T=-(m[1]-r.clientHeight/2)/(r.clientHeight/2),x=d.origin;let M;if(x){const e=W(g,x,l);M=f.mulMat4(_,e,u);}else M=f.mulMat4(_,g,u);const D=f.inverseMat4(M,c);t[0]=P,t[1]=T,t[2]=-1,t[3]=1;let A=f.transformVec4(D,t);A=f.mulVec4Scalar(A,1/A[3]),s[0]=P,s[1]=T,s[2]=1,s[3]=1;let C=f.transformVec4(D,s);C=f.mulVec4Scalar(C,1/C[3]);const I=f.subVec3(C,A,n),F=f.addVec3(A,f.mulVec4Scalar(I,w,a),h);x&&f.addVec3(F,x),v.worldPos=F;}}();this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new Ie(e,w),this._occlusionTester.addMarker(t),e.occlusionTestCountdown=0;},this.markerWorldPosUpdated=function(e){this._occlusionTester.markerWorldPosUpdated(e);},this.removeMarker=function(e){this._occlusionTester.removeMarker(e);},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){M(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in l)if(l.hasOwnProperty(e)){const t=l[e].drawableList;for(let e=0,s=t.length;e<s;e++){const s=t[e];s.drawOcclusion&&!0!==s.culled&&!1!==s.visible&&!1!==s.pickable&&s.drawOcclusion(i);}}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf();}},this.readPixels=function(e,t,s,i){const r=w.getRenderBuffer("snapshot");let o,n,a,h;for(r.bind(),r.clear(),this.render({force:!0,opaqueOnly:i}),n=0;n<s;n++)a=2*n,h=4*n,o=r.read(e[a],e[a+1]),t[h]=o[0],t[h+1]=o[1],t[h+2]=o[2],t[h+3]=o[3];r.unbind(),d=!0;},this.beginSnapshot=function(){const e=w.getRenderBuffer("snapshot");e.bind(),e.clear(),P=!0;},this.renderSnapshot=function(){if(!P)return;w.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),d=!0;},this.readSnapshot=function(e){return w.getRenderBuffer("snapshot").readImage(e)},this.endSnapshot=function(){if(!P)return;w.getRenderBuffer("snapshot").unbind(),P=!1;},this.destroy=function(){l={},u={},w.destroy(),T.destroy(),x.destroy(),this._occlusionTester&&this._occlusionTester.destroy();};};class ze extends B{constructor(e,t={}){super(e,t),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=t.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=f.vec2(),this._keyboardEventsElement=t.keyboardEventsElement||document,this._bindEvents();}_bindEvents(){if(!this._eventsBound){this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=e=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===this.KEY_CTRL?this.ctrlDown=!0:e.keyCode===this.KEY_ALT?this.altDown=!0:e.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[e.keyCode]=!0,this.fire("keydown",e.keyCode,!0));},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=e=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===this.KEY_CTRL?this.ctrlDown=!1:e.keyCode===this.KEY_ALT?this.altDown=!1:e.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[e.keyCode]=!1,this.fire("keyup",e.keyCode,!0));}),this.element.addEventListener("mouseenter",this._mouseEnterListener=e=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(e),this.fire("mouseenter",this.mouseCanvasPos,!0));}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=e=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(e),this.fire("mouseleave",this.mouseCanvasPos,!0));}),this.element.addEventListener("mousedown",this._mouseDownListener=e=>{if(this.enabled){switch(e.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0;}this._getMouseCanvasPos(e),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault();}}),document.addEventListener("mouseup",this._mouseUpListener=e=>{if(this.enabled){switch(e.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1;}this.fire("mouseup",this.mouseCanvasPos,!0);}},!0),document.addEventListener("click",this._clickListener=e=>{if(this.enabled){switch(e.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;}this._getMouseCanvasPos(e),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault();}}),document.addEventListener("dblclick",this._dblClickListener=e=>{if(this.enabled){switch(e.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;}this._getMouseCanvasPos(e),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault();}}),this.element.addEventListener("mousemove",this._mouseMoveListener=e=>{this.enabled&&(this._getMouseCanvasPos(e),this.fire("mousemove",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault());}),this.element.addEventListener("wheel",this._mouseWheelListener=(e,t)=>{if(!this.enabled)return;const s=Math.max(-1,Math.min(1,40*-e.deltaY));this.fire("mousewheel",s,!0);},{passive:!0});{let e,t;const s=2;this.on("mousedown",(s=>{e=s[0],t=s[1];})),this.on("mouseup",(i=>{e>=i[0]-s&&e<=i[0]+s&&t>=i[1]-s&&t<=i[1]+s&&this.fire("mouseclicked",i,!0);}));}this._eventsBound=!0;}}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1);}_getMouseCanvasPos(e){if(e){let t=e.target,s=0,i=0;for(;t.offsetParent;)s+=t.offsetLeft,i+=t.offsetTop,t=t.offsetParent;this.mouseCanvasPos[0]=e.pageX-s,this.mouseCanvasPos[1]=e.pageY-i;}else e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y;}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e);}getEnabled(){return this.enabled}setKeyboardEnabled(e){this.keyboardEnabled=e;}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents();}}const We=new s({});class Xe{constructor(e){this.id=We.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);}destroy(){We.removeItem(this.id);}}class Ye extends B{get type(){return "Viewport"}constructor(e,t={}){super(e,t),this._state=new Xe({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary;}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]];}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary);}}get boundary(){return this._state.boundary}set autoBoundary(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(e){const t=e[2],s=e[3];this._state.boundary=[0,0,t,s],this.glRedraw(),this.fire("boundary",this._state.boundary);}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary));}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy();}}class Ke extends B{get type(){return "Perspective"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Xe({matrix:f.mat4(),inverseMatrix:f.mat4(),transposedMatrix:f.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=t.fov,this.fovAxis=t.fovAxis,this.near=t.near,this.far=t.far;}_update(){const e=this.scene.viewport.boundary,t=e[2]/e[3],s=this._fovAxis;let i=this._fov;("x"===s||"min"===s&&t<1||"max"===s&&t>1)&&(i/=t),i=Math.min(i,120),f.perspectiveMat4(i*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix);}set fov(e){(e=null!=e?e:60)!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov));}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis));}get fovAxis(){return this._fovAxis}set near(e){const t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near));}get near(){return this._state.near}set far(e){const t=null!=e?e:2e3;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far));}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,s,i,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return s[0]=(e[0]-n)/n,s[1]=(e[1]-a)/a,s[2]=t,s[3]=1,f.mulMat4v4(this.inverseMatrix,s,i),f.mulVec3Scalar(i,1/i[3]),i[3]=1,i[1]*=-1,f.mulMat4v4(this.camera.inverseViewMatrix,i,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized);}}class Je extends B{get type(){return "Ortho"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Xe({matrix:f.mat4(),inverseMatrix:f.mat4(),transposedMatrix:f.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this);}_update(){const e=this.scene,t=.5*this._scale,s=e.viewport.boundary,i=s[2],r=s[3],o=i/r;let n,a,h,l;i>r?(n=-t,a=t,h=t/o,l=-t/o):(n=-t*o,a=t*o,h=t,l=-t),f.orthoMat4c(n,a,l,h,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix);}set scale(e){null==e&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale);}get scale(){return this._scale}set near(e){const t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near));}get near(){return this._state.near}set far(e){const t=null!=e?e:2e3;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far));}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,s,i,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return s[0]=(e[0]-n)/n,s[1]=(e[1]-a)/a,s[2]=t,s[3]=1,f.mulMat4v4(this.inverseMatrix,s,i),f.mulVec3Scalar(i,1/i[3]),i[3]=1,i[1]*=-1,f.mulMat4v4(this.camera.inverseViewMatrix,i,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary);}}class Ze extends B{get type(){return "Frustum"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Xe({matrix:f.mat4(),inverseMatrix:f.mat4(),transposedMatrix:f.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far;}_update(){f.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix);}set left(e){this._left=null!=e?e:-1,this._needUpdate(0),this.fire("left",this._left);}get left(){return this._left}set right(e){this._right=null!=e?e:1,this._needUpdate(0),this.fire("right",this._right);}get right(){return this._right}set top(e){this._top=null!=e?e:1,this._needUpdate(0),this.fire("top",this._top);}get top(){return this._top}set bottom(e){this._bottom=null!=e?e:-1,this._needUpdate(0),this.fire("bottom",this._bottom);}get bottom(){return this._bottom}set near(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near);}get near(){return this._state.near}set far(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far);}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,s,i,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return s[0]=(e[0]-n)/n,s[1]=(e[1]-a)/a,s[2]=t,s[3]=1,f.mulMat4v4(this.inverseMatrix,s,i),f.mulVec3Scalar(i,1/i[3]),i[3]=1,i[1]*=-1,f.mulMat4v4(this.camera.inverseViewMatrix,i,r),r}destroy(){super.destroy(),this._state.destroy(),super.destroy();}}class Qe extends B{get type(){return "CustomProjection"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Xe({matrix:f.mat4(),inverseMatrix:f.mat4(),transposedMatrix:f.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=t.matrix;}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("far",this._state.matrix);}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(f.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(f.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,s,i,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return s[0]=(e[0]-n)/n,s[1]=(e[1]-a)/a,s[2]=t,s[3]=1,f.mulMat4v4(this.inverseMatrix,s,i),f.mulVec3Scalar(i,1/i[3]),i[3]=1,i[1]*=-1,f.mulMat4v4(this.camera.inverseViewMatrix,i,r),r}destroy(){super.destroy(),this._state.destroy();}}const qe=f.vec3(),$e=f.vec3(),et=f.vec3(),tt=f.vec3(),st=f.vec3(),it=f.vec3(),rt=f.mat4(),ot=f.mat4(),nt=f.vec3(),at=f.vec3(),ht=f.vec3(),lt=f.vec3();class ut extends B{get type(){return "Camera"}constructor(e,t={}){super(e,t),this._state=new Xe({deviceMatrix:f.mat4(),hasDeviceMatrix:!1,matrix:f.mat4(),normalMatrix:f.mat4(),inverseMatrix:f.mat4()}),this._perspective=new Ke(this),this._ortho=new Je(this),this._frustum=new Ze(this),this._customProjection=new Qe(this),this._project=this._perspective,this._eye=f.vec3([0,0,10]),this._look=f.vec3([0,0,0]),this._up=f.vec3([0,1,0]),this._worldUp=f.vec3([0,1,0]),this._worldRight=f.vec3([1,0,0]),this._worldForward=f.vec3([0,0,-1]),this.deviceMatrix=t.deviceMatrix,this.eye=t.eye,this.look=t.look,this.up=t.up,this.worldAxis=t.worldAxis,this.gimbalLock=t.gimbalLock,this.constrainPitch=t.constrainPitch,this.projection=t.projection,this._perspective.on("matrix",(()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix);})),this._ortho.on("matrix",(()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix);})),this._frustum.on("matrix",(()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix);})),this._customProjection.on("matrix",(()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix);}));}_update(){const e=this._state;let t;"ortho"===this.projection?(f.subVec3(this._eye,this._look,nt),f.normalizeVec3(nt,at),f.mulVec3Scalar(at,1e3,ht),f.addVec3(this._look,ht,lt),t=lt):t=this._eye,e.hasDeviceMatrix?(f.lookAtMat4v(t,this._look,this._up,ot),f.mulMat4(e.deviceMatrix,ot,e.matrix)):f.lookAtMat4v(t,this._look,this._up,e.matrix),f.inverseMat4(this._state.matrix,this._state.inverseMatrix),f.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix);}orbitYaw(e){let t=f.subVec3(this._eye,this._look,qe);f.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,rt),t=f.transformPoint3(rt,t,$e),this.eye=f.addVec3(this._look,t,et),this.up=f.transformPoint3(rt,this._up,tt);}orbitPitch(e){if(this._constrainPitch&&(e=f.dotVec3(this._up,this._worldUp)/f.DEGTORAD)<1)return;let t=f.subVec3(this._eye,this._look,qe);const s=f.cross3Vec3(f.normalizeVec3(t,$e),f.normalizeVec3(this._up,et));f.rotationMat4v(.0174532925*e,s,rt),t=f.transformPoint3(rt,t,tt),this.up=f.transformPoint3(rt,this._up,st),this.eye=f.addVec3(t,this._look,it);}yaw(e){let t=f.subVec3(this._look,this._eye,qe);f.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,rt),t=f.transformPoint3(rt,t,$e),this.look=f.addVec3(t,this._eye,et),this._gimbalLock&&(this.up=f.transformPoint3(rt,this._up,tt));}pitch(e){if(this._constrainPitch&&(e=f.dotVec3(this._up,this._worldUp)/f.DEGTORAD)<1)return;let t=f.subVec3(this._look,this._eye,qe);const s=f.cross3Vec3(f.normalizeVec3(t,$e),f.normalizeVec3(this._up,et));f.rotationMat4v(.0174532925*e,s,rt),this.up=f.transformPoint3(rt,this._up,it),t=f.transformPoint3(rt,t,tt),this.look=f.addVec3(t,this._eye,st);}pan(e){const t=f.subVec3(this._eye,this._look,qe),s=[0,0,0];let i;if(0!==e[0]){const r=f.cross3Vec3(f.normalizeVec3(t,[]),f.normalizeVec3(this._up,$e));i=f.mulVec3Scalar(r,e[0]),s[0]+=i[0],s[1]+=i[1],s[2]+=i[2];}0!==e[1]&&(i=f.mulVec3Scalar(f.normalizeVec3(this._up,et),e[1]),s[0]+=i[0],s[1]+=i[1],s[2]+=i[2]),0!==e[2]&&(i=f.mulVec3Scalar(f.normalizeVec3(t,tt),e[2]),s[0]+=i[0],s[1]+=i[1],s[2]+=i[2]),this.eye=f.addVec3(this._eye,s,st),this.look=f.addVec3(this._look,s,it);}zoom(e){const t=f.subVec3(this._eye,this._look,qe),s=Math.abs(f.lenVec3(t,$e)),i=Math.abs(s+e);if(i<.5)return;const r=f.normalizeVec3(t,et);this.eye=f.addVec3(this._look,f.mulVec3Scalar(r,i),tt);}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye);}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look);}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up);}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix);}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=f.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis);}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock);}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch);}get eyeLookDist(){return f.lenVec3(f.subVec3(this._look,this._eye,qe))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix));}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy();}}class ct extends B{get type(){return "Light"}get isLight(){return !0}constructor(e,t={}){super(e,t);}}class pt extends ct{get type(){return "DirLight"}constructor(e,t={}){super(e,t),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const s=this.scene.camera,i=this.scene.canvas;this._onCameraViewMatrix=s.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0;})),this._onCameraProjMatrix=s.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0;})),this._onCanvasBoundary=i.on("boundary",(()=>{this._shadowProjMatrixDirty=!0;})),this._state=new Xe({type:"dir",dir:f.vec3([1,1,1]),color:f.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=f.identityMat4());const e=this.scene.camera,t=this._state.dir,s=e.look,i=[s[0]-t[0],s[1]-t[1],s[2]-t[2]],r=[0,1,0];f.lookAtMat4v(i,s,r,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1;}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=f.identityMat4()),f.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new Ge(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.castsShadow=t.castsShadow,this.scene._lightCreated(this);}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw();}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw();}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw();}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw());}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw();}}class dt extends ct{get type(){return "AmbientLight"}constructor(e,t={}){super(e,t),this._state={type:"ambient",color:f.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity,this.scene._lightCreated(this);}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw();}get color(){return this._state.color}set intensity(e){this._state.intensity=void 0!==e?e:1,this.glRedraw();}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this);}}class ft extends B{get type(){return "Geometry"}get isGeometry(){return !0}constructor(e,t={}){super(e,t),g.memory.meshes++;}destroy(){super.destroy(),g.memory.meshes--;}}var mt=function(){const e=[],t=[],s=[],i=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),h=new Uint16Array(3),l=f.vec3(),u=f.vec3(),c=f.vec3(),p=f.vec3(),d=f.vec3(),m=f.vec3(),g=f.vec3();return function(_,y,v,b){!function(r,o){const n={};let a,h,l,u;const c=Math.pow(10,4);let p,d,f=0;for(p=0,d=r.length;p<d;p+=3)a=r[p],h=r[p+1],l=r[p+2],u=Math.round(a*c)+"_"+Math.round(h*c)+"_"+Math.round(l*c),void 0===n[u]&&(n[u]=f/3,e[f++]=a,e[f++]=h,e[f++]=l),t[p/3]=n[u];for(p=0,d=o.length;p<d;p++)i[p]=t[o[p]],s[i[p]]=o[p];}(_,y),function(t,s){o=0;for(let _=0,y=t;_<y;_+=3){const t=3*i[_],y=3*i[_+1],v=3*i[_+2];s?(n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],a[0]=e[y],a[1]=e[y+1],a[2]=e[y+2],h[0]=e[v],h[1]=e[v+1],h[2]=e[v+2],f.decompressPosition(n,s,l),f.decompressPosition(a,s,u),f.decompressPosition(h,s,c)):(l[0]=e[t],l[1]=e[t+1],l[2]=e[t+2],u[0]=e[y],u[1]=e[y+1],u[2]=e[y+2],c[0]=e[v],c[1]=e[v+1],c[2]=e[v+2]),f.subVec3(c,u,p),f.subVec3(l,u,d),f.cross3Vec3(p,d,m),f.normalizeVec3(m,g);const b=r[o]||(r[o]={normal:f.vec3()});b.normal[0]=g[0],b.normal[1]=g[1],b.normal[2]=g[2],o++;}}(y.length,v);const w=[],P=Math.cos(f.DEGTORAD*b),T={};let x,M,D,A,C,I,F,B,E,S,R,O=!1;for(let e=0,t=y.length;e<t;e+=3){const t=e/3;for(let s=0;s<3;s++)x=i[e+s],M=i[e+(s+1)%3],D=Math.min(x,M),A=Math.max(x,M),C=D+","+A,void 0===T[C]?T[C]={index1:D,index2:A,face1:t,face2:void 0}:T[C].face2=t;}for(C in T)I=T[C],void 0!==I.face2&&(F=r[I.face1].normal,B=r[I.face2].normal,E=f.dotVec3(F,B),E>P)||(S=s[I.index1],R=s[I.index2],(!O&&S>65535||R>65535)&&(O=!0),w.push(S),w.push(R));return O?new Uint32Array(w):new Uint16Array(w)}}();const gt=function(){const e=f.mat4(),t=f.mat4();return function(s,i){i=i||f.mat4();const r=s[0],o=s[1],n=s[2],a=s[3]-r,h=s[4]-o,l=s[5]-n,u=65535;return f.identityMat4(e),f.translationMat4v(s,e),f.identityMat4(t),f.scalingMat4v([a/u,h/u,l/u],t),f.mulMat4(e,t,i),i}}();var _t=function(){const e=f.mat4(),t=f.mat4();return function(s,i,r){const o=new Uint16Array(s.length);var n=new Float32Array([r[0]!==i[0]?65535/(r[0]-i[0]):0,r[1]!==i[1]?65535/(r[1]-i[1]):0,r[2]!==i[2]?65535/(r[2]-i[2]):0]);let a;for(a=0;a<s.length;a+=3)o[a+0]=Math.floor((s[a+0]-i[0])*n[0]),o[a+1]=Math.floor((s[a+1]-i[1])*n[1]),o[a+2]=Math.floor((s[a+2]-i[2])*n[2]);f.identityMat4(e),f.translationMat4v(i,e),f.identityMat4(t),f.scalingMat4v([(r[0]-i[0])/65535,(r[1]-i[1])/65535,(r[2]-i[2])/65535],t);return {quantized:o,decodeMatrix:f.mulMat4(e,t,f.identityMat4())}}}();var yt=function(){const e=f.mat3(),t=f.mat3();return function(s,i,r){const o=new Uint16Array(s.length),n=new Float32Array([65535/(r[0]-i[0]),65535/(r[1]-i[1])]);let a;for(a=0;a<s.length;a+=2)o[a+0]=Math.floor((s[a+0]-i[0])*n[0]),o[a+1]=Math.floor((s[a+1]-i[1])*n[1]);f.identityMat3(e),f.translationMat3v(i,e),f.identityMat3(t),f.scalingMat3v([(r[0]-i[0])/65535,(r[1]-i[1])/65535],t);return {quantized:o,decodeMatrix:f.mulMat3(e,t,f.identityMat3())}}}();function vt(e,t,s,i){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),o=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=(1-Math.abs(o))*(r>=0?1:-1),t=(1-Math.abs(r))*(o>=0?1:-1);r=e,o=t;}return new Int8Array([Math[s](127.5*r+(r<0?-1:0)),Math[i](127.5*o+(o<0?-1:0))])}function bt(e){let t=e[0],s=e[1];t/=t<0?127:128,s/=s<0?127:128;const i=1-Math.abs(t)-Math.abs(s);i<0&&(t=(1-Math.abs(s))*(t>=0?1:-1),s=(1-Math.abs(t))*(s>=0?1:-1));const r=Math.sqrt(t*t+s*s+i*i);return [t/r,s/r,i/r]}function wt(e,t,s){return e[t]*s[0]+e[t+1]*s[1]+e[t+2]*s[2]}const Pt={getPositionsBounds:function(e){const t=new Float32Array(3),s=new Float32Array(3);let i,r;for(i=0;i<3;i++)t[i]=Number.MAX_VALUE,s[i]=-Number.MAX_VALUE;for(i=0;i<e.length;i+=3)for(r=0;r<3;r++)t[r]=Math.min(t[r],e[i+r]),s[r]=Math.max(s[r],e[i+r]);return {min:t,max:s}},createPositionsDecodeMatrix:gt,compressPositions:_t,compressPosition:function(e,t,s){const i=new Float32Array([t[3]!==t[0]?65535/(t[3]-t[0]):0,t[4]!==t[1]?65535/(t[4]-t[1]):0,t[5]!==t[2]?65535/(t[5]-t[2]):0]);s[0]=Math.floor((e[0]-t[0])*i[0]),s[1]=Math.floor((e[1]-t[1])*i[1]),s[2]=Math.floor((e[2]-t[2])*i[2]);},decompressPositions:function(e,t,s=new Float32Array(e.length)){for(let i=0,r=e.length;i<r;i+=3)s[i+0]=e[i+0]*t[0]+t[12],s[i+1]=e[i+1]*t[5]+t[13],s[i+2]=e[i+2]*t[10]+t[14];return s},decompressPosition:function(e,t,s){return s[0]=e[0]*t[0]+t[12],s[1]=e[1]*t[5]+t[13],s[2]=e[2]*t[10]+t[14],s},decompressAABB:function(e,t,s=e){return s[0]=e[0]*t[0]+t[12],s[1]=e[1]*t[5]+t[13],s[2]=e[2]*t[10]+t[14],s[3]=e[3]*t[0]+t[12],s[4]=e[4]*t[5]+t[13],s[5]=e[5]*t[10]+t[14],s},getUVBounds:function(e){const t=new Float32Array(2),s=new Float32Array(2);let i,r;for(i=0;i<2;i++)t[i]=Number.MAX_VALUE,s[i]=-Number.MAX_VALUE;for(i=0;i<e.length;i+=2)for(r=0;r<2;r++)t[r]=Math.min(t[r],e[i+r]),s[r]=Math.max(s[r],e[i+r]);return {min:t,max:s}},compressUVs:yt,decompressUVs:function(e,t,s=new Float32Array(e.length)){for(let i=0,r=e.length;i<r;i+=3)s[i+0]=e[i+0]*t[0]+t[6],s[i+1]=e[i+1]*t[4]+t[7];return s},decompressUV:function(e,t,s){s[0]=e[0]*t[0]+t[6],s[1]=e[1]*t[4]+t[7];},compressNormals:function(e){const t=new Int8Array(e.length);let s,i,r,o,n;for(let a=0;a<e.length;a+=3)r=s=vt(e,a,"floor","floor"),i=bt(s),o=n=wt(e,a,i),s=vt(e,a,"ceil","floor"),i=bt(s),o=wt(e,a,i),o>n&&(r=s,n=o),s=vt(e,a,"floor","ceil"),i=bt(s),o=wt(e,a,i),o>n&&(r=s,n=o),s=vt(e,a,"ceil","ceil"),i=bt(s),o=wt(e,a,i),o>n&&(r=s,n=o),t[a]=r[0],t[a+1]=r[1];return t},decompressNormals:function(e,t){for(let s=0,i=0,r=e.length;s<r;s+=2){let r=e[s+0],o=e[s+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);t[i+0]=r/a,t[i+1]=o/a,t[i+2]=n/a,i+=3;}return t},decompressNormal:function(e,t){let s=e[0],i=e[1];s=(2*s+1)/255,i=(2*i+1)/255;const r=1-Math.abs(s)-Math.abs(i);r<0&&(s=(1-Math.abs(i))*(s>=0?1:-1),i=(1-Math.abs(s))*(i>=0?1:-1));const o=Math.sqrt(s*s+i*i+r*r);return t[0]=s/o,t[1]=i/o,t[2]=r/o,t}},Tt=g.memory,xt=f.AABB3();class Mt extends ft{get type(){return "ReadableGeometry"}get isReadableGeometry(){return !0}constructor(e,t={}){super(e,t),this._state=new Xe({compressGeometry:!!t.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const s=this._state,i=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":s.primitive=i.POINTS,s.primitiveName=t.primitive;break;case"lines":s.primitive=i.LINES,s.primitiveName=t.primitive;break;case"line-loop":s.primitive=i.LINE_LOOP,s.primitiveName=t.primitive;break;case"line-strip":s.primitive=i.LINE_STRIP,s.primitiveName=t.primitive;break;case"triangles":s.primitive=i.TRIANGLES,s.primitiveName=t.primitive;break;case"triangle-strip":s.primitive=i.TRIANGLE_STRIP,s.primitiveName=t.primitive;break;case"triangle-fan":s.primitive=i.TRIANGLE_FAN,s.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),s.primitive=i.TRIANGLES,s.primitiveName=t.primitive;}if(t.positions)if(this._state.compressGeometry){const e=Pt.getPositionsBounds(t.positions),i=Pt.compressPositions(t.positions,e.min,e.max);s.positions=i.quantized,s.positionsDecodeMatrix=i.decodeMatrix;}else s.positions=t.positions.constructor===Float32Array?t.positions:new Float32Array(t.positions);if(t.colors&&(s.colors=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors)),t.uv)if(this._state.compressGeometry){const e=Pt.getUVBounds(t.uv),i=Pt.compressUVs(t.uv,e.min,e.max);s.uv=i.quantized,s.uvDecodeMatrix=i.decodeMatrix;}else s.uv=t.uv.constructor===Float32Array?t.uv:new Float32Array(t.uv);t.normals&&(this._state.compressGeometry?s.normals=Pt.compressNormals(t.normals):s.normals=t.normals.constructor===Float32Array?t.normals:new Float32Array(t.normals)),t.indices&&(s.indices=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices),"triangles"===this._state.primitiveName&&(this._numTriangles=t.indices.length/3)),this._buildHash(),Tt.meshes++,this._buildVBOs();}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new Me(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),Tt.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new Me(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),Tt.positions+=e.positionsBuf.numItems),e.normals){let s=e.compressGeometry;e.normalsBuf=new Me(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,s),Tt.normals+=e.normalsBuf.numItems;}e.colors&&(e.colorsBuf=new Me(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),Tt.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new Me(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),Tt.uvs+=e.uvBuf.numItems);}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("");}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,s=mt(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Me(t,t.ELEMENT_ARRAY_BUFFER,s,s.length,1,t.STATIC_DRAW),Tt.indices+=this._edgeIndicesBuf.numItems;}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,s=f.buildPickTriangles(e.positions,e.indices,e.compressGeometry),i=s.positions,r=s.colors;this._pickTrianglePositionsBuf=new Me(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new Me(t,t.ARRAY_BUFFER,r,r.length,4,t.STATIC_DRAW,!0),Tt.positions+=this._pickTrianglePositionsBuf.numItems,Tt.colors+=this._pickTriangleColorsBuf.numItems;}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost();}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null;}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),Pt.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const t=this._state,s=t.positions;if(s)if(s.length===e.length){if(this._state.compressGeometry){const s=Pt.getPositionsBounds(e),i=Pt.compressPositions(e,s.min,s.max);e=i.quantized,t.positionsDecodeMatrix=i.decodeMatrix;}s.set(e),t.positionsBuf&&t.positionsBuf.setData(s),this._setAABBDirty(),this.glRedraw();}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions");}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),Pt.decompressNormals(this._state.normals,this._decompressedNormals);}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const t=this._state,s=t.normals;s?s.length===e.length?(s.set(e),t.normalsBuf&&t.normalsBuf.setData(s),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals");}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),Pt.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const t=this._state,s=t.uv;s?s.length===e.length?(s.set(e),t.uvBuf&&t.uvBuf.setData(s),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs");}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const t=this._state,s=t.colors;s?s.length===e.length?(s.set(e),t.colorsBuf&&t.colorsBuf.setData(s),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors");}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=f.AABB3()),f.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=f.OBB3()),f.positions3ToAABB3(this._state.positions,xt,this._state.positionsDecodeMatrix),f.AABB3ToOBB3(xt,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0);}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),Tt.meshes--;}}function Dt(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let s=e.ySize||1;s<0&&(console.error("negative ySize not allowed - will invert"),s*=-1);let i=e.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);const r=e.center,o=r?r[0]:0,n=r?r[1]:0,a=r?r[2]:0,h=-t+o,l=-s+n,u=-i+a,c=t+o,p=s+n,d=i+a;return b.apply(e,{positions:[c,p,d,h,p,d,h,l,d,c,l,d,c,p,d,c,l,d,c,l,u,c,p,u,c,p,d,c,p,u,h,p,u,h,p,d,h,p,d,h,p,u,h,l,u,h,l,d,h,l,u,c,l,u,c,l,d,h,l,d,c,l,u,h,l,u,h,p,u,c,p,u],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}class At extends B{get type(){return "Material"}constructor(e,t={}){super(e,t),g.memory.materials++;}destroy(){super.destroy(),g.memory.materials--;}}const Ct={opaque:0,mask:1,blend:2},It=["opaque","mask","blend"];class Ft extends At{get type(){return "PhongMaterial"}constructor(e,t={}){super(e,t),this._state=new Xe({type:"PhongMaterial",ambient:f.vec3([1,1,1]),diffuse:f.vec3([1,1,1]),specular:f.vec3([1,1,1]),emissive:f.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.alpha=t.alpha,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,t.ambientMap&&(this._ambientMap=this._checkComponent("Texture",t.ambientMap)),t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",t.reflectivityMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",t.diffuseFresnel)),t.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",t.specularFresnel)),t.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",t.emissiveFresnel)),t.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",t.alphaFresnel)),t.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",t.reflectivityFresnel)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this._makeHash();}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("");}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw();}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw();}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw();}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw();}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw());}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=void 0!==e?e:80,this.glRedraw();}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw();}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw();}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=void 0!==e?e:1,this.glRedraw();}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){let t=Ct[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw());}get alphaMode(){return It[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e);}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw());}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw());}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy();}}const Bt={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class Et extends At{get type(){return "EmphasisMaterial"}get presets(){return Bt}constructor(e,t={}){super(e,t),this._state=new Xe({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),this._preset="default",t.preset?(this.preset=t.preset,void 0!==t.fill&&(this.fill=t.fill),t.fillColor&&(this.fillColor=t.fillColor),void 0!==t.fillAlpha&&(this.fillAlpha=t.fillAlpha),void 0!==t.edges&&(this.edges=t.edges),t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth),void 0!==t.backfaces&&(this.backfaces=t.backfaces),void 0!==t.glowThrough&&(this.glowThrough=t.glowThrough)):(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.backfaces=t.backfaces,this.glowThrough=t.glowThrough);}set fill(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this.glRedraw());}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw();}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=null!=e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw());}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw());}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw();}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw());}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw();}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw());}get backfaces(){return this._state.backfaces}set glowThrough(e){e=!1!==e,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw());}get glowThrough(){return this._state.glowThrough}set preset(e){if(e=e||"default",this._preset===e)return;const t=Bt[e];t?(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.glowThrough=t.glowThrough,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Bt).join(", "));}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy();}}const St={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class Rt extends At{get type(){return "EdgeMaterial"}get presets(){return St}constructor(e,t={}){super(e,t),this._state=new Xe({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",t.preset?(this.preset=t.preset,t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth)):(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth),this.edges=!1!==t.edges;}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw());}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw();}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw());}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw();}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=St[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(St).join(", "));}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy();}}const Ot={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class Lt extends B{constructor(e,t={}){super(e,t),this._units="meters",this._scale=1,this._origin=f.vec3([0,0,0]),this.units=t.units,this.scale=t.scale,this.origin=t.origin;}get unitsInfo(){return Ot}set units(e){e||(e="meters");Ot[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units);}get units(){return this._units}set scale(e){(e=e||1)<=0?this.error("scale value should be larger than zero"):(this._scale=e,this.fire("scale",this._scale));}get scale(){return this._scale}set origin(e){if(!e)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin);}get origin(){return this._origin}worldToRealPos(e,t=f.vec3(3)){t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2];}realToWorldPos(e,t=f.vec3(3)){return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}class Nt extends B{constructor(e,t={}){super(e,t);const s=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|mobile)\/?\s*(\.?\d+(\.\d+)*)/i),i=s&&"safari"===s[1].toLowerCase();this._supported=!i&&pe.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=t.enabled,this.kernelRadius=t.kernelRadius,this.intensity=t.intensity,this.bias=t.bias,this.scale=t.scale,this.minResolution=t.minResolution,this.numSamples=t.numSamples,this.blur=t.blur,this.blendCutoff=t.blendCutoff,this.blendFactor=t.blendFactor;}get supported(){return this._supported}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw());}get enabled(){return this._enabled}get possible(){if(!this._supported)return !1;if(!this._enabled)return !1;const e=this.scene.camera.projection;return "customProjection"!==e&&"frustum"!==e}get active(){return this._active}set kernelRadius(e){null==e&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw());}get kernelRadius(){return this._kernelRadius}set intensity(e){null==e&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw());}get intensity(){return this._intensity}set bias(e){null==e&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw());}get bias(){return this._bias}set scale(e){null==e&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw());}get scale(){return this._scale}set minResolution(e){null==e&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw());}get minResolution(){return this._minResolution}set numSamples(e){null==e&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw());}get numSamples(){return this._numSamples}set blur(e){e=!1!==e,this._blur!==e&&(this._blur=e,this.glRedraw());}get blur(){return this._blur}set blendCutoff(e){null==e&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw());}get blendCutoff(){return this._blendCutoff}set blendFactor(e){null==e&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw());}get blendFactor(){return this._blendFactor}destroy(){super.destroy();}}const kt={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class jt extends At{get type(){return "PointsMaterial"}get presets(){return kt}constructor(e,t={}){super(e,t),this._state=new Xe({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),t.preset?(this.preset=t.preset,void 0!==t.pointSize&&(this.pointSize=t.pointSize),void 0!==t.roundPoints&&(this.roundPoints=t.roundPoints),void 0!==t.perspectivePoints&&(this.perspectivePoints=t.perspectivePoints),void 0!==t.minPerspectivePointSize&&(this.minPerspectivePointSize=t.minPerspectivePointSize),void 0!==t.maxPerspectivePointSize&&(this.maxPerspectivePointSize=t.minPerspectivePointSize)):(this._preset="default",this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize),this.filterIntensity=t.filterIntensity,this.minIntensity=t.minIntensity,this.maxIntensity=t.maxIntensity;}set pointSize(e){this._state.pointSize=e||2,this.glRedraw();}get pointSize(){return this._state.pointSize}set roundPoints(e){e=!1!==e,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw());}get roundPoints(){return this._state.roundPoints}set perspectivePoints(e){e=!1!==e,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw());}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw();}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw();}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(e){e=!1!==e,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw());}get filterIntensity(){return this._state.filterIntensity}set minIntensity(e){this._state.minIntensity=null!=e?e:0,this.glRedraw();}get minIntensity(){return this._state.minIntensity}set maxIntensity(e){this._state.maxIntensity=null!=e?e:1,this.glRedraw();}get maxIntensity(){return this._state.maxIntensity}set preset(e){if(e=e||"default",this._preset===e)return;const t=kt[e];t?(this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(kt).join(", "));}get preset(){return this._preset}get hash(){return [this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy();}}const Gt={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class Ht extends At{get type(){return "LinesMaterial"}get presets(){return Gt}constructor(e,t={}){super(e,t),this._state=new Xe({type:"LinesMaterial",lineWidth:null}),t.preset?(this.preset=t.preset,void 0!==t.lineWidth&&(this.lineWidth=t.lineWidth)):(this._preset="default",this.lineWidth=t.lineWidth);}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw();}get lineWidth(){return this._state.lineWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=Gt[e];t?(this.lineWidth=t.lineWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Gt).join(", "));}get preset(){return this._preset}get hash(){return [""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy();}}function Vt(e,t){const s={};let i,r;for(let o=0,n=t.length;o<n;o++)i=t[o],r=e.component[i],r?r.isEntity?s[i]=!0:e.warn("pick(): Component is not an Entity: "+i):e.warn("pick(): Component not found: "+i);return s}class Ut extends B{get type(){return "Scene"}constructor(e,t={}){super(null,t);const s=t.canvasElement||document.getElementById(t.canvasId);if(!(s instanceof HTMLCanvasElement))throw "Mandatory config expected: valid canvasId or canvasElement";const i=!!t.transparent,r=!!t.alphaDepthMask;this._aabbDirty=!0,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.realWorldOffset=t.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new me(this,{dontClear:!0,canvas:s,spinnerElementId:t.spinnerElementId,transparent:i,webgl2:!1!==t.webgl2,contextAttr:t.contextAttr||{},backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,premultipliedAlpha:t.premultipliedAlpha}),this.canvas.on("boundary",(()=>{this.glRedraw();})),this.canvas.on("webglContextFailed",(()=>{alert("xeokit failed to find WebGL!");})),this._renderer=new Ue(this,{transparent:i,alphaDepthMask:r}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;let e=null;this.getHash=function(){if(e)return e;const t=this.sectionPlanes;if(0===t.length)return this.hash=";";const s=[];for(let e=0,i=t.length;e<i;e++)s.push("cp");return s.push(";"),e=s.join(""),e},this.addSectionPlane=function(t){this.sectionPlanes.push(t),e=null;},this.removeSectionPlane=function(t){for(let s=0,i=this.sectionPlanes.length;s<i;s++)if(this.sectionPlanes[s].id===t.id)return this.sectionPlanes.splice(s,1),void(e=null)};},this._lightsState=new function(){const e=f.vec4([0,0,0,0]),t=f.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let s=null,i=null;this.getHash=function(){if(s)return s;const e=[],t=this.lights;let i;for(let s=0,r=t.length;s<r;s++)i=t[s],e.push("/"),e.push(i.type),e.push("world"===i.space?"w":"v"),i.castsShadow&&e.push("sh");return this.lightMaps.length>0&&e.push("/lm"),this.reflectionMaps.length>0&&e.push("/rm"),e.push(";"),s=e.join(""),s},this.addLight=function(e){this.lights.push(e),i=null,s=null;},this.removeLight=function(e){for(let t=0,r=this.lights.length;t<r;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),i&&i.id===e.id&&(i=null),void(s=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),s=null;},this.removeReflectionMap=function(e){for(let t=0,i=this.reflectionMaps.length;t<i;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(s=null)},this.addLightMap=function(e){this.lightMaps.push(e),s=null;},this.removeLightMap=function(e){for(let t=0,i=this.lightMaps.length;t<i;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(s=null)},this.getAmbientColorAndIntensity=function(){if(!i)for(let e=0,t=this.lights.length;e<t;e++){const t=this.lights[e];if("ambient"===t.type){i=t;break}}if(i){const e=i.color,s=i.intensity;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=s,t}return e};},this.input=new ze(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:t.keyboardEventsElement}),this.metrics=new Lt(this,{units:t.units,scale:t.scale,origin:t.origin}),this.sao=new Nt(this,{enabled:t.saoEnabled}),this.ticksPerRender=t.ticksPerRender,this.ticksPerOcclusionTest=t.ticksPerOcclusionTest,this.passes=t.passes,this.clearEachPass=t.clearEachPass,this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.gammaFactor=t.gammaFactor,this._entityOffsetsEnabled=!!t.entityOffsetsEnabled,this._pickSurfacePrecisionEnabled=!!t.pickSurfacePrecisionEnabled,this._logarithmicDepthBufferEnabled=!!t.logarithmicDepthBufferEnabled,this._pbrEnabled=!!t.pbrEnabled,this._colorTextureEnabled=!1!==t.colorTextureEnabled,I._addScene(this),this._initDefaults(),this._viewport=new Ye(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new ut(this,{id:"default.camera",dontClear:!0}),new dt(this,{color:[1,1,1],intensity:.7}),new pt(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new pt(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(()=>{this._renderer.imageDirty();}));}_initDefaults(){}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+b.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=f.createUUID();this.components[e.id]=e;const t=e.type;let s=this.types[e.type];s||(s=this.types[t]={}),s[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e);}_removeComponent(e){var t=e.id,s=e.type;delete this.components[t];const i=this.types[s];i&&(delete i[t],b.isEmptyObject(i)&&delete this.types[s]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id]);}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0;}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0;}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0;}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0;}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0;}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0;}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0;}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0;}_registerModel(e){this.models[e.id]=e,this._modelIds=null;}_deregisterModel(e){const t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t);}_registerObject(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null;}_deregisterObject(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null;}_objectVisibilityUpdated(e,t=!0){e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0);}_objectXRayedUpdated(e){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null;}_objectHighlightedUpdated(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null;}_objectSelectedUpdated(e){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null;}_objectColorizeUpdated(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null;}_objectOpacityUpdated(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null;}_objectOffsetUpdated(e,t){!t||0===t[0]&&0===t[1]&&0===t[2]?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null;}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost();}this._renderer.webglContextLost();}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const s=this.components[t];s._webglContextRestored&&s._webglContextRestored(e);}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--;}get capabilities(){return this._renderer.capabilities}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get pickSurfacePrecisionEnabled(){return this._pickSurfacePrecisionEnabled}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set pbrEnabled(e){this._pbrEnabled=!!e,this.glRedraw();}get pbrEnabled(){return this._pbrEnabled}set colorTextureEnabled(e){this._colorTextureEnabled=!!e,this.glRedraw();}get colorTextureEnabled(){return this._colorTextureEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest();}render(e){e&&I.runTasks();const t={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!e&&!this._renderer.needsRender())return;t.sceneId=this.id;const s=this._passes,i=this._clearEachPass;let r,o;for(r=0;r<s;r++)t.pass=r,this.fire("rendering",t,!0),o=i||0===r,this._renderer.render({pass:r,clear:o,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor();}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0);}_saveAmbientColor(){const e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else {const t=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=f.vec4([0,0,0,1])),this._lastAmbientColor.set(t));}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(e){null==e?e=1:(!b.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e);}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){null==e?e=20:(!b.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e);}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){null==e?e=1:(!b.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw());}get passes(){return this._passes}set clearEachPass(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw());}get clearEachPass(){return this._clearEachPass}set gammaInput(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw());}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){(e=!!e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw());}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){(e=null==e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw());}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||Dt(Mt)}get material(){return this.components["default.material"]||new Ft(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new Et(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Et(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Et(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new Rt(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new jt(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new Ht(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=f.vec3());const e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2;}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=f.AABB3());let e,t=f.MAX_DOUBLE,s=f.MAX_DOUBLE,i=f.MAX_DOUBLE,r=f.MIN_DOUBLE,o=f.MIN_DOUBLE,n=f.MIN_DOUBLE;const a=this._collidables;let h,l=!1;for(const u in a)if(a.hasOwnProperty(u)){if(h=a[u],!1===h.collidable)continue;e=h.aabb,e[0]<t&&(t=e[0]),e[1]<s&&(s=e[1]),e[2]<i&&(i=e[2]),e[3]>r&&(r=e[3]),e[4]>o&&(o=e[4]),e[5]>n&&(n=e[5]),l=!0;}l||(t=-100,s=-100,i=-100,r=100,o=100,n=100),this._aabb[0]=t,this._aabb[1]=s,this._aabb[2]=i,this._aabb[3]=r,this._aabb[4]=o,this._aabb[5]=n,this._aabbDirty=!1;}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary");}pick(e,t){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.matrix||e.origin&&e.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");const s=e.includeEntities||e.include;s&&(e.includeEntityIds=Vt(this,s));const i=e.excludeEntities||e.exclude;return i&&(e.excludeEntityIds=Vt(this,i)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(t=this._renderer.pick(e,t))?(t.entity&&t.entity.fire&&t.entity.fire("picked",t),t):void 0}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy());}clearLights(){const e=Object.keys(this.lights);for(let t=0,s=e.length;t<s;t++)this.lights[e[t]].destroy();}clearSectionPlanes(){const e=Object.keys(this.sectionPlanes);for(let t=0,s=e.length;t<s;t++)this.sectionPlanes[e[t]].destroy();}getAABB(e){if(void 0===e)return this.aabb;if(b.isString(e)){const t=this.objects[e];if(t&&t.aabb)return t.aabb;e=[e];}if(0===e.length)return this.aabb;let t,s=f.MAX_DOUBLE,i=f.MAX_DOUBLE,r=f.MAX_DOUBLE,o=f.MIN_DOUBLE,n=f.MIN_DOUBLE,a=f.MIN_DOUBLE;if(this.withObjects(e,(e=>{if(e.collidable){const h=e.aabb;h[0]<s&&(s=h[0]),h[1]<i&&(i=h[1]),h[2]<r&&(r=h[2]),h[3]>o&&(o=h[3]),h[4]>n&&(n=h[4]),h[5]>a&&(a=h[5]),t=!0;}})),t){const e=f.AABB3();return e[0]=s,e[1]=i,e[2]=r,e[3]=o,e[4]=n,e[5]=a,e}return this.aabb}setObjectsVisible(e,t){return this.withObjects(e,(e=>{const s=e.visible!==t;return e.visible=t,s}))}setObjectsCollidable(e,t){return this.withObjects(e,(e=>{const s=e.collidable!==t;return e.collidable=t,s}))}setObjectsCulled(e,t){return this.withObjects(e,(e=>{const s=e.culled!==t;return e.culled=t,s}))}setObjectsSelected(e,t){return this.withObjects(e,(e=>{const s=e.selected!==t;return e.selected=t,s}))}setObjectsHighlighted(e,t){return this.withObjects(e,(e=>{const s=e.highlighted!==t;return e.highlighted=t,s}))}setObjectsXRayed(e,t){return this.withObjects(e,(e=>{const s=e.xrayed!==t;return e.xrayed=t,s}))}setObjectsEdges(e,t){return this.withObjects(e,(e=>{const s=e.edges!==t;return e.edges=t,s}))}setObjectsColorized(e,t){return this.withObjects(e,(e=>{e.colorize=t;}))}setObjectsOpacity(e,t){return this.withObjects(e,(e=>{const s=e.opacity!==t;return e.opacity=t,s}))}setObjectsPickable(e,t){return this.withObjects(e,(e=>{const s=e.pickable!==t;return e.pickable=t,s}))}setObjectsOffset(e,t){this.withObjects(e,(e=>{e.offset=t;}));}withObjects(e,t){b.isString(e)&&(e=[e]);let s=!1;for(let i=0,r=e.length;i<r;i++){const r=e[i];let o=this.objects[r];if(o)s=t(o)||s;else {const e=this.modelIds;for(let i=0,n=e.length;i<n;i++){const n=e[i],a=f.globalizeObjectId(n,r);o=this.objects[a],o&&(s=t(o)||s);}}}return s}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null;}}const ii=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){const t=e.scene,s=e.scene._sectionPlanesState,i=e.scene._lightsState,r=e._geometry._state,o=e._state.billboard,n=e._state.stationary,a=s.sectionPlanes.length>0,h=!!r.compressGeometry,l=[];l.push("#version 300 es"),l.push("// Lambertian drawing vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),h&&l.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;"));a&&l.push("out vec4 vWorldPosition;");if(l.push("uniform vec4 lightAmbient;"),l.push("uniform vec4 materialColor;"),l.push("uniform vec3 materialEmissive;"),r.normalsBuf){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(l.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&l.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&l.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(l.push("uniform vec3 lightPos"+e+";"),l.push("uniform vec3 lightDir"+e+";")));}h&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"));}l.push("out vec4 vColor;"),"points"===r.primitiveName&&l.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===o&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),h&&l.push("localPosition = positionsDecodeMatrix * localPosition;");r.normalsBuf&&(h?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),r.normalsBuf&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r.normalsBuf&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),r.normalsBuf)for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?l.push("viewLightDir = normalize(lightDir"+e+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?l.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):l.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);");else {if("spot"!==t.type)continue;"view"===t.space?l.push("viewLightDir = normalize(lightDir"+e+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);");}}l.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),a&&l.push("vWorldPosition = worldPosition;");"points"===r.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return l.push("gl_Position = clipPos;"),l.push("}"),l}(e),this.fragment=function(e){const t=e.scene,s=t._sectionPlanesState;e._material._state;const i=e._geometry._state,r=s.sectionPlanes.length>0,o=t.gammaOutput,n=[];n.push("#version 300 es"),n.push("// Lambertian drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;"));if(r){n.push("in vec4 vWorldPosition;"),n.push("uniform bool clippable;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");}n.push("in vec4 vColor;"),o&&(n.push("uniform float gammaFactor;"),n.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}");}"points"===i.primitiveName&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}"));t.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");o?n.push("outColor = linearToGamma(vColor, gammaFactor);"):n.push("outColor = vColor;");return n.push("}"),n}(e)):(this.vertex=function(e){const t=e.scene;e._material;const s=e._state,i=t._sectionPlanesState,r=e._geometry._state,o=t._lightsState;let n;const a=s.billboard,h=s.background,l=s.stationary,u=function(e){if(!e._geometry._state.uvBuf)return !1;const t=e._material;return !!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),c=ni(e),p=i.sectionPlanes.length>0,d=oi(e),f=!!r.compressGeometry,m=[];m.push("#version 300 es"),m.push("// Drawing vertex shader"),m.push("in  vec3 position;"),f&&m.push("uniform mat4 positionsDecodeMatrix;");m.push("uniform  mat4 modelMatrix;"),m.push("uniform  mat4 viewMatrix;"),m.push("uniform  mat4 projMatrix;"),m.push("out  vec3 vViewPosition;"),m.push("uniform  vec3 offset;"),p&&m.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(m.push("uniform float logDepthBufFC;"),m.push("out float vFragDepth;"),m.push("bool isPerspectiveMatrix(mat4 m) {"),m.push("    return (m[2][3] == - 1.0);"),m.push("}"),m.push("out float isPerspective;"));o.lightMaps.length>0&&m.push("out    vec3 vWorldNormal;");if(c){m.push("in  vec3 normal;"),m.push("uniform    mat4 modelNormalMatrix;"),m.push("uniform    mat4 viewNormalMatrix;"),m.push("out    vec3 vViewNormal;");for(let e=0,t=o.lights.length;e<t;e++)n=o.lights[e],"ambient"!==n.type&&("dir"===n.type&&m.push("uniform vec3 lightDir"+e+";"),"point"===n.type&&m.push("uniform vec3 lightPos"+e+";"),"spot"===n.type&&(m.push("uniform vec3 lightPos"+e+";"),m.push("uniform vec3 lightDir"+e+";")),"dir"===n.type&&"view"===n.space||m.push("out vec4 vViewLightReverseDirAndDist"+e+";"));f&&(m.push("vec3 octDecode(vec2 oct) {"),m.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),m.push("    if (v.z < 0.0) {"),m.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),m.push("    }"),m.push("    return normalize(v);"),m.push("}"));}u&&(m.push("in vec2 uv;"),m.push("out vec2 vUV;"),f&&m.push("uniform mat3 uvDecodeMatrix;"));r.colors&&(m.push("in vec4 color;"),m.push("out vec4 vColor;"));"points"===r.primitiveName&&m.push("uniform float pointSize;");"spherical"!==a&&"cylindrical"!==a||(m.push("void billboard(inout mat4 mat) {"),m.push("   mat[0][0] = 1.0;"),m.push("   mat[0][1] = 0.0;"),m.push("   mat[0][2] = 0.0;"),"spherical"===a&&(m.push("   mat[1][0] = 0.0;"),m.push("   mat[1][1] = 1.0;"),m.push("   mat[1][2] = 0.0;")),m.push("   mat[2][0] = 0.0;"),m.push("   mat[2][1] = 0.0;"),m.push("   mat[2][2] =1.0;"),m.push("}"));if(d){m.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(m.push("uniform mat4 shadowViewMatrix"+e+";"),m.push("uniform mat4 shadowProjMatrix"+e+";"),m.push("out vec4 vShadowPosFromLight"+e+";"));}m.push("void main(void) {"),m.push("vec4 localPosition = vec4(position, 1.0); "),m.push("vec4 worldPosition;"),f&&m.push("localPosition = positionsDecodeMatrix * localPosition;");c&&(f?m.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):m.push("vec4 localNormal = vec4(normal, 0.0); "),m.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),m.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));m.push("mat4 viewMatrix2           = viewMatrix;"),m.push("mat4 modelMatrix2          = modelMatrix;"),l?m.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):h&&m.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);");"spherical"===a||"cylindrical"===a?(m.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),m.push("billboard(modelMatrix2);"),m.push("billboard(viewMatrix2);"),m.push("billboard(modelViewMatrix);"),c&&(m.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),m.push("billboard(modelNormalMatrix2);"),m.push("billboard(viewNormalMatrix2);"),m.push("billboard(modelViewNormalMatrix);")),m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("worldPosition.xyz = worldPosition.xyz + offset;"),m.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("worldPosition.xyz = worldPosition.xyz + offset;"),m.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(c){m.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&m.push("vWorldNormal = worldNormal;"),m.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),m.push("vec3 tmpVec3;"),m.push("float lightDist;");for(let e=0,t=o.lights.length;e<t;e++)n=o.lights[e],"ambient"!==n.type&&("dir"===n.type&&"world"===n.space&&(m.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+e+", 0.0) ).xyz;"),m.push("vViewLightReverseDirAndDist"+e+" = vec4(-tmpVec3, 0.0);")),"point"===n.type&&("world"===n.space?(m.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+e+", 1.0)).xyz - viewPosition.xyz;"),m.push("lightDist = abs(length(tmpVec3));")):(m.push("tmpVec3 = lightPos"+e+".xyz - viewPosition.xyz;"),m.push("lightDist = abs(length(tmpVec3));")),m.push("vViewLightReverseDirAndDist"+e+" = vec4(tmpVec3, lightDist);")));}u&&(f?m.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):m.push("vUV = uv;"));r.colors&&m.push("vColor = color;");"points"===r.primitiveName&&m.push("gl_PointSize = pointSize;");p&&m.push("vWorldPosition = worldPosition;");m.push("   vViewPosition = viewPosition.xyz;"),m.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(m.push("vFragDepth = 1.0 + clipPos.w;"),m.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));h&&m.push("clipPos.z = clipPos.w;");if(m.push("gl_Position = clipPos;"),d){m.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),m.push("vec4 tempx; ");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&m.push("vShadowPosFromLight"+e+" = texUnitConverter * shadowProjMatrix"+e+" * (shadowViewMatrix"+e+" * worldPosition); ");}return m.push("}"),m}(e),this.fragment=function(e){const t=e.scene;t.canvas.gl;const s=e._material,i=e._geometry._state,r=e.scene._sectionPlanesState,o=e.scene._lightsState,n=e._material._state,a=r.sectionPlanes.length>0,h=ni(e),l=i.uvBuf,u="PhongMaterial"===n.type,c="MetallicMaterial"===n.type,p="SpecularMaterial"===n.type,d=oi(e);t.gammaInput;const f=t.gammaOutput,m=[];m.push("#version 300 es"),m.push("// Drawing fragment shader"),m.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),m.push("precision highp float;"),m.push("precision highp int;"),m.push("#else"),m.push("precision mediump float;"),m.push("precision mediump int;"),m.push("#endif"),t.logarithmicDepthBufferEnabled&&(m.push("in float isPerspective;"),m.push("uniform float logDepthBufFC;"),m.push("in float vFragDepth;"));d&&(m.push("float unpackDepth (vec4 color) {"),m.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),m.push("  return dot(color, bitShift);"),m.push("}"));m.push("uniform float gammaFactor;"),m.push("vec4 linearToLinear( in vec4 value ) {"),m.push("  return value;"),m.push("}"),m.push("vec4 sRGBToLinear( in vec4 value ) {"),m.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),m.push("}"),m.push("vec4 gammaToLinear( in vec4 value) {"),m.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),m.push("}"),f&&(m.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),m.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),m.push("}"));if(a){m.push("in vec4 vWorldPosition;"),m.push("uniform bool clippable;");for(var g=0;g<r.sectionPlanes.length;g++)m.push("uniform bool sectionPlaneActive"+g+";"),m.push("uniform vec3 sectionPlanePos"+g+";"),m.push("uniform vec3 sectionPlaneDir"+g+";");}h&&(o.lightMaps.length>0&&(m.push("uniform samplerCube lightMap;"),m.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&m.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&m.push("uniform mat4 viewMatrix;"),m.push("#define PI 3.14159265359"),m.push("#define RECIPROCAL_PI 0.31830988618"),m.push("#define RECIPROCAL_PI2 0.15915494"),m.push("#define EPSILON 1e-6"),m.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),m.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),m.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),m.push("}"),m.push("struct IncidentLight {"),m.push("   vec3 color;"),m.push("   vec3 direction;"),m.push("};"),m.push("struct ReflectedLight {"),m.push("   vec3 diffuse;"),m.push("   vec3 specular;"),m.push("};"),m.push("struct Geometry {"),m.push("   vec3 position;"),m.push("   vec3 viewNormal;"),m.push("   vec3 worldNormal;"),m.push("   vec3 viewEyeDir;"),m.push("};"),m.push("struct Material {"),m.push("   vec3    diffuseColor;"),m.push("   float   specularRoughness;"),m.push("   vec3    specularColor;"),m.push("   float   shine;"),m.push("};"),u&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(m.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(m.push("   vec3 irradiance = "+ri[o.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),m.push("   irradiance *= PI;"),m.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(m.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),m.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),m.push("   radiance *= PI;"),m.push("   reflectedLight.specular     += radiance;")),m.push("}")),m.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),m.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),m.push("   vec3 irradiance = dotNL * directLight.color * PI;"),m.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),m.push("}")),(c||p)&&(m.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),m.push("   float r = ggxRoughness + 0.0001;"),m.push("   return (2.0 / (r * r) - 2.0);"),m.push("}"),m.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),m.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),m.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),m.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),m.push("}"),o.reflectionMaps.length>0&&(m.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),m.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),m.push("   vec3 envMapColor = "+ri[o.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),m.push("  return envMapColor;"),m.push("}")),m.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),m.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),m.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),m.push("}"),m.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),m.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),m.push("   return 1.0 / ( gl * gv );"),m.push("}"),m.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),m.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),m.push("   return 0.5 / max( gv + gl, EPSILON );"),m.push("}"),m.push("float D_GGX(const in float alpha, const in float dotNH) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),m.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),m.push("}"),m.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),m.push("   float alpha = ( roughness * roughness );"),m.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),m.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),m.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),m.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),m.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),m.push("   vec3  F = F_Schlick( specularColor, dotLH );"),m.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),m.push("   float D = D_GGX( alpha, dotNH );"),m.push("   return F * (G * D);"),m.push("}"),m.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),m.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),m.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),m.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),m.push("   vec4 r = roughness * c0 + c1;"),m.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),m.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),m.push("   return specularColor * AB.x + AB.y;"),m.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(m.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(m.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),m.push("   irradiance *= PI;"),m.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(m.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),m.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),m.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),m.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),m.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),m.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),m.push("}")),m.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),m.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),m.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),m.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),m.push("}")));m.push("in vec3 vViewPosition;"),i.colors&&m.push("in vec4 vColor;");l&&(h&&s._normalMap||s._ambientMap||s._baseColorMap||s._diffuseMap||s._emissiveMap||s._metallicMap||s._roughnessMap||s._metallicRoughnessMap||s._specularMap||s._glossinessMap||s._specularGlossinessMap||s._occlusionMap||s._alphaMap)&&m.push("in vec2 vUV;");h&&(o.lightMaps.length>0&&m.push("in vec3 vWorldNormal;"),m.push("in vec3 vViewNormal;"));n.ambient&&m.push("uniform vec3 materialAmbient;");n.baseColor&&m.push("uniform vec3 materialBaseColor;");void 0!==n.alpha&&null!==n.alpha&&m.push("uniform vec4 materialAlphaModeCutoff;");n.emissive&&m.push("uniform vec3 materialEmissive;");n.diffuse&&m.push("uniform vec3 materialDiffuse;");void 0!==n.glossiness&&null!==n.glossiness&&m.push("uniform float materialGlossiness;");void 0!==n.shininess&&null!==n.shininess&&m.push("uniform float materialShininess;");n.specular&&m.push("uniform vec3 materialSpecular;");void 0!==n.metallic&&null!==n.metallic&&m.push("uniform float materialMetallic;");void 0!==n.roughness&&null!==n.roughness&&m.push("uniform float materialRoughness;");void 0!==n.specularF0&&null!==n.specularF0&&m.push("uniform float materialSpecularF0;");l&&s._ambientMap&&(m.push("uniform sampler2D ambientMap;"),s._ambientMap._state.matrix&&m.push("uniform mat4 ambientMapMatrix;"));l&&s._baseColorMap&&(m.push("uniform sampler2D baseColorMap;"),s._baseColorMap._state.matrix&&m.push("uniform mat4 baseColorMapMatrix;"));l&&s._diffuseMap&&(m.push("uniform sampler2D diffuseMap;"),s._diffuseMap._state.matrix&&m.push("uniform mat4 diffuseMapMatrix;"));l&&s._emissiveMap&&(m.push("uniform sampler2D emissiveMap;"),s._emissiveMap._state.matrix&&m.push("uniform mat4 emissiveMapMatrix;"));h&&l&&s._metallicMap&&(m.push("uniform sampler2D metallicMap;"),s._metallicMap._state.matrix&&m.push("uniform mat4 metallicMapMatrix;"));h&&l&&s._roughnessMap&&(m.push("uniform sampler2D roughnessMap;"),s._roughnessMap._state.matrix&&m.push("uniform mat4 roughnessMapMatrix;"));h&&l&&s._metallicRoughnessMap&&(m.push("uniform sampler2D metallicRoughnessMap;"),s._metallicRoughnessMap._state.matrix&&m.push("uniform mat4 metallicRoughnessMapMatrix;"));h&&s._normalMap&&(m.push("uniform sampler2D normalMap;"),s._normalMap._state.matrix&&m.push("uniform mat4 normalMapMatrix;"),m.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),m.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),m.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),m.push("      vec2 st0 = dFdx( uv.st );"),m.push("      vec2 st1 = dFdy( uv.st );"),m.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),m.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),m.push("      vec3 N = normalize( surf_norm );"),m.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),m.push("      mat3 tsn = mat3( S, T, N );"),m.push("      return normalize( tsn * mapN );"),m.push("}"));l&&s._occlusionMap&&(m.push("uniform sampler2D occlusionMap;"),s._occlusionMap._state.matrix&&m.push("uniform mat4 occlusionMapMatrix;"));l&&s._alphaMap&&(m.push("uniform sampler2D alphaMap;"),s._alphaMap._state.matrix&&m.push("uniform mat4 alphaMapMatrix;"));h&&l&&s._specularMap&&(m.push("uniform sampler2D specularMap;"),s._specularMap._state.matrix&&m.push("uniform mat4 specularMapMatrix;"));h&&l&&s._glossinessMap&&(m.push("uniform sampler2D glossinessMap;"),s._glossinessMap._state.matrix&&m.push("uniform mat4 glossinessMapMatrix;"));h&&l&&s._specularGlossinessMap&&(m.push("uniform sampler2D materialSpecularGlossinessMap;"),s._specularGlossinessMap._state.matrix&&m.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));h&&(s._diffuseFresnel||s._specularFresnel||s._alphaFresnel||s._emissiveFresnel||s._reflectivityFresnel)&&(m.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),m.push("    float fr = abs(dot(eyeDir, normal));"),m.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),m.push("    return pow(finalFr, power);"),m.push("}"),s._diffuseFresnel&&(m.push("uniform float  diffuseFresnelCenterBias;"),m.push("uniform float  diffuseFresnelEdgeBias;"),m.push("uniform float  diffuseFresnelPower;"),m.push("uniform vec3   diffuseFresnelCenterColor;"),m.push("uniform vec3   diffuseFresnelEdgeColor;")),s._specularFresnel&&(m.push("uniform float  specularFresnelCenterBias;"),m.push("uniform float  specularFresnelEdgeBias;"),m.push("uniform float  specularFresnelPower;"),m.push("uniform vec3   specularFresnelCenterColor;"),m.push("uniform vec3   specularFresnelEdgeColor;")),s._alphaFresnel&&(m.push("uniform float  alphaFresnelCenterBias;"),m.push("uniform float  alphaFresnelEdgeBias;"),m.push("uniform float  alphaFresnelPower;"),m.push("uniform vec3   alphaFresnelCenterColor;"),m.push("uniform vec3   alphaFresnelEdgeColor;")),s._reflectivityFresnel&&(m.push("uniform float  materialSpecularF0FresnelCenterBias;"),m.push("uniform float  materialSpecularF0FresnelEdgeBias;"),m.push("uniform float  materialSpecularF0FresnelPower;"),m.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),m.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),s._emissiveFresnel&&(m.push("uniform float  emissiveFresnelCenterBias;"),m.push("uniform float  emissiveFresnelEdgeBias;"),m.push("uniform float  emissiveFresnelPower;"),m.push("uniform vec3   emissiveFresnelCenterColor;"),m.push("uniform vec3   emissiveFresnelEdgeColor;")));if(m.push("uniform vec4   lightAmbient;"),h)for(let e=0,t=o.lights.length;e<t;e++){const t=o.lights[e];"ambient"!==t.type&&(m.push("uniform vec4 lightColor"+e+";"),"point"===t.type&&m.push("uniform vec3 lightAttenuation"+e+";"),"dir"===t.type&&"view"===t.space&&m.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&"view"===t.space?m.push("uniform vec3 lightPos"+e+";"):m.push("in vec4 vViewLightReverseDirAndDist"+e+";"));}if(d)for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(m.push("in vec4 vShadowPosFromLight"+e+";"),m.push("uniform sampler2D shadowMap"+e+";"));if(m.push("uniform vec4 colorize;"),m.push("out vec4 outColor;"),m.push("void main(void) {"),a){m.push("if (clippable) {"),m.push("  float dist = 0.0;");for(g=0;g<r.sectionPlanes.length;g++)m.push("if (sectionPlaneActive"+g+") {"),m.push("   dist += clamp(dot(-sectionPlaneDir"+g+".xyz, vWorldPosition.xyz - sectionPlanePos"+g+".xyz), 0.0, 1000.0);"),m.push("}");m.push("  if (dist > 0.0) { discard; }"),m.push("}");}"points"===i.primitiveName&&(m.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),m.push("float r = dot(cxy, cxy);"),m.push("if (r > 1.0) {"),m.push("   discard;"),m.push("}"));m.push("float occlusion = 1.0;"),n.ambient?m.push("vec3 ambientColor = materialAmbient;"):m.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");n.diffuse?m.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?m.push("vec3 diffuseColor = materialBaseColor;"):m.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");i.colors&&m.push("diffuseColor *= vColor.rgb;");n.emissive?m.push("vec3 emissiveColor = materialEmissive;"):m.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");n.specular?m.push("vec3 specular = materialSpecular;"):m.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==n.alpha?m.push("float alpha = materialAlphaModeCutoff[0];"):m.push("float alpha = 1.0;");i.colors&&m.push("alpha *= vColor.a;");void 0!==n.glossiness?m.push("float glossiness = materialGlossiness;"):m.push("float glossiness = 1.0;");void 0!==n.metallic?m.push("float metallic = materialMetallic;"):m.push("float metallic = 1.0;");void 0!==n.roughness?m.push("float roughness = materialRoughness;"):m.push("float roughness = 1.0;");void 0!==n.specularF0?m.push("float specularF0 = materialSpecularF0;"):m.push("float specularF0 = 1.0;");l&&(h&&s._normalMap||s._ambientMap||s._baseColorMap||s._diffuseMap||s._occlusionMap||s._emissiveMap||s._metallicMap||s._roughnessMap||s._metallicRoughnessMap||s._specularMap||s._glossinessMap||s._specularGlossinessMap||s._alphaMap)&&(m.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),m.push("vec2 textureCoord;"));l&&s._ambientMap&&(s._ambientMap._state.matrix?m.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),m.push("ambientTexel = "+ri[s._ambientMap._state.encoding]+"(ambientTexel);"),m.push("ambientColor *= ambientTexel.rgb;"));l&&s._diffuseMap&&(s._diffuseMap._state.matrix?m.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),m.push("diffuseTexel = "+ri[s._diffuseMap._state.encoding]+"(diffuseTexel);"),m.push("diffuseColor *= diffuseTexel.rgb;"),m.push("alpha *= diffuseTexel.a;"));l&&s._baseColorMap&&(s._baseColorMap._state.matrix?m.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),m.push("baseColorTexel = "+ri[s._baseColorMap._state.encoding]+"(baseColorTexel);"),m.push("diffuseColor *= baseColorTexel.rgb;"),m.push("alpha *= baseColorTexel.a;"));l&&s._emissiveMap&&(s._emissiveMap._state.matrix?m.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),m.push("emissiveTexel = "+ri[s._emissiveMap._state.encoding]+"(emissiveTexel);"),m.push("emissiveColor = emissiveTexel.rgb;"));l&&s._alphaMap&&(s._alphaMap._state.matrix?m.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("alpha *= texture(alphaMap, textureCoord).r;"));l&&s._occlusionMap&&(s._occlusionMap._state.matrix?m.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("occlusion *= texture(occlusionMap, textureCoord).r;"));if(h&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){l&&s._normalMap?(s._normalMap._state.matrix?m.push("textureCoord = (normalMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):m.push("vec3 viewNormal = normalize(vViewNormal);"),l&&s._specularMap&&(s._specularMap._state.matrix?m.push("textureCoord = (specularMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("specular *= texture(specularMap, textureCoord).rgb;")),l&&s._glossinessMap&&(s._glossinessMap._state.matrix?m.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("glossiness *= texture(glossinessMap, textureCoord).r;")),l&&s._specularGlossinessMap&&(s._specularGlossinessMap._state.matrix?m.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),m.push("specular *= specGlossRGB.rgb;"),m.push("glossiness *= specGlossRGB.a;")),l&&s._metallicMap&&(s._metallicMap._state.matrix?m.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("metallic *= texture(metallicMap, textureCoord).r;")),l&&s._roughnessMap&&(s._roughnessMap._state.matrix?m.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("roughness *= texture(roughnessMap, textureCoord).r;")),l&&s._metallicRoughnessMap&&(s._metallicRoughnessMap._state.matrix?m.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),m.push("metallic *= metalRoughRGB.b;"),m.push("roughness *= metalRoughRGB.g;")),m.push("vec3 viewEyeDir = normalize(-vViewPosition);"),s._diffuseFresnel&&(m.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),m.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),s._specularFresnel&&(m.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),m.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),s._alphaFresnel&&(m.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),m.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),s._emissiveFresnel&&(m.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),m.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),m.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),m.push("   discard;"),m.push("}"),m.push("IncidentLight  light;"),m.push("Material       material;"),m.push("Geometry       geometry;"),m.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),m.push("vec3           viewLightDir;"),u&&(m.push("material.diffuseColor      = diffuseColor;"),m.push("material.specularColor     = specular;"),m.push("material.shine             = materialShininess;")),p&&(m.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),m.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),m.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),m.push("material.specularColor     = specular;")),c&&(m.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),m.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),m.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),m.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),m.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&m.push("geometry.worldNormal   = normalize(vWorldNormal);"),m.push("geometry.viewNormal    = viewNormal;"),m.push("geometry.viewEyeDir    = viewEyeDir;"),u&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&m.push("computePhongLightMapping(geometry, material, reflectedLight);"),(p||c)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&m.push("computePBRLightMapping(geometry, material, reflectedLight);"),m.push("float shadow = 1.0;"),m.push("float shadowAcneRemover = 0.007;"),m.push("vec3 fragmentDepth;"),m.push("float texelSize = 1.0 / 1024.0;"),m.push("float amountInLight = 0.0;"),m.push("vec3 shadowCoord;"),m.push("vec4 rgbaDepth;"),m.push("float depth;");for(let e=0,t=o.lights.length;e<t;e++){const t=o.lights[e];"ambient"!==t.type&&("dir"===t.type&&"view"===t.space?m.push("viewLightDir = -normalize(lightDir"+e+");"):"point"===t.type&&"view"===t.space?m.push("viewLightDir = normalize(lightPos"+e+" - vViewPosition);"):m.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+e+".xyz);"),d&&t.castsShadow?(m.push("shadow = 0.0;"),m.push("fragmentDepth = vShadowPosFromLight"+e+".xyz;"),m.push("fragmentDepth.z -= shadowAcneRemover;"),m.push("for (int x = -3; x <= 3; x++) {"),m.push("  for (int y = -3; y <= 3; y++) {"),m.push("      float texelDepth = unpackDepth(texture(shadowMap"+e+", fragmentDepth.xy + vec2(x, y) * texelSize));"),m.push("      if (fragmentDepth.z < texelDepth) {"),m.push("          shadow += 1.0;"),m.push("      }"),m.push("  }"),m.push("}"),m.push("shadow = shadow / 9.0;"),m.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a * shadow);")):m.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a );"),m.push("light.direction = viewLightDir;"),u&&m.push("computePhongLighting(light, geometry, material, reflectedLight);"),(p||c)&&m.push("computePBRLighting(light, geometry, material, reflectedLight);"));}u?m.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):m.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;");}else m.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),m.push("vec3 outgoingLight = emissiveColor + ambientColor;");m.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),f&&m.push("fragColor = linearToGamma(fragColor, gammaFactor);");m.push("outColor = fragColor;"),t.logarithmicDepthBufferEnabled&&m.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return m.push("}"),m}(e));},ri={};function oi(e){if(!e.receivesShadow)return !1;const t=e.scene._lightsState.lights;if(!t||0===t.length)return !1;for(let e=0,s=t.length;e<s;e++)if(t[e].castsShadow)return !0;return !1}function ni(e){const t=e._geometry._state.primitiveName;return !(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}ri[3e3]="linearToLinear",ri[3001]="sRGBToLinear";const ai=f.vec3(),hi=new s({}),li=function(e,t){this.id=hi.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new ii(t),this._allocate(t);},ui={};li.get=function(e){const t=e.scene,s=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";");let i=ui[s];if(!i){if(i=new li(s,e),i.errors)return console.log(i.errors.join("\n")),null;ui[s]=i,g.memory.programs++;}return i._useCount++,i},li.prototype.put=function(){0==--this._useCount&&(hi.removeItem(this.id),this._program&&this._program.destroy(),delete ui[this._hash],g.memory.programs--);},li.prototype.webglContextRestored=function(){this._program=null;},li.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const s=pe.MAX_TEXTURE_UNITS,i=t.scene,r=t._material,o=i.canvas.gl,n=this._program,a=t._state,h=t._material._state,l=t._geometry._state,u=i.camera,c=t.origin,p=a.background;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,p&&o.depthFunc(o.LEQUAL),this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(a.originHash,c):u.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,u.viewNormalMatrix),a.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const s=i._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const i=r.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,i?1:0),i){const i=s[t];o.uniform3fv(e.pos,c?K(i.dist,i.dir,c,ai):i.pos),o.uniform3fv(e.dir,i.dir);}}}}}if(h.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;const t=h.backfaces;e.backfaces!==t&&(t?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=t);const i=h.frontface;switch(e.frontface!==i&&(i?o.frontFace(o.CCW):o.frontFace(o.CW),e.frontface=i),e.lineWidth!==h.lineWidth&&(o.lineWidth(h.lineWidth),e.lineWidth=h.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,h.pointSize),h.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,h.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,h.color[0],h.color[1],h.color[2],h.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,h.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,h.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,h.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,h.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,h.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,h.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*h.alpha,1===h.alphaMode?1:0,h.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(n.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,r._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(n.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,r._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,h.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,h.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,h.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,h.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,h.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*h.alpha,1===h.alphaMode?1:0,h.alphaCutoff,0);const t=r._baseColorMap;t&&t._state.texture&&this._uBaseColorMap&&(n.bindTexture(this._uBaseColorMap,t._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,t._state.matrix));const i=r._metallicMap;i&&i._state.texture&&this._uMetallicMap&&(n.bindTexture(this._uMetallicMap,i._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,i._state.matrix));const a=r._roughnessMap;a&&a._state.texture&&this._uRoughnessMap&&(n.bindTexture(this._uRoughnessMap,a._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,a._state.matrix));const l=r._metallicRoughnessMap;l&&l._state.texture&&this._uMetallicRoughnessMap&&(n.bindTexture(this._uMetallicRoughnessMap,l._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,l._state.matrix)),(d=r._emissiveMap)&&d._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,d._state.matrix)),(f=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f._state.matrix)),(m=r._alphaMap)&&m._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,m._state.matrix)),(g=r._normalMap)&&g._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,g._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,h.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,h.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,h.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,h.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,h.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*h.alpha,1===h.alphaMode?1:0,h.alphaCutoff,0);const u=r._diffuseMap;u&&u._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,u._state.matrix));const c=r._specularMap;c&&c._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,c._state.matrix));const p=r._glossinessMap;p&&p._state.texture&&this._uGlossinessMap&&(n.bindTexture(this._uGlossinessMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,p._state.matrix));const _=r._specularGlossinessMap;var d,f,m,g;_&&_._state.texture&&this._uSpecularGlossinessMap&&(n.bindTexture(this._uSpecularGlossinessMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,_._state.matrix)),(d=r._emissiveMap)&&d._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,d._state.matrix)),(f=r._occlusionMap)&&f._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f._state.matrix)),(m=r._alphaMap)&&m._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,m._state.matrix)),(g=r._normalMap)&&g._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,g._state.matrix));}this._lastMaterialId=h.id;}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,t.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),this._uColorize){const e=a.colorize,t=this._lastColorize;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]||(o.uniform4fv(this._uColorize,e),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]);}o.uniform3fv(this._uOffset,a.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(l.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(l.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(l.flagsBuf),e.bindArray++),l.indicesBuf&&(l.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++):l.positions&&(o.drawArrays(o.TRIANGLES,0,l.positions.numItems),e.drawArrays++),p&&o.depthFunc(o.LESS);},li.prototype._allocate=function(e){const t=e.scene,s=t.canvas.gl,i=e._material,r=t._lightsState,o=t._sectionPlanesState,n=e._material._state;if(this._program=new xe(s,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=a.getLocation("uvDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC"));const h=r.lights;let l;for(var u=0,c=h.length;u<c;u++){switch(l=h[u],l.type){case"ambient":this._uLightAmbient[u]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[u]=a.getLocation("lightColor"+u),this._uLightPos[u]=null,this._uLightDir[u]=a.getLocation("lightDir"+u);break;case"point":this._uLightColor[u]=a.getLocation("lightColor"+u),this._uLightPos[u]=a.getLocation("lightPos"+u),this._uLightDir[u]=null,this._uLightAttenuation[u]=a.getLocation("lightAttenuation"+u);break;case"spot":this._uLightColor[u]=a.getLocation("lightColor"+u),this._uLightPos[u]=a.getLocation("lightPos"+u),this._uLightDir[u]=a.getLocation("lightDir"+u),this._uLightAttenuation[u]=a.getLocation("lightAttenuation"+u);}l.castsShadow&&(this._uShadowViewMatrix[u]=a.getLocation("shadowViewMatrix"+u),this._uShadowProjMatrix[u]=a.getLocation("shadowProjMatrix"+u));}r.lightMaps.length>0&&(this._uLightMap="lightMap"),r.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(u=0,c=o.sectionPlanes.length;u<c;u++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+u),pos:a.getLocation("sectionPlanePos"+u),dir:a.getLocation("sectionPlaneDir"+u)});switch(this._uPointSize=a.getLocation("pointSize"),n.type){case"LambertMaterial":this._uMaterialColor=a.getLocation("materialColor"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=a.getLocation("materialAmbient"),this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=a.getLocation("materialShininess"),i._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=a.getLocation("ambientMapMatrix")),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),i._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=a.getLocation("reflectivityMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),i._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=a.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=a.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=a.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=a.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=a.getLocation("diffuseFresnelPower")),i._specularFresnel&&(this._uSpecularFresnelEdgeBias=a.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=a.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=a.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=a.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=a.getLocation("specularFresnelPower")),i._alphaFresnel&&(this._uAlphaFresnelEdgeBias=a.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=a.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=a.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=a.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=a.getLocation("alphaFresnelPower")),i._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=a.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=a.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=a.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=a.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=a.getLocation("reflectivityFresnelPower")),i._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=a.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=a.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=a.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=a.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=a.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=a.getLocation("materialBaseColor"),this._uMaterialMetallic=a.getLocation("materialMetallic"),this._uMaterialRoughness=a.getLocation("materialRoughness"),this._uMaterialSpecularF0=a.getLocation("materialSpecularF0"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),i._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=a.getLocation("baseColorMapMatrix")),i._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=a.getLocation("metallicMapMatrix")),i._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=a.getLocation("roughnessMapMatrix")),i._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=a.getLocation("metallicRoughnessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialGlossiness=a.getLocation("materialGlossiness"),this._uMaterialReflectivity=a.getLocation("reflectivityFresnel"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),i._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=a.getLocation("glossinessMapMatrix")),i._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=a.getLocation("materialSpecularGlossinessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));}this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aUV=a.getAttribute("uv"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._uClippable=a.getLocation("clippable"),this._uColorize=a.getLocation("colorize"),this._uOffset=a.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0;},li.prototype._bindProgram=function(e){const t=pe.MAX_TEXTURE_UNITS,s=this._scene,i=s.canvas.gl,r=s._lightsState,o=s.camera.project;let n;const a=this._program;if(a.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),s.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e);}for(var h=0,l=r.lights.length;h<l;h++)if(n=r.lights[h],this._uLightAmbient[h])i.uniform4f(this._uLightAmbient[h],n.color[0],n.color[1],n.color[2],n.intensity);else if(this._uLightColor[h]&&i.uniform4f(this._uLightColor[h],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[h]&&(i.uniform3fv(this._uLightPos[h],n.pos),this._uLightAttenuation[h]&&i.uniform1f(this._uLightAttenuation[h],n.attenuation)),this._uLightDir[h]&&i.uniform3fv(this._uLightDir[h],n.dir),n.castsShadow){this._uShadowViewMatrix[h]&&i.uniformMatrix4fv(this._uShadowViewMatrix[h],!1,n.getShadowViewMatrix()),this._uShadowProjMatrix[h]&&i.uniformMatrix4fv(this._uShadowProjMatrix[h],!1,n.getShadowProjMatrix());const s=n.getShadowRenderBuf();s&&(a.bindTexture("shadowMap"+h,s.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++);}r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(a.bindTexture(this._uLightMap,r.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(a.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,s.gammaFactor),this._baseTextureUnit=e.textureUnit;};class ci{constructor(e){this.vertex=function(e){const t=e.scene,s=t._lightsState,i=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return !0;return !1}(e),r=t._sectionPlanesState.sectionPlanes.length>0,o=!!e._geometry._state.compressGeometry,n=e._state.billboard,a=e._state.stationary,h=[];h.push("#version 300 es"),h.push("// EmphasisFillShaderSource vertex shader"),h.push("in vec3 position;"),h.push("uniform mat4 modelMatrix;"),h.push("uniform mat4 viewMatrix;"),h.push("uniform mat4 projMatrix;"),h.push("uniform vec4 colorize;"),h.push("uniform vec3 offset;"),o&&h.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(h.push("uniform float logDepthBufFC;"),h.push("out float vFragDepth;"),h.push("bool isPerspectiveMatrix(mat4 m) {"),h.push("    return (m[2][3] == - 1.0);"),h.push("}"),h.push("out float isPerspective;"));r&&h.push("out vec4 vWorldPosition;");if(h.push("uniform vec4   lightAmbient;"),h.push("uniform vec4   fillColor;"),i){h.push("in vec3 normal;"),h.push("uniform mat4 modelNormalMatrix;"),h.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(h.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&h.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&h.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&h.push("uniform vec3 lightPos"+e+";"));}o&&(h.push("vec3 octDecode(vec2 oct) {"),h.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),h.push("    if (v.z < 0.0) {"),h.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),h.push("    }"),h.push("    return normalize(v);"),h.push("}"));}h.push("out vec4 vColor;"),("spherical"===n||"cylindrical"===n)&&(h.push("void billboard(inout mat4 mat) {"),h.push("   mat[0][0] = 1.0;"),h.push("   mat[0][1] = 0.0;"),h.push("   mat[0][2] = 0.0;"),"spherical"===n&&(h.push("   mat[1][0] = 0.0;"),h.push("   mat[1][1] = 1.0;"),h.push("   mat[1][2] = 0.0;")),h.push("   mat[2][0] = 0.0;"),h.push("   mat[2][1] = 0.0;"),h.push("   mat[2][2] =1.0;"),h.push("}"));h.push("void main(void) {"),h.push("vec4 localPosition = vec4(position, 1.0); "),h.push("vec4 worldPosition;"),o&&h.push("localPosition = positionsDecodeMatrix * localPosition;");i&&(o?h.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):h.push("vec4 localNormal = vec4(normal, 0.0); "),h.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),h.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));h.push("mat4 viewMatrix2 = viewMatrix;"),h.push("mat4 modelMatrix2 = modelMatrix;"),a&&h.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(h.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),h.push("billboard(modelMatrix2);"),h.push("billboard(viewMatrix2);"),h.push("billboard(modelViewMatrix);"),i&&(h.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),h.push("billboard(modelNormalMatrix2);"),h.push("billboard(viewNormalMatrix2);"),h.push("billboard(modelViewNormalMatrix);")),h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));i&&h.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(h.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),h.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),h.push("float lambertian = 1.0;"),i)for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?h.push("viewLightDir = normalize(lightDir"+e+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else {if("point"!==t.type)continue;"view"===t.space?h.push("viewLightDir = normalize(lightPos"+e+" - viewPosition.xyz);"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);");}h.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),h.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);");}}h.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&h.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&h.push("gl_PointSize = pointSize;");h.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(h.push("vFragDepth = 1.0 + clipPos.w;"),h.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return h.push("gl_Position = clipPos;"),h.push("}"),h}(e),this.fragment=function(e){const t=e.scene,s=e.scene._sectionPlanesState,i=e.scene.gammaOutput,r=s.sectionPlanes.length>0,o=[];o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";");}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}");}"points"===e._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");i?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e);}}const pi=new s({}),di=f.vec3(),fi=function(e,t){this.id=pi.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new ci(t),this._allocate(t);},mi={};fi.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let s=mi[t];return s||(s=new fi(t,e),mi[t]=s,g.memory.programs++),s._useCount++,s},fi.prototype.put=function(){0==--this._useCount&&(pi.removeItem(this.id),this._program&&this._program.destroy(),delete mi[this._hash],g.memory.programs--);},fi.prototype.webglContextRestored=function(){this._program=null;},fi.prototype.drawMesh=function(e,t,s){this._program||this._allocate(t);const i=this._scene,r=i.camera,o=i.canvas.gl,n=0===s?t._xrayMaterial._state:1===s?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,h=t._geometry._state,l=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCViewMatrix(a.originHash,l):r.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const s=i._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const i=r.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,i?1:0),i){const i=s[t];o.uniform3fv(e.pos,l?K(i.dist,i.dir,l,di):i.pos),o.uniform3fv(e.dir,i.dir);}}}}}if(n.id!==this._lastMaterialId){const t=n.fillColor,s=n.backfaces;e.backfaces!==s&&(s?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=s),o.uniform4f(this._uFillColor,t[0],t[1],t[2],n.fillAlpha),this._lastMaterialId=n.id;}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,t.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),e.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),e.bindArray++):h.positionsBuf,this._lastGeometryId=h.id),h.indicesBuf?(o.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++):h.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,h.positionsBuf.numItems),e.drawArrays++);},fi.prototype._allocate=function(e){const t=e.scene,s=t._lightsState,i=t._sectionPlanesState,r=t.canvas.gl;if(this._program=new xe(r,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let e=0,t=s.lights.length;e<t;e++){switch(s.lights[e].type){case"ambient":this._uLightAmbient[e]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[e]=o.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=o.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=o.getLocation("lightColor"+e),this._uLightPos[e]=o.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=o.getLocation("lightAttenuation"+e);}}this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+e),pos:o.getLocation("sectionPlanePos"+e),dir:o.getLocation("sectionPlaneDir"+e)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null;},fi.prototype._bindProgram=function(e){const t=this._scene,s=t.canvas.gl,i=t._lightsState,r=t.camera,o=r.project;if(this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,s.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.normalMatrix),s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];this._uLightAmbient[e]?s.uniform4f(this._uLightAmbient[e],t.color[0],t.color[1],t.color[2],t.intensity):(this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir));}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,t.gammaFactor);};class gi{constructor(e){this.vertex=function(e){const t=e.scene,s=t._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Edges drawing vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec4 edgeColor;"),n.push("uniform vec3 offset;"),i&&n.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));s&&n.push("out vec4 vWorldPosition;");n.push("out vec4 vColor;"),("spherical"===r||"cylindrical"===r)&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),i&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n.push("vColor = edgeColor;"),s&&n.push("vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,s=e.scene._sectionPlanesState,i=e.scene.gammaOutput,r=s.sectionPlanes.length>0,o=[];o.push("#version 300 es"),o.push("// Edges drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";");}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}");}t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");i?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e);}}const _i=new s({}),yi=f.vec3(),vi=function(e,t){this.id=_i.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new gi(t),this._allocate(t);},bi={};vi.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let s=bi[t];return s||(s=new vi(t,e),bi[t]=s,g.memory.programs++),s._useCount++,s},vi.prototype.put=function(){0==--this._useCount&&(_i.removeItem(this.id),this._program&&this._program.destroy(),delete bi[this._hash],g.memory.programs--);},vi.prototype.webglContextRestored=function(){this._program=null;},vi.prototype.drawMesh=function(e,t,s){this._program||this._allocate(t);const i=this._scene,r=i.camera,o=i.canvas.gl;let n;const a=t._state,h=t._geometry,l=h._state,u=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,u?e.getRTCViewMatrix(a.originHash,u):r.viewMatrix),a.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const s=i._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const i=r.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,i?1:0),i){const i=s[t];o.uniform3fv(e.pos,u?K(i.dist,i.dir,u,yi):i.pos),o.uniform3fv(e.dir,i.dir);}}}}}switch(s){case 0:n=t._xrayMaterial._state;break;case 1:n=t._highlightMaterial._state;break;case 2:n=t._selectedMaterial._state;break;default:n=t._edgeMaterial._state;}if(n.id!==this._lastMaterialId){const t=n.backfaces;if(e.backfaces!==t&&(t?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=t),e.lineWidth!==n.edgeWidth&&(o.lineWidth(n.edgeWidth),e.lineWidth=n.edgeWidth),this._uEdgeColor){const e=n.edgeColor,t=n.edgeAlpha;o.uniform4f(this._uEdgeColor,e[0],e[1],e[2],t);}this._lastMaterialId=n.id;}let c;o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),l.primitive===o.TRIANGLES?c=h._getEdgeIndices():l.primitive===o.LINES&&(c=l.indicesBuf),c&&(l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),e.bindArray++),c.bind(),e.bindArray++,this._lastGeometryId=l.id),o.drawElements(o.LINES,c.numItems,c.itemType,0),e.drawElements++);},vi.prototype._allocate=function(e){const t=e.scene,s=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new xe(s,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+e),pos:r.getLocation("sectionPlanePos"+e),dir:r.getLocation("sectionPlaneDir"+e)});this._uEdgeColor=r.getLocation("edgeColor"),this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null;},vi.prototype._bindProgram=function(e){const t=this._program,s=this._scene,i=s.canvas.gl,r=s.camera.project;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),s.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e);}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,s.gammaFactor);};class wi{constructor(e){this.vertex=function(e){const t=e.scene,s=t._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Mesh picking vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("out vec4 vViewPosition;"),n.push("uniform vec3 offset;"),i&&n.push("uniform mat4 positionsDecodeMatrix;");s&&n.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),i&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==r&&"cylindrical"!==r||(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"));n.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),n.push("   worldPosition.xyz = worldPosition.xyz + offset;"),n.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),s&&n.push("   vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,s=t._sectionPlanesState,i=s.sectionPlanes.length>0,r=[];r.push("#version 300 es"),r.push("// Mesh picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(r.push("uniform vec4 pickColor;"),i){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<s.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";");}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<s.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}");}t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   outColor = pickColor; "),r.push("}"),r}(e);}}const Pi=f.vec3(),Ti=function(e,t){this._hash=e,this._shaderSource=new wi(t),this._scene=t.scene,this._useCount=0,this._allocate(t);},xi={};Ti.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let s=xi[t];if(!s){if(s=new Ti(t,e),s.errors)return console.log(s.errors.join("\n")),null;xi[t]=s,g.memory.programs++;}return s._useCount++,s},Ti.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete xi[this._hash],g.memory.programs--);},Ti.prototype.webglContextRestored=function(){this._program=null;},Ti.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const s=this._scene,i=s.canvas.gl,r=t._state,o=t._material._state,n=t._geometry._state,a=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCPickViewMatrix(r.originHash,a):e.pickViewMatrix),r.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const r=s._sectionPlanesState.sectionPlanes,o=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const s=o.sectionPlanesActivePerLayer[t];if(i.uniform1i(e.active,s?1:0),s){const s=r[t];i.uniform3fv(e.pos,a?K(s.dist,s.dir,a,Pi):s.pos),i.uniform3fv(e.dir,s.dir);}}}}}if(o.id!==this._lastMaterialId){const t=o.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const s=o.frontface;e.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=s),this._lastMaterialId=o.id;}i.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=n.id);var h=t._state.pickID;const l=h>>24&255,u=h>>16&255,c=h>>8&255,p=255&h;i.uniform4f(this._uPickColor,p/255,c/255,u/255,l/255),n.indicesBuf?(i.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&i.drawArrays(i.TRIANGLES,0,n.positions.numItems);},Ti.prototype._allocate=function(e){const t=e.scene,s=t.canvas.gl;if(this._program=new xe(s,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uPickColor=i.getLocation("pickColor"),this._uOffset=i.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null;},Ti.prototype._bindProgram=function(e){const t=this._scene,s=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.useProgram++,t.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}this._lastMaterialId=null,this._lastGeometryId=null;};class Mi{constructor(e){this.vertex=function(e){const t=e.scene,s=t._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry;e._state.billboard,e._state.stationary;const r=[];r.push("#version 300 es"),r.push("// Surface picking vertex shader"),r.push("in vec3 position;"),r.push("in vec4 color;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform vec3 offset;"),s&&(r.push("uniform bool clippable;"),r.push("out vec4 vWorldPosition;"));t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;"),r.push("bool isPerspectiveMatrix(mat4 m) {"),r.push("    return (m[2][3] == - 1.0);"),r.push("}"),r.push("out float isPerspective;"));r.push("out vec4 vColor;"),i&&r.push("uniform mat4 positionsDecodeMatrix;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),i&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("   vec4 worldPosition = modelMatrix * localPosition; "),r.push("   worldPosition.xyz = worldPosition.xyz + offset;"),r.push("   vec4 viewPosition = viewMatrix * worldPosition;"),s&&r.push("   vWorldPosition = worldPosition;");r.push("   vColor = color;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return r.push("gl_Position = clipPos;"),r.push("}"),r}(e),this.fragment=function(e){const t=e.scene,s=t._sectionPlanesState,i=s.sectionPlanes.length>0,r=[];r.push("#version 300 es"),r.push("// Surface picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),r.push("in vec4 vColor;"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(i){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(let e=0;e<s.sectionPlanes.length;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";");}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0;e<s.sectionPlanes.length;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}");}t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   outColor = vColor;"),r.push("}"),r}(e);}}const Di=f.vec3(),Ai=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Mi(t),this._allocate(t);},Ci={};Ai.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let s=Ci[t];if(!s){if(s=new Ai(t,e),s.errors)return console.log(s.errors.join("\n")),null;Ci[t]=s,g.memory.programs++;}return s._useCount++,s},Ai.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Ci[this._hash],g.memory.programs--);},Ai.prototype.webglContextRestored=function(){this._program=null;},Ai.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const s=this._scene,i=s.canvas.gl,r=t._state,o=t._material._state,n=t._geometry,a=t._geometry._state,h=t.origin,l=o.backfaces,u=o.frontface,c=s.camera.project,p=n._getPickTrianglePositions(),d=n._getPickTriangleColors();if(this._program.bind(),e.useProgram++,s.logarithmicDepthBufferEnabled){const e=2/(Math.log(c.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e);}if(i.uniformMatrix4fv(this._uViewMatrix,!1,h?e.getRTCPickViewMatrix(r.originHash,h):e.pickViewMatrix),r.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const r=s._sectionPlanesState.sectionPlanes,o=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const s=o.sectionPlanesActivePerLayer[t];if(i.uniform1i(e.active,s?1:0),s){const s=r[t];i.uniform3fv(e.pos,h?K(s.dist,s.dir,h,Di):s.pos),i.uniform3fv(e.dir,s.dir);}}}}}i.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.logarithmicDepthBufferEnabled&&i.uniform1f(this._uZFar,s.camera.project.far),e.backfaces!==l&&(l?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=l),e.frontface!==u&&(u?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=u),i.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),this._uPositionsDecodeMatrix?(i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(p,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT)):this._aPosition.bindArrayBuffer(p),d.bind(),i.enableVertexAttribArray(this._aColor.location),i.vertexAttribPointer(this._aColor.location,d.itemSize,d.itemType,!0,0,0),i.drawArrays(a.primitive,0,p.numItems/3);},Ai.prototype._allocate=function(e){const t=e.scene,s=t.canvas.gl;if(this._program=new xe(s,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));};class Ii{constructor(e){this.vertex=function(e){const t=e.scene,s=t._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Mesh occlusion vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec3 offset;"),i&&n.push("uniform mat4 positionsDecodeMatrix;");s&&n.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),i&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&n.push("   vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,s=t._sectionPlanesState,i=s.sectionPlanes.length>0,r=[];r.push("#version 300 es"),r.push("// Mesh occlusion fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(i){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<s.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";");}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<s.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}");}r.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("}"),r}(e);}}const Fi=f.vec3(),Bi=function(e,t){this._hash=e,this._shaderSource=new Ii(t),this._scene=t.scene,this._useCount=0,this._allocate(t);},Ei={};Bi.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.occlusionHash].join(";");let s=Ei[t];if(!s){if(s=new Bi(t,e),s.errors)return console.log(s.errors.join("\n")),null;Ei[t]=s,g.memory.programs++;}return s._useCount++,s},Bi.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Ei[this._hash],g.memory.programs--);},Bi.prototype.webglContextRestored=function(){this._program=null;},Bi.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const s=this._scene,i=s.canvas.gl,r=t._material._state,o=t._state,n=t._geometry._state,a=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){const t=r.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const s=r.frontface;e.frontface!==s&&(s?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=s),this._lastMaterialId=r.id;}const h=s.camera;if(i.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCViewMatrix(o.originHash,a):h.viewMatrix),o.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const r=s._sectionPlanesState.sectionPlanes,o=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const s=o.sectionPlanesActivePerLayer[t];if(i.uniform1i(e.active,s?1:0),s){const s=r[t];i.uniform3fv(e.pos,a?K(s.dist,s.dir,a,Fi):s.pos),i.uniform3fv(e.dir,s.dir);}}}}}i.uniformMatrix4fv(this._uProjMatrix,!1,h._project._state.matrix),i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=n.id),n.indicesBuf?(i.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&i.drawArrays(i.TRIANGLES,0,n.positions.numItems);},Bi.prototype._allocate=function(e){const t=e.scene,s=t.canvas.gl;if(this._program=new xe(s,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null;},Bi.prototype._bindProgram=function(e){const t=this._scene,s=t.camera.project,i=t.canvas.gl;if(this._program.bind(),e.useProgram++,i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e);}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null;};class Si{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,i=[];i.push("// Mesh shadow vertex shader"),i.push("in vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform vec3 offset;"),s&&i.push("uniform mat4 positionsDecodeMatrix;");t&&i.push("out vec4 vWorldPosition;");i.push("void main(void) {"),i.push("vec4 localPosition = vec4(position, 1.0); "),i.push("vec4 worldPosition;"),s&&i.push("localPosition = positionsDecodeMatrix * localPosition;");i.push("worldPosition = modelMatrix * localPosition;"),i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&i.push("vWorldPosition = worldPosition;");return i.push("   gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i}(e),this.fragment=function(e){const t=e.scene;t.canvas.gl;const s=t._sectionPlanesState,i=s.sectionPlanes.length>0,r=[];if(r.push("// Mesh shadow fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),i){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<s.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";");}if(r.push("vec4 encodeFloat( const in float depth ) {"),r.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),r.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),r.push("  vec4 comp = fract(depth * bitShift);"),r.push("  comp -= comp.xxyz * bitMask;"),r.push("  return comp;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<s.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}");}return r.push("outColor = encodeFloat(gl_FragCoord.z);"),r.push("}"),r}(e);}}const Ri=function(e,t){this._hash=e,this._shaderSource=new Si(t),this._scene=t.scene,this._useCount=0,this._allocate(t);},Oi={};Ri.get=function(e){const t=e.scene,s=[t.canvas.canvas.id,t._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=Oi[s];if(!i){if(i=new Ri(s,e),i.errors)return console.log(i.errors.join("\n")),null;Oi[s]=i,g.memory.programs++;}return i._useCount++,i},Ri.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Oi[this._hash],g.memory.programs--);},Ri.prototype.webglContextRestored=function(){this._program=null;},Ri.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const s=this._scene.canvas.gl,i=t._material._state,r=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i.id!==this._lastMaterialId){const t=i.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const r=i.frontface;e.frontface!==r&&(r?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=r),e.lineWidth!==i.lineWidth&&(s.lineWidth(i.lineWidth),e.lineWidth=i.lineWidth),this._uPointSize&&s.uniform1i(this._uPointSize,i.pointSize),this._lastMaterialId=i.id;}if(s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),r.combineGeometry){const i=t.vertexBufs;i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),this._lastVertexBufsId=i.id);}this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combineGeometry?r.indicesBufCombined&&(r.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=r.id),r.combineGeometry?r.indicesBufCombined&&(s.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),e.drawElements++):r.indicesBuf?(s.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++):r.positions&&(s.drawArrays(s.TRIANGLES,0,r.positions.numItems),e.drawArrays++);},Ri.prototype._allocate=function(e){const t=e.scene,s=t.canvas.gl;if(this._program=new xe(s,this._shaderSource),this._scene=t,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uShadowViewMatrix=i.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=i.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null;},Ri.prototype._bindProgram=function(e){this._program||this._allocate(mesh);const t=this._scene,s=t.canvas.gl,i=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),s.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.sectionPlanes.length>0){let e,t,r,o,n;for(let a=0,h=this._uSectionPlanes.length;a<h;a++)e=this._uSectionPlanes[a],t=e.active,r=i.sectionPlanes[a],t&&s.uniform1i(t,r.active),o=e.pos,o&&s.uniform3fv(e.pos,r.pos),n=e.dir,n&&s.uniform3fv(e.dir,r.dir);}};class Li{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset();}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1;}}const Ni=f.OBB3(),ki=f.vec4(),ji=f.vec4(),Gi=f.vec4(),Hi=f.vec3([1,0,0]),Vi=f.vec3([0,1,0]),Ui=f.vec3([0,0,1]),zi=f.vec3(3),Wi=f.vec3(3),Xi=f.identityMat4();class Yi extends B{constructor(e,t={}){super(e,t),this.originalSystemId=t.originalSystemId||this.id,this.renderFlags=new Li,this._state=new Xe({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:!1!==t.occluder,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,background:!!t.background,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:f.vec3(),origin:null,originHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=f.vec3(),this._quaternion=f.identityQuaternion(),this._rotation=f.vec3(),this._position=f.vec3(),this._worldMatrix=f.identityMat4(),this._worldNormalMatrix=f.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const s=t.origin||t.rtcCenter;if(s&&(this._state.origin=f.vec3(s),this._state.originHash=s.join()),t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=e;}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile();}get type(){return "Mesh"}get isMesh(){return !0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get rotation(){return this._rotation}set rotation(e){this._rotation.set(e||[0,0,0]),f.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get quaternion(){return this._quaternion}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),f.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get scale(){return this._scale}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=f.identityMat4()),f.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(e){this.__localMatrix||(this.__localMatrix=f.identityMat4()),this.__localMatrix.set(e||Xi),f.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return !0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(e){e?(this._state.origin||(this._state.origin=f.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0);}get rtcCenter(){return this.origin}set rtcCenter(e){this.origin=e;}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw();}get xrayed(){return this._state.xrayed}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw());}get highlighted(){return this._state.highlighted}set highlighted(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw());}get selected(){return this._state.selected}set selected(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw());}get edges(){return this._state.edges}set edges(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw());}get culled(){return this._state.culled}set culled(e){this._state.culled=!!e,this.glRedraw();}get clippable(){return this._state.clippable}set clippable(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw());}get collidable(){return this._state.collidable}set collidable(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0);}get pickable(){return this._state.pickable}set pickable(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e);}get castsShadow(){return this._state.castsShadow}set castsShadow(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw());}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this));}get saoEnabled(){return !1}get colorize(){return this._state.colorize}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);const s=!!e;this.scene._objectColorizeUpdated(this,s),this.glRedraw();}get opacity(){return this._state.colorize[3]}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1);const s=null!=e;t[3]=s?e:1,this.scene._objectOpacityUpdated(this,s),this.glRedraw();}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort());}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw();}get isDrawable(){return !0}get isStateSortable(){return !0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(e){return "spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=li.get(this),this._emphasisFillRenderer=fi.get(this),this._emphasisEdgesRenderer=vi.get(this));const t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=Ti.get(this)),this._state.occluder){const e=this._makeOcclusionHash();this._state.occlusionHash!==e&&(this._state.occlusionHash=e,this._putOcclusionRenderer(),this._occlusionRenderer=Bi.get(this));}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty();}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)f.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,s=e.length;t<s;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1;}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=f.mat4()),f.transposeMat4(this._worldMatrix,this._worldNormalMatrix),f.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1;}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0;}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=f.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1;}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored();}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],s=this._state;return s.stationary&&t.push("/s"),"none"===s.billboard?t.push("/n"):"spherical"===s.billboard?t.push("/s"):"cylindrical"===s.billboard&&t.push("/c"),s.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],s=this._state;return s.stationary&&t.push("/s"),"none"===s.billboard?t.push("/n"):"spherical"===s.billboard?t.push("/s"):"cylindrical"===s.billboard&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],s=this._state;return s.stationary&&t.push("/s"),"none"===s.billboard?t.push("/n"):"spherical"===s.billboard?t.push("/s"):"cylindrical"===s.billboard&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){f.transformOBB3(e,this._geometry.obb,Ni),f.OBB3ToAABB3(Ni,t);const s=this._state.offset;if(t[0]+=s[0],t[1]+=s[1],t[2]+=s[2],t[3]+=s[0],t[4]+=s[1],t[5]+=s[2],this._state.origin){const e=this._state.origin;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2];}}rotate(e,t){return ki[0]=e[0],ki[1]=e[1],ki[2]=e[2],ki[3]=t*f.DEGTORAD,f.angleAxisToQuaternion(ki,ji),f.mulQuaternions(this.quaternion,ji,Gi),this.quaternion=Gi,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return ki[0]=e[0],ki[1]=e[1],ki[2]=e[2],ki[3]=t*f.DEGTORAD,f.angleAxisToQuaternion(ki,ji),f.mulQuaternions(ji,this.quaternion,ji),this}rotateX(e){return this.rotate(Hi,e)}rotateY(e){return this.rotate(Vi,e)}rotateZ(e){return this.rotate(Ui,e)}translate(e,t){return f.vec3ApplyQuaternion(this.quaternion,e,zi),f.mulVec3Scalar(zi,t,Wi),f.addVec3(this.position,Wi,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(Hi,e)}translateY(e){return this.translate(Vi,e)}translateZ(e){return this.translate(Ui,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null);}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null);}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null);}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}rebuildRenderFlags(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0;}_updateRenderFlags(){const e=this.renderFlags,t=this._state;if(t.xrayed){const t=this._xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0);}else {if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges){this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0;}if(t.selected){const t=this._selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0);}else if(t.highlighted){const t=this._highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0);}}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let s=0;s<t;s++){const t=e[s],i=this.renderFlags;if(t.active)if(this._state.origin){const e=f.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return !1;const r=0===e;i.sectionPlanesActivePerLayer[s]=r;}else i.sectionPlanesActivePerLayer[s]=!0;else i.sectionPlanesActivePerLayer[s]=!1;}}return !0}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=li.get(this)))&&this._drawRenderer.drawMesh(e,this);}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=li.get(this)))&&this._drawRenderer.drawMesh(e,this);}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=fi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0);}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=fi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1);}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=fi.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2);}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3);}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3);}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0);}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1);}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2);}drawOcclusion(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=Bi.get(this)))&&this._occlusionRenderer.drawMesh(e,this);}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=Ri.get(this)))&&this._shadowRenderer.drawMesh(e,this);}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=Ti.get(this)))&&this._pickMeshRenderer.drawMesh(e,this);}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Ai.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this);}pickTriangleSurface(e,t,s){Ki(this,e,t,s);}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw();}}const Ki=function(){const e=f.vec3(),t=f.vec3(),s=f.vec3(),i=f.vec3(),r=f.vec3(),o=f.vec3(),n=f.vec4(),a=f.vec3(),h=f.vec3(),l=f.vec3(),u=f.vec3(),c=f.vec3(),p=f.vec3(),d=f.vec3(),m=f.vec3(),g=f.vec3(),_=f.vec4(),y=f.vec4(),v=f.vec4(),b=f.vec3(),w=f.vec3(),P=f.vec3(),T=f.vec3(),x=f.vec3(),M=f.vec3(),D=f.vec3(),A=f.vec3(),C=f.vec3(),I=f.vec3(),F=f.vec3();return function(B,E,S,R){var O=R.primIndex;if(null!=O&&O>-1){const j=B.geometry._state,G=B.scene,H=G.camera,V=G.canvas;if("triangles"===j.primitiveName){R.primitive="triangle";const G=O,U=j.indices,z=j.positions;let W,X,Y,K;if(U){var L=U[G+0],N=U[G+1],k=U[G+2];o[0]=L,o[1]=N,o[2]=k,R.indices=o,W=3*L,X=3*N,Y=3*k;}else W=3*G,X=W+3,Y=X+3;if(s[0]=z[W+0],s[1]=z[W+1],s[2]=z[W+2],i[0]=z[X+0],i[1]=z[X+1],i[2]=z[X+2],r[0]=z[Y+0],r[1]=z[Y+1],r[2]=z[Y+2],j.compressGeometry){const e=j.positionsDecodeMatrix;e&&(Pt.decompressPosition(s,e,s),Pt.decompressPosition(i,e,i),Pt.decompressPosition(r,e,r));}R.canvasPos?(K=R.canvasPos,f.canvasPosToLocalRay(V.canvas,E,S,B.worldMatrix,K,e,t)):R.origin&&R.direction&&f.worldRayToLocalRay(B.worldMatrix,R.origin,R.direction,e,t),f.normalizeVec3(t),f.rayPlaneIntersect(e,t,s,i,r,n),R.localPos=n,R.position=n,_[0]=n[0],_[1]=n[1],_[2]=n[2],_[3]=1,f.transformVec4(B.worldMatrix,_,y),a[0]=y[0],a[1]=y[1],a[2]=y[2],R.worldPos=a,f.transformVec4(H.matrix,y,v),h[0]=v[0],h[1]=v[1],h[2]=v[2],R.viewPos=h,f.cartesianToBarycentric(n,s,i,r,l),R.bary=l;const J=j.normals;if(J){if(j.compressGeometry){const e=3*L,t=3*N,s=3*k;Pt.decompressNormal(J.subarray(e,e+2),u),Pt.decompressNormal(J.subarray(t,t+2),c),Pt.decompressNormal(J.subarray(s,s+2),p);}else u[0]=J[W],u[1]=J[W+1],u[2]=J[W+2],c[0]=J[X],c[1]=J[X+1],c[2]=J[X+2],p[0]=J[Y],p[1]=J[Y+1],p[2]=J[Y+2];const e=f.addVec3(f.addVec3(f.mulVec3Scalar(u,l[0],b),f.mulVec3Scalar(c,l[1],w),P),f.mulVec3Scalar(p,l[2],T),x);R.worldNormal=f.normalizeVec3(f.transformVec3(B.worldNormalMatrix,e,M));}const Z=j.uv;if(Z){if(d[0]=Z[2*L],d[1]=Z[2*L+1],m[0]=Z[2*N],m[1]=Z[2*N+1],g[0]=Z[2*k],g[1]=Z[2*k+1],j.compressGeometry){const e=j.uvDecodeMatrix;e&&(Pt.decompressUV(d,e,d),Pt.decompressUV(m,e,m),Pt.decompressUV(g,e,g));}R.uv=f.addVec3(f.addVec3(f.mulVec2Scalar(d,l[0],D),f.mulVec2Scalar(m,l[1],A),C),f.mulVec2Scalar(g,l[2],I),F);}}}}}();function Ji(e={}){let t=e.radiusTop||1;t<0&&(console.error("negative radiusTop not allowed - will invert"),t*=-1);let s=e.radiusBottom||1;s<0&&(console.error("negative radiusBottom not allowed - will invert"),s*=-1);let i=e.height||1;i<0&&(console.error("negative height not allowed - will invert"),i*=-1);let r=e.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let o=e.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const n=!!e.openEnded;let a=e.center;const h=a?a[0]:0,l=a?a[1]:0,u=a?a[2]:0,c=i/2,p=i/o,d=2*Math.PI/r,f=1/r,m=(t-s)/o,g=[],_=[],y=[],v=[];let w,P,T,x,M,D,A,C,I,F,B;const E=(90-180*Math.atan(i/(s-t))/Math.PI)/90;for(w=0;w<=o;w++)for(M=t-w*m,D=c-w*p,P=0;P<=r;P++)T=Math.sin(P*d),x=Math.cos(P*d),_.push(M*T),_.push(E),_.push(M*x),y.push(P*f),y.push(1*w/o),g.push(M*T+h),g.push(D+l),g.push(M*x+u);for(w=0;w<o;w++)for(P=0;P<=r;P++)A=w*(r+1)+P,C=A+r,v.push(A),v.push(C),v.push(C+1),v.push(A),v.push(C+1),v.push(A+1);if(!n&&t>0){for(I=g.length/3,_.push(0),_.push(1),_.push(0),y.push(.5),y.push(.5),g.push(0+h),g.push(c+l),g.push(0+u),P=0;P<=r;P++)T=Math.sin(P*d),x=Math.cos(P*d),F=.5*Math.sin(P*d)+.5,B=.5*Math.cos(P*d)+.5,_.push(t*T),_.push(1),_.push(t*x),y.push(F),y.push(B),g.push(t*T+h),g.push(c+l),g.push(t*x+u);for(P=0;P<r;P++)a=I,A=I+1+P,v.push(A),v.push(A+1),v.push(a);}if(!n&&s>0){for(I=g.length/3,_.push(0),_.push(-1),_.push(0),y.push(.5),y.push(.5),g.push(0+h),g.push(0-c+l),g.push(0+u),P=0;P<=r;P++)T=Math.sin(P*d),x=Math.cos(P*d),F=.5*Math.sin(P*d)+.5,B=.5*Math.cos(P*d)+.5,_.push(s*T),_.push(-1),_.push(s*x),y.push(F),y.push(B),g.push(s*T+h),g.push(0-c+l),g.push(s*x+u);for(P=0;P<r;P++)a=I,A=I+1+P,v.push(a),v.push(A+1),v.push(A);}return b.apply(e,{positions:g,normals:_,uv:y,indices:v})}function Zi(e={}){const t=e.lod||1,s=e.center?e.center[0]:0,i=e.center?e.center[1]:0,r=e.center?e.center[2]:0;let o=e.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let n=e.heightSegments||18;n<0&&(console.error("negative heightSegments not allowed - will invert"),n*=-1),n=Math.floor(t*n),n<18&&(n=18);let a=e.widthSegments||18;a<0&&(console.error("negative widthSegments not allowed - will invert"),a*=-1),a=Math.floor(t*a),a<18&&(a=18);const h=[],l=[],u=[],c=[];let p,d,f,m,g,_,y,v,w,P,T,x,M,D,A;for(p=0;p<=n;p++)for(f=p*Math.PI/n,m=Math.sin(f),g=Math.cos(f),d=0;d<=a;d++)_=2*d*Math.PI/a,y=Math.sin(_),v=Math.cos(_),w=v*m,P=g,T=y*m,x=1-d/a,M=p/n,l.push(w),l.push(P),l.push(T),u.push(x),u.push(M),h.push(s+o*w),h.push(i+o*P),h.push(r+o*T);for(p=0;p<n;p++)for(d=0;d<a;d++)D=p*(a+1)+d,A=D+a+1,c.push(D+1),c.push(A+1),c.push(A),c.push(D+1),c.push(A),c.push(D);return b.apply(e,{positions:h,normals:l,uv:u,indices:c})}class er extends B{get type(){return "SectionPlane"}constructor(e,t={}){super(e,t),this._state=new Xe({active:!0,pos:f.vec3(),dir:f.vec3(),dist:0}),this.active=t.active,this.pos=t.pos,this.dir=t.dir,this.scene._sectionPlaneCreated(this);}set active(e){this._state.active=!1!==e,this.glRedraw(),this.fire("active",this._state.active);}get active(){return this._state.active}set pos(e){this._state.pos.set(e||[0,0,0]),this._state.dist=-f.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos);}get pos(){return this._state.pos}set dir(e){this._state.dir.set(e||[0,0,-1]),this._state.dist=-f.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir);}get dir(){return this._state.dir}get dist(){return this._state.dist}flipDir(){const e=this._state.dir;e[0]*=-1,e[1]*=-1,e[2]*=-1,this._state.dist=-f.dotVec3(this._state.pos,this._state.dir),this.fire("dir",this._state.dir),this.glRedraw();}destroy(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),super.destroy();}}const tr=f.vec3();class sr extends h{constructor(e,t={}){super("BCFViewpoints",e,t),this.originatingSystem=t.originatingSystem||"xeokit.io",this.authoringTool=t.authoringTool||"xeokit.io";}getViewpoint(e={}){const t=this.viewer.scene,s=t.camera,i=t.realWorldOffset,r=!0===e.reverseClippingPlanes;let o={},n=f.normalizeVec3(f.subVec3(s.look,s.eye,f.vec3())),a=s.eye,h=s.up;s.yUp&&(n=or(n),a=or(a),h=or(h));const l=ir(f.addVec3(a,i));"ortho"===s.projection?o.orthogonal_camera={camera_view_point:l,camera_direction:ir(n),camera_up_vector:ir(h),view_to_world_scale:s.ortho.scale}:o.perspective_camera={camera_view_point:l,camera_direction:ir(n),camera_up_vector:ir(h),field_of_view:s.perspective.fov};const u=t.sectionPlanes;for(let e in u)if(u.hasOwnProperty(e)){let t,n=u[e],a=n.pos;t=r?f.negateVec3(n.dir,f.vec3()):n.dir,s.yUp&&(a=or(a),t=or(t)),f.addVec3(a,i),a=ir(a),t=ir(t),o.clipping_planes||(o.clipping_planes=[]),o.clipping_planes.push({location:a,direction:t});}o.components={visibility:{view_setup_hints:{spaces_visible:!!e.spacesVisible,space_boundaries_visible:!!e.spaceBoundariesVisible,openings_visible:!!e.openingsVisible}}};const c=new Set(t.opacityObjectIds),p=new Set(t.xrayedObjectIds),d=new Set(t.colorizedObjectIds),m=Object.values(t.objects).filter((e=>c.has(e.id)||d.has(e.id)||p.has(e.id))).reduce(((e,s)=>{let i,r=function(e){let t="";return t+=Math.round(255*e[0]).toString(16).padStart(2,"0"),t+=Math.round(255*e[1]).toString(16).padStart(2,"0"),t+=Math.round(255*e[2]).toString(16).padStart(2,"0"),t}(s.colorize);s.xrayed?(i=0===t.xrayMaterial.fillAlpha&&0!==t.xrayMaterial.edgeAlpha?.1:t.xrayMaterial.fillAlpha,i=Math.round(255*i).toString(16).padStart(2,"0"),r=i+r):c.has(s.id)&&(i=Math.round(255*s.opacity).toString(16).padStart(2,"0"),r=i+r),e[r]||(e[r]=[]);const o=s.id,n=s.originalSystemId,a={ifc_guid:n,originating_system:this.originatingSystem};return n!==o&&(a.authoring_tool_id=o),e[r].push(a),e}),{}),g=Object.entries(m).map((([e,t])=>({color:e,components:t})));o.components.coloring=g;const _=t.objectIds,y=t.visibleObjects,v=t.visibleObjectIds,b=_.filter((e=>!y[e])),w=t.selectedObjectIds;return e.defaultInvisible||v.length<b.length?(o.components.visibility.exceptions=this._createBCFComponents(v),o.components.visibility.default_visibility=!1):(o.components.visibility.exceptions=this._createBCFComponents(b),o.components.visibility.default_visibility=!0),o.components.selection=this._createBCFComponents(w),!1!==e.snapshot&&(o.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),o}_createBCFComponents(e){const t=this.viewer.scene,s=[];for(let i=0,r=e.length;i<r;i++){const r=e[i],o=t.objects[r];if(o){const e={ifc_guid:o.originalSystemId,originating_system:this.originatingSystem};o.originalSystemId!==r&&(e.authoring_tool_id=r),s.push(e);}}return s}setViewpoint(e,t={}){if(!e)return;const s=this.viewer,i=s.scene,r=i.camera,o=!1!==t.rayCast,n=!1!==t.immediate,a=!1!==t.reset,h=i.realWorldOffset,l=!0===t.reverseClippingPlanes;if(i.clearSectionPlanes(),e.clipping_planes&&e.clipping_planes.forEach((function(e){let t=rr(e.location,tr),s=rr(e.direction,tr);l&&f.negateVec3(s),f.subVec3(t,h),r.yUp&&(t=nr(t),s=nr(s)),new er(i,{pos:t,dir:s});})),a&&(i.setObjectsXRayed(i.xrayedObjectIds,!1),i.setObjectsHighlighted(i.highlightedObjectIds,!1),i.setObjectsSelected(i.selectedObjectIds,!1)),e.components){if(e.components.visibility){e.components.visibility.default_visibility?(i.setObjectsVisible(i.objectIds,!0),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((e=>this._withBCFComponent(t,e,(e=>e.visible=!1))))):(i.setObjectsVisible(i.objectIds,!1),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((e=>this._withBCFComponent(t,e,(e=>e.visible=!0)))));const r=e.components.visibility.view_setup_hints;r&&(!1===r.spaces_visible&&i.setObjectsVisible(s.metaScene.getObjectIDsByType("IfcSpace"),!1),!1===r.openings_visible&&i.setObjectsVisible(s.metaScene.getObjectIDsByType("IfcOpening"),!1),r.space_boundaries_visible);}e.components.selection&&(i.setObjectsSelected(i.selectedObjectIds,!1),e.components.selection.forEach((e=>this._withBCFComponent(t,e,(e=>e.selected=!0))))),e.components.coloring&&e.components.coloring.forEach((e=>{let s=e.color,i=0,r=!1;8===s.length&&(i=parseInt(s.substring(0,2),16)/256,i<=1&&i>=.95&&(i=1),s=s.substring(2),r=!0);const o=[parseInt(s.substring(0,2),16)/256,parseInt(s.substring(2,4),16)/256,parseInt(s.substring(4,6),16)/256];e.components.map((e=>this._withBCFComponent(t,e,(e=>{e.colorize=o,r&&(e.opacity=i);}))));}));}if(e.perspective_camera||e.orthogonal_camera){let a,l,u,c;if(e.perspective_camera?(a=rr(e.perspective_camera.camera_view_point,tr),l=rr(e.perspective_camera.camera_direction,tr),u=rr(e.perspective_camera.camera_up_vector,tr),r.perspective.fov=e.perspective_camera.field_of_view,c="perspective"):(a=rr(e.orthogonal_camera.camera_view_point,tr),l=rr(e.orthogonal_camera.camera_direction,tr),u=rr(e.orthogonal_camera.camera_up_vector,tr),r.ortho.scale=e.orthogonal_camera.view_to_world_scale,c="ortho"),f.subVec3(a,h),r.yUp&&(a=nr(a),l=nr(l),u=nr(u)),o){const e=i.pick({pickSurface:!0,origin:a,direction:l});l=e?e.worldPos:f.addVec3(a,l,tr);}else l=f.addVec3(a,l,tr);n?(r.eye=a,r.look=l,r.up=u,r.projection=c):s.cameraFlight.flyTo({eye:a,look:l,up:u,duration:t.duration,projection:c});}}_withBCFComponent(e,t,s){const i=this.viewer,r=i.scene;if(t.authoring_tool_id&&t.originating_system===this.originatingSystem){const o=t.authoring_tool_id,n=r.objects[o];if(n)return void s(n);if(e.updateCompositeObjects){if(i.metaScene.metaObjects[o])return void r.withObjects(i.metaScene.getObjectIDsInSubtree(o),s)}}if(t.ifc_guid){const o=t.ifc_guid,n=r.objects[o];if(n)return void s(n);if(e.updateCompositeObjects){if(i.metaScene.metaObjects[o])return void r.withObjects(i.metaScene.getObjectIDsInSubtree(o),s)}Object.keys(r.models).forEach((t=>{const n=f.globalizeObjectId(t,o),a=r.objects[n];if(a)s(a);else if(e.updateCompositeObjects){if(i.metaScene.metaObjects[n])return void r.withObjects(i.metaScene.getObjectIDsInSubtree(n),s)}}));}}destroy(){super.destroy();}}function ir(e){return {x:e[0],y:e[1],z:e[2]}}function rr(e,t){return (t=new Float64Array(3))[0]=e.x,t[1]=e.y,t[2]=e.z,t}function or(e){return new Float64Array([e[0],-e[2],e[1]])}function nr(e){return new Float64Array([e[0],e[2],-e[1]])}var ar=f.vec3();class pr extends h{constructor(e,t={}){super("FastNav",e),this._hideColorTexture=!1!==t.hideColorTexture,this._hidePBR=!1!==t.hidePBR,this._hideSAO=!1!==t.hideSAO,this._hideEdges=!1!==t.hideEdges,this._hideTransparentObjects=!!t.hideTransparentObjects,this._scaleCanvasResolution=!!t.scaleCanvasResolution,this._scaleCanvasResolutionFactor=t.scaleCanvasResolutionFactor||.6,this._delayBeforeRestore=!1!==t.delayBeforeRestore,this._delayBeforeRestoreSeconds=t.delayBeforeRestoreSeconds||.5;let s=1e3*this._delayBeforeRestoreSeconds,i=!1;const r=()=>{s=1e3*this._delayBeforeRestoreSeconds,i||(e.scene._renderer.setColorTextureEnabled(!this._hideColorTexture),e.scene._renderer.setPBREnabled(!this._hidePBR),e.scene._renderer.setSAOEnabled(!this._hideSAO),e.scene._renderer.setTransparentEnabled(!this._hideTransparentObjects),e.scene._renderer.setEdgesEnabled(!this._hideEdges),this._scaleCanvasResolution?e.scene.canvas.resolutionScale=this._scaleCanvasResolutionFactor:e.scene.canvas.resolutionScale=1,i=!0);};this._onCanvasBoundary=e.scene.canvas.on("boundary",r),this._onCameraMatrix=e.scene.camera.on("matrix",r),this._onSceneTick=e.scene.on("tick",(t=>{i&&(s-=t.deltaTime,(!this._delayBeforeRestore||s<=0)&&(e.scene.canvas.resolutionScale=1,e.scene._renderer.setEdgesEnabled(!0),e.scene._renderer.setColorTextureEnabled(!0),e.scene._renderer.setPBREnabled(!0),e.scene._renderer.setSAOEnabled(!0),e.scene._renderer.setTransparentEnabled(!0),i=!1));}));let o=!1;this._onSceneMouseDown=e.scene.input.on("mousedown",(()=>{o=!0;})),this._onSceneMouseUp=e.scene.input.on("mouseup",(()=>{o=!1;})),this._onSceneMouseMove=e.scene.input.on("mousemove",(()=>{o&&r();}));}get hideColorTexture(){return this._hideColorTexture}set hideColorTexture(e){this._hideColorTexture=e;}get hidePBR(){return this._hidePBR}set hidePBR(e){this._hidePBR=e;}get hideSAO(){return this._hideSAO}set hideSAO(e){this._hideSAO=e;}get hideEdges(){return this._hideEdges}set hideEdges(e){this._hideEdges=e;}get hideTransparentObjects(){return this._hideTransparentObjects}set hideTransparentObjects(e){this._hideTransparentObjects=!1!==e;}get scaleCanvasResolution(){return this._scaleCanvasResolution}set scaleCanvasResolution(e){this._scaleCanvasResolution=e;}get scaleCanvasResolutionFactor(){return this._scaleCanvasResolutionFactor}set scaleCanvasResolutionFactor(e){this._scaleCanvasResolutionFactor=e||.6;}get delayBeforeRestore(){return this._delayBeforeRestore}set delayBeforeRestore(e){this._delayBeforeRestore=e;}get delayBeforeRestoreSeconds(){return this._delayBeforeRestoreSeconds}set delayBeforeRestoreSeconds(e){this._delayBeforeRestoreSeconds=null!=e?e:.5;}send(e,t){}destroy(){this.viewer.scene.camera.off(this._onCameraMatrix),this.viewer.scene.canvas.off(this._onCanvasBoundary),this.viewer.scene.input.off(this._onSceneMouseDown),this.viewer.scene.input.off(this._onSceneMouseUp),this.viewer.scene.input.off(this._onSceneMouseMove),this.viewer.scene.off(this._onSceneTick),super.destroy();}}class fr{constructor(e,t,s,i,r=null,o=0){this.model=e,this.object=null,this.parent=null,this.id=t,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=f.AABB3(),this._layer=r,this._portionId=o,this._color=[s[0],s[1],s[2],i],this._colorize=[s[0],s[1],s[2],i],this._colorizing=!1,this._transparent=i<255,this.numTriangles=0,this.origin=null;}_finalize(e){this._layer.initFlags(this._portionId,e,this._transparent);}_finalize2(){this._layer.flushInitFlags&&this._layer.flushInitFlags();}_setVisible(e){this._layer.setVisible(this._portionId,e,this._transparent);}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1);}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1);}_setOpacity(e,t){const s=e<255,i=this._transparent!==s;this._color[3]=e,this._colorize[3]=e,this._transparent=s,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),i&&this._layer.setTransparent(this._portionId,t,s);}_setOffset(e){this._layer.setOffset(this._portionId,e);}_setHighlighted(e){this._layer.setHighlighted(this._portionId,e,this._transparent);}_setXRayed(e){this._layer.setXRayed(this._portionId,e,this._transparent);}_setSelected(e){this._layer.setSelected(this._portionId,e,this._transparent);}_setEdges(e){this._layer.setEdges(this._portionId,e,this._transparent);}_setClippable(e){this._layer.setClippable(this._portionId,e,this._transparent);}_setCollidable(e){this._layer.setCollidable(this._portionId,e);}_setPickable(e){this._layer.setPickable(this._portionId,e,this._transparent);}_setCulled(e){this._layer.setCulled(this._portionId,e,this._transparent);}canPickTriangle(){return !1}drawPickTriangles(e,t){}pickTriangleSurface(e){}precisionRayPickSurface(e,t,s,i){return !!this._layer.precisionRayPickSurface&&this._layer.precisionRayPickSurface(this._portionId,e,t,s,i)}canPickWorldPos(){return !0}drawPickDepths(e){this.model.drawPickDepths(e);}drawPickNormals(e){this.model.drawPickNormals(e);}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId);}}const mr=new class{constructor(){this._uint8Arrays={},this._float32Arrays={};}_clear(){this._uint8Arrays={},this._float32Arrays={};}getUInt8Array(e){let t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}getFloat32Array(e){let t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}};let gr=0;const _r=0,yr=1,vr=2,br=3,wr=4,Pr=5,Tr=6,xr=7,Mr=8,Dr=9,Ar=10,Cr=11,Ir=f.vec4(),Fr=f.vec3();class Br{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=this._scene,r=i.camera,o=t.model,n=i.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(r.viewMatrix,h):r.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const l=i._sectionPlanesState.sectionPlanes.length;if(l>0){const e=i._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,r=o.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const o=r.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,o?1:0),o){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Fr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++;}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=this._program,r=t._lightsState.lights,o=t.camera.project;i.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(this._withSAO){const i=t.sao;if(i.possible){const t=s.drawingBufferWidth,r=s.drawingBufferHeight;Ir[0]=t,Ir[1]=r,Ir[2]=i.blendCutoff,Ir[3]=i.blendFactor,s.uniform4fv(this._uSAOParams,Ir),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0);}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,s=e._lightsState,i=t.sectionPlanes.length>0;let r;const o=[];o.push("#version 300 es"),o.push("// Triangles batching draw vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec4 flags;"),o.push("in vec4 flags2;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("uniform vec4 lightAmbient;");for(let e=0,t=s.lights.length;e<t;e++)r=s.lights[e],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")));o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),i&&(o.push("out vec4 vWorldPosition;"),o.push("out vec4 vFlags2;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let e=0,t=s.lights.length;e<t;e++)if(r=s.lights[e],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else {if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);");}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),this._withSAO&&(i.push("uniform sampler2D uOcclusionTexture;"),i.push("uniform vec4      uSAOParams;"),i.push("const float       packUpscale = 256. / 255.;"),i.push("const float       unpackDownScale = 255. / 256.;"),i.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),i.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),i.push("float unpackRGBToFloat( const in vec4 v ) {"),i.push("    return dot( v, unPackFactors );"),i.push("}")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(i.push("   float viewportWidth     = uSAOParams[0];"),i.push("   float viewportHeight    = uSAOParams[1];"),i.push("   float blendCutoff       = uSAOParams[2];"),i.push("   float blendFactor       = uSAOParams[3];"),i.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),i.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),i.push("   outColor            = vec4(vColor.rgb * ambient, 1.0);")):i.push("   outColor            = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Er=f.vec4(),Sr=f.vec3();class Rr{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=this._scene,r=i.camera,o=t.model,n=i.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(r.viewMatrix,h):r.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const l=i._sectionPlanesState.sectionPlanes.length;if(l>0){const e=i._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,r=o.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t],o=r.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,o?1:0),o){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Sr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=this._program,r=t._lightsState.lights,o=t.camera.project;i.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(this._withSAO){const i=t.sao;if(i.possible){const t=s.drawingBufferWidth,r=s.drawingBufferHeight;Er[0]=t,Er[1]=r,Er[2]=i.blendCutoff,Er[3]=i.blendFactor,s.uniform4fv(this._uSAOParams,Er),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0);}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching flat-shading draw vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._lightsState,s=e._sectionPlanesState,i=s.sectionPlanes.length>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching flat-shading draw fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("in vec4 vWorldPosition;"),r.push("in vec4 vFlags2;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";");}r.push("uniform mat4 viewMatrix;"),r.push("uniform vec4 lightAmbient;");for(let e=0,s=t.lights.length;e<s;e++){const s=t.lights[e];"ambient"!==s.type&&(r.push("uniform vec4 lightColor"+e+";"),"dir"===s.type&&r.push("uniform vec3 lightDir"+e+";"),"point"===s.type&&r.push("uniform vec3 lightPos"+e+";"),"spot"===s.type&&(r.push("uniform vec3 lightPos"+e+";"),r.push("uniform vec3 lightDir"+e+";")));}if(r.push("in vec4 vViewPosition;"),r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}");}r.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),r.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),r.push("float lambertian = 1.0;"),r.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),r.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),r.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,s=t.lights.length;e<s;e++){const s=t.lights[e];if("ambient"!==s.type){if("dir"===s.type)"view"===s.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===s.type)"view"===s.space?r.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):r.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else {if("spot"!==s.type)continue;"view"===s.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");}r.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),r.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);");}}return r.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):r.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Or=new Float32Array([1,1,1]),Lr=f.vec3();class Nr{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Pr){const e=r.xrayMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===br){const e=r.highlightMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===wr){const e=r.selectedMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,Or);const l=h?W(o.viewMatrix,h):o.viewMatrix;n.uniformMatrix4fv(this._uViewMatrix,!1,l),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Lr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let s,i;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching silhouette fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("uniform bool sectionPlaneActive"+s+";"),o.push("uniform vec3 sectionPlanePos"+s+";"),o.push("uniform vec3 sectionPlaneDir"+s+";");if(o.push("uniform vec4 color;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("if (sectionPlaneActive"+s+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}");}return e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("outColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const kr=f.vec3(),jr=new Float32Array([0,0,0,1]);class Gr{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Ar){const e=r.xrayMaterial._state,t=e.edgeColor,s=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===Mr){const e=r.highlightMaterial._state,t=e.edgeColor,s=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===Dr){const e=r.selectedMaterial._state,t=e.edgeColor,s=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,jr);n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const l=r._sectionPlanesState.sectionPlanes.length;if(l>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,o=i.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,kr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.edgeIndicesBuf.bind(),n.drawElements(n.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=this._program,i=e.camera.project;if(s.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry edges drawing vertex shader"),s.push("uniform int renderPass;"),s.push("uniform vec4 color;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.z) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry edges drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Hr=f.vec3();class Vr{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const l=r._sectionPlanesState.sectionPlanes.length;if(l>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,o=i.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Hr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.edgeIndicesBuf.bind(),n.drawElements(n.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=this._program,i=e.camera.project;if(s.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry edges drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.z) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry edges drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Ur=f.vec3();class zr{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const l=e.pickViewMatrix||o.viewMatrix,u=h?W(l,h):l;if(n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,u),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Ur);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(a.pickColorsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible);}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry picking vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 pickColor;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry picking fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Wr=f.vec3();class Xr{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);const l=e.pickViewMatrix||o.viewMatrix,u=h?W(l,h):l;if(n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t);}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Wr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outColor = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Yr=f.vec3();class Kr{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const l=e.pickViewMatrix||o.viewMatrix,u=h?W(l,h):l;if(n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Yr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(a.normalsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching pick normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec3 vWorldNormal;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vec3 worldNormal =  octDecode(normal.xy); "),s.push("      vWorldNormal = worldNormal;"),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching pick normals fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");}if(i.push("in vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Jr=f.vec3();class Zr{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.canvas.gl,n=t._state,a=r.camera,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,s),o.uniformMatrix4fv(this._uViewMatrix,!1,h?W(a.viewMatrix,h):a.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const l=r._sectionPlanesState.sectionPlanes.length;if(l>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,n=i.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const r=n.sectionPlanesActivePerLayer[s+t];if(o.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Jr);o.uniform3fv(i.pos,e);}else o.uniform3fv(i.pos,s.pos);o.uniform3fv(i.dir,s.dir);}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),o.drawElements(o.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching occlusion fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("      if (sectionPlaneActive"+e+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Qr=f.vec3();class qr{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix);const l=r._sectionPlanesState.sectionPlanes.length;if(l>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,o=i.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Qr);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec2 vHighPrecisionZW;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching depth fragment shader"),i.push("precision highp float;"),i.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("const float   packUpScale = 256. / 255.;"),i.push("const float   unpackDownscale = 255. / 256.;"),i.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),i.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),i.push("const float   shiftRight8 = 1.0 / 256.;"),i.push("vec4 packDepthToRGBA( const in float v ) {"),i.push("    vec4 r = vec4( fract( v * packFactors ), v );"),i.push("    r.yzw -= r.xyz * shiftRight8;"),i.push("    return r * packUpScale;"),i.push("}"),i.push("in vec2 vHighPrecisionZW;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),i.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null,g.memory.programs--;}}const $r=f.vec3();class eo{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,i.worldNormalMatrix);const l=r._sectionPlanesState.sectionPlanes.length;if(l>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,o=i.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,$r);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2&&(this._aFlags2=s.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 worldNormalMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 viewNormalMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec3 vViewNormal;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),s.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(s.push("      vWorldPosition  = worldPosition;"),s.push("      vFlags2         = flags2;")),s.push("      vViewNormal = viewNormal;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const to=f.vec3();class so{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){const s=this._scene,i=s.canvas.gl,r=t._state;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),s.logarithmicDepthBufferEnabled&&i.uniform1f(this._uZFar,s.camera.project.far),this._aPosition.bindArrayBuffer(r.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(r.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(r.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(r.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(r.offsetsBuf),r.indicesBuf.bind();const o=s._sectionPlanesState.sectionPlanes.length;if(o>0){const e=s._sectionPlanesState.sectionPlanes,r=t.layerIndex*o,n=model.renderFlags,a=t._state.origin;for(let t=0;t<o;t++){const s=this._uSectionPlanes[t];if(s){const o=n.sectionPlanesActivePerLayer[r+t];if(i.uniform1i(s.active,o?1:0),o){const r=e[t];if(a){const e=K(r.dist,r.dir,a,to);i.uniform3fv(s.pos,e);}else i.uniform3fv(s.pos,r.pos);i.uniform3fv(s.dir,r.dir);}}}}i.drawElements(i.TRIANGLES,r.indicesBuf.numItems,r.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=i.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=i.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=i.getLocation("zFar")),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2");}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),t.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null;}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry shadow vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  bool visible        = (float(flags.x) > 0.0);"),s.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),s.push("  if (!visible || transparent) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("      vViewPosition = viewPosition;"),s.push("      gl_Position = shadowProjMatrix * viewPosition;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry shadow fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";");}if(s.push("in vec4 vViewPosition;"),s.push("vec4 encodeFloat( const in float v ) {"),s.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),s.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),s.push("  vec4 comp = fract(v * bitShift);"),s.push("  comp -= comp.xxyz * bitMask;"),s.push("  return comp;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),t){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var i=0;i<e.sectionPlanes.length;i++)s.push("      if (sectionPlaneActive"+i+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }");}return s.push("    outColor = encodeFloat( gl_FragCoord.z); "),s.push("}"),s}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const io=f.vec4(),ro=f.vec3();class oo{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=pe.MAX_TEXTURE_IMAGE_UNITS,r=this._scene,o=r.camera,n=t.model,a=r.canvas.gl,h=t._state,l=t._state.origin,u=h.textureSet,c=r._lightsState;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,n.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,n.worldNormalMatrix);const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,i=n.renderFlags;for(let t=0;t<p;t++){const r=this._uSectionPlanes[t];if(r){const o=i.sectionPlanesActivePerLayer[s+t];if(a.uniform1i(r.active,o?1:0),o){const s=e[t];if(l){const e=K(s.dist,s.dir,l,ro);a.uniform3fv(r.pos,e);}else a.uniform3fv(r.pos,s.pos);a.uniform3fv(r.dir,s.dir);}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(h.normalsBuf),this._aUV&&this._aUV.bindArrayBuffer(h.uvBuf),this._aColor&&this._aColor.bindArrayBuffer(h.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(h.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(h.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(h.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(h.offsetsBuf),c.reflectionMaps.length>0&&c.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,c.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),c.lightMaps.length>0&&c.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,c.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),this._withSAO){const t=r.sao;if(t.possible){const s=a.drawingBufferWidth,r=a.drawingBufferHeight;io[0]=s,io[1]=r,io[2]=t.blendCutoff,io[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,io),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++;}}this._program.bindTexture(this._uBaseColorMap,u.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uMetallicRoughMap,u.metallicRoughnessTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uEmissiveMap,u.emissiveTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uNormalMap,u.normalsTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uAOMap,u.occlusionTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,h.indicesBuf.bind(),a.drawElements(a.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++;}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=i.getLocation("uvDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uGammaFactor=i.getLocation("gammaFactor"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),s.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aUV=i.getAttribute("uv"),this._aColor=i.getAttribute("color"),this._aMetallicRoughness=i.getAttribute("metallicRoughness"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uBaseColorMap="uBaseColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=this._program,r=t._lightsState.lights,o=t.camera.project;i.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,t.gammaFactor);}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,s=e._lightsState,i=t.sectionPlanes.length>0,r=t.clippingCaps,o=[];return o.push("#version 300 es"),o.push("// Triangles batching quality draw vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("precision highp usampler2D;"),o.push("precision highp isampler2D;"),o.push("precision highp sampler2D;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("precision mediump usampler2D;"),o.push("precision mediump isampler2D;"),o.push("precision mediump sampler2D;"),o.push("#endif"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec2 uv;"),o.push("in vec2 metallicRoughness;"),o.push("in vec4 flags;"),o.push("in vec4 flags2;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),o.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("out vec4 vViewPosition;"),o.push("out vec3 vViewNormal;"),o.push("out vec4 vColor;"),o.push("out vec2 vUV;"),o.push("out vec2 vMetallicRoughness;"),s.lightMaps.length>0&&o.push("out vec3 vWorldNormal;"),i&&(o.push("out vec4 vWorldPosition;"),o.push("out vec4 vFlags2;"),r&&o.push("out vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),o.push("vFragDepth = 1.0 + clipPos.w;")),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),o.push("vMetallicRoughness = metallicRoughness;"),s.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,s=e._sectionPlanesState,i=e._lightsState,r=s.sectionPlanes.length>0,o=s.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Triangles batching quality draw fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uBaseColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),n.push("uniform sampler2D uAOMap;"),n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),i.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),n.push("uniform mat4 viewMatrix;"),i.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),i.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")));}if(this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;"),o&&n.push("in vec4 vClipPosition;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");}if(n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),n.push("              return surf_norm;"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3  diffuseColor;"),n.push("   float specularRoughness;"),n.push("   vec3  specularColor;"),n.push("   float shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),i.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(i.lightMaps.length>0||i.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),i.lightMaps.length>0&&(n.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),i.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}");}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 baseColorTexel = sRGBToLinear(texture(uBaseColorMap, vUV));"),n.push("baseColor *= baseColorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),i.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(i.lightMaps.length>0||i.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else {if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);");}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("float aoFactor = texture(uAOMap, vUV).r;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const no=f.vec3();class ao{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const l=e.pickViewMatrix||o.viewMatrix,u=h?W(l,h):l;if(n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,no);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching pick flat normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("out vec4 vWorldPosition;"),t&&s.push("out vec4 vFlags2;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vWorldPosition = worldPosition;"),t&&s.push("      vFlags2 = flags2;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching pick flat normals fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("in vec4 vWorldPosition;"),s){i.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("  outColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const ho=f.vec4(),lo=f.vec3();class uo{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=pe.MAX_TEXTURE_IMAGE_UNITS,r=this._scene,o=r.camera,n=t.model,a=r.canvas.gl,h=t._state,l=t._state.origin,u=h.textureSet;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,n.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,i=n.renderFlags;for(let t=0;t<c;t++){const r=this._uSectionPlanes[t];if(r){const o=i.sectionPlanesActivePerLayer[s+t];if(a.uniform1i(r.active,o?1:0),o){const s=e[t];if(l){const e=K(s.dist,s.dir,l,lo);a.uniform3fv(r.pos,e);}else a.uniform3fv(r.pos,s.pos);a.uniform3fv(r.dir,s.dir);}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(h.uvBuf),this._aColor&&this._aColor.bindArrayBuffer(h.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(h.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(h.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(h.offsetsBuf),u&&u.colorTexture&&(this._program.bindTexture(this._uColorMap,u.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i),this._withSAO){const t=r.sao;if(t.possible){const s=a.drawingBufferWidth,r=a.drawingBufferHeight;ho[0]=s,ho[1]=r,ho[2]=t.blendCutoff,ho[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,ho),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++;}}h.indicesBuf.bind(),a.drawElements(a.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++;}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=i.getLocation("uvDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aUV=i.getAttribute("uv"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uColorMap="uColorMap",this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=this._program,r=t._lightsState.lights,o=t.camera.project;i.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching color texture vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._lightsState,s=e._sectionPlanesState,i=s.sectionPlanes.length>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching color texture fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),r.push("uniform sampler2D uColorMap;"),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("in vec4 vWorldPosition;"),r.push("in vec4 vFlags2;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";");}r.push("uniform mat4 viewMatrix;"),r.push("uniform vec4 lightAmbient;");for(let e=0,s=t.lights.length;e<s;e++){const s=t.lights[e];"ambient"!==s.type&&(r.push("uniform vec4 lightColor"+e+";"),"dir"===s.type&&r.push("uniform vec3 lightDir"+e+";"),"point"===s.type&&r.push("uniform vec3 lightPos"+e+";"),"spot"===s.type&&(r.push("uniform vec3 lightPos"+e+";"),r.push("uniform vec3 lightDir"+e+";")));}if(r.push("in vec4 vViewPosition;"),r.push("in vec4 vColor;"),r.push("in vec2 vUV;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}");}r.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),r.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),r.push("float lambertian = 1.0;"),r.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),r.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),r.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,s=t.lights.length;e<s;e++){const s=t.lights[e];if("ambient"!==s.type){if("dir"===s.type)"view"===s.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===s.type)"view"===s.space?r.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):r.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else {if("spot"!==s.type)continue;"view"===s.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");}r.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),r.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);");}}return r.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),r.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),r.push("float opacity = color.a;"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):r.push("   outColor                = vec4(colorTexel.rgb, opacity);"),e.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}class co{constructor(e){this._scene=e;}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null);}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Br(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Br(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new Rr(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Rr(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new uo(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new uo(this._scene,!0)),this._colorTextureRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new oo(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new oo(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Nr(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new qr(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new eo(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Gr(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Vr(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new zr(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Kr(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new ao(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Xr(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Zr(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new so(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy();}}const po={};class fo{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[],this.edgeIndices=[];}}const mo=f.mat4(),go=f.mat4();function _o(e,t,s){const i=e.length,r=new Uint16Array(i),o=t[0],n=t[1],a=t[2],h=t[3]-o,l=t[4]-n,u=t[5]-a,c=65525,p=c/h,d=c/l,m=c/u,g=e=>e>=0?e:0;for(let t=0;t<i;t+=3)r[t+0]=Math.floor(g(e[t+0]-o)*p),r[t+1]=Math.floor(g(e[t+1]-n)*d),r[t+2]=Math.floor(g(e[t+2]-a)*m);return f.identityMat4(mo),f.translationMat4v(t,mo),f.identityMat4(go),f.scalingMat4v([h/c,l/c,u/c],go),f.mulMat4(mo,go,s),r}function yo(e,t,s){let i=e[0]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])),r=e[1]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]));if(e[2]<0){let e=i,t=r;e=(1-Math.abs(r))*(i>=0?1:-1),t=(1-Math.abs(i))*(r>=0?1:-1),i=e,r=t;}return new Int8Array([Math[t](127.5*i+(i<0?-1:0)),Math[s](127.5*r+(r<0?-1:0))])}function vo(e,t,s,i){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),o=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=(1-Math.abs(o))*(r>=0?1:-1),t=(1-Math.abs(r))*(o>=0?1:-1);r=e,o=t;}return new Int8Array([Math[s](127.5*r+(r<0?-1:0)),Math[i](127.5*o+(o<0?-1:0))])}function bo(e){let t=e[0],s=e[1];t/=t<0?127:128,s/=s<0?127:128;const i=1-Math.abs(t)-Math.abs(s);i<0&&(t=(1-Math.abs(s))*(t>=0?1:-1),s=(1-Math.abs(t))*(s>=0?1:-1));const r=Math.sqrt(t*t+s*s+i*i);return [t/r,s/r,i/r]}function wo(e,t,s){return e[t]*s[0]+e[t+1]*s[1]+e[t+2]*s[2]}const Po=f.mat4(),To=f.mat4(),xo=f.vec4([0,0,0,1]),Mo=f.vec4([0,0,0,1]),Do=f.vec4([0,0,0,1]),Ao=f.OBB3(),Co=f.vec3(),Io=f.vec3(),Fo=f.vec3(),Bo=f.vec3(),Eo=f.vec3(),So=f.vec3(),Ro=f.vec3();class Oo{constructor(e){this.model=e.model,this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals")+(e.textureSet&&e.textureSet.colorTexture?"-colorTexture":"")+(e.textureSet&&e.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=e.layerIndex,this._batchingRenderers=function(e){const t=e.id;let s=po[t];return s||(s=new co(e),po[t]=s,s._compile(),e.on("compile",(()=>{s._compile();})),e.on("destroyed",(()=>{delete po[t],s._destroy();}))),s}(e.model.scene),this._buffer=new fo(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Xe({origin:f.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:f.mat4(),uvDecodeMatrix:null,textureSet:e.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=f.collapseAABB3(),this._portions=[],this._numVerts=0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.uvDecodeMatrix?(this._state.uvDecodeMatrix=f.mat3(e.uvDecodeMatrix),this._preCompressedNormalsExpected=!0):this._preCompressedNormalsExpected=!1,e.origin&&this._state.origin.set(e.origin),this.aabb=f.collapseAABB3(),this.solid=!!e.solid;}canCreatePortion(e,t){if(this._finalized)throw "Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e){if(this._finalized)throw "Already finalized";const t=e.positions,s=e.positionsCompressed,i=e.normals,r=e.normalsCompressed,o=e.uv,n=e.uvCompressed,a=e.colors,h=e.colorsCompressed,l=e.indices,u=e.edgeIndices,c=e.color,p=e.metallic,d=e.roughness,m=e.opacity,g=e.meshMatrix,_=e.worldMatrix,y=e.worldAABB,v=e.pickColor,b=this.model.scene,w=this._buffer,P=w.positions.length/3;let T;if(this._preCompressedPositionsExpected){if(!s)throw "positionsCompressed expected";T=s.length/3;for(let e=0,t=s.length;e<t;e++)w.positions.push(s[e]);const e=Pt.getPositionsBounds(s),t=Pt.decompressPosition(e.min,this._state.positionsDecodeMatrix,[]),i=Pt.decompressPosition(e.max,this._state.positionsDecodeMatrix,[]);y[0]=t[0],y[1]=t[1],y[2]=t[2],y[3]=i[0],y[4]=i[1],y[5]=i[2],_&&(f.AABB3ToOBB3(y,Ao),f.transformOBB3(_,Ao),f.OBB3ToAABB3(Ao,y));}else {if(!t)throw "positions expected";T=t.length/3;const e=t.length,s=w.positions.length;for(let e=0,s=t.length;e<s;e++)w.positions.push(t[e]);if(g)for(let t=s,i=s+e;t<i;t+=3)xo[0]=w.positions[t+0],xo[1]=w.positions[t+1],xo[2]=w.positions[t+2],f.transformPoint4(g,xo,Mo),w.positions[t+0]=Mo[0],w.positions[t+1]=Mo[1],w.positions[t+2]=Mo[2],f.expandAABB3Point3(this._modelAABB,Mo),_?(f.transformPoint4(_,Mo,Do),f.expandAABB3Point3(y,Do)):f.expandAABB3Point3(y,Mo);else for(let t=s,i=s+e;t<i;t+=3)xo[0]=w.positions[t+0],xo[1]=w.positions[t+1],xo[2]=w.positions[t+2],f.expandAABB3Point3(this._modelAABB,xo),_?(f.transformPoint4(_,xo,Mo),f.expandAABB3Point3(y,Mo)):f.expandAABB3Point3(y,xo);}if(this._state.origin){const e=this._state.origin;y[0]+=e[0],y[1]+=e[1],y[2]+=e[2],y[3]+=e[0],y[4]+=e[1],y[5]+=e[2];}if(f.expandAABB3(this.aabb,y),r&&r.length>0)for(let e=0,t=r.length;e<t;e++)w.normals.push(r[e]);else if(i&&i.length>0){const e=Po;g?f.inverseMat4(f.transposeMat4(g,To),e):f.identityMat4(e,e),function(e,t,s,i,r){function o(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}let n,a,h,l,u,c,p=new Float32Array([0,0,0,0]),d=new Float32Array([0,0,0,0]);for(c=0;c<s;c+=3)p[0]=t[c],p[1]=t[c+1],p[2]=t[c+2],f.transformVec3(e,p,d),f.normalizeVec3(d,d),h=n=yo(d,"floor","floor"),a=bo(n),l=u=o(d,a),n=yo(d,"ceil","floor"),a=bo(n),l=o(d,a),l>u&&(h=n,u=l),n=yo(d,"floor","ceil"),a=bo(n),l=o(d,a),l>u&&(h=n,u=l),n=yo(d,"ceil","ceil"),a=bo(n),l=o(d,a),l>u&&(h=n,u=l),i[r+c+0]=h[0],i[r+c+1]=h[1],i[r+c+2]=0;}(e,i,i.length,w.normals,w.normals.length);}if(a)for(let e=0,t=a.length;e<t;e+=3)w.colors.push(255*a[e]),w.colors.push(255*a[e+1]),w.colors.push(255*a[e+2]),w.colors.push(255);else if(h)for(let e=0,t=a.length;e<t;e+=3)w.colors.push(a[e]),w.colors.push(a[e+1]),w.colors.push(a[e+2]),w.colors.push(255);else if(c){const e=c[0],t=c[1],s=c[2],i=m,r=null!=p?p:0,o=null!=d?d:255;for(let n=0;n<T;n++)w.colors.push(e),w.colors.push(t),w.colors.push(s),w.colors.push(i),w.metallicRoughness.push(r),w.metallicRoughness.push(o);}if(o&&o.length>0)for(let e=0,t=o.length;e<t;e++)w.uv.push(o[e]);else if(n&&n.length>0)for(let e=0,t=n.length;e<t;e++)w.uv.push(n[e]);if(l)for(let e=0,t=l.length;e<t;e++)w.indices.push(l[e]+P);if(u)for(let e=0,t=u.length;e<t;e++)w.edgeIndices.push(u[e]+P);{const e=w.pickColors.length;for(let t=e,s=e+4*T;t<s;t+=4)w.pickColors.push(v[0]),w.pickColors.push(v[1]),w.pickColors.push(v[2]),w.pickColors.push(v[3]);}if(b.entityOffsetsEnabled)for(let e=0;e<T;e++)w.offsets.push(0),w.offsets.push(0),w.offsets.push(0);const x=this._portions.length,M={vertsBase:P,numVerts:T};return b.pickSurfacePrecisionEnabled&&(l&&(M.indices=l),b.entityOffsetsEnabled&&(M.offset=new Float32Array(3))),this._portions.push(M),this._numPortions++,this.model.numPortions++,this._numVerts+=M.numVerts,x}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,s=this._buffer;if(s.positions.length>0){const i=this._preCompressedPositionsExpected?new Uint16Array(s.positions):_o(s.positions,this._modelAABB,e.positionsDecodeMatrix);if(e.positionsBuf=new Me(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(let e=0,t=this._portions.length;e<t;e++){const t=this._portions[e],s=3*t.vertsBase,r=s+3*t.numVerts;t.quantizedPositions=i.slice(s,r);}}if(s.normals.length>0){const i=new Int8Array(s.normals);let r=!0;e.normalsBuf=new Me(t,t.ARRAY_BUFFER,i,s.normals.length,3,t.STATIC_DRAW,r);}if(s.colors.length>0){const i=new Uint8Array(s.colors);let r=!1;e.colorsBuf=new Me(t,t.ARRAY_BUFFER,i,s.colors.length,4,t.DYNAMIC_DRAW,r);}if(s.uv.length>0)if(e.uvDecodeMatrix){let i=!1;e.uvBuf=new Me(t,t.ARRAY_BUFFER,s.uv,s.uv.length,2,t.STATIC_DRAW,i);}else {const i=Pt.getUVBounds(s.uv),r=Pt.compressUVs(s.uv,i.min,i.max),o=r.quantized;let n=!1;e.uvDecodeMatrix=f.mat3(r.decodeMatrix),e.uvBuf=new Me(t,t.ARRAY_BUFFER,o,o.length,2,t.STATIC_DRAW,n);}if(s.metallicRoughness.length>0){const i=new Uint8Array(s.metallicRoughness);let r=!1;e.metallicRoughnessBuf=new Me(t,t.ARRAY_BUFFER,i,s.metallicRoughness.length,2,t.STATIC_DRAW,r);}if(s.positions.length>0){const i=s.positions.length/3*4,r=new Uint8Array(i),o=new Uint8Array(i);let n=!1,a=!0;e.flagsBuf=new Me(t,t.ARRAY_BUFFER,r,r.length,4,t.DYNAMIC_DRAW,n),e.flags2Buf=new Me(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,a);}if(s.pickColors.length>0){const i=new Uint8Array(s.pickColors);let r=!1;e.pickColorsBuf=new Me(t,t.ARRAY_BUFFER,i,s.pickColors.length,4,t.STATIC_DRAW,r);}if(this.model.scene.entityOffsetsEnabled&&s.offsets.length>0){const i=new Float32Array(s.offsets);e.offsetsBuf=new Me(t,t.ARRAY_BUFFER,i,s.offsets.length,3,t.DYNAMIC_DRAW);}if(s.indices.length>0){const i=new Uint32Array(s.indices);e.indicesBuf=new Me(t,t.ELEMENT_ARRAY_BUFFER,i,s.indices.length,1,t.STATIC_DRAW);}if(s.edgeIndices.length>0){const i=new Uint32Array(s.edgeIndices);e.edgeIndicesBuf=new Me(t,t.ELEMENT_ARRAY_BUFFER,i,s.edgeIndices.length,1,t.STATIC_DRAW);}this._state.pbrSupported=!!(e.metallicRoughnessBuf&&e.uvBuf&&e.normalsBuf&&e.textureSet&&e.textureSet.colorTexture&&e.textureSet.metallicRoughnessTexture),this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0;}isEmpty(){return !this._state.indicesBuf}initFlags(e,t,s){t&E&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&j&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&O&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&G&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&R&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&S&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,s,true),this._setFlags2(e,t,true);}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2();}setVisible(e,t,s){if(!this._finalized)throw "Not finalized";t&E?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,s);}setHighlighted(e,t,s){if(!this._finalized)throw "Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,s);}setXRayed(e,t,s){if(!this._finalized)throw "Not finalized";t&N?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,s);}setSelected(e,t,s){if(!this._finalized)throw "Not finalized";t&j?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,s);}setEdges(e,t,s){if(!this._finalized)throw "Not finalized";t&G?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,s);}setClippable(e,t){if(!this._finalized)throw "Not finalized";t&O?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t);}setCulled(e,t,s){if(!this._finalized)throw "Not finalized";t&S?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,s);}setCollidable(e,t){if(!this._finalized)throw "Not finalized"}setPickable(e,t,s){if(!this._finalized)throw "Not finalized";t&R?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,s);}setColor(e,t){if(!this._finalized)throw "Not finalized";const s=e,i=this._portions[s],r=4*i.vertsBase,o=4*i.numVerts,n=this._scratchMemory.getUInt8Array(o),a=t[0],h=t[1],l=t[2],u=t[3];for(let e=0;e<o;e+=4)n[e+0]=a,n[e+1]=h,n[e+2]=l,n[e+3]=u;this._state.colorsBuf&&this._state.colorsBuf.setData(n,r,o);}setTransparent(e,t,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,s);}_setFlags(e,t,s,i=!1){if(!this._finalized)throw "Not finalized";const r=e,o=this._portions[r],n=4*o.vertsBase,a=4*o.numVerts,h=!!(t&E),l=!!(t&N),u=!!(t&k),c=!!(t&j),p=!!(t&G),d=!!(t&R),f=!!(t&S);let m,g;m=!h||f||l||u&&!this.model.scene.highlightMaterial.glowThrough||c&&!this.model.scene.selectedMaterial.glowThrough?_r:s?vr:yr,g=!h||f?_r:c?wr:u?br:l?Pr:_r;let _=0;_=!h||f?_r:c?Dr:u?Mr:l?Ar:p?s?xr:Tr:_r;let y=h&&!f&&d?Cr:_r;if(i){this._deferredFlagValues||(this._deferredFlagValues=new Uint8Array(4*this._numVerts));for(let e=n,t=n+a;e<t;e+=4)this._deferredFlagValues[e+0]=m,this._deferredFlagValues[e+1]=g,this._deferredFlagValues[e+2]=_,this._deferredFlagValues[e+3]=y;}else if(this._state.flagsBuf){const e=this._scratchMemory.getUInt8Array(a);for(let t=0;t<a;t+=4)e[t+0]=m,e[t+1]=g,e[t+2]=_,e[t+3]=y;this._state.flagsBuf.setData(e,n,a);}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null);}_setFlags2(e,t,s=!1){if(!this._finalized)throw "Not finalized";const i=e,r=this._portions[i],o=4*r.vertsBase,n=4*r.numVerts,a=t&O?255:0;if(s){this._setDeferredFlag2Values||(this._setDeferredFlag2Values=new Uint8Array(4*this._numVerts));for(let e=o,t=o+n;e<t;e+=4)this._setDeferredFlag2Values[e]=a;}else if(this._state.flags2Buf){const e=this._scratchMemory.getUInt8Array(n);for(let t=0;t<n;t+=4)e[t+0]=a;this._state.flags2Buf.setData(e,o,n);}}_setDeferredFlags2(){this._setDeferredFlag2Values&&(this._state.flags2Buf.setData(this._setDeferredFlag2Values),this._setDeferredFlag2Values=null);}setOffset(e,t){if(!this._finalized)throw "Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const s=e,i=this._portions[s],r=3*i.vertsBase,o=3*i.numVerts,n=this._scratchMemory.getFloat32Array(o),a=t[0],h=t[1],l=t[2];for(let e=0;e<o;e+=3)n[e+0]=a,n[e+1]=h,n[e+2]=l;this._state.offsetsBuf&&this._state.offsetsBuf.setData(n,r,o),this.model.scene.pickSurfacePrecisionEnabled&&(i.offset[0]=t[0],i.offset[1]=t[1],i.offset[2]=t[2]);}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._batchingRenderers.pbrRendererWithSAO&&this._batchingRenderers.pbrRendererWithSAO.drawLayer(t,this,yr):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._batchingRenderers.colorTextureRendererWithSAO&&this._batchingRenderers.colorTextureRendererWithSAO.drawLayer(t,this,yr):this._state.normalsBuf?this._batchingRenderers.colorRendererWithSAO&&this._batchingRenderers.colorRendererWithSAO.drawLayer(t,this,yr):this._batchingRenderers.flatColorRendererWithSAO&&this._batchingRenderers.flatColorRendererWithSAO.drawLayer(t,this,yr):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._batchingRenderers.pbrRenderer&&this._batchingRenderers.pbrRenderer.drawLayer(t,this,yr):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._batchingRenderers.colorTextureRenderer&&this._batchingRenderers.colorTextureRenderer.drawLayer(t,this,yr):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,yr):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(t,this,yr));}_updateBackfaceCull(e,t){const s=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==s){const e=t.gl;s?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),t.backfaces=s;}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._batchingRenderers.pbrRenderer&&this._batchingRenderers.pbrRenderer.drawLayer(t,this,vr):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._batchingRenderers.colorTextureRenderer&&this._batchingRenderers.colorTextureRenderer.drawLayer(t,this,vr):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,vr):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(t,this,vr));}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.depthRenderer&&this._batchingRenderers.depthRenderer.drawLayer(t,this,yr));}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.normalsRenderer&&this._batchingRenderers.normalsRenderer.drawLayer(t,this,yr));}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,Pr));}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,br));}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,wr));}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(t,this,Tr);}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(t,this,xr);}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,Mr);}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,Dr);}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,Ar);}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.occlusionRenderer&&this._batchingRenderers.occlusionRenderer.drawLayer(t,this,yr));}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.shadowRenderer&&this._batchingRenderers.shadowRenderer.drawLayer(t,this,yr));}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickMeshRenderer&&this._batchingRenderers.pickMeshRenderer.drawLayer(t,this,Cr));}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickDepthRenderer&&this._batchingRenderers.pickDepthRenderer.drawLayer(t,this,Cr));}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickNormalsFlatRenderer&&this._batchingRenderers.pickNormalsFlatRenderer.drawLayer(t,this,Cr));}precisionRayPickSurface(e,t,s,i,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return !1;const o=this._state,n=this._portions[e];if(!n)return this.model.error("portion not found: "+e),!1;const a=n.quantizedPositions,h=n.indices,l=o.origin,u=n.offset,c=Co,p=Io;c.set(l?f.subVec3(t,l,Fo):t),p.set(s),u&&f.subVec3(c,u),f.transformRay(this.model.worldNormalMatrix,c,p,c,p);const d=Bo,m=Eo,g=So;let _=!1,y=0;const v=Ro;for(let e=0,s=h.length;e<s;e+=3){const s=3*h[e],n=3*h[e+1],b=3*h[e+2];if(d[0]=a[s],d[1]=a[s+1],d[2]=a[s+2],m[0]=a[n],m[1]=a[n+1],m[2]=a[n+2],g[0]=a[b],g[1]=a[b+1],g[2]=a[b+2],f.decompressPosition(d,o.positionsDecodeMatrix),f.decompressPosition(m,o.positionsDecodeMatrix),f.decompressPosition(g,o.positionsDecodeMatrix),f.rayTriangleIntersect(c,p,d,m,g,v)){f.transformPoint3(this.model.worldMatrix,v,v),u&&f.addVec3(v,u),l&&f.addVec3(v,l);const e=Math.abs(f.lenVec3(f.subVec3(v,t,[])));(!_||e>y)&&(y=e,i.set(v),r&&f.triangleNormal(d,m,g,r),_=!0);}}return _&&r&&(f.transformVec3(this.model.worldNormalMatrix,r,r),f.normalizeVec3(r)),_}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy();}}const Lo=f.vec4(),No=f.vec3();class ko{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,i.worldNormalMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,No);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(a.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(a.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(a.modelNormalMatrixCol2Buf),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aNormal.bindArrayBuffer(h.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),e.drawElements++,n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=i.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=i.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=i.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=t._lightsState.lights,r=t.camera.project;this._program.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=i.length;e<t;e++){const t=i[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(this._withSAO){const i=t.sao;if(i.possible){const t=s.drawingBufferWidth,r=s.drawingBufferHeight;Lo[0]=t,Lo[1]=r,Lo[2]=i.blendCutoff,Lo[3]=i.blendFactor,s.uniform4fv(this._uSAOParams,Lo),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0);}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,s=e._lightsState,i=t.sectionPlanes.length>0;let r,o,n;const a=[];for(a.push("#version 300 es"),a.push("// Instancing geometry drawing vertex shader"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec2 normal;"),a.push("in vec4 color;"),a.push("in vec4 flags;"),a.push("in vec4 flags2;"),e.entityOffsetsEnabled&&a.push("in vec3 offset;"),a.push("in vec4 modelMatrixCol0;"),a.push("in vec4 modelMatrixCol1;"),a.push("in vec4 modelMatrixCol2;"),a.push("in vec4 modelNormalMatrixCol0;"),a.push("in vec4 modelNormalMatrixCol1;"),a.push("in vec4 modelNormalMatrixCol2;"),a.push("uniform mat4 worldMatrix;"),a.push("uniform mat4 worldNormalMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("uniform vec4 lightAmbient;"),r=0,o=s.lights.length;r<o;r++)n=s.lights[r],"ambient"!==n.type&&(a.push("uniform vec4 lightColor"+r+";"),"dir"===n.type&&a.push("uniform vec3 lightDir"+r+";"),"point"===n.type&&a.push("uniform vec3 lightPos"+r+";"),"spot"===n.type&&(a.push("uniform vec3 lightPos"+r+";"),a.push("uniform vec3 lightDir"+r+";")));for(a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),i&&(a.push("out vec4 vWorldPosition;"),a.push("out vec4 vFlags2;")),a.push("out vec4 vColor;"),a.push("void main(void) {"),a.push("if (int(flags.x) != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),a.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&a.push("      worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),a.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),a.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),r=0,o=s.lights.length;r<o;r++)if(n=s.lights[r],"ambient"!==n.type){if("dir"===n.type)"view"===n.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");else if("point"===n.type)"view"===n.space?a.push("viewLightDir = -normalize(lightPos"+r+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+r+", 0.0)).xyz);");else {if("spot"!==n.type)continue;"view"===n.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+r+".rgb * lightColor"+r+".a);");}return a.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags2 = flags2;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Instancing geometry drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),this._withSAO&&(i.push("uniform sampler2D uOcclusionTexture;"),i.push("uniform vec4      uSAOParams;"),i.push("const float       packUpscale = 256. / 255.;"),i.push("const float       unpackDownScale = 255. / 256.;"),i.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),i.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),i.push("float unpackRGBToFloat( const in vec4 v ) {"),i.push("    return dot( v, unPackFactors );"),i.push("}")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(i.push("   float viewportWidth     = uSAOParams[0];"),i.push("   float viewportHeight    = uSAOParams[1];"),i.push("   float blendCutoff       = uSAOParams[2];"),i.push("   float blendFactor       = uSAOParams[3];"),i.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),i.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),i.push("   outColor                = vec4(vColor.rgb * ambient, 1.0);")):i.push("    outColor           = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const jo=f.vec4(),Go=f.vec3();class Ho{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,Go);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=t._lightsState.lights,r=t.camera.project;this._program.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=i.length;e<t;e++){const t=i[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(this._withSAO){const i=t.sao;if(i.possible){const t=s.drawingBufferWidth,r=s.drawingBufferHeight;jo[0]=t,jo[1]=r,jo[2]=i.blendCutoff,jo[3]=i.blendFactor,s.uniform4fv(this._uSAOParams,jo),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0);}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry flat-shading drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=e._lightsState;let i,r;const o=t.sectionPlanes.length>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry flat-shading drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");}for(n.push("uniform mat4 viewMatrix;"),n.push("uniform vec4 lightAmbient;"),i=0,r=s.lights.length;i<r;i++){const e=s.lights[i];"ambient"!==e.type&&(n.push("uniform vec4 lightColor"+i+";"),"dir"===e.type&&n.push("uniform vec3 lightDir"+i+";"),"point"===e.type&&n.push("uniform vec3 lightPos"+i+";"),"spot"===e.type&&(n.push("uniform vec3 lightPos"+i+";"),n.push("uniform vec3 lightDir"+i+";")));}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }"),n.push("}");}for(n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),i=0,r=s.lights.length;i<r;i++){const e=s.lights[i];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?n.push("viewLightDir = normalize(lightDir"+i+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+i+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?n.push("viewLightDir = -normalize(lightPos"+i+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+i+", 0.0)).xyz);");else {if("spot"!==e.type)continue;"view"===e.space?n.push("viewLightDir = normalize(lightDir"+i+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+i+", 0.0)).xyz);");}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+i+".rgb * lightColor"+i+".a);");}}return n.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):n.push("    outColor           = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Vo=f.vec3();class Uo{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t.model.scene),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Pr){const e=r.xrayMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===br){const e=r.highlightMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===wr){const e=r.selectedMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,f.vec3([1,1,1]));n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,Vo);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing fill vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("uniform vec4 color;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Instancing fill fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = color;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const zo=f.vec3(),Wo=new Float32Array([0,0,0,1]);class Xo{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Ar){const e=r.xrayMaterial._state,t=e.edgeColor,s=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===Mr){const e=r.highlightMaterial._state,t=e.edgeColor,s=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===Dr){const e=r.selectedMaterial._state,t=e.edgeColor,s=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,Wo);n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,zo);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aFlags&&(this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.edgeIndicesBuf.bind(),n.drawElementsInstanced(n.LINES,h.edgeIndicesBuf.numItems,h.edgeIndicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles instancing edges vertex shader"),s.push("uniform int renderPass;"),s.push("uniform vec4 color;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.z) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry edges drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Yo=f.vec3();class Ko{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,Yo);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.edgeIndicesBuf.bind(),n.drawElementsInstanced(n.LINES,h.edgeIndicesBuf.numItems,h.edgeIndicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles instancing edges vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.z) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry edges drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Jo=f.vec3();class Zo{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s);const u=e.pickViewMatrix||o.viewMatrix,c=l?W(u,l):u;if(n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(a.pickColorsBuf),n.vertexAttribDivisor(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind();const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,o=i.renderFlags;for(let t=0;t<p;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,Jo);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aPickColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._uRenderPass=i.getLocation("renderPass"),this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible);}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry picking vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 pickColor;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry picking fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Qo=f.vec3();class qo{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.canvas.gl,n=t._state,a=n.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const l=r.camera;o.uniform1i(this._uRenderPass,s),o.uniform1i(this._uPickInvisible,e.pickInvisible);const u=e.pickViewMatrix||l.viewMatrix,c=h?W(u,h):u;if(o.uniformMatrix4fv(this._uViewMatrix,!1,c),o.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),o.uniform1f(this._uPickZNear,e.pickZNear),o.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t);}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,n=i.renderFlags;for(let t=0;t<p;t++){const i=this._uSectionPlanes[t];if(i){const r=n.sectionPlanesActivePerLayer[s+t];if(o.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Qo);o.uniform3fv(i.pos,e);}else o.uniform3fv(i.pos,s.pos);o.uniform3fv(i.dir,s.dir);}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),o.vertexAttribDivisor(this._aModelMatrixCol0.location,1),o.vertexAttribDivisor(this._aModelMatrixCol1.location,1),o.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),o.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),o.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),o.vertexAttribDivisor(this._aOffset.location,1)),a.indicesBuf.bind(),o.drawElementsInstanced(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,n.numInstances),o.vertexAttribDivisor(this._aModelMatrixCol0.location,0),o.vertexAttribDivisor(this._aModelMatrixCol1.location,0),o.vertexAttribDivisor(this._aModelMatrixCol2.location,0),o.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&o.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outColor = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const $o=f.vec3();class en{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);const u=e.pickViewMatrix||o.viewMatrix,c=l?W(u,l):u;if(n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,i.worldNormalMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,o=i.renderFlags;for(let t=0;t<p;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,$o);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(a.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(a.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(a.modelNormalMatrixCol2Buf),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aNormal.bindArrayBuffer(h.normalsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=i.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=i.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=i.getAttribute("modelNormalMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec2 normal;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("in vec4 modelNormalMatrixCol0;"),s.push("in vec4 modelNormalMatrixCol1;"),s.push("in vec4 modelNormalMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec3 vWorldNormal;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),s.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),s.push("  vWorldNormal = worldNormal;"),t&&s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("if (sectionPlaneActive"+r+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const tn=f.vec3();class sn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,tn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1)),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aColor&&n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("in float isPerspective;")),t&&(s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Instancing occlusion fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("out float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),s){i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const rn=f.vec3();class on{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,rn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry depth drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec2 vHighPrecisionZW;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let s,i;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Instancing geometry depth drawing fragment shader"),o.push("precision highp float;"),o.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("uniform bool sectionPlaneActive"+s+";"),o.push("uniform vec3 sectionPlanePos"+s+";"),o.push("uniform vec3 sectionPlaneDir"+s+";");if(o.push("in vec2 vHighPrecisionZW;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("if (sectionPlaneActive"+s+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}");}return e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),o.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),o.push("}"),o}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const nn=f.vec3();class an{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,l?W(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,i.worldNormalMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,nn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aNormal.bindArrayBuffer(h.normalsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 worldNormalMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 viewNormalMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec3 vViewNormal;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("  vViewNormal = viewNormal;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Instancing geometry depth drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const hn=f.vec3();class ln{constructor(e){this._scene=e,this._hash=this._getHash(),this._lastLightId=null,this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){const s=t.model,i=s.scene,r=i.canvas.gl,o=t._state,n=o.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),r.vertexAttribDivisor(this._aModelMatrixCol0.location,1),r.vertexAttribDivisor(this._aModelMatrixCol1.location,1),r.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),r.vertexAttribDivisor(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),r.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),r.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),r.vertexAttribDivisor(this._aFlags2.location,1));const a=i._sectionPlanesState.sectionPlanes.length;if(a>0){const e=i._sectionPlanesState.sectionPlanes,o=t.layerIndex*a,n=s.renderFlags,h=t._state.origin;for(let t=0;t<a;t++){const s=this._uSectionPlanes[t];if(s){const i=n.sectionPlanesActivePerLayer[o+t];if(r.uniform1i(s.active,i?1:0),i){const i=e[t];if(h){const e=K(i.dist,i.dir,h,hn);r.uniform3fv(s.pos,e);}else r.uniform3fv(s.pos,i.pos);r.uniform3fv(s.dir,i.dir);}}}}n.indicesBuf.bind(),r.drawElementsInstanced(r.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,o.numInstances),r.vertexAttribDivisor(this._aModelMatrixCol0.location,0),r.vertexAttribDivisor(this._aModelMatrixCol1.location,0),r.vertexAttribDivisor(this._aModelMatrixCol2.location,0),r.vertexAttribDivisor(this._aColor.location,0),r.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&r.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&r.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=i.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=i.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2");}_bindProgram(e,t){const s=this._scene.canvas.gl;this._program.bind(),s.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),s.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null;}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry shadow drawing vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("bool visible      = (float(flags.x) > 0.0);"),s.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),s.push("if (!visible || transparent) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("  gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Instancing geometry depth drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const un=f.vec4(),cn=f.vec3(),pn={3e3:"linearToLinear",3001:"sRGBToLinear"};class dn{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=pe.MAX_TEXTURE_IMAGE_UNITS,r=t.model,o=this._scene,n=o.camera,a=o.canvas.gl,h=t._state,l=h.origin,u=h.textureSet,c=h.geometry,p=o._lightsState;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uViewMatrix,!1,l?W(n.viewMatrix,l):n.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);const d=o._sectionPlanesState.sectionPlanes.length;if(d>0){const e=o._sectionPlanesState.sectionPlanes,s=t.layerIndex*d,i=r.renderFlags;for(let t=0;t<d;t++){const r=this._uSectionPlanes[t];if(r){const o=i.sectionPlanesActivePerLayer[s+t];if(a.uniform1i(r.active,o?1:0),o){const s=e[t];if(l){const e=K(s.dist,s.dir,l,cn);a.uniform3fv(r.pos,e);}else a.uniform3fv(r.pos,s.pos);a.uniform3fv(r.dir,s.dir);}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,c.uvDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(h.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(h.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(h.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(h.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(h.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(h.modelNormalMatrixCol2Buf),a.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(c.positionsBuf),this._aNormal.bindArrayBuffer(c.normalsBuf),this._aUV&&this._aUV.bindArrayBuffer(c.uvBuf),this._aColor.bindArrayBuffer(h.colorsBuf),a.vertexAttribDivisor(this._aColor.location,1),this._aMetallicRoughness.bindArrayBuffer(h.metallicRoughnessBuf),a.vertexAttribDivisor(this._aMetallicRoughness.location,1),this._aFlags.bindArrayBuffer(h.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(h.flags2Buf),a.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(h.offsetsBuf),a.vertexAttribDivisor(this._aOffset.location,1)),p.reflectionMaps.length>0&&p.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,p.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),p.lightMaps.length>0&&p.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,p.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++),this._withSAO){const t=o.sao;if(t.possible){const s=a.drawingBufferWidth,r=a.drawingBufferHeight;un[0]=s,un[1]=r,un[2]=t.blendCutoff,un[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,un),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++;}}u&&(this._program.bindTexture(this._uBaseColorMap,u.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uMetallicRoughMap,u.metallicRoughnessTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uEmissiveMap,u.emissiveTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._program.bindTexture(this._uNormalMap,u.normalsTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i),c.indicesBuf.bind(),a.drawElementsInstanced(a.TRIANGLES,c.indicesBuf.numItems,c.indicesBuf.itemType,0,h.numInstances),e.drawElements++,a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,0),a.vertexAttribDivisor(this._aColor.location,0),a.vertexAttribDivisor(this._aMetallicRoughness.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=i.getLocation("uvDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uGammaFactor=i.getLocation("gammaFactor"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(var n=0,a=r.length;n<a;n++)switch(o=r[n],o.type){case"dir":this._uLightColor[n]=i.getLocation("lightColor"+n),this._uLightPos[n]=null,this._uLightDir[n]=i.getLocation("lightDir"+n);break;case"point":this._uLightColor[n]=i.getLocation("lightColor"+n),this._uLightPos[n]=i.getLocation("lightPos"+n),this._uLightDir[n]=null,this._uLightAttenuation[n]=i.getLocation("lightAttenuation"+n);break;case"spot":this._uLightColor[n]=i.getLocation("lightColor"+n),this._uLightPos[n]=i.getLocation("lightPos"+n),this._uLightDir[n]=i.getLocation("lightDir"+n),this._uLightAttenuation[n]=i.getLocation("lightAttenuation"+n);}s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),s.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aNormal=i.getAttribute("normal"),this._aUV=i.getAttribute("uv"),this._aColor=i.getAttribute("color"),this._aMetallicRoughness=i.getAttribute("metallicRoughness"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._uBaseColorMap="uBaseColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=i.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=i.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=i.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=t._lightsState.lights,r=t.camera.project;this._program.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=i.length;e<t;e++){const t=i[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,t.gammaFactor);}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,s=e._lightsState,i=t.sectionPlanes.length>0,r=t.clippingCaps,o=[];return o.push("#version 300 es"),o.push("// Instancing geometry quality drawing vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec2 uv;"),o.push("in vec2 metallicRoughness;"),o.push("in vec4 flags;"),o.push("in vec4 flags2;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("in vec4 modelNormalMatrixCol0;"),o.push("in vec4 modelNormalMatrixCol1;"),o.push("in vec4 modelNormalMatrixCol2;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),o.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("out vec4 vViewPosition;"),o.push("out vec3 vViewNormal;"),o.push("out vec4 vColor;"),o.push("out vec2 vUV;"),o.push("out vec2 vMetallicRoughness;"),s.lightMaps.length>0&&o.push("out vec3 vWorldNormal;"),i&&(o.push("out vec4 vWorldPosition;"),o.push("out vec4 vFlags2;"),r&&o.push("out vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),o.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),o.push("vMetallicRoughness = metallicRoughness;"),s.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,s=e._sectionPlanesState,i=e._lightsState,r=s.sectionPlanes.length>0,o=s.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Instancing geometry quality drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uBaseColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),i.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),i.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")));}if(n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;"),o&&n.push("in vec4 vClipPosition;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");}if(n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),i.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),n.push("uniform mat4 viewMatrix;"),n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),n.push("              return normalize(surf_norm );"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3    diffuseColor;"),n.push("   float   specularRoughness;"),n.push("   vec3    specularColor;"),n.push("   float   shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),i.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = "+pn[i.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(i.lightMaps.length>0||i.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),i.lightMaps.length>0&&(n.push("   vec3 irradiance = "+pn[i.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),i.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}");}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 baseColorTexel = sRGBToLinear(texture(uBaseColorMap, vUV));"),n.push("baseColor *= baseColorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),i.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(i.lightMaps.length>0||i.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction = normalize(lightDir"+e+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction = normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction = normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else {if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction = normalize(lightDir"+e+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);");}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const fn=f.vec3();class mn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=a.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);const u=e.pickViewMatrix||o.viewMatrix,c=l?W(u,l):u;if(n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,o=i.renderFlags;for(let t=0;t<p;t++){const i=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(l){const e=K(s.dist,s.dir,l,fn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&s.push("out vec4 vFlags2;"),s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("in vec4 vWorldPosition;"),s){i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("if (sectionPlaneActive"+r+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push("  outColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const gn=f.vec4(),_n=f.vec3();class yn{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return [e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,s){const i=pe.MAX_TEXTURE_IMAGE_UNITS,r=t.model,o=r.scene,n=o.camera,a=o.canvas.gl,h=t._state,l=h.geometry,u=t._state.origin,c=h.textureSet;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,s),a.uniformMatrix4fv(this._uViewMatrix,!1,u?W(n.viewMatrix,u):n.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);const p=o._sectionPlanesState.sectionPlanes.length;if(p>0){const e=o._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,i=r.renderFlags;for(let t=0;t<p;t++){const r=this._uSectionPlanes[t];if(r){const o=i.sectionPlanesActivePerLayer[s+t];if(a.uniform1i(r.active,o?1:0),o){const s=e[t];if(u){const e=K(s.dist,s.dir,u,_n);a.uniform3fv(r.pos,e);}else a.uniform3fv(r.pos,s.pos);a.uniform3fv(r.dir,s.dir);}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(h.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(h.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(h.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aUV.bindArrayBuffer(l.uvBuf),this._aColor.bindArrayBuffer(h.colorsBuf),a.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(h.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(h.flags2Buf),a.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(h.offsetsBuf),a.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),a.drawElementsInstanced(a.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,h.numInstances),e.drawElements++,a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aColor.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0),c&&c.colorTexture&&(this._program.bindTexture(this._uColorMap,c.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i),this._withSAO){const t=o.sao;if(t.possible){const s=a.drawingBufferWidth,i=a.drawingBufferHeight;gn[0]=s,gn[1]=i,gn[2]=t.blendCutoff,gn[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,gn),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0);}}}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._lightsState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=i.getLocation("uvDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uLightAmbient=i.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=s.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=i.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=i.getLocation("lightColor"+e),this._uLightPos[e]=i.getLocation("lightPos"+e),this._uLightDir[e]=i.getLocation("lightDir"+e),this._uLightAttenuation[e]=i.getLocation("lightAttenuation"+e);}this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aUV=i.getAttribute("uv"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uColorMap="uColorMap",this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=t._lightsState.lights,r=t.camera.project;this._program.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=i.length;e<t;e++){const t=i[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir);}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=e._lightsState;let i,r;const o=t.sectionPlanes.length>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");}for(n.push("uniform mat4 viewMatrix;"),n.push("uniform vec4 lightAmbient;"),i=0,r=s.lights.length;i<r;i++){const e=s.lights[i];"ambient"!==e.type&&(n.push("uniform vec4 lightColor"+i+";"),"dir"===e.type&&n.push("uniform vec3 lightDir"+i+";"),"point"===e.type&&n.push("uniform vec3 lightPos"+i+";"),"spot"===e.type&&(n.push("uniform vec3 lightPos"+i+";"),n.push("uniform vec3 lightDir"+i+";")));}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }"),n.push("}");}for(n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),i=0,r=s.lights.length;i<r;i++){const e=s.lights[i];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?n.push("viewLightDir = normalize(lightDir"+i+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+i+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?n.push("viewLightDir = -normalize(lightPos"+i+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+i+", 0.0)).xyz);");else {if("spot"!==e.type)continue;"view"===e.space?n.push("viewLightDir = normalize(lightDir"+i+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+i+", 0.0)).xyz);");}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+i+".rgb * lightColor"+i+".a);");}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),n.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(vColor.rgb * colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(vColor.rgb * colorTexel.rgb, opacity);"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}class vn{constructor(e){this._scene=e;}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null);}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new ko(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new ko(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new Ho(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Ho(this._scene,!0)),this._flatColorRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new dn(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new dn(this._scene,!0)),this._pbrRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new yn(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new yn(this._scene,!0)),this._colorTextureRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Uo(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new on(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new an(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Xo(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Ko(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Zo(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new en(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new mn(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new qo(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new sn(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new ln(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy();}}const bn={};const wn=new Uint8Array(4),Pn=f.vec4([0,0,0,1]),Tn=f.vec4([0,0,0,1]),xn=f.vec4([0,0,0,1]),Mn=new Float32Array(3),Dn=f.vec3(),An=f.vec3(),Cn=f.vec3(),In=f.vec3(),Fn=f.vec3(),Bn=f.vec3(),En=f.vec3();class Sn{constructor(e){this.model=e.model,this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._instancingRenderers=function(e){const t=e.id;let s=bn[t];return s||(s=new vn(e),bn[t]=s,s._compile(),e.on("compile",(()=>{s._compile();})),e.on("destroyed",(()=>{delete bn[t],s._destroy();}))),s}(e.model.scene),this._aabb=f.collapseAABB3();const t={numInstances:0,obb:f.OBB3(),origin:f.vec3(),geometry:e.geometry,textureSet:e.textureSet,pbrSupported:!1};this._state=new Xe(t),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],e.origin&&this._state.origin.set(e.origin),this._finalized=!1,this.aabb=f.collapseAABB3(),this.solid=!!e.solid;}createPortion(e){const t=e.color,s=e.metallic,i=e.roughness,r=e.opacity,o=e.meshMatrix,n=e.worldMatrix,a=e.aabb,h=e.pickColor;if(this._finalized)throw "Already finalized";const l=t[0],u=t[1],c=t[2];if(t[3],this._colors.push(l),this._colors.push(u),this._colors.push(c),this._colors.push(r),this._metallicRoughness.push(null!=s?s:0),this._metallicRoughness.push(null!=i?i:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.geometry.normalsBuf){let e=f.transposeMat4(o,f.mat4()),t=f.inverseMat4(e);this._modelNormalMatrixCol0.push(t[0]),this._modelNormalMatrixCol0.push(t[4]),this._modelNormalMatrixCol0.push(t[8]),this._modelNormalMatrixCol0.push(t[12]),this._modelNormalMatrixCol1.push(t[1]),this._modelNormalMatrixCol1.push(t[5]),this._modelNormalMatrixCol1.push(t[9]),this._modelNormalMatrixCol1.push(t[13]),this._modelNormalMatrixCol2.push(t[2]),this._modelNormalMatrixCol2.push(t[6]),this._modelNormalMatrixCol2.push(t[10]),this._modelNormalMatrixCol2.push(t[14]);}this._pickColors.push(h[0]),this._pickColors.push(h[1]),this._pickColors.push(h[2]),this._pickColors.push(h[3]),f.collapseAABB3(a);const p=this._state.geometry.obb,d=p.length;for(let e=0;e<d;e+=4)Pn[0]=p[e+0],Pn[1]=p[e+1],Pn[2]=p[e+2],f.transformPoint4(o,Pn,Tn),n?(f.transformPoint4(n,Tn,xn),f.expandAABB3Point3(a,xn)):f.expandAABB3Point3(a,Tn);if(this._state.origin){const e=this._state.origin;a[0]+=e[0],a[1]+=e[1],a[2]+=e[2],a[3]+=e[0],a[4]+=e[1],a[5]+=e[2];}f.expandAABB3(this.aabb,a),this._state.numInstances++;const m=this._portions.length,g={};return this.model.scene.pickSurfacePrecisionEnabled&&(g.matrix=o.slice(),g.inverseMatrix=null,g.normalMatrix=null),this._portions.push(g),this._numPortions++,this.model.numPortions++,m}finalize(){if(this._finalized)throw "Already finalized";const e=this._state,t=e.geometry,s=e.textureSet,i=this.model.scene.canvas.gl,r=this._colors.length,o=r;if(r>0){let e=!1;this._state.colorsBuf=new Me(i,i.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,i.DYNAMIC_DRAW,e),this._colors=[];}if(this._metallicRoughness.length>0){const e=new Uint8Array(this._metallicRoughness);let t=!1;this._state.metallicRoughnessBuf=new Me(i,i.ARRAY_BUFFER,e,this._metallicRoughness.length,2,i.STATIC_DRAW,t);}if(o>0){let e=!1,t=!0;this._state.flagsBuf=new Me(i,i.ARRAY_BUFFER,new Uint8Array(o),o,4,i.DYNAMIC_DRAW,e),this._state.flags2Buf=new Me(i,i.ARRAY_BUFFER,new Uint8Array(o),o,4,i.DYNAMIC_DRAW,t);}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,i.DYNAMIC_DRAW,e),this._offsets=[];}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,i.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,i.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,i.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.geometry.normalsBuf&&(this._state.modelNormalMatrixCol0Buf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,i.STATIC_DRAW,e),this._state.modelNormalMatrixCol1Buf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,i.STATIC_DRAW,e),this._state.modelNormalMatrixCol2Buf=new Me(i,i.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,i.STATIC_DRAW,e),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[]);}if(this._pickColors.length>0){const e=!1;this._state.pickColorsBuf=new Me(i,i.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,i.STATIC_DRAW,e),this._pickColors=[];}this._state.pbrSupported=!!(e.metallicRoughnessBuf&&t.uvBuf&&t.normalsBuf&&s&&s.colorTexture&&s.metallicRoughnessTexture),this._state.colorTextureSupported=!!t.uvBuf&&!!s&&!!s.colorTexture,this._finalized=!0;}initFlags(e,t,s){t&E&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&j&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&O&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&G&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&R&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&S&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,s),this._setFlags2(e,t);}setVisible(e,t,s){if(!this._finalized)throw "Not finalized";t&E?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,s);}setHighlighted(e,t,s){if(!this._finalized)throw "Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,s);}setXRayed(e,t,s){if(!this._finalized)throw "Not finalized";t&N?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,s);}setSelected(e,t,s){if(!this._finalized)throw "Not finalized";t&j?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,s);}setEdges(e,t,s){if(!this._finalized)throw "Not finalized";t&G?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,s);}setClippable(e,t){if(!this._finalized)throw "Not finalized";t&O?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t);}setCollidable(e,t){if(!this._finalized)throw "Not finalized"}setPickable(e,t,s){if(!this._finalized)throw "Not finalized";t&R?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,s);}setCulled(e,t,s){if(!this._finalized)throw "Not finalized";t&S?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,s);}setColor(e,t){if(!this._finalized)throw "Not finalized";wn[0]=t[0],wn[1]=t[1],wn[2]=t[2],wn[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(wn,4*e,4);}setTransparent(e,t,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,s);}_setFlags(e,t,s){if(!this._finalized)throw "Not finalized";const i=!!(t&E),r=!!(t&N),o=!!(t&k),n=!!(t&j),a=!!(t&G),h=!!(t&R),l=!!(t&S);let u,c;u=!i||l||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?_r:s?vr:yr,c=!i||l?_r:n?wr:o?br:r?Pr:_r;let p=0;p=!i||l?_r:n?Dr:o?Mr:r?Ar:a?s?xr:Tr:_r;let d=i&&!l&&h?Cr:_r;wn[0]=u,wn[1]=c,wn[2]=p,wn[3]=d,this._state.flagsBuf&&this._state.flagsBuf.setData(wn,4*e,4);}_setFlags2(e,t){if(!this._finalized)throw "Not finalized";const s=t&O?255:0;wn[0]=s,this._state.flags2Buf&&this._state.flags2Buf.setData(wn,4*e,4);}setOffset(e,t){if(!this._finalized)throw "Not finalized";this.model.scene.entityOffsetsEnabled?(Mn[0]=t[0],Mn[1]=t[1],Mn[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(Mn,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer");}drawColorOpaque(e,t){if(this._numCulledLayerPortions===this._numPortions||0===this._numVisibleLayerPortions||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions)return;this._updateBackfaceCull(e,t);const s=this._state.geometry;t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._instancingRenderers.pbrRendererWithSAO&&this._instancingRenderers.pbrRendererWithSAO.drawLayer(t,this,yr):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._instancingRenderers.colorTextureRendererWithSAO&&this._instancingRenderers.colorTextureRendererWithSAO.drawLayer(t,this,yr):s.normalsBuf?this._instancingRenderers.colorRendererWithSAO&&this._instancingRenderers.colorRendererWithSAO.drawLayer(t,this,yr):this._instancingRenderers.flatColorRendererWithSAO&&this._instancingRenderers.flatColorRendererWithSAO.drawLayer(t,this,yr):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._instancingRenderers.pbrRenderer&&this._instancingRenderers.pbrRenderer.drawLayer(t,this,yr):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._instancingRenderers.colorTextureRenderer&&this._instancingRenderers.colorTextureRenderer.drawLayer(t,this,yr):s.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(t,this,yr):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(t,this,yr);}_updateBackfaceCull(e,t){const s=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==s){const e=t.gl;s?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),t.backfaces=s;}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._instancingRenderers.pbrRenderer&&this._instancingRenderers.pbrRenderer.drawLayer(t,this,vr):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._instancingRenderers.colorTextureRenderer&&this._instancingRenderers.colorTextureRenderer.drawLayer(t,this,vr):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(t,this,vr):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(t,this,vr));}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.depthRenderer&&this._instancingRenderers.depthRenderer.drawLayer(t,this,yr));}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.normalsRenderer&&this._instancingRenderers.normalsRenderer.drawLayer(t,this,yr));}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,Pr));}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,br));}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,wr));}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(t,this,Tr);}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(t,this,xr);}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,Ar);}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,Mr);}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,Dr);}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.occlusionRenderer&&this._instancingRenderers.occlusionRenderer.drawLayer(t,this,yr));}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.shadowRenderer&&this._instancingRenderers.shadowRenderer.drawLayer(t,this,yr));}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickMeshRenderer&&this._instancingRenderers.pickMeshRenderer.drawLayer(t,this,Cr));}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickDepthRenderer&&this._instancingRenderers.pickDepthRenderer.drawLayer(t,this,Cr));}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickNormalsRenderer&&this._instancingRenderers.pickNormalsRenderer.drawLayer(t,this,Cr));}precisionRayPickSurface(e,t,s,i,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return !1;const o=this._state.geometry,n=this._state,a=this._portions[e];if(!a)return this.model.error("portion not found: "+e),!1;a.inverseMatrix||(a.inverseMatrix=f.inverseMat4(a.matrix,f.mat4())),r&&!a.normalMatrix&&(a.normalMatrix=f.transposeMat4(a.inverseMatrix,f.mat4()));const h=o.quantizedPositions,l=o.indices,u=n.origin,c=a.offset,p=Dn,d=An;p.set(u?f.subVec3(t,u,Cn):t),d.set(s),c&&f.subVec3(p,c),f.transformRay(this.model.worldNormalMatrix,p,d,p,d),f.transformRay(a.inverseMatrix,p,d,p,d);const m=In,g=Fn,_=Bn;let y=!1,v=0;const b=En;for(let e=0,s=l.length;e<s;e+=3){const s=3*l[e+0],o=3*l[e+1],w=3*l[e+2];if(m[0]=h[s],m[1]=h[s+1],m[2]=h[s+2],g[0]=h[o],g[1]=h[o+1],g[2]=h[o+2],_[0]=h[w],_[1]=h[w+1],_[2]=h[w+2],f.decompressPosition(m,n.positionsDecodeMatrix),f.decompressPosition(g,n.positionsDecodeMatrix),f.decompressPosition(_,n.positionsDecodeMatrix),f.rayTriangleIntersect(p,d,m,g,_,b)){f.transformPoint3(a.matrix,b,b),f.transformPoint3(this.model.worldMatrix,b,b),c&&f.addVec3(b,c),u&&f.addVec3(b,u);const e=Math.abs(f.lenVec3(f.subVec3(b,t,[])));(!y||e>v)&&(v=e,i.set(b),r&&f.triangleNormal(m,g,_,r),y=!0);}}return y&&r&&(f.transformVec3(a.normalMatrix,r,r),f.transformVec3(this.model.worldNormalMatrix,r,r),f.normalizeVec3(r)),y}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy();}}const Rn=f.vec3();class On{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=this._scene,r=i.camera,o=t.model,n=i.canvas.gl,a=t._state,h=t._state.origin;if(t.geometry,!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(r.viewMatrix,h):r.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),n.lineWidth(i.linesMaterial.lineWidth);const l=i._sectionPlanesState.sectionPlanes.length;if(l>0){const e=i._sectionPlanesState.sectionPlanes,s=t.layerIndex*l,r=o.renderFlags;for(let t=0;t<l;t++){const i=this._uSectionPlanes[t];if(i){const o=r.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,o?1:0),o){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Rn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++;}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene,s=t.canvas.gl,i=this._program,r=t.camera.project;if(i.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Lines batching color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Lines batching color fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return i.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Ln=new Float32Array([1,1,1]),Nn=f.vec3();class kn{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin;if(t.geometry,!this._program&&(this._allocate(),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Pr){const e=r.xrayMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===br){const e=r.highlightMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===wr){const e=r.selectedMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,Ln);const l=h?W(o.viewMatrix,h):o.viewMatrix;n.uniformMatrix4fv(this._uViewMatrix,!1,l),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.lineWidth(r.linesMaterial.lineWidth);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Nn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Lines batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Lines batching silhouette fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = color;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}class jn{constructor(e){this._scene=e;}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null);}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new On(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new kn(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy();}}const Gn={};class Hn{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[];}}const Vn=f.vec4([0,0,0,1]),Un=f.vec4([0,0,0,1]),zn=f.vec4([0,0,0,1]),Wn=f.OBB3();class Xn{constructor(e){this.layerIndex=e.layerIndex,this._batchingRenderers=function(e){const t=e.id;let s=Gn[t];return s||(s=new jn(e),Gn[t]=s,s._compile(),e.on("compile",(()=>{s._compile();})),e.on("destroyed",(()=>{delete Gn[t],s._destroy();}))),s}(e.model.scene),this.model=e.model,this._buffer=new Hn(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Xe({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,positionsDecodeMatrix:f.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=f.collapseAABB3(),this._portions=[],this._numVerts=0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=f.vec3(e.origin)),this.aabb=f.collapseAABB3();}canCreatePortion(e,t){if(this._finalized)throw "Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e){if(this._finalized)throw "Already finalized";const t=e.positions,s=e.positionsCompressed,i=e.indices,r=e.color,o=e.opacity,n=e.meshMatrix,a=e.worldMatrix,h=e.worldAABB;e.pickColor;const l=this._buffer,u=l.positions.length/3;let c;if(this._preCompressedPositionsExpected){if(!s)throw "positionsCompressed expected";c=s.length/3;for(let e=0,t=s.length;e<t;e++)l.positions.push(s[e]);const e=Pt.getPositionsBounds(s),t=Pt.decompressPosition(e.min,this._state.positionsDecodeMatrix,[]),i=Pt.decompressPosition(e.max,this._state.positionsDecodeMatrix,[]);h[0]=t[0],h[1]=t[1],h[2]=t[2],h[3]=i[0],h[4]=i[1],h[5]=i[2],a&&(f.AABB3ToOBB3(h,Wn),f.transformOBB3(a,Wn),f.OBB3ToAABB3(Wn,h));}else {if(!t)throw "positions expected";c=t.length/3;const e=t.length,s=l.positions.length;for(let e=0,s=t.length;e<s;e++)l.positions.push(t[e]);if(n)for(let t=s,i=s+e;t<i;t+=3)Vn[0]=l.positions[t+0],Vn[1]=l.positions[t+1],Vn[2]=l.positions[t+2],f.transformPoint4(n,Vn,Un),l.positions[t+0]=Un[0],l.positions[t+1]=Un[1],l.positions[t+2]=Un[2],f.expandAABB3Point3(this._modelAABB,Un),a?(f.transformPoint4(a,Un,zn),f.expandAABB3Point3(h,zn)):f.expandAABB3Point3(h,Un);else for(let t=s,i=s+e;t<i;t+=3)Vn[0]=l.positions[t+0],Vn[1]=l.positions[t+1],Vn[2]=l.positions[t+2],f.expandAABB3Point3(this._modelAABB,Vn),a?(f.transformPoint4(a,Vn,Un),f.expandAABB3Point3(h,Un)):f.expandAABB3Point3(h,Vn);}if(this._state.origin){const e=this._state.origin;h[0]+=e[0],h[1]+=e[1],h[2]+=e[2],h[3]+=e[0],h[4]+=e[1],h[5]+=e[2];}if(f.expandAABB3(this.aabb,h),r){const e=r[0],t=r[1],s=r[2],i=o;for(let r=0;r<c;r++)l.colors.push(e),l.colors.push(t),l.colors.push(s),l.colors.push(i);}if(i)for(let e=0,t=i.length;e<t;e++)l.indices.push(i[e]+u);if(this.model.scene.entityOffsetsEnabled)for(let e=0;e<c;e++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);const p=this._portions.length/2;return this._portions.push(u),this._portions.push(c),this._numPortions++,this.model.numPortions++,this._numVerts+=c,p}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,s=this._buffer;if(s.positions.length>0)if(this._preCompressedPositionsExpected){const i=new Uint16Array(s.positions);e.positionsBuf=new Me(t,t.ARRAY_BUFFER,i,s.positions.length,3,t.STATIC_DRAW);}else {const i=_o(new Float32Array(s.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Me(t,t.ARRAY_BUFFER,i,s.positions.length,3,t.STATIC_DRAW);}if(s.colors.length>0){const i=new Uint8Array(s.colors);let r=!1;e.colorsBuf=new Me(t,t.ARRAY_BUFFER,i,s.colors.length,4,t.DYNAMIC_DRAW,r);}if(s.colors.length>0){const i=s.colors.length,r=new Uint8Array(i),o=new Uint8Array(i);let n=!1,a=!0;e.flagsBuf=new Me(t,t.ARRAY_BUFFER,r,r.length,4,t.DYNAMIC_DRAW,n),e.flags2Buf=new Me(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,a);}if(this.model.scene.entityOffsetsEnabled&&s.offsets.length>0){const i=new Float32Array(s.offsets);e.offsetsBuf=new Me(t,t.ARRAY_BUFFER,i,s.offsets.length,3,t.DYNAMIC_DRAW);}if(s.indices.length>0){const i=new Uint32Array(s.indices);e.indicesBuf=new Me(t,t.ELEMENT_ARRAY_BUFFER,i,s.indices.length,1,t.STATIC_DRAW);}this._buffer=null,this._finalized=!0;}initFlags(e,t,s){t&E&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&j&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&O&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&G&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&R&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&S&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,s,true),this._setFlags2(e,t,true);}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2();}setVisible(e,t,s){if(!this._finalized)throw "Not finalized";t&E?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,s);}setHighlighted(e,t,s){if(!this._finalized)throw "Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,s);}setXRayed(e,t,s){if(!this._finalized)throw "Not finalized";t&N?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,s);}setSelected(e,t,s){if(!this._finalized)throw "Not finalized";t&j?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,s);}setEdges(e,t,s){if(!this._finalized)throw "Not finalized";t&G?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,s);}setClippable(e,t){if(!this._finalized)throw "Not finalized";t&O?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t);}setCulled(e,t,s){if(!this._finalized)throw "Not finalized";t&S?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,s);}setCollidable(e,t){if(!this._finalized)throw "Not finalized"}setPickable(e,t,s){if(!this._finalized)throw "Not finalized";t&R?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,s);}setColor(e,t){if(!this._finalized)throw "Not finalized";const s=2*e,i=4*this._portions[s],r=4*this._portions[s+1],o=this._scratchMemory.getUInt8Array(r),n=t[0],a=t[1],h=t[2],l=t[3];for(let e=0;e<r;e+=4)o[e+0]=n,o[e+1]=a,o[e+2]=h,o[e+3]=l;this._state.colorsBuf.setData(o,i,r);}setTransparent(e,t,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,s);}_setFlags(e,t,s,i=!1){if(!this._finalized)throw "Not finalized";const r=2*e,o=4*this._portions[r],n=4*this._portions[r+1];this._scratchMemory.getUInt8Array(n);const a=!!(t&E),h=!!(t&N),l=!!(t&k),u=!!(t&j),c=!!(t&R),p=!!(t&S);let d,f;d=!a||p||h||l&&!this.model.scene.highlightMaterial.glowThrough||u&&!this.model.scene.selectedMaterial.glowThrough?_r:s?vr:yr,f=!a||p?_r:u?wr:l?br:h?Pr:_r;let m=a&&!p&&c?Cr:_r;if(i){this._deferredFlagValues||(this._deferredFlagValues=new Uint8Array(4*this._numVerts));for(let e=o,t=o+n;e<t;e+=4)this._deferredFlagValues[e+0]=d,this._deferredFlagValues[e+1]=f,this._deferredFlagValues[e+2]=0,this._deferredFlagValues[e+3]=m;}else if(this._state.flagsBuf){const e=this._scratchMemory.getUInt8Array(n);for(let t=0;t<n;t+=4)e[t+0]=d,e[t+1]=f,e[t+2]=0,e[t+3]=m;this._state.flagsBuf.setData(e,o,n);}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null);}_setFlags2(e,t,s=!1){if(!this._finalized)throw "Not finalized";const i=2*e,r=4*this._portions[i],o=4*this._portions[i+1],n=t&O?255:0;if(s){this._setDeferredFlag2Values||(this._setDeferredFlag2Values=new Uint8Array(4*this._numVerts));for(let e=r,t=r+o;e<t;e+=4)this._setDeferredFlag2Values[e]=n;}else {const e=this._scratchMemory.getUInt8Array(o);for(let t=0;t<o;t+=4)e[t+0]=n;this._state.flags2Buf.setData(e,r,o);}}_setDeferredFlags2(){this._setDeferredFlag2Values&&(this._state.flags2Buf.setData(this._setDeferredFlag2Values),this._setDeferredFlag2Values=null);}setOffset(e,t){if(!this._finalized)throw "Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const s=2*e,i=3*this._portions[s],r=3*this._portions[s+1],o=this._scratchMemory.getFloat32Array(r),n=t[0],a=t[1],h=t[2];for(let e=0;e<r;e+=3)o[e+0]=n,o[e+1]=a,o[e+2]=h;this._state.offsetsBuf.setData(o,i,r);}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,yr);}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,vr);}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,Pr);}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,br);}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,wr);}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e){}drawPickDepths(e){}drawPickNormals(e){}drawOcclusion(e){}drawShadow(e){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.destroy();}}const Yn=f.vec3();class Kn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.lineWidth(r.linesMaterial.lineWidth);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Yn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),e.drawElements++,n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Lines instancing color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 lightAmbient;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let s,i;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Lines instancing color fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("uniform bool sectionPlaneActive"+s+";"),o.push("uniform vec3 sectionPlanePos"+s+";"),o.push("uniform vec3 sectionPlaneDir"+s+";");if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("if (sectionPlaneActive"+s+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}");}return this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):o.push("    outColor           = vColor;"),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Jn=f.vec3();class Zn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=t.geometry;if(!this._program&&(this._allocate(t.model.scene),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Pr){const e=r.xrayMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===br){const e=r.highlightMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===wr){const e=r.selectedMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,f.vec3([1,1,1]));n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.lineWidth(r.linesMaterial.lineWidth);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,o=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Jn);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Lines instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 color;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Lines instancing silhouette fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = color;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}class Qn{constructor(e){this._scene=e;}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null);}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Kn(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Zn(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy();}}const qn={};const $n=new Uint8Array(4),ea=f.vec4([0,0,0,1]),ta=f.vec4([0,0,0,1]),sa=f.vec4([0,0,0,1]),ia=new Float32Array(3);class ra{constructor(e){this.model=e.model,this.geometry=e.geometry,this.material=e.material,this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._linesInstancingRenderers=function(e){const t=e.id;let s=qn[t];return s||(s=new Qn(e),qn[t]=s,s._compile(),e.on("compile",(()=>{s._compile();})),e.on("destroyed",(()=>{delete qn[t],s._destroy();}))),s}(e.model.scene),this._aabb=f.collapseAABB3(),this._state=new Xe({obb:f.OBB3(),numInstances:0,origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.origin&&(this._state.origin=f.vec3(e.origin)),this._finalized=!1,this.aabb=f.collapseAABB3();}createPortion(e){const t=e.color,s=e.opacity,i=e.meshMatrix,r=e.worldMatrix,o=e.aabb;if(this._finalized)throw "Already finalized";const n=t[0],a=t[1],h=t[2];t[3],this._colors.push(n),this._colors.push(a),this._colors.push(h),this._colors.push(s),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(i[0]),this._modelMatrixCol0.push(i[4]),this._modelMatrixCol0.push(i[8]),this._modelMatrixCol0.push(i[12]),this._modelMatrixCol1.push(i[1]),this._modelMatrixCol1.push(i[5]),this._modelMatrixCol1.push(i[9]),this._modelMatrixCol1.push(i[13]),this._modelMatrixCol2.push(i[2]),this._modelMatrixCol2.push(i[6]),this._modelMatrixCol2.push(i[10]),this._modelMatrixCol2.push(i[14]),f.collapseAABB3(o);const l=this._state.obb,u=l.length;for(let e=0;e<u;e+=4)ea[0]=l[e+0],ea[1]=l[e+1],ea[2]=l[e+2],f.transformPoint4(i,ea,ta),r?(f.transformPoint4(r,ta,sa),f.expandAABB3Point3(o,sa)):f.expandAABB3Point3(o,ta);if(this._state.origin){const e=this._state.origin;o[0]+=e[0],o[1]+=e[1],o[2]+=e[2],o[3]+=e[0],o[4]+=e[1],o[5]+=e[2];}f.expandAABB3(this.aabb,o),this._state.numInstances++;const c=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,c}finalize(){if(this._finalized)throw "Already finalized";const e=this.model.scene.canvas.gl,t=this._colors.length,s=t;if(t>0){let t=!1;this._state.colorsBuf=new Me(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,t),this._colors=[];}if(s>0){let t=!1,i=!0;this._state.flagsBuf=new Me(e,e.ARRAY_BUFFER,new Uint8Array(s),s,4,e.DYNAMIC_DRAW,t),this._state.flags2Buf=new Me(e,e.ARRAY_BUFFER,new Uint8Array(s),s,4,e.DYNAMIC_DRAW,i);}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;this._state.offsetsBuf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,t),this._offsets=[];}if(this._modelMatrixCol0.length>0){const t=!1;this._state.modelMatrixCol0Buf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol1Buf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol2Buf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[];}this._finalized=!0;}initFlags(e,t,s){t&E&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&j&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&O&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&G&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&R&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&S&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,s),this._setFlags2(e,t);}setVisible(e,t,s){if(!this._finalized)throw "Not finalized";t&E?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,s);}setHighlighted(e,t,s){if(!this._finalized)throw "Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,s);}setXRayed(e,t,s){if(!this._finalized)throw "Not finalized";t&N?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,s);}setSelected(e,t,s){if(!this._finalized)throw "Not finalized";t&j?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,s);}setEdges(e,t,s){if(!this._finalized)throw "Not finalized";t&G?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,s);}setClippable(e,t){if(!this._finalized)throw "Not finalized";t&O?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t);}setCollidable(e,t){if(!this._finalized)throw "Not finalized"}setPickable(e,t,s){if(!this._finalized)throw "Not finalized";t&R?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,s);}setCulled(e,t,s){if(!this._finalized)throw "Not finalized";t&S?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,s);}setColor(e,t){if(!this._finalized)throw "Not finalized";$n[0]=t[0],$n[1]=t[1],$n[2]=t[2],$n[3]=t[3],this._state.colorsBuf.setData($n,4*e,4);}setTransparent(e,t,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,s);}_setFlags(e,t,s){if(!this._finalized)throw "Not finalized";const i=!!(t&E),r=!!(t&N),o=!!(t&k),n=!!(t&j),a=!!(t&G),h=!!(t&R),l=!!(t&S);let u,c;u=!i||l||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?_r:s?vr:yr,c=!i||l?_r:n?wr:o?br:r?Pr:_r;let p=0;p=!i||l?_r:n?Dr:o?Mr:r?Ar:a?s?xr:Tr:_r;let d=i&&!l&&h?Cr:_r;$n[0]=u,$n[1]=c,$n[2]=p,$n[3]=d,this._state.flagsBuf.setData($n,4*e,4);}_setFlags2(e,t){if(!this._finalized)throw "Not finalized";const s=t&O?255:0;$n[0]=s,this._state.flags2Buf.setData($n,4*e,4);}setOffset(e,t){if(!this._finalized)throw "Not finalized";this.model.scene.entityOffsetsEnabled?(ia[0]=t[0],ia[1]=t[1],ia[2]=t[2],this._state.offsetsBuf.setData(ia,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer");}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(t,this,yr);}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(t,this,vr);}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,Pr);}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,br);}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,wr);}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesXRayed(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawOcclusion(e,t){}drawShadow(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawPickNormals(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy();}}const oa=f.vec3();class na{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=this._scene,r=i.camera,o=t.model,n=i.canvas.gl,a=t._state,h=t._state.origin,l=i.pointsMaterial;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(r.viewMatrix,h):r.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const u=i._sectionPlanesState.sectionPlanes.length;if(u>0){const e=i._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,r=o.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const o=r.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,o?1:0),o){const s=e[t];if(h){const e=K(s.dist,s.dir,h,oa);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),l.filterIntensity&&n.uniform2f(this._uIntensityRange,l.minIntensity,l.maxIntensity),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),n.uniform1f(this._uPointSize,l.pointSize);const c="ortho"===i.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*i.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,c),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems),e.drawArrays++;}_allocate(){const e=this._scene,t=e.pointsMaterial._state,s=e.canvas.gl;if(this._program=new xe(s,this._buildShader(e)),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.filterIntensity&&(this._uIntensityRange=i.getLocation("intensityRange")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=this._program,i=e.camera.project;if(s.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial,i=[];return i.push("#version 300 es"),i.push("// Points batching color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),s.filterIntensity&&i.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),s.filterIntensity&&(i.push("float intensity = float(color.a) / 255.0;"),i.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {")),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),s.filterIntensity&&i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points batching color fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}");}return i.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const aa=new Float32Array([1,1,1]),ha=f.vec3();class la{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Pr){const e=r.xrayMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===br){const e=r.highlightMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===wr){const e=r.selectedMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,aa);const u=h?W(o.viewMatrix,h):o.viewMatrix;n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,ha);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),n.uniform1f(this._uPointSize,l.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let s,i;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Points batching silhouette vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("uniform bool sectionPlaneActive"+s+";"),o.push("uniform vec3 sectionPlanePos"+s+";"),o.push("uniform vec3 sectionPlaneDir"+s+";");if(o.push("uniform vec4 color;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),e.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("if (sectionPlaneActive"+s+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}");}return e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("outColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const ua=f.vec3();class ca{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=e.pickViewMatrix||o.viewMatrix,c=h?W(u,h):u;if(n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,c),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,o=i.renderFlags;for(let t=0;t<p;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,ua);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(a.pickColorsBuf),n.uniform1f(this._uPointSize,l.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible);}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points batching pick mesh vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 pickColor;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("gl_PointSize += 10.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points batching pick mesh vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";");}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const pa=f.vec3();class da{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniform1i(this._uPickInvisible,e.pickInvisible);const u=e.pickViewMatrix||o.viewMatrix,c=h?W(u,h):u;if(n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t);}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*p,o=i.renderFlags;for(let t=0;t<p;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,pa);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),n.uniform1f(this._uPointSize,l.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points batched pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("gl_PointSize += 10.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points batched pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("      if (sectionPlaneActive"+r+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outColor = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const fa=f.vec3();class ma{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.canvas.gl,n=t._state,a=r.camera,h=t._state.origin,l=r.pointsMaterial._state;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,s),o.uniformMatrix4fv(this._uViewMatrix,!1,h?W(a.viewMatrix,h):a.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*u,n=i.renderFlags;for(let t=0;t<u;t++){const i=this._uSectionPlanes[t];if(i){const r=n.sectionPlanesActivePerLayer[s+t];if(o.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,fa);o.uniform3fv(i.pos,e);}else o.uniform3fv(i.pos,s.pos);o.uniform3fv(i.dir,s.dir);}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),o.uniform1f(this._uPointSize,l.pointSize);const c="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,c),o.drawArrays(o.POINTS,0,n.positionsBuf.numItems);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points batching occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("  gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("// Points batching occlusion fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("      if (sectionPlaneActive"+e+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}class ga{constructor(e){this._scene=e;}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null);}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new na(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new la(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new ca(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new da(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new ma(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy();}}const _a={};class ya{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[];}}const va=f.vec4(),ba=f.vec4(),wa=f.vec4([0,0,0,1]),Pa=f.vec4([0,0,0,1]),Ta=f.vec4([0,0,0,1]),xa=f.OBB3();class Ma{constructor(e){this.model=e.model,this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._pointsBatchingRenderers=function(e){const t=e.id;let s=_a[t];return s||(s=new ga(e),_a[t]=s,s._compile(),e.on("compile",(()=>{s._compile();})),e.on("destroyed",(()=>{delete _a[t],s._destroy();}))),s}(e.model.scene),this._buffer=new ya(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Xe({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,positionsDecodeMatrix:f.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=f.collapseAABB3(),this._portions=[],this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=f.vec3(e.origin)),this.aabb=f.collapseAABB3();}canCreatePortion(e){if(this._finalized)throw "Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts}createPortion(e){if(this._finalized)throw "Already finalized";const t=e.positions,s=e.positionsCompressed,i=e.color,r=e.colorsCompressed,o=e.colors,n=e.meshMatrix,a=e.worldMatrix,h=e.worldAABB,l=e.pickColor,u=this._buffer,c=u.positions.length/3;let p;if(this._preCompressedPositionsExpected){if(!s)throw "positionsCompressed expected";for(let e=0,t=s.length;e<t;e++)u.positions.push(s[e]);const e=Pt.getPositionsBounds(s),t=Pt.decompressPosition(e.min,this._state.positionsDecodeMatrix,va),i=Pt.decompressPosition(e.max,this._state.positionsDecodeMatrix,ba);h[0]=t[0],h[1]=t[1],h[2]=t[2],h[3]=i[0],h[4]=i[1],h[5]=i[2],a&&(f.AABB3ToOBB3(h,xa),f.transformOBB3(a,xa),f.OBB3ToAABB3(xa,h)),p=s.length/3;}else {if(!t)throw "positions expected";p=t.length/3;const e=t.length,s=u.positions.length;for(let e=0,s=t.length;e<s;e++)u.positions.push(t[e]);if(n)for(let t=s,i=s+e;t<i;t+=3)wa[0]=u.positions[t+0],wa[1]=u.positions[t+1],wa[2]=u.positions[t+2],f.transformPoint4(n,wa,Pa),u.positions[t+0]=Pa[0],u.positions[t+1]=Pa[1],u.positions[t+2]=Pa[2],f.expandAABB3Point3(this._modelAABB,Pa),a?(f.transformPoint4(a,Pa,Ta),f.expandAABB3Point3(h,Ta)):f.expandAABB3Point3(h,Pa);else for(let t=s,i=s+e;t<i;t+=3)wa[0]=u.positions[t+0],wa[1]=u.positions[t+1],wa[2]=u.positions[t+2],f.expandAABB3Point3(this._modelAABB,wa),a?(f.transformPoint4(a,wa,Pa),f.expandAABB3Point3(h,Pa)):f.expandAABB3Point3(h,wa);}if(this._state.origin){const e=this._state.origin;h[0]+=e[0],h[1]+=e[1],h[2]+=e[2],h[3]+=e[0],h[4]+=e[1],h[5]+=e[2];}if(f.expandAABB3(this.aabb,h),r)for(let e=0,t=r.length;e<t;e++)u.colors.push(r[e]);else if(o)for(let e=0,t=o.length;e<t;e++)u.colors.push(255*o[e]);else if(i){const e=i[0],t=i[1],s=i[2],r=1;for(let i=0;i<p;i++)u.colors.push(e),u.colors.push(t),u.colors.push(s),u.colors.push(r);}{const e=u.pickColors.length;for(let t=e,s=e+4*p;t<s;t+=4)u.pickColors.push(l[0]),u.pickColors.push(l[1]),u.pickColors.push(l[2]),u.pickColors.push(l[3]);}if(this.model.scene.entityOffsetsEnabled)for(let e=0;e<p;e++)u.offsets.push(0),u.offsets.push(0),u.offsets.push(0);const d=this._portions.length/2;return this._portions.push(c),this._portions.push(p),this._numPortions++,this.model.numPortions++,d}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,s=this._buffer;if(s.positions.length>0)if(this._preCompressedPositionsExpected){const i=new Uint16Array(s.positions);e.positionsBuf=new Me(t,t.ARRAY_BUFFER,i,s.positions.length,3,t.STATIC_DRAW);}else {const i=_o(new Float32Array(s.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Me(t,t.ARRAY_BUFFER,i,s.positions.length,3,t.STATIC_DRAW);}if(s.colors.length>0){const i=new Uint8Array(s.colors);let r=!1;e.colorsBuf=new Me(t,t.ARRAY_BUFFER,i,s.colors.length,4,t.STATIC_DRAW,r);}if(s.positions.length>0){const i=s.positions.length/3*4,r=new Uint8Array(i),o=new Uint8Array(i);let n=!1,a=!0;e.flagsBuf=new Me(t,t.ARRAY_BUFFER,r,r.length,4,t.DYNAMIC_DRAW,n),e.flags2Buf=new Me(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,a);}if(s.pickColors.length>0){const i=new Uint8Array(s.pickColors);let r=!1;e.pickColorsBuf=new Me(t,t.ARRAY_BUFFER,i,s.pickColors.length,4,t.STATIC_DRAW,r);}if(this.model.scene.entityOffsetsEnabled&&s.offsets.length>0){const i=new Float32Array(s.offsets);e.offsetsBuf=new Me(t,t.ARRAY_BUFFER,i,s.offsets.length,3,t.DYNAMIC_DRAW);}this._buffer=null,this._finalized=!0;}initFlags(e,t,s){t&E&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&j&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&O&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&R&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&S&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,s),this._setFlags2(e,t);}setVisible(e,t,s){if(!this._finalized)throw "Not finalized";t&E?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,s);}setHighlighted(e,t,s){if(!this._finalized)throw "Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,s);}setXRayed(e,t,s){if(!this._finalized)throw "Not finalized";t&N?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,s);}setSelected(e,t,s){if(!this._finalized)throw "Not finalized";t&j?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,s);}setEdges(e,t,s){if(!this._finalized)throw "Not finalized"}setClippable(e,t){if(!this._finalized)throw "Not finalized";t&O?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t);}setCulled(e,t,s){if(!this._finalized)throw "Not finalized";t&S?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,s);}setCollidable(e,t){if(!this._finalized)throw "Not finalized"}setPickable(e,t,s){if(!this._finalized)throw "Not finalized";t&R?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,s);}setColor(e,t){if(!this._finalized)throw "Not finalized";const s=2*e,i=4*this._portions[s],r=4*this._portions[s+1],o=this._scratchMemory.getUInt8Array(r),n=t[0],a=t[1],h=t[2];for(let e=0;e<r;e+=4)o[e+0]=n,o[e+1]=a,o[e+2]=h;this._state.colorsBuf.setData(o,i,r);}setTransparent(e,t,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,s);}_setFlags(e,t,s){if(!this._finalized)throw "Not finalized";const i=2*e,r=4*this._portions[i],o=4*this._portions[i+1],n=this._scratchMemory.getUInt8Array(o),a=!!(t&E),h=!!(t&N),l=!!(t&k),u=!!(t&j),c=!!(t&R),p=!!(t&S);let d,f;d=!a||p||h||l&&!this.model.scene.highlightMaterial.glowThrough||u&&!this.model.scene.selectedMaterial.glowThrough?_r:s?vr:yr,f=!a||p?_r:u?wr:l?br:h?Pr:_r;let m=a&&!p&&c?Cr:_r;for(let e=0;e<o;e+=4)n[e+0]=d,n[e+1]=f,n[e+2]=0,n[e+3]=m;this._state.flagsBuf.setData(n,r,o);}_setFlags2(e,t){if(!this._finalized)throw "Not finalized";const s=2*e,i=4*this._portions[s],r=4*this._portions[s+1],o=this._scratchMemory.getUInt8Array(r),n=t&O?255:0;for(let e=0;e<r;e+=4)o[e+0]=n;this._state.flags2Buf.setData(o,i,r);}setOffset(e,t){if(!this._finalized)throw "Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const s=2*e,i=3*this._portions[s],r=3*this._portions[s+1],o=this._scratchMemory.getFloat32Array(r),n=t[0],a=t[1],h=t[2];for(let e=0;e<r;e+=3)o[e+0]=n,o[e+1]=a,o[e+2]=h;this._state.offsetsBuf.setData(o,i,r);}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(t,this,yr);}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(t,this,vr);}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,Pr);}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,br);}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,wr);}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickMeshRenderer&&this._pointsBatchingRenderers.pickMeshRenderer.drawLayer(t,this,Cr);}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickDepthRenderer&&this._pointsBatchingRenderers.pickDepthRenderer.drawLayer(t,this,Cr);}drawPickNormals(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.occlusionRenderer&&this._pointsBatchingRenderers.occlusionRenderer.drawLayer(t,this,yr);}drawShadow(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy();}}const Da=f.vec3();class Aa{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state,u=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),this._aPosition.bindArrayBuffer(u.positionsBuf),this._aColor.bindArrayBuffer(u.colorsBuf),l.filterIntensity&&n.uniform2f(this._uIntensityRange,l.minIntensity,l.maxIntensity);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Da);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),n.uniform1f(this._uPointSize,l.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArraysInstanced(n.POINTS,0,u.positionsBuf.numItems,a.numInstances),e.drawArrays++,n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.pointsMaterial._state,s=e.canvas.gl;if(this._program=new xe(s,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.filterIntensity&&(this._uIntensityRange=i.getLocation("intensityRange")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points instancing color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),s.filterIntensity&&i.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),s.filterIntensity&&(i.push("float intensity = float(color.a) / 255.0;"),i.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {")),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),s.filterIntensity&&i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing color fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return i.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Ca=f.vec3();class Ia{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state,u=t.geometry;if(!this._program&&(this._allocate(t.model.scene),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),s===Pr){const e=r.xrayMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===br){const e=r.highlightMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else if(s===wr){const e=r.selectedMaterial._state,t=e.fillColor,s=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],s);}else n.uniform4fv(this._uColor,f.vec3([1,1,1]));n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Ca);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(u.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),n.uniform1f(this._uPointSize,l.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArraysInstanced(n.POINTS,0,u.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 color;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing silhouette fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = color;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Fa=f.vec3();class Ba{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state,u=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,s);const c=e.pickViewMatrix||o.viewMatrix,p=h?W(c,h):c;if(n.uniformMatrix4fv(this._uViewMatrix,!1,p),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e);}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(a.pickColorsBuf),n.vertexAttribDivisor(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(u.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),n.uniform1f(this._uPointSize,l.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d);const f=r._sectionPlanesState.sectionPlanes.length;if(f>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*f,o=i.renderFlags;for(let t=0;t<f;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Fa);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.drawArraysInstanced(n.POINTS,0,u.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aPickColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._uRenderPass=i.getLocation("renderPass"),this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible);}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points instancing pick mesh vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 pickColor;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick mesh fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Ea=f.vec3();class Sa{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.canvas.gl,n=t._state,a=t._state.origin,h=r.pointsMaterial._state,l=t.geometry;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const u=r.camera;o.uniform1i(this._uRenderPass,s),o.uniform1i(this._uPickInvisible,e.pickInvisible);const c=e.pickViewMatrix||u.viewMatrix,p=a?W(c,a):c;if(o.uniformMatrix4fv(this._uViewMatrix,!1,p),o.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),o.uniform1f(this._uPickZNear,e.pickZNear),o.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t);}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*d,n=i.renderFlags;for(let t=0;t<d;t++){const i=this._uSectionPlanes[t];if(i){const r=n.sectionPlanesActivePerLayer[s+t];if(o.uniform1i(i.active,r?1:0),r){const s=e[t];if(a){const e=K(s.dist,s.dir,a,Ea);o.uniform3fv(i.pos,e);}else o.uniform3fv(i.pos,s.pos);o.uniform3fv(i.dir,s.dir);}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),o.vertexAttribDivisor(this._aModelMatrixCol0.location,1),o.vertexAttribDivisor(this._aModelMatrixCol1.location,1),o.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),o.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),o.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),o.vertexAttribDivisor(this._aOffset.location,1)),o.uniform1f(this._uPointSize,h.pointSize);const f="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,f),o.drawArraysInstanced(o.POINTS,0,l.positionsBuf.numItems,n.numInstances),o.vertexAttribDivisor(this._aModelMatrixCol0.location,0),o.vertexAttribDivisor(this._aModelMatrixCol1.location,0),o.vertexAttribDivisor(this._aModelMatrixCol2.location,0),o.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&o.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){this._program.bind();}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points instancing pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outColor = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const Ra=f.vec3();class Oa{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state,u=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,Ra);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(u.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1)),this._aPosition.bindArrayBuffer(u.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),n.uniform1f(this._uPointSize,l.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArraysInstanced(n.POINTS,0,u.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aColor&&n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points instancing occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing occlusion vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),e.pointsMaterial.roundPoints&&(i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }")),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const La=f.vec3();class Na{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,s){const i=t.model,r=i.scene,o=r.camera,n=r.canvas.gl,a=t._state,h=t._state.origin,l=r.pointsMaterial._state,u=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,s),n.uniformMatrix4fv(this._uWorldMatrix,!1,i.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,h?W(o.viewMatrix,h):o.viewMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,s=t.layerIndex*c,o=i.renderFlags;for(let t=0;t<c;t++){const i=this._uSectionPlanes[t];if(i){const r=o.sectionPlanesActivePerLayer[s+t];if(n.uniform1i(i.active,r?1:0),r){const s=e[t];if(h){const e=K(s.dist,s.dir,h,La);n.uniform3fv(i.pos,e);}else n.uniform3fv(i.pos,s.pos);n.uniform3fv(i.dir,s.dir);}}}}this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(u.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),n.uniform1f(this._uPointSize,l.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArraysInstanced(n.POINTS,0,u.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"));}_bindProgram(){const e=this._scene,t=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e);}}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=e.pointsMaterial._state,i=[];return i.push("#version 300 es"),i.push("// Points instancing depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),s.perspectivePoints&&i.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),s.perspectivePoints?(i.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),i.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),i.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):i.push("gl_PointSize = pointSize;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let s,i;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Points instancing depth vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("uniform bool sectionPlaneActive"+s+";"),o.push("uniform vec3 sectionPlanePos"+s+";"),o.push("uniform vec3 sectionPlaneDir"+s+";");if(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}"),o.push("out vec4 outColor;"),o.push("void main(void) {"),e.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),s=0,i=t.sectionPlanes.length;s<i;s++)o.push("if (sectionPlaneActive"+s+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}");}return o.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}const ka=f.vec3();class ja{constructor(e){this._scene=e,this._hash=this._getHash(),this._lastLightId=null,this._allocate();}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){const s=t.model,i=s.scene,r=i.canvas.gl,o=t._state;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,geometry.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),r.vertexAttribDivisor(this._aModelMatrixCol0.location,1),r.vertexAttribDivisor(this._aModelMatrixCol1.location,1),r.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),r.vertexAttribDivisor(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),r.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),r.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),r.vertexAttribDivisor(this._aFlags2.location,1));const n=i._sectionPlanesState.sectionPlanes.length;if(n>0){const e=i._sectionPlanesState.sectionPlanes,o=t.layerIndex*n,a=s.renderFlags,h=t._state.origin;for(let t=0;t<n;t++){const s=this._uSectionPlanes[t];if(s){const i=a.sectionPlanesActivePerLayer[o+t];if(r.uniform1i(s.active,i?1:0),i){const i=e[t];if(h){const e=K(i.dist,i.dir,h,ka);r.uniform3fv(s.pos,e);}else r.uniform3fv(s.pos,i.pos);r.uniform3fv(s.dir,i.dir);}}}}r.uniform1f(this._uPointSize,10),r.drawArraysInstanced(r.POINTS,0,o.positionsBuf.numItems,o.numInstances),r.vertexAttribDivisor(this._aModelMatrixCol0.location,0),r.vertexAttribDivisor(this._aModelMatrixCol1.location,0),r.vertexAttribDivisor(this._aModelMatrixCol2.location,0),r.vertexAttribDivisor(this._aColor.location,0),r.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&r.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&r.vertexAttribDivisor(this._aOffset.location,0);}_allocate(){const e=this._scene,t=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new xe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=i.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=i.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize");}_bindProgram(e,t){const s=this._scene.canvas.gl;this._program.bind(),s.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),s.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null;}_buildShader(){return {vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry shadow drawing vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("bool visible      = (float(flags.x) > 0.0);"),s.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),s.push("if (!visible || transparent) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("  gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s.push("gl_PointSize = pointSize;"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,s=t.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Instancing geometry depth drawing fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),s){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";");}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),i.push("  float r = dot(cxy, cxy);"),i.push("  if (r > 1.0) {"),i.push("       discard;"),i.push("  }"),s){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let e=0,s=t.sectionPlanes.length;e<s;e++)i.push("if (sectionPlaneActive"+e+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}");}return e.logarithmicDepthBufferEnabled&&i.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null;}destroy(){this._program&&this._program.destroy(),this._program=null;}}class Ga{constructor(e){this._scene=e;}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null);}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Aa(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Ia(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new Na(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Ba(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Sa(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Oa(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new ja(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy();}}const Ha={};const Va=new Uint8Array(4),Ua=f.vec4([0,0,0,1]),za=f.vec4([0,0,0,1]),Wa=f.vec4([0,0,0,1]),Xa=new Float32Array(3);class Ya{constructor(e){this.model=e.model,this.geometry=e.geometry,this.material=e.material,this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._pointsInstancingRenderers=function(e){const t=e.id;let s=Ha[t];return s||(s=new Ga(e),Ha[t]=s,s._compile(),e.on("compile",(()=>{s._compile();})),e.on("destroyed",(()=>{delete Ha[t],s._destroy();}))),s}(e.model.scene),this._aabb=f.collapseAABB3(),this._state=new Xe({obb:f.OBB3(),numInstances:0,origin:e.origin?f.vec3(e.origin):null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._finalized=!1,this.aabb=f.collapseAABB3();}createPortion(e){const t=e.meshMatrix,s=e.worldMatrix,i=e.aabb,r=e.pickColor;if(this._finalized)throw "Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(t[0]),this._modelMatrixCol0.push(t[4]),this._modelMatrixCol0.push(t[8]),this._modelMatrixCol0.push(t[12]),this._modelMatrixCol1.push(t[1]),this._modelMatrixCol1.push(t[5]),this._modelMatrixCol1.push(t[9]),this._modelMatrixCol1.push(t[13]),this._modelMatrixCol2.push(t[2]),this._modelMatrixCol2.push(t[6]),this._modelMatrixCol2.push(t[10]),this._modelMatrixCol2.push(t[14]),this._pickColors.push(r[0]),this._pickColors.push(r[1]),this._pickColors.push(r[2]),this._pickColors.push(r[3]),f.collapseAABB3(i);const o=this._state.obb,n=o.length;for(let e=0;e<n;e+=4)Ua[0]=o[e+0],Ua[1]=o[e+1],Ua[2]=o[e+2],f.transformPoint4(t,Ua,za),s?(f.transformPoint4(s,za,Wa),f.expandAABB3Point3(i,Wa)):f.expandAABB3Point3(i,za);if(this._state.origin){const e=this._state.origin;i[0]+=e[0],i[1]+=e[1],i[2]+=e[2],i[3]+=e[0],i[4]+=e[1],i[5]+=e[2];}f.expandAABB3(this.aabb,i),this._state.numInstances++;const a=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,a}finalize(){if(this._finalized)throw "Already finalized";const e=this.model.scene.canvas.gl,t=this._pickColors.length;if(t>0){let s=!1,i=!0;this._state.flagsBuf=new Me(e,e.ARRAY_BUFFER,new Uint8Array(t),t,4,e.DYNAMIC_DRAW,s),this._state.flags2Buf=new Me(e,e.ARRAY_BUFFER,new Uint8Array(t),t,4,e.DYNAMIC_DRAW,i);}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;this._state.offsetsBuf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,t),this._offsets=[];}if(this._modelMatrixCol0.length>0){const t=!1;this._state.modelMatrixCol0Buf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol1Buf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol2Buf=new Me(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[];}if(this._pickColors.length>0){const t=!1;this._state.pickColorsBuf=new Me(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,t),this._pickColors=[];}this._finalized=!0;}initFlags(e,t,s){t&E&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&j&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&O&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&G&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&R&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&S&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),s&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,s),this._setFlags2(e,t);}setVisible(e,t,s){if(!this._finalized)throw "Not finalized";t&E?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,s);}setHighlighted(e,t,s){if(!this._finalized)throw "Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,s);}setXRayed(e,t,s){if(!this._finalized)throw "Not finalized";t&N?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,s);}setSelected(e,t,s){if(!this._finalized)throw "Not finalized";t&j?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,s);}setEdges(e,t,s){if(!this._finalized)throw "Not finalized";t&G?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,s);}setClippable(e,t){if(!this._finalized)throw "Not finalized";t&O?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t);}setCollidable(e,t){if(!this._finalized)throw "Not finalized"}setPickable(e,t,s){if(!this._finalized)throw "Not finalized";t&R?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,s);}setCulled(e,t,s){if(!this._finalized)throw "Not finalized";t&S?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,s);}setColor(e,t){if(!this._finalized)throw "Not finalized";Va[0]=t[0],Va[1]=t[1],Va[2]=t[2],this._state.colorsBuf.setData(Va,3*e,3);}setTransparent(e,t,s){s?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,s);}_setFlags(e,t,s){if(!this._finalized)throw "Not finalized";const i=!!(t&E),r=!!(t&N),o=!!(t&k),n=!!(t&j),a=!!(t&G),h=!!(t&R),l=!!(t&S);let u,c;u=!i||l||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?_r:s?vr:yr,c=!i||l?_r:n?wr:o?br:r?Pr:_r;let p=0;p=!i||l?_r:n?Dr:o?Mr:r?Ar:a?s?xr:Tr:_r;let d=i&&!l&&h?Cr:_r;Va[0]=u,Va[1]=c,Va[2]=p,Va[3]=d,this._state.flagsBuf.setData(Va,4*e,4);}_setFlags2(e,t){if(!this._finalized)throw "Not finalized";const s=t&O?255:0;Va[0]=s,this._state.flags2Buf.setData(Va,4*e,4);}setOffset(e,t){if(!this._finalized)throw "Not finalized";this.model.scene.entityOffsetsEnabled?(Xa[0]=t[0],Xa[1]=t[1],Xa[2]=t[2],this._state.offsetsBuf.setData(Xa,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer");}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(t,this,yr);}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(t,this,vr);}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,Pr);}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,br);}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,wr);}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.occlusionRenderer&&this._pointsInstancingRenderers.occlusionRenderer.drawLayer(t,this,yr);}drawShadow(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickMeshRenderer&&this._pointsInstancingRenderers.pickMeshRenderer.drawLayer(t,this,Cr);}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickDepthRenderer&&this._pointsInstancingRenderers.pickDepthRenderer.drawLayer(t,this,Cr);}drawPickNormals(e,t){}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy();}}class Ka{constructor(e){this.id=e.id,this.colorTexture=e.colorTexture,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.normalsTexture=e.normalsTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture;}destroy(){}}class Ja{constructor(e,t,s){this.id=s.id,this.model=s.model,this.primitive=s.primitive,this.positions=null,this.positionsCompressed=null,this.quantizedPositions=null,this.positionsDecodeMatrix=f.mat4(),this.normals=null,this.normalsCompressed=null,this.colors=null,this.colorsCompressed=null,this.uv=null,this.uvCompressed=null,this.uvDecodeMatrix=null,this.indices=null,this.numIndices=0,this.obb=f.OBB3(),this.positionsBuf=null,this.normalsBuf=null,this.edgeIndicesBuf=null,this.uvBuf=null,this.colorsBuf=null;const i=t.scene.pickSurfacePrecisionEnabled,r=t.scene.canvas.gl;if(s.positionsCompressed&&s.positionsCompressed.length>0){const e=!1;this.positionsBuf=new Me(r,r.ARRAY_BUFFER,s.positionsCompressed,s.positionsCompressed.length,3,r.STATIC_DRAW,e),this.positionsDecodeMatrix.set(s.positionsDecodeMatrix);const t=f.collapseAABB3();f.expandAABB3Points3(t,s.positionsCompressed),Pt.decompressAABB(t,this.positionsDecodeMatrix),f.AABB3ToOBB3(t,this.obb),i&&(this.quantizedPositions=s.positionsCompressed);}else if(s.positions&&s.positions.length>0){const e=s.positions.length,t=f.collapseAABB3();f.expandAABB3Points3(t,s.positions),f.AABB3ToOBB3(t,this.obb);const o=_o(s.positions,t,this.positionsDecodeMatrix);let n=!1;this.positionsBuf=new Me(r,r.ARRAY_BUFFER,o,e,3,r.STATIC_DRAW,n),i&&(this.quantizedPositions=o);}if(s.normalsCompressed&&s.normalsCompressed.length>0){const e=!0;this.normalsBuf=new Me(r,r.ARRAY_BUFFER,s.normalsCompressed,s.normalsCompressed.length,3,r.STATIC_DRAW,e);}else if(s.normals&&s.normals.length>0){const e=function(e){const t=e.length,s=new Int8Array(t);let i,r,o,n,a;for(let h=0;h<t;h+=3)o=i=vo(e,h,"floor","floor"),r=bo(i),n=a=wo(e,h,r),i=vo(e,h,"ceil","floor"),r=bo(i),n=wo(e,h,r),n>a&&(o=i,a=n),i=vo(e,h,"floor","ceil"),r=bo(i),n=wo(e,h,r),n>a&&(o=i,a=n),i=vo(e,h,"ceil","ceil"),r=bo(i),n=wo(e,h,r),n>a&&(o=i,a=n),s[h+0]=o[0],s[h+1]=o[1],s[h+2]=0;return s}(s.normals),t=!0;this.normalsBuf=new Me(r,r.ARRAY_BUFFER,e,e.length,3,r.STATIC_DRAW,t);}if(s.colorsCompressed&&s.colorsCompressed.length>0){const e=new Uint8Array(s.colorsCompressed),t=!1;this.colorsBuf=new Me(r,r.ARRAY_BUFFER,e,e.length,4,r.STATIC_DRAW,t);}else if(s.colors&&s.colors.length>0){const e=s.colors,t=new Uint8Array(e.length);for(let s=0,i=e.length;s<i;s++)t[s]=255*e[s];const i=!1;this.colorsBuf=new Me(r,r.ARRAY_BUFFER,t,t.length,4,r.STATIC_DRAW,i);}if(s.uvCompressed&&s.uvCompressed.length>0){const e=new Uint16Array(s.uvCompressed);this.uvDecodeMatrix=f.mat4(s.uvDecodeMatrix),this.uvBuf=new Me(r,r.ARRAY_BUFFER,s.uvCompressed,e.length,2,r.STATIC_DRAW,!1);}else if(s.uv&&s.uv.length>0){const e=Pt.getUVBounds(s.uv),t=Pt.compressUVs(s.uv,e.min,e.max),i=t.quantized;this.uvDecodeMatrix=t.decodeMatrix,this.uvBuf=new Me(r,r.ARRAY_BUFFER,i,i.length,2,r.STATIC_DRAW,!1);}if(s.indices&&s.indices.length>0&&(this.indicesBuf=new Me(r,r.ELEMENT_ARRAY_BUFFER,new Uint32Array(s.indices),s.indices.length,1,r.STATIC_DRAW),i&&(this.indices=s.indices),this.numIndices=s.indices.length),"triangles"===s.primitive||"solid"===s.primitive||"surface"===s.primitive){let e=s.edgeIndices;e||(e=mt(s.positions,s.indices,null,s.edgeThreshold||10)),this.edgeIndicesBuf=new Me(r,r.ELEMENT_ARRAY_BUFFER,new Uint32Array(e),e.length,1,r.STATIC_DRAW);}}destroy(){}}function Za(e,t,s=null){let i;const r=t;if(1009===r)return e.UNSIGNED_BYTE;if(1017===r)return e.UNSIGNED_SHORT_4_4_4_4;if(1018===r)return e.UNSIGNED_SHORT_5_5_5_1;if(1010===r)return e.BYTE;if(1011===r)return e.SHORT;if(1012===r)return e.UNSIGNED_SHORT;if(1013===r)return e.INT;if(1014===r)return e.UNSIGNED_INT;if(1015===r)return e.FLOAT;if(1016===r)return e.HALF_FLOAT;if(1021===r)return e.ALPHA;if(1023===r)return e.RGBA;if(1024===r)return e.LUMINANCE;if(1025===r)return e.LUMINANCE_ALPHA;if(1026===r)return e.DEPTH_COMPONENT;if(1027===r)return e.DEPTH_STENCIL;if(1028===r)return e.RED;if(1022===r)return e.RGBA;if(1029===r)return e.RED_INTEGER;if(1030===r)return e.RG;if(1031===r)return e.RG_INTEGER;if(1033===r)return e.RGBA_INTEGER;if(33776===r||33777===r||33778===r||33779===r)if(3001===s){const t=Ve(e,"WEBGL_compressed_texture_s3tc_srgb");if(null===t)return null;if(33776===r)return t.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(33777===r)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(33778===r)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(33779===r)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else {if(i=Ve(e,"WEBGL_compressed_texture_s3tc"),null===i)return null;if(33776===r)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===r)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===r)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===r)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===r||35841===r||35842===r||35843===r){const t=Ve(e,"WEBGL_compressed_texture_pvrtc");if(null===t)return null;if(35840===r)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===r)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===r)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===r)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===r){const t=Ve(e,"WEBGL_compressed_texture_etc1");return null!==t?t.COMPRESSED_RGB_ETC1_WEBGL:null}if(37492===r||37496===r){const t=Ve(e,"WEBGL_compressed_texture_etc");if(null===t)return null;if(37492===r)return 3001===s?t.COMPRESSED_SRGB8_ETC2:t.COMPRESSED_RGB8_ETC2;if(37496===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC}if(37808===r||37809===r||37810===r||37811===r||37812===r||37813===r||37814===r||37815===r||37816===r||37817===r||37818===r||37819===r||37820===r||37821===r){const t=Ve(e,"WEBGL_compressed_texture_astc");if(null===t)return null;if(37808===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:t.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:t.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:t.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:t.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:t.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:t.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:t.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:t.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:t.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:t.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:t.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:t.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:t.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===r)return 3001===s?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:t.COMPRESSED_RGBA_ASTC_12x12_KHR}if(36492===r){const t=Ve(e,"EXT_texture_compression_bptc");if(null===t)return null;if(36492===r)return 3001===s?t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:t.COMPRESSED_RGBA_BPTC_UNORM_EXT}return 1020===r?e.UNSIGNED_INT_24_8:1e3===r?e.REPEAT:1001===r?e.CLAMP_TO_EDGE:1004===r||1005===r?e.NEAREST_MIPMAP_LINEAR:1007===r?e.LINEAR_MIPMAP_NEAREST:1008===r?e.LINEAR_MIPMAP_LINEAR:1003===r?e.NEAREST:1006===r?e.LINEAR:null}const Qa=new Uint8Array([0,0,0,1]);class qa{constructor({gl:e,target:t,format:s,type:i,wrapS:r,wrapT:o,wrapR:n,preloadColor:a,premultiplyAlpha:h,flipY:l}){this.gl=e,this.target=t||e.TEXTURE_2D,this.format=s||1023,this.type=i||1009,this.internalFormat=null,this.premultiplyAlpha=!!h,this.flipY=!!l,this.unpackAlignment=4,this.wrapS=r||1e3,this.wrapT=o||1e3,this.wrapR=n||1e3,this.texture=e.createTexture(),a&&this.setPreloadColor(a),this.allocated=!0;}setPreloadColor(e){e?(Qa[0]=Math.floor(255*e[0]),Qa[1]=Math.floor(255*e[1]),Qa[2]=Math.floor(255*e[2]),Qa[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(Qa[0]=0,Qa[1]=0,Qa[2]=0,Qa[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),this.target===t.TEXTURE_CUBE_MAP){const e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let s=0,i=e.length;s<i;s++)t.texImage2D(e[s],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Qa);}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Qa);t.bindTexture(this.target,null);}setTarget(e){this.target=e||this.gl.TEXTURE_2D;}setImage(e,t={}){const s=this.gl;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR);let i=!1;s.bindTexture(this.target,this.texture),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,this.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,this.unpackAlignment),s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,s.NONE);const r=Za(s,this.minFilter);s.texParameteri(this.target,s.TEXTURE_MIN_FILTER,r),r!==s.NEAREST_MIPMAP_NEAREST&&r!==s.LINEAR_MIPMAP_NEAREST&&r!==s.NEAREST_MIPMAP_LINEAR&&r!==s.LINEAR_MIPMAP_LINEAR||(i=!0);const o=Za(s,this.magFilter);o&&s.texParameteri(this.target,s.TEXTURE_MAG_FILTER,o);const n=Za(s,this.wrapS);n&&s.texParameteri(this.target,s.TEXTURE_WRAP_S,n);const a=Za(s,this.wrapT);a&&s.texParameteri(this.target,s.TEXTURE_WRAP_T,a);const h=Za(s,this.format,this.encoding),l=Za(s,this.type),u=$a(s,this.internalFormat,h,l,this.encoding,!1);if(this.target===s.TEXTURE_CUBE_MAP){if(b.isArray(e)){const t=e,i=[s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Y,s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let e=0,r=i.length;e<r;e++)s.texImage2D(i[e],0,u,h,l,t[e]);}}else s.texImage2D(s.TEXTURE_2D,0,u,h,l,e);i&&s.generateMipmap(this.target),s.bindTexture(this.target,null);}setCompressedData({mipmaps:e,props:t={}}){const s=this.gl,i=e.length;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR),s.activeTexture(s.TEXTURE0+0),s.bindTexture(this.target,this.texture);let r=e.length>1;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,this.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,this.unpackAlignment),s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,s.NONE);const o=Za(s,this.wrapS);o&&s.texParameteri(this.target,s.TEXTURE_WRAP_S,o);const n=Za(s,this.wrapT);if(n&&s.texParameteri(this.target,s.TEXTURE_WRAP_T,n),this.type===s.TEXTURE_3D||this.type===s.TEXTURE_2D_ARRAY){const e=Za(s,this.wrapR);e&&s.texParameteri(this.target,s.TEXTURE_WRAP_R,e),s.texParameteri(this.type,s.TEXTURE_WRAP_R,e);}r?(s.texParameteri(this.target,s.TEXTURE_MIN_FILTER,eh(s,this.minFilter)),s.texParameteri(this.target,s.TEXTURE_MAG_FILTER,eh(s,this.magFilter))):(s.texParameteri(this.target,s.TEXTURE_MIN_FILTER,Za(s,this.minFilter)),s.texParameteri(this.target,s.TEXTURE_MAG_FILTER,Za(s,this.magFilter)));const a=Za(s,this.format,this.encoding),h=Za(s,this.type),l=$a(s,this.internalFormat,a,h,this.encoding,!1);s.texStorage2D(s.TEXTURE_2D,i,l,e[0].width,e[0].height);for(let t=0,i=e.length;t<i;t++){const i=e[t];1023!==this.format?null!==a?s.compressedTexSubImage2D(s.TEXTURE_2D,t,0,0,i.width,i.height,a,i.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):s.texSubImage2D(s.TEXTURE_2D,t,0,0,i.width,i.height,a,h,i.data);}s.bindTexture(this.target,null);}setProps(e){const t=this.gl;t.bindTexture(this.target,this.texture),this._uploadProps(e),t.bindTexture(this.target,null);}_uploadProps(e){const t=this.gl;if(void 0!==e.format&&(this.format=e.format),void 0!==e.internalFormat&&(this.internalFormat=e.internalFormat),void 0!==e.encoding&&(this.encoding=e.encoding),void 0!==e.type&&(this.type=e.type),void 0!==e.minFilter){const s=Za(t,e.minFilter);s&&(this.minFilter=e.minFilter,t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,s),s!==t.NEAREST_MIPMAP_NEAREST&&s!==t.LINEAR_MIPMAP_NEAREST&&s!==t.NEAREST_MIPMAP_LINEAR&&s!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target));}if(void 0!==e.magFilter){const s=Za(t,e.magFilter);s&&(this.magFilter=e.magFilter,t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,s));}if(void 0!==e.wrapS){const s=Za(t,e.wrapS);s&&(this.wrapS=e.wrapS,t.texParameteri(this.target,t.TEXTURE_WRAP_S,s));}if(void 0!==e.wrapT){const s=Za(t,e.wrapT);s&&(this.wrapT=e.wrapT,t.texParameteri(this.target,t.TEXTURE_WRAP_T,s));}}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return !1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null);}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null);}}function $a(e,t,s,i,r,o=!1){if(null!==t){if(void 0!==e[t])return e[t];console.warn("Attempt to use non-existing WebGL internal format '"+t+"'");}let n=s;return s===e.RED&&(i===e.FLOAT&&(n=e.R32F),i===e.HALF_FLOAT&&(n=e.R16F),i===e.UNSIGNED_BYTE&&(n=e.R8)),s===e.RG&&(i===e.FLOAT&&(n=e.RG32F),i===e.HALF_FLOAT&&(n=e.RG16F),i===e.UNSIGNED_BYTE&&(n=e.RG8)),s===e.RGBA&&(i===e.FLOAT&&(n=e.RGBA32F),i===e.HALF_FLOAT&&(n=e.RGBA16F),i===e.UNSIGNED_BYTE&&(n=3001===r&&!1===o?e.SRGB8_ALPHA8:e.RGBA8),i===e.UNSIGNED_SHORT_4_4_4_4&&(n=e.RGBA4),i===e.UNSIGNED_SHORT_5_5_5_1&&(n=e.RGB5_A1)),n!==e.R16F&&n!==e.R32F&&n!==e.RG16F&&n!==e.RG32F&&n!==e.RGBA16F&&n!==e.RGBA32F||Ve(e,"EXT_color_buffer_float"),n}function eh(e,t){return 1003===t||1004===t||1005===t?e.NEAREST:e.LINEAR}class th{constructor(e){this.id=e.id,this.texture=e.texture;}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);}}class ih{constructor(e,t,s){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=s;}itemStart(e){this.itemsTotal++,!1===this.isLoading&&void 0!==this.onStart&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0;}itemEnd(e){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad());}itemError(e){void 0!==this.onError&&this.onError(e);}resolveURL(e){return this.urlModifier?this.urlModifier(e):e}setURLModifier(e){return this.urlModifier=e,this}addHandler(e,t){return this.handlers.push(e,t),this}removeHandler(e){const t=this.handlers.indexOf(e);return -1!==t&&this.handlers.splice(t,2),this}getHandler(e){for(let t=0,s=this.handlers.length;t<s;t+=2){const s=this.handlers[t],i=this.handlers[t+1];if(s.global&&(s.lastIndex=0),s.test(e))return i}return null}}const rh=new ih;class oh{constructor(e){this.manager=void 0!==e?e:rh,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={};}load(){}loadAsync(e,t){const s=this;return new Promise((function(i,r){s.load(e,i,t,r);}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}class nh{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0;}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t;}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return -1}_onMessage(e,t){const s=this.workersResolve[e];if(s&&s(t),this.queue.length){const{resolve:t,msg:s,transfer:i}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(s,i);}else this.workerStatus^=1<<e;}setWorkerCreator(e){this.workerCreator=e;}setWorkerLimit(e){this.pool=e;}postMessage(e,t){return new Promise((s=>{const i=this._getIdleWorker();-1!==i?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=s,this.workers[i].postMessage(e,t)):this.queue.push({resolve:s,msg:e,transfer:t});}))}destroy(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0;}}const hh={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t);},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e];},clear:function(){this.files={};}},lh={};class uh extends oh{constructor(e){super(e);}load(e,t,s,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=hh.get(e);if(void 0!==r)return this.manager.itemStart(e),setTimeout((()=>{t&&t(r),this.manager.itemEnd(e);}),0),r;if(void 0!==lh[e])return void lh[e].push({onLoad:t,onProgress:s,onError:i});lh[e]=[],lh[e].push({onLoad:t,onProgress:s,onError:i});const o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),n=this.mimeType,a=this.responseType;fetch(o).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body.getReader)return t;const s=lh[e],i=t.body.getReader(),r=t.headers.get("Content-Length"),o=r?parseInt(r):0,n=0!==o;let a=0;const h=new ReadableStream({start(e){!function t(){i.read().then((({done:i,value:r})=>{if(i)e.close();else {a+=r.byteLength;const i=new ProgressEvent("progress",{lengthComputable:n,loaded:a,total:o});for(let e=0,t=s.length;e<t;e++){const t=s[e];t.onProgress&&t.onProgress(i);}e.enqueue(r),t();}}));}();}});return new Response(h)}throw Error(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`)})).then((e=>{switch(a){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,n)));case"json":return e.json();default:if(void 0===n)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(n),s=t&&t[1]?t[1].toLowerCase():void 0,i=new TextDecoder(s);return e.arrayBuffer().then((e=>i.decode(e)))}}})).then((t=>{hh.add(e,t);const s=lh[e];delete lh[e];for(let e=0,i=s.length;e<i;e++){const i=s[e];i.onLoad&&i.onLoad(t);}})).catch((t=>{const s=lh[e];if(void 0===s)throw this.manager.itemError(e),t;delete lh[e];for(let e=0,i=s.length;e<i;e++){const i=s[e];i.onError&&i.onError(t);}this.manager.itemError(e);})).finally((()=>{this.manager.itemEnd(e);})),this.manager.itemStart(e);}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}let ch=0;class ph{constructor({viewer:e,transcoderPath:t,workerLimit:s}){this._transcoderPath=t||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new nh,this._workerSourceURL="",s&&this._workerPool.setWorkerLimit(s);const i=e.capabilities;this._workerConfig={astcSupported:i.astcSupported,etc1Supported:i.etc1Supported,etc2Supported:i.etc2Supported,dxtSupported:i.dxtSupported,bptcSupported:i.bptcSupported,pvrtcSupported:i.pvrtcSupported},this._supportedFileTypes=["xkt2"];}_init(){if(!this._transcoderPending){const e=new uh;e.setPath(this._transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),s=new uh;s.setPath(this._transcoderPath),s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials);const i=s.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([t,i]).then((([e,t])=>{const s=ph.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(ph.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(ph.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(ph.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this._workerSourceURL=URL.createObjectURL(new Blob([i])),this._transcoderBinary=t,this._workerPool.setWorkerCreator((()=>{const e=new Worker(this._workerSourceURL),t=this._transcoderBinary.slice(0);return e.postMessage({type:"init",config:this._workerConfig,transcoderBinary:t},[t]),e}));})),ch>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),ch++;}return this._transcoderPending}transcode(e,t,s={}){return new Promise(((i,r)=>{const o=s;this._init().then((()=>this._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:o},e))).then((e=>{const s=e.data,{mipmaps:o,width:n,height:a,format:h,type:l,error:u,dfdTransferFn:c,dfdFlags:p}=s;if("error"===l)return r(u);t.setCompressedData({mipmaps:o,props:{format:h,minFilter:1===o.length?1006:1008,magFilter:1===o.length?1006:1008,encoding:2===c?3001:3e3,premultiplyAlpha:!!(1&p)}}),i();}));}))}destroy(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),ch--;}}ph.BasisFormat={ETC1S:0,UASTC_4x4:1},ph.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},ph.EngineFormat={RGBAFormat:1023,RGBA_ASTC_4x4_Format:37808,RGBA_BPTC_Format:36492,RGBA_ETC2_EAC_Format:37496,RGBA_PVRTC_4BPPV1_Format:35842,RGBA_S3TC_DXT5_Format:33779,RGB_ETC1_Format:36196,RGB_ETC2_Format:37492,RGB_PVRTC_4BPPV1_Format:35840,RGB_S3TC_DXT1_Format:33776},ph.BasisWorker=function(){let e,t,s;const i=_EngineFormat,r=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",(function(n){const u=n.data;switch(u.type){case"init":e=u.config,c=u.transcoderBinary,t=new Promise((e=>{s={wasmBinary:c,onRuntimeInitialized:e},BASIS(s);})).then((()=>{s.initializeBasis(),void 0===s.KTX2File&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.");}));break;case"transcode":t.then((()=>{try{const{width:t,height:n,hasAlpha:c,mipmaps:p,format:d,dfdTransferFn:f,dfdFlags:m}=function(t){const n=new s.KTX2File(new Uint8Array(t));function u(){n.close(),n.delete();}if(!n.isValid())throw u(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");const c=n.isUASTC()?o.UASTC_4x4:o.ETC1S,p=n.getWidth(),d=n.getHeight(),f=n.getLevels(),m=n.getHasAlpha(),g=n.getDFDTransferFunc(),_=n.getDFDFlags(),{transcoderFormat:y,engineFormat:v}=function(t,s,n,u){let c,p;const d=t===o.ETC1S?a:h;for(let i=0;i<d.length;i++){const r=d[i];if(e[r.if]&&(r.basisFormat.includes(t)&&!(u&&r.transcoderFormat.length<2)&&(!r.needsPowerOfTwo||l(s)&&l(n))))return c=r.transcoderFormat[u?1:0],p=r.engineFormat[u?1:0],{transcoderFormat:c,engineFormat:p}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),c=r.RGBA32,p=i.RGBAFormat,{transcoderFormat:c,engineFormat:p}}(c,p,d,m);if(!p||!d||!f)throw u(),new Error("KTX2TextureTranscoder: Invalid texture");if(!n.startTranscoding())throw u(),new Error("KTX2TextureTranscoder: .startTranscoding failed");const b=[];for(let e=0;e<f;e++){const t=n.getImageLevelInfo(e,0,0),s=t.origWidth,i=t.origHeight,r=new Uint8Array(n.getImageTranscodedSizeInBytes(e,0,0,y));if(!n.transcodeImage(r,e,0,0,y,0,-1,-1))throw u(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");b.push({data:r,width:s,height:i});}return u(),{width:p,height:d,hasAlpha:m,mipmaps:b,format:v,dfdTransferFn:g,dfdFlags:_}}(u.buffers[0]),g=[];for(let e=0;e<p.length;++e)g.push(p[e].data.buffer);self.postMessage({type:"transcode",id:u.id,width:t,height:n,hasAlpha:c,mipmaps:p,format:d,dfdTransferFn:f,dfdFlags:m},g);}catch(e){console.error(`[KTX2TextureTranscoder.BasisWorker]: ${e}`),self.postMessage({type:"error",id:u.id,error:e.message});}}));}var c;}));const n=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[r.ASTC_4x4,r.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.BC7_M5,r.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.BC1,r.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.ETC1,r.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.PVRTC1_4_RGB,r.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=n.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),h=n.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function l(e){return e<=2||0==(e&e-1)&&0!==e}};const dh={};function fh(e){const t=e.scene.id;let s=dh[t];return s||(s=new ph({viewer:e}),dh[t]=s,e.scene.on("destroyed",(()=>{delete dh[t],s.destroy();}))),s}const mh=f.vec3(),gh=f.mat4(),_h=f.vec3([1,1,1]),yh=f.vec3([0,0,0]),vh=f.vec3([0,0,0]),bh=f.identityQuaternion();class wh extends B{constructor(e,t={}){super(e,t),this._textureTranscoder=t.textureTranscoder||fh(this.scene.viewer),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this._aabb=f.collapseAABB3(),this._aabbDirty=!1,this._layerList=[],this._nodeList=[],this._lastOrigin=null,this._lastPositionsDecodeMatrix=null,this._lastNormals=null,this._instancingLayers={},this._currentBatchingLayers={},this._scratchMemory=(gr++,mr),this._geometries={},this._textures={},this._textureSets={},this._meshes={},this._nodes={},this.renderFlags=new Li,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=t.edgeThreshold||10,this._origin=f.vec3(t.origin||[0,0,0]),this._position=f.vec3(t.position||[0,0,0]),this._rotation=f.vec3(t.rotation||[0,0,0]),this._quaternion=f.vec4(t.quaternion||[0,0,0,1]),t.rotation&&f.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=f.vec3(t.scale||[1,1,1]),this._worldMatrix=f.mat4(),f.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=f.mat4(),f.inverseMat4(this._worldMatrix,this._worldNormalMatrix),f.transposeMat4(this._worldNormalMatrix),(t.matrix||t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=f.mat4(),this._viewNormalMatrix=f.mat4(),this._viewMatrixDirty=!0,this._worldMatrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==t.saoEnabled,this._pbrEnabled=!1!==t.pbrEnabled,this._colorTextureEnabled=!1!==t.colorTextureEnabled,this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewMatrixDirty=!0;})),this._createDefaultTextureSet(),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.backfaces=t.backfaces;}_createDefaultTextureSet(){const e=new th({id:"defaultColorTexture",texture:new qa({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),t=new th({id:"defaultMetalRoughTexture",texture:new qa({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),s=new th({id:"defaultNormalsTexture",texture:new qa({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),i=new th({id:"defaultEmissiveTexture",texture:new qa({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),r=new th({id:"defaultOcclusionTexture",texture:new qa({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures.defaultColorTexture=e,this._textures.defaultMetalRoughTexture=t,this._textures.defaultNormalsTexture=s,this._textures.defaultEmissiveTexture=i,this._textures.defaultOcclusionTexture=r,this._textureSets.defaultTextureSet=new Ka({id:"defaultTextureSet",model:this,colorTexture:e,metallicRoughnessTexture:t,normalsTexture:s,emissiveTexture:i,occlusionTexture:r});}get isPerformanceModel(){return !0}get objects(){return this._nodes}get origin(){return this._origin}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(f.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),f.inverseMat4(this._viewMatrix,this._viewNormalMatrix),f.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(f.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),f.inverseMat4(this._viewMatrix,this._viewNormalMatrix),f.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw();}get entityList(){return this._nodeList}get isEntity(){return !0}get isModel(){return this._isModel}get isObject(){return !1}get aabb(){return this._aabbDirty&&this._rebuildAABB(),this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=!1!==e,this._visible=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].visible=e;this.glRedraw();}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].xrayed=e;this.glRedraw();}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].highlighted=e;this.glRedraw();}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].selected=e;this.glRedraw();}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].edges=e;this.glRedraw();}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].culled=e;this.glRedraw();}get clippable(){return this._clippable}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].clippable=e;this.glRedraw();}get collidable(){return this._collidable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].collidable=e;}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].pickable=e;}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].colorize=e;}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let t=0,s=this._nodeList.length;t<s;t++)this._nodeList[t].opacity=e;}get castsShadow(){return this._castsShadow}set castsShadow(e){(e=!1!==e)!==this._castsShadow&&(this._castsShadow=e,this.glRedraw());}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw());}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get colorTextureEnabled(){return this._colorTextureEnabled}get isDrawable(){return !0}get isStateSortable(){return !1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createGeometry(e){const t=e.id;if(null==t)return void this.error("Config missing: id");if(this._geometries[t])return void this.error("Geometry already created: "+t);const s=e.primitive;if(null==s)return void this.error("Param expected: primitive");if("points"!==s&&"lines"!==s&&"triangles"!==s&&"solid"!==s&&"surface"!==s)return void this.error(`Unsupported value for 'primitive': '${s}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`);if(!e.positions&&!e.positionsCompressed)return this.error("Param expected: `positions` or `positionsCompressed'"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix)return this.error("Param expected: `positionsDecodeMatrix` (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!e.indices&&"points"!==s)return this.error(`Param expected: indices (required for '${s}' primitive type)`),null;const i=new Ja(t,this,e);this._geometries[t]=i,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++;}createTexture(e){const t=e.id;if(null==t)return void this.error("Config missing: id");if(this._textures[t])return void this.error("Texture already created: "+t);if(!e.src&&!e.image&&!e.buffers)return this.error("Param expected: `src`, `image' or 'buffers'"),null;let s=e.minFilter||1008;1006!==s&&1007!==s&&1008!==s&&1005!==s&&1004!==s&&(this.error("[createTexture] Unsupported value for 'minFilter' - \n            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, \n            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter."),s=1008);let i=e.magFilter||1006;1006!==i&&1003!==i&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),i=1006);let r=e.wrapS||1e3;1001!==r&&1002!==r&&1e3!==r&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),r=1e3);let o=e.wrapT||1e3;1001!==o&&1002!==o&&1e3!==o&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=1e3);let n=e.encoding||3e3;3e3!==n&&3001!==n&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),n=3e3);const a=new qa({gl:this.scene.canvas.gl});if(e.preloadColor&&a.setPreloadColor(e.preloadColor),e.image){const t=e.image;t.crossOrigin="Anonymous",a.setImage(t,{minFilter:s,magFilter:i,wrapS:r,wrapT:o,flipY:e.flipY,encoding:n});}else if(e.src){const t=e.src.split(".").pop();switch(t){case"jpeg":case"jpg":case"png":case"gif":const h=new Image;h.onload=()=>{a.setImage(h,{minFilter:s,magFilter:i,wrapS:r,wrapT:o,flipY:e.flipY,encoding:n});},h.src=e.src;break;default:this._textureTranscoder?b.loadArraybuffer(e.src,(e=>{e.byteLength?this._textureTranscoder.transcode([e],a).then((()=>{this.glRedraw();})):this.error("Can't create texture from 'src': file data is zero length");}),(function(e){this.error(`Can't create texture from 'src': ${e}`);})):this.error(`Can't create texture from 'src' - VBOSceneModel needs to be configured with a TextureTranscoder for this file type ('${t}')`);}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,a).then((()=>{this.glRedraw();})):this.error("Can't create texture from 'buffers' - VBOSceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[t]=new th({id:t,texture:a});}createTextureSet(e){const t=e.id;if(null==t)return void this.error("Config missing: id");if(this._textureSets[t])return void this.error(`Texture set already created: ${t}`);let s,i,r,o,n;if(void 0!==e.colorTextureId&&null!==e.colorTextureId){if(s=this._textures[e.colorTextureId],!s)return void this.error(`Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`)}else s=this._textures.defaultColorTexture;if(void 0!==e.metallicRoughnessTextureId&&null!==e.metallicRoughnessTextureId){if(i=this._textures[e.metallicRoughnessTextureId],!i)return void this.error(`Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`)}else i=this._textures.defaultMetalRoughTexture;if(void 0!==e.normalsTextureId&&null!==e.normalsTextureId){if(r=this._textures[e.normalsTextureId],!r)return void this.error(`Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`)}else r=this._textures.defaultNormalsTexture;if(void 0!==e.emissiveTextureId&&null!==e.emissiveTextureId){if(o=this._textures[e.emissiveTextureId],!o)return void this.error(`Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`)}else o=this._textures.defaultEmissiveTexture;if(void 0!==e.occlusionTextureId&&null!==e.occlusionTextureId){if(n=this._textures[e.occlusionTextureId],!n)return void this.error(`Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`)}else n=this._textures.defaultOcclusionTexture;const a=new Ka({id:t,model:this,colorTexture:s,metallicRoughnessTexture:i,normalsTexture:r,emissiveTexture:o,occlusionTexture:n});this._textureSets[t]=a;}createMesh(e){let t=e.id;if(null==t)return void this.error("Config missing: id");if(this._meshes[t])return void this.error(`VBOSceneModel already has a mesh with this ID: ${t}`);const s=e.geometryId,i=void 0!==e.geometryId;if(i&&!this._geometries[e.geometryId])return void this.error(`Geometry not found: ${e.geometryId} - ensure that you create it first with createGeometry()`);const r=e.textureSetId||"defaultTextureSet";if(r&&!this._textureSets[r])return void this.error(`Texture set not found: ${r} - ensure that you create it first with createTextureSet()`);let o;const n=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],a=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,h=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,l=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,u=new fr(this,t,n,a),c=u.pickId,p=new Uint8Array([255&c,c>>8&255,c>>16&255,c>>24&255]),d=f.collapseAABB3();let m;if(i){let t,i=this._worldMatrixNonIdentity?this._worldMatrix:null;if(e.matrix)t=e.matrix;else {const s=e.scale||_h,i=e.position||yh,r=e.rotation||vh;f.eulerToQuaternion(r,"XYZ",bh),t=f.composeMat4(i,bh,s,gh);}const c=e.origin||e.rtcCenter,g=c?f.addVec3(this._origin,c,mh):this._origin,_=this._getInstancingLayer(g,r,s);m=_,o=_.createPortion({color:n,metallic:h,roughness:l,opacity:a,meshMatrix:t,worldMatrix:i,aabb:d,pickColor:p}),f.expandAABB3(this._aabb,d);const y=Math.round(_.numIndices/3);this._numTriangles+=y,u.numTriangles=y,u.origin=g;}else {let t=e.primitive;if(null==t&&(t="triangles"),"points"!==t&&"lines"!==t&&"triangles"!==t&&"solid"!==t&&"surface"!==t)return void this.error(`Unsupported value for 'primitive': '${t}'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.`);if(!e.positions&&!e.positionsCompressed)return this.error("Param expected: 'positions' or 'positionsCompressed'  ('geometryId' is absent)"),null;if(e.positions&&e.positionsCompressed)return this.error("Only one param expected, not both: 'positions' or 'positionsCompressed' ('geometryId' is absent)"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix)return this.error("Param expected: 'positionsDecodeMatrix' (required for 'positionsCompressed'; 'geometryId' is absent)"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: `uvDecodeMatrix` (required for `uvCompressed'; 'geometryId' is absent)"),null;if(!e.indices&&"points"!==t)return this.error(`Param expected: indices (required for '${t}' primitive type)`),null;if(!e.indices&&"points"!==t)return this.error("Config expected: indices (no meshIds provided, so expecting geometry arrays instead)"),null;let s=e.indices,i=e.edgeIndices,c=e.origin||e.rtcCenter?f.addVec3(this._origin,e.origin||e.rtcCenter,mh):this._origin,g=e.positions;if(g){const e=f.vec3(),t=[];Y(g,t,e)&&(g=t,c=f.addVec3(c,e,e));}let _=!1;if(this._lastOrigin?f.compareVec3(this._lastOrigin,c)||(_=!0,this._lastOrigin.set(c)):(_=!0,this._lastOrigin=f.vec3(c)),e.positionsDecodeMatrix&&(this._lastPositionsDecodeMatrix?f.compareMat4(this._lastPositionsDecodeMatrix,e.positionsDecodeMatrix)||(_=!0,this._lastPositionsDecodeMatrix.set(e.positionsDecodeMatrix)):(_=!0,this._lastPositionsDecodeMatrix=f.mat4(e.positionsDecodeMatrix))),e.uvDecodeMatrix&&(this._lastUVDecodeMatrix?f.compareMat4(this._lastUVDecodeMatrix,e.uvDecodeMatrix)||(_=!0,this._lastUVDecodeMatrix.set(e.uvDecodeMatrix)):(_=!0,this._lastUVDecodeMatrix=f.mat4(e.uvDecodeMatrix))),e.textureSetId&&this._lastTextureSetId!==e.textureSetId&&(_=!0,this._lastTextureSetId=e.textureSetId),_){for(let e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].finalize();this._currentBatchingLayers={};}const y=!!e.normals&&e.normals.length>0;"triangles"!==t&&"solid"!==t&&"surface"!==t||(null!==this._lastNormals&&y!==this._lastNormals&&["triangles","solid","surface"].map((e=>{this._currentBatchingLayers[e]&&(this._currentBatchingLayers[e].finalize(),delete this._currentBatchingLayers[e]);})),this._lastNormals=y);const v=this._worldMatrixNonIdentity?this._worldMatrix:null;let b;if(!e.positionsDecodeMatrix)if(e.matrix)b=e.matrix;else {const t=e.scale||_h,s=e.position||yh,i=e.rotation||vh;f.eulerToQuaternion(i,"XYZ",bh),b=f.composeMat4(s,bh,t,gh);}const w=r?this._textureSets[r]:null;m=this._currentBatchingLayers[t];const P=(g||e.positionsCompressed).length;switch(t){case"triangles":case"solid":case"surface":m&&(m.canCreatePortion(P,s.length)||(m.finalize(),delete this._currentBatchingLayers[t],m=null)),m||(m=new Oo({model:this,textureSet:w,layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:c,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===t,autoNormals:!y}),this._layerList.push(m),this._currentBatchingLayers[t]=m),i||(i=mt(g||e.positionsCompressed,s,null,this._edgeThreshold)),o=m.createPortion({positions:g,positionsCompressed:e.positionsCompressed,normals:e.normals,normalsCompressed:e.normalsCompressed,colors:e.colors,colorsCompressed:e.colorsCompressed,uv:e.uv,uvCompressed:e.uvCompressed,indices:s,edgeIndices:i,color:n,opacity:a,metallic:h,roughness:l,meshMatrix:b,worldMatrix:v,worldAABB:d,pickColor:p});const r=Math.round(s.length/3);this._numTriangles+=r,u.numTriangles=r;break;case"lines":m&&(m.canCreatePortion(P,s.length)||(m.finalize(),delete this._currentBatchingLayers[t],m=null)),m||(m=new Xn({model:this,layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:c,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(m),this._currentBatchingLayers[t]=m),o=m.createPortion({positions:g,positionsCompressed:e.positionsCompressed,indices:s,colors:e.colors,colorsCompressed:e.colorsCompressed,color:n,opacity:a,meshMatrix:b,worldMatrix:v,worldAABB:d,pickColor:p}),this._numLines+=Math.round(s.length/2);break;case"points":m&&(m.canCreatePortion(P)||(m.finalize(),delete this._currentBatchingLayers[t],m=null)),m||(m=new Ma({model:this,layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:c,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(m),this._currentBatchingLayers[t]=m),o=m.createPortion({positions:g,positionsCompressed:e.positionsCompressed,colors:e.colors,colorsCompressed:e.colorsCompressed,color:n,opacity:a,meshMatrix:b,worldMatrix:v,worldAABB:d,pickColor:p}),this._numPoints+=Math.round(P/3);}f.expandAABB3(this._aabb,d),this.numGeometries++,u.origin=c;}u.parent=null,u._layer=m,u._portionId=o,u.aabb=d,this._meshes[t]=u;}_getInstancingLayer(e,t,s){const i=`${e[0]}.${e[1]}.${e[2]}.${t}.${s}`;let r,o=this._instancingLayers[i];if(o)return o;if(void 0!==t&&(r=this._textureSets[t],!r))return void this.error(`TextureSet not found: ${t} - ensure that you create it first with createTextureSet()`);const n=this._geometries[s];if(this._geometries[s]){switch(n.primitive){case"triangles":case"surface":o=new Sn({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0,solid:!1});break;case"solid":o=new Sn({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0,solid:!0});break;case"lines":o=new ra({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0});break;case"points":o=new Ya({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0});}return this._instancingLayers[i]=o,this._layerList.push(o),o}this.error(`Geometry not found: ${s} - ensure that you create it first with createGeometry()`);}createEntity(e){let t=e.id;void 0===t?t=f.createUUID():this.scene.components[t]&&(this.error("Scene already has a Component with this ID: "+t+" - will assign random ID"),t=f.createUUID());const s=e.meshIds;if(void 0===s)return void this.error("Config missing: meshIds");let i=[];for(let e=0,t=s.length;e<t;e++){const t=s[e],r=this._meshes[t];r?r.parent?this.error("Mesh with ID "+t+" already belongs to object with ID "+r.parent.id+" - ignoring this mesh"):i.push(r):this.error("Mesh with this ID not found: "+t+" - ignoring this mesh");}let r,o=0;if(this._visible&&!1!==e.visible&&(o|=E),this._pickable&&!1!==e.pickable&&(o|=R),this._culled&&!1!==e.culled&&(o|=S),this._clippable&&!1!==e.clippable&&(o|=O),this._collidable&&!1!==e.collidable&&(o|=L),this._edges&&!1!==e.edges&&(o|=G),this._xrayed&&!1!==e.xrayed&&(o|=N),this._highlighted&&!1!==e.highlighted&&(o|=k),this._selected&&!1!==e.selected&&(o|=j),1===i.length)r=i[0].aabb;else {r=f.collapseAABB3();for(let e=0,t=i.length;e<t;e++)f.expandAABB3(r,i[e].aabb);}const n=new U(this,e.isObject,t,i,o,r);return this._nodeList.push(n),this._nodes[t]=n,this.numEntities++,n}finalize(){if(!this.destroyed){for(const e in this._instancingLayers)this._instancingLayers.hasOwnProperty(e)&&this._instancingLayers[e].finalize();for(let e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].finalize();this._currentBatchingLayers={};for(let e=0,t=this._nodeList.length;e<t;e++){this._nodeList[e]._finalize();}for(let e=0,t=this._nodeList.length;e<t;e++){this._nodeList[e]._finalize2();}this._layerList.sort(((e,t)=>e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0));for(let e=0,t=this._layerList.length;e<t;e++){this._layerList[e].layerIndex=e;}this.glRedraw(),this.scene._aabbDirty=!0;}}_rebuildAABB(){f.collapseAABB3(this._aabb);for(let e=0,t=this._nodeList.length;e<t;e++){const t=this._nodeList[e];f.expandAABB3(this._aabb,t.aabb);}this._aabbDirty=!1;}stateSortCompare(e,t){}rebuildRenderFlags(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags();}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this._layerList.length,e.numVisibleLayers=0;for(let t=0,s=this._layerList.length;t<s;t++){const s=this._layerList[t];this._getActiveSectionPlanesForLayer(s)&&(e.visibleLayers[e.numVisibleLayers++]=t);}}_getActiveSectionPlanesForLayer(e){const t=this.renderFlags,s=this.scene._sectionPlanesState.sectionPlanes,i=s.length,r=e.layerIndex*i;if(i>0)for(let e=0;e<i;e++){s[e].active?(t.sectionPlanesActivePerLayer[r+e]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[r+e]=!1;}return !0}_updateRenderFlags(){if(0===this.numVisibleLayerPortions)return;if(this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0);}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0));}if(this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0);}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0);}}drawColorOpaque(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawColorOpaque(t,e);}}drawColorTransparent(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawColorTransparent(t,e);}}drawDepth(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawDepth(t,e);}}drawNormals(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawNormals(t,e);}}drawSilhouetteXRayed(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawSilhouetteXRayed(t,e);}}drawSilhouetteHighlighted(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawSilhouetteHighlighted(t,e);}}drawSilhouetteSelected(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawSilhouetteSelected(t,e);}}drawEdgesColorOpaque(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawEdgesColorOpaque(t,e);}}drawEdgesColorTransparent(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawEdgesColorTransparent(t,e);}}drawEdgesXRayed(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawEdgesXRayed(t,e);}}drawEdgesHighlighted(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawEdgesHighlighted(t,e);}}drawEdgesSelected(e){const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawEdgesSelected(t,e);}}drawOcclusion(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawOcclusion(t,e);}}drawShadow(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawShadow(t,e);}}drawPickMesh(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawPickMesh(t,e);}}drawPickDepths(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawPickDepths(t,e);}}drawPickNormals(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let s=0,i=t.visibleLayers.length;s<i;s++){const i=t.visibleLayers[s];this._layerList[i].drawPickNormals(t,e);}}destroy(){for(let e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].destroy();this._currentBatchingLayers={},this.scene.camera.off(this._onCameraViewMatrix);for(let e=0,t=this._layerList.length;e<t;e++)this._layerList[e].destroy();for(let e=0,t=this._nodeList.length;e<t;e++)this._nodeList[e]._destroy();Object.entries(this._geometries).forEach((([e,t])=>{t.destroy();})),this._geometries={},this._textures={},this._textureSets={},this._meshes={},this._nodes={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==gr&&(gr--,0===gr&&mr._clear()),super.destroy();}}const Ph=f.vec4(4),Th=f.vec4(),xh=f.vec4(),Mh=f.vec3([1,0,0]),Dh=f.vec3([0,1,0]),Ah=f.vec3([0,0,1]),Ch=f.vec3(3),Ih=f.vec3(3),Fh=f.identityMat4();class Bh extends B{constructor(e,t={}){if(super(e,t),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=f.vec3(),this._quaternion=f.identityQuaternion(),this._rotation=f.vec3(),this._position=f.vec3(),this._offset=f.vec3(),this._localMatrix=f.identityMat4(),this._worldMatrix=f.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this.origin=t.origin,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.children){const e=t.children;for(let s=0,i=e.length;s<i;s++)this.addChild(e[s],t.inheritStates);}if(t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'");}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this));}get isEntity(){return !0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set origin(e){e?(this._origin||(this._origin=f.vec3()),this._origin.set(e)):this._origin&&(this._origin=null);for(let t=0,s=this._children.length;t<s;t++)this._children[t].origin=e;this.glRedraw();}get origin(){return this._origin}set rtcCenter(e){this.origin=e;}get rtcCenter(){return this.origin}get numTriangles(){return this._numTriangles}set visible(e){e=!1!==e,this._visible=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e);}get visible(){return this._visible}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e);}get xrayed(){return this._xrayed}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e);}get highlighted(){return this._highlighted}set selected(e){e=!!e,this._selected=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e);}get selected(){return this._selected}set edges(e){e=!!e,this._edges=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].edges=e;}get edges(){return this._edges}set culled(e){e=!!e,this._culled=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].culled=e;}get culled(){return this._culled}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].clippable=e;}get clippable(){return this._clippable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].collidable=e;}get collidable(){return this._collidable}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].pickable=e;}get pickable(){return this._pickable}set colorize(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(let e=0,s=this._children.length;e<s;e++)this._children[e].colorize=t;if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t);}}get colorize(){return this._colorize.slice(0,3)}set opacity(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1;for(let t=0,s=this._children.length;t<s;t++)this._children[t].opacity=e;if(this._isObject){const t=null!=e;this.scene._objectOpacityUpdated(this,t);}}get opacity(){return this._colorize[3]}set castsShadow(e){e=!!e,this._castsShadow=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].castsShadow=e;}get castsShadow(){return this._castsShadow}set receivesShadow(e){e=!!e,this._receivesShadow=e;for(let t=0,s=this._children.length;t<s;t++)this._children[t].receivesShadow=e;}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return !1}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this._children.length;e<t;e++)this._children[e].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e);}get offset(){return this._offset}get isNode(){return !0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty();}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty();}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)f.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,s=e.length;t<s;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1;}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._children)for(let t=0,s=e._children.length;t<s;t++)this._setSubtreeAABBsDirty(e._children[t]);}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0;}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=f.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else {let e;f.collapseAABB3(this._aabb);for(let t=0,s=this._children.length;t<s;t++)e=this._children[t],e.collidable&&f.expandAABB3(this._aabb,e.aabb);}this._aabbDirty=!1;}addChild(e,t){if(b.isNumeric(e)||b.isString(e)){const t=e;if(!(e=this.scene.component[t]))return void this.warn("Component not found: "+b.inQuotes(t));if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+t)}else {if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+e.id);if(e._parentNode){if(e._parentNode.id===this.id)return void this.warn("Already a child: "+e.id);e._parentNode.removeChild(e);}}if(e.id,e.scene.id===this.scene.id)return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e;this.error("Child not in same Scene: "+e.id);}removeChild(e){for(let t=0,s=this._children.length;t<s;t++)if(this._children[t].id===e.id)return e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=e.numTriangles)}removeChildren(){let e;for(let t=0,s=this._children.length;t<s;t++)e=this._children[t],e._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty();}get numChildren(){return this._children.length}get children(){return this._children}set parent(e){if(b.isNumeric(e)||b.isString(e)){const t=e;if(!(e=this.scene.components[t]))return void this.warn("Node not found: "+b.inQuotes(t));if(!e.isNode)return void this.error("Not a Node: "+e.id)}e.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===e.id?this.warn("Already a child of Node: "+e.id):e.addChild(this):this.error("Node not in same Scene: "+e.id);}get parent(){return this._parentNode}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),f.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),f.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=f.identityMat4()),this._localMatrix.set(e||Fh),f.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw();}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=f.identityMat4()),f.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return Ph[0]=e[0],Ph[1]=e[1],Ph[2]=e[2],Ph[3]=t*f.DEGTORAD,f.angleAxisToQuaternion(Ph,Th),f.mulQuaternions(this.quaternion,Th,xh),this.quaternion=xh,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Ph[0]=e[0],Ph[1]=e[1],Ph[2]=e[2],Ph[3]=t*f.DEGTORAD,f.angleAxisToQuaternion(Ph,Th),f.mulQuaternions(Th,this.quaternion,Th),this}rotateX(e){return this.rotate(Mh,e)}rotateY(e){return this.rotate(Dh,e)}rotateZ(e){return this.rotate(Ah,e)}translate(e,t){return f.vec3ApplyQuaternion(this.quaternion,e,Ch),f.mulVec3Scalar(Ch,t,Ih),f.addVec3(this.position,Ih,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(Mh,e)}translateY(e){return this.translate(Dh,e)}translateZ(e){return this.translate(Ah,e)}get type(){return "Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const e=this._children.splice();let t;for(let s=0,i=e.length;s<i;s++)t=e[s],t.destroy();}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0;}}const Sh=f.AABB3();function Hh(e){if(!Vh(e.width)||!Vh(e.height)){const t=document.createElement("canvas");t.width=Uh(e.width),t.height=Uh(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t;}return e}function Vh(e){return 0==(e&e-1)}function Uh(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class zh extends B{get type(){return "Texture"}constructor(e,t={}){super(e,t),this._state=new Xe({texture:new qa({gl:this.scene.canvas.gl}),matrix:f.identityMat4(),hasMatrix:t.translate&&(0!==t.translate[0]||0!==t.translate[1])||!!t.rotate||t.scale&&(0!==t.scale[0]||0!==t.scale[1]),minFilter:this._checkMinFilter(t.minFilter),magFilter:this._checkMagFilter(t.magFilter),wrapS:this._checkWrapS(t.wrapS),wrapT:this._checkWrapT(t.wrapT),flipY:this._checkFlipY(t.flipY),encoding:this._checkEncoding(t.encoding)}),this._src=null,this._image=null,this._translate=f.vec2([0,0]),this._scale=f.vec2([1,1]),this._rotate=f.vec2([0,0]),this._matrixDirty=!1,this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,t.src?this.src=t.src:t.image&&(this.image=t.image),g.memory.textures++;}_checkMinFilter(e){return 1006!==(e=e||1008)&&1007!==e&&1008!==e&&1005!==e&&1004!==e&&(this.error("Unsupported value for 'minFilter' - supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, NearestMipMapLinearFilter and LinearMipMapLinearFilter. Defaulting to LinearMipMapLinearFilter."),e=1008),e}_checkMagFilter(e){return 1006!==(e=e||1006)&&1003!==e&&(this.error("Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),e=1006),e}_checkWrapS(e){return 1001!==(e=e||1e3)&&1002!==e&&1e3!==e&&(this.error("Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=1e3),e}_checkWrapT(e){return 1001!==(e=e||1e3)&&1002!==e&&1e3!==e&&(this.error("Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=1e3),e}_checkFlipY(e){return !!e}_checkEncoding(e){return 3e3!==(e=e||3e3)&&3001!==e&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=3e3),e}_webglContextRestored(){this._state.texture=new qa({gl:this.scene.canvas.gl}),this._image?this.image=this._image:this._src&&(this.src=this._src);}_update(){const e=this._state;if(this._matrixDirty){let t,s;0===this._translate[0]&&0===this._translate[1]||(t=f.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(s=f.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?f.mulMat4(t,s):s),0!==this._rotate&&(s=f.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?f.mulMat4(t,s):s),t&&(e.matrix=t),this._matrixDirty=!1;}this.glRedraw();}set image(e){this._image=Hh(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._src=null,this.glRedraw();}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let s=new Image;s.onload=function(){s=Hh(s),t._state.texture.setImage(s,t._state),t.scene.loading--,t.glRedraw(),t.scene.canvas.spinner.processes--;},s.src=e,this._src=e,this._image=null;}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate();}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate();}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate());}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),g.memory.textures--;}}function Kh(e,t){if(!e)throw new Error(t||"loader assertion failed.")}const Jh=Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser),Zh="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Zh&&parseFloat(Zh[1]);function Qh(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}const qh={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},$h=qh.global||qh.self||qh.window||{},el="object"!=typeof process||"[object process]"!==String(process)||process.browser,tl="function"==typeof importScripts,sl="undefined"!=typeof window&&void 0!==window.orientation,il="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);function rl(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}il&&parseFloat(il[1]);class ol{constructor(e,t){rl(this,"name",void 0),rl(this,"workerThread",void 0),rl(this,"isRunning",void 0),rl(this,"result",void 0),rl(this,"_resolve",void 0),rl(this,"_reject",void 0),this.name=e,this.workerThread=t,this.isRunning=!0,this._resolve=()=>{},this._reject=()=>{},this.result=new Promise(((e,t)=>{this._resolve=e,this._reject=t;}));}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t});}done(e){Qh(this.isRunning),this.isRunning=!1,this._resolve(e);}error(e){Qh(this.isRunning),this.isRunning=!1,this._reject(e);}}const nl=new Map;function al(e){Qh(e.source&&!e.url||!e.source&&e.url);let t=nl.get(e.source||e.url);return t||(e.url&&(t=function(e){if(!e.startsWith("http"))return e;return hl((t=e,"try {\n  importScripts('".concat(t,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")));var t;}(e.url),nl.set(e.url,t)),e.source&&(t=hl(e.source),nl.set(e.source,t))),Qh(t),t}function hl(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function ll(e,t=!0,s){const i=s||new Set;if(e){if(ul(e))i.add(e);else if(ul(e.buffer))i.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const s in e)ll(e[s],t,i);}return void 0===s?Array.from(i):[]}function ul(e){return !!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}const cl=()=>{};class pl{static isSupported(){return "undefined"!=typeof Worker}constructor(e){rl(this,"name",void 0),rl(this,"source",void 0),rl(this,"url",void 0),rl(this,"terminated",!1),rl(this,"worker",void 0),rl(this,"onMessage",void 0),rl(this,"onError",void 0),rl(this,"_loadableURL","");const{name:t,source:s,url:i}=e;Qh(s||i),this.name=t,this.source=s,this.url=i,this.onMessage=cl,this.onError=e=>console.log(e),this.worker=this._createBrowserWorker();}destroy(){this.onMessage=cl,this.onError=cl,this.worker.terminate(),this.terminated=!0;}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||ll(e),this.worker.postMessage(e,t);}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=al({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"));},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0;},e.onmessageerror=e=>console.error(e),e}}class dl{constructor(e){rl(this,"name","unnamed"),rl(this,"source",void 0),rl(this,"url",void 0),rl(this,"maxConcurrency",1),rl(this,"maxMobileConcurrency",1),rl(this,"onDebug",(()=>{})),rl(this,"reuseWorkers",!0),rl(this,"props",{}),rl(this,"jobQueue",[]),rl(this,"idleQueue",[]),rl(this,"count",0),rl(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e);}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0;}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug);}async startJob(e,t=((e,t,s)=>e.done(s)),s=((e,t)=>e.error(t))){const i=new Promise((i=>(this.jobQueue.push({name:e,onMessage:t,onError:s,onStart:i}),this)));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const s=new ol(t.name,e);e.onMessage=e=>t.onMessage(s,e.type,e.payload),e.onError=e=>t.onError(s,e),t.onStart(s);try{await s.result;}finally{this.returnWorkerToQueue(e);}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob();}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new pl({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return sl?this.maxMobileConcurrency:this.maxConcurrency}}const fl={maxConcurrency:3,maxMobileConcurrency:1,onDebug:()=>{},reuseWorkers:!0};class ml{static isSupported(){return pl.isSupported()}static getWorkerFarm(e={}){return ml._workerFarm=ml._workerFarm||new ml({}),ml._workerFarm.setProps(e),ml._workerFarm}constructor(e){rl(this,"props",void 0),rl(this,"workerPools",new Map),this.props={...fl},this.setProps(e),this.workerPools=new Map;}destroy(){for(const e of this.workerPools.values())e.destroy();}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps());}getWorkerPool(e){const{name:t,source:s,url:i}=e;let r=this.workerPools.get(t);return r||(r=new dl({name:t,source:s,url:i}),r.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,r)),r}_getWorkerPoolProps(){return {maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}rl(ml,"_workerFarm",void 0);async function gl(e){if(e.startsWith("http")){const t=await fetch(e);return _l(await t.text())}return e.startsWith("/")||(e="".concat(process.cwd(),"/").concat(e)),require(e)}function _l(s,i="",r){var o,n;if("object"==typeof i&&(r=i,i=""),"string"!=typeof s)throw new Error("code must be a string, not ".concat(typeof s));const a=e._nodeModulePaths(t.dirname(i)),h=module.parent,l=new e(i,h);return l.filename=i,l.paths=[].concat((null===(o=r)||void 0===o?void 0:o.prependPaths)||[]).concat(a).concat((null===(n=r)||void 0===n?void 0:n.appendPaths)||[]),l._compile(s,i),h&&h.children&&h.children.splice(h.children.indexOf(l),1),l.exports}var yl=Object.freeze({__proto__:null,requireFromFile:gl,requireFromString:_l});const vl={};async function bl(e,t=null,s={}){return t&&(e=function(e,t,s){if(e.startsWith("http"))return e;const i=s.modules||{};if(i[e])return i[e];if(!el)return "modules/".concat(t,"/dist/libs/").concat(e);if(s.CDN)return Qh(s.CDN.startsWith("http")),"".concat(s.CDN,"/").concat(t,"@").concat("3.1.8","/dist/libs/").concat(e);if(tl)return "../src/libs/".concat(e);return "modules/".concat(t,"/src/libs/").concat(e)}(e,t,s)),vl[e]=vl[e]||async function(e){if(e.endsWith("wasm")){const t=await fetch(e);return await t.arrayBuffer()}if(!el)try{return yl&&gl&&await gl(e)}catch{return null}if(tl)return importScripts(e);const t=await fetch(e);return function(e,t){if(!el)return _l&&_l(e,t);if(tl)return eval.call($h,e),null;const s=document.createElement("script");s.id=t;try{s.appendChild(document.createTextNode(e));}catch(t){s.text=e;}return document.body.appendChild(s),null}(await t.text(),e)}(e),await vl[e]}function Al(e,t,s){const i=void 0!==s?new Uint8Array(e).subarray(t,t+s):new Uint8Array(e).subarray(t);return new Uint8Array(i).buffer}function Cl(e,t){return Kh(e>=0),Kh(t>0),e+(t-1)&~(t-1)}function Il(e,t,s){let i;if(e instanceof ArrayBuffer)i=new Uint8Array(e);else {const t=e.byteOffset,s=e.byteLength;i=new Uint8Array(e.buffer||e.arrayBuffer,t,s);}return t.set(i,s),s+Cl(i.byteLength,4)}const Yl={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},Kl=Yl.window||Yl.self||Yl.global,Jl=Yl.process||{},Zl="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source",Ql=!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(e){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return !0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return !0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,s=e||t;return !!(s&&s.indexOf("Electron")>=0)}();class ql{constructor(e,t,s="sessionStorage"){this.storage=function(e){try{const t=window[e],s="__storage_test__";return t.setItem(s,s),t.removeItem(s),t}catch(e){return null}}(s),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration();}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e);}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{};}return Object.assign(this.config,e),this}}function $l(e,t,s,i=600){const r=e.src.replace(/\(/g,"%28").replace(/\)/g,"%29");e.width>i&&(s=Math.min(s,i/e.width));const o=e.width*s,n=e.height*s,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(r,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return ["".concat(t," %c+"),a]}const eu={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function tu(e){return "string"==typeof e?eu[e.toUpperCase()]||eu.WHITE:e}function su(e,t){if(!e)throw new Error(t||"Assertion failed")}function iu(){let e;if(Ql&&Kl.performance)e=Kl.performance.now();else if(Jl.hrtime){const t=Jl.hrtime();e=1e3*t[0]+t[1]/1e6;}else e=Date.now();return e}const ru={debug:Ql&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},ou={enabled:!0,level:0};function nu(){}const au={},hu={once:!0};function lu(e){for(const t in e)for(const s in e[t])return s||"untitled";return "empty"}class uu{constructor({id:e}={id:""}){this.id=e,this.VERSION=Zl,this._startTs=iu(),this._deltaTs=iu(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new ql("__probe-".concat(this.id,"__"),ou),this.userData={},this.timeStamp("".concat(this.id," started")),function(e,t=["constructor"]){const s=Object.getPrototypeOf(e),i=Object.getOwnPropertyNames(s);for(const s of i)"function"==typeof e[s]&&(t.find((e=>s===e))||(e[s]=e[s].bind(e)));}(this),Object.seal(this);}set level(e){this.setLevel(e);}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((iu()-this._startTs).toPrecision(10))}getDelta(){return Number((iu()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e;}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}assert(e,t){su(e,t);}warn(e){return this._getLogFunction(0,e,ru.warn,arguments,hu)}error(e){return this._getLogFunction(0,e,ru.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,ru.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,ru.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,ru.debug||ru.info,arguments,hu)}table(e,t,s){return t?this._getLogFunction(e,t,console.table||nu,s&&[s],{tag:lu(t)}):nu}image({logLevel:e,priority:t,image:s,message:i="",scale:r=1}){return this._shouldLog(e||t)?Ql?function({image:e,message:t="",scale:s=1}){if("string"==typeof e){const i=new Image;return i.onload=()=>{const e=$l(i,t,s);console.log(...e);},i.src=e,nu}const i=e.nodeName||"";if("img"===i.toLowerCase())return console.log(...$l(e,t,s)),nu;if("canvas"===i.toLowerCase()){const i=new Image;return i.onload=()=>console.log(...$l(i,t,s)),i.src=e.toDataURL(),nu}return nu}({image:s,message:i,scale:r}):function({image:e,message:t="",scale:s=1}){let i=null;try{i=module.require("asciify-image");}catch(e){}if(i)return ()=>i(e,{fit:"box",width:"".concat(Math.round(80*s),"%")}).then((e=>console.log(e)));return nu}({image:s,message:i,scale:r}):nu}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config);}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t});}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||nu)}group(e,t,s={collapsed:!1}){s=pu({logLevel:e,message:t,opts:s});const{collapsed:i}=s;return s.method=(i?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,t,s={}){return this.group(e,t,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||nu)}withGroup(e,t,s){this.group(e,t)();try{s();}finally{this.groupEnd(e)();}}trace(){console.trace&&console.trace();}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=cu(e)}_getLogFunction(e,t,s,i=[],r){if(this._shouldLog(e)){r=pu({logLevel:e,message:t,args:i,opts:r}),su(s=s||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=iu();const o=r.tag||r.message;if(r.once){if(au[o])return nu;au[o]=iu();}return t=function(e,t,s){if("string"==typeof t){const i=s.time?function(e,t=8){const s=Math.max(t-e.length,0);return "".concat(" ".repeat(s)).concat(e)}(function(e){let t;return t=e<10?"".concat(e.toFixed(2),"ms"):e<100?"".concat(e.toFixed(1),"ms"):e<1e3?"".concat(e.toFixed(0),"ms"):"".concat((e/1e3).toFixed(2),"s"),t}(s.total)):"";t=function(e,t,s){return Ql||"string"!=typeof e||(t&&(t=tu(t),e="[".concat(t,"m").concat(e,"[39m")),s&&(t=tu(s),e="[".concat(s+10,"m").concat(e,"[49m"))),e}(t=s.time?"".concat(e,": ").concat(i,"  ").concat(t):"".concat(e,": ").concat(t),s.color,s.background);}return t}(this.id,r.message,r),s.bind(console,t,...r.args)}return nu}}function cu(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return su(Number.isFinite(t)&&t>=0),t}function pu(e){const{logLevel:t,message:s}=e;e.logLevel=cu(t);const i=e.args?Array.from(e.args):[];for(;i.length&&i.shift()!==s;);switch(e.args=i,typeof t){case"string":case"function":void 0!==s&&i.unshift(s),e.message=t;break;case"object":Object.assign(e,t);}"function"==typeof e.message&&(e.message=e.message());const r=typeof e.message;return su("string"===r||"object"===r),Object.assign(e,e.opts)}uu.VERSION=Zl;const du=new uu({id:"loaders.gl"});const mu={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){rl(this,"console",void 0),this.console=console;}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}},CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]};function Au(){return !("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(e){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return !0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return !0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,s=e||t;return !!(s&&s.indexOf("Electron")>=0)}()}const Cu={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},Iu=Cu.window||Cu.self||Cu.global,Fu=Cu.process||{},Bu="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";Au();class Eu{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";rl(this,"storage",void 0),rl(this,"id",void 0),rl(this,"config",{}),this.storage=function(e){try{const t=window[e],s="__storage_test__";return t.setItem(s,s),t.removeItem(s),t}catch(e){return null}}(s),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration();}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e);}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{};}return Object.assign(this.config,e),this}}function Su(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const r=e.src.replace(/\(/g,"%28").replace(/\)/g,"%29");e.width>i&&(s=Math.min(s,i/e.width));const o=e.width*s,n=e.height*s,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(r,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return ["".concat(t," %c+"),a]}let Ru;function Ou(e){return "string"==typeof e?Ru[e.toUpperCase()]||Ru.WHITE:e}function Lu(e,t){if(!e)throw new Error(t||"Assertion failed")}function Nu(){let e;var t,s;if(Au&&"performance"in Iu)e=null==Iu||null===(t=Iu.performance)||void 0===t||null===(s=t.now)||void 0===s?void 0:s.call(t);else if("hrtime"in Fu){var i;const t=null==Fu||null===(i=Fu.hrtime)||void 0===i?void 0:i.call(Fu);e=1e3*t[0]+t[1]/1e6;}else e=Date.now();return e}!function(e){e[e.BLACK=30]="BLACK",e[e.RED=31]="RED",e[e.GREEN=32]="GREEN",e[e.YELLOW=33]="YELLOW",e[e.BLUE=34]="BLUE",e[e.MAGENTA=35]="MAGENTA",e[e.CYAN=36]="CYAN",e[e.WHITE=37]="WHITE",e[e.BRIGHT_BLACK=90]="BRIGHT_BLACK",e[e.BRIGHT_RED=91]="BRIGHT_RED",e[e.BRIGHT_GREEN=92]="BRIGHT_GREEN",e[e.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",e[e.BRIGHT_BLUE=94]="BRIGHT_BLUE",e[e.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",e[e.BRIGHT_CYAN=96]="BRIGHT_CYAN",e[e.BRIGHT_WHITE=97]="BRIGHT_WHITE";}(Ru||(Ru={}));const ku={debug:Au&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},ju={enabled:!0,level:0};function Gu(){}const Hu={},Vu={once:!0};class Uu{constructor(){let{id:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};rl(this,"id",void 0),rl(this,"VERSION",Bu),rl(this,"_startTs",Nu()),rl(this,"_deltaTs",Nu()),rl(this,"_storage",void 0),rl(this,"userData",{}),rl(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new Eu("__probe-".concat(this.id,"__"),ju),this.userData={},this.timeStamp("".concat(this.id," started")),function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const s=Object.getPrototypeOf(e),i=Object.getOwnPropertyNames(s);for(const s of i)"function"==typeof e[s]&&(t.find((e=>s===e))||(e[s]=e[s].bind(e)));}(this),Object.seal(this);}set level(e){this.setLevel(e);}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Nu()-this._startTs).toPrecision(10))}getDelta(){return Number((Nu()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e;}get priority(){return this.level}getPriority(){return this.level}enable(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t});}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config);}assert(e,t){Lu(e,t);}warn(e){return this._getLogFunction(0,e,ku.warn,arguments,Vu)}error(e){return this._getLogFunction(0,e,ku.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,ku.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,ku.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var s=arguments.length,i=new Array(s>2?s-2:0),r=2;r<s;r++)i[r-2]=arguments[r];return this._getLogFunction(e,t,ku.debug||ku.info,arguments,Vu)}table(e,t,s){return t?this._getLogFunction(e,t,console.table||Gu,s&&[s],{tag:Xu(t)}):Gu}image(e){let{logLevel:t,priority:s,image:i,message:r="",scale:o=1}=e;return this._shouldLog(t||s)?Au?function(e){let{image:t,message:s="",scale:i=1}=e;if("string"==typeof t){const e=new Image;return e.onload=()=>{const t=Su(e,s,i);console.log(...t);},e.src=t,Gu}const r=t.nodeName||"";if("img"===r.toLowerCase())return console.log(...Su(t,s,i)),Gu;if("canvas"===r.toLowerCase()){const e=new Image;return e.onload=()=>console.log(...Su(e,s,i)),e.src=t.toDataURL(),Gu}return Gu}({image:i,message:r,scale:o}):function(e){let{image:t,message:s="",scale:i=1}=e,r=null;try{r=module.require("asciify-image");}catch(e){}if(r)return ()=>r(t,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then((e=>console.log(e)));return Gu}({image:i,message:r,scale:o}):Gu}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Gu)}group(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const i=Wu({logLevel:e,message:t,opts:s}),{collapsed:r}=s;return i.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.group(e,t,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Gu)}withGroup(e,t,s){this.group(e,t)();try{s();}finally{this.groupEnd(e)();}}trace(){console.trace&&console.trace();}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=zu(e)}_getLogFunction(e,t,s,i,r){if(this._shouldLog(e)){r=Wu({logLevel:e,message:t,args:i,opts:r}),Lu(s=s||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=Nu();const o=r.tag||r.message;if(r.once){if(Hu[o])return Gu;Hu[o]=Nu();}return t=function(e,t,s){if("string"==typeof t){const i=s.time?function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;const s=Math.max(t-e.length,0);return "".concat(" ".repeat(s)).concat(e)}(function(e){let t;return t=e<10?"".concat(e.toFixed(2),"ms"):e<100?"".concat(e.toFixed(1),"ms"):e<1e3?"".concat(e.toFixed(0),"ms"):"".concat((e/1e3).toFixed(2),"s"),t}(s.total)):"";t=function(e,t,s){return Au||"string"!=typeof e||(t&&(t=Ou(t),e="[".concat(t,"m").concat(e,"[39m")),s&&(t=Ou(s),e="[".concat(s+10,"m").concat(e,"[49m"))),e}(t=s.time?"".concat(e,": ").concat(i,"  ").concat(t):"".concat(e,": ").concat(t),s.color,s.background);}return t}(this.id,r.message,r),s.bind(console,t,...r.args)}return Gu}}function zu(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return Lu(Number.isFinite(t)&&t>=0),t}function Wu(e){const{logLevel:t,message:s}=e;e.logLevel=zu(t);const i=e.args?Array.from(e.args):[];for(;i.length&&i.shift()!==s;);switch(typeof t){case"string":case"function":void 0!==s&&i.unshift(s),e.message=t;break;case"object":Object.assign(e,t);}"function"==typeof e.message&&(e.message=e.message());const r=typeof e.message;return Lu("string"===r||"object"===r),Object.assign(e,{args:i},e.opts)}function Xu(e){for(const t in e)for(const s in e[t])return s||"untitled";return "empty"}rl(Uu,"VERSION",Bu);const Yu=new Uu({id:"loaders.gl"});var Mc,Dc,Ac,Cc,Ic,Fc,Bc,Ec;!function(e){e[e.NONE=0]="NONE",e[e.BASISLZ=1]="BASISLZ",e[e.ZSTD=2]="ZSTD",e[e.ZLIB=3]="ZLIB";}(Mc||(Mc={})),function(e){e[e.BASICFORMAT=0]="BASICFORMAT";}(Dc||(Dc={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.ETC1S=163]="ETC1S",e[e.UASTC=166]="UASTC";}(Ac||(Ac={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.SRGB=1]="SRGB";}(Cc||(Cc={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.LINEAR=1]="LINEAR",e[e.SRGB=2]="SRGB",e[e.ITU=3]="ITU",e[e.NTSC=4]="NTSC",e[e.SLOG=5]="SLOG",e[e.SLOG2=6]="SLOG2";}(Ic||(Ic={})),function(e){e[e.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",e[e.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED";}(Fc||(Fc={})),function(e){e[e.RGB=0]="RGB",e[e.RRR=3]="RRR",e[e.GGG=4]="GGG",e[e.AAA=15]="AAA";}(Bc||(Bc={})),function(e){e[e.RGB=0]="RGB",e[e.RGBA=3]="RGBA",e[e.RRR=4]="RRR",e[e.RRRG=5]="RRRG";}(Ec||(Ec={}));function sp(e){const t=ip(e);return function(e){const t=ip(e);if(!(t.byteLength>=24&&2303741511===t.getUint32(0,false)))return null;return {mimeType:"image/png",width:t.getUint32(16,false),height:t.getUint32(20,false)}}(t)||function(e){const t=ip(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,false)&&255===t.getUint8(2)))return null;const{tableMarkers:s,sofMarkers:i}=function(){const e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);const t=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return {tableMarkers:e,sofMarkers:t}}();let r=2;for(;r+9<t.byteLength;){const e=t.getUint16(r,false);if(i.has(e))return {mimeType:"image/jpeg",height:t.getUint16(r+5,false),width:t.getUint16(r+7,false)};if(!s.has(e))return null;r+=2,r+=t.getUint16(r,false);}return null}(t)||function(e){const t=ip(e);if(!(t.byteLength>=10&&1195984440===t.getUint32(0,false)))return null;return {mimeType:"image/gif",width:t.getUint16(6,true),height:t.getUint16(8,true)}}(t)||function(e){const t=ip(e);if(!(t.byteLength>=14&&16973===t.getUint16(0,false)&&t.getUint32(2,true)===t.byteLength))return null;return {mimeType:"image/bmp",width:t.getUint32(18,true),height:t.getUint32(22,true)}}(t)}function ip(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}const op=["image/png","image/jpeg","image/gif"],np={};function ap(e){return void 0===np[e]&&(np[e]=function(e){switch(e){case"image/webp":return function(){if(!Jh)return !1;try{return 0===document.createElement("canvas").toDataURL("image/webp").indexOf("data:image/webp")}catch{return !1}}();case"image/svg":return Jh;default:if(!Jh){const{_parseImageNode:t}=globalThis;return Boolean(t)&&op.includes(e)}return !0}}(e)),np[e]}function hp(e,t){if(!e)throw new Error(t||"assert failed: gltf")}const up=["SCALAR","VEC2","VEC3","VEC4"],cp=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],pp=new Map(cp),dp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},fp={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},mp={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function gp(e){return up[e-1]||up[0]}function _p(e){const t=pp.get(e.constructor);if(!t)throw new Error("Illegal typed array");return t}function yp(e,t){const s=mp[e.componentType],i=dp[e.type],r=fp[e.componentType],o=e.count*i,n=e.count*i*r;return hp(n>=0&&n<=t.byteLength),{ArrayType:s,length:o,byteLength:n}}const vp={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class bp{constructor(e){rl(this,"gltf",void 0),rl(this,"sourceBuffers",void 0),rl(this,"byteLength",void 0),this.gltf=e||{json:{...vp},buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]]);}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return (this.json.extras||{})[e]}getExtension(e){const t=this.getUsedExtensions().find((t=>t===e)),s=this.json.extensions||{};return t?s[e]||!0:null}getRequiredExtension(e){const t=this.getRequiredExtensions().find((t=>t===e));return t?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getObjectExtension(e,t){return (e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if("object"==typeof t)return t;const s=this.json[e]&&this.json[e][t];if(!s)throw new Error("glTF file error: Could not find ".concat(e,"[").concat(t,"]"));return s}getTypedArrayForBufferView(e){const t=(e=this.getBufferView(e)).buffer,s=this.gltf.buffers[t];hp(s);const i=(e.byteOffset||0)+s.byteOffset;return new Uint8Array(s.arrayBuffer,i,e.byteLength)}getTypedArrayForAccessor(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),s=this.getBuffer(t.buffer).data,{ArrayType:i,length:r}=yp(e,t);return new i(s,t.byteOffset+e.byteOffset,r)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),s=this.getBuffer(t.buffer).data,i=t.byteOffset||0;return new Uint8Array(s,i,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,s){return e.extensions=e.extensions||{},e.extensions[t]=s,this.registerUsedExtension(t),this}setObjectExtension(e,t,s){(e.extensions||{})[t]=s;}removeObjectExtension(e,t){const s=e.extensions||{},i=s[t];return delete s[t],i}addExtension(e,t={}){return hp(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return hp(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((t=>t===e))||this.json.extensionsUsed.push(e);}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((t=>t===e))||this.json.extensionsRequired.push(e);}removeExtension(e){this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e),this.json.extensions&&delete this.json.extensions[e];}setDefaultScene(e){this.json.scene=e;}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:s}=e;this.json.nodes=this.json.nodes||[];const i={mesh:t};return s&&(i.matrix=s),this.json.nodes.push(i),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:s,material:i,mode:r=4}=e,o={primitives:[{attributes:this._addAttributes(t),mode:r}]};if(s){const e=this._addIndices(s);o.primitives[0].indices=e;}return Number.isFinite(i)&&(o.primitives[0].material=i),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}addPointCloud(e){const t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}addImage(e,t){const s=sp(e),i=t||(null==s?void 0:s.mimeType),r={bufferView:this.addBufferView(e),mimeType:i};return this.json.images=this.json.images||[],this.json.images.push(r),this.json.images.length-1}addBufferView(e){const t=e.byteLength;hp(Number.isFinite(t)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const s={buffer:0,byteOffset:this.byteLength,byteLength:t};return this.byteLength+=Cl(t,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(s),this.json.bufferViews.length-1}addAccessor(e,t){const s={bufferView:e,type:gp(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(s),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const s=this.addBufferView(e);let i={min:t.min,max:t.max};i.min&&i.max||(i=this._getAccessorMinMax(e,t.size));const r={size:t.size,componentType:_p(e),count:Math.round(e.length/t.size),min:i.min,max:i.max};return this.addAccessor(s,Object.assign(r,t))}addTexture(e){const{imageIndex:t}=e,s={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(s),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var e,t;this.gltf.buffers=[];const s=this.byteLength,i=new ArrayBuffer(s),r=new Uint8Array(i);let o=0;for(const e of this.sourceBuffers||[])o=Il(e,r,o);null!==(e=this.json)&&void 0!==e&&null!==(t=e.buffers)&&void 0!==t&&t[0]?this.json.buffers[0].byteLength=s:this.json.buffers=[{byteLength:s}],this.gltf.binary=i,this.sourceBuffers=[i];}_removeStringFromArray(e,t){let s=!0;for(;s;){const i=e.indexOf(t);i>-1?e.splice(i,1):s=!1;}}_addAttributes(e={}){const t={};for(const s in e){const i=e[s],r=this._getGltfAttributeName(s),o=this.addBinaryBuffer(i.value,i);t[r]=o;}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return "POSITION";case"normal":case"normals":return "NORMAL";case"color":case"colors":return "COLOR_0";case"texcoord":case"texcoords":return "TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const s={min:null,max:null};if(e.length<t)return s;s.min=[],s.max=[];const i=e.subarray(0,t);for(const e of i)s.min.push(e),s.max.push(e);for(let i=t;i<e.length;i+=t)for(let r=0;r<t;r++)s.min[0+r]=Math.min(s.min[0+r],e[i+r]),s.max[0+r]=Math.max(s.max[0+r],e[i+r]);return s}}const wp="object"!=typeof WebAssembly,Pp="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",Tp="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",xp=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),Mp=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),Dp={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Ap={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function Cp(e,t,s,i,r,o="NONE"){const n=await async function(){Ip||(Ip=async function(){let e=Pp;WebAssembly.validate(xp)&&(e=Tp,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const t=await WebAssembly.instantiate(function(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;++s){const i=e.charCodeAt(s);t[s]=i>96?i-71:i>64?i-65:i>47?i+4:i>46?63:62;}let s=0;for(let i=0;i<e.length;++i)t[s++]=t[i]<60?Mp[t[i]]:64*(t[i]-60)+t[++i];return t.buffer.slice(0,s)}(e),{});return await t.instance.exports.__wasm_call_ctors(),t.instance}());return Ip}();!function(e,t,s,i,r,o,n){const a=e.exports.sbrk,h=i+3&-4,l=a(h*r),u=a(o.length),c=new Uint8Array(e.exports.memory.buffer);c.set(o,u);const p=t(l,i,r,u,o.length);0===p&&n&&n(l,h,r);if(s.set(c.subarray(l,l+i*r)),a(l-a(0)),0!==p)throw new Error("Malformed buffer data: ".concat(p))}(n,n.exports[Ap[r]],e,t,s,i,n.exports[Dp[o||"NONE"]]);}let Ip;async function Fp(e,t){const s=e.getObjectExtension(t,"EXT_meshopt_compression");if(s){const e=t.buffer,{byteOffset:i=0,byteLength:r=0,byteStride:o,count:n,mode:a,filter:h="NONE"}=s,l=new Uint8Array(e,i,r),u=new ArrayBuffer(n*o);return await Cp(new Uint8Array(u),n,o,l,a,h),u}return null}var Bp=Object.freeze({__proto__:null,name:"EXT_meshopt_compression",preprocess:function(e){if(new bp(e).getRequiredExtensions().includes("EXT_meshopt_compression")&&!wp)throw new Error("gltf: Required extension ".concat("EXT_meshopt_compression"," not supported by browser"))},decode:async function(e,t){var s;const i=new bp(e);if(null==t||null===(s=t.gltf)||void 0===s||!s.decompressMeshes)return;const r=[];for(const t of e.json.bufferViews||[])r.push(Fp(i,t));await Promise.all(r),i.removeExtension("EXT_meshopt_compression");}});var Ep=Object.freeze({__proto__:null,name:"EXT_texture_webp",preprocess:function(e,t){const s=new bp(e);if(!ap("image/webp")){if(s.getRequiredExtensions().includes("EXT_texture_webp"))throw new Error("gltf: Required extension ".concat("EXT_texture_webp"," not supported by browser"));return}const{json:i}=s;for(const e of i.textures||[]){const t=s.getObjectExtension(e,"EXT_texture_webp");t&&(e.source=t.source),s.removeObjectExtension(e,"EXT_texture_webp");}s.removeExtension("EXT_texture_webp");}});var Sp=Object.freeze({__proto__:null,name:"KHR_texture_basisu",preprocess:function(e,t){const s=new bp(e),{json:i}=s;for(const e of i.textures||[]){const t=s.getObjectExtension(e,"KHR_texture_basisu");t&&(e.source=t.source),s.removeObjectExtension(e,"KHR_texture_basisu");}s.removeExtension("KHR_texture_basisu");}});const Rp={name:"Draco",id:"draco",module:"draco",shapes:["mesh"],version:"3.1.8",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:"object"==typeof WebAssembly?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};class Op{constructor(e,t){rl(this,"fields",void 0),rl(this,"metadata",void 0),function(e,t){if(!e)throw new Error(t||"loader assertion failed.")}(Array.isArray(e)),function(e){const t={};for(const s of e)t[s.name]&&console.warn("Schema: duplicated field name",s.name,s),t[s.name]=!0;}(e),this.fields=e,this.metadata=t||new Map;}compareTo(e){if(this.metadata!==e.metadata)return !1;if(this.fields.length!==e.fields.length)return !1;for(let t=0;t<this.fields.length;++t)if(!this.fields[t].compareTo(e.fields[t]))return !1;return !0}select(...e){const t=Object.create(null);for(const s of e)t[s]=!0;const s=this.fields.filter((e=>t[e.name]));return new Op(s,this.metadata)}selectAt(...e){const t=e.map((e=>this.fields[e])).filter(Boolean);return new Op(t,this.metadata)}assign(e){let t,s=this.metadata;if(e instanceof Op){const i=e;t=i.fields,s=Lp(Lp(new Map,this.metadata),i.metadata);}else t=e;const i=Object.create(null);for(const e of this.fields)i[e.name]=e;for(const e of t)i[e.name]=e;const r=Object.values(i);return new Op(r,s)}}function Lp(e,t){return new Map([...e||new Map,...t||new Map])}class Np{constructor(e,t,s=!1,i=new Map){rl(this,"name",void 0),rl(this,"type",void 0),rl(this,"nullable",void 0),rl(this,"metadata",void 0),this.name=e,this.type=t,this.nullable=s,this.metadata=i;}get typeId(){return this.type&&this.type.typeId}clone(){return new Np(this.name,this.type,this.nullable,this.metadata)}compareTo(e){return this.name===e.name&&this.type===e.type&&this.nullable===e.nullable&&this.metadata===e.metadata}toString(){return "".concat(this.type).concat(this.nullable?", nullable":"").concat(this.metadata?", metadata: ".concat(this.metadata):"")}}let kp,jp,Gp,Hp;!function(e){e[e.NONE=0]="NONE",e[e.Null=1]="Null",e[e.Int=2]="Int",e[e.Float=3]="Float",e[e.Binary=4]="Binary",e[e.Utf8=5]="Utf8",e[e.Bool=6]="Bool",e[e.Decimal=7]="Decimal",e[e.Date=8]="Date",e[e.Time=9]="Time",e[e.Timestamp=10]="Timestamp",e[e.Interval=11]="Interval",e[e.List=12]="List",e[e.Struct=13]="Struct",e[e.Union=14]="Union",e[e.FixedSizeBinary=15]="FixedSizeBinary",e[e.FixedSizeList=16]="FixedSizeList",e[e.Map=17]="Map",e[e.Dictionary=-1]="Dictionary",e[e.Int8=-2]="Int8",e[e.Int16=-3]="Int16",e[e.Int32=-4]="Int32",e[e.Int64=-5]="Int64",e[e.Uint8=-6]="Uint8",e[e.Uint16=-7]="Uint16",e[e.Uint32=-8]="Uint32",e[e.Uint64=-9]="Uint64",e[e.Float16=-10]="Float16",e[e.Float32=-11]="Float32",e[e.Float64=-12]="Float64",e[e.DateDay=-13]="DateDay",e[e.DateMillisecond=-14]="DateMillisecond",e[e.TimestampSecond=-15]="TimestampSecond",e[e.TimestampMillisecond=-16]="TimestampMillisecond",e[e.TimestampMicrosecond=-17]="TimestampMicrosecond",e[e.TimestampNanosecond=-18]="TimestampNanosecond",e[e.TimeSecond=-19]="TimeSecond",e[e.TimeMillisecond=-20]="TimeMillisecond",e[e.TimeMicrosecond=-21]="TimeMicrosecond",e[e.TimeNanosecond=-22]="TimeNanosecond",e[e.DenseUnion=-23]="DenseUnion",e[e.SparseUnion=-24]="SparseUnion",e[e.IntervalDayTime=-25]="IntervalDayTime",e[e.IntervalYearMonth=-26]="IntervalYearMonth";}(kp||(kp={}));class Vp{static isNull(e){return e&&e.typeId===kp.Null}static isInt(e){return e&&e.typeId===kp.Int}static isFloat(e){return e&&e.typeId===kp.Float}static isBinary(e){return e&&e.typeId===kp.Binary}static isUtf8(e){return e&&e.typeId===kp.Utf8}static isBool(e){return e&&e.typeId===kp.Bool}static isDecimal(e){return e&&e.typeId===kp.Decimal}static isDate(e){return e&&e.typeId===kp.Date}static isTime(e){return e&&e.typeId===kp.Time}static isTimestamp(e){return e&&e.typeId===kp.Timestamp}static isInterval(e){return e&&e.typeId===kp.Interval}static isList(e){return e&&e.typeId===kp.List}static isStruct(e){return e&&e.typeId===kp.Struct}static isUnion(e){return e&&e.typeId===kp.Union}static isFixedSizeBinary(e){return e&&e.typeId===kp.FixedSizeBinary}static isFixedSizeList(e){return e&&e.typeId===kp.FixedSizeList}static isMap(e){return e&&e.typeId===kp.Map}static isDictionary(e){return e&&e.typeId===kp.Dictionary}get typeId(){return kp.NONE}compareTo(e){return this===e}}jp=Symbol.toStringTag;class Up extends Vp{constructor(e,t){super(),rl(this,"isSigned",void 0),rl(this,"bitWidth",void 0),this.isSigned=e,this.bitWidth=t;}get typeId(){return kp.Int}get[jp](){return "Int"}toString(){return "".concat(this.isSigned?"I":"Ui","nt").concat(this.bitWidth)}}class zp extends Up{constructor(){super(!0,8);}}class Wp extends Up{constructor(){super(!0,16);}}class Xp extends Up{constructor(){super(!0,32);}}class Yp extends Up{constructor(){super(!1,8);}}class Kp extends Up{constructor(){super(!1,16);}}class Jp extends Up{constructor(){super(!1,32);}}const Zp=32,Qp=64;Gp=Symbol.toStringTag;class qp extends Vp{constructor(e){super(),rl(this,"precision",void 0),this.precision=e;}get typeId(){return kp.Float}get[Gp](){return "Float"}toString(){return "Float".concat(this.precision)}}class $p extends qp{constructor(){super(Zp);}}class ed extends qp{constructor(){super(Qp);}}Hp=Symbol.toStringTag;class td extends Vp{constructor(e,t){super(),rl(this,"listSize",void 0),rl(this,"children",void 0),this.listSize=e,this.children=[t];}get typeId(){return kp.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[Hp](){return "FixedSizeList"}toString(){return "FixedSizeList[".concat(this.listSize,"]<").concat(this.valueType,">")}}function sd(e,t,s){const i=function(e){switch(e.constructor){case Int8Array:return new zp;case Uint8Array:return new Yp;case Int16Array:return new Wp;case Uint16Array:return new Kp;case Int32Array:return new Xp;case Uint32Array:return new Jp;case Float32Array:return new $p;case Float64Array:return new ed;default:throw new Error("array type not supported")}}(t.value),r=s||function(e){const t=new Map;"byteOffset"in e&&t.set("byteOffset",e.byteOffset.toString(10));"byteStride"in e&&t.set("byteStride",e.byteStride.toString(10));"normalized"in e&&t.set("normalized",e.normalized.toString());return t}(t);return new Np(e,new td(t.size,new Np("value",i)),!1,r)}function id(e,t,s){return sd(e,t,s?rd(s.metadata):void 0)}function rd(e){const t=new Map;for(const s in e)t.set("".concat(s,".string"),JSON.stringify(e[s]));return t}const od={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},nd={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class ad{constructor(e){rl(this,"draco",void 0),rl(this,"decoder",void 0),rl(this,"metadataQuerier",void 0),this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier;}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier);}parseSync(e,t={}){const s=new this.draco.DecoderBuffer;s.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const i=this.decoder.GetEncodedGeometryType(s),r=i===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let e;switch(i){case this.draco.TRIANGULAR_MESH:e=this.decoder.DecodeBufferToMesh(s,r);break;case this.draco.POINT_CLOUD:e=this.decoder.DecodeBufferToPointCloud(s,r);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!e.ok()||!r.ptr){const t="DRACO decompression failed: ".concat(e.error_msg());throw new Error(t)}const o=this._getDracoLoaderData(r,i,t),n=this._getMeshData(r,o,t),a=function(e){let t=1/0,s=1/0,i=1/0,r=-1/0,o=-1/0,n=-1/0;const a=e.POSITION?e.POSITION.value:[],h=a&&a.length;for(let e=0;e<h;e+=3){const h=a[e],l=a[e+1],u=a[e+2];t=h<t?h:t,s=l<s?l:s,i=u<i?u:i,r=h>r?h:r,o=l>o?l:o,n=u>n?u:n;}return [[t,s,i],[r,o,n]]}(n.attributes),h=function(e,t,s){const i=rd(t.metadata),r=[],o=function(e){const t={};for(const s in e){const i=e[s];t[i.name||"undefined"]=i;}return t}(t.attributes);for(const t in e){const s=id(t,e[t],o[t]);r.push(s);}if(s){const e=id("indices",s);r.push(e);}return new Op(r,i)}(n.attributes,o,n.indices);return {loader:"draco",loaderData:o,header:{vertexCount:r.num_points(),boundingBox:a},...n,schema:h}}finally{this.draco.destroy(s),r&&this.draco.destroy(r);}}_getDracoLoaderData(e,t,s){const i=this._getTopLevelMetadata(e),r=this._getDracoAttributes(e,s);return {geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:i,attributes:r}}_getDracoAttributes(e,t){const s={};for(let i=0;i<e.num_attributes();i++){const r=this.decoder.GetAttribute(e,i),o=this._getAttributeMetadata(e,i);s[r.unique_id()]={unique_id:r.unique_id(),attribute_type:r.attribute_type(),data_type:r.data_type(),num_components:r.num_components(),byte_offset:r.byte_offset(),byte_stride:r.byte_stride(),normalized:r.normalized(),attribute_index:i,metadata:o};const n=this._getQuantizationTransform(r,t);n&&(s[r.unique_id()].quantization_transform=n);const a=this._getOctahedronTransform(r,t);a&&(s[r.unique_id()].octahedron_transform=a);}return s}_getMeshData(e,t,s){const i=this._getMeshAttributes(t,e,s);if(!i.POSITION)throw new Error("DRACO: No position attribute found.");return e instanceof this.draco.Mesh?"triangle-strip"===s.topology?{topology:"triangle-strip",mode:4,attributes:i,indices:{value:this._getTriangleStripIndices(e),size:1}}:{topology:"triangle-list",mode:5,attributes:i,indices:{value:this._getTriangleListIndices(e),size:1}}:{topology:"point-list",mode:0,attributes:i}}_getMeshAttributes(e,t,s){const i={};for(const r of Object.values(e.attributes)){const e=this._deduceAttributeName(r,s);r.name=e;const{value:o,size:n}=this._getAttributeValues(t,r);i[e]={value:o,size:n,byteOffset:r.byte_offset,byteStride:r.byte_stride,normalized:r.normalized};}return i}_getTriangleListIndices(e){const t=3*e.num_faces(),s=4*t,i=this.draco._malloc(s);try{return this.decoder.GetTrianglesUInt32Array(e,s,i),new Uint32Array(this.draco.HEAPF32.buffer,i,t).slice()}finally{this.draco._free(i);}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),function(e){const t=e.size(),s=new Int32Array(t);for(let i=0;i<t;i++)s[i]=e.GetValue(i);return s}(t)}finally{this.draco.destroy(t);}}_getAttributeValues(e,t){const s=nd[t.data_type],i=t.num_components,r=e.num_points()*i,o=r*s.BYTES_PER_ELEMENT,n=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32;default:return e.DT_INVALID}}(this.draco,s);let a;const h=this.draco._malloc(o);try{const i=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,i,n,o,h),a=new s(this.draco.HEAPF32.buffer,h,r).slice();}finally{this.draco._free(h);}return {value:a,size:i}}_deduceAttributeName(e,t){const s=e.unique_id;for(const[e,i]of Object.entries(t.extraAttributes||{}))if(i===s)return e;const i=e.attribute_type;for(const e in od){if(this.draco[e]===i)return od[e]}const r=t.attributeNameEntry||"name";return e.metadata[r]?e.metadata[r].string:"CUSTOM_ATTRIBUTE_".concat(s)}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const s=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(s)}_getDracoMetadata(e){if(!e||!e.ptr)return {};const t={},s=this.metadataQuerier.NumEntries(e);for(let i=0;i<s;i++){const s=this.metadataQuerier.GetEntryName(e,i);t[s]=this._getDracoMetadataField(e,s);}return t}_getDracoMetadataField(e,t){const s=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,s);const i=function(e){const t=e.size(),s=new Int32Array(t);for(let i=0;i<t;i++)s[i]=e.GetValue(i);return s}(s);return {int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:i}}finally{this.draco.destroy(s);}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:s=[]}=e,i=[...t,...s];for(const e of i)this.decoder.SkipAttributeTransform(this.draco[e]);}_getQuantizationTransform(e,t){const{quantizedAttributes:s=[]}=t,i=e.attribute_type();if(s.map((e=>this.decoder[e])).includes(i)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return {quantization_bits:t.quantization_bits(),range:t.range(),min_values:new Float32Array([1,2,3]).map((e=>t.min_value(e)))}}finally{this.draco.destroy(t);}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:s=[]}=t,i=e.attribute_type();if(s.map((e=>this.decoder[e])).includes(i)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return {quantization_bits:t.quantization_bits()}}finally{this.draco.destroy(t);}}return null}}const hd="https://www.gstatic.com/draco/versioned/decoders/".concat("1.4.1","/draco_decoder.js"),ld="https://www.gstatic.com/draco/versioned/decoders/".concat("1.4.1","/draco_wasm_wrapper.js"),ud="https://www.gstatic.com/draco/versioned/decoders/".concat("1.4.1","/draco_decoder.wasm");let cd;async function pd(e){const t=e.modules||{};return cd=t.draco3d?cd||t.draco3d.createDecoderModule({}).then((e=>({draco:e}))):cd||async function(e){let t,s;if("js"===(e.draco&&e.draco.decoderType))t=await bl(hd,"draco",e);else [t,s]=await Promise.all([await bl(ld,"draco",e),await bl(ud,"draco",e)]);return t=t||globalThis.DracoDecoderModule,await function(e,t){const s={};t&&(s.wasmBinary=t);return new Promise((t=>{e({...s,onModuleLoaded:e=>t({draco:e})});}))}(t,s)}(e),await cd}const dd={...Rp,parse:async function(e,t){const{draco:s}=await pd(t),i=new ad(s);try{return i.parseSync(e,null==t?void 0:t.draco)}finally{i.destroy();}}};function fd(e){const{buffer:t,size:s,count:i}=function(e){let t=e,s=1,i=0;e&&e.value&&(t=e.value,s=e.size||1);t&&(ArrayBuffer.isView(t)||(t=function(e,t,s=!1){if(!e)return null;if(Array.isArray(e))return new t(e);if(s&&!(e instanceof t))return new t(e);return e}(t,Float32Array)),i=t.length/s);return {buffer:t,size:s,count:i}}(e);return {value:t,size:s,byteOffset:0,count:i,type:gp(s),componentType:_p(t)}}async function md(e,t,s,i){const r=e.getObjectExtension(t,"KHR_draco_mesh_compression");if(!r)return;const o=e.getTypedArrayForBufferView(r.bufferView),n=Al(o.buffer,o.byteOffset),{parse:a}=i,h={...s};delete h["3d-tiles"];const l=await a(n,dd,h,i),u=function(e){const t={};for(const s in e){const i=e[s];if("indices"!==s){const e=fd(i);t[s]=e;}}return t}(l.attributes);for(const[s,i]of Object.entries(u))if(s in t.attributes){const r=t.attributes[s],o=e.getAccessor(r);null!=o&&o.min&&null!=o&&o.max&&(i.min=o.min,i.max=o.max);}t.attributes=u,l.indices&&(t.indices=fd(l.indices)),function(e){if(!e.attributes&&Object.keys(e.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(t);}function gd(e,t,s=4,i,r){var o;if(!i.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const n=i.DracoWriter.encodeSync({attributes:e}),a=null==r||null===(o=r.parseSync)||void 0===o?void 0:o.call(r,{attributes:e}),h=i._addFauxAttributes(a.attributes);return {primitives:[{attributes:h,mode:s,extensions:{KHR_draco_mesh_compression:{bufferView:i.addBufferView(n),attributes:h}}}]}}function*_d(e){for(const t of e.json.meshes||[])for(const e of t.primitives)yield e;}var yd=Object.freeze({__proto__:null,name:"KHR_draco_mesh_compression",preprocess:function(e,t,s){const i=new bp(e);for(const e of _d(i))i.getObjectExtension(e,"KHR_draco_mesh_compression");},decode:async function(e,t,s){var i;if(null==t||null===(i=t.gltf)||void 0===i||!i.decompressMeshes)return;const r=new bp(e),o=[];for(const e of _d(r))r.getObjectExtension(e,"KHR_draco_mesh_compression")&&o.push(md(r,e,t,s));await Promise.all(o),r.removeExtension("KHR_draco_mesh_compression");},encode:function(e,t={}){const s=new bp(e);for(const e of s.json.meshes||[])gd(e),s.addRequiredExtension("KHR_draco_mesh_compression");}});var vd=Object.freeze({__proto__:null,name:"KHR_lights_punctual",decode:async function(e){const t=new bp(e),{json:s}=t,i=t.getExtension("KHR_lights_punctual");i&&(t.json.lights=i.lights,t.removeExtension("KHR_lights_punctual"));for(const e of s.nodes||[]){const s=t.getObjectExtension(e,"KHR_lights_punctual");s&&(e.light=s.light),t.removeObjectExtension(e,"KHR_lights_punctual");}},encode:async function(e){const t=new bp(e),{json:s}=t;if(s.lights){const e=t.addExtension("KHR_lights_punctual");hp(!e.lights),e.lights=s.lights,delete s.lights;}if(t.json.lights){for(const e of t.json.lights){const s=e.node;t.addObjectExtension(s,"KHR_lights_punctual",e);}delete t.json.lights;}}});function bd(e,t){const s=Object.assign({},e.values);return Object.keys(e.uniforms||{}).forEach((t=>{e.uniforms[t].value&&!(t in s)&&(s[t]=e.uniforms[t].value);})),Object.keys(s).forEach((e=>{"object"==typeof s[e]&&void 0!==s[e].index&&(s[e].texture=t.getTexture(s[e].index));})),s}const wd=[Bp,Ep,Sp,yd,vd,Object.freeze({__proto__:null,name:"KHR_materials_unlit",decode:async function(e){const t=new bp(e),{json:s}=t;t.removeExtension("KHR_materials_unlit");for(const e of s.materials||[]){e.extensions&&e.extensions.KHR_materials_unlit&&(e.unlit=!0),t.removeObjectExtension(e,"KHR_materials_unlit");}},encode:function(e){const t=new bp(e),{json:s}=t;if(t.materials)for(const e of s.materials||[])e.unlit&&(delete e.unlit,t.addObjectExtension(e,"KHR_materials_unlit",{}),t.addExtension("KHR_materials_unlit"));}}),Object.freeze({__proto__:null,name:"KHR_techniques_webgl",decode:async function(e){const t=new bp(e),{json:s}=t,i=t.getExtension("KHR_techniques_webgl");if(i){const e=function(e,t){const{programs:s=[],shaders:i=[],techniques:r=[]}=e,o=new TextDecoder;return i.forEach((e=>{if(!Number.isFinite(e.bufferView))throw new Error("KHR_techniques_webgl: no shader code");e.code=o.decode(t.getTypedArrayForBufferView(e.bufferView));})),s.forEach((e=>{e.fragmentShader=i[e.fragmentShader],e.vertexShader=i[e.vertexShader];})),r.forEach((e=>{e.program=s[e.program];})),r}(i,t);for(const i of s.materials||[]){const s=t.getObjectExtension(i,"KHR_techniques_webgl");s&&(i.technique=Object.assign({},s,e[s.technique]),i.technique.values=bd(i.technique,t)),t.removeObjectExtension(i,"KHR_techniques_webgl");}t.removeExtension("KHR_techniques_webgl");}},encode:async function(e,t){}})];const $d={IfcOpeningElement:{pickable:!1,visible:!1},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.4},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.3},DEFAULT:{}};function tf(e,t={}){const s="lightgrey",i=t.hoverColor||"rgba(0,0,0,0.4)",r=500,o=r+r/3,n=o/24,a=[{boundary:[6,6,6,6],color:t.frontColor||t.color||"#55FF55"},{boundary:[18,6,6,6],color:t.backColor||t.color||"#55FF55"},{boundary:[12,6,6,6],color:t.leftColor||t.color||"#FF5555"},{boundary:[0,6,6,6],color:t.rightColor||t.color||"#FF5555"},{boundary:[6,0,6,6],color:t.topColor||t.color||"#7777FF"},{boundary:[6,12,6,6],color:t.bottomColor||t.color||"#7777FF"}],h=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];t.frontColor||t.color,t.backColor||t.color,t.leftColor||t.color,t.rightColor||t.color,t.topColor||t.color,t.bottomColor||t.color;const l=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}];for(let e=0,t=h.length;e<t;e++)f.normalizeVec3(h[e].dir,h[e].dir),f.normalizeVec3(h[e].up,h[e].up);for(let e=0,t=l.length;e<t;e++)f.normalizeVec3(l[e].dir,l[e].dir),f.normalizeVec3(l[e].up,l[e].up);var u=l;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=o,this._textureCanvas.height=r,this._textureCanvas.style.width=o+"px",this._textureCanvas.style.height="500px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=s,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6;document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);const c=this._textureCanvas.getContext("2d");let p=!1;function d(){for(let e=0,t=a.length;e<t;e++){const t=a[e],s=t.boundary,i=Math.round(s[0]*n),r=Math.round(s[1]*n),o=Math.round(s[2]*n),h=Math.round(s[3]*n);c.fillStyle=t.color,c.fillRect(i,r,o,h);}for(let e=0,a=u.length;e<a;e++){let a,l,p,d;const f=u[e],g=f.boundaries;for(var t=0,r=g.length;t<r;t++){const e=g[t];a=Math.round(e[0]*n),l=Math.round(e[1]*n),p=Math.round(e[2]*n),d=Math.round(e[3]*n),f.highlighted&&(c.fillStyle=f.highlighted?i:f.color||s,c.fillRect(a,l,p,d));}if(f.label){c.fillStyle="black",c.font="60px sans-serif",c.textAlign="center";var o=a+.5*p,h=l+.7*d;c.fillText(m(f.label),o,h,80);}}e.scene.glRedraw();}const m=function(){const t={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},s={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},i={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"};return function(r){const o=p?s:t,n=o?o[r]:null;return n?e.localeService.translate(n)||i[n]||n:r}}();this.setZUp=function(){p=!0,u=h,this.clear();},this.setYUp=function(){p=!1,u=l,this.clear();},this.clear=function(){c.fillStyle=s,c.fillRect(0,0,o,r);for(var e=0,t=u.length;e<t;e++){u[e].highlighted=!1;}d();},this.getArea=function(e){const t=e[0]*o,s=r-e[1]*r;for(var i=0,a=u.length;i<a;i++){const e=u[i].boundaries;for(var h=0,l=e.length;h<l;h++){const r=e[h];if(t>=r[0]*n&&t<=(r[0]+r[2])*n&&s>=r[1]*n&&s<=(r[1]+r[3])*n)return i}}return -1},this.setAreaHighlighted=function(e,t){var s=u[e];if(!s)throw "Area not found: "+e;s.highlighted=!!t,d();},this.getAreaDir=function(e){var t=u[e];if(!t)throw "Unknown area: "+e;return t.dir},this.getAreaUp=function(e){var t=u[e];if(!t)throw "Unknown area: "+e;return t.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null);};}class sf extends h{constructor(e,t={}){super("NavCube",e,t),e.navCube=this;try{this._navCubeScene=new Ut(e,{canvasId:t.canvasId,canvasElement:t.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1;}catch(e){return void this.error(e)}const s=this._navCubeScene;s.clearLights(),new pt(s,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new pt(s,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new pt(s,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=s.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,s.edgeMaterial.edgeColor=[.2,.2,.2],s.edgeMaterial.edgeAlpha=.6,this._zUp=Boolean(e.camera.zUp);var i=this;this._synchCamera=function(){var t=f.rotationMat4c(-90*f.DEGTORAD,1,0,0),s=f.vec3(),r=f.vec3(),o=f.vec3();return function(){var n=e.camera.eye,a=e.camera.look,h=e.camera.up;s=f.mulVec3Scalar(f.normalizeVec3(f.subVec3(n,a,s)),5),i._zUp?(f.transformVec3(t,s,r),f.transformVec3(t,h,o),i._navCubeCamera.look=[0,0,0],i._navCubeCamera.eye=f.transformVec3(t,s,r),i._navCubeCamera.up=f.transformPoint3(t,h,o)):(i._navCubeCamera.look=[0,0,0],i._navCubeCamera.eye=s,i._navCubeCamera.up=h);}}(),this._cubeTextureCanvas=new tf(e,t),this._cubeSampler=new zh(s,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:1001,wrapT:1001}),this._cubeMesh=new Yi(s,{geometry:new Mt(s,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new Ft(s,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=!1===t.shadowVisible?null:new Yi(s,{geometry:new Mt(s,Ji({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new Ft(s,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1}),this._onCameraMatrix=e.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=e.camera.on("worldAxis",(()=>{e.camera.zUp?(this._zUp=!0,this._cubeTextureCanvas.setZUp(),this._repaint(),this._synchCamera()):e.camera.yUp&&(this._zUp=!1,this._cubeTextureCanvas.setYUp(),this._repaint(),this._synchCamera());})),this._onCameraFOV=e.camera.perspective.on("fov",(e=>{this._synchProjection&&(this._navCubeCamera.perspective.fov=e);})),this._onCameraProjection=e.camera.on("projection",(e=>{this._synchProjection&&(this._navCubeCamera.projection="ortho"===e||"perspective"===e?e:"perspective");}));var r=-1;function o(e){var t=[0,0];if(e){for(var s=e.target,i=0,r=0;s.offsetParent;)i+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;t[0]=e.pageX-i,t[1]=e.pageY-r;}else e=window.event,t[0]=e.x,t[1]=e.y;return t}var n,a,h=null,l=null,u=!1,c=!1,p=.5;i._navCubeCanvas.addEventListener("mouseenter",i._onMouseEnter=function(e){c=!0;}),i._navCubeCanvas.addEventListener("mouseleave",i._onMouseLeave=function(e){c=!1;}),i._navCubeCanvas.addEventListener("mousedown",i._onMouseDown=function(e){if(1===e.which){h=e.x,l=e.y,n=e.clientX,a=e.clientY;var t=o(e),i=s.pick({canvasPos:t});u=!!i;}}),document.addEventListener("mouseup",i._onMouseUp=function(e){if(1===e.which&&(u=!1,null!==h)){var t=o(e),n=s.pick({canvasPos:t,pickSurface:!0});if(n&&n.uv){var a=i._cubeTextureCanvas.getArea(n.uv);if(a>=0&&(document.body.style.cursor="pointer",r>=0&&(i._cubeTextureCanvas.setAreaHighlighted(r,!1),i._repaint(),r=-1),a>=0)){if(i._cubeTextureCanvas.setAreaHighlighted(a,!0),r=a,i._repaint(),e.x<h-3||e.x>h+3||e.y<l-3||e.y>l+3)return;var c=i._cubeTextureCanvas.getAreaDir(a);if(c){var p=i._cubeTextureCanvas.getAreaUp(a);d(c,p,(function(){r>=0&&(i._cubeTextureCanvas.setAreaHighlighted(r,!1),i._repaint(),r=-1),document.body.style.cursor="pointer",r>=0&&(i._cubeTextureCanvas.setAreaHighlighted(r,!1),i._repaint(),r=-1),a>=0&&(i._cubeTextureCanvas.setAreaHighlighted(a,!1),r=-1,i._repaint());}));}}}}}),document.addEventListener("mousemove",i._onMouseMove=function(t){if(r>=0&&(i._cubeTextureCanvas.setAreaHighlighted(r,!1),i._repaint(),r=-1),1!==t.buttons||u){if(u){var h=t.clientX,l=t.clientY;return document.body.style.cursor="move",void function(t,s){var i=(t-n)*-p,r=(s-a)*-p;e.camera.orbitYaw(i),e.camera.orbitPitch(-r),n=t,a=s;}(h,l)}if(c){var d=o(t),f=s.pick({canvasPos:d,pickSurface:!0});if(f){if(f.uv){document.body.style.cursor="pointer";var m=i._cubeTextureCanvas.getArea(f.uv);if(m===r)return;r>=0&&i._cubeTextureCanvas.setAreaHighlighted(r,!1),m>=0&&(i._cubeTextureCanvas.setAreaHighlighted(m,!0),i._repaint(),r=m);}}else document.body.style.cursor="default",r>=0&&(i._cubeTextureCanvas.setAreaHighlighted(r,!1),i._repaint(),r=-1);}}});var d=function(){var t=f.vec3();return function(s,r,o){var n=i._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,a=f.getAABB3Diag(n);f.getAABB3Center(n,t);var h=Math.abs(a/Math.tan(i._cameraFitFOV*f.DEGTORAD));e.cameraControl.pivotPos=t,i._cameraFly?e.cameraFlight.flyTo({look:t,eye:[t[0]-h*s[0],t[1]-h*s[1],t[2]-h*s[2]],up:r||[0,1,0],orthoScale:1.1*a,fitFOV:i._cameraFitFOV,duration:i._cameraFlyDuration},o):e.cameraFlight.jumpTo({look:t,eye:[t[0]-h*s[0],t[1]-h*s[1],t[2]-h*s[2]],up:r||[0,1,0],orthoScale:1.1*a,fitFOV:i._cameraFitFOV},o);}}();this._onUpdated=e.localeService.on("updated",(()=>{this._cubeTextureCanvas.clear(),this._repaint();})),this.setVisible(t.visible),this.setCameraFitFOV(t.cameraFitFOV),this.setCameraFly(t.cameraFly),this.setCameraFlyDuration(t.cameraFlyDuration),this.setFitVisible(t.fitVisible),this.setSynchProjection(t.synchProjection);}send(e,t){if("language"===e)this._cubeTextureCanvas.clear(),this._repaint();}_repaint(){const e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e;}setVisible(e=!0){this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow&&(this._shadow.visible=e),this._navCubeCanvas.style.visibility=e?"visible":"hidden");}getVisible(){return !!this._navCubeCanvas&&this._cubeMesh.visible}setFitVisible(e=!1){this._fitVisible=e;}getFitVisible(){return this._fitVisible}setCameraFly(e=!0){this._cameraFly=e;}getCameraFly(){return this._cameraFly}setCameraFitFOV(e=45){this._cameraFitFOV=e;}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(e=.5){this._cameraFlyDuration=e;}getCameraFlyDuration(){return this._cameraFlyDuration}setSynchProjection(e=!1){this._synchProjection=e;}getSynchProjection(){return this._synchProjection}destroy(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy();}}const rf=f.vec3();function df(e={}){let t=e.radius||1;t<0&&(console.error("negative radius not allowed - will invert"),t*=-1),t*=.5;let s=e.tube||.3;s<0&&(console.error("negative tube not allowed - will invert"),s*=-1);let i=e.radialSegments||32;i<0&&(console.error("negative radialSegments not allowed - will invert"),i*=-1),i<4&&(i=4);let r=e.tubeSegments||24;r<0&&(console.error("negative tubeSegments not allowed - will invert"),r*=-1),r<4&&(r=4);let o=e.arc||2*Math.PI;o<0&&(console.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);const n=e.center;let a=n?n[0]:0,h=n?n[1]:0;const l=n?n[2]:0,u=[],c=[],p=[],d=[];let m,g,_,y,v,w,P,T,x,M,D,A;for(T=0;T<=r;T++)for(P=0;P<=i;P++)m=P/i*o,g=.785398+T/r*Math.PI*2,a=t*Math.cos(m),h=t*Math.sin(m),_=(t+s*Math.cos(g))*Math.cos(m),y=(t+s*Math.cos(g))*Math.sin(m),v=s*Math.sin(g),u.push(_+a),u.push(y+h),u.push(v+l),p.push(1-P/i),p.push(T/r),w=f.normalizeVec3(f.subVec3([_,y,v],[a,h,l],[]),[]),c.push(w[0]),c.push(w[1]),c.push(w[2]);for(T=1;T<=r;T++)for(P=1;P<=i;P++)x=(i+1)*T+P-1,M=(i+1)*(T-1)+P-1,D=(i+1)*(T-1)+P,A=(i+1)*T+P,d.push(x),d.push(M),d.push(D),d.push(D),d.push(A),d.push(x);return b.apply(e,{positions:u,normals:c,uv:p,indices:d})}const ff=new Float64Array([0,0,1]),mf=new Float64Array(4);class gf{constructor(e){this.id=null,this._viewer=e.viewer,this._visible=!1,this._pos=f.vec3(),this._origin=f.vec3(),this._rtcPos=f.vec3(),this._baseDir=f.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents();}_setSectionPlane(e){this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),e&&(this.id=e.id,this._setPos(e.pos),this._setDir(e.dir),this._sectionPlane=e,this._onSectionPlanePos=e.on("pos",(()=>{this._setPos(this._sectionPlane.pos);})),this._onSectionPlaneDir=e.on("dir",(()=>{this._ignoreNextSectionPlaneDirUpdate?this._ignoreNextSectionPlaneDirUpdate=!1:this._setDir(this._sectionPlane.dir);})));}get sectionPlane(){return this._sectionPlane}_setPos(e){this._pos.set(e),X(this._pos,this._origin,this._rtcPos),this._rootNode.origin=this._origin,this._rootNode.position=this._rtcPos;}_setDir(e){this._baseDir.set(e),this._rootNode.quaternion=f.vec3PairToQuaternion(ff,e,mf);}_setSectionPlaneDir(e){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=e);}setVisible(e=!0){if(this._visible!==e){var t;for(t in this._visible=e,this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].visible=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].visible=e);}}getVisible(){return this._visible}setCulled(e){var t;for(t in this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].culled=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].culled=e);}_createNodes(){const e=!1,t=this._viewer.scene,s=.01;this._rootNode=new Bh(t,{position:[0,0,0],scale:[5,5,5]});const i=this._rootNode,r={arrowHead:new Mt(i,Ji({radiusTop:.001,radiusBottom:.07,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new Mt(i,Ji({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),arrowHeadHandle:new Mt(i,Ji({radiusTop:.09,radiusBottom:.09,radialSegments:8,heightSegments:1,height:.37,openEnded:!1})),curve:new Mt(i,df({radius:.8,tube:s,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),curveHandle:new Mt(i,df({radius:.8,tube:.06,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),hoop:new Mt(i,df({radius:.8,tube:s,radialSegments:64,tubeSegments:8,arc:2*Math.PI})),axis:new Mt(i,Ji({radiusTop:s,radiusBottom:s,radialSegments:20,heightSegments:1,height:1,openEnded:!1})),axisHandle:new Mt(i,Ji({radiusTop:.08,radiusBottom:.08,radialSegments:20,heightSegments:1,height:1,openEnded:!1}))},o={pickable:new Ft(i,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),red:new Ft(i,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new Et(i,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6}),green:new Ft(i,{diffuse:[0,1,0],emissive:[0,1,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightGreen:new Et(i,{edges:!1,fill:!0,fillColor:[0,1,0],fillAlpha:.6}),blue:new Ft(i,{diffuse:[0,0,1],emissive:[0,0,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightBlue:new Et(i,{edges:!1,fill:!0,fillColor:[0,0,1],fillAlpha:.2}),center:new Ft(i,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),highlightBall:new Et(i,{edges:!1,fill:!0,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1}),highlightPlane:new Et(i,{edges:!0,edgeWidth:3,fill:!1,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1})};this._displayMeshes={plane:i.addChild(new Yi(i,{geometry:new Mt(i,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new Ft(i,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new Et(i,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1]}),e),planeFrame:i.addChild(new Yi(i,{geometry:new Mt(i,df({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new Ft(i,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new Et(i,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45]}),e),xCurve:i.addChild(new Yi(i,{geometry:r.curve,material:o.red,matrix:function(){const e=f.rotationMat4v(90*f.DEGTORAD,[0,1,0],f.identityMat4()),t=f.rotationMat4v(270*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),xCurveHandle:i.addChild(new Yi(i,{geometry:r.curveHandle,material:o.pickable,matrix:function(){const e=f.rotationMat4v(90*f.DEGTORAD,[0,1,0],f.identityMat4()),t=f.rotationMat4v(270*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),xCurveArrow1:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.red,matrix:function(){const e=f.translateMat4c(0,-.07,-.8,f.identityMat4()),t=f.scaleMat4v([.6,.6,.6],f.identityMat4()),s=f.rotationMat4v(0*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(f.mulMat4(e,t,f.identityMat4()),s,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),xCurveArrow2:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.red,matrix:function(){const e=f.translateMat4c(0,-.8,-.07,f.identityMat4()),t=f.scaleMat4v([.6,.6,.6],f.identityMat4()),s=f.rotationMat4v(90*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(f.mulMat4(e,t,f.identityMat4()),s,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),yCurve:i.addChild(new Yi(i,{geometry:r.curve,material:o.green,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),yCurveHandle:i.addChild(new Yi(i,{geometry:r.curveHandle,material:o.pickable,rotation:[-90,0,0],pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),yCurveArrow1:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.green,matrix:function(){const e=f.translateMat4c(.07,0,-.8,f.identityMat4()),t=f.scaleMat4v([.6,.6,.6],f.identityMat4()),s=f.rotationMat4v(90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(f.mulMat4(e,t,f.identityMat4()),s,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),yCurveArrow2:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.green,matrix:function(){const e=f.translateMat4c(.8,0,-.07,f.identityMat4()),t=f.scaleMat4v([.6,.6,.6],f.identityMat4()),s=f.rotationMat4v(90*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(f.mulMat4(e,t,f.identityMat4()),s,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zCurve:i.addChild(new Yi(i,{geometry:r.curve,material:o.blue,matrix:f.rotationMat4v(180*f.DEGTORAD,[1,0,0],f.identityMat4()),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zCurveHandle:i.addChild(new Yi(i,{geometry:r.curveHandle,material:o.pickable,matrix:f.rotationMat4v(180*f.DEGTORAD,[1,0,0],f.identityMat4()),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zCurveCurveArrow1:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=f.translateMat4c(.8,-.07,0,f.identityMat4()),t=f.scaleMat4v([.6,.6,.6],f.identityMat4());return f.mulMat4(e,t,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zCurveArrow2:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=f.translateMat4c(.05,-.8,0,f.identityMat4()),t=f.scaleMat4v([.6,.6,.6],f.identityMat4()),s=f.rotationMat4v(90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(f.mulMat4(e,t,f.identityMat4()),s,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),center:i.addChild(new Yi(i,{geometry:new Mt(i,Zi({radius:.05})),material:o.center,pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),xAxisArrow:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.red,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),xAxisArrowHandle:i.addChild(new Yi(i,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),xAxis:i.addChild(new Yi(i,{geometry:r.axis,material:o.red,matrix:function(){const e=f.translateMat4c(0,.5,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),xAxisHandle:i.addChild(new Yi(i,{geometry:r.axisHandle,material:o.pickable,matrix:function(){const e=f.translateMat4c(0,.5,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),yAxisArrow:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.green,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(180*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yAxisArrowHandle:i.addChild(new Yi(i,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(180*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,opacity:.2}),e),yShaft:i.addChild(new Yi(i,{geometry:r.axis,material:o.green,position:[0,-.5,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yShaftHandle:i.addChild(new Yi(i,{geometry:r.axisHandle,material:o.pickable,position:[0,-.5,0],pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrow:i.addChild(new Yi(i,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[.8,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrowHandle:i.addChild(new Yi(i,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[.8,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zShaft:i.addChild(new Yi(i,{geometry:r.axis,material:o.blue,matrix:function(){const e=f.translateMat4c(0,.5,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1}),e),zAxisHandle:i.addChild(new Yi(i,{geometry:r.axisHandle,material:o.pickable,matrix:function(){const e=f.translateMat4c(0,.5,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),clippable:!1,pickable:!0,collidable:!0,visible:!1}),e)},this._affordanceMeshes={planeFrame:i.addChild(new Yi(i,{geometry:new Mt(i,df({center:[0,0,0],radius:2,tube:s,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new Ft(i,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new Et(i,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45]}),e),xHoop:i.addChild(new Yi(i,{geometry:r.hoop,material:o.red,highlighted:!0,highlightMaterial:o.highlightRed,matrix:function(){const e=f.rotationMat4v(90*f.DEGTORAD,[0,1,0],f.identityMat4()),t=f.rotationMat4v(270*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yHoop:i.addChild(new Yi(i,{geometry:r.hoop,material:o.green,highlighted:!0,highlightMaterial:o.highlightGreen,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zHoop:i.addChild(new Yi(i,{geometry:r.hoop,material:o.blue,highlighted:!0,highlightMaterial:o.highlightBlue,matrix:f.rotationMat4v(180*f.DEGTORAD,[1,0,0],f.identityMat4()),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),xAxisArrow:i.addChild(new Yi(i,{geometry:r.arrowHeadBig,material:o.red,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[0,0,1],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yAxisArrow:i.addChild(new Yi(i,{geometry:r.arrowHeadBig,material:o.green,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(180*f.DEGTORAD,[1,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrow:i.addChild(new Yi(i,{geometry:r.arrowHeadBig,material:o.blue,matrix:function(){const e=f.translateMat4c(0,1.1,0,f.identityMat4()),t=f.rotationMat4v(-90*f.DEGTORAD,[.8,0,0],f.identityMat4());return f.mulMat4(t,e,f.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e)};}_bindEvents(){const e=this;var t=!1;const s=-1,i=0,r=1,o=2,n=3,a=4,h=5,l=this._rootNode;var u=null,c=null;const p=f.vec2(),d=f.vec3([1,0,0]),m=f.vec3([0,1,0]),g=f.vec3([0,0,1]),_=this._viewer.scene.canvas.canvas,y=this._viewer.camera,v=this._viewer.scene;{const e=f.vec3([0,0,0]);let t=-1;this._onCameraViewMatrix=v.camera.on("viewMatrix",(()=>{})),this._onCameraProjMatrix=v.camera.on("projMatrix",(()=>{})),this._onSceneTick=v.on("tick",(()=>{const s=Math.abs(f.lenVec3(f.subVec3(v.camera.eye,this._pos,e)));if(s!==t&&"perspective"===y.projection){const e=.07*(Math.tan(y.perspective.fov*f.DEGTORAD)*s);l.scale=[e,e,e],t=s;}if("ortho"===y.projection){const e=y.ortho.scale/10;l.scale=[e,e,e],t=s;}}));}const b=function(){const e=new Float64Array(2);return function(t){if(t){for(var s=t.target,i=0,r=0;s.offsetParent;)i+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;e[0]=t.pageX-i,e[1]=t.pageY-r;}else t=window.event,e[0]=t.x,e[1]=t.y;return e}}(),w=function(){const t=f.mat4();return function(s,i){return f.quaternionToMat4(e._rootNode.quaternion,t),f.transformVec3(t,s,i),f.normalizeVec3(i),i}}();var P=function(){const e=f.vec3();return function(t){const s=Math.abs(t[0]);return s>Math.abs(t[1])&&s>Math.abs(t[2])?f.cross3Vec3(t,[0,1,0],e):f.cross3Vec3(t,[1,0,0],e),f.cross3Vec3(e,t,e),f.normalizeVec3(e),e}}();const T=function(){const t=f.vec3(),s=f.vec3(),i=f.vec4();return function(r,o,n){w(r,i);const a=P(i,o,n);M(o,a,t),M(n,a,s),f.subVec3(s,t);const h=f.dotVec3(s,i);e._pos[0]+=i[0]*h,e._pos[1]+=i[1]*h,e._pos[2]+=i[2]*h,e._rootNode.position=e._pos,e._sectionPlane&&(e._sectionPlane.pos=e._pos);}}();var x=function(){const t=f.vec4(),s=f.vec4(),i=f.vec4(),r=f.vec4();return function(o,n,a){w(o,r);if(!(M(n,r,t)&&M(a,r,s))){const e=P(r,n,a);M(n,e,t,1),M(a,e,s,1);var h=f.dotVec3(t,r);t[0]-=h*r[0],t[1]-=h*r[1],t[2]-=h*r[2],h=f.dotVec3(s,r),s[0]-=h*r[0],s[1]-=h*r[1],s[2]-=h*r[2];}f.normalizeVec3(t),f.normalizeVec3(s),h=f.dotVec3(t,s),h=f.clamp(h,-1,1);var l=Math.acos(h)*f.RADTODEG;f.cross3Vec3(t,s,i),f.dotVec3(i,r)<0&&(l=-l),e._rootNode.rotate(o,l),D();}}(),M=function(){const t=f.vec4([0,0,0,1]),s=f.mat4();return function(i,r,o,n){n=n||0,t[0]=i[0]/_.width*2-1,t[1]=-(i[1]/_.height*2-1),t[2]=0,t[3]=1,f.mulMat4(y.projMatrix,y.viewMatrix,s),f.inverseMat4(s),f.transformVec4(s,t,t),f.mulVec4Scalar(t,1/t[3]);var a=y.eye;f.subVec4(t,a,t);const h=e._sectionPlane.pos;var l=-f.dotVec3(h,r)-n,u=f.dotVec3(r,t);if(Math.abs(u)>.005){var c=-(f.dotVec3(r,a)+l)/u;return f.mulVec3Scalar(t,c,o),f.addVec3(o,a),f.subVec3(o,h,o),!0}return !1}}();const D=function(){const t=f.vec3(),s=f.mat4();return function(){e.sectionPlane&&(f.quaternionToMat4(l.quaternion,s),f.transformVec3(s,[0,0,1],t),e._setSectionPlaneDir(t));}}();var A,C=!1;this._onCameraControlHover=this._viewer.cameraControl.on("hoverEnter",(e=>{if(!this._visible)return;if(C)return;var l;t=!1,A&&(A.visible=!1);switch(e.entity.id){case this._displayMeshes.xAxisArrowHandle.id:case this._displayMeshes.xAxisHandle.id:l=this._affordanceMeshes.xAxisArrow,u=i;break;case this._displayMeshes.yAxisArrowHandle.id:case this._displayMeshes.yShaftHandle.id:l=this._affordanceMeshes.yAxisArrow,u=r;break;case this._displayMeshes.zAxisArrowHandle.id:case this._displayMeshes.zAxisHandle.id:l=this._affordanceMeshes.zAxisArrow,u=o;break;case this._displayMeshes.xCurveHandle.id:l=this._affordanceMeshes.xHoop,u=n;break;case this._displayMeshes.yCurveHandle.id:l=this._affordanceMeshes.yHoop,u=a;break;case this._displayMeshes.zCurveHandle.id:l=this._affordanceMeshes.zHoop,u=h;break;default:return void(u=s)}l&&(l.visible=!0),A=l,t=!0;})),this._onCameraControlHoverLeave=this._viewer.cameraControl.on("hoverOut",(e=>{this._visible&&(A&&(A.visible=!1),A=null,u=s);})),_.addEventListener("mousedown",this._canvasMouseDownListener=e=>{if(e.preventDefault(),this._visible&&t&&(this._viewer.cameraControl.pointerEnabled=!1,1===e.which)){C=!0;var s=b(e);c=u,p[0]=s[0],p[1]=s[1];}}),_.addEventListener("mousemove",this._canvasMouseMoveListener=e=>{if(!this._visible)return;if(!C)return;var t=b(e);const s=t[0],l=t[1];switch(c){case i:T(d,p,t);break;case r:T(m,p,t);break;case o:T(g,p,t);break;case n:x(d,p,t);break;case a:x(m,p,t);break;case h:x(g,p,t);}p[0]=s,p[1]=l;}),_.addEventListener("mouseup",this._canvasMouseUpListener=e=>{this._visible&&(this._viewer.cameraControl.pointerEnabled=!0,C&&(e.which,C=!1,t=!1));}),_.addEventListener("wheel",this._canvasWheelListener=e=>{if(this._visible)Math.max(-1,Math.min(1,40*-e.deltaY));});}_destroy(){this._unbindEvents(),this._destroyNodes();}_unbindEvents(){const e=this._viewer,t=e.scene,s=t.canvas.canvas,i=e.camera,r=e.cameraControl;t.off(this._onSceneTick),s.removeEventListener("mousedown",this._canvasMouseDownListener),s.removeEventListener("mousemove",this._canvasMouseMoveListener),s.removeEventListener("mouseup",this._canvasMouseUpListener),s.removeEventListener("wheel",this._canvasWheelListener),i.off(this._onCameraViewMatrix),i.off(this._onCameraProjMatrix),r.off(this._onCameraControlHover),r.off(this._onCameraControlHoverLeave);}_destroyNodes(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={};}}class _f{constructor(e,t,s){this.id=s.id,this._sectionPlane=s,this._mesh=new Yi(t,{id:s.id,geometry:new Mt(t,Dt({xSize:.5,ySize:.5,zSize:.001})),material:new Ft(t,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new Rt(t,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new Et(t,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new Et(t,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});{const e=f.vec3([0,0,0]),t=f.vec3(),s=f.vec3([0,0,1]),i=f.vec4(4),r=f.vec3(),o=()=>{const o=this._sectionPlane.scene.center,n=[-this._sectionPlane.dir[0],-this._sectionPlane.dir[1],-this._sectionPlane.dir[2]];f.subVec3(o,this._sectionPlane.pos,e);const a=-f.dotVec3(n,e);f.normalizeVec3(n),f.mulVec3Scalar(n,a,t);const h=f.vec3PairToQuaternion(s,this._sectionPlane.dir,i);r[0]=.1*t[0],r[1]=.1*t[1],r[2]=.1*t[2],this._mesh.quaternion=h,this._mesh.position=r;};this._onSectionPlanePos=this._sectionPlane.on("pos",o),this._onSectionPlaneDir=this._sectionPlane.on("dir",o);}this._highlighted=!1,this._selected=!1;}setHighlighted(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0];}getHighlighted(){return this._highlighted}setSelected(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1;}getSelected(){return this._selected}destroy(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy();}}class yf{constructor(e,t){if(!(t.onHoverEnterPlane&&t.onHoverLeavePlane&&t.onClickedNothing&&t.onClickedPlane))throw "Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=e,this._viewer=e.viewer,this._onHoverEnterPlane=t.onHoverEnterPlane,this._onHoverLeavePlane=t.onHoverLeavePlane,this._onClickedNothing=t.onClickedNothing,this._onClickedPlane=t.onClickedPlane,this._visible=!0,this._planes={},this._canvas=t.overviewCanvas,this._scene=new Ut(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new pt(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new pt(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new pt(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;{const e=this._scene.camera,t=f.rotationMat4c(-90*f.DEGTORAD,1,0,0),s=f.vec3(),i=f.vec3(),r=f.vec3();this._synchCamera=()=>{const o=this._viewer.camera.eye,n=this._viewer.camera.look,a=this._viewer.camera.up;f.mulVec3Scalar(f.normalizeVec3(f.subVec3(o,n,s)),7),this._zUp?(f.transformVec3(t,s,i),f.transformVec3(t,a,r),e.look=[0,0,0],e.eye=f.transformVec3(t,s,i),e.up=f.transformPoint3(t,a,r)):(e.look=[0,0,0],e.eye=s,e.up=a);};}this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(e=>{this._scene.camera.perspective.fov=e;}));var s=null;this._onInputMouseMove=this._scene.input.on("mousemove",(e=>{const t=this._scene.pick({canvasPos:e});if(t){if(!s||t.entity.id!==s.id){if(s){this._planes[s.id]&&this._onHoverLeavePlane(s.id);}s=t.entity;this._planes[s.id]&&this._onHoverEnterPlane(s.id);}}else s&&(this._onHoverLeavePlane(s.id),s=null);})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=()=>{if(s){this._planes[s.id]&&this._onClickedPlane(s.id);}else this._onClickedNothing();}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=()=>{s&&(this._onHoverLeavePlane(s.id),s=null);}),this.setVisible(t.overviewVisible);}addSectionPlane(e){this._planes[e.id]=new _f(this,this._scene,e);}setPlaneHighlighted(e,t){const s=this._planes[e];s&&s.setHighlighted(t);}setPlaneSelected(e,t){const s=this._planes[e];s&&s.setSelected(t);}removeSectionPlane(e){const t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id]);}setVisible(e=!0){this._visible=e,this._canvas.style.visibility=e?"visible":"hidden";}getVisible(){return this._visible}destroy(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy();}}const vf=f.AABB3(),bf=f.vec3();class wf extends h{constructor(e,t={}){if(super("SectionPlanes",e),this._freeControls=[],this._sectionPlanes=e.scene.sectionPlanes,this._controls={},this._shownControlId=null,null!==t.overviewCanvasId&&void 0!==t.overviewCanvasId){const e=document.getElementById(t.overviewCanvasId);e?this._overview=new yf(this,{overviewCanvas:e,visible:t.overviewVisible,onHoverEnterPlane:e=>{this._overview.setPlaneHighlighted(e,!0);},onHoverLeavePlane:e=>{this._overview.setPlaneHighlighted(e,!1);},onClickedPlane:e=>{if(this.getShownControl()===e)return void this.hideControl();this.showControl(e);const t=this.sectionPlanes[e].pos;vf.set(this.viewer.scene.aabb),f.getAABB3Center(vf,bf),vf[0]+=t[0]-bf[0],vf[1]+=t[1]-bf[1],vf[2]+=t[2]-bf[2],vf[3]+=t[0]-bf[0],vf[4]+=t[1]-bf[1],vf[5]+=t[2]-bf[2],this.viewer.cameraFlight.flyTo({aabb:vf,fitFOV:65});},onClickedNothing:()=>{this.hideControl();}}):this.warn("Can't find overview canvas: '"+t.overviewCanvasId+"' - will create plugin without overview");}this._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(e=>{this._sectionPlaneCreated(e);}));}setOverviewVisible(e){this._overview&&this._overview.setVisible(e);}getOverviewVisible(){if(this._overview)return this._overview.getVisible()}get sectionPlanes(){return this._sectionPlanes}createSectionPlane(e={}){void 0!==e.id&&null!==e.id&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);return new er(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0})}_sectionPlaneCreated(e){const t=this._freeControls.length>0?this._freeControls.pop():new gf(this);t._setSectionPlane(e),t.setVisible(!1),this._controls[e.id]=t,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",(()=>{this._sectionPlaneDestroyed(e);}));}flipSectionPlanes(){const e=this.viewer.scene.sectionPlanes;for(let t in e){e[t].flipDir();}}showControl(e){const t=this._controls[e];t?(this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e):this.error("Control not found: "+e);}getShownControl(){return this._shownControlId}hideControl(){for(var e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null;}destroySectionPlane(e){var t=this.viewer.scene.sectionPlanes[e];t?(this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+e);}_sectionPlaneDestroyed(e){this._overview&&this._overview.removeSectionPlane(e);const t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t));}clear(){const e=Object.keys(this._sectionPlanes);for(var t=0,s=e.length;t<s;t++)this.destroySectionPlane(e[t]);}send(e,t){switch(e){case"snapshotStarting":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!0);break;case"snapshotFinished":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!1);break;case"clearSectionPlanes":this.clear();}}destroy(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),super.destroy();}_destroyFreeControls(){for(var e=this._freeControls.pop();e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated);}}const Mf=f.vec3();const Lf=f.vec3();const Gf=f.vec3(),Hf=f.mat4();function Uf(e,t){const s=e.rootMetaObject;return s?zf(s,t):(t.push("Can't build storeys hierarchy: model is empty"),!1)}function zf(e,t,s=0,i,r){i=i||{foundIFCBuildingStoreys:!1};const o=e.type,n=e.children;if("IfcBuilding"===o)r=!0;else if("IfcBuildingStorey"===o){if(!r)return t.push("Can't build storeys hierarchy: IfcBuildingStorey found without parent IfcBuilding"),!1;i.foundIFCBuildingStoreys=!0;}if(n)for(let e=0,o=n.length;e<o;e++){if(!zf(n[e],t,s+1,i,r))return !1}return 0===s&&i.foundIFCBuildingStoreys,!0}const Wf=new s;class Xf{constructor(e,t,s,i,r){if(!r.containerElement)throw "Config expected: containerElement";const o=i.rootMetaObject;o&&(this.errors=[],this.valid=!0,this.metaModel=i,this._id=Wf.addItem(),this._baseId=""+this._id,this._viewer=e,this._treeViewPlugin=t,this._rootMetaObject=o,this._containerElement=r.containerElement,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._rootName=r.rootName,this._sortNodes=r.sortNodes,this._pruneEmptyNodes=r.pruneEmptyNodes,this._showListItemElementId=null,this._containerElement.oncontextmenu=e=>{e.preventDefault();},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",(e=>{if(this._muteSceneEvents)return;const t=e.id,s=this._objectNodes[t];if(!s)return;const i=e.visible;if(!(i!==s.checked))return;this._muteTreeEvents=!0,s.checked=i,i?s.numVisibleEntities++:s.numVisibleEntities--;const r=document.getElementById(s.nodeId);r&&(r.checked=i);let o=s.parent;for(;o;){o.checked=i,i?o.numVisibleEntities++:o.numVisibleEntities--;const e=document.getElementById(o.nodeId);if(e){const t=o.numVisibleEntities>0;t!==e.checked&&(e.checked=t);}o=o.parent;}this._muteTreeEvents=!1;})),this.switchExpandHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._expandSwitchElement(t);},this.switchCollapseHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._collapseSwitchElement(t);},this._checkboxChangeHandler=e=>{if(this._muteTreeEvents)return;this._muteSceneEvents=!0;const t=e.target,s=t.checked,i=t.id,r=this._nodeToObjectID(i),o=this._objectNodes[r],n=this._viewer.scene.objects;let a=0;this._withNodeTree(o,(e=>{const t=e.objectId,i=e.nodeId,r=n[t],o=0===e.children.length;e.numVisibleEntities=s?e.numEntities:0,o&&s!==e.checked&&a++,e.checked=s;const h=document.getElementById(i);h&&(h.checked=s),r&&(r.visible=s);}));let h=o.parent;for(;h;){h.checked=s;const e=document.getElementById(h.nodeId);s?h.numVisibleEntities+=a:h.numVisibleEntities-=a;const t=h.numVisibleEntities>0;t!==e.checked&&(e.checked=t),h=h.parent;}this._muteSceneEvents=!1;},this._hierarchy=r.hierarchy||"containment",this._autoExpandDepth=r.autoExpandDepth||0,this._createNodes());}_nodeToObjectID(e){return e.substring(this._baseId.length)}_objectToNodeID(e){return this._baseId+e}setAutoExpandDepth(e=0){this._autoExpandDepth=e;}setHierarchy(e){this._hierarchy!==e&&(this._hierarchy=e,this._createNodes());}_createNodes(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._validate(),this.valid||"storeys"!==this._hierarchy?this._createEnabledNodes():this._createDisabledNodes();}_validate(){switch(this.errors=[],this._hierarchy){case"storeys":this.valid=Uf(this.metaModel,this.errors);break;case"types":this.valid=(e=this.metaModel,t=this.errors,!!e.rootMetaObject||(t.push("Can't build types hierarchy: model is empty"),!1));break;default:this.valid=function(e,t){return !!e.rootMetaObject||(t.push("Can't build containment hierarchy: model is empty"),!1)}(this.metaModel,this.errors);}var e,t;return this.valid}_createEnabledNodes(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),0===this._rootNodes.length&&this._treeViewPlugin.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - perhaps this model is not an IFC model?");break;case"types":this._createTypesNodes();break;default:this._createContainmentNodes();}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth);}_createDisabledNodes(){const e=this._rootMetaObject,t=e.type,s=e.name,i=s&&""!==s&&"Undefined"!==s&&"Default"!==s?s:t,r=document.createElement("ul"),o=document.createElement("li");r.appendChild(o),this._containerElement.appendChild(r),this._rootElement=r;const n=document.createElement("a");n.href="#",n.textContent="!",n.classList.add("warn"),n.classList.add("warning"),o.appendChild(n);const a=document.createElement("span");a.textContent=i,o.appendChild(a);}_findEmptyNodes(e=this._rootMetaObject,t=0){const s=this._treeViewPlugin.viewer.scene,i=e.children,r=e.id,o=s.objects[r];if(e._countEntities=0,o&&e._countEntities++,i)for(let t=0,s=i.length;t<s;t++){const s=i[t];s._countEntities=this._findEmptyNodes(s),e._countEntities+=s._countEntities;}return e._countEntities}_createStoreysNodes(e=this._rootMetaObject,t,s,i){if(this._pruneEmptyNodes&&0===e._countEntities)return;const r=e.type,o=e.name,n=e.children,a=e.id;if("IfcBuilding"===r)t={nodeId:this._objectToNodeID(a),objectId:a,title:this._rootName||(o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r),type:r,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t;else if("IfcBuildingStorey"===r){if(!t)return void this._treeViewPlugin.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - model does not have an IfcBuilding object, or is not an IFC model");s={nodeId:this._objectToNodeID(a),objectId:a,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r,type:r,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},t.children.push(s),this._objectNodes[s.objectId]=s,i={};}else if(s){if(this._viewer.scene.objects[a]){let e=(i=i||{})[r];if(!e){const t=s.objectId+"."+r;e={nodeId:this._objectToNodeID(t),objectId:t,title:r,type:r,parent:s,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},s.children.push(e),this._objectNodes[t]=e,i[r]=e;}const t={nodeId:this._objectToNodeID(a),objectId:a,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r,type:r,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};e.children.push(t),this._objectNodes[t.objectId]=t;}}if(n)for(let e=0,r=n.length;e<r;e++){const r=n[e];this._createStoreysNodes(r,t,s,i);}}_createTypesNodes(e=this._rootMetaObject,t,s){if(this._pruneEmptyNodes&&0===e._countEntities)return;const i=e.type,r=e.name,o=e.children,n=e.id;if(e.id===this._rootMetaObject.id)t={nodeId:this._objectToNodeID(n),objectId:n,title:this._rootName||(r&&""!==r&&"Undefined"!==r&&"Default"!==r?r:i),type:i,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,s={};else if(t){if(this._viewer.scene.objects[n]){let e=s[i];e||(e={nodeId:this._objectToNodeID(t.objectId+"."+i),objectId:t.objectId+"."+i,title:i,type:i,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},t.children.push(e),this._objectNodes[e.objectId]=e,s[i]=e);const o={nodeId:this._objectToNodeID(n),objectId:n,title:r&&""!==r&&"Default"!==r?r:i,type:i,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};e.children.push(o),this._objectNodes[o.objectId]=o;}}if(o)for(let e=0,i=o.length;e<i;e++){const i=o[e];this._createTypesNodes(i,t,s);}}_createContainmentNodes(e=this._rootMetaObject,t){if(this._pruneEmptyNodes&&0===e._countEntities)return;const s=e.type,i=e.name||s,r=e.children,o=e.id,n={nodeId:this._objectToNodeID(o),objectId:o,title:t?i&&""!==i&&"Undefined"!==i&&"Default"!==i?i:s:this._rootName||i,type:s,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};if(t?t.children.push(n):this._rootNodes.push(n),this._objectNodes[n.objectId]=n,r)for(let e=0,t=r.length;e<t;e++){const t=r[e];this._createContainmentNodes(t,n);}}_doSortNodes(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e];this._sortChildren(t);}}_sortChildren(e){const t=e.children;if(t&&0!==t.length){"storeys"===this._hierarchy&&"IfcBuilding"===e.type?t.sort(this._getSpatialSortFunc()):t.sort(this._alphaSortFunc);for(let e=0,s=t.length;e<s;e++){const s=t[e];this._sortChildren(s);}}}_getSpatialSortFunc(){const e=this._treeViewPlugin.viewer,t=e.scene,s=t.camera,i=e.metaScene;return this._spatialSortFunc||(this._spatialSortFunc=(e,r)=>{e.aabb&&r.aabb||(e.aabb||(e.aabb=t.getAABB(i.getObjectIDsInSubtree(e.objectId))),r.aabb||(r.aabb=t.getAABB(i.getObjectIDsInSubtree(r.objectId))));let o=0;return o=s.xUp?0:s.yUp?1:2,e.aabb[o]>r.aabb[o]?-1:e.aabb[o]<r.aabb[o]?1:0})}_alphaSortFunc(e,t){const s=e.title.toUpperCase(),i=t.title.toUpperCase();return s<i?-1:s>i?1:0}_synchNodesToEntities(){const e=this._rootMetaObject.getObjectIDsInSubtree(),t=this._viewer.metaScene.metaObjects,s=this._viewer.scene.objects;for(let i=0,r=e.length;i<r;i++){const r=e[i];if(t[r]){const e=this._objectNodes[r];if(e){const t=s[r];if(t){const s=t.visible;e.numEntities=1,s?(e.numVisibleEntities=1,e.checked=!0):(e.numVisibleEntities=0,e.checked=!1);let i=e.parent;for(;i;)i.numEntities++,s&&(i.numVisibleEntities++,i.checked=!0),i=i.parent;}}}}}_withNodeTree(e,t){t(e);const s=e.children;if(s)for(let e=0,i=s.length;e<i;e++)this._withNodeTree(s[e],t);}_createTrees(){if(0===this._rootNodes.length)return;const e=this._rootNodes.map((e=>this._createNodeElement(e))),t=document.createElement("ul");e.forEach((e=>{t.appendChild(e);})),this._containerElement.appendChild(t),this._rootElement=t;}_createNodeElement(e){const t=document.createElement("li"),s=e.nodeId;if(t.id="node-"+s,e.children.length>0){const e="switch-"+s,i=document.createElement("a");i.href="#",i.id=e,i.textContent="+",i.classList.add("plus"),i.addEventListener("click",this.switchExpandHandler),t.appendChild(i);}const i=document.createElement("input");i.id=s,i.type="checkbox",i.checked=e.checked,i.style["pointer-events"]="all",i.addEventListener("change",this._checkboxChangeHandler),t.appendChild(i);const r=document.createElement("span");return r.textContent=e.title,t.appendChild(r),r.oncontextmenu=t=>{this._treeViewPlugin.fire("contextmenu",{event:t,viewer:this._viewer,treeViewPlugin:this._treeViewPlugin,treeViewNode:e}),t.preventDefault();},r.onclick=t=>{this._treeViewPlugin.fire("nodeTitleClicked",{event:t,viewer:this._viewer,treeViewPlugin:this._treeViewPlugin,treeViewNode:e}),t.preventDefault();},t}expandToDepth(e){const t=(s,i)=>{if(i===e)return;const r="switch-"+s.nodeId,o=document.getElementById(r);if(o){this._expandSwitchElement(o);const e=s.children;for(var n=0,a=e.length;n<a;n++){const s=e[n];t(s,i+1);}}};for(let e=0,s=this._rootNodes.length;e<s;e++){const s=this._rootNodes[e];t(s,0);}}collapse(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e].objectId;this._collapseNode(t);}}showNode(e){this._showListItemElementId&&this.unShowNode();const t=this._objectNodes[e];if(!t)return;const s=t.nodeId,i="switch-"+s,r=document.getElementById(i);if(r)return this._expandSwitchElement(r),void r.scrollIntoView();const o=[];o.unshift(t);let n=t.parent;for(;n;)o.unshift(n),n=n.parent;for(let e=0,t=o.length;e<t;e++){const t="switch-"+o[e].nodeId,s=document.getElementById(t);s&&this._expandSwitchElement(s);}const a="node-"+s,h=document.getElementById(a);h.scrollIntoView({block:"center"}),h.classList.add("highlighted-node"),this._showListItemElementId=a;}unShowNode(){if(!this._showListItemElementId)return;const e=document.getElementById(this._showListItemElementId);e?(e.classList.remove("highlighted-node"),this._showListItemElementId=null):this._showListItemElementId=null;}_expandSwitchElement(e){const t=e.parentElement;if(t.getElementsByTagName("li")[0])return;const s=t.id.replace("node-",""),i=this._nodeToObjectID(s),r=this._objectNodes[i].children.map((e=>this._createNodeElement(e))),o=document.createElement("ul");r.forEach((e=>{o.appendChild(e);})),t.appendChild(o),e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",this.switchExpandHandler),e.addEventListener("click",this.switchCollapseHandler);}_collapseNode(e){const t="switch-"+this._objectToNodeID(e),s=document.getElementById(t);this._collapseSwitchElement(s);}_collapseSwitchElement(e){if(!e)return;const t=e.parentElement;if(!t)return;const s=t.querySelector("ul");s&&(t.removeChild(s),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",this.switchCollapseHandler),e.addEventListener("click",this.switchExpandHandler));}destroy(){this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0,Wf.removeItem(this._id));}}class Yf extends h{constructor(e,t={}){if(super("TreeViewPlugin",e),t.containerElement){if(this._containerElement=t.containerElement,this._modelTreeViews={},this._autoAddModels=!1!==t.autoAddModels,this._autoExpandDepth=t.autoExpandDepth||0,this._sortNodes=!1!==t.sortNodes,this._pruneEmptyNodes=!1!==t.pruneEmptyNodes,this._autoAddModels){const e=Object.keys(this.viewer.metaScene.metaModels);for(let t=0,s=e.length;t<s;t++){const s=e[t];this.addModel(s);}this.viewer.scene.on("modelLoaded",(e=>{this.viewer.metaScene.metaModels[e]&&this.addModel(e);}));}this.hierarchy=t.hierarchy;}else this.error("Config expected: containerElement");}get modelTreeViews(){return this._modelTreeViews}set hierarchy(e){"containment"!==(e=e||"containment")&&"storeys"!==e&&"types"!==e&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy=e;for(let e in this._modelTreeViews)this._modelTreeViews.hasOwnProperty(e)&&this._modelTreeViews[e].setHierarchy(this._hierarchy);}get hierarchy(){return this._hierarchy}addModel(e,t={}){if(!this._containerElement)return;const s=this.viewer.scene.models[e];if(!s)throw "Model not found: "+e;const i=this.viewer.metaScene.metaModels[e];if(!i)return void this.error("MetaModel not found: "+e);if(this._modelTreeViews[e])return void this.warn("Model already added: "+e);const r=new Xf(this.viewer,this,s,i,{containerElement:this._containerElement,autoExpandDepth:this._autoExpandDepth,hierarchy:this._hierarchy,sortNodes:this._sortNodes,pruneEmptyNodes:this._pruneEmptyNodes,rootName:t.rootName});return this._modelTreeViews[e]=r,s.on("destroyed",(()=>{this.removeModel(s.id);})),r}removeModel(e){if(!this._containerElement)return;const t=this._modelTreeViews[e];t&&(t.destroy(),delete this._modelTreeViews[e]);}collapse(){for(let e in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(e)){this._modelTreeViews[e].collapse();}}showNode(e){this.unShowNode();const t=this.viewer.metaScene.metaObjects[e];if(!t)return void this.error("MetaObject not found: "+e);const s=t.metaModel.id,i=this._modelTreeViews[s];i?i.showNode(e):this.error("Object not in this TreeView: "+e);}unShowNode(){for(let e in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(e)){this._modelTreeViews[e].unShowNode();}}expandToDepth(e){for(let t in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(t)){const s=this._modelTreeViews[t];s.collapse(),s.expandToDepth(e);}}withNodeTree(e,t){t(e);const s=e.children;if(s)for(let e=0,i=s.length;e<i;e++)this.withNodeTree(s[e],t);}destroy(){if(this._containerElement){for(let e in this._modelTreeViews)this._modelTreeViews.hasOwnProperty(e)&&this._modelTreeViews[e].destroy();this._modelTreeViews={},super.destroy();}}}const Kf=f.vec3(),Jf=f.vec3(),Zf=f.mat4();class im{constructor(){}getMetaModel(e,t,s){b.loadJSON(e,(e=>{t(e);}),(function(e){s(e);}));}getXKT(e,t,s){var i=()=>{};t=t||i,s=s||i;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),s=new Uint8Array(e);for(var n=0;n<o.length;n++)s[n]=o.charCodeAt(n);t(e);}catch(e){s(e);}}else {const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onreadystatechange=function(){4===i.readyState&&(200===i.status?t(i.response):s("getXKT error : "+i.response));},i.send(null);}}}
/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */var rm=(e,t,s,i)=>{let r=65535&e|0,o=e>>>16&65535|0,n=0;for(;0!==s;){n=s>2e3?2e3:s,s-=n;do{r=r+t[i++]|0,o=o+r|0;}while(--n);r%=65521,o%=65521;}return r|o<<16|0};const om=new Uint32Array((()=>{let e,t=[];for(var s=0;s<256;s++){e=s;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[s]=e;}return t})());var nm=(e,t,s,i)=>{const r=om,o=i+s;e^=-1;for(let s=i;s<o;s++)e=e>>>8^r[255&(e^t[s])];return -1^e},am=function(e,t){let s,i,r,o,n,a,h,l,u,c,p,d,f,m,g,_,y,v,b,w,P,T,x,M;const D=e.state;s=e.next_in,x=e.input,i=s+(e.avail_in-5),r=e.next_out,M=e.output,o=r-(t-e.avail_out),n=r+(e.avail_out-257),a=D.dmax,h=D.wsize,l=D.whave,u=D.wnext,c=D.window,p=D.hold,d=D.bits,f=D.lencode,m=D.distcode,g=(1<<D.lenbits)-1,_=(1<<D.distbits)-1;e:do{d<15&&(p+=x[s++]<<d,d+=8,p+=x[s++]<<d,d+=8),y=f[p&g];t:for(;;){if(v=y>>>24,p>>>=v,d-=v,v=y>>>16&255,0===v)M[r++]=65535&y;else {if(!(16&v)){if(0==(64&v)){y=f[(65535&y)+(p&(1<<v)-1)];continue t}if(32&v){D.mode=12;break e}e.msg="invalid literal/length code",D.mode=30;break e}b=65535&y,v&=15,v&&(d<v&&(p+=x[s++]<<d,d+=8),b+=p&(1<<v)-1,p>>>=v,d-=v),d<15&&(p+=x[s++]<<d,d+=8,p+=x[s++]<<d,d+=8),y=m[p&_];s:for(;;){if(v=y>>>24,p>>>=v,d-=v,v=y>>>16&255,!(16&v)){if(0==(64&v)){y=m[(65535&y)+(p&(1<<v)-1)];continue s}e.msg="invalid distance code",D.mode=30;break e}if(w=65535&y,v&=15,d<v&&(p+=x[s++]<<d,d+=8,d<v&&(p+=x[s++]<<d,d+=8)),w+=p&(1<<v)-1,w>a){e.msg="invalid distance too far back",D.mode=30;break e}if(p>>>=v,d-=v,v=r-o,w>v){if(v=w-v,v>l&&D.sane){e.msg="invalid distance too far back",D.mode=30;break e}if(P=0,T=c,0===u){if(P+=h-v,v<b){b-=v;do{M[r++]=c[P++];}while(--v);P=r-w,T=M;}}else if(u<v){if(P+=h+u-v,v-=u,v<b){b-=v;do{M[r++]=c[P++];}while(--v);if(P=0,u<b){v=u,b-=v;do{M[r++]=c[P++];}while(--v);P=r-w,T=M;}}}else if(P+=u-v,v<b){b-=v;do{M[r++]=c[P++];}while(--v);P=r-w,T=M;}for(;b>2;)M[r++]=T[P++],M[r++]=T[P++],M[r++]=T[P++],b-=3;b&&(M[r++]=T[P++],b>1&&(M[r++]=T[P++]));}else {P=r-w;do{M[r++]=M[P++],M[r++]=M[P++],M[r++]=M[P++],b-=3;}while(b>2);b&&(M[r++]=M[P++],b>1&&(M[r++]=M[P++]));}break}}break}}while(s<i&&r<n);b=d>>3,s-=b,d-=b<<3,p&=(1<<d)-1,e.next_in=s,e.next_out=r,e.avail_in=s<i?i-s+5:5-(s-i),e.avail_out=r<n?n-r+257:257-(r-n),D.hold=p,D.bits=d;};const hm=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),lm=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),um=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),cm=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var pm=(e,t,s,i,r,o,n,a)=>{const h=a.bits;let l,u,c,p,d,f,m=0,g=0,_=0,y=0,v=0,b=0,w=0,P=0,T=0,x=0,M=null,D=0;const A=new Uint16Array(16),C=new Uint16Array(16);let I,F,B,E=null,S=0;for(m=0;m<=15;m++)A[m]=0;for(g=0;g<i;g++)A[t[s+g]]++;for(v=h,y=15;y>=1&&0===A[y];y--);if(v>y&&(v=y),0===y)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(_=1;_<y&&0===A[_];_++);for(v<_&&(v=_),P=1,m=1;m<=15;m++)if(P<<=1,P-=A[m],P<0)return -1;if(P>0&&(0===e||1!==y))return -1;for(C[1]=0,m=1;m<15;m++)C[m+1]=C[m]+A[m];for(g=0;g<i;g++)0!==t[s+g]&&(n[C[t[s+g]]++]=g);if(0===e?(M=E=n,f=19):1===e?(M=hm,D-=257,E=lm,S-=257,f=256):(M=um,E=cm,f=-1),x=0,g=0,m=_,d=o,b=v,w=0,c=-1,T=1<<v,p=T-1,1===e&&T>852||2===e&&T>592)return 1;for(;;){I=m-w,n[g]<f?(F=0,B=n[g]):n[g]>f?(F=E[S+n[g]],B=M[D+n[g]]):(F=96,B=0),l=1<<m-w,u=1<<b,_=u;do{u-=l,r[d+(x>>w)+u]=I<<24|F<<16|B|0;}while(0!==u);for(l=1<<m-1;x&l;)l>>=1;if(0!==l?(x&=l-1,x+=l):x=0,g++,0==--A[m]){if(m===y)break;m=t[s+n[g]];}if(m>v&&(x&p)!==c){for(0===w&&(w=v),d+=_,b=m-w,P=1<<b;b+w<y&&(P-=A[b+w],!(P<=0));)b++,P<<=1;if(T+=1<<b,1===e&&T>852||2===e&&T>592)return 1;c=x&p,r[c]=v<<24|b<<16|d-o|0;}}return 0!==x&&(r[d+x]=m-w<<24|64<<16|0),a.bits=v,0},dm={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{Z_FINISH:fm,Z_BLOCK:mm,Z_TREES:gm,Z_OK:_m,Z_STREAM_END:ym,Z_NEED_DICT:vm,Z_STREAM_ERROR:bm,Z_DATA_ERROR:wm,Z_MEM_ERROR:Pm,Z_BUF_ERROR:Tm,Z_DEFLATED:xm}=dm,Mm=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Dm(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0;}const Am=e=>{if(!e||!e.state)return bm;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,_m},Cm=e=>{if(!e||!e.state)return bm;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Am(e)},Im=(e,t)=>{let s;if(!e||!e.state)return bm;const i=e.state;return t<0?(s=0,t=-t):(s=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?bm:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=s,i.wbits=t,Cm(e))},Fm=(e,t)=>{if(!e)return bm;const s=new Dm;e.state=s,s.window=null;const i=Im(e,t);return i!==_m&&(e.state=null),i};let Bm,Em,Sm=!0;const Rm=e=>{if(Sm){Bm=new Int32Array(512),Em=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(pm(1,e.lens,0,288,Bm,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;pm(2,e.lens,0,32,Em,0,e.work,{bits:5}),Sm=!1;}e.lencode=Bm,e.lenbits=9,e.distcode=Em,e.distbits=5;},Om=(e,t,s,i)=>{let r;const o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(t.subarray(s-o.wsize,s),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(t.subarray(s-i,s-i+r),o.wnext),(i-=r)?(o.window.set(t.subarray(s-i,s),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var Lm=Cm,Nm=Fm,km=(e,t)=>{let s,i,r,o,n,a,h,l,u,c,p,d,f,m,g,_,y,v,b,w,P,T,x=0;const M=new Uint8Array(4);let D,A;const C=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return bm;s=e.state,12===s.mode&&(s.mode=13),n=e.next_out,r=e.output,h=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,l=s.hold,u=s.bits,c=a,p=h,T=_m;e:for(;;)switch(s.mode){case 1:if(0===s.wrap){s.mode=13;break}for(;u<16;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(2&s.wrap&&35615===l){s.check=0,M[0]=255&l,M[1]=l>>>8&255,s.check=nm(s.check,M,2,0),l=0,u=0,s.mode=2;break}if(s.flags=0,s.head&&(s.head.done=!1),!(1&s.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",s.mode=30;break}if((15&l)!==xm){e.msg="unknown compression method",s.mode=30;break}if(l>>>=4,u-=4,P=8+(15&l),0===s.wbits)s.wbits=P;else if(P>s.wbits){e.msg="invalid window size",s.mode=30;break}s.dmax=1<<s.wbits,e.adler=s.check=1,s.mode=512&l?10:12,l=0,u=0;break;case 2:for(;u<16;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(s.flags=l,(255&s.flags)!==xm){e.msg="unknown compression method",s.mode=30;break}if(57344&s.flags){e.msg="unknown header flags set",s.mode=30;break}s.head&&(s.head.text=l>>8&1),512&s.flags&&(M[0]=255&l,M[1]=l>>>8&255,s.check=nm(s.check,M,2,0)),l=0,u=0,s.mode=3;case 3:for(;u<32;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}s.head&&(s.head.time=l),512&s.flags&&(M[0]=255&l,M[1]=l>>>8&255,M[2]=l>>>16&255,M[3]=l>>>24&255,s.check=nm(s.check,M,4,0)),l=0,u=0,s.mode=4;case 4:for(;u<16;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}s.head&&(s.head.xflags=255&l,s.head.os=l>>8),512&s.flags&&(M[0]=255&l,M[1]=l>>>8&255,s.check=nm(s.check,M,2,0)),l=0,u=0,s.mode=5;case 5:if(1024&s.flags){for(;u<16;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}s.length=l,s.head&&(s.head.extra_len=l),512&s.flags&&(M[0]=255&l,M[1]=l>>>8&255,s.check=nm(s.check,M,2,0)),l=0,u=0;}else s.head&&(s.head.extra=null);s.mode=6;case 6:if(1024&s.flags&&(d=s.length,d>a&&(d=a),d&&(s.head&&(P=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Uint8Array(s.head.extra_len)),s.head.extra.set(i.subarray(o,o+d),P)),512&s.flags&&(s.check=nm(s.check,i,d,o)),a-=d,o+=d,s.length-=d),s.length))break e;s.length=0,s.mode=7;case 7:if(2048&s.flags){if(0===a)break e;d=0;do{P=i[o+d++],s.head&&P&&s.length<65536&&(s.head.name+=String.fromCharCode(P));}while(P&&d<a);if(512&s.flags&&(s.check=nm(s.check,i,d,o)),a-=d,o+=d,P)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=8;case 8:if(4096&s.flags){if(0===a)break e;d=0;do{P=i[o+d++],s.head&&P&&s.length<65536&&(s.head.comment+=String.fromCharCode(P));}while(P&&d<a);if(512&s.flags&&(s.check=nm(s.check,i,d,o)),a-=d,o+=d,P)break e}else s.head&&(s.head.comment=null);s.mode=9;case 9:if(512&s.flags){for(;u<16;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(l!==(65535&s.check)){e.msg="header crc mismatch",s.mode=30;break}l=0,u=0;}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),e.adler=s.check=0,s.mode=12;break;case 10:for(;u<32;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}e.adler=s.check=Mm(l),l=0,u=0,s.mode=11;case 11:if(0===s.havedict)return e.next_out=n,e.avail_out=h,e.next_in=o,e.avail_in=a,s.hold=l,s.bits=u,vm;e.adler=s.check=1,s.mode=12;case 12:if(t===mm||t===gm)break e;case 13:if(s.last){l>>>=7&u,u-=7&u,s.mode=27;break}for(;u<3;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}switch(s.last=1&l,l>>>=1,u-=1,3&l){case 0:s.mode=14;break;case 1:if(Rm(s),s.mode=20,t===gm){l>>>=2,u-=2;break e}break;case 2:s.mode=17;break;case 3:e.msg="invalid block type",s.mode=30;}l>>>=2,u-=2;break;case 14:for(l>>>=7&u,u-=7&u;u<32;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",s.mode=30;break}if(s.length=65535&l,l=0,u=0,s.mode=15,t===gm)break e;case 15:s.mode=16;case 16:if(d=s.length,d){if(d>a&&(d=a),d>h&&(d=h),0===d)break e;r.set(i.subarray(o,o+d),n),a-=d,o+=d,h-=d,n+=d,s.length-=d;break}s.mode=12;break;case 17:for(;u<14;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(s.nlen=257+(31&l),l>>>=5,u-=5,s.ndist=1+(31&l),l>>>=5,u-=5,s.ncode=4+(15&l),l>>>=4,u-=4,s.nlen>286||s.ndist>30){e.msg="too many length or distance symbols",s.mode=30;break}s.have=0,s.mode=18;case 18:for(;s.have<s.ncode;){for(;u<3;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}s.lens[C[s.have++]]=7&l,l>>>=3,u-=3;}for(;s.have<19;)s.lens[C[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,D={bits:s.lenbits},T=pm(0,s.lens,0,19,s.lencode,0,s.work,D),s.lenbits=D.bits,T){e.msg="invalid code lengths set",s.mode=30;break}s.have=0,s.mode=19;case 19:for(;s.have<s.nlen+s.ndist;){for(;x=s.lencode[l&(1<<s.lenbits)-1],g=x>>>24,_=x>>>16&255,y=65535&x,!(g<=u);){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(y<16)l>>>=g,u-=g,s.lens[s.have++]=y;else {if(16===y){for(A=g+2;u<A;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(l>>>=g,u-=g,0===s.have){e.msg="invalid bit length repeat",s.mode=30;break}P=s.lens[s.have-1],d=3+(3&l),l>>>=2,u-=2;}else if(17===y){for(A=g+3;u<A;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}l>>>=g,u-=g,P=0,d=3+(7&l),l>>>=3,u-=3;}else {for(A=g+7;u<A;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}l>>>=g,u-=g,P=0,d=11+(127&l),l>>>=7,u-=7;}if(s.have+d>s.nlen+s.ndist){e.msg="invalid bit length repeat",s.mode=30;break}for(;d--;)s.lens[s.have++]=P;}}if(30===s.mode)break;if(0===s.lens[256]){e.msg="invalid code -- missing end-of-block",s.mode=30;break}if(s.lenbits=9,D={bits:s.lenbits},T=pm(1,s.lens,0,s.nlen,s.lencode,0,s.work,D),s.lenbits=D.bits,T){e.msg="invalid literal/lengths set",s.mode=30;break}if(s.distbits=6,s.distcode=s.distdyn,D={bits:s.distbits},T=pm(2,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,D),s.distbits=D.bits,T){e.msg="invalid distances set",s.mode=30;break}if(s.mode=20,t===gm)break e;case 20:s.mode=21;case 21:if(a>=6&&h>=258){e.next_out=n,e.avail_out=h,e.next_in=o,e.avail_in=a,s.hold=l,s.bits=u,am(e,p),n=e.next_out,r=e.output,h=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,l=s.hold,u=s.bits,12===s.mode&&(s.back=-1);break}for(s.back=0;x=s.lencode[l&(1<<s.lenbits)-1],g=x>>>24,_=x>>>16&255,y=65535&x,!(g<=u);){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(_&&0==(240&_)){for(v=g,b=_,w=y;x=s.lencode[w+((l&(1<<v+b)-1)>>v)],g=x>>>24,_=x>>>16&255,y=65535&x,!(v+g<=u);){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}l>>>=v,u-=v,s.back+=v;}if(l>>>=g,u-=g,s.back+=g,s.length=y,0===_){s.mode=26;break}if(32&_){s.back=-1,s.mode=12;break}if(64&_){e.msg="invalid literal/length code",s.mode=30;break}s.extra=15&_,s.mode=22;case 22:if(s.extra){for(A=s.extra;u<A;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}s.length+=l&(1<<s.extra)-1,l>>>=s.extra,u-=s.extra,s.back+=s.extra;}s.was=s.length,s.mode=23;case 23:for(;x=s.distcode[l&(1<<s.distbits)-1],g=x>>>24,_=x>>>16&255,y=65535&x,!(g<=u);){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(0==(240&_)){for(v=g,b=_,w=y;x=s.distcode[w+((l&(1<<v+b)-1)>>v)],g=x>>>24,_=x>>>16&255,y=65535&x,!(v+g<=u);){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}l>>>=v,u-=v,s.back+=v;}if(l>>>=g,u-=g,s.back+=g,64&_){e.msg="invalid distance code",s.mode=30;break}s.offset=y,s.extra=15&_,s.mode=24;case 24:if(s.extra){for(A=s.extra;u<A;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}s.offset+=l&(1<<s.extra)-1,l>>>=s.extra,u-=s.extra,s.back+=s.extra;}if(s.offset>s.dmax){e.msg="invalid distance too far back",s.mode=30;break}s.mode=25;case 25:if(0===h)break e;if(d=p-h,s.offset>d){if(d=s.offset-d,d>s.whave&&s.sane){e.msg="invalid distance too far back",s.mode=30;break}d>s.wnext?(d-=s.wnext,f=s.wsize-d):f=s.wnext-d,d>s.length&&(d=s.length),m=s.window;}else m=r,f=n-s.offset,d=s.length;d>h&&(d=h),h-=d,s.length-=d;do{r[n++]=m[f++];}while(--d);0===s.length&&(s.mode=21);break;case 26:if(0===h)break e;r[n++]=s.length,h--,s.mode=21;break;case 27:if(s.wrap){for(;u<32;){if(0===a)break e;a--,l|=i[o++]<<u,u+=8;}if(p-=h,e.total_out+=p,s.total+=p,p&&(e.adler=s.check=s.flags?nm(s.check,r,p,n-p):rm(s.check,r,p,n-p)),p=h,(s.flags?l:Mm(l))!==s.check){e.msg="incorrect data check",s.mode=30;break}l=0,u=0;}s.mode=28;case 28:if(s.wrap&&s.flags){for(;u<32;){if(0===a)break e;a--,l+=i[o++]<<u,u+=8;}if(l!==(4294967295&s.total)){e.msg="incorrect length check",s.mode=30;break}l=0,u=0;}s.mode=29;case 29:T=ym;break e;case 30:T=wm;break e;case 31:return Pm;default:return bm}return e.next_out=n,e.avail_out=h,e.next_in=o,e.avail_in=a,s.hold=l,s.bits=u,(s.wsize||p!==e.avail_out&&s.mode<30&&(s.mode<27||t!==fm))&&Om(e,e.output,e.next_out,p-e.avail_out),c-=e.avail_in,p-=e.avail_out,e.total_in+=c,e.total_out+=p,s.total+=p,s.wrap&&p&&(e.adler=s.check=s.flags?nm(s.check,r,p,e.next_out-p):rm(s.check,r,p,e.next_out-p)),e.data_type=s.bits+(s.last?64:0)+(12===s.mode?128:0)+(20===s.mode||15===s.mode?256:0),(0===c&&0===p||t===fm)&&T===_m&&(T=Tm),T},jm=e=>{if(!e||!e.state)return bm;let t=e.state;return t.window&&(t.window=null),e.state=null,_m},Gm=(e,t)=>{if(!e||!e.state)return bm;const s=e.state;return 0==(2&s.wrap)?bm:(s.head=t,t.done=!1,_m)},Hm=(e,t)=>{const s=t.length;let i,r,o;return e&&e.state?(i=e.state,0!==i.wrap&&11!==i.mode?bm:11===i.mode&&(r=1,r=rm(r,t,s,0),r!==i.check)?wm:(o=Om(e,t,s,s),o?(i.mode=31,Pm):(i.havedict=1,_m))):bm};const Vm=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);let Um=!0;try{String.fromCharCode.apply(null,new Uint8Array(1));}catch(rm){Um=!1;}const zm=new Uint8Array(256);for(let e=0;e<256;e++)zm[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;zm[254]=zm[254]=1;var Wm=(e,t)=>{const s=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return (new TextDecoder).decode(e.subarray(0,t));let i,r;const o=new Array(2*s);for(r=0,i=0;i<s;){let t=e[i++];if(t<128){o[r++]=t;continue}let n=zm[t];if(n>4)o[r++]=65533,i+=n-1;else {for(t&=2===n?31:3===n?15:7;n>1&&i<s;)t=t<<6|63&e[i++],n--;n>1?o[r++]=65533:t<65536?o[r++]=t:(t-=65536,o[r++]=55296|t>>10&1023,o[r++]=56320|1023&t);}}return ((e,t)=>{if(t<65534&&e.subarray&&Um)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let s="";for(let i=0;i<t;i++)s+=String.fromCharCode(e[i]);return s})(o,r)},Xm=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let s=t-1;for(;s>=0&&128==(192&e[s]);)s--;return s<0||0===s?t:s+zm[e[s]]>t?s:t},Ym={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Km=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0;},Jm=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1;};const Zm=Object.prototype.toString,{Z_NO_FLUSH:Qm,Z_FINISH:qm,Z_OK:$m,Z_STREAM_END:eg,Z_NEED_DICT:tg,Z_STREAM_ERROR:sg,Z_DATA_ERROR:ig,Z_MEM_ERROR:rg}=dm;function og(e){this.options=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const s=t.shift();if(s){if("object"!=typeof s)throw new TypeError(s+"must be non-object");for(const t in s)Vm(s,t)&&(e[t]=s[t]);}}return e}({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Km,this.strm.avail_out=0;let s=Nm(this.strm,t.windowBits);if(s!==$m)throw new Error(Ym[s]);if(this.header=new Jm,Gm(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=(e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return (new TextEncoder).encode(e);let t,s,i,r,o,n=e.length,a=0;for(r=0;r<n;r++)s=e.charCodeAt(r),55296==(64512&s)&&r+1<n&&(i=e.charCodeAt(r+1),56320==(64512&i)&&(s=65536+(s-55296<<10)+(i-56320),r++)),a+=s<128?1:s<2048?2:s<65536?3:4;for(t=new Uint8Array(a),o=0,r=0;o<a;r++)s=e.charCodeAt(r),55296==(64512&s)&&r+1<n&&(i=e.charCodeAt(r+1),56320==(64512&i)&&(s=65536+(s-55296<<10)+(i-56320),r++)),s<128?t[o++]=s:s<2048?(t[o++]=192|s>>>6,t[o++]=128|63&s):s<65536?(t[o++]=224|s>>>12,t[o++]=128|s>>>6&63,t[o++]=128|63&s):(t[o++]=240|s>>>18,t[o++]=128|s>>>12&63,t[o++]=128|s>>>6&63,t[o++]=128|63&s);return t})(t.dictionary):"[object ArrayBuffer]"===Zm.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(s=Hm(this.strm,t.dictionary),s!==$m)))throw new Error(Ym[s])}function ng(e,t){const s=new og(t);if(s.push(e),s.err)throw s.msg||Ym[s.err];return s.result}og.prototype.push=function(e,t){const s=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let o,n,a;if(this.ended)return !1;for(n=t===~~t?t:!0===t?qm:Qm,"[object ArrayBuffer]"===Zm.call(e)?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;;){for(0===s.avail_out&&(s.output=new Uint8Array(i),s.next_out=0,s.avail_out=i),o=km(s,n),o===tg&&r&&(o=Hm(s,r),o===$m?o=km(s,n):o===ig&&(o=tg));s.avail_in>0&&o===eg&&s.state.wrap>0&&0!==e[s.next_in];)Lm(s),o=km(s,n);switch(o){case sg:case ig:case tg:case rg:return this.onEnd(o),this.ended=!0,!1}if(a=s.avail_out,s.next_out&&(0===s.avail_out||o===eg))if("string"===this.options.to){let e=Xm(s.output,s.next_out),t=s.next_out-e,r=Wm(s.output,e);s.next_out=t,s.avail_out=i-t,t&&s.output.set(s.output.subarray(e,e+t),0),this.onData(r);}else this.onData(s.output.length===s.next_out?s.output:s.output.subarray(0,s.next_out));if(o!==$m||0!==a){if(o===eg)return o=jm(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===s.avail_in)break}}return !0},og.prototype.onData=function(e){this.chunks.push(e);},og.prototype.onEnd=function(e){e===$m&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=(e=>{let t=0;for(let s=0,i=e.length;s<i;s++)t+=e[s].length;const s=new Uint8Array(t);for(let t=0,i=0,r=e.length;t<r;t++){let r=e[t];s.set(r,i),i+=r.length;}return s})(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg;};var ag=og,hg=ng,lg=function(e,t){return (t=t||{}).raw=!0,ng(e,t)},ug=ng,cg=dm,pg={Inflate:ag,inflate:hg,inflateRaw:lg,ungzip:ug,constants:cg},dg=Object.freeze({__proto__:null,Inflate:ag,constants:cg,default:pg,inflate:hg,inflateRaw:lg,ungzip:ug});let fg=window.pako||dg;fg.inflate||(fg=fg.default);const mg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const gg={version:1,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11]}}(s),o=function(e){return {positions:new Uint16Array(fg.inflate(e.positions).buffer),normals:new Int8Array(fg.inflate(e.normals).buffer),indices:new Uint32Array(fg.inflate(e.indices).buffer),edgeIndices:new Uint32Array(fg.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(fg.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(fg.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(fg.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(fg.inflate(e.meshColors).buffer),entityIDs:fg.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(fg.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(fg.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(fg.inflate(e.positionsDecodeMatrix).buffer)}}(r);!function(e,t,s,i){i.positionsCompression="precompressed",i.normalsCompression="precompressed";const r=s.positions,o=s.normals,n=s.indices,a=s.edgeIndices,h=s.meshPositions,l=s.meshIndices,u=s.meshEdgesIndices,c=s.meshColors,p=JSON.parse(s.entityIDs),d=s.entityMeshes,m=s.entityIsObjects,g=h.length,_=d.length;for(let y=0;y<_;y++){const v=p[y],w=t.globalizeObjectIds?f.globalizeObjectId(i.id,v):v,P=e.metaScene.metaObjects[w],T={},x={};if(P){if(t.excludeTypesMap&&P.type&&t.excludeTypesMap[P.type])continue;if(t.includeTypesMap&&P.type&&!t.includeTypesMap[P.type])continue;const e=t.objectDefaults?t.objectDefaults[P.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(T.visible=!1),!1===e.pickable&&(T.pickable=!1),e.colorize&&(x.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(x.opacity=e.opacity));}else if(t.excludeUnclassifiedObjects)continue;const M=y===_-1,D=[];for(let e=d[y],t=M?d.length:d[y+1];e<t;e++){const t=e===g-1,p=w+".mesh."+e,d=mg(c.subarray(4*e,4*e+3)),f=c[4*e+3]/255;i.createMesh(b.apply(x,{id:p,primitive:"triangles",positionsCompressed:r.subarray(h[e],t?r.length:h[e+1]),normalsCompressed:o.subarray(h[e],t?r.length:h[e+1]),indices:n.subarray(l[e],t?n.length:l[e+1]),edgeIndices:a.subarray(u[e],t?a.length:u[e+1]),positionsDecodeMatrix:s.positionsDecodeMatrix,color:d,opacity:f})),D.push(p);}i.createEntity(b.apply(T,{id:w,isObject:1===m[y],meshIds:D}));}}(e,t,o,i);}};let _g=window.pako||dg;_g.inflate||(_g=_g.default);const yg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const vg={version:2,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11],entityMeshIds:e[12],entityMatrices:e[13],entityUsesInstancing:e[14]}}(s),o=function(e){return {positions:new Uint16Array(_g.inflate(e.positions).buffer),normals:new Int8Array(_g.inflate(e.normals).buffer),indices:new Uint32Array(_g.inflate(e.indices).buffer),edgeIndices:new Uint32Array(_g.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(_g.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(_g.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(_g.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(_g.inflate(e.meshColors).buffer),entityIDs:_g.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(_g.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(_g.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(_g.inflate(e.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(_g.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(_g.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(_g.inflate(e.entityUsesInstancing).buffer)}}(r);!function(e,t,s,i){i.positionsCompression="precompressed",i.normalsCompression="precompressed";const r=s.positions,o=s.normals,n=s.indices,a=s.edgeIndices,h=s.meshPositions,l=s.meshIndices,u=s.meshEdgesIndices,c=s.meshColors,p=JSON.parse(s.entityIDs),d=s.entityMeshes,m=s.entityIsObjects,g=s.entityMeshIds,_=s.entityMatrices,y=s.entityUsesInstancing,v=h.length,w=d.length,P={};for(let T=0;T<w;T++){const x=p[T],M=t.globalizeObjectIds?f.globalizeObjectId(i.id,x):x,D=e.metaScene.metaObjects[M],A={},C={},I=_.subarray(16*T,16*T+16);if(D){if(t.excludeTypesMap&&D.type&&t.excludeTypesMap[D.type])continue;if(t.includeTypesMap&&D.type&&!t.includeTypesMap[D.type])continue;const e=t.objectDefaults?t.objectDefaults[D.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(A.visible=!1),!1===e.pickable&&(A.pickable=!1),e.colorize&&(C.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(C.opacity=e.opacity));}else if(t.excludeUnclassifiedObjects)continue;const F=T===w-1,B=[];for(let e=d[T],t=F?g.length:d[T+1];e<t;e++){const t=g[e],p=t===v-1,d=M+".mesh."+t,f=yg(c.subarray(4*t,4*t+3)),m=c[4*t+3]/255,_=r.subarray(h[t],p?r.length:h[t+1]),w=o.subarray(h[t],p?r.length:h[t+1]),x=n.subarray(l[t],p?n.length:l[t+1]),D=a.subarray(u[t],p?a.length:u[t+1]);if(1===y[T]){const e="geometry."+t;e in P||(i.createGeometry({id:e,positionsCompressed:_,normalsCompressed:w,indices:x,edgeIndices:D,primitive:"triangles",positionsDecodeMatrix:s.positionsDecodeMatrix}),P[e]=!0),i.createMesh(b.apply(C,{id:d,color:f,opacity:m,matrix:I,geometryId:e})),B.push(d);}else i.createMesh(b.apply(C,{id:d,primitive:"triangles",positionsCompressed:_,normalsCompressed:w,indices:x,edgeIndices:D,positionsDecodeMatrix:s.positionsDecodeMatrix,color:f,opacity:m})),B.push(d);}B.length&&i.createEntity(b.apply(A,{id:M,isObject:1===m[T],meshIds:B}));}}(e,t,o,i);}};let bg=window.pako||dg;bg.inflate||(bg=bg.default);const wg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Pg={version:3,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],instancedPositionsDecodeMatrix:e[11],batchedPositionsDecodeMatrix:e[12],entityMeshIds:e[13],entityMatrices:e[14],entityUsesInstancing:e[15]}}(s),o=function(e){return {positions:new Uint16Array(bg.inflate(e.positions).buffer),normals:new Int8Array(bg.inflate(e.normals).buffer),indices:new Uint32Array(bg.inflate(e.indices).buffer),edgeIndices:new Uint32Array(bg.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(bg.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(bg.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(bg.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(bg.inflate(e.meshColors).buffer),entityIDs:bg.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(bg.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(bg.inflate(e.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(bg.inflate(e.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(bg.inflate(e.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(bg.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(bg.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(bg.inflate(e.entityUsesInstancing).buffer)}}(r);!function(e,t,s,i){i.positionsCompression="precompressed",i.normalsCompression="precompressed";const r=s.positions,o=s.normals,n=s.indices,a=s.edgeIndices,h=s.meshPositions,l=s.meshIndices,u=s.meshEdgesIndices,c=s.meshColors,p=JSON.parse(s.entityIDs),d=s.entityMeshes,m=s.entityIsObjects,g=s.entityMeshIds,_=s.entityMatrices,y=s.entityUsesInstancing,v=h.length,w=d.length,P={};for(let I=0;I<w;I++){const F=p[I],B=t.globalizeObjectIds?f.globalizeObjectId(i.id,F):F,E=e.metaScene.metaObjects[B],S={},R={},O=_.subarray(16*I,16*I+16);if(E){if(t.excludeTypesMap&&E.type&&t.excludeTypesMap[E.type])continue;if(t.includeTypesMap&&E.type&&!t.includeTypesMap[E.type])continue;const e=t.objectDefaults?t.objectDefaults[E.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(S.visible=!1),!1===e.pickable&&(S.pickable=!1),e.colorize&&(R.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(R.opacity=e.opacity));}else if(t.excludeUnclassifiedObjects)continue;const L=I===w-1,N=[];for(let e=d[I],t=L?g.length:d[I+1];e<t;e++){var T=g[e];const t=T===v-1,p=B+".mesh."+T,d=wg(c.subarray(4*T,4*T+3)),f=c[4*T+3]/255;var x=r.subarray(h[T],t?r.length:h[T+1]),M=o.subarray(h[T],t?r.length:h[T+1]),D=n.subarray(l[T],t?n.length:l[T+1]),A=a.subarray(u[T],t?a.length:u[T+1]);if(1===y[I]){var C="geometry."+T;C in P||(i.createGeometry({id:C,positionsCompressed:x,normalsCompressed:M,indices:D,edgeIndices:A,primitive:"triangles",positionsDecodeMatrix:s.instancedPositionsDecodeMatrix}),P[C]=!0),i.createMesh(b.apply(R,{id:p,color:d,opacity:f,matrix:O,geometryId:C})),N.push(p);}else i.createMesh(b.apply(R,{id:p,primitive:"triangles",positionsCompressed:x,normalsCompressed:M,indices:D,edgeIndices:A,positionsDecodeMatrix:s.batchedPositionsDecodeMatrix,color:d,opacity:f})),N.push(p);}N.length&&i.createEntity(b.apply(S,{id:B,isObject:1===m[I],meshIds:N}));}}(e,t,o,i);}};let Tg=window.pako||dg;Tg.inflate||(Tg=Tg.default);const xg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Mg={version:4,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],decodeMatrices:e[4],matrices:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveDecodeMatricesPortion:e[9],eachPrimitiveColor:e[10],primitiveInstances:e[11],eachEntityId:e[12],eachEntityPrimitiveInstancesPortion:e[13],eachEntityMatricesPortion:e[14],eachEntityMatrix:e[15]}}(s),o=function(e){return {positions:new Uint16Array(Tg.inflate(e.positions).buffer),normals:new Int8Array(Tg.inflate(e.normals).buffer),indices:new Uint32Array(Tg.inflate(e.indices).buffer),edgeIndices:new Uint32Array(Tg.inflate(e.edgeIndices).buffer),decodeMatrices:new Float32Array(Tg.inflate(e.decodeMatrices).buffer),matrices:new Float32Array(Tg.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Tg.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Tg.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Tg.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(Tg.inflate(e.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(Tg.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Tg.inflate(e.primitiveInstances).buffer),eachEntityId:Tg.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Tg.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Tg.inflate(e.eachEntityMatricesPortion).buffer)}}(r);!function(e,t,s,i){i.positionsCompression="precompressed",i.normalsCompression="precompressed";const r=s.positions,o=s.normals,n=s.indices,a=s.edgeIndices,h=s.decodeMatrices,l=s.matrices,u=s.eachPrimitivePositionsAndNormalsPortion,c=s.eachPrimitiveIndicesPortion,p=s.eachPrimitiveEdgeIndicesPortion,d=s.eachPrimitiveDecodeMatricesPortion,f=s.eachPrimitiveColor,m=s.primitiveInstances,g=JSON.parse(s.eachEntityId),_=s.eachEntityPrimitiveInstancesPortion,y=s.eachEntityMatricesPortion,v=u.length,w=m.length,P=new Uint8Array(v),T=new Uint32Array(v),x=g.length;for(let e=0;e<v;e++)T[e]=e;T.sort(((e,t)=>d[e]<d[t]?-1:d[e]>d[t]?1:0));for(let e=0;e<w;e++)P[m[e]]++;const M={};for(let e=0;e<x;e++){const t=x-1,s=e===t,i=_[e],r=s?_[t]:_[e+1];for(let t=i;t<r;t++){const s=m[t];P[s]>1||(M[s]=e);}}for(let e=0;e<v;e++){const t=T[e],s=t===v-1,l=P[t]>1,m=xg(f.subarray(4*t,4*t+3)),_=f[4*t+3]/255,y=r.subarray(u[t],s?r.length:u[t+1]),w=o.subarray(u[t],s?o.length:u[t+1]),x=n.subarray(c[t],s?n.length:c[t+1]),A=a.subarray(p[t],s?a.length:p[t+1]),C=h.subarray(d[t],d[t]+16);if(l){var D="geometry"+t;i.createGeometry({id:D,primitive:"triangles",positionsCompressed:y,normalsCompressed:w,indices:x,edgeIndices:A,positionsDecodeMatrix:C});}else {const e=t;g[M[t]];const s={};i.createMesh(b.apply(s,{id:e,primitive:"triangles",positionsCompressed:y,normalsCompressed:w,indices:x,edgeIndices:A,positionsDecodeMatrix:C,color:m,opacity:_}));}}let A=0;for(let e=0;e<x;e++){const t=x-1,s=e===t,r=g[e],o=_[e],n=s?_[t]:_[e+1],a=[];for(let t=o;t<n;t++){const s=m[t];if(P[s]>1){const t={},r="instance."+A++,o="geometry"+s,n=16*y[e],h=l.subarray(n,n+16);i.createMesh(b.apply(t,{id:r,geometryId:o,matrix:h})),a.push(r);}else a.push(s);}if(a.length>0){const e={};i.createEntity(b.apply(e,{id:r,isObject:!0,meshIds:a}));}}}(0,0,o,i);}};let Dg=window.pako||dg;Dg.inflate||(Dg=Dg.default);const Ag=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Cg={version:5,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],eachPrimitivePositionsAndNormalsPortion:e[5],eachPrimitiveIndicesPortion:e[6],eachPrimitiveEdgeIndicesPortion:e[7],eachPrimitiveColor:e[8],primitiveInstances:e[9],eachEntityId:e[10],eachEntityPrimitiveInstancesPortion:e[11],eachEntityMatricesPortion:e[12]}}(s),o=function(e){return {positions:new Float32Array(Dg.inflate(e.positions).buffer),normals:new Int8Array(Dg.inflate(e.normals).buffer),indices:new Uint32Array(Dg.inflate(e.indices).buffer),edgeIndices:new Uint32Array(Dg.inflate(e.edgeIndices).buffer),matrices:new Float32Array(Dg.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Dg.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Dg.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Dg.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(Dg.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Dg.inflate(e.primitiveInstances).buffer),eachEntityId:Dg.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Dg.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Dg.inflate(e.eachEntityMatricesPortion).buffer)}}(r);!function(e,t,s,i){i.positionsCompression="disabled",i.normalsCompression="precompressed";const r=s.positions,o=s.normals,n=s.indices,a=s.edgeIndices,h=s.matrices,l=s.eachPrimitivePositionsAndNormalsPortion,u=s.eachPrimitiveIndicesPortion,c=s.eachPrimitiveEdgeIndicesPortion,p=s.eachPrimitiveColor,d=s.primitiveInstances,f=JSON.parse(s.eachEntityId),m=s.eachEntityPrimitiveInstancesPortion,g=s.eachEntityMatricesPortion,_=l.length,y=d.length,v=new Uint8Array(_),w=f.length;for(let e=0;e<y;e++)v[d[e]]++;const P={};for(let e=0;e<w;e++){const t=w-1,s=e===t,i=m[e],r=s?m[t]:m[e+1];for(let t=i;t<r;t++){const s=d[t];v[s]>1||(P[s]=e);}}for(let e=0;e<_;e++){const t=e===_-1,s=v[e]>1,h=Ag(p.subarray(4*e,4*e+3)),d=p[4*e+3]/255,m=r.subarray(l[e],t?r.length:l[e+1]),g=o.subarray(l[e],t?o.length:l[e+1]),y=n.subarray(u[e],t?n.length:u[e+1]),w=a.subarray(c[e],t?a.length:c[e+1]);if(s){var T="geometry"+e;i.createGeometry({id:T,primitive:"triangles",positionsCompressed:m,normalsCompressed:g,indices:y,edgeIndices:w});}else {const t=e;f[P[e]];const s={};i.createMesh(b.apply(s,{id:t,primitive:"triangles",positionsCompressed:m,normalsCompressed:g,indices:y,edgeIndices:w,color:h,opacity:d}));}}let x=0;for(let e=0;e<w;e++){const t=w-1,s=e===t,r=f[e],o=m[e],n=s?m[t]:m[e+1],a=[];for(let t=o;t<n;t++){const s=d[t];if(v[s]>1){const t={},r="instance."+x++,o="geometry"+s,n=16*g[e],l=h.subarray(n,n+16);i.createMesh(b.apply(t,{id:r,geometryId:o,matrix:l})),a.push(r);}else a.push(s);}if(a.length>0){const e={};i.createEntity(b.apply(e,{id:r,isObject:!0,meshIds:a}));}}}(0,0,o,i);}};let Ig=window.pako||dg;Ig.inflate||(Ig=Ig.default);const Fg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Bg={version:6,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],reusedPrimitivesDecodeMatrix:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveColorAndOpacity:e[9],primitiveInstances:e[10],eachEntityId:e[11],eachEntityPrimitiveInstancesPortion:e[12],eachEntityMatricesPortion:e[13],eachTileAABB:e[14],eachTileEntitiesPortion:e[15]}}(s),o=function(e){function t(e,t){return 0===e.length?[]:Ig.inflate(e,t).buffer}return {positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(t(e.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(t(e.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(t(e.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(t(e.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(t(e.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(t(e.primitiveInstances)),eachEntityId:Ig.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(t(e.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(t(e.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,s,i){const r=s.positions,o=s.normals,n=s.indices,a=s.edgeIndices,h=s.matrices,l=s.reusedPrimitivesDecodeMatrix,u=s.eachPrimitivePositionsAndNormalsPortion,c=s.eachPrimitiveIndicesPortion,p=s.eachPrimitiveEdgeIndicesPortion,d=s.eachPrimitiveColorAndOpacity,m=s.primitiveInstances,g=JSON.parse(s.eachEntityId),_=s.eachEntityPrimitiveInstancesPortion,y=s.eachEntityMatricesPortion,v=s.eachTileAABB,w=s.eachTileEntitiesPortion,P=u.length,T=m.length,x=g.length,M=w.length;let D=0;const A=new Uint32Array(P);for(let e=0;e<T;e++){const t=m[e];void 0!==A[t]?A[t]++:A[t]=1;}const C=f.vec3(),I=f.AABB3();for(let s=0;s<M;s++){const T=s===M-1,F=w[s],B=T?x:w[s+1],E=6*s,S=v.subarray(E,E+6);f.getAABB3Center(S,C),I[0]=S[0]-C[0],I[1]=S[1]-C[1],I[2]=S[2]-C[2],I[3]=S[3]-C[0],I[4]=S[4]-C[1],I[5]=S[5]-C[2];const R=Pt.createPositionsDecodeMatrix(I),O={};for(let v=F;v<B;v++){const w=g[v],T=t.globalizeObjectIds?f.globalizeObjectId(i.id,w):w,M=y[v],I=h.slice(M,M+16),F=v===x-1,B=_[v],E=F?m.length:_[v+1],S=[],L=e.metaScene.metaObjects[T],N={},k={};if(L){if(t.excludeTypesMap&&L.type&&t.excludeTypesMap[L.type])continue;if(t.includeTypesMap&&L.type&&!t.includeTypesMap[L.type])continue;const e=t.objectDefaults?t.objectDefaults[L.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(N.visible=!1),!1===e.pickable&&(N.pickable=!1),e.colorize&&(k.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(k.opacity=e.opacity));}else if(t.excludeUnclassifiedObjects)continue;for(let e=B;e<E;e++){const t=m[e],h=A[t]>1,f=t===P-1,g=r.subarray(u[t],f?r.length:u[t+1]),_=o.subarray(u[t],f?o.length:u[t+1]),y=n.subarray(c[t],f?n.length:c[t+1]),v=a.subarray(p[t],f?a.length:p[t+1]),w=Fg(d.subarray(4*t,4*t+3)),T=d[4*t+3]/255,x=D++;if(h){const e="geometry."+s+"."+t;O[e]||(i.createGeometry({id:e,primitive:"triangles",positionsCompressed:g,normalsCompressed:_,indices:y,edgeIndices:v,positionsDecodeMatrix:l}),O[e]=!0),i.createMesh(b.apply(k,{id:x,geometryId:e,origin:C,matrix:I,color:w,opacity:T})),S.push(x);}else i.createMesh(b.apply(k,{id:x,origin:C,primitive:"triangles",positionsCompressed:g,normalsCompressed:_,indices:y,edgeIndices:v,positionsDecodeMatrix:R,color:w,opacity:T})),S.push(x);}S.length>0&&i.createEntity(b.apply(N,{id:T,isObject:!0,meshIds:S}));}}}(e,t,o,i);}};let Eg=window.pako||dg;Eg.inflate||(Eg=Eg.default);const Sg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function Rg(e){const t=[];for(let s=0,i=e.length;s<i;s+=3)t.push(e[s]),t.push(e[s+1]),t.push(e[s+2]),t.push(1);return t}const Og={version:7,parse:function(e,t,s,i){const r=function(e){return {positions:e[0],normals:e[1],colors:e[2],indices:e[3],edgeIndices:e[4],matrices:e[5],reusedGeometriesDecodeMatrix:e[6],eachGeometryPrimitiveType:e[7],eachGeometryPositionsPortion:e[8],eachGeometryNormalsPortion:e[9],eachGeometryColorsPortion:e[10],eachGeometryIndicesPortion:e[11],eachGeometryEdgeIndicesPortion:e[12],eachMeshGeometriesPortion:e[13],eachMeshMatricesPortion:e[14],eachMeshMaterial:e[15],eachEntityId:e[16],eachEntityMeshesPortion:e[17],eachTileAABB:e[18],eachTileEntitiesPortion:e[19]}}(s),o=function(e){function t(e,t){return 0===e.length?[]:Eg.inflate(e,t).buffer}return {positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:Eg.inflate(e.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,s,i){const r=s.positions,o=s.normals,n=s.colors,a=s.indices,h=s.edgeIndices,l=s.matrices,u=s.reusedGeometriesDecodeMatrix,c=s.eachGeometryPrimitiveType,p=s.eachGeometryPositionsPortion,d=s.eachGeometryNormalsPortion,m=s.eachGeometryColorsPortion,g=s.eachGeometryIndicesPortion,_=s.eachGeometryEdgeIndicesPortion,y=s.eachMeshGeometriesPortion,v=s.eachMeshMatricesPortion,w=s.eachMeshMaterial,P=JSON.parse(s.eachEntityId),T=s.eachEntityMeshesPortion,x=s.eachTileAABB,M=s.eachTileEntitiesPortion,D=p.length,A=y.length,C=P.length,I=M.length;let F=0;const B=new Uint32Array(D);for(let e=0;e<A;e++){const t=y[e];void 0!==B[t]?B[t]++:B[t]=1;}const E=f.vec3(),S=f.AABB3();for(let s=0;s<I;s++){const A=s===I-1,R=M[s],O=A?C:M[s+1],L=6*s,N=x.subarray(L,L+6);f.getAABB3Center(N,E),S[0]=N[0]-E[0],S[1]=N[1]-E[1],S[2]=N[2]-E[2],S[3]=N[3]-E[0],S[4]=N[4]-E[1],S[5]=N[5]-E[2];const k=Pt.createPositionsDecodeMatrix(S),j={};for(let x=R;x<O;x++){const M=P[x],A=t.globalizeObjectIds?f.globalizeObjectId(i.id,M):M,I=x===C-1,S=T[x],R=I?y.length:T[x+1],O=[],L=e.metaScene.metaObjects[A],N={},G={};if(L){if(t.excludeTypesMap&&L.type&&t.excludeTypesMap[L.type])continue;if(t.includeTypesMap&&L.type&&!t.includeTypesMap[L.type])continue;const e=t.objectDefaults?t.objectDefaults[L.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(N.visible=!1),!1===e.pickable&&(N.pickable=!1),e.colorize&&(G.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(G.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(G.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(G.roughness=e.roughness));}else if(t.excludeUnclassifiedObjects)continue;for(let e=S;e<R;e++){const t=y[e],f=B[t]>1,P=t===D-1,T=Sg(w.subarray(6*e,6*e+3)),x=w[6*e+3]/255,M=w[6*e+4]/255,A=w[6*e+5]/255,C=F++;if(f){const f=v[e],y=l.slice(f,f+16),w="geometry."+s+"."+t;if(!j[w]){let e,s,l,f,y,v;switch(c[t]){case 0:e="solid",s=r.subarray(p[t],P?r.length:p[t+1]),l=o.subarray(d[t],P?o.length:d[t+1]),y=a.subarray(g[t],P?a.length:g[t+1]),v=h.subarray(_[t],P?h.length:_[t+1]);break;case 1:e="surface",s=r.subarray(p[t],P?r.length:p[t+1]),l=o.subarray(d[t],P?o.length:d[t+1]),y=a.subarray(g[t],P?a.length:g[t+1]),v=h.subarray(_[t],P?h.length:_[t+1]);break;case 2:e="points",s=r.subarray(p[t],P?r.length:p[t+1]),f=Rg(n.subarray(m[t],P?n.length:m[t+1]));break;case 3:e="lines",s=r.subarray(p[t],P?r.length:p[t+1]),y=a.subarray(g[t],P?a.length:g[t+1]);break;default:continue}i.createGeometry({id:w,primitive:e,positionsCompressed:s,normalsCompressed:l,colors:f,indices:y,edgeIndices:v,positionsDecodeMatrix:u}),j[w]=!0;}i.createMesh(b.apply(G,{id:C,geometryId:w,origin:E,matrix:y,color:T,metallic:M,roughness:A,opacity:x})),O.push(C);}else {let e,s,l,u,f,y;switch(c[t]){case 0:e="solid",s=r.subarray(p[t],P?r.length:p[t+1]),l=o.subarray(d[t],P?o.length:d[t+1]),f=a.subarray(g[t],P?a.length:g[t+1]),y=h.subarray(_[t],P?h.length:_[t+1]);break;case 1:e="surface",s=r.subarray(p[t],P?r.length:p[t+1]),l=o.subarray(d[t],P?o.length:d[t+1]),f=a.subarray(g[t],P?a.length:g[t+1]),y=h.subarray(_[t],P?h.length:_[t+1]);break;case 2:e="points",s=r.subarray(p[t],P?r.length:p[t+1]),u=Rg(n.subarray(m[t],P?n.length:m[t+1]));break;case 3:e="lines",s=r.subarray(p[t],P?r.length:p[t+1]),f=a.subarray(g[t],P?a.length:g[t+1]);break;default:continue}i.createMesh(b.apply(G,{id:C,origin:E,primitive:e,positionsCompressed:s,normalsCompressed:l,colors:u,indices:f,edgeIndices:y,positionsDecodeMatrix:k,color:T,metallic:M,roughness:A,opacity:x})),O.push(C);}}O.length>0&&i.createEntity(b.apply(N,{id:A,isObject:!0,meshIds:O}));}}}(e,t,o,i);}};let Lg=window.pako||dg;Lg.inflate||(Lg=Lg.default);const Ng=f.vec4(),kg=f.vec4();const jg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function Gg(e){const t=[];for(let s=0,i=e.length;s<i;s+=3)t.push(e[s]),t.push(e[s+1]),t.push(e[s+2]),t.push(1);return t}const Hg={version:8,parse:function(e,t,s,i){const r=function(e){return {types:e[0],eachMetaObjectId:e[1],eachMetaObjectType:e[2],eachMetaObjectName:e[3],eachMetaObjectParent:e[4],positions:e[5],normals:e[6],colors:e[7],indices:e[8],edgeIndices:e[9],matrices:e[10],reusedGeometriesDecodeMatrix:e[11],eachGeometryPrimitiveType:e[12],eachGeometryPositionsPortion:e[13],eachGeometryNormalsPortion:e[14],eachGeometryColorsPortion:e[15],eachGeometryIndicesPortion:e[16],eachGeometryEdgeIndicesPortion:e[17],eachMeshGeometriesPortion:e[18],eachMeshMatricesPortion:e[19],eachMeshMaterial:e[20],eachEntityMetaObject:e[21],eachEntityMeshesPortion:e[22],eachTileAABB:e[23],eachTileEntitiesPortion:e[24]}}(s),o=function(e){function t(e,t){return 0===e.length?[]:Lg.inflate(e,t).buffer}return {types:Lg.inflate(e.types,{to:"string"}),eachMetaObjectId:Lg.inflate(e.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(t(e.eachMetaObjectType)),eachMetaObjectName:Lg.inflate(e.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(t(e.eachMetaObjectParent)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(t(e.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,s,i){const r=JSON.parse(s.types),o=JSON.parse(s.eachMetaObjectId),n=s.eachMetaObjectType,a=JSON.parse(s.eachMetaObjectName),h=s.eachMetaObjectParent,l=s.positions,u=s.normals,c=s.colors,p=s.indices,d=s.edgeIndices,m=s.matrices,g=s.reusedGeometriesDecodeMatrix,_=s.eachGeometryPrimitiveType,y=s.eachGeometryPositionsPortion,v=s.eachGeometryNormalsPortion,w=s.eachGeometryColorsPortion,P=s.eachGeometryIndicesPortion,T=s.eachGeometryEdgeIndicesPortion,x=s.eachMeshGeometriesPortion,M=s.eachMeshMatricesPortion,D=s.eachMeshMaterial,A=s.eachEntityMetaObject,C=s.eachEntityMeshesPortion,I=s.eachTileAABB,F=s.eachTileEntitiesPortion,B=o.length,E=y.length,S=x.length,R=A.length,O=F.length;let L=0;const N=i.id;if(!e.metaScene.metaModels[N]){const s={metaObjects:[]};for(let e=0;e<B;e++){const t=o[e],i=r[n[e]]||"default",l=a[e],u=h[e],c=u!==e?o[u]:null;s.metaObjects.push({id:t,type:i,name:l,parent:c});}e.metaScene.createMetaModel(N,s,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),i.once("destroyed",(()=>{e.metaScene.destroyMetaModel(N);}));}const k=new Uint32Array(E);for(let e=0;e<S;e++){const t=x[e];void 0!==k[t]?k[t]++:k[t]=1;}const j=f.vec3(),G=f.AABB3(),H={};for(let s=0;s<O;s++){const r=s===O-1,n=F[s],a=r?R:F[s+1],h=6*s,B=I.subarray(h,h+6);f.getAABB3Center(B,j),G[0]=B[0]-j[0],G[1]=B[1]-j[1],G[2]=B[2]-j[2],G[3]=B[3]-j[0],G[4]=B[4]-j[1],G[5]=B[5]-j[2];const S=Pt.createPositionsDecodeMatrix(G),N={};for(let r=n;r<a;r++){const n=o[A[r]],a=t.globalizeObjectIds?f.globalizeObjectId(i.id,n):n,h=r===R-1,I=C[r],F=h?x.length:C[r+1],B=[],O=e.metaScene.metaObjects[a],V={},U={};if(O){if(t.excludeTypesMap&&O.type&&t.excludeTypesMap[O.type])continue;if(t.includeTypesMap&&O.type&&!t.includeTypesMap[O.type])continue;const e=t.objectDefaults?t.objectDefaults[O.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(V.visible=!1),!1===e.pickable&&(V.pickable=!1),e.colorize&&(U.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(U.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(U.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(U.roughness=e.roughness));}else if(t.excludeUnclassifiedObjects)continue;for(let e=I;e<F;e++){const r=x[e],o=k[r]>1,n=r===E-1,a=jg(D.subarray(6*e,6*e+3)),h=D[6*e+3]/255,A=D[6*e+4]/255,C=D[6*e+5]/255,I=L++;if(o){const o=M[e],x=m.slice(o,o+16),D="geometry."+s+"."+r;let F=H[D];if(!F){F={batchThisMesh:!t.reuseGeometries};let e=!1;switch(_[r]){case 0:F.primitiveName="solid",F.geometryPositions=l.subarray(y[r],n?l.length:y[r+1]),F.geometryNormals=u.subarray(v[r],n?u.length:v[r+1]),F.geometryIndices=p.subarray(P[r],n?p.length:P[r+1]),F.geometryEdgeIndices=d.subarray(T[r],n?d.length:T[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 1:F.primitiveName="surface",F.geometryPositions=l.subarray(y[r],n?l.length:y[r+1]),F.geometryNormals=u.subarray(v[r],n?u.length:v[r+1]),F.geometryIndices=p.subarray(P[r],n?p.length:P[r+1]),F.geometryEdgeIndices=d.subarray(T[r],n?d.length:T[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 2:F.primitiveName="points",F.geometryPositions=l.subarray(y[r],n?l.length:y[r+1]),F.geometryColors=Gg(c.subarray(w[r],n?c.length:w[r+1])),e=F.geometryPositions.length>0;break;case 3:F.primitiveName="lines",F.geometryPositions=l.subarray(y[r],n?l.length:y[r+1]),F.geometryIndices=p.subarray(P[r],n?p.length:P[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;default:continue}if(e||(F=null),F&&(F.geometryPositions.length,F.batchThisMesh)){F.decompressedPositions=new Float32Array(F.geometryPositions.length);const e=F.geometryPositions,t=F.decompressedPositions;for(let s=0,i=e.length;s<i;s+=3)t[s+0]=e[s+0]*g[0]+g[12],t[s+1]=e[s+1]*g[5]+g[13],t[s+2]=e[s+2]*g[10]+g[14];F.geometryPositions=null,H[D]=F;}}if(F)if(F.batchThisMesh){const e=F.decompressedPositions,t=new Uint16Array(e.length);for(let s=0,i=e.length;s<i;s+=3)Ng[0]=e[s+0],Ng[1]=e[s+1],Ng[2]=e[s+2],Ng[3]=1,f.transformVec4(x,Ng,kg),Pt.compressPosition(kg,G,Ng),t[s+0]=Ng[0],t[s+1]=Ng[1],t[s+2]=Ng[2];i.createMesh(b.apply(U,{id:I,origin:j,primitive:F.primitiveName,positionsCompressed:t,normalsCompressed:F.geometryNormals,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:S,color:a,metallic:A,roughness:C,opacity:h})),B.push(I);}else N[D]||(i.createGeometry({id:D,primitive:F.primitiveName,positionsCompressed:F.geometryPositions,normalsCompressed:F.geometryNormals,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:g}),N[D]=!0),i.createMesh(b.apply(U,{id:I,geometryId:D,origin:j,matrix:x,color:a,metallic:A,roughness:C,opacity:h})),B.push(I);}else {let e,t,s,o,f,m,g=!1;switch(_[r]){case 0:e="solid",t=l.subarray(y[r],n?l.length:y[r+1]),s=u.subarray(v[r],n?u.length:v[r+1]),f=p.subarray(P[r],n?p.length:P[r+1]),m=d.subarray(T[r],n?d.length:T[r+1]),g=t.length>0&&f.length>0;break;case 1:e="surface",t=l.subarray(y[r],n?l.length:y[r+1]),s=u.subarray(v[r],n?u.length:v[r+1]),f=p.subarray(P[r],n?p.length:P[r+1]),m=d.subarray(T[r],n?d.length:T[r+1]),g=t.length>0&&f.length>0;break;case 2:e="points",t=l.subarray(y[r],n?l.length:y[r+1]),o=Gg(c.subarray(w[r],n?c.length:w[r+1])),g=t.length>0;break;case 3:e="lines",t=l.subarray(y[r],n?l.length:y[r+1]),f=p.subarray(P[r],n?p.length:P[r+1]),g=t.length>0&&f.length>0;break;default:continue}g&&(i.createMesh(b.apply(U,{id:I,origin:j,primitive:e,positionsCompressed:t,normalsCompressed:s,colorsCompressed:o,indices:f,edgeIndices:m,positionsDecodeMatrix:S,color:a,metallic:A,roughness:C,opacity:h})),B.push(I));}}B.length>0&&i.createEntity(b.apply(V,{id:a,isObject:!0,meshIds:B}));}}}(e,t,o,i);}},Vg=f.vec4(),Ug=f.vec4();const zg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Wg={version:9,parse:function(e,t,s,i){const r=function(e){return {metadata:e[0],positions:e[1],normals:e[2],colors:e[3],indices:e[4],edgeIndices:e[5],matrices:e[6],reusedGeometriesDecodeMatrix:e[7],eachGeometryPrimitiveType:e[8],eachGeometryPositionsPortion:e[9],eachGeometryNormalsPortion:e[10],eachGeometryColorsPortion:e[11],eachGeometryIndicesPortion:e[12],eachGeometryEdgeIndicesPortion:e[13],eachMeshGeometriesPortion:e[14],eachMeshMatricesPortion:e[15],eachMeshMaterial:e[16],eachEntityId:e[17],eachEntityMeshesPortion:e[18],eachTileAABB:e[19],eachTileEntitiesPortion:e[20]}}(s),o=function(e){function t(e,t){return 0===e.length?[]:hg(e,t).buffer}return {metadata:JSON.parse(hg(e.metadata,{to:"string"})),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:JSON.parse(hg(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,s,i){const r=s.metadata,o=s.positions,n=s.normals,a=s.colors,h=s.indices,l=s.edgeIndices,u=s.matrices,c=s.reusedGeometriesDecodeMatrix,p=s.eachGeometryPrimitiveType,d=s.eachGeometryPositionsPortion,m=s.eachGeometryNormalsPortion,g=s.eachGeometryColorsPortion,_=s.eachGeometryIndicesPortion,y=s.eachGeometryEdgeIndicesPortion,v=s.eachMeshGeometriesPortion,w=s.eachMeshMatricesPortion,P=s.eachMeshMaterial,T=s.eachEntityId,x=s.eachEntityMeshesPortion,M=s.eachTileAABB,D=s.eachTileEntitiesPortion,A=d.length,C=v.length,I=x.length,F=D.length;let B=0;const E=i.id;e.metaScene.metaModels[E]||(e.metaScene.createMetaModel(E,r,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),i.once("destroyed",(()=>{e.metaScene.destroyMetaModel(E);})));const S=new Uint32Array(A);for(let e=0;e<C;e++){const t=v[e];void 0!==S[t]?S[t]++:S[t]=1;}const R=f.vec3(),O=f.AABB3(),L={};for(let s=0;s<F;s++){const r=s===F-1,C=D[s],E=r?I-1:D[s+1]-1,N=6*s,k=M.subarray(N,N+6);f.getAABB3Center(k,R),O[0]=k[0]-R[0],O[1]=k[1]-R[1],O[2]=k[2]-R[2],O[3]=k[3]-R[0],O[4]=k[4]-R[1],O[5]=k[5]-R[2];const j=Pt.createPositionsDecodeMatrix(O),G={};for(let r=C;r<=E;r++){const M=T[r],D=t.globalizeObjectIds?f.globalizeObjectId(i.id,M):M,C=r===I-1,F=x[r],E=C?v.length-1:x[r+1]-1,N=[],k=e.metaScene.metaObjects[D],H={},V={};if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;const e=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(H.visible=!1),!1===e.pickable&&(H.pickable=!1),e.colorize&&(V.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(V.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(V.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(V.roughness=e.roughness));}else if(t.excludeUnclassifiedObjects)continue;for(let e=F;e<=E;e++){const r=v[e],T=S[r]>1,x=r===A-1,M=zg(P.subarray(6*e,6*e+3)),D=P[6*e+3]/255,C=P[6*e+4]/255,I=P[6*e+5]/255,F=B++;if(T){const v=w[e],P=u.slice(v,v+16),T="geometry."+s+"."+r;let A=L[T];if(!A){A={batchThisMesh:!t.reuseGeometries};let e=!1;switch(p[r]){case 0:A.primitiveName="solid",A.geometryPositions=o.subarray(d[r],x?o.length:d[r+1]),A.geometryNormals=n.subarray(m[r],x?n.length:m[r+1]),A.geometryIndices=h.subarray(_[r],x?h.length:_[r+1]),A.geometryEdgeIndices=l.subarray(y[r],x?l.length:y[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;case 1:A.primitiveName="surface",A.geometryPositions=o.subarray(d[r],x?o.length:d[r+1]),A.geometryNormals=n.subarray(m[r],x?n.length:m[r+1]),A.geometryIndices=h.subarray(_[r],x?h.length:_[r+1]),A.geometryEdgeIndices=l.subarray(y[r],x?l.length:y[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;case 2:A.primitiveName="points",A.geometryPositions=o.subarray(d[r],x?o.length:d[r+1]),A.geometryColors=a.subarray(g[r],x?a.length:g[r+1]),e=A.geometryPositions.length>0;break;case 3:A.primitiveName="lines",A.geometryPositions=o.subarray(d[r],x?o.length:d[r+1]),A.geometryIndices=h.subarray(_[r],x?h.length:_[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;default:continue}if(e||(A=null),A&&(A.geometryPositions.length,A.batchThisMesh)){A.decompressedPositions=new Float32Array(A.geometryPositions.length),A.transformedAndRecompressedPositions=new Uint16Array(A.geometryPositions.length);const e=A.geometryPositions,t=A.decompressedPositions;for(let s=0,i=e.length;s<i;s+=3)t[s+0]=e[s+0]*c[0]+c[12],t[s+1]=e[s+1]*c[5]+c[13],t[s+2]=e[s+2]*c[10]+c[14];A.geometryPositions=null,L[T]=A;}}if(A)if(A.batchThisMesh){const e=A.decompressedPositions,t=A.transformedAndRecompressedPositions;for(let s=0,i=e.length;s<i;s+=3)Vg[0]=e[s+0],Vg[1]=e[s+1],Vg[2]=e[s+2],Vg[3]=1,f.transformVec4(P,Vg,Ug),Pt.compressPosition(Ug,O,Vg),t[s+0]=Vg[0],t[s+1]=Vg[1],t[s+2]=Vg[2];i.createMesh(b.apply(V,{id:F,origin:R,primitive:A.primitiveName,positionsCompressed:t,normalsCompressed:A.geometryNormals,colorsCompressed:A.geometryColors,indices:A.geometryIndices,edgeIndices:A.geometryEdgeIndices,positionsDecodeMatrix:j,color:M,metallic:C,roughness:I,opacity:D})),N.push(F);}else G[T]||(i.createGeometry({id:T,primitive:A.primitiveName,positionsCompressed:A.geometryPositions,normalsCompressed:A.geometryNormals,colorsCompressed:A.geometryColors,indices:A.geometryIndices,edgeIndices:A.geometryEdgeIndices,positionsDecodeMatrix:c}),G[T]=!0),i.createMesh(b.apply(V,{id:F,geometryId:T,origin:R,matrix:P,color:M,metallic:C,roughness:I,opacity:D})),N.push(F);}else {let e,t,s,u,c,f,v=!1;switch(p[r]){case 0:e="solid",t=o.subarray(d[r],x?o.length:d[r+1]),s=n.subarray(m[r],x?n.length:m[r+1]),c=h.subarray(_[r],x?h.length:_[r+1]),f=l.subarray(y[r],x?l.length:y[r+1]),v=t.length>0&&c.length>0;break;case 1:e="surface",t=o.subarray(d[r],x?o.length:d[r+1]),s=n.subarray(m[r],x?n.length:m[r+1]),c=h.subarray(_[r],x?h.length:_[r+1]),f=l.subarray(y[r],x?l.length:y[r+1]),v=t.length>0&&c.length>0;break;case 2:e="points",t=o.subarray(d[r],x?o.length:d[r+1]),u=a.subarray(g[r],x?a.length:g[r+1]),v=t.length>0;break;case 3:e="lines",t=o.subarray(d[r],x?o.length:d[r+1]),c=h.subarray(_[r],x?h.length:_[r+1]),v=t.length>0&&c.length>0;break;default:continue}v&&(i.createMesh(b.apply(V,{id:F,origin:R,primitive:e,positionsCompressed:t,normalsCompressed:s,colorsCompressed:u,indices:c,edgeIndices:f,positionsDecodeMatrix:j,color:M,metallic:C,roughness:I,opacity:D})),N.push(F));}}N.length>0&&i.createEntity(b.apply(H,{id:D,isObject:!0,meshIds:N}));}}}(e,t,o,i);}};console.log({pakoInflate:hg});const Xg=f.vec4(),Yg=f.vec4();const Kg=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();!function(){const e=document.createElement("canvas"),t=e.getContext("2d");}();const Jg={version:10,parse:function(e,t,s,i){const r=function(e){return {metadata:e[0],textureData:e[1],eachTextureDataPortion:e[2],eachTextureDimensions:e[3],positions:e[4],normals:e[5],colors:e[6],uvs:e[7],indices:e[8],edgeIndices:e[9],eachTextureSetTextures:e[10],matrices:e[11],reusedGeometriesDecodeMatrix:e[12],eachGeometryPrimitiveType:e[13],eachGeometryPositionsPortion:e[14],eachGeometryNormalsPortion:e[15],eachGeometryColorsPortion:e[16],eachGeometryUVsPortion:e[17],eachGeometryIndicesPortion:e[18],eachGeometryEdgeIndicesPortion:e[19],eachMeshGeometriesPortion:e[20],eachMeshMatricesPortion:e[21],eachMeshTextureSet:e[22],eachMeshMaterialAttributes:e[23],eachEntityId:e[24],eachEntityMeshesPortion:e[25],eachTileAABB:e[26],eachTileEntitiesPortion:e[27]}}(s),o=function(e){function t(e,t){return 0===e.length?[]:hg(e,t).buffer}return {metadata:JSON.parse(hg(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureDimensions:new Uint16Array(t(e.eachTextureDimensions)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(t(e.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(hg(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,s,i){const r=s.metadata,o=s.textureData,n=s.eachTextureDataPortion;s.eachTextureDimensions;const a=s.positions,h=s.normals,l=s.colors,u=s.uvs,c=s.indices,p=s.edgeIndices,d=s.eachTextureSetTextures,m=s.matrices,g=s.reusedGeometriesDecodeMatrix,_=s.eachGeometryPrimitiveType,y=s.eachGeometryPositionsPortion,v=s.eachGeometryNormalsPortion,w=s.eachGeometryColorsPortion,P=s.eachGeometryUVsPortion,T=s.eachGeometryIndicesPortion,x=s.eachGeometryEdgeIndicesPortion,M=s.eachMeshGeometriesPortion,D=s.eachMeshMatricesPortion,A=s.eachMeshTextureSet,C=s.eachMeshMaterialAttributes,I=s.eachEntityId,F=s.eachEntityMeshesPortion,B=s.eachTileAABB,E=s.eachTileEntitiesPortion,S=n.length,R=d.length/5,O=y.length,L=M.length,N=F.length,k=E.length;let j=0;const G=i.id;e.metaScene.metaModels[G]||(e.metaScene.createMetaModel(G,r,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),i.once("destroyed",(()=>{e.metaScene.destroyMetaModel(G);})));for(let e=0;e<S;e++){const t=e===S-1,s=n[e],r=t?o.length:n[e+1];if(r-s>0){const t=new Uint8Array(o.subarray(s,r)).buffer;i.createTexture({id:`texture-${e}`,buffers:[t]});}}for(let e=0;e<R;e++){const t=5*e,s=`textureSet-${e}`,r=d[t+0],o=d[t+1],n=d[t+2],a=d[t+3],h=d[t+4];i.createTextureSet({id:s,colorTextureId:r>=0?`texture-${r}`:null,normalsTextureId:n>=0?`texture-${n}`:null,metallicRoughnessTextureId:o>=0?`texture-${o}`:null,emissiveTextureId:a>=0?`texture-${a}`:null,occlusionTextureId:h>=0?`texture-${h}`:null});}const H=new Uint32Array(O);for(let e=0;e<L;e++){const t=M[e];void 0!==H[t]?H[t]++:H[t]=1;}const V=f.vec3(),U=f.AABB3(),z={};for(let s=0;s<k;s++){const r=s===k-1,o=E[s],n=r?N-1:E[s+1]-1,d=6*s,S=B.subarray(d,d+6);f.getAABB3Center(S,V),U[0]=S[0]-V[0],U[1]=S[1]-V[1],U[2]=S[2]-V[2],U[3]=S[3]-V[0],U[4]=S[4]-V[1],U[5]=S[5]-V[2];const R=Pt.createPositionsDecodeMatrix(U),L={};for(let r=o;r<=n;r++){const o=I[r],n=t.globalizeObjectIds?f.globalizeObjectId(i.id,o):o,d=r===N-1,B=F[r],E=d?M.length-1:F[r+1]-1,S=[],k=e.metaScene.metaObjects[n],G={},W={};if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;const e=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(G.visible=!1),!1===e.pickable&&(G.pickable=!1),e.colorize&&(W.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(W.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(W.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(W.roughness=e.roughness));}else if(t.excludeUnclassifiedObjects)continue;for(let e=B;e<=E;e++){const r=M[e],o=H[r]>1,n=r===O-1,d=A[e],I=d>=0?`textureSet-${d}`:null,F=Kg(C.subarray(6*e,6*e+3)),B=C[6*e+3]/255,E=C[6*e+4]/255,N=C[6*e+5]/255,k=j++;if(o){const o=D[e],d=m.slice(o,o+16),M="geometry."+s+"."+r;let A=z[M];if(!A){A={batchThisMesh:!t.reuseGeometries};let e=!1;switch(_[r]){case 0:A.primitiveName="solid",A.geometryPositions=a.subarray(y[r],n?a.length:y[r+1]),A.geometryNormals=h.subarray(v[r],n?h.length:v[r+1]),A.geometryUVs=u.subarray(P[r],n?u.length:P[r+1]),A.geometryIndices=c.subarray(T[r],n?c.length:T[r+1]),A.geometryEdgeIndices=p.subarray(x[r],n?p.length:x[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;case 1:A.primitiveName="surface",A.geometryPositions=a.subarray(y[r],n?a.length:y[r+1]),A.geometryNormals=h.subarray(v[r],n?h.length:v[r+1]),A.geometryUVs=u.subarray(P[r],n?u.length:P[r+1]),A.geometryIndices=c.subarray(T[r],n?c.length:T[r+1]),A.geometryEdgeIndices=p.subarray(x[r],n?p.length:x[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;case 2:A.primitiveName="points",A.geometryPositions=a.subarray(y[r],n?a.length:y[r+1]),A.geometryColors=l.subarray(w[r],n?l.length:w[r+1]),e=A.geometryPositions.length>0;break;case 3:A.primitiveName="lines",A.geometryPositions=a.subarray(y[r],n?a.length:y[r+1]),A.geometryIndices=c.subarray(T[r],n?c.length:T[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;default:continue}if(e||(A=null),A&&(A.geometryPositions.length,A.batchThisMesh)){A.decompressedPositions=new Float32Array(A.geometryPositions.length),A.transformedAndRecompressedPositions=new Uint16Array(A.geometryPositions.length);const e=A.geometryPositions,t=A.decompressedPositions;for(let s=0,i=e.length;s<i;s+=3)t[s+0]=e[s+0]*g[0]+g[12],t[s+1]=e[s+1]*g[5]+g[13],t[s+2]=e[s+2]*g[10]+g[14];A.geometryPositions=null,z[M]=A;}}if(A)if(A.batchThisMesh){const e=A.decompressedPositions,t=A.transformedAndRecompressedPositions;for(let s=0,i=e.length;s<i;s+=3)Xg[0]=e[s+0],Xg[1]=e[s+1],Xg[2]=e[s+2],Xg[3]=1,f.transformVec4(d,Xg,Yg),Pt.compressPosition(Yg,U,Xg),t[s+0]=Xg[0],t[s+1]=Xg[1],t[s+2]=Xg[2];i.createMesh(b.apply(W,{id:k,textureSetId:I,origin:V,primitive:A.primitiveName,positionsCompressed:t,normalsCompressed:A.geometryNormals,uv:A.geometryUVs,colorsCompressed:A.geometryColors,indices:A.geometryIndices,edgeIndices:A.geometryEdgeIndices,positionsDecodeMatrix:R,color:F,metallic:E,roughness:N,opacity:B})),S.push(k);}else L[M]||(i.createGeometry({id:M,primitive:A.primitiveName,positionsCompressed:A.geometryPositions,normalsCompressed:A.geometryNormals,uv:A.geometryUVs,colorsCompressed:A.geometryColors,indices:A.geometryIndices,edgeIndices:A.geometryEdgeIndices,positionsDecodeMatrix:g}),L[M]=!0),i.createMesh(b.apply(W,{id:k,geometryId:M,textureSetId:I,matrix:d,color:F,metallic:E,roughness:N,opacity:B,origin:V})),S.push(k);}else {let e,t,s,o,d,f,m,g=!1;switch(_[r]){case 0:e="solid",t=a.subarray(y[r],n?a.length:y[r+1]),s=h.subarray(v[r],n?h.length:v[r+1]),o=u.subarray(P[r],n?u.length:P[r+1]),f=c.subarray(T[r],n?c.length:T[r+1]),m=p.subarray(x[r],n?p.length:x[r+1]),g=t.length>0&&f.length>0;break;case 1:e="surface",t=a.subarray(y[r],n?a.length:y[r+1]),s=h.subarray(v[r],n?h.length:v[r+1]),o=u.subarray(P[r],n?u.length:P[r+1]),f=c.subarray(T[r],n?c.length:T[r+1]),m=p.subarray(x[r],n?p.length:x[r+1]),g=t.length>0&&f.length>0;break;case 2:e="points",t=a.subarray(y[r],n?a.length:y[r+1]),d=l.subarray(w[r],n?l.length:w[r+1]),g=t.length>0;break;case 3:e="lines",t=a.subarray(y[r],n?a.length:y[r+1]),f=c.subarray(T[r],n?c.length:T[r+1]),g=t.length>0&&f.length>0;break;default:continue}g&&(i.createMesh(b.apply(W,{id:k,textureSetId:I,origin:V,primitive:e,positionsCompressed:t,normalsCompressed:s,uv:o&&o.length>0?o:null,colorsCompressed:d,indices:f,edgeIndices:m,positionsDecodeMatrix:R,color:F,metallic:E,roughness:N,opacity:B})),S.push(k));}}S.length>0&&i.createEntity(b.apply(G,{id:n,isObject:!0,meshIds:S}));}}}(e,t,o,i);}},Zg={};Zg[gg.version]=gg,Zg[vg.version]=vg,Zg[Pg.version]=Pg,Zg[Mg.version]=Mg,Zg[Cg.version]=Cg,Zg[Bg.version]=Bg,Zg[Og.version]=Og,Zg[Hg.version]=Hg,Zg[Wg.version]=Wg,Zg[Jg.version]=Jg;class Qg extends h{constructor(e,t={}){super("XKTLoader",e,t),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this.textureTranscoder=t.textureTranscoder,this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults,this.includeTypes=t.includeTypes,this.excludeTypes=t.excludeTypes,this.excludeUnclassifiedObjects=t.excludeUnclassifiedObjects,this.reuseGeometries=t.reuseGeometries;}get supportedVersions(){return Object.keys(Zg)}get textureTranscoder(){return this._textureTranscoder}set textureTranscoder(e){this._textureTranscoder=e;}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new im;}get objectDefaults(){return this._objectDefaults}set objectDefaults(e){this._objectDefaults=e||$d;}get includeTypes(){return this._includeTypes}set includeTypes(e){this._includeTypes=e;}get excludeTypes(){return this._excludeTypes}set excludeTypes(e){this._excludeTypes=e;}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(e){this._excludeUnclassifiedObjects=!!e;}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(e){this._globalizeObjectIds=!!e;}get reuseGeometries(){return this._reuseGeometries}set reuseGeometries(e){this._reuseGeometries=!1!==e;}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new wh(this.viewer.scene,b.apply(e,{isModel:!0,textureTranscoder:this._textureTranscoder,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:e.origin})),s=t.id;if(!e.src&&!e.xkt)return this.error("load() param expected: src or xkt"),t;const i={},r=e.includeTypes||this._includeTypes,o=e.excludeTypes||this._excludeTypes,n=e.objectDefaults||this._objectDefaults;if(i.reuseGeometries=null!==e.reuseGeometries&&void 0!==e.reuseGeometries?e.reuseGeometries:!1!==this._reuseGeometries,r){i.includeTypesMap={};for(let e=0,t=r.length;e<t;e++)i.includeTypesMap[r[e]]=!0;}if(o){i.excludeTypesMap={};for(let e=0,t=o.length;e<t;e++)i.excludeTypesMap[o[e]]=!0;}if(n&&(i.objectDefaults=n),i.excludeUnclassifiedObjects=void 0!==e.excludeUnclassifiedObjects?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,i.globalizeObjectIds=void 0!==e.globalizeObjectIds?!!e.globalizeObjectIds:this._globalizeObjectIds,e.metaModelSrc||e.metaModelData){const n=n=>!!this.viewer.metaScene.createMetaModel(s,n,{includeTypes:r,excludeTypes:o,globalizeObjectIds:this.globalizeObjectIds})&&(e.src?this._loadModel(e.src,e,i,t):this._parseModel(e.xkt,e,i,t),t.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(t.id);})),!0);if(e.metaModelSrc){const i=e.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(i,(e=>{t.destroyed||(n(e)||(this.error(`load(): Failed to load model metadata for model '${s} from '${i}' - metadata not valid`),t.fire("error","Metadata not valid")),this.viewer.scene.canvas.spinner.processes--);}),(e=>{this.error(`load(): Failed to load model metadata for model '${s} from  '${i}' - ${e}`),t.fire("error",`Failed to load model metadata from  '${i}' - ${e}`),this.viewer.scene.canvas.spinner.processes--;}));}else e.metaModelData&&(n(e.metaModelData)||(this.error(`load(): Failed to load model metadata for model '${s} from '${e.metaModelSrc}' - metadata not valid`),t.fire("error","Metadata not valid")));}else e.src?this._loadModel(e.src,e,i,t):this._parseModel(e.xkt,e,i,t);return t}_loadModel(e,t,s,i){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getXKT(t.src,(e=>{this._parseModel(e,t,s,i),r.processes--;}),(e=>{r.processes--,this.error(e),i.fire("error",e);}));}_parseModel(e,t,s,i){if(i.destroyed)return;const r=new DataView(e),o=new Uint8Array(e),n=r.getUint32(0,!0),a=Zg[n];if(!a)return void this.error("Unsupported .XKT file version: "+n+" - this XKTLoaderPlugin supports versions "+Object.keys(Zg));this.log("Loading .xkt V"+n);const h=r.getUint32(4,!0),l=[];let u=4*(h+2);for(let e=0;e<h;e++){const t=r.getUint32(4*(e+2),!0);l.push(o.subarray(u,u+t)),u+=t;}a.parse(this.viewer,s,l,i),i.finalize(),this._createDefaultMetaModelIfNeeded(i,t,s),i.scene.once("tick",(()=>{i.destroyed||(i.scene.fire("modelLoaded",i.id),i.fire("loaded",!0,!1));}));}_createDefaultMetaModelIfNeeded(e,t,s){const i=e.id;if(!this.viewer.metaScene.metaModels[i]){const r={metaObjects:[]};r.metaObjects.push({id:i,type:"default",name:i,parent:null});const o=e.entityList;for(let e=0,t=o.length;e<t;e++){const t=o[e];t.isObject&&r.metaObjects.push({id:t.id,type:"default",name:t.id,parent:i});}const n=t.src;this.viewer.metaScene.createMetaModel(i,r,{includeTypes:s.includeTypes,excludeTypes:s.excludeTypes,globalizeObjectIds:s.globalizeObjectIds,getProperties:async e=>await this._dataSource.getProperties(n,e)}),e.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(i);}));}}}var $g={};!function(e){var t,s="File format is not recognized.",i="Error while reading zip file.",r="Error while reading file data.",o=524288,n="text/plain";try{t=0===new Blob([new DataView(new ArrayBuffer(0))]).size;}catch(e){}function a(){this.crc=-1;}function h(){}function l(e,t){var s,i;return s=new ArrayBuffer(e),i=new Uint8Array(s),t&&i.set(t,0),{buffer:s,array:i,view:new DataView(s)}}function u(){}function c(e){var t,s=this;s.size=0,s.init=function(i,r){var o=new Blob([e],{type:n});(t=new d(o)).init((function(){s.size=t.size,i();}),r);},s.readUint8Array=function(e,s,i,r){t.readUint8Array(e,s,i,r);};}function p(t){var s,i=this;i.size=0,i.init=function(e){for(var r=t.length;"="==t.charAt(r-1);)r--;s=t.indexOf(",")+1,i.size=Math.floor(.75*(r-s)),e();},i.readUint8Array=function(i,r,o){var n,a=l(r),h=4*Math.floor(i/3),u=4*Math.ceil((i+r)/3),c=e.atob(t.substring(h+s,u+s)),p=i-3*Math.floor(h/4);for(n=p;n<p+r;n++)a.array[n-p]=c.charCodeAt(n);o(a.array);};}function d(e){var t=this;t.size=0,t.init=function(s){t.size=e.size,s();},t.readUint8Array=function(t,s,i,r){var o=new FileReader;o.onload=function(e){i(new Uint8Array(e.target.result));},o.onerror=r;try{o.readAsArrayBuffer(function(e,t,s){if(t<0||s<0||t+s>e.size)throw new RangeError("offset:"+t+", length:"+s+", size:"+e.size);return e.slice?e.slice(t,t+s):e.webkitSlice?e.webkitSlice(t,t+s):e.mozSlice?e.mozSlice(t,t+s):e.msSlice?e.msSlice(t,t+s):void 0}(e,t,s));}catch(e){r(e);}};}function f(){}function m(e){var s,i=this;i.init=function(e){s=new Blob([],{type:n}),e();},i.writeUint8Array=function(e,i){s=new Blob([s,t?e:e.buffer],{type:n}),i();},i.getData=function(t,i){var r=new FileReader;r.onload=function(e){t(e.target.result);},r.onerror=i,r.readAsText(s,e);};}function g(t){var s=this,i="",r="";s.init=function(e){i+="data:"+(t||"")+";base64,",e();},s.writeUint8Array=function(t,s){var o,n=r.length,a=r;for(r="",o=0;o<3*Math.floor((n+t.length)/3)-n;o++)a+=String.fromCharCode(t[o]);for(;o<t.length;o++)r+=String.fromCharCode(t[o]);a.length>2?i+=e.btoa(a):r=a,s();},s.getData=function(t){t(i+e.btoa(r));};}function _(e){var s,i=this;i.init=function(t){s=new Blob([],{type:e}),t();},i.writeUint8Array=function(i,r){s=new Blob([s,t?i:i.buffer],{type:e}),r();},i.getData=function(e){e(s);};}function y(e,t,s,i,r,n,a,h,l,u){var c,p,d,f=0,m=t.sn;function g(){e.removeEventListener("message",_,!1),h(p,d);}function _(t){var s=t.data,r=s.data,o=s.error;if(o)return o.toString=function(){return "Error: "+this.message},void l(o);if(s.sn===m)switch("number"==typeof s.codecTime&&(e.codecTime+=s.codecTime),"number"==typeof s.crcTime&&(e.crcTime+=s.crcTime),s.type){case"append":r?(p+=r.length,i.writeUint8Array(r,(function(){y();}),u)):y();break;case"flush":d=s.crc,r?(p+=r.length,i.writeUint8Array(r,(function(){g();}),u)):g();break;case"progress":a&&a(c+s.loaded,n);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",s);}}function y(){(c=f*o)<=n?s.readUint8Array(r+c,Math.min(o,n-c),(function(s){a&&a(c,n);var i=0===c?t:{sn:m};i.type="append",i.data=s;try{e.postMessage(i,[s.buffer]);}catch(t){e.postMessage(i);}f++;}),l):e.postMessage({sn:m,type:"flush"});}p=0,e.addEventListener("message",_,!1),y();}function v(e,t,s,i,r,n,h,l,u,c){var p,d=0,f=0,m="input"===n,g="output"===n,_=new a;!function n(){var a;if((p=d*o)<r)t.readUint8Array(i+p,Math.min(o,r-p),(function(t){var i;try{i=e.append(t,(function(e){h&&h(p+e,r);}));}catch(e){return void u(e)}i?(f+=i.length,s.writeUint8Array(i,(function(){d++,setTimeout(n,1);}),c),g&&_.append(i)):(d++,setTimeout(n,1)),m&&_.append(t),h&&h(p,r);}),u);else {try{a=e.flush();}catch(e){return void u(e)}a?(g&&_.append(a),f+=a.length,s.writeUint8Array(a,(function(){l(f,_.get());}),c)):l(f,_.get());}}();}function b(t,s,i,r,o,n,a,l,u,c,p){var d="input";e.zip.useWebWorkers&&a?y(t,{sn:s,codecClass:"NOOP",crcType:d},i,r,o,n,u,l,c,p):v(new h,i,r,o,n,d,u,l,c,p);}function w(e){var t,s,i="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)i+=(s=255&e.charCodeAt(t))>127?r[s-128]:String.fromCharCode(s);return i}function P(e){return decodeURIComponent(escape(e))}function T(e){var t,s="";for(t=0;t<e.length;t++)s+=String.fromCharCode(e[t]);return s}function x(e,t,s,i,r){e.version=t.view.getUint16(s,!0),e.bitFlag=t.view.getUint16(s+2,!0),e.compressionMethod=t.view.getUint16(s+4,!0),e.lastModDateRaw=t.view.getUint32(s+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,s=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&s)>>11,(2016&s)>>5,2*(31&s),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?((i||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(s+10,!0),e.compressedSize=t.view.getUint32(s+14,!0),e.uncompressedSize=t.view.getUint32(s+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(s+22,!0),e.extraFieldLength=t.view.getUint16(s+24,!0)):r("File is using Zip64 (4gb+ file size).")):r("File contains encrypted entry.");}function M(t,o,n){var a=0;function h(){}h.prototype.getData=function(i,o,h,u){var c=this;function p(e,t){u&&!function(e){var t=l(4);return t.view.setUint32(0,e),c.crc32==t.view.getUint32(0)}(t)?n("CRC failed."):i.getData((function(e){o(e);}));}function d(e){n(e||r);}function f(e){n(e||"Error while writing file data.");}t.readUint8Array(c.offset,30,(function(r){var o,m=l(r.length,r);1347093252==m.view.getUint32(0)?(x(c,m,4,!1,n),o=c.offset+30+c.filenameLength+c.extraFieldLength,i.init((function(){0===c.compressionMethod?b(c._worker,a++,t,i,o,c.compressedSize,u,p,h,d,f):function(t,s,i,r,o,n,a,h,l,u,c){var p=a?"output":"none";e.zip.useWebWorkers?y(t,{sn:s,codecClass:"Inflater",crcType:p},i,r,o,n,l,h,u,c):v(new e.zip.Inflater,i,r,o,n,p,l,h,u,c);}(c._worker,a++,t,i,o,c.compressedSize,u,p,h,d,f);}),f)):n(s);}),d);};var u={getEntries:function(e){var r=this._worker;!function(e){t.size<22?n(s):r(22,(function(){r(Math.min(65558,t.size),(function(){n(s);}));}));function r(s,r){t.readUint8Array(t.size-s,s,(function(t){for(var s=t.length-22;s>=0;s--)if(80===t[s]&&75===t[s+1]&&5===t[s+2]&&6===t[s+3])return void e(new DataView(t.buffer,s,22));r();}),(function(){n(i);}));}}((function(o){var a,u;a=o.getUint32(16,!0),u=o.getUint16(8,!0),a<0||a>=t.size?n(s):t.readUint8Array(a,t.size-a,(function(t){var i,o,a,c,p=0,d=[],f=l(t.length,t);for(i=0;i<u;i++){if((o=new h)._worker=r,1347092738!=f.view.getUint32(p))return void n(s);x(o,f,p+6,!0,n),o.commentLength=f.view.getUint16(p+32,!0),o.directory=16==(16&f.view.getUint8(p+38)),o.offset=f.view.getUint32(p+42,!0),a=T(f.array.subarray(p+46,p+46+o.filenameLength)),o.filename=2048==(2048&o.bitFlag)?P(a):w(a),o.directory||"/"!=o.filename.charAt(o.filename.length-1)||(o.directory=!0),c=T(f.array.subarray(p+46+o.filenameLength+o.extraFieldLength,p+46+o.filenameLength+o.extraFieldLength+o.commentLength)),o.comment=2048==(2048&o.bitFlag)?P(c):w(c),d.push(o),p+=46+o.filenameLength+o.extraFieldLength+o.commentLength;}e(d);}),(function(){n(i);}));}));},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e();},_worker:null};e.zip.useWebWorkers?F("inflater",(function(e){u._worker=e,o(u);}),(function(e){n(e);})):o(u);}function D(e){return unescape(encodeURIComponent(e))}function A(e){var t,s=[];for(t=0;t<e.length;t++)s.push(e.charCodeAt(t));return s}function C(t,s,i,o){var n={},a=[],h=0,u=0;function c(e){i(e||"Error while writing zip file.");}function p(e){i(e||r);}var d={add:function(s,r,d,f,m){var g,_,w,P=this._worker;function T(e,s){var i=l(16);h+=e||0,i.view.setUint32(0,1347094280),void 0!==s&&(g.view.setUint32(10,s,!0),i.view.setUint32(4,s,!0)),r&&(i.view.setUint32(8,e,!0),g.view.setUint32(14,e,!0),i.view.setUint32(12,r.size,!0),g.view.setUint32(18,r.size,!0)),t.writeUint8Array(i.array,(function(){h+=16,d();}),c);}function x(){m=m||{},s=s.trim(),m.directory&&"/"!=s.charAt(s.length-1)&&(s+="/"),n.hasOwnProperty(s)?i("File already exists."):(_=A(D(s)),a.push(s),function(e){var i;w=m.lastModDate||new Date,g=l(26),n[s]={headerArray:g.array,directory:m.directory,filename:_,offset:h,comment:A(D(m.comment||""))},g.view.setUint32(0,335546376),m.version&&g.view.setUint8(0,m.version),o||0===m.level||m.directory||g.view.setUint16(4,2048),g.view.setUint16(6,(w.getHours()<<6|w.getMinutes())<<5|w.getSeconds()/2,!0),g.view.setUint16(8,(w.getFullYear()-1980<<4|w.getMonth()+1)<<5|w.getDate(),!0),g.view.setUint16(22,_.length,!0),(i=l(30+_.length)).view.setUint32(0,1347093252),i.array.set(g.array,4),i.array.set(_,30),h+=i.array.length,t.writeUint8Array(i.array,e,c);}((function(){r?o||0===m.level?b(P,u++,r,t,0,r.size,!0,T,f,p,c):function(t,s,i,r,o,n,a,h,l){var u="input";e.zip.useWebWorkers?y(t,{sn:s,options:{level:o},codecClass:"Deflater",crcType:u},i,r,0,i.size,a,n,h,l):v(new e.zip.Deflater,i,r,0,i.size,u,a,n,h,l);}(P,u++,r,t,m.level,T,f,p,c):T();})));}r?r.init(x,p):x();},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var s,i,r,o=0,u=0;for(i=0;i<a.length;i++)o+=46+(r=n[a[i]]).filename.length+r.comment.length;for(s=l(o+22),i=0;i<a.length;i++)r=n[a[i]],s.view.setUint32(u,1347092738),s.view.setUint16(u+4,5120),s.array.set(r.headerArray,u+6),s.view.setUint16(u+32,r.comment.length,!0),r.directory&&s.view.setUint8(u+38,16),s.view.setUint32(u+42,r.offset,!0),s.array.set(r.filename,u+46),s.array.set(r.comment,u+46+r.filename.length),u+=46+r.filename.length+r.comment.length;s.view.setUint32(u,1347093766),s.view.setUint16(u+8,a.length,!0),s.view.setUint16(u+10,a.length,!0),s.view.setUint32(u+12,o,!0),s.view.setUint32(u+16,h,!0),t.writeUint8Array(s.array,(function(){t.getData(e);}),c);},_worker:null};e.zip.useWebWorkers?F("deflater",(function(e){d._worker=e,s(d);}),(function(e){i(e);})):s(d);}a.prototype.append=function(e){for(var t=0|this.crc,s=this.table,i=0,r=0|e.length;i<r;i++)t=t>>>8^s[255&(t^e[i])];this.crc=t;},a.prototype.get=function(){return ~this.crc},a.prototype.table=function(){var e,t,s,i=[];for(e=0;e<256;e++){for(s=e,t=0;t<8;t++)1&s?s=s>>>1^3988292384:s>>>=1;i[e]=s;}return i}(),h.prototype.append=function(e,t){return e},h.prototype.flush=function(){},c.prototype=new u,c.prototype.constructor=c,p.prototype=new u,p.prototype.constructor=p,d.prototype=new u,d.prototype.constructor=d,f.prototype.getData=function(e){e(this.data);},m.prototype=new f,m.prototype.constructor=m,g.prototype=new f,g.prototype.constructor=g,_.prototype=new f,_.prototype.constructor=_;var I={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function F(t,s,i){if(null===e.zip.workerScripts||null===e.zip.workerScriptsPath){var r;if(e.zip.workerScripts){if(r=e.zip.workerScripts[t],!Array.isArray(r))return void i(new Error("zip.workerScripts."+t+" is not an array!"));r=function(e){var t=document.createElement("a");return e.map((function(e){return t.href=e,t.href}))}(r);}else (r=I[t].slice(0))[0]=(e.zip.workerScriptsPath||"")+r[0];var o=new Worker(r[0]);o.codecTime=o.crcTime=0,o.postMessage({type:"importScripts",scripts:r.slice(1)}),o.addEventListener("message",(function e(t){var r=t.data;if(r.error)return o.terminate(),void i(r.error);"importScripts"===r.type&&(o.removeEventListener("message",e),o.removeEventListener("error",n),s(o));})),o.addEventListener("error",n);}else i(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function n(e){o.terminate(),i(e);}}function B(e){console.error(e);}e.zip={Reader:u,Writer:f,BlobReader:d,Data64URIReader:p,TextReader:c,BlobWriter:_,Data64URIWriter:g,TextWriter:m,createReader:function(e,t,s){s=s||B,e.init((function(){M(e,t,s);}),s);},createWriter:function(e,t,s,i){s=s||B,i=!!i,e.init((function(){C(e,t,s,i);}),s);},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null};}($g);const e_=$g.zip;!function(e){var t,s,i=e.Reader,r=e.Writer;try{s=0===new Blob([new DataView(new ArrayBuffer(0))]).size;}catch(e){}function o(e){var t=this;function s(s,i){var r;t.data?s():((r=new XMLHttpRequest).addEventListener("load",(function(){t.size||(t.size=Number(r.getResponseHeader("Content-Length"))||Number(r.response.byteLength)),t.data=new Uint8Array(r.response),s();}),!1),r.addEventListener("error",i,!1),r.open("GET",e),r.responseType="arraybuffer",r.send());}t.size=0,t.init=function(i,r){if(function(e){var t=document.createElement("a");return t.href=e,"http:"===t.protocol||"https:"===t.protocol}(e)){var o=new XMLHttpRequest;o.addEventListener("load",(function(){t.size=Number(o.getResponseHeader("Content-Length")),t.size?i():s(i,r);}),!1),o.addEventListener("error",r,!1),o.open("HEAD",e),o.send();}else s(i,r);},t.readUint8Array=function(e,i,r,o){s((function(){r(new Uint8Array(t.data.subarray(e,e+i)));}),o);};}function n(e){var t=this;t.size=0,t.init=function(s,i){var r=new XMLHttpRequest;r.addEventListener("load",(function(){t.size=Number(r.getResponseHeader("Content-Length")),"bytes"==r.getResponseHeader("Accept-Ranges")?s():i("HTTP Range not supported.");}),!1),r.addEventListener("error",i,!1),r.open("HEAD",e),r.send();},t.readUint8Array=function(t,s,i,r){!function(t,s,i,r){var o=new XMLHttpRequest;o.open("GET",e),o.responseType="arraybuffer",o.setRequestHeader("Range","bytes="+t+"-"+(t+s-1)),o.addEventListener("load",(function(){i(o.response);}),!1),o.addEventListener("error",r,!1),o.send();}(t,s,(function(e){i(new Uint8Array(e));}),r);};}function a(e){var t=this;t.size=0,t.init=function(s,i){t.size=e.byteLength,s();},t.readUint8Array=function(t,s,i,r){i(new Uint8Array(e.slice(t,t+s)));};}function h(){var e,t=this;t.init=function(t,s){e=new Uint8Array,t();},t.writeUint8Array=function(t,s,i){var r=new Uint8Array(e.length+t.length);r.set(e),r.set(t,e.length),e=r,s();},t.getData=function(t){t(e.buffer);};}function l(e,t){var i,r=this;r.init=function(t,s){e.createWriter((function(e){i=e,t();}),s);},r.writeUint8Array=function(e,r,o){var n=new Blob([s?e:e.buffer],{type:t});i.onwrite=function(){i.onwrite=null,r();},i.onerror=o,i.write(n);},r.getData=function(t){e.file(t);};}o.prototype=new i,o.prototype.constructor=o,n.prototype=new i,n.prototype.constructor=n,a.prototype=new i,a.prototype.constructor=a,h.prototype=new r,h.prototype.constructor=h,l.prototype=new r,l.prototype.constructor=l,e.FileWriter=l,e.HttpReader=o,e.HttpRangeReader=n,e.ArrayBufferReader=a,e.ArrayBufferWriter=h,e.fs&&((t=e.fs.ZipDirectoryEntry).prototype.addHttpContent=function(s,i,r){return function(s,i,r,o){if(s.directory)return o?new t(s.fs,i,r,s):new e.fs.ZipFileEntry(s.fs,i,r,s);throw "Parent entry is not a directory."}(this,s,{data:i,Reader:r?n:o})},t.prototype.importHttpContent=function(e,t,s,i){this.importZip(t?new n(e):new o(e),s,i);},e.fs.FS.prototype.importHttpContent=function(e,s,i,r){this.entries=[],this.root=new t(this),this.root.importHttpContent(e,s,i,r);});}(e_);var f_,w_=e=>{if("undefined"!=typeof require)return require(e);throw new Error('Dynamic require of "'+e+'" is not supported')},P_=(e,t)=>function(){return t||(0, e[Object.keys(e)[0]])((t={exports:{}}).exports,t),t.exports},x_=P_({"(disabled):crypto"(){}}),M_=P_({"dist/web-ifc-mt.js"(e,t){var s,i=(s="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(s=s||__filename),function(e){function t(){return F.buffer!=O&&oe(F.buffer),L}function i(){return F.buffer!=O&&oe(F.buffer),N}function r(){return F.buffer!=O&&oe(F.buffer),k}function o(){return F.buffer!=O&&oe(F.buffer),j}function n(){return F.buffer!=O&&oe(F.buffer),G}function a(){return F.buffer!=O&&oe(F.buffer),H}function h(){return F.buffer!=O&&oe(F.buffer),U}var l,u,c=void 0!==(e=e||{})?e:{};c.ready=new Promise((function(e,t){l=e,u=t;}));var p,d={};for(p in c)c.hasOwnProperty(p)&&(d[p]=c[p]);var f,m,g,_,y="./this.program",v=function(e,t){throw t};f="object"==typeof window,m="function"==typeof importScripts,g="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,_=!f&&!g&&!m;var b=c.ENVIRONMENT_IS_PTHREAD||!1;b&&(O=c.buffer);var w,P,T,x,M="";function D(e){return c.locateFile?c.locateFile(e,M):M+e}if(g){var A;M=m?w_("path").dirname(M)+"/":__dirname+"/",w=function(e,t){return T||(T=w_("fs")),x||(x=w_("path")),e=x.normalize(e),T.readFileSync(e,t?null:"utf8")},P=function(e){var t=w(e,!0);return t.buffer||(t=new Uint8Array(t)),X(t.buffer),t},process.argv.length>1&&(y=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),process.on("uncaughtException",(function(e){if(!(e instanceof Pi))throw e})),process.on("unhandledRejection",ge),v=function(e){process.exit(e);},c.inspect=function(){return "[Emscripten Module object]"};try{A=w_("worker_threads");}catch(e){throw console.error('The "worker_threads" module is not supported in this node.js build - perhaps a newer version is needed?'),e}global.Worker=A.Worker;}else _?("undefined"!=typeof read&&(w=function(e){return read(e)}),P=function(e){var t;return "function"==typeof readbuffer?new Uint8Array(readbuffer(e)):(X("object"==typeof(t=read(e,"binary"))),t)},"undefined"!=typeof scriptArgs&&scriptArgs,"function"==typeof quit&&(v=function(e){quit(e);}),"undefined"!=typeof print&&("undefined"==typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!=typeof printErr?printErr:print)):(f||m)&&(m?M=self.location.href:"undefined"!=typeof document&&document.currentScript&&(M=document.currentScript.src),s&&(M=s),M=0!==M.indexOf("blob:")?M.substr(0,M.lastIndexOf("/")+1):"",g?(w=function(e,t){return T||(T=w_("fs")),x||(x=w_("path")),e=x.normalize(e),T.readFileSync(e,t?null:"utf8")},P=function(e){var t=w(e,!0);return t.buffer||(t=new Uint8Array(t)),X(t.buffer),t}):(w=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},m&&(P=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)})));g&&"undefined"==typeof performance&&(global.performance=w_("perf_hooks").performance);var C,I,F,B,E=c.print||console.log.bind(console),S=c.printErr||console.warn.bind(console);for(p in d)d.hasOwnProperty(p)&&(c[p]=d[p]);function R(e){R.shown||(R.shown={}),R.shown[e]||(R.shown[e]=1,S(e));}d=null,c.arguments,c.thisProgram&&(y=c.thisProgram),c.quit&&(v=c.quit),c.wasmBinary&&(C=c.wasmBinary),c.noExitRuntime&&(I=c.noExitRuntime),"object"!=typeof WebAssembly&&ge("no native wasm support detected");var O,L,N,k,j,G,H,V,U,z=0,W=!1;function X(e,t){e||ge("Assertion failed: "+t);}function Y(e,t,s){for(var i=(t>>>=0)+s,r="";!(t>=i);){var o=e[t++>>>0];if(!o)return r;if(128&o){var n=63&e[t++>>>0];if(192!=(224&o)){var a=63&e[t++>>>0];if((o=224==(240&o)?(15&o)<<12|n<<6|a:(7&o)<<18|n<<12|a<<6|63&e[t++>>>0])<65536)r+=String.fromCharCode(o);else {var h=o-65536;r+=String.fromCharCode(55296|h>>10,56320|1023&h);}}else r+=String.fromCharCode((31&o)<<6|n);}else r+=String.fromCharCode(o);}return r}function K(e,t){return (e>>>=0)?Y(i(),e,t):""}function J(e,t,s,i){if(!(i>0))return 0;for(var r=s>>>=0,o=s+i-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),a<=127){if(s>=o)break;t[s++>>>0]=a;}else if(a<=2047){if(s+1>=o)break;t[s++>>>0]=192|a>>6,t[s++>>>0]=128|63&a;}else if(a<=65535){if(s+2>=o)break;t[s++>>>0]=224|a>>12,t[s++>>>0]=128|a>>6&63,t[s++>>>0]=128|63&a;}else {if(s+3>=o)break;t[s++>>>0]=240|a>>18,t[s++>>>0]=128|a>>12&63,t[s++>>>0]=128|a>>6&63,t[s++>>>0]=128|63&a;}}return t[s>>>0]=0,s-r}function Z(e,t,s){return J(e,i(),t,s)}function Q(e){for(var t=0,s=0;s<e.length;++s){var i=e.charCodeAt(s);i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++s)),i<=127?++t:t+=i<=2047?2:i<=65535?3:4;}return t}function q(e,t){for(var s="",i=0;!(i>=t/2);++i){var o=r()[e+2*i>>1];if(0==o)break;s+=String.fromCharCode(o);}return s}function $(e,t,s){if(void 0===s&&(s=2147483647),s<2)return 0;for(var i=t,o=(s-=2)<2*e.length?s/2:e.length,n=0;n<o;++n){var a=e.charCodeAt(n);r()[t>>1]=a,t+=2;}return r()[t>>1]=0,t-i}function ee(e){return 2*e.length}function te(e,t){for(var s=0,i="";!(s>=t/4);){var r=n()[e+4*s>>2];if(0==r)break;if(++s,r>=65536){var o=r-65536;i+=String.fromCharCode(55296|o>>10,56320|1023&o);}else i+=String.fromCharCode(r);}return i}function se(e,t,s){if(void 0===s&&(s=2147483647),s<4)return 0;for(var i=t>>>=0,r=i+s-4,o=0;o<e.length;++o){var a=e.charCodeAt(o);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++o)),n()[t>>2]=a,(t+=4)+4>r)break}return n()[t>>2]=0,t-i}function ie(e){for(var t=0,s=0;s<e.length;++s){var i=e.charCodeAt(s);i>=55296&&i<=57343&&++s,t+=4;}return t}function re(e,t){return e%t>0&&(e+=t-e%t),e}function oe(e){O=e,c.HEAP8=L=new Int8Array(e),c.HEAP16=k=new Int16Array(e),c.HEAP32=G=new Int32Array(e),c.HEAPU8=N=new Uint8Array(e),c.HEAPU16=j=new Uint16Array(e),c.HEAPU32=H=new Uint32Array(e),c.HEAPF32=V=new Float32Array(e),c.HEAPF64=U=new Float64Array(e);}var ne,ae=c.INITIAL_MEMORY||16777216;if(b)F=c.wasmMemory,O=c.buffer;else if(c.wasmMemory)F=c.wasmMemory;else if(!((F=new WebAssembly.Memory({initial:ae/65536,maximum:65536,shared:!0})).buffer instanceof SharedArrayBuffer))throw S("requested a shared WebAssembly.Memory but the returned buffer is not a SharedArrayBuffer, indicating that while the browser has SharedArrayBuffer it does not have WebAssembly threads support - you may need to set a flag"),g&&console.log("(on node you may need: --experimental-wasm-threads --experimental-wasm-bulk-memory and also use a recent version)"),Error("bad memory");F&&(O=F.buffer),ae=O.byteLength,oe(O);var he=[],le=[],ue=[],ce=[],pe=0,de=null;function fe(e){X(!b,"addRunDependency cannot be used in a pthread worker"),pe++,c.monitorRunDependencies&&c.monitorRunDependencies(pe);}function me(e){if(pe--,c.monitorRunDependencies&&c.monitorRunDependencies(pe),0==pe&&de){var t=de;de=null,t();}}function ge(e){c.onAbort&&c.onAbort(e),b&&console.error("Pthread aborting at "+(new Error).stack),S(e+=""),W=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw u(t),t}function _e(e,t){return String.prototype.startsWith?e.startsWith(t):0===e.indexOf(t)}function ye(e){return _e(e,"data:application/octet-stream;base64,")}function ve(e){return _e(e,"file://")}c.preloadedImages={},c.preloadedAudios={};var be,we,Pe="web-ifc-mt.wasm";function Te(){try{if(C)return new Uint8Array(C);if(P)return P(Pe);throw "both async and sync fetching of the wasm failed"}catch(e){ge(e);}}ye(Pe)||(Pe=D(Pe));var xe={41793:function(e,t){setTimeout((function(){gi(e,t);}),0);},41871:function(){throw "Canceled!"}};function Me(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var s=t.func;"number"==typeof s?void 0===t.arg?ne.get(s)():ne.get(s)(t.arg):s(void 0===t.arg?null:t.arg);}else t(c);}}function De(e,t,s){return -1!=e.indexOf("j")?function(e,t,s){return s&&s.length?c["dynCall_"+e].apply(null,[t].concat(s)):c["dynCall_"+e].call(null,t)}(e,t,s):ne.get(t).apply(null,s)}c.dynCall=De;var Ae=0,Ce=0,Ie=0;function Fe(e,t,s){Ae=e|=0,Ie=t|=0,Ce=s|=0;}c.registerPthreadPtr=Fe;var Be=71,Ee=28;function Se(e,s){if(e<=0||e>t().length||!0&e||s<0)return -28;if(0==s)return 0;s>=2147483647&&(s=1/0);var i=Atomics.load(n(),Oe.mainThreadFutex>>2),r=0;if(i==e&&Atomics.compareExchange(n(),Oe.mainThreadFutex>>2,i,0)==i&&(r=1,--s<=0))return 1;var o=Atomics.notify(n(),e>>2,s);if(o>=0)return o+r;throw "Atomics.notify returned an unexpected value "+o}c._emscripten_futex_wake=Se;var Re,Oe={MAIN_THREAD_ID:1,mainThreadInfo:{schedPolicy:0,schedPrio:0},unusedWorkers:[],runningWorkers:[],initMainThreadBlock:function(){for(var e=navigator.hardwareConcurrency,t=0;t<e;++t)Oe.allocateUnusedWorker();},initRuntime:function(){Oe.mainThreadBlock=ii(232);for(var e=0;e<58;++e)a()[Oe.mainThreadBlock/4+e]=0;n()[Oe.mainThreadBlock+12>>2]=Oe.mainThreadBlock;var t=Oe.mainThreadBlock+156;n()[t>>2]=t;var s=ii(512);for(e=0;e<128;++e)a()[s/4+e]=0;Atomics.store(a(),Oe.mainThreadBlock+104>>2,s),Atomics.store(a(),Oe.mainThreadBlock+40>>2,Oe.mainThreadBlock),Atomics.store(a(),Oe.mainThreadBlock+44>>2,42),Oe.initShared(),Fe(Oe.mainThreadBlock,!m,1),mi(Oe.mainThreadBlock);},initWorker:function(){Oe.initShared(),l(c);},initShared:function(){Oe.mainThreadFutex=wi;},pthreads:{},threadExitHandlers:[],setThreadStatus:function(){},runExitHandlers:function(){for(;Oe.threadExitHandlers.length>0;)Oe.threadExitHandlers.pop()();b&&z&&di();},threadExit:function(e){var t=Vs();t&&(Atomics.store(a(),t+4>>2,e),Atomics.store(a(),t+0>>2,1),Atomics.store(a(),t+60>>2,1),Atomics.store(a(),t+64>>2,0),Oe.runExitHandlers(),Se(t+0,2147483647),Fe(0,0,0),z=0,b&&postMessage({cmd:"exit"}));},threadCancel:function(){Oe.runExitHandlers(),Atomics.store(a(),z+4>>2,-1),Atomics.store(a(),z+0>>2,1),Se(z+0,2147483647),z=0,Fe(0,0,0),postMessage({cmd:"cancelDone"});},terminateAllThreads:function(){for(var e in Oe.pthreads)(i=Oe.pthreads[e])&&i.worker&&Oe.returnWorkerToPool(i.worker);Oe.pthreads={};for(var t=0;t<Oe.unusedWorkers.length;++t)(s=Oe.unusedWorkers[t]).terminate();for(Oe.unusedWorkers=[],t=0;t<Oe.runningWorkers.length;++t){var s,i=(s=Oe.runningWorkers[t]).pthread;Oe.freeThreadData(i),s.terminate();}Oe.runningWorkers=[];},freeThreadData:function(e){if(e){if(e.threadInfoStruct){var t=n()[e.threadInfoStruct+104>>2];n()[e.threadInfoStruct+104>>2]=0,ri(t),ri(e.threadInfoStruct);}e.threadInfoStruct=0,e.allocatedOwnStack&&e.stackBase&&ri(e.stackBase),e.stackBase=0,e.worker&&(e.worker.pthread=null);}},returnWorkerToPool:function(e){delete Oe.pthreads[e.pthread.thread],Oe.unusedWorkers.push(e),Oe.runningWorkers.splice(Oe.runningWorkers.indexOf(e),1),Oe.freeThreadData(e.pthread),e.pthread=void 0;},receiveObjectTransfer:function(e){},loadWasmModuleToWorker:function(e,t){e.onmessage=function(s){var i=s.data,r=i.cmd;if(e.pthread&&(Oe.currentProxiedOperationCallerThread=e.pthread.threadInfoStruct),i.targetThread&&i.targetThread!=Vs()){var o=Oe.pthreads[i.targetThread];return o?o.worker.postMessage(s.data,i.transferList):console.error('Internal error! Worker sent a message "'+r+'" to target pthread '+i.targetThread+", but that thread no longer exists!"),void(Oe.currentProxiedOperationCallerThread=void 0)}"processQueuedMainThreadWork"===r?fi():"spawnThread"===r?Hs(s.data):"cleanupThread"===r?function(e){if(b)throw "Internal Error! cleanupThread() can only ever be called from main application thread!";if(!e)throw "Internal Error! Null pthread_ptr in cleanupThread!";n()[e+12>>2]=0;var t=Oe.pthreads[e];if(t){var s=t.worker;Oe.returnWorkerToPool(s);}}(i.thread):"killThread"===r?function(e){if(b)throw "Internal Error! killThread() can only ever be called from main application thread!";if(!e)throw "Internal Error! Null pthread_ptr in killThread!";n()[e+12>>2]=0;var t=Oe.pthreads[e];t.worker.terminate(),Oe.freeThreadData(t),Oe.runningWorkers.splice(Oe.runningWorkers.indexOf(t.worker),1),t.worker.pthread=void 0;}(i.thread):"cancelThread"===r?function(e){if(b)throw "Internal Error! cancelThread() can only ever be called from main application thread!";if(!e)throw "Internal Error! Null pthread_ptr in cancelThread!";Oe.pthreads[e].worker.postMessage({cmd:"cancel"});}(i.thread):"loaded"===r?(e.loaded=!0,t&&t(e),e.runPthread&&(e.runPthread(),delete e.runPthread)):"print"===r?E("Thread "+i.threadId+": "+i.text):"printErr"===r?S("Thread "+i.threadId+": "+i.text):"alert"===r?alert("Thread "+i.threadId+": "+i.text):"exit"===r?e.pthread&&Atomics.load(a(),e.pthread.thread+68>>2)&&Oe.returnWorkerToPool(e):"cancelDone"===r?Oe.returnWorkerToPool(e):"objectTransfer"===r?Oe.receiveObjectTransfer(s.data):"setimmediate"===s.data.target?e.postMessage(s.data):S("worker sent an unknown command "+r),Oe.currentProxiedOperationCallerThread=void 0;},e.onerror=function(e){S("pthread sent an error! "+e.filename+":"+e.lineno+": "+e.message);},g&&(e.on("message",(function(t){e.onmessage({data:t});})),e.on("error",(function(t){e.onerror(t);})),e.on("exit",(function(e){}))),e.postMessage({cmd:"load",urlOrBlob:c.mainScriptUrlOrBlob||s,wasmMemory:F,wasmModule:B});},allocateUnusedWorker:function(){var e=D("web-ifc-mt.worker.js");Oe.unusedWorkers.push(new Worker(e));},getNewWorker:function(){return 0==Oe.unusedWorkers.length&&(Oe.allocateUnusedWorker(),Oe.loadWasmModuleToWorker(Oe.unusedWorkers[0])),Oe.unusedWorkers.length>0?Oe.unusedWorkers.pop():null},busySpinWait:function(e){for(var t=performance.now()+e;performance.now()<t;);}};c.establishStackSpace=function(e,t){ci(e,t),li(e);},c.getNoExitRuntime=function(){return I},Re=g?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:b?function(){return performance.now()-c.__performance_now_clock_drift}:"undefined"!=typeof dateNow?dateNow:function(){return performance.now()};var Le=0,Ne=4,ke=8,je=12,Ge=13,He=16;function Ve(e){this.excPtr=e,this.ptr=e-He,this.set_type=function(e){n()[this.ptr+ke>>2]=e;},this.get_type=function(){return n()[this.ptr+ke>>2]},this.set_destructor=function(e){n()[this.ptr+Le>>2]=e;},this.get_destructor=function(){return n()[this.ptr+Le>>2]},this.set_refcount=function(e){n()[this.ptr+Ne>>2]=e;},this.set_caught=function(e){e=e?1:0,t()[this.ptr+je>>0]=e;},this.get_caught=function(){return 0!=t()[this.ptr+je>>0]},this.set_rethrown=function(e){e=e?1:0,t()[this.ptr+Ge>>0]=e;},this.get_rethrown=function(){return 0!=t()[this.ptr+Ge>>0]},this.init=function(e,t){this.set_type(e),this.set_destructor(t),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1);},this.add_ref=function(){Atomics.add(n(),this.ptr+Ne>>2,1);},this.release_ref=function(){return 1===Atomics.sub(n(),this.ptr+Ne>>2,1)};}var Ue={splitPath:function(e){return /^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1)},normalizeArray:function(e,t){for(var s=0,i=e.length-1;i>=0;i--){var r=e[i];"."===r?e.splice(i,1):".."===r?(e.splice(i,1),s++):s&&(e.splice(i,1),s--);}if(t)for(;s;s--)e.unshift("..");return e},normalize:function(e){var t="/"===e.charAt(0),s="/"===e.substr(-1);return e=Ue.normalizeArray(e.split("/").filter((function(e){return !!e})),!t).join("/"),e||t||(e="."),e&&s&&(e+="/"),(t?"/":"")+e},dirname:function(e){var t=Ue.splitPath(e),s=t[0],i=t[1];return s||i?(i&&(i=i.substr(0,i.length-1)),s+i):"."},basename:function(e){if("/"===e)return "/";var t=(e=(e=Ue.normalize(e)).replace(/\/$/,"")).lastIndexOf("/");return -1===t?e:e.substr(t+1)},extname:function(e){return Ue.splitPath(e)[3]},join:function(){var e=Array.prototype.slice.call(arguments,0);return Ue.normalize(e.join("/"))},join2:function(e,t){return Ue.normalize(e+"/"+t)}},ze={resolve:function(){for(var e="",t=!1,s=arguments.length-1;s>=-1&&!t;s--){var i=s>=0?arguments[s]:Ke.cwd();if("string"!=typeof i)throw new TypeError("Arguments to path.resolve must be strings");if(!i)return "";e=i+"/"+e,t="/"===i.charAt(0);}return e=Ue.normalizeArray(e.split("/").filter((function(e){return !!e})),!t).join("/"),(t?"/":"")+e||"."},relative:function(e,t){function s(e){for(var t=0;t<e.length&&""===e[t];t++);for(var s=e.length-1;s>=0&&""===e[s];s--);return t>s?[]:e.slice(t,s-t+1)}e=ze.resolve(e).substr(1),t=ze.resolve(t).substr(1);for(var i=s(e.split("/")),r=s(t.split("/")),o=Math.min(i.length,r.length),n=o,a=0;a<o;a++)if(i[a]!==r[a]){n=a;break}var h=[];for(a=n;a<i.length;a++)h.push("..");return (h=h.concat(r.slice(n))).join("/")}},We={ttys:[],init:function(){},shutdown:function(){},register:function(e,t){We.ttys[e]={input:[],output:[],ops:t},Ke.registerDevice(e,We.stream_ops);},stream_ops:{open:function(e){var t=We.ttys[e.node.rdev];if(!t)throw new Ke.ErrnoError(43);e.tty=t,e.seekable=!1;},close:function(e){e.tty.ops.flush(e.tty);},flush:function(e){e.tty.ops.flush(e.tty);},read:function(e,t,s,i,r){if(!e.tty||!e.tty.ops.get_char)throw new Ke.ErrnoError(60);for(var o=0,n=0;n<i;n++){var a;try{a=e.tty.ops.get_char(e.tty);}catch(e){throw new Ke.ErrnoError(29)}if(void 0===a&&0===o)throw new Ke.ErrnoError(6);if(null==a)break;o++,t[s+n]=a;}return o&&(e.node.timestamp=Date.now()),o},write:function(e,t,s,i,r){if(!e.tty||!e.tty.ops.put_char)throw new Ke.ErrnoError(60);try{for(var o=0;o<i;o++)e.tty.ops.put_char(e.tty,t[s+o]);}catch(e){throw new Ke.ErrnoError(29)}return i&&(e.node.timestamp=Date.now()),o}},default_tty_ops:{get_char:function(e){if(!e.input.length){var t=null;if(g){var s=Buffer.alloc?Buffer.alloc(256):new Buffer(256),i=0;try{i=T.readSync(process.stdin.fd,s,0,256,null);}catch(e){if(-1==e.toString().indexOf("EOF"))throw e;i=0;}t=i>0?s.slice(0,i).toString("utf-8"):null;}else "undefined"!=typeof window&&"function"==typeof window.prompt?null!==(t=window.prompt("Input: "))&&(t+="\n"):"function"==typeof readline&&null!==(t=readline())&&(t+="\n");if(!t)return null;e.input=ei(t,!0);}return e.input.shift()},put_char:function(e,t){null===t||10===t?(E(Y(e.output,0)),e.output=[]):0!=t&&e.output.push(t);},flush:function(e){e.output&&e.output.length>0&&(E(Y(e.output,0)),e.output=[]);}},default_tty1_ops:{put_char:function(e,t){null===t||10===t?(S(Y(e.output,0)),e.output=[]):0!=t&&e.output.push(t);},flush:function(e){e.output&&e.output.length>0&&(S(Y(e.output,0)),e.output=[]);}}};function Xe(e){for(var s=function(e,t){return t||(t=16),Math.ceil(e/t)*t}(e,16384),i=ii(s);e<s;)t()[i+e++]=0;return i}var Ye={ops_table:null,mount:function(e){return Ye.createNode(null,"/",16895,0)},createNode:function(e,t,s,i){if(Ke.isBlkdev(s)||Ke.isFIFO(s))throw new Ke.ErrnoError(63);Ye.ops_table||(Ye.ops_table={dir:{node:{getattr:Ye.node_ops.getattr,setattr:Ye.node_ops.setattr,lookup:Ye.node_ops.lookup,mknod:Ye.node_ops.mknod,rename:Ye.node_ops.rename,unlink:Ye.node_ops.unlink,rmdir:Ye.node_ops.rmdir,readdir:Ye.node_ops.readdir,symlink:Ye.node_ops.symlink},stream:{llseek:Ye.stream_ops.llseek}},file:{node:{getattr:Ye.node_ops.getattr,setattr:Ye.node_ops.setattr},stream:{llseek:Ye.stream_ops.llseek,read:Ye.stream_ops.read,write:Ye.stream_ops.write,allocate:Ye.stream_ops.allocate,mmap:Ye.stream_ops.mmap,msync:Ye.stream_ops.msync}},link:{node:{getattr:Ye.node_ops.getattr,setattr:Ye.node_ops.setattr,readlink:Ye.node_ops.readlink},stream:{}},chrdev:{node:{getattr:Ye.node_ops.getattr,setattr:Ye.node_ops.setattr},stream:Ke.chrdev_stream_ops}});var r=Ke.createNode(e,t,s,i);return Ke.isDir(r.mode)?(r.node_ops=Ye.ops_table.dir.node,r.stream_ops=Ye.ops_table.dir.stream,r.contents={}):Ke.isFile(r.mode)?(r.node_ops=Ye.ops_table.file.node,r.stream_ops=Ye.ops_table.file.stream,r.usedBytes=0,r.contents=null):Ke.isLink(r.mode)?(r.node_ops=Ye.ops_table.link.node,r.stream_ops=Ye.ops_table.link.stream):Ke.isChrdev(r.mode)&&(r.node_ops=Ye.ops_table.chrdev.node,r.stream_ops=Ye.ops_table.chrdev.stream),r.timestamp=Date.now(),e&&(e.contents[t]=r),r},getFileDataAsRegularArray:function(e){if(e.contents&&e.contents.subarray){for(var t=[],s=0;s<e.usedBytes;++s)t.push(e.contents[s]);return t}return e.contents},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0)},expandFileStorage:function(e,t){t>>>=0;var s=e.contents?e.contents.length:0;if(!(s>=t)){t=Math.max(t,s*(s<1048576?2:1.125)>>>0),0!=s&&(t=Math.max(t,256));var i=e.contents;e.contents=new Uint8Array(t),e.usedBytes>0&&e.contents.set(i.subarray(0,e.usedBytes),0);}},resizeFileStorage:function(e,t){if(t>>>=0,e.usedBytes!=t){if(0==t)return e.contents=null,void(e.usedBytes=0);if(!e.contents||e.contents.subarray){var s=e.contents;return e.contents=new Uint8Array(t),s&&e.contents.set(s.subarray(0,Math.min(t,e.usedBytes))),void(e.usedBytes=t)}if(e.contents||(e.contents=[]),e.contents.length>t)e.contents.length=t;else for(;e.contents.length<t;)e.contents.push(0);e.usedBytes=t;}},node_ops:{getattr:function(e){var t={};return t.dev=Ke.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,Ke.isDir(e.mode)?t.size=4096:Ke.isFile(e.mode)?t.size=e.usedBytes:Ke.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr:function(e,t){void 0!==t.mode&&(e.mode=t.mode),void 0!==t.timestamp&&(e.timestamp=t.timestamp),void 0!==t.size&&Ye.resizeFileStorage(e,t.size);},lookup:function(e,t){throw Ke.genericErrors[44]},mknod:function(e,t,s,i){return Ye.createNode(e,t,s,i)},rename:function(e,t,s){if(Ke.isDir(e.mode)){var i;try{i=Ke.lookupNode(t,s);}catch(e){}if(i)for(var r in i.contents)throw new Ke.ErrnoError(55)}delete e.parent.contents[e.name],e.name=s,t.contents[s]=e,e.parent=t;},unlink:function(e,t){delete e.contents[t];},rmdir:function(e,t){var s=Ke.lookupNode(e,t);for(var i in s.contents)throw new Ke.ErrnoError(55);delete e.contents[t];},readdir:function(e){var t=[".",".."];for(var s in e.contents)e.contents.hasOwnProperty(s)&&t.push(s);return t},symlink:function(e,t,s){var i=Ye.createNode(e,t,41471,0);return i.link=s,i},readlink:function(e){if(!Ke.isLink(e.mode))throw new Ke.ErrnoError(28);return e.link}},stream_ops:{read:function(e,t,s,i,r){var o=e.node.contents;if(r>=e.node.usedBytes)return 0;var n=Math.min(e.node.usedBytes-r,i);if(n>8&&o.subarray)t.set(o.subarray(r,r+n),s);else for(var a=0;a<n;a++)t[s+a]=o[r+a];return n},write:function(e,s,i,r,o,n){if(s.buffer===t().buffer&&(n=!1),!r)return 0;var a=e.node;if(a.timestamp=Date.now(),s.subarray&&(!a.contents||a.contents.subarray)){if(n)return a.contents=s.subarray(i,i+r),a.usedBytes=r,r;if(0===a.usedBytes&&0===o)return a.contents=s.slice(i,i+r),a.usedBytes=r,r;if(o+r<=a.usedBytes)return a.contents.set(s.subarray(i,i+r),o),r}if(Ye.expandFileStorage(a,o+r),a.contents.subarray&&s.subarray)a.contents.set(s.subarray(i,i+r),o);else for(var h=0;h<r;h++)a.contents[o+h]=s[i+h];return a.usedBytes=Math.max(a.usedBytes,o+r),r},llseek:function(e,t,s){var i=t;if(1===s?i+=e.position:2===s&&Ke.isFile(e.node.mode)&&(i+=e.node.usedBytes),i<0)throw new Ke.ErrnoError(28);return i},allocate:function(e,t,s){Ye.expandFileStorage(e.node,t+s),e.node.usedBytes=Math.max(e.node.usedBytes,t+s);},mmap:function(e,s,i,r,o,n){if(X(0===s),!Ke.isFile(e.node.mode))throw new Ke.ErrnoError(43);var a,h,l=e.node.contents;if(2&n||l.buffer!==O){if((r>0||r+i<l.length)&&(l=l.subarray?l.subarray(r,r+i):Array.prototype.slice.call(l,r,r+i)),h=!0,!(a=Xe(i)))throw new Ke.ErrnoError(48);a>>>=0,t().set(l,a);}else h=!1,a=l.byteOffset;return {ptr:a,allocated:h}},msync:function(e,t,s,i,r){if(!Ke.isFile(e.node.mode))throw new Ke.ErrnoError(43);return 2&r||Ye.stream_ops.write(e,t,0,i,s,!1),0}}},Ke={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,trackingDelegate:{},tracking:{openFlags:{READ:1,WRITE:2}},ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:function(e,t){if(t=t||{},!(e=ze.resolve(Ke.cwd(),e)))return {path:"",node:null};var s={follow_mount:!0,recurse_count:0};for(var i in s)void 0===t[i]&&(t[i]=s[i]);if(t.recurse_count>8)throw new Ke.ErrnoError(32);for(var r=Ue.normalizeArray(e.split("/").filter((function(e){return !!e})),!1),o=Ke.root,n="/",a=0;a<r.length;a++){var h=a===r.length-1;if(h&&t.parent)break;if(o=Ke.lookupNode(o,r[a]),n=Ue.join2(n,r[a]),Ke.isMountpoint(o)&&(!h||h&&t.follow_mount)&&(o=o.mounted.root),!h||t.follow)for(var l=0;Ke.isLink(o.mode);){var u=Ke.readlink(n);if(n=ze.resolve(Ue.dirname(n),u),o=Ke.lookupPath(n,{recurse_count:t.recurse_count}).node,l++>40)throw new Ke.ErrnoError(32)}}return {path:n,node:o}},getPath:function(e){for(var t;;){if(Ke.isRoot(e)){var s=e.mount.mountpoint;return t?"/"!==s[s.length-1]?s+"/"+t:s+t:s}t=t?e.name+"/"+t:e.name,e=e.parent;}},hashName:function(e,t){for(var s=0,i=0;i<t.length;i++)s=(s<<5)-s+t.charCodeAt(i)|0;return (e+s>>>0)%Ke.nameTable.length},hashAddNode:function(e){var t=Ke.hashName(e.parent.id,e.name);e.name_next=Ke.nameTable[t],Ke.nameTable[t]=e;},hashRemoveNode:function(e){var t=Ke.hashName(e.parent.id,e.name);if(Ke.nameTable[t]===e)Ke.nameTable[t]=e.name_next;else for(var s=Ke.nameTable[t];s;){if(s.name_next===e){s.name_next=e.name_next;break}s=s.name_next;}},lookupNode:function(e,t){var s=Ke.mayLookup(e);if(s)throw new Ke.ErrnoError(s,e);for(var i=Ke.hashName(e.id,t),r=Ke.nameTable[i];r;r=r.name_next){var o=r.name;if(r.parent.id===e.id&&o===t)return r}return Ke.lookup(e,t)},createNode:function(e,t,s,i){var r=new Ke.FSNode(e,t,s,i);return Ke.hashAddNode(r),r},destroyNode:function(e){Ke.hashRemoveNode(e);},isRoot:function(e){return e===e.parent},isMountpoint:function(e){return !!e.mounted},isFile:function(e){return 32768==(61440&e)},isDir:function(e){return 16384==(61440&e)},isLink:function(e){return 40960==(61440&e)},isChrdev:function(e){return 8192==(61440&e)},isBlkdev:function(e){return 24576==(61440&e)},isFIFO:function(e){return 4096==(61440&e)},isSocket:function(e){return 49152==(49152&e)},flagModes:{r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},modeStringToFlags:function(e){var t=Ke.flagModes[e];if(void 0===t)throw new Error("Unknown file open mode: "+e);return t},flagsToPermissionString:function(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t},nodePermissions:function(e,t){return Ke.ignorePermissions||(-1===t.indexOf("r")||292&e.mode)&&(-1===t.indexOf("w")||146&e.mode)&&(-1===t.indexOf("x")||73&e.mode)?0:2},mayLookup:function(e){var t=Ke.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:2)},mayCreate:function(e,t){try{return Ke.lookupNode(e,t),20}catch(e){}return Ke.nodePermissions(e,"wx")},mayDelete:function(e,t,s){var i;try{i=Ke.lookupNode(e,t);}catch(e){return e.errno}var r=Ke.nodePermissions(e,"wx");if(r)return r;if(s){if(!Ke.isDir(i.mode))return 54;if(Ke.isRoot(i)||Ke.getPath(i)===Ke.cwd())return 10}else if(Ke.isDir(i.mode))return 31;return 0},mayOpen:function(e,t){return e?Ke.isLink(e.mode)?32:Ke.isDir(e.mode)&&("r"!==Ke.flagsToPermissionString(t)||512&t)?31:Ke.nodePermissions(e,Ke.flagsToPermissionString(t)):44},MAX_OPEN_FDS:4096,nextfd:function(e,t){e=e||0,t=t||Ke.MAX_OPEN_FDS;for(var s=e;s<=t;s++)if(!Ke.streams[s])return s;throw new Ke.ErrnoError(33)},getStream:function(e){return Ke.streams[e]},createStream:function(e,t,s){Ke.FSStream||(Ke.FSStream=function(){},Ke.FSStream.prototype={object:{get:function(){return this.node},set:function(e){this.node=e;}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}}});var i=new Ke.FSStream;for(var r in e)i[r]=e[r];e=i;var o=Ke.nextfd(t,s);return e.fd=o,Ke.streams[o]=e,e},closeStream:function(e){Ke.streams[e]=null;},chrdev_stream_ops:{open:function(e){var t=Ke.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open&&e.stream_ops.open(e);},llseek:function(){throw new Ke.ErrnoError(70)}},major:function(e){return e>>8},minor:function(e){return 255&e},makedev:function(e,t){return e<<8|t},registerDevice:function(e,t){Ke.devices[e]={stream_ops:t};},getDevice:function(e){return Ke.devices[e]},getMounts:function(e){for(var t=[],s=[e];s.length;){var i=s.pop();t.push(i),s.push.apply(s,i.mounts);}return t},syncfs:function(e,t){"function"==typeof e&&(t=e,e=!1),Ke.syncFSRequests++,Ke.syncFSRequests>1&&S("warning: "+Ke.syncFSRequests+" FS.syncfs operations in flight at once, probably just doing extra work");var s=Ke.getMounts(Ke.root.mount),i=0;function r(e){return Ke.syncFSRequests--,t(e)}function o(e){if(e)return o.errored?void 0:(o.errored=!0,r(e));++i>=s.length&&r(null);}s.forEach((function(t){if(!t.type.syncfs)return o(null);t.type.syncfs(t,e,o);}));},mount:function(e,t,s){var i,r="/"===s,o=!s;if(r&&Ke.root)throw new Ke.ErrnoError(10);if(!r&&!o){var n=Ke.lookupPath(s,{follow_mount:!1});if(s=n.path,i=n.node,Ke.isMountpoint(i))throw new Ke.ErrnoError(10);if(!Ke.isDir(i.mode))throw new Ke.ErrnoError(54)}var a={type:e,opts:t,mountpoint:s,mounts:[]},h=e.mount(a);return h.mount=a,a.root=h,r?Ke.root=h:i&&(i.mounted=a,i.mount&&i.mount.mounts.push(a)),h},unmount:function(e){var t=Ke.lookupPath(e,{follow_mount:!1});if(!Ke.isMountpoint(t.node))throw new Ke.ErrnoError(28);var s=t.node,i=s.mounted,r=Ke.getMounts(i);Object.keys(Ke.nameTable).forEach((function(e){for(var t=Ke.nameTable[e];t;){var s=t.name_next;-1!==r.indexOf(t.mount)&&Ke.destroyNode(t),t=s;}})),s.mounted=null;var o=s.mount.mounts.indexOf(i);s.mount.mounts.splice(o,1);},lookup:function(e,t){return e.node_ops.lookup(e,t)},mknod:function(e,t,s){var i=Ke.lookupPath(e,{parent:!0}).node,r=Ue.basename(e);if(!r||"."===r||".."===r)throw new Ke.ErrnoError(28);var o=Ke.mayCreate(i,r);if(o)throw new Ke.ErrnoError(o);if(!i.node_ops.mknod)throw new Ke.ErrnoError(63);return i.node_ops.mknod(i,r,t,s)},create:function(e,t){return t=void 0!==t?t:438,t&=4095,t|=32768,Ke.mknod(e,t,0)},mkdir:function(e,t){return t=void 0!==t?t:511,t&=1023,t|=16384,Ke.mknod(e,t,0)},mkdirTree:function(e,t){for(var s=e.split("/"),i="",r=0;r<s.length;++r)if(s[r]){i+="/"+s[r];try{Ke.mkdir(i,t);}catch(e){if(20!=e.errno)throw e}}},mkdev:function(e,t,s){return void 0===s&&(s=t,t=438),t|=8192,Ke.mknod(e,t,s)},symlink:function(e,t){if(!ze.resolve(e))throw new Ke.ErrnoError(44);var s=Ke.lookupPath(t,{parent:!0}).node;if(!s)throw new Ke.ErrnoError(44);var i=Ue.basename(t),r=Ke.mayCreate(s,i);if(r)throw new Ke.ErrnoError(r);if(!s.node_ops.symlink)throw new Ke.ErrnoError(63);return s.node_ops.symlink(s,i,e)},rename:function(e,t){var s,i,r=Ue.dirname(e),o=Ue.dirname(t),n=Ue.basename(e),a=Ue.basename(t);if(s=Ke.lookupPath(e,{parent:!0}).node,i=Ke.lookupPath(t,{parent:!0}).node,!s||!i)throw new Ke.ErrnoError(44);if(s.mount!==i.mount)throw new Ke.ErrnoError(75);var h,l=Ke.lookupNode(s,n),u=ze.relative(e,o);if("."!==u.charAt(0))throw new Ke.ErrnoError(28);if("."!==(u=ze.relative(t,r)).charAt(0))throw new Ke.ErrnoError(55);try{h=Ke.lookupNode(i,a);}catch(e){}if(l!==h){var c=Ke.isDir(l.mode),p=Ke.mayDelete(s,n,c);if(p)throw new Ke.ErrnoError(p);if(p=h?Ke.mayDelete(i,a,c):Ke.mayCreate(i,a))throw new Ke.ErrnoError(p);if(!s.node_ops.rename)throw new Ke.ErrnoError(63);if(Ke.isMountpoint(l)||h&&Ke.isMountpoint(h))throw new Ke.ErrnoError(10);if(i!==s&&(p=Ke.nodePermissions(s,"w")))throw new Ke.ErrnoError(p);try{Ke.trackingDelegate.willMovePath&&Ke.trackingDelegate.willMovePath(e,t);}catch(s){S("FS.trackingDelegate['willMovePath']('"+e+"', '"+t+"') threw an exception: "+s.message);}Ke.hashRemoveNode(l);try{s.node_ops.rename(l,i,a);}catch(e){throw e}finally{Ke.hashAddNode(l);}try{Ke.trackingDelegate.onMovePath&&Ke.trackingDelegate.onMovePath(e,t);}catch(s){S("FS.trackingDelegate['onMovePath']('"+e+"', '"+t+"') threw an exception: "+s.message);}}},rmdir:function(e){var t=Ke.lookupPath(e,{parent:!0}).node,s=Ue.basename(e),i=Ke.lookupNode(t,s),r=Ke.mayDelete(t,s,!0);if(r)throw new Ke.ErrnoError(r);if(!t.node_ops.rmdir)throw new Ke.ErrnoError(63);if(Ke.isMountpoint(i))throw new Ke.ErrnoError(10);try{Ke.trackingDelegate.willDeletePath&&Ke.trackingDelegate.willDeletePath(e);}catch(t){S("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message);}t.node_ops.rmdir(t,s),Ke.destroyNode(i);try{Ke.trackingDelegate.onDeletePath&&Ke.trackingDelegate.onDeletePath(e);}catch(t){S("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message);}},readdir:function(e){var t=Ke.lookupPath(e,{follow:!0}).node;if(!t.node_ops.readdir)throw new Ke.ErrnoError(54);return t.node_ops.readdir(t)},unlink:function(e){var t=Ke.lookupPath(e,{parent:!0}).node,s=Ue.basename(e),i=Ke.lookupNode(t,s),r=Ke.mayDelete(t,s,!1);if(r)throw new Ke.ErrnoError(r);if(!t.node_ops.unlink)throw new Ke.ErrnoError(63);if(Ke.isMountpoint(i))throw new Ke.ErrnoError(10);try{Ke.trackingDelegate.willDeletePath&&Ke.trackingDelegate.willDeletePath(e);}catch(t){S("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message);}t.node_ops.unlink(t,s),Ke.destroyNode(i);try{Ke.trackingDelegate.onDeletePath&&Ke.trackingDelegate.onDeletePath(e);}catch(t){S("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message);}},readlink:function(e){var t=Ke.lookupPath(e).node;if(!t)throw new Ke.ErrnoError(44);if(!t.node_ops.readlink)throw new Ke.ErrnoError(28);return ze.resolve(Ke.getPath(t.parent),t.node_ops.readlink(t))},stat:function(e,t){var s=Ke.lookupPath(e,{follow:!t}).node;if(!s)throw new Ke.ErrnoError(44);if(!s.node_ops.getattr)throw new Ke.ErrnoError(63);return s.node_ops.getattr(s)},lstat:function(e){return Ke.stat(e,!0)},chmod:function(e,t,s){var i;if(!(i="string"==typeof e?Ke.lookupPath(e,{follow:!s}).node:e).node_ops.setattr)throw new Ke.ErrnoError(63);i.node_ops.setattr(i,{mode:4095&t|-4096&i.mode,timestamp:Date.now()});},lchmod:function(e,t){Ke.chmod(e,t,!0);},fchmod:function(e,t){var s=Ke.getStream(e);if(!s)throw new Ke.ErrnoError(8);Ke.chmod(s.node,t);},chown:function(e,t,s,i){var r;if(!(r="string"==typeof e?Ke.lookupPath(e,{follow:!i}).node:e).node_ops.setattr)throw new Ke.ErrnoError(63);r.node_ops.setattr(r,{timestamp:Date.now()});},lchown:function(e,t,s){Ke.chown(e,t,s,!0);},fchown:function(e,t,s){var i=Ke.getStream(e);if(!i)throw new Ke.ErrnoError(8);Ke.chown(i.node,t,s);},truncate:function(e,t){if(t<0)throw new Ke.ErrnoError(28);var s;if(!(s="string"==typeof e?Ke.lookupPath(e,{follow:!0}).node:e).node_ops.setattr)throw new Ke.ErrnoError(63);if(Ke.isDir(s.mode))throw new Ke.ErrnoError(31);if(!Ke.isFile(s.mode))throw new Ke.ErrnoError(28);var i=Ke.nodePermissions(s,"w");if(i)throw new Ke.ErrnoError(i);s.node_ops.setattr(s,{size:t,timestamp:Date.now()});},ftruncate:function(e,t){var s=Ke.getStream(e);if(!s)throw new Ke.ErrnoError(8);if(0==(2097155&s.flags))throw new Ke.ErrnoError(28);Ke.truncate(s.node,t);},utime:function(e,t,s){var i=Ke.lookupPath(e,{follow:!0}).node;i.node_ops.setattr(i,{timestamp:Math.max(t,s)});},open:function(e,t,s,i,r){if(""===e)throw new Ke.ErrnoError(44);var o;if(s=void 0===s?438:s,s=64&(t="string"==typeof t?Ke.modeStringToFlags(t):t)?4095&s|32768:0,"object"==typeof e)o=e;else {e=Ue.normalize(e);try{o=Ke.lookupPath(e,{follow:!(131072&t)}).node;}catch(e){}}var n=!1;if(64&t)if(o){if(128&t)throw new Ke.ErrnoError(20)}else o=Ke.mknod(e,s,0),n=!0;if(!o)throw new Ke.ErrnoError(44);if(Ke.isChrdev(o.mode)&&(t&=-513),65536&t&&!Ke.isDir(o.mode))throw new Ke.ErrnoError(54);if(!n){var a=Ke.mayOpen(o,t);if(a)throw new Ke.ErrnoError(a)}512&t&&Ke.truncate(o,0),t&=-131713;var h=Ke.createStream({node:o,path:Ke.getPath(o),flags:t,seekable:!0,position:0,stream_ops:o.stream_ops,ungotten:[],error:!1},i,r);h.stream_ops.open&&h.stream_ops.open(h),!c.logReadFiles||1&t||(Ke.readFiles||(Ke.readFiles={}),e in Ke.readFiles||(Ke.readFiles[e]=1,S("FS.trackingDelegate error on read file: "+e)));try{if(Ke.trackingDelegate.onOpenFile){var l=0;1!=(2097155&t)&&(l|=Ke.tracking.openFlags.READ),0!=(2097155&t)&&(l|=Ke.tracking.openFlags.WRITE),Ke.trackingDelegate.onOpenFile(e,l);}}catch(t){S("FS.trackingDelegate['onOpenFile']('"+e+"', flags) threw an exception: "+t.message);}return h},close:function(e){if(Ke.isClosed(e))throw new Ke.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e);}catch(e){throw e}finally{Ke.closeStream(e.fd);}e.fd=null;},isClosed:function(e){return null===e.fd},llseek:function(e,t,s){if(Ke.isClosed(e))throw new Ke.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new Ke.ErrnoError(70);if(0!=s&&1!=s&&2!=s)throw new Ke.ErrnoError(28);return e.position=e.stream_ops.llseek(e,t,s),e.ungotten=[],e.position},read:function(e,t,s,i,r){if(s>>>=0,i<0||r<0)throw new Ke.ErrnoError(28);if(Ke.isClosed(e))throw new Ke.ErrnoError(8);if(1==(2097155&e.flags))throw new Ke.ErrnoError(8);if(Ke.isDir(e.node.mode))throw new Ke.ErrnoError(31);if(!e.stream_ops.read)throw new Ke.ErrnoError(28);var o=void 0!==r;if(o){if(!e.seekable)throw new Ke.ErrnoError(70)}else r=e.position;var n=e.stream_ops.read(e,t,s,i,r);return o||(e.position+=n),n},write:function(e,t,s,i,r,o){if(s>>>=0,i<0||r<0)throw new Ke.ErrnoError(28);if(Ke.isClosed(e))throw new Ke.ErrnoError(8);if(0==(2097155&e.flags))throw new Ke.ErrnoError(8);if(Ke.isDir(e.node.mode))throw new Ke.ErrnoError(31);if(!e.stream_ops.write)throw new Ke.ErrnoError(28);e.seekable&&1024&e.flags&&Ke.llseek(e,0,2);var n=void 0!==r;if(n){if(!e.seekable)throw new Ke.ErrnoError(70)}else r=e.position;var a=e.stream_ops.write(e,t,s,i,r,o);n||(e.position+=a);try{e.path&&Ke.trackingDelegate.onWriteToFile&&Ke.trackingDelegate.onWriteToFile(e.path);}catch(t){S("FS.trackingDelegate['onWriteToFile']('"+e.path+"') threw an exception: "+t.message);}return a},allocate:function(e,t,s){if(Ke.isClosed(e))throw new Ke.ErrnoError(8);if(t<0||s<=0)throw new Ke.ErrnoError(28);if(0==(2097155&e.flags))throw new Ke.ErrnoError(8);if(!Ke.isFile(e.node.mode)&&!Ke.isDir(e.node.mode))throw new Ke.ErrnoError(43);if(!e.stream_ops.allocate)throw new Ke.ErrnoError(138);e.stream_ops.allocate(e,t,s);},mmap:function(e,t,s,i,r,o){if(t>>>=0,0!=(2&r)&&0==(2&o)&&2!=(2097155&e.flags))throw new Ke.ErrnoError(2);if(1==(2097155&e.flags))throw new Ke.ErrnoError(2);if(!e.stream_ops.mmap)throw new Ke.ErrnoError(43);return e.stream_ops.mmap(e,t,s,i,r,o)},msync:function(e,t,s,i,r){return s>>>=0,e&&e.stream_ops.msync?e.stream_ops.msync(e,t,s,i,r):0},munmap:function(e){return 0},ioctl:function(e,t,s){if(!e.stream_ops.ioctl)throw new Ke.ErrnoError(59);return e.stream_ops.ioctl(e,t,s)},readFile:function(e,t){if((t=t||{}).flags=t.flags||0,t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error('Invalid encoding type "'+t.encoding+'"');var s,i=Ke.open(e,t.flags),r=Ke.stat(e).size,o=new Uint8Array(r);return Ke.read(i,o,0,r,0),"utf8"===t.encoding?s=Y(o,0):"binary"===t.encoding&&(s=o),Ke.close(i),s},writeFile:function(e,t,s){(s=s||{}).flags=s.flags||577;var i=Ke.open(e,s.flags,s.mode);if("string"==typeof t){var r=new Uint8Array(Q(t)+1),o=J(t,r,0,r.length);Ke.write(i,r,0,o,void 0,s.canOwn);}else {if(!ArrayBuffer.isView(t))throw new Error("Unsupported data type");Ke.write(i,t,0,t.byteLength,void 0,s.canOwn);}Ke.close(i);},cwd:function(){return Ke.currentPath},chdir:function(e){var t=Ke.lookupPath(e,{follow:!0});if(null===t.node)throw new Ke.ErrnoError(44);if(!Ke.isDir(t.node.mode))throw new Ke.ErrnoError(54);var s=Ke.nodePermissions(t.node,"x");if(s)throw new Ke.ErrnoError(s);Ke.currentPath=t.path;},createDefaultDirectories:function(){Ke.mkdir("/tmp"),Ke.mkdir("/home"),Ke.mkdir("/home/web_user");},createDefaultDevices:function(){Ke.mkdir("/dev"),Ke.registerDevice(Ke.makedev(1,3),{read:function(){return 0},write:function(e,t,s,i,r){return i}}),Ke.mkdev("/dev/null",Ke.makedev(1,3)),We.register(Ke.makedev(5,0),We.default_tty_ops),We.register(Ke.makedev(6,0),We.default_tty1_ops),Ke.mkdev("/dev/tty",Ke.makedev(5,0)),Ke.mkdev("/dev/tty1",Ke.makedev(6,0));var e=function(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues){var e=new Uint8Array(1);return function(){return crypto.getRandomValues(e),e[0]}}if(g)try{var t=x_();return function(){return t.randomBytes(1)[0]}}catch(e){}return function(){ge("randomDevice");}}();Ke.createDevice("/dev","random",e),Ke.createDevice("/dev","urandom",e),Ke.mkdir("/dev/shm"),Ke.mkdir("/dev/shm/tmp");},createSpecialDirectories:function(){Ke.mkdir("/proc"),Ke.mkdir("/proc/self"),Ke.mkdir("/proc/self/fd"),Ke.mount({mount:function(){var e=Ke.createNode("/proc/self","fd",16895,73);return e.node_ops={lookup:function(e,t){var s=+t,i=Ke.getStream(s);if(!i)throw new Ke.ErrnoError(8);var r={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:function(){return i.path}}};return r.parent=r,r}},e}},{},"/proc/self/fd");},createStandardStreams:function(){c.stdin?Ke.createDevice("/dev","stdin",c.stdin):Ke.symlink("/dev/tty","/dev/stdin"),c.stdout?Ke.createDevice("/dev","stdout",null,c.stdout):Ke.symlink("/dev/tty","/dev/stdout"),c.stderr?Ke.createDevice("/dev","stderr",null,c.stderr):Ke.symlink("/dev/tty1","/dev/stderr"),Ke.open("/dev/stdin",0),Ke.open("/dev/stdout",1),Ke.open("/dev/stderr",1);},ensureErrnoError:function(){Ke.ErrnoError||(Ke.ErrnoError=function(e,t){this.node=t,this.setErrno=function(e){this.errno=e;},this.setErrno(e),this.message="FS error";},Ke.ErrnoError.prototype=new Error,Ke.ErrnoError.prototype.constructor=Ke.ErrnoError,[44].forEach((function(e){Ke.genericErrors[e]=new Ke.ErrnoError(e),Ke.genericErrors[e].stack="<generic error, no stack>";})));},staticInit:function(){Ke.ensureErrnoError(),Ke.nameTable=new Array(4096),Ke.mount(Ye,{},"/"),Ke.createDefaultDirectories(),Ke.createDefaultDevices(),Ke.createSpecialDirectories(),Ke.filesystems={MEMFS:Ye};},init:function(e,t,s){Ke.init.initialized=!0,Ke.ensureErrnoError(),c.stdin=e||c.stdin,c.stdout=t||c.stdout,c.stderr=s||c.stderr,Ke.createStandardStreams();},quit:function(){Ke.init.initialized=!1;var e=c._fflush;e&&e(0);for(var t=0;t<Ke.streams.length;t++){var s=Ke.streams[t];s&&Ke.close(s);}},getMode:function(e,t){var s=0;return e&&(s|=365),t&&(s|=146),s},findObject:function(e,t){var s=Ke.analyzePath(e,t);return s.exists?s.object:null},analyzePath:function(e,t){try{e=(i=Ke.lookupPath(e,{follow:!t})).path;}catch(e){}var s={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var i=Ke.lookupPath(e,{parent:!0});s.parentExists=!0,s.parentPath=i.path,s.parentObject=i.node,s.name=Ue.basename(e),i=Ke.lookupPath(e,{follow:!t}),s.exists=!0,s.path=i.path,s.object=i.node,s.name=i.node.name,s.isRoot="/"===i.path;}catch(e){s.error=e.errno;}return s},createPath:function(e,t,s,i){e="string"==typeof e?e:Ke.getPath(e);for(var r=t.split("/").reverse();r.length;){var o=r.pop();if(o){var n=Ue.join2(e,o);try{Ke.mkdir(n);}catch(e){}e=n;}}return n},createFile:function(e,t,s,i,r){var o=Ue.join2("string"==typeof e?e:Ke.getPath(e),t),n=Ke.getMode(i,r);return Ke.create(o,n)},createDataFile:function(e,t,s,i,r,o){var n=t?Ue.join2("string"==typeof e?e:Ke.getPath(e),t):e,a=Ke.getMode(i,r),h=Ke.create(n,a);if(s){if("string"==typeof s){for(var l=new Array(s.length),u=0,c=s.length;u<c;++u)l[u]=s.charCodeAt(u);s=l;}Ke.chmod(h,146|a);var p=Ke.open(h,577);Ke.write(p,s,0,s.length,0,o),Ke.close(p),Ke.chmod(h,a);}return h},createDevice:function(e,t,s,i){var r=Ue.join2("string"==typeof e?e:Ke.getPath(e),t),o=Ke.getMode(!!s,!!i);Ke.createDevice.major||(Ke.createDevice.major=64);var n=Ke.makedev(Ke.createDevice.major++,0);return Ke.registerDevice(n,{open:function(e){e.seekable=!1;},close:function(e){i&&i.buffer&&i.buffer.length&&i(10);},read:function(e,t,i,r,o){for(var n=0,a=0;a<r;a++){var h;try{h=s();}catch(e){throw new Ke.ErrnoError(29)}if(void 0===h&&0===n)throw new Ke.ErrnoError(6);if(null==h)break;n++,t[i+a]=h;}return n&&(e.node.timestamp=Date.now()),n},write:function(e,t,s,r,o){for(var n=0;n<r;n++)try{i(t[s+n]);}catch(e){throw new Ke.ErrnoError(29)}return r&&(e.node.timestamp=Date.now()),n}}),Ke.mkdev(r,o,n)},forceLoadFile:function(e){if(e.isDevice||e.isFolder||e.link||e.contents)return !0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!w)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=ei(w(e.url),!0),e.usedBytes=e.contents.length;}catch(e){throw new Ke.ErrnoError(29)}},createLazyFile:function(e,t,s,i,r){function o(){this.lengthKnown=!1,this.chunks=[];}if(o.prototype.get=function(e){if(!(e>this.length-1||e<0)){var t=e%this.chunkSize,s=e/this.chunkSize|0;return this.getter(s)[t]}},o.prototype.setDataGetter=function(e){this.getter=e;},o.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",s,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+s+". Status: "+e.status);var t,i=Number(e.getResponseHeader("Content-length")),r=(t=e.getResponseHeader("Accept-Ranges"))&&"bytes"===t,o=(t=e.getResponseHeader("Content-Encoding"))&&"gzip"===t,n=1048576;r||(n=i);var a=this;a.setDataGetter((function(e){var t=e*n,r=(e+1)*n-1;if(r=Math.min(r,i-1),void 0===a.chunks[e]&&(a.chunks[e]=function(e,t){if(e>t)throw new Error("invalid range ("+e+", "+t+") or no bytes requested!");if(t>i-1)throw new Error("only "+i+" bytes available! programmer error!");var r=new XMLHttpRequest;if(r.open("GET",s,!1),i!==n&&r.setRequestHeader("Range","bytes="+e+"-"+t),"undefined"!=typeof Uint8Array&&(r.responseType="arraybuffer"),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),!(r.status>=200&&r.status<300||304===r.status))throw new Error("Couldn't load "+s+". Status: "+r.status);return void 0!==r.response?new Uint8Array(r.response||[]):ei(r.responseText||"",!0)}(t,r)),void 0===a.chunks[e])throw new Error("doXHR failed!");return a.chunks[e]})),!o&&i||(n=i=1,i=this.getter(0).length,n=i,E("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=i,this._chunkSize=n,this.lengthKnown=!0;},"undefined"!=typeof XMLHttpRequest){if(!m)throw "Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var n=new o;Object.defineProperties(n,{length:{get:function(){return this.lengthKnown||this.cacheLength(),this._length}},chunkSize:{get:function(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}});var a={isDevice:!1,contents:n};}else a={isDevice:!1,url:s};var h=Ke.createFile(e,t,a,i,r);a.contents?h.contents=a.contents:a.url&&(h.contents=null,h.url=a.url),Object.defineProperties(h,{usedBytes:{get:function(){return this.contents.length}}});var l={};return Object.keys(h.stream_ops).forEach((function(e){var t=h.stream_ops[e];l[e]=function(){return Ke.forceLoadFile(h),t.apply(null,arguments)};})),l.read=function(e,t,s,i,r){Ke.forceLoadFile(h);var o=e.node.contents;if(r>=o.length)return 0;var n=Math.min(o.length-r,i);if(o.slice)for(var a=0;a<n;a++)t[s+a]=o[r+a];else for(a=0;a<n;a++)t[s+a]=o.get(r+a);return n},h.stream_ops=l,h},createPreloadedFile:function(e,t,s,i,r,o,n,a,h,l){Browser.init();var u=t?ze.resolve(Ue.join2(e,t)):e;function p(s){function p(s){l&&l(),a||Ke.createDataFile(e,t,s,i,r,h),o&&o(),me();}var d=!1;c.preloadPlugins.forEach((function(e){d||e.canHandle(u)&&(e.handle(s,u,p,(function(){n&&n(),me();})),d=!0);})),d||p(s);}fe(),"string"==typeof s?Browser.asyncLoad(s,(function(e){p(e);}),n):p(s);},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return "EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(e,t,s){t=t||function(){},s=s||function(){};var i=Ke.indexedDB();try{var r=i.open(Ke.DB_NAME(),Ke.DB_VERSION);}catch(e){return s(e)}r.onupgradeneeded=function(){E("creating db"),r.result.createObjectStore(Ke.DB_STORE_NAME);},r.onsuccess=function(){var i=r.result.transaction([Ke.DB_STORE_NAME],"readwrite"),o=i.objectStore(Ke.DB_STORE_NAME),n=0,a=0,h=e.length;function l(){0==a?t():s();}e.forEach((function(e){var t=o.put(Ke.analyzePath(e).object.contents,e);t.onsuccess=function(){++n+a==h&&l();},t.onerror=function(){a++,n+a==h&&l();};})),i.onerror=s;},r.onerror=s;},loadFilesFromDB:function(e,t,s){t=t||function(){},s=s||function(){};var i=Ke.indexedDB();try{var r=i.open(Ke.DB_NAME(),Ke.DB_VERSION);}catch(e){return s(e)}r.onupgradeneeded=s,r.onsuccess=function(){var i=r.result;try{var o=i.transaction([Ke.DB_STORE_NAME],"readonly");}catch(e){return void s(e)}var n=o.objectStore(Ke.DB_STORE_NAME),a=0,h=0,l=e.length;function u(){0==h?t():s();}e.forEach((function(e){var t=n.get(e);t.onsuccess=function(){Ke.analyzePath(e).exists&&Ke.unlink(e),Ke.createDataFile(Ue.dirname(e),Ue.basename(e),t.result,!0,!0,!0),++a+h==l&&u();},t.onerror=function(){h++,a+h==l&&u();};})),o.onerror=s;},r.onerror=s;}},Je={mappings:{},DEFAULT_POLLMASK:5,umask:511,calculateAt:function(e,t){if("/"!==t[0]){var s;if(-100===e)s=Ke.cwd();else {var i=Ke.getStream(e);if(!i)throw new Ke.ErrnoError(8);s=i.path;}t=Ue.join2(s,t);}return t},doStat:function(e,t,s){try{var i=e(t);}catch(e){if(e&&e.node&&Ue.normalize(t)!==Ue.normalize(Ke.getPath(e.node)))return -54;throw e}return n()[s>>2]=i.dev,n()[s+4>>2]=0,n()[s+8>>2]=i.ino,n()[s+12>>2]=i.mode,n()[s+16>>2]=i.nlink,n()[s+20>>2]=i.uid,n()[s+24>>2]=i.gid,n()[s+28>>2]=i.rdev,n()[s+32>>2]=0,we=[i.size>>>0,(be=i.size,+Math.abs(be)>=1?be>0?(0|Math.min(+Math.floor(be/4294967296),4294967295))>>>0:~~+Math.ceil((be-+(~~be>>>0))/4294967296)>>>0:0)],n()[s+40>>2]=we[0],n()[s+44>>2]=we[1],n()[s+48>>2]=4096,n()[s+52>>2]=i.blocks,n()[s+56>>2]=i.atime.getTime()/1e3|0,n()[s+60>>2]=0,n()[s+64>>2]=i.mtime.getTime()/1e3|0,n()[s+68>>2]=0,n()[s+72>>2]=i.ctime.getTime()/1e3|0,n()[s+76>>2]=0,we=[i.ino>>>0,(be=i.ino,+Math.abs(be)>=1?be>0?(0|Math.min(+Math.floor(be/4294967296),4294967295))>>>0:~~+Math.ceil((be-+(~~be>>>0))/4294967296)>>>0:0)],n()[s+80>>2]=we[0],n()[s+84>>2]=we[1],0},doMsync:function(e,t,s,r,o){var n=i().slice(e,e+s);Ke.msync(t,n,o,s,r);},doMkdir:function(e,t){return "/"===(e=Ue.normalize(e))[e.length-1]&&(e=e.substr(0,e.length-1)),Ke.mkdir(e,t,0),0},doMknod:function(e,t,s){switch(61440&t){case 32768:case 8192:case 24576:case 4096:case 49152:break;default:return -28}return Ke.mknod(e,t,s),0},doReadlink:function(e,s,i){if(i<=0)return -28;var r=Ke.readlink(e),o=Math.min(i,Q(r)),n=t()[s+o];return Z(r,s,i+1),t()[s+o]=n,o},doAccess:function(e,t){if(-8&t)return -28;var s;if(!(s=Ke.lookupPath(e,{follow:!0}).node))return -44;var i="";return 4&t&&(i+="r"),2&t&&(i+="w"),1&t&&(i+="x"),i&&Ke.nodePermissions(s,i)?-2:0},doDup:function(e,t,s){var i=Ke.getStream(s);return i&&Ke.close(i),Ke.open(e,t,0,s,s).fd},doReadv:function(e,s,i,r){for(var o=0,a=0;a<i;a++){var h=n()[s+8*a>>2],l=n()[s+(8*a+4)>>2],u=Ke.read(e,t(),h,l,r);if(u<0)return -1;if(o+=u,u<l)break}return o},doWritev:function(e,s,i,r){for(var o=0,a=0;a<i;a++){var h=n()[s+8*a>>2],l=n()[s+(8*a+4)>>2],u=Ke.write(e,t(),h,l,r);if(u<0)return -1;o+=u;}return o},varargs:void 0,get:function(){return Je.varargs+=4,n()[Je.varargs-4>>2]},getStr:function(e){return K(e)},getStreamFromFD:function(e){var t=Ke.getStream(e);if(!t)throw new Ke.ErrnoError(8);return t},get64:function(e,t){return e}};function Ze(e,t,s){if(b)return bs(2,1,e,t,s);Je.varargs=s;try{var i=Je.getStreamFromFD(e);switch(t){case 21509:case 21505:case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:case 21523:case 21524:return i.tty?0:-59;case 21519:if(!i.tty)return -59;var r=Je.get();return n()[r>>2]=0,0;case 21520:return i.tty?-28:-59;case 21531:return r=Je.get(),Ke.ioctl(i,t,r);default:ge("bad ioctl syscall "+t);}}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),-e.errno}}function Qe(e,t,s){if(b)return bs(3,1,e,t,s);Je.varargs=s;try{var i=Je.getStr(e),r=Je.get();return Ke.open(i,t,r).fd}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),-e.errno}}var qe={};function $e(e){for(;e.length;){var t=e.pop();e.pop()(t);}}function et(e){return this.fromWireType(a()[e>>2])}var tt={},st={},it={};function rt(e){if(void 0===e)return "_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function ot(e,t){return e=rt(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function nt(e,t){var s=ot(t,(function(e){this.name=t,this.message=e;var s=new Error(e).stack;void 0!==s&&(this.stack=this.toString()+"\n"+s.replace(/^Error(:[^\n]*)?\n/,""));}));return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},s}var at=void 0;function ht(e){throw new at(e)}function lt(e,t,s){function i(t){var i=s(t);i.length!==e.length&&ht("Mismatched type converter count");for(var r=0;r<e.length;++r)gt(e[r],i[r]);}e.forEach((function(e){it[e]=t;}));var r=new Array(t.length),o=[],n=0;t.forEach((function(e,t){st.hasOwnProperty(e)?r[t]=st[e]:(o.push(e),tt.hasOwnProperty(e)||(tt[e]=[]),tt[e].push((function(){r[t]=st[e],++n===o.length&&i(r);})));})),0===o.length&&i(r);}var ut={};function ct(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var pt=void 0;function dt(e){for(var t="",s=e;i()[s];)t+=pt[i()[s++]];return t}var ft=void 0;function mt(e){throw new ft(e)}function gt(e,t,s){if(s=s||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var i=t.name;if(e||mt('type "'+i+'" must have a positive integer typeid pointer'),st.hasOwnProperty(e)){if(s.ignoreDuplicateRegistrations)return;mt("Cannot register type '"+i+"' twice");}if(st[e]=t,delete it[e],tt.hasOwnProperty(e)){var r=tt[e];delete tt[e],r.forEach((function(e){e();}));}}function _t(e){if(!(this instanceof Bt))return !1;if(!(e instanceof Bt))return !1;for(var t=this.$$.ptrType.registeredClass,s=this.$$.ptr,i=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)s=t.upcast(s),t=t.baseClass;for(;i.baseClass;)r=i.upcast(r),i=i.baseClass;return t===i&&s===r}function yt(e){return {count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType}}function vt(e){mt(e.$$.ptrType.registeredClass.name+" instance already deleted");}var bt=!1;function wt(e){}function Pt(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr);}(e);}function Tt(e){return "undefined"==typeof FinalizationGroup?(Tt=function(e){return e},e):(bt=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var s=t.value;s.ptr?Pt(s):console.warn("object already deleted: "+s.ptr);}})),wt=function(e){bt.unregister(e.$$);},(Tt=function(e){return bt.register(e,e.$$,e.$$),e})(e))}function xt(){if(this.$$.ptr||vt(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e=Tt(Object.create(Object.getPrototypeOf(this),{$$:{value:yt(this.$$)}}));return e.$$.count.value+=1,e.$$.deleteScheduled=!1,e}function Mt(){this.$$.ptr||vt(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&mt("Object already scheduled for deletion"),wt(this),Pt(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0);}function Dt(){return !this.$$.ptr}var At=void 0,Ct=[];function It(){for(;Ct.length;){var e=Ct.pop();e.$$.deleteScheduled=!1,e.delete();}}function Ft(){return this.$$.ptr||vt(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&mt("Object already scheduled for deletion"),Ct.push(this),1===Ct.length&&At&&At(It),this.$$.deleteScheduled=!0,this}function Bt(){}var Et={};function St(e,t,s){if(void 0===e[t].overloadTable){var i=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||mt("Function '"+s+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[i.argCount]=i;}}function Rt(e,t,s){c.hasOwnProperty(e)?((void 0===s||void 0!==c[e].overloadTable&&void 0!==c[e].overloadTable[s])&&mt("Cannot register public name '"+e+"' twice"),St(c,e,e),c.hasOwnProperty(s)&&mt("Cannot register multiple overloads of a function with the same number of arguments ("+s+")!"),c[e].overloadTable[s]=t):(c[e]=t,void 0!==s&&(c[e].numArguments=s));}function Ot(e,t,s,i,r,o,n,a){this.name=e,this.constructor=t,this.instancePrototype=s,this.rawDestructor=i,this.baseClass=r,this.getActualType=o,this.upcast=n,this.downcast=a,this.pureVirtualFunctions=[];}function Lt(e,t,s){for(;t!==s;)t.upcast||mt("Expected null or instance of "+s.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Nt(e,t){if(null===t)return this.isReference&&mt("null is not a valid "+this.name),0;t.$$||mt('Cannot pass "'+ds(t)+'" as a '+this.name),t.$$.ptr||mt("Cannot pass deleted object as a pointer of type "+this.name);var s=t.$$.ptrType.registeredClass;return Lt(t.$$.ptr,s,this.registeredClass)}function kt(e,t){var s;if(null===t)return this.isReference&&mt("null is not a valid "+this.name),this.isSmartPointer?(s=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,s),s):0;t.$$||mt('Cannot pass "'+ds(t)+'" as a '+this.name),t.$$.ptr||mt("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&mt("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;if(s=Lt(t.$$.ptr,i,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&mt("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?s=t.$$.smartPtr:mt("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:s=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)s=t.$$.smartPtr;else {var r=t.clone();s=this.rawShare(s,us((function(){r.delete();}))),null!==e&&e.push(this.rawDestructor,s);}break;default:mt("Unsupporting sharing policy");}return s}function jt(e,t){if(null===t)return this.isReference&&mt("null is not a valid "+this.name),0;t.$$||mt('Cannot pass "'+ds(t)+'" as a '+this.name),t.$$.ptr||mt("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&mt("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var s=t.$$.ptrType.registeredClass;return Lt(t.$$.ptr,s,this.registeredClass)}function Gt(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function Ht(e){this.rawDestructor&&this.rawDestructor(e);}function Vt(e){null!==e&&e.delete();}function Ut(e,t,s){if(t===s)return e;if(void 0===s.baseClass)return null;var i=Ut(e,t,s.baseClass);return null===i?null:s.downcast(i)}function zt(){return Object.keys(Yt).length}function Wt(){var e=[];for(var t in Yt)Yt.hasOwnProperty(t)&&e.push(Yt[t]);return e}function Xt(e){At=e,Ct.length&&At&&At(It);}var Yt={};function Kt(e,t){return t=function(e,t){for(void 0===t&&mt("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),Yt[t]}function Jt(e,t){return t.ptrType&&t.ptr||ht("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!=!!t.smartPtr&&ht("Both smartPtrType and smartPtr must be specified"),t.count={value:1},Tt(Object.create(e,{$$:{value:t}}))}function Zt(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var s=Kt(this.registeredClass,t);if(void 0!==s){if(0===s.$$.count.value)return s.$$.ptr=t,s.$$.smartPtr=e,s.clone();var i=s.clone();return this.destructor(e),i}function r(){return this.isSmartPointer?Jt(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Jt(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var o,n=this.registeredClass.getActualType(t),a=Et[n];if(!a)return r.call(this);o=this.isConst?a.constPointerType:a.pointerType;var h=Ut(t,this.registeredClass,o.registeredClass);return null===h?r.call(this):this.isSmartPointer?Jt(o.registeredClass.instancePrototype,{ptrType:o,ptr:h,smartPtrType:this,smartPtr:e}):Jt(o.registeredClass.instancePrototype,{ptrType:o,ptr:h})}function Qt(e,t,s,i,r,o,n,a,h,l,u){this.name=e,this.registeredClass=t,this.isReference=s,this.isConst=i,this.isSmartPointer=r,this.pointeeType=o,this.sharingPolicy=n,this.rawGetPointee=a,this.rawConstructor=h,this.rawShare=l,this.rawDestructor=u,r||void 0!==t.baseClass?this.toWireType=kt:i?(this.toWireType=Nt,this.destructorFunction=null):(this.toWireType=jt,this.destructorFunction=null);}function qt(e,t,s){c.hasOwnProperty(e)||ht("Replacing nonexistant public symbol"),void 0!==c[e].overloadTable&&void 0!==s?c[e].overloadTable[s]=t:(c[e]=t,c[e].argCount=s);}function $t(e,t){var s=-1!=(e=dt(e)).indexOf("j")?function(e,t){X(e.indexOf("j")>=0,"getDynCaller should only be called with i64 sigs");var s=[];return function(){s.length=arguments.length;for(var i=0;i<arguments.length;i++)s[i]=arguments[i];return De(e,t,s)}}(e,t):ne.get(t);return "function"!=typeof s&&mt("unknown function pointer with signature "+e+": "+t),s}var es=void 0;function ts(e){var t=oi(e),s=dt(t);return ri(t),s}function ss(e,t){var s=[],i={};throw t.forEach((function e(t){i[t]||st[t]||(it[t]?it[t].forEach(e):(s.push(t),i[t]=!0));})),new es(e+": "+s.map(ts).join([", "]))}function is(e,t){for(var s=[],i=0;i<e;i++)s.push(n()[(t>>2)+i]);return s}function rs(e,t,s,i,r){var o=t.length;o<2&&mt("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var n=null!==t[1]&&null!==s,a=!1,h=1;h<t.length;++h)if(null!==t[h]&&void 0===t[h].destructorFunction){a=!0;break}var l="void"!==t[0].name,u="",c="";for(h=0;h<o-2;++h)u+=(0!==h?", ":"")+"arg"+h,c+=(0!==h?", ":"")+"arg"+h+"Wired";var p="return function "+rt(e)+"("+u+") {\nif (arguments.length !== "+(o-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(o-2)+" args!');\n}\n";a&&(p+="var destructors = [];\n");var d=a?"destructors":"null",f=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],m=[mt,i,r,$e,t[0],t[1]];for(n&&(p+="var thisWired = classParam.toWireType("+d+", this);\n"),h=0;h<o-2;++h)p+="var arg"+h+"Wired = argType"+h+".toWireType("+d+", arg"+h+"); // "+t[h+2].name+"\n",f.push("argType"+h),m.push(t[h+2]);if(n&&(c="thisWired"+(c.length>0?", ":"")+c),p+=(l?"var rv = ":"")+"invoker(fn"+(c.length>0?", ":"")+c+");\n",a)p+="runDestructors(destructors);\n";else for(h=n?1:2;h<t.length;++h){var g=1===h?"thisWired":"arg"+(h-2)+"Wired";null!==t[h].destructorFunction&&(p+=g+"_dtor("+g+"); // "+t[h].name+"\n",f.push(g+"_dtor"),m.push(t[h].destructorFunction));}l&&(p+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),p+="}\n",f.push(p);var _=function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var s=ot(e.name||"unknownFunctionName",(function(){}));s.prototype=e.prototype;var i=new s,r=e.apply(i,t);return r instanceof Object?r:i}(Function,f).apply(null,m);return _}var os=[],ns=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function as(e){e>4&&0==--ns[e].refcount&&(ns[e]=void 0,os.push(e));}function hs(){for(var e=0,t=5;t<ns.length;++t)void 0!==ns[t]&&++e;return e}function ls(){for(var e=5;e<ns.length;++e)if(void 0!==ns[e])return ns[e];return null}function us(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=os.length?os.pop():ns.length;return ns[t]={refcount:1,value:e},t}}function cs(e,s,h){switch(s){case 0:return function(e){var s=h?t():i();return this.fromWireType(s[e>>>0])};case 1:return function(e){var t=h?r():o();return this.fromWireType(t[e>>>1])};case 2:return function(e){var t=h?n():a();return this.fromWireType(t[e>>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function ps(e,t){var s=st[e];return void 0===s&&mt(t+" has unknown type "+ts(e)),s}function ds(e){if(null===e)return "null";var t=typeof e;return "object"===t||"array"===t||"function"===t?e.toString():""+e}function fs(e,t){switch(t){case 2:return function(e){return this.fromWireType((F.buffer!=O&&oe(F.buffer),V)[e>>2])};case 3:return function(e){return this.fromWireType(h()[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ms(e,s,h){switch(s){case 0:return h?function(e){return t()[e]}:function(e){return i()[e]};case 1:return h?function(e){return r()[e>>1]}:function(e){return o()[e>>1]};case 2:return h?function(e){return n()[e>>2]}:function(e){return a()[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function gs(e){return e||mt("Cannot use deleted val. handle = "+e),ns[e].value}var _s={};function ys(e){var t=_s[e];return void 0===t?dt(e):t}function vs(){return "object"==typeof globalThis?globalThis:Function("return this")()}function bs(e,t){for(var s=arguments.length-2,i=hi(),r=ui(8*s),o=r>>3,n=0;n<s;n++)h()[o+n]=arguments[2+n];var a=yi(e,s,r,t);return li(i),a}var ws=[],Ps=[];function Ts(e){try{return F.grow(e-O.byteLength+65535>>>16),oe(F.buffer),1}catch(e){}}var xs={inEventHandler:0,removeAllEventListeners:function(){for(var e=xs.eventHandlers.length-1;e>=0;--e)xs._removeHandler(e);xs.eventHandlers=[],xs.deferredCalls=[];},registerRemoveEventListeners:function(){xs.removeEventListenersRegistered||(xs.removeEventListenersRegistered=!0);},deferredCalls:[],deferCall:function(e,t,s){function i(e,t){if(e.length!=t.length)return !1;for(var s in e)if(e[s]!=t[s])return !1;return !0}for(var r in xs.deferredCalls){var o=xs.deferredCalls[r];if(o.targetFunction==e&&i(o.argsList,s))return}xs.deferredCalls.push({targetFunction:e,precedence:t,argsList:s}),xs.deferredCalls.sort((function(e,t){return e.precedence<t.precedence}));},removeDeferredCalls:function(e){for(var t=0;t<xs.deferredCalls.length;++t)xs.deferredCalls[t].targetFunction==e&&(xs.deferredCalls.splice(t,1),--t);},canPerformEventHandlerRequests:function(){return xs.inEventHandler&&xs.currentEventHandler.allowsDeferredCalls},runDeferredCalls:function(){if(xs.canPerformEventHandlerRequests())for(var e=0;e<xs.deferredCalls.length;++e){var t=xs.deferredCalls[e];xs.deferredCalls.splice(e,1),--e,t.targetFunction.apply(null,t.argsList);}},eventHandlers:[],removeAllHandlersOnTarget:function(e,t){for(var s=0;s<xs.eventHandlers.length;++s)xs.eventHandlers[s].target!=e||t&&t!=xs.eventHandlers[s].eventTypeString||xs._removeHandler(s--);},_removeHandler:function(e){var t=xs.eventHandlers[e];t.target.removeEventListener(t.eventTypeString,t.eventListenerFunc,t.useCapture),xs.eventHandlers.splice(e,1);},registerOrRemoveHandler:function(e){var t=function(t){++xs.inEventHandler,xs.currentEventHandler=e,xs.runDeferredCalls(),e.handlerFunc(t),xs.runDeferredCalls(),--xs.inEventHandler;};if(e.callbackfunc)e.eventListenerFunc=t,e.target.addEventListener(e.eventTypeString,t,e.useCapture),xs.eventHandlers.push(e),xs.registerRemoveEventListeners();else for(var s=0;s<xs.eventHandlers.length;++s)xs.eventHandlers[s].target==e.target&&xs.eventHandlers[s].eventTypeString==e.eventTypeString&&xs._removeHandler(s--);},queueEventHandlerOnThread_iiii:function(e,t,s,i,r){var o=hi(),a=ui(12);n()[a>>2]=s,n()[a+4>>2]=i,n()[a+8>>2]=r,vi(0,e,637534208,t,i,a),li(o);},getTargetThreadForEventCallback:function(e){switch(e){case 1:return 0;case 2:return Oe.currentProxiedOperationCallerThread;default:return e}},getNodeNameForTarget:function(e){return e?e==window?"#window":e==screen?"#screen":e&&e.nodeName?e.nodeName:"":""},fullscreenEnabled:function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled}};function Ms(e,t,s,i){var r,o,a,h=hi(),l=ui(12),u=0;t&&(o=Q(r=t)+1,a=ii(o),Z(r,a,o),u=a),n()[l>>2]=u,n()[l+4>>2]=s,n()[l+8>>2]=i,vi(0,e,657457152,0,u,l),li(h);}var Ds=[0,"undefined"!=typeof document?document:0,"undefined"!=typeof window?window:0];function As(e){var t;return e=(t=e)>2?K(t):t,Ds[e]||("undefined"!=typeof document?document.querySelector(e):void 0)}function Cs(e){return As(e)}function Is(e,t,s){var i=Cs(e);if(!i)return -4;if(i.canvasSharedPtr&&(n()[i.canvasSharedPtr>>2]=t,n()[i.canvasSharedPtr+4>>2]=s),!i.offscreenCanvas&&i.controlTransferredOffscreen)return i.canvasSharedPtr?(function(e,t,s,i){Ms(e,t=t?K(t):"",s,i);}(n()[i.canvasSharedPtr+8>>2],e,t,s),1):-4;i.offscreenCanvas&&(i=i.offscreenCanvas);var r=!1;if(i.GLctxObject&&i.GLctxObject.GLctx){var o=i.GLctxObject.GLctx.getParameter(2978);r=0===o[0]&&0===o[1]&&o[2]===i.width&&o[3]===i.height;}return i.width=t,i.height=s,r&&i.GLctxObject.GLctx.viewport(0,0,t,s),0}function Fs(e,t,s){return b?bs(4,1,e,t,s):Is(e,t,s)}var Bs={counter:1,buffers:[],programs:[],framebuffers:[],renderbuffers:[],textures:[],uniforms:[],shaders:[],vaos:[],contexts:{},offscreenCanvases:{},timerQueriesEXT:[],programInfos:{},stringCache:{},unpackAlignment:4,recordError:function(e){Bs.lastError||(Bs.lastError=e);},getNewId:function(e){for(var t=Bs.counter++,s=e.length;s<t;s++)e[s]=null;return t},getSource:function(e,t,s,i){for(var r="",o=0;o<t;++o){var a=i?n()[i+4*o>>2]:-1;r+=K(n()[s+4*o>>2],a<0?void 0:a);}return r},createContext:function(e,t){var s=e.getContext("webgl",t);return s?Bs.registerContext(s,t):0},registerContext:function(e,t){var s=ii(8);n()[s+4>>2]=Vs();var i={handle:s,attributes:t,version:t.majorVersion,GLctx:e};return e.canvas&&(e.canvas.GLctxObject=i),Bs.contexts[s]=i,(void 0===t.enableExtensionsByDefault||t.enableExtensionsByDefault)&&Bs.initExtensions(i),s},makeContextCurrent:function(e){return Bs.currentContext=Bs.contexts[e],c.ctx=Js=Bs.currentContext&&Bs.currentContext.GLctx,!(e&&!Js)},getContext:function(e){return Bs.contexts[e]},deleteContext:function(e){Bs.currentContext===Bs.contexts[e]&&(Bs.currentContext=null),"object"==typeof xs&&xs.removeAllHandlersOnTarget(Bs.contexts[e].GLctx.canvas),Bs.contexts[e]&&Bs.contexts[e].GLctx.canvas&&(Bs.contexts[e].GLctx.canvas.GLctxObject=void 0),ri(Bs.contexts[e].handle),Bs.contexts[e]=null;},initExtensions:function(e){if(e||(e=Bs.currentContext),!e.initExtensionsDone){e.initExtensionsDone=!0;var t,s=e.GLctx;!function(e){var t=e.getExtension("ANGLE_instanced_arrays");t&&(e.vertexAttribDivisor=function(e,s){t.vertexAttribDivisorANGLE(e,s);},e.drawArraysInstanced=function(e,s,i,r){t.drawArraysInstancedANGLE(e,s,i,r);},e.drawElementsInstanced=function(e,s,i,r,o){t.drawElementsInstancedANGLE(e,s,i,r,o);});}(s),function(e){var t=e.getExtension("OES_vertex_array_object");t&&(e.createVertexArray=function(){return t.createVertexArrayOES()},e.deleteVertexArray=function(e){t.deleteVertexArrayOES(e);},e.bindVertexArray=function(e){t.bindVertexArrayOES(e);},e.isVertexArray=function(e){return t.isVertexArrayOES(e)});}(s),function(e){var t=e.getExtension("WEBGL_draw_buffers");t&&(e.drawBuffers=function(e,s){t.drawBuffersWEBGL(e,s);});}(s),s.disjointTimerQueryExt=s.getExtension("EXT_disjoint_timer_query"),(t=s).multiDrawWebgl=t.getExtension("WEBGL_multi_draw");var i=["OES_texture_float","OES_texture_half_float","OES_standard_derivatives","OES_vertex_array_object","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","OES_element_index_uint","EXT_texture_filter_anisotropic","EXT_frag_depth","WEBGL_draw_buffers","ANGLE_instanced_arrays","OES_texture_float_linear","OES_texture_half_float_linear","EXT_blend_minmax","EXT_shader_texture_lod","EXT_texture_norm16","WEBGL_compressed_texture_pvrtc","EXT_color_buffer_half_float","WEBGL_color_buffer_float","EXT_sRGB","WEBGL_compressed_texture_etc1","EXT_disjoint_timer_query","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_astc","EXT_color_buffer_float","WEBGL_compressed_texture_s3tc_srgb","EXT_disjoint_timer_query_webgl2","WEBKIT_WEBGL_compressed_texture_pvrtc"];(s.getSupportedExtensions()||[]).forEach((function(e){-1!=i.indexOf(e)&&s.getExtension(e);}));}},populateUniformTable:function(e){for(var t=Bs.programs[e],s=Bs.programInfos[e]={uniforms:{},maxUniformLength:0,maxAttributeLength:-1,maxUniformBlockNameLength:-1},i=s.uniforms,r=Js.getProgramParameter(t,35718),o=0;o<r;++o){var n=Js.getActiveUniform(t,o),a=n.name;s.maxUniformLength=Math.max(s.maxUniformLength,a.length+1),"]"==a.slice(-1)&&(a=a.slice(0,a.lastIndexOf("[")));var h=Js.getUniformLocation(t,a);if(h){var l=Bs.getNewId(Bs.uniforms);i[a]=[n.size,l],Bs.uniforms[l]=h;for(var u=1;u<n.size;++u){var c=a+"["+u+"]";h=Js.getUniformLocation(t,c),l=Bs.getNewId(Bs.uniforms),Bs.uniforms[l]=h;}}}}},Es=["default","low-power","high-performance"],Ss={};function Rs(){if(!Rs.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:y||"./this.program"};for(var t in Ss)e[t]=Ss[t];var s=[];for(var t in e)s.push(t+"="+e[t]);Rs.strings=s;}return Rs.strings}function Os(e,s){if(b)return bs(5,1,e,s);try{var i=0;return Rs().forEach((function(r,o){var a=s+i;n()[e+4*o>>2]=a,function(e,s,i){for(var r=0;r<e.length;++r)t()[s++>>0]=e.charCodeAt(r);i||(t()[s>>0]=0);}(r,a),i+=r.length+1;})),0}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),e.errno}}function Ls(e,t){if(b)return bs(6,1,e,t);try{var s=Rs();n()[e>>2]=s.length;var i=0;return s.forEach((function(e){i+=e.length+1;})),n()[t>>2]=i,0}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),e.errno}}function Ns(e){if(b)return bs(7,1,e);try{var t=Je.getStreamFromFD(e);return Ke.close(t),0}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),e.errno}}function ks(e,t,s,i){if(b)return bs(8,1,e,t,s,i);try{var r=Je.getStreamFromFD(e),o=Je.doReadv(r,t,s);return n()[i>>2]=o,0}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),e.errno}}function js(e,t,s,i,r){if(b)return bs(9,1,e,t,s,i,r);try{var o=Je.getStreamFromFD(e),a=4294967296*s+(t>>>0),h=9007199254740992;return a<=-h||a>=h?-61:(Ke.llseek(o,a,i),we=[o.position>>>0,(be=o.position,+Math.abs(be)>=1?be>0?(0|Math.min(+Math.floor(be/4294967296),4294967295))>>>0:~~+Math.ceil((be-+(~~be>>>0))/4294967296)>>>0:0)],n()[r>>2]=we[0],n()[r+4>>2]=we[1],o.getdents&&0===a&&0===i&&(o.getdents=null),0)}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),e.errno}}function Gs(e,t,s,i){if(b)return bs(10,1,e,t,s,i);try{var r=Je.getStreamFromFD(e),o=Je.doWritev(r,t,s);return n()[i>>2]=o,0}catch(e){return void 0!==Ke&&e instanceof Ke.ErrnoError||ge(e),e.errno}}function Hs(e){if(b)throw "Internal Error! spawnThread() can only ever be called from main application thread!";var t=Oe.getNewWorker();if(void 0!==t.pthread)throw "Internal error!";if(!e.pthread_ptr)throw "Internal error, no pthread ptr!";Oe.runningWorkers.push(t);for(var s=ii(512),i=0;i<128;++i)n()[s+4*i>>2]=0;var r=e.stackBase+e.stackSize,o=Oe.pthreads[e.pthread_ptr]={worker:t,stackBase:e.stackBase,stackSize:e.stackSize,allocatedOwnStack:e.allocatedOwnStack,thread:e.pthread_ptr,threadInfoStruct:e.pthread_ptr},h=o.threadInfoStruct>>2;Atomics.store(a(),h+0,0),Atomics.store(a(),h+1,0),Atomics.store(a(),h+2,0),Atomics.store(a(),h+17,e.detached),Atomics.store(a(),h+26,s),Atomics.store(a(),h+12,0),Atomics.store(a(),h+10,o.threadInfoStruct),Atomics.store(a(),h+11,42),Atomics.store(a(),h+27,e.stackSize),Atomics.store(a(),h+21,e.stackSize),Atomics.store(a(),h+20,r),Atomics.store(a(),h+29,r),Atomics.store(a(),h+30,e.detached),Atomics.store(a(),h+32,e.schedPolicy),Atomics.store(a(),h+33,e.schedPrio);var l=ai()+40;Atomics.store(a(),h+44,l),t.pthread=o;var u={cmd:"run",start_routine:e.startRoutine,arg:e.arg,threadInfoStruct:e.pthread_ptr,selfThreadId:e.pthread_ptr,parentThreadId:e.parent_pthread_ptr,stackBase:e.stackBase,stackSize:e.stackSize};t.runPthread=function(){u.time=performance.now(),t.postMessage(u,e.transferList);},t.loaded&&(t.runPthread(),delete t.runPthread);}function Vs(){return 0|Ae}function Us(e){return e%4==0&&(e%100!=0||e%400==0)}function zs(e,t){for(var s=0,i=0;i<=t;s+=e[i++]);return s}c._pthread_self=Vs;var Ws=[31,29,31,30,31,30,31,31,30,31,30,31],Xs=[31,28,31,30,31,30,31,31,30,31,30,31];function Ys(e,t){for(var s=new Date(e.getTime());t>0;){var i=Us(s.getFullYear()),r=s.getMonth(),o=(i?Ws:Xs)[r];if(!(t>o-s.getDate()))return s.setDate(s.getDate()+t),s;t-=o-s.getDate()+1,s.setDate(1),r<11?s.setMonth(r+1):(s.setMonth(0),s.setFullYear(s.getFullYear()+1));}return s}function Ks(e,s,i,r){var o=n()[r+40>>2],a={tm_sec:n()[r>>2],tm_min:n()[r+4>>2],tm_hour:n()[r+8>>2],tm_mday:n()[r+12>>2],tm_mon:n()[r+16>>2],tm_year:n()[r+20>>2],tm_wday:n()[r+24>>2],tm_yday:n()[r+28>>2],tm_isdst:n()[r+32>>2],tm_gmtoff:n()[r+36>>2],tm_zone:o?K(o):""},h=K(i),l={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var u in l)h=h.replace(new RegExp(u,"g"),l[u]);var c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],p=["January","February","March","April","May","June","July","August","September","October","November","December"];function d(e,t,s){for(var i="number"==typeof e?e.toString():e||"";i.length<t;)i=s[0]+i;return i}function f(e,t){return d(e,t,"0")}function m(e,t){function s(e){return e<0?-1:e>0?1:0}var i;return 0===(i=s(e.getFullYear()-t.getFullYear()))&&0===(i=s(e.getMonth()-t.getMonth()))&&(i=s(e.getDate()-t.getDate())),i}function g(e){switch(e.getDay()){case 0:return new Date(e.getFullYear()-1,11,29);case 1:return e;case 2:return new Date(e.getFullYear(),0,3);case 3:return new Date(e.getFullYear(),0,2);case 4:return new Date(e.getFullYear(),0,1);case 5:return new Date(e.getFullYear()-1,11,31);case 6:return new Date(e.getFullYear()-1,11,30)}}function _(e){var t=Ys(new Date(e.tm_year+1900,0,1),e.tm_yday),s=new Date(t.getFullYear(),0,4),i=new Date(t.getFullYear()+1,0,4),r=g(s),o=g(i);return m(r,t)<=0?m(o,t)<=0?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}var y={"%a":function(e){return c[e.tm_wday].substring(0,3)},"%A":function(e){return c[e.tm_wday]},"%b":function(e){return p[e.tm_mon].substring(0,3)},"%B":function(e){return p[e.tm_mon]},"%C":function(e){return f((e.tm_year+1900)/100|0,2)},"%d":function(e){return f(e.tm_mday,2)},"%e":function(e){return d(e.tm_mday,2," ")},"%g":function(e){return _(e).toString().substring(2)},"%G":function(e){return _(e)},"%H":function(e){return f(e.tm_hour,2)},"%I":function(e){var t=e.tm_hour;return 0==t?t=12:t>12&&(t-=12),f(t,2)},"%j":function(e){return f(e.tm_mday+zs(Us(e.tm_year+1900)?Ws:Xs,e.tm_mon-1),3)},"%m":function(e){return f(e.tm_mon+1,2)},"%M":function(e){return f(e.tm_min,2)},"%n":function(){return "\n"},"%p":function(e){return e.tm_hour>=0&&e.tm_hour<12?"AM":"PM"},"%S":function(e){return f(e.tm_sec,2)},"%t":function(){return "\t"},"%u":function(e){return e.tm_wday||7},"%U":function(e){var t=new Date(e.tm_year+1900,0,1),s=0===t.getDay()?t:Ys(t,7-t.getDay()),i=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(m(s,i)<0){var r=zs(Us(i.getFullYear())?Ws:Xs,i.getMonth()-1)-31,o=31-s.getDate()+r+i.getDate();return f(Math.ceil(o/7),2)}return 0===m(s,t)?"01":"00"},"%V":function(e){var t,s=new Date(e.tm_year+1900,0,4),i=new Date(e.tm_year+1901,0,4),r=g(s),o=g(i),n=Ys(new Date(e.tm_year+1900,0,1),e.tm_yday);return m(n,r)<0?"53":m(o,n)<=0?"01":(t=r.getFullYear()<e.tm_year+1900?e.tm_yday+32-r.getDate():e.tm_yday+1-r.getDate(),f(Math.ceil(t/7),2))},"%w":function(e){return e.tm_wday},"%W":function(e){var t=new Date(e.tm_year,0,1),s=1===t.getDay()?t:Ys(t,0===t.getDay()?1:7-t.getDay()+1),i=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(m(s,i)<0){var r=zs(Us(i.getFullYear())?Ws:Xs,i.getMonth()-1)-31,o=31-s.getDate()+r+i.getDate();return f(Math.ceil(o/7),2)}return 0===m(s,t)?"01":"00"},"%y":function(e){return (e.tm_year+1900).toString().substring(2)},"%Y":function(e){return e.tm_year+1900},"%z":function(e){var t=e.tm_gmtoff,s=t>=0;return t=(t=Math.abs(t)/60)/60*100+t%60,(s?"+":"-")+String("0000"+t).slice(-4)},"%Z":function(e){return e.tm_zone},"%%":function(){return "%"}};for(var u in y)h.indexOf(u)>=0&&(h=h.replace(new RegExp(u,"g"),y[u](a)));var v,b,w=ei(h,!1);return w.length>s?0:(v=w,b=e,t().set(v,b),w.length-1)}b||Oe.initMainThreadBlock();var Js,Zs=function(e,t,s,i){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=Ke.nextInode++,this.name=t,this.mode=s,this.node_ops={},this.stream_ops={},this.rdev=i;},Qs=365,qs=146;Object.defineProperties(Zs.prototype,{read:{get:function(){return (this.mode&Qs)===Qs},set:function(e){e?this.mode|=Qs:this.mode&=-366;}},write:{get:function(){return (this.mode&qs)===qs},set:function(e){e?this.mode|=qs:this.mode&=-147;}},isFolder:{get:function(){return Ke.isDir(this.mode)}},isDevice:{get:function(){return Ke.isChrdev(this.mode)}}}),Ke.FSNode=Zs,Ke.staticInit(),c.FS_createPath=Ke.createPath,c.FS_createDataFile=Ke.createDataFile,c.FS_createPreloadedFile=Ke.createPreloadedFile,c.FS_createLazyFile=Ke.createLazyFile,c.FS_createDevice=Ke.createDevice,c.FS_unlink=Ke.unlink,at=c.InternalError=nt(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);pt=e;}(),ft=c.BindingError=nt(Error,"BindingError"),Bt.prototype.isAliasOf=_t,Bt.prototype.clone=xt,Bt.prototype.delete=Mt,Bt.prototype.isDeleted=Dt,Bt.prototype.deleteLater=Ft,Qt.prototype.getPointee=Gt,Qt.prototype.destructor=Ht,Qt.prototype.argPackAdvance=8,Qt.prototype.readValueFromPointer=et,Qt.prototype.deleteObject=Vt,Qt.prototype.fromWireType=Zt,c.getInheritedInstanceCount=zt,c.getLiveInheritedInstances=Wt,c.flushPendingDeletes=It,c.setDelayFunction=Xt,es=c.UnboundTypeError=nt(Error,"UnboundTypeError"),c.count_emval_handles=hs,c.get_first_emval=ls;var $s=[null,function(e,t){if(b)return bs(1,1,e,t)},Ze,Qe,Fs,Os,Ls,Ns,ks,js,Gs];function ei(e,t,s){var i=s>0?s:Q(e)+1,r=new Array(i),o=J(e,r,0,r.length);return t&&(r.length=o),r}b||le.push({func:function(){si();}});var ti={p:function(e,t,s,i){ge("Assertion failed: "+K(e)+", at: "+[t?K(t):"unknown filename",s,i?K(i):"unknown function"]);},H:function(e){return ii(e+He)+He},G:function(e,t,s){throw new Ve(e).init(t,s),e},ha:Ze,ia:Qe,na:function(e){var t=qe[e];delete qe[e];var s=t.elements,i=s.length,r=s.map((function(e){return e.getterReturnType})).concat(s.map((function(e){return e.setterArgumentType}))),o=t.rawConstructor,n=t.rawDestructor;lt([e],r,(function(e){return s.forEach((function(t,s){var r=e[s],o=t.getter,n=t.getterContext,a=e[s+i],h=t.setter,l=t.setterContext;t.read=function(e){return r.fromWireType(o(n,e))},t.write=function(e,t){var s=[];h(l,e,a.toWireType(s,t)),$e(s);};})),[{name:t.name,fromWireType:function(e){for(var t=new Array(i),r=0;r<i;++r)t[r]=s[r].read(e);return n(e),t},toWireType:function(e,r){if(i!==r.length)throw new TypeError("Incorrect number of tuple elements for "+t.name+": expected="+i+", actual="+r.length);for(var a=o(),h=0;h<i;++h)s[h].write(a,r[h]);return null!==e&&e.push(n,a),a},argPackAdvance:8,readValueFromPointer:et,destructorFunction:n}]}));},w:function(e){var t=ut[e];delete ut[e];var s=t.rawConstructor,i=t.rawDestructor,r=t.fields;lt([e],r.map((function(e){return e.getterReturnType})).concat(r.map((function(e){return e.setterArgumentType}))),(function(e){var o={};return r.forEach((function(t,s){var i=t.fieldName,n=e[s],a=t.getter,h=t.getterContext,l=e[s+r.length],u=t.setter,c=t.setterContext;o[i]={read:function(e){return n.fromWireType(a(h,e))},write:function(e,t){var s=[];u(c,e,l.toWireType(s,t)),$e(s);}};})),[{name:t.name,fromWireType:function(e){var t={};for(var s in o)t[s]=o[s].read(e);return i(e),t},toWireType:function(e,t){for(var r in o)if(!(r in t))throw new TypeError('Missing field:  "'+r+'"');var n=s();for(r in o)o[r].write(n,t[r]);return null!==e&&e.push(i,n),n},argPackAdvance:8,readValueFromPointer:et,destructorFunction:i}]}));},ka:function(e,s,i,o,a){var h=ct(i);gt(e,{name:s=dt(s),fromWireType:function(e){return !!e},toWireType:function(e,t){return t?o:a},argPackAdvance:8,readValueFromPointer:function(e){var o;if(1===i)o=t();else if(2===i)o=r();else {if(4!==i)throw new TypeError("Unknown boolean type size: "+s);o=n();}return this.fromWireType(o[e>>>h])},destructorFunction:null});},z:function(e,t,s,i,r,o,n,a,h,l,u,c,p){u=dt(u),o=$t(r,o),a&&(a=$t(n,a)),l&&(l=$t(h,l)),p=$t(c,p);var d=rt(u);Rt(d,(function(){ss("Cannot construct "+u+" due to unbound types",[i]);})),lt([e,t,s],i?[i]:[],(function(t){var s,r;t=t[0],r=i?(s=t.registeredClass).instancePrototype:Bt.prototype;var n=ot(d,(function(){if(Object.getPrototypeOf(this)!==h)throw new ft("Use 'new' to construct "+u);if(void 0===c.constructor_body)throw new ft(u+" has no accessible constructor");var e=c.constructor_body[arguments.length];if(void 0===e)throw new ft("Tried to invoke ctor of "+u+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(c.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),h=Object.create(r,{constructor:{value:n}});n.prototype=h;var c=new Ot(u,n,h,p,s,o,a,l),f=new Qt(u,c,!0,!1,!1),m=new Qt(u+"*",c,!1,!1,!1),g=new Qt(u+" const*",c,!1,!0,!1);return Et[e]={pointerType:m,constPointerType:g},qt(d,n),[f,m,g]}));},y:function(e,t,s,i,r,o){X(t>0);var n=is(t,s);r=$t(i,r);var a=[o],h=[];lt([],[e],(function(e){var s="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ft("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){ss("Cannot construct "+e.name+" due to unbound types",n);},lt([],n,(function(i){return e.registeredClass.constructor_body[t-1]=function(){arguments.length!==t-1&&mt(s+" called with "+arguments.length+" arguments, expected "+(t-1)),h.length=0,a.length=t;for(var e=1;e<t;++e)a[e]=i[e].toWireType(h,arguments[e-1]);var o=r.apply(null,a);return $e(h),i[0].fromWireType(o)},[]})),[]}));},e:function(e,t,s,i,r,o,n,a){var h=is(s,i);t=dt(t),o=$t(r,o),lt([],[e],(function(e){var i=(e=e[0]).name+"."+t;function r(){ss("Cannot call "+i+" due to unbound types",h);}a&&e.registeredClass.pureVirtualFunctions.push(t);var l=e.registeredClass.instancePrototype,u=l[t];return void 0===u||void 0===u.overloadTable&&u.className!==e.name&&u.argCount===s-2?(r.argCount=s-2,r.className=e.name,l[t]=r):(St(l,t,i),l[t].overloadTable[s-2]=r),lt([],h,(function(r){var a=rs(i,r,e,o,n);return void 0===l[t].overloadTable?(a.argCount=s-2,l[t]=a):l[t].overloadTable[s-2]=a,[]})),[]}));},ja:function(e,t){gt(e,{name:t=dt(t),fromWireType:function(e){var t=ns[e].value;return as(e),t},toWireType:function(e,t){return us(t)},argPackAdvance:8,readValueFromPointer:et,destructorFunction:null});},ma:function(e,t,s,i){var r=ct(s);function o(){}t=dt(t),o.values={},gt(e,{name:t,constructor:o,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:cs(t,r,i),destructorFunction:null}),Rt(t,o);},E:function(e,t,s){var i=ps(e,"enum");t=dt(t);var r=i.constructor,o=Object.create(i.constructor.prototype,{value:{value:s},constructor:{value:ot(i.name+"_"+t,(function(){}))}});r.values[s]=o,r[t]=o;},N:function(e,t,s){var i=ct(s);gt(e,{name:t=dt(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+ds(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:fs(t,i),destructorFunction:null});},i:function(e,t,s,i,r,o){var n=is(t,s);e=dt(e),r=$t(i,r),Rt(e,(function(){ss("Cannot call "+e+" due to unbound types",n);}),t-1),lt([],n,(function(s){var i=[s[0],null].concat(s.slice(1));return qt(e,rs(e,i,null,r,o),t-1),[]}));},u:function(e,t,s,i,r){t=dt(t),-1===r&&(r=4294967295);var o=ct(s),n=function(e){return e};if(0===i){var a=32-8*s;n=function(e){return e<<a>>>a};}var h=-1!=t.indexOf("unsigned");gt(e,{name:t,fromWireType:n,toWireType:function(e,s){if("number"!=typeof s&&"boolean"!=typeof s)throw new TypeError('Cannot convert "'+ds(s)+'" to '+this.name);if(s<i||s>r)throw new TypeError('Passing a number "'+ds(s)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+i+", "+r+"]!");return h?s>>>0:0|s},argPackAdvance:8,readValueFromPointer:ms(t,o,0!==i),destructorFunction:null});},q:function(e,t,s){var i=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){e>>=2;var t=a(),s=t[e>>>0],r=t[e+1>>>0];return new i(O,r,s)}gt(e,{name:s=dt(s),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0});},O:function(e,t){var s="std::string"===(t=dt(t));gt(e,{name:t,fromWireType:function(e){var t,r=a()[e>>2];if(s)for(var o=e+4,n=0;n<=r;++n){var h=e+4+n;if(n==r||0==i()[h]){var l=K(o,h-o);void 0===t?t=l:(t+=String.fromCharCode(0),t+=l),o=h+1;}}else {var u=new Array(r);for(n=0;n<r;++n)u[n]=String.fromCharCode(i()[e+4+n]);t=u.join("");}return ri(e),t},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||mt("Cannot pass non-string to std::string");var o=(s&&r?function(){return Q(t)}:function(){return t.length})(),n=ii(4+o+1);if(n>>>=0,a()[n>>2]=o,s&&r)Z(t,n+4,o+1);else if(r)for(var h=0;h<o;++h){var l=t.charCodeAt(h);l>255&&(ri(n),mt("String has UTF-16 code units that do not fit in 8 bits")),i()[n+4+h]=l;}else for(h=0;h<o;++h)i()[n+4+h]=t[h];return null!==e&&e.push(ri,n),n},argPackAdvance:8,readValueFromPointer:et,destructorFunction:function(e){ri(e);}});},F:function(e,t,s){var i,r,n,h,l;s=dt(s),2===t?(i=q,r=$,h=ee,n=function(){return o()},l=1):4===t&&(i=te,r=se,h=ie,n=function(){return a()},l=2),gt(e,{name:s,fromWireType:function(e){for(var s,r=a()[e>>2],o=n(),h=e+4,u=0;u<=r;++u){var c=e+4+u*t;if(u==r||0==o[c>>>l]){var p=i(h,c-h);void 0===s?s=p:(s+=String.fromCharCode(0),s+=p),h=c+t;}}return ri(e),s},toWireType:function(e,i){"string"!=typeof i&&mt("Cannot pass non-string to C++ string type "+s);var o=h(i),n=ii(4+o+t);return n>>>=0,a()[n>>2]=o>>l,r(i,n+4,o+t),null!==e&&e.push(ri,n),n},argPackAdvance:8,readValueFromPointer:et,destructorFunction:function(e){ri(e);}});},oa:function(e,t,s,i,r,o){qe[e]={name:dt(t),rawConstructor:$t(s,i),rawDestructor:$t(r,o),elements:[]};},l:function(e,t,s,i,r,o,n,a,h){qe[e].elements.push({getterReturnType:t,getter:$t(s,i),getterContext:r,setterArgumentType:o,setter:$t(n,a),setterContext:h});},x:function(e,t,s,i,r,o){ut[e]={name:dt(t),rawConstructor:$t(s,i),rawDestructor:$t(r,o),fields:[]};},h:function(e,t,s,i,r,o,n,a,h,l){ut[e].fields.push({fieldName:dt(t),getterReturnType:s,getter:$t(i,r),getterContext:o,setterArgumentType:n,setter:$t(a,h),setterContext:l});},la:function(e,t){gt(e,{isVoid:!0,name:t=dt(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}});},$:function(e,t){if(e==t)postMessage({cmd:"processQueuedMainThreadWork"});else if(b)postMessage({targetThread:e,cmd:"processThreadQueue"});else {var s=Oe.pthreads[e],i=s&&s.worker;if(!i)return;i.postMessage({cmd:"processThreadQueue"});}return 1},s:function(e,t,s){e=gs(e),t=ps(t,"emval::as");var i=[],r=us(i);return n()[s>>2]=r,t.toWireType(i,e)},P:function(e,t,s,i){e=gs(e);for(var r=function(e,t){for(var s=new Array(e),i=0;i<e;++i)s[i]=ps(n()[(t>>2)+i],"parameter "+i);return s}(t,s),o=new Array(t),a=0;a<t;++a){var h=r[a];o[a]=h.readValueFromPointer(i),i+=h.argPackAdvance;}return us(e.apply(void 0,o))},b:as,Z:function(e){return 0===e?us(vs()):(e=ys(e),us(vs()[e]))},t:function(e,t){return us((e=gs(e))[t=gs(t)])},o:function(e){e>4&&(ns[e].refcount+=1);},ba:function(e,t){return (e=gs(e))instanceof(t=gs(t))},Q:function(e){return "number"==typeof(e=gs(e))},I:function(){return us([])},j:function(e){return us(ys(e))},A:function(){return us({})},r:function(e){$e(ns[e].value),as(e);},m:function(e,t,s){e=gs(e),t=gs(t),s=gs(s),e[t]=s;},g:function(e,t){return us((e=ps(e,"_emval_take_value")).readValueFromPointer(t))},K:function(){ge();},fa:function(e,t){var s,i;if(0===e)s=Date.now();else {if(1!==e&&4!==e)return i=28,n()[ni()>>2]=i,-1;s=Re();}return n()[t>>2]=s/1e3|0,n()[t+4>>2]=s%1e3*1e3*1e3|0,0},B:function(e,t,s){var r=function(e,t){var s;for(Ps.length=0,t>>=2;s=i()[e++];){var r=s<105;r&&1&t&&t++,Ps.push(r?h()[t++>>1]:n()[t]),++t;}return Ps}(t,s);return xe[e].apply(null,r)},aa:function(){g||m||R("Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread");},J:function(e,t){},k:function(e,s,i){if(e<=0||e>t().length||!0&e)return -28;if(f){if(Atomics.load(n(),e>>2)!=s)return -6;var r=performance.now(),o=r+i;for(Atomics.exchange(n(),Oe.mainThreadFutex>>2,e);;){if((r=performance.now())>o)return Atomics.exchange(n(),Oe.mainThreadFutex>>2,0),-73;if(0==Atomics.exchange(n(),Oe.mainThreadFutex>>2,0))break;if(fi(),Atomics.load(n(),e>>2)!=s)return -6;Atomics.exchange(n(),Oe.mainThreadFutex>>2,e);}return 0}var a=Atomics.wait(n(),e>>2,s,i);if("timed-out"===a)return -73;if("not-equal"===a)return -6;if("ok"===a)return 0;throw "Atomics.wait returned an unexpected value "+a},n:Se,d:Re,D:function(){return 0|Ie},C:function(){return 0|Ce},U:function(e,t,s){i().copyWithin(e,t,t+s);},W:function(e,t,s){ws.length=t;for(var i=s>>3,r=0;r<t;r++)ws[r]=h()[i+r];return (e<0?xe[-e-1]:$s[e]).apply(null,ws)},v:function(e){e>>>=0;var t=i().length;if(e<=t)return !1;var s=4294967296;if(e>s)return !1;for(var r=1;r<=4;r*=2){var o=t*(1+.2/r);if(o=Math.min(o,e+100663296),Ts(Math.min(s,re(Math.max(16777216,e,o),65536))))return !0}return !1},X:function(e,t,s){return Cs(e)?Is(e,t,s):Fs(e,t,s)},f:function(e){},Y:function(e,t){return function(e,t){var s=t>>2,i=n()[s+6],r={alpha:!!n()[s+0],depth:!!n()[s+1],stencil:!!n()[s+2],antialias:!!n()[s+3],premultipliedAlpha:!!n()[s+4],preserveDrawingBuffer:!!n()[s+5],powerPreference:Es[i],failIfMajorPerformanceCaveat:!!n()[s+7],majorVersion:n()[s+8],minorVersion:n()[s+9],enableExtensionsByDefault:n()[s+10],explicitSwapControl:n()[s+11],proxyContextToMainThread:n()[s+12],renderViaOffscreenBackBuffer:n()[s+13]},o=Cs(e);return o?r.explicitSwapControl?0:Bs.createContext(o,r):0}(e,t)},da:Os,ea:Ls,M:Ns,ga:ks,R:js,L:Gs,T:function(){Oe.initRuntime();},a:F||c.wasmMemory,V:function(e,t){Oe.threadExitHandlers.push((function(){ne.get(e)(t);}));},_:function(e,t,s,i){if("undefined"==typeof SharedArrayBuffer)return S("Current environment does not support SharedArrayBuffer, pthreads are not available!"),6;if(!e)return S("pthread_create called with a null thread pointer!"),28;var r=[];if(b&&0===r.length)return _i(687865856,e,t,s,i);var o=0,h=0,l=0,u=0,c=0;if(t)if(o=n()[t>>2],o+=81920,h=n()[t+8>>2],l=0!==n()[t+12>>2],0===n()[t+16>>2]){var p=n()[t+20>>2],d=n()[t+24>>2];!function(e,t,s){if(!t&&!s)return Ee;if(!e)return S("pthread_getschedparam called with a null thread pointer!"),Be;if(n()[e+12>>2]!==e)return S("pthread_getschedparam attempted on thread "+e+", which does not point to a valid thread, or does not exist anymore!"),Be;var i=Atomics.load(a(),e+108+20>>2),r=Atomics.load(a(),e+108+24>>2);t&&(n()[t>>2]=i),s&&(n()[s>>2]=r);}(Oe.currentProxiedOperationCallerThread?Oe.currentProxiedOperationCallerThread:Vs(),t+20,t+24),u=n()[t+20>>2],c=n()[t+24>>2],n()[t+20>>2]=p,n()[t+24>>2]=d;}else u=n()[t+20>>2],c=n()[t+24>>2];else o=2097152;var f=0==h;f?h=pi(16,o):X((h-=o)>0);for(var m=ii(232),g=0;g<58;++g)a()[(m>>2)+g]=0;n()[e>>2]=m,n()[m+12>>2]=m;var _=m+156;n()[_>>2]=_;var y={stackBase:h,stackSize:o,allocatedOwnStack:f,schedPolicy:u,schedPrio:c,detached:l,startRoutine:s,pthread_ptr:m,parent_pthread_ptr:Vs(),arg:i,transferList:r};return b?(y.cmd="spawnThread",postMessage(y,r)):Hs(y),0},c:Vs,S:function(e){},ca:function(e,t,s,i){return Ks(e,t,s,i)}};!function(){var e={a:ti};function t(e,t){var s=e.exports;if(c.asm=s,ne=c.asm.pa,B=t,!b){var i=Oe.unusedWorkers.length;Oe.unusedWorkers.forEach((function(e){Oe.loadWasmModuleToWorker(e,(function(){--i||me();}));}));}}function s(e){t(e.instance,e.module);}function i(t){return (C||!f&&!m||"function"!=typeof fetch||ve(Pe)?Promise.resolve().then(Te):fetch(Pe,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw "failed to load wasm binary file at '"+Pe+"'";return e.arrayBuffer()})).catch((function(){return Te()}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){S("failed to asynchronously prepare wasm: "+e),ge(e);}))}if(b||fe(),c.instantiateWasm)try{return c.instantiateWasm(e,t)}catch(e){return S("Module.instantiateWasm callback failed with error: "+e),!1}(C||"function"!=typeof WebAssembly.instantiateStreaming||ye(Pe)||ve(Pe)||"function"!=typeof fetch?i(s):fetch(Pe,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(s,(function(e){return S("wasm streaming compile failed: "+e),S("falling back to ArrayBuffer instantiation"),i(s)}))}))).catch(u);}();var si=c.___wasm_call_ctors=function(){return (si=c.___wasm_call_ctors=c.asm.qa).apply(null,arguments)};c._main=function(){return (c._main=c.asm.ra).apply(null,arguments)};var ii=c._malloc=function(){return (ii=c._malloc=c.asm.sa).apply(null,arguments)},ri=c._free=function(){return (ri=c._free=c.asm.ta).apply(null,arguments)},oi=c.___getTypeName=function(){return (oi=c.___getTypeName=c.asm.ua).apply(null,arguments)};c.___embind_register_native_and_builtin_types=function(){return (c.___embind_register_native_and_builtin_types=c.asm.va).apply(null,arguments)};var ni=c.___errno_location=function(){return (ni=c.___errno_location=c.asm.wa).apply(null,arguments)},ai=c._emscripten_get_global_libc=function(){return (ai=c._emscripten_get_global_libc=c.asm.xa).apply(null,arguments)};c.___em_js__initPthreadsJS=function(){return (c.___em_js__initPthreadsJS=c.asm.ya).apply(null,arguments)};var hi=c.stackSave=function(){return (hi=c.stackSave=c.asm.za).apply(null,arguments)},li=c.stackRestore=function(){return (li=c.stackRestore=c.asm.Aa).apply(null,arguments)},ui=c.stackAlloc=function(){return (ui=c.stackAlloc=c.asm.Ba).apply(null,arguments)},ci=c._emscripten_stack_set_limits=function(){return (ci=c._emscripten_stack_set_limits=c.asm.Ca).apply(null,arguments)},pi=c._memalign=function(){return (pi=c._memalign=c.asm.Da).apply(null,arguments)};c._emscripten_main_browser_thread_id=function(){return (c._emscripten_main_browser_thread_id=c.asm.Ea).apply(null,arguments)};var di=c.___pthread_tsd_run_dtors=function(){return (di=c.___pthread_tsd_run_dtors=c.asm.Fa).apply(null,arguments)},fi=c._emscripten_main_thread_process_queued_calls=function(){return (fi=c._emscripten_main_thread_process_queued_calls=c.asm.Ga).apply(null,arguments)};c._emscripten_current_thread_process_queued_calls=function(){return (c._emscripten_current_thread_process_queued_calls=c.asm.Ha).apply(null,arguments)};var mi=c._emscripten_register_main_browser_thread_id=function(){return (mi=c._emscripten_register_main_browser_thread_id=c.asm.Ia).apply(null,arguments)},gi=c._do_emscripten_dispatch_to_thread=function(){return (gi=c._do_emscripten_dispatch_to_thread=c.asm.Ja).apply(null,arguments)};c._emscripten_async_run_in_main_thread=function(){return (c._emscripten_async_run_in_main_thread=c.asm.Ka).apply(null,arguments)},c._emscripten_sync_run_in_main_thread=function(){return (c._emscripten_sync_run_in_main_thread=c.asm.La).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_0=function(){return (c._emscripten_sync_run_in_main_thread_0=c.asm.Ma).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_1=function(){return (c._emscripten_sync_run_in_main_thread_1=c.asm.Na).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_2=function(){return (c._emscripten_sync_run_in_main_thread_2=c.asm.Oa).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_xprintf_varargs=function(){return (c._emscripten_sync_run_in_main_thread_xprintf_varargs=c.asm.Pa).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_3=function(){return (c._emscripten_sync_run_in_main_thread_3=c.asm.Qa).apply(null,arguments)};var _i=c._emscripten_sync_run_in_main_thread_4=function(){return (_i=c._emscripten_sync_run_in_main_thread_4=c.asm.Ra).apply(null,arguments)};c._emscripten_sync_run_in_main_thread_5=function(){return (c._emscripten_sync_run_in_main_thread_5=c.asm.Sa).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_6=function(){return (c._emscripten_sync_run_in_main_thread_6=c.asm.Ta).apply(null,arguments)},c._emscripten_sync_run_in_main_thread_7=function(){return (c._emscripten_sync_run_in_main_thread_7=c.asm.Ua).apply(null,arguments)};var yi=c._emscripten_run_in_main_runtime_thread_js=function(){return (yi=c._emscripten_run_in_main_runtime_thread_js=c.asm.Va).apply(null,arguments)},vi=c.__emscripten_call_on_thread=function(){return (vi=c.__emscripten_call_on_thread=c.asm.Wa).apply(null,arguments)};c._emscripten_tls_init=function(){return (c._emscripten_tls_init=c.asm.Xa).apply(null,arguments)},c.dynCall_jiji=function(){return (c.dynCall_jiji=c.asm.Ya).apply(null,arguments)},c.dynCall_viijii=function(){return (c.dynCall_viijii=c.asm.Za).apply(null,arguments)},c.dynCall_iiiiiijj=function(){return (c.dynCall_iiiiiijj=c.asm._a).apply(null,arguments)},c.dynCall_iiiiij=function(){return (c.dynCall_iiiiij=c.asm.$a).apply(null,arguments)},c.dynCall_iiiiijj=function(){return (c.dynCall_iiiiijj=c.asm.ab).apply(null,arguments)};var bi,wi=c._main_thread_futex=51928;function Pi(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e;}function Ti(e){var t,s=c._main;try{t=s(0,0),!0&&I&&0===t||(I||(Oe.terminateAllThreads(),c.onExit&&c.onExit(t),W=!0),v(t,new Pi(t)));}catch(e){if(e instanceof Pi)return;if("unwind"==e)return void(I=!0);var i=e;e&&"object"==typeof e&&e.stack&&(i=[e,e.stack]),S("exception thrown: "+i),v(1,e);}}function xi(e){function t(){bi||(bi=!0,c.calledRun=!0,W||(c.noFSInit||Ke.init.initialized||Ke.init(),Me(le),b||(Ke.ignorePermissions=!1,Me(ue)),l(c),c.onRuntimeInitialized&&c.onRuntimeInitialized(),Mi&&Ti(),function(){if(!b){if(c.postRun)for("function"==typeof c.postRun&&(c.postRun=[c.postRun]);c.postRun.length;)e=c.postRun.shift(),ce.unshift(e);var e;Me(ce);}}()));}pe>0||(function(){if(!b){if(c.preRun)for("function"==typeof c.preRun&&(c.preRun=[c.preRun]);c.preRun.length;)e=c.preRun.shift(),he.unshift(e);var e;Me(he);}}(),pe>0||(c.setStatus?(c.setStatus("Running..."),setTimeout((function(){setTimeout((function(){c.setStatus("");}),1),t();}),1)):t()));}if(c.addRunDependency=fe,c.removeRunDependency=me,c.FS_createPath=Ke.createPath,c.FS_createDataFile=Ke.createDataFile,c.FS_createPreloadedFile=Ke.createPreloadedFile,c.FS_createLazyFile=Ke.createLazyFile,c.FS_createDevice=Ke.createDevice,c.FS_unlink=Ke.unlink,c.FS=Ke,c.PThread=Oe,c.PThread=Oe,c._pthread_self=Vs,c.wasmMemory=F,c.ExitStatus=Pi,de=function e(){bi||xi(),bi||(de=e);},c.run=xi,c.preInit)for("function"==typeof c.preInit&&(c.preInit=[c.preInit]);c.preInit.length>0;)c.preInit.pop()();var Mi=!0;return c.noInitialRun&&(Mi=!1),b||(I=!0),b?Oe.initWorker():xi(),e.ready});"object"==typeof e&&"object"==typeof t?t.exports=i:"function"==typeof define&&define.amd?define([],(function(){return i})):"object"==typeof e&&(e.WebIFCWasm=i);}}),D_=P_({"dist/web-ifc.js"(e,t){var s,i=(s="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(s=s||__filename),function(e){var t,i,r=void 0!==(e=e||{})?e:{};r.ready=new Promise((function(e,s){t=e,i=s;}));var o,n={};for(o in r)r.hasOwnProperty(o)&&(n[o]=r[o]);var a,h,l,u,c="./this.program",p=function(e,t){throw t};a="object"==typeof window,h="function"==typeof importScripts,l="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,u=!a&&!l&&!h;var d,f,m,g,_="";l?(_=h?w_("path").dirname(_)+"/":__dirname+"/",d=function(e,t){return m||(m=w_("fs")),g||(g=w_("path")),e=g.normalize(e),m.readFileSync(e,t?null:"utf8")},f=function(e){var t=d(e,!0);return t.buffer||(t=new Uint8Array(t)),x(t.buffer),t},process.argv.length>1&&(c=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),process.on("uncaughtException",(function(e){if(!(e instanceof ys))throw e})),process.on("unhandledRejection",oe),p=function(e){process.exit(e);},r.inspect=function(){return "[Emscripten Module object]"}):u?("undefined"!=typeof read&&(d=function(e){return read(e)}),f=function(e){var t;return "function"==typeof readbuffer?new Uint8Array(readbuffer(e)):(x("object"==typeof(t=read(e,"binary"))),t)},"undefined"!=typeof scriptArgs&&scriptArgs,"function"==typeof quit&&(p=function(e){quit(e);}),"undefined"!=typeof print&&("undefined"==typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!=typeof printErr?printErr:print)):(a||h)&&(h?_=self.location.href:"undefined"!=typeof document&&document.currentScript&&(_=document.currentScript.src),s&&(_=s),_=0!==_.indexOf("blob:")?_.substr(0,_.lastIndexOf("/")+1):"",d=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},h&&(f=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}));var y,v,b,w=r.print||console.log.bind(console),P=r.printErr||console.warn.bind(console);for(o in n)n.hasOwnProperty(o)&&(r[o]=n[o]);n=null,r.arguments,r.thisProgram&&(c=r.thisProgram),r.quit&&(p=r.quit),r.wasmBinary&&(y=r.wasmBinary),r.noExitRuntime&&(v=r.noExitRuntime),"object"!=typeof WebAssembly&&oe("no native wasm support detected");var T=!1;function x(e,t){e||oe("Assertion failed: "+t);}var M="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function D(e,t,s){for(var i=(t>>>=0)+s,r=t;e[r>>>0]&&!(r>=i);)++r;if(r-t>16&&e.subarray&&M)return M.decode(e.subarray(t>>>0,r>>>0));for(var o="";t<r;){var n=e[t++>>>0];if(128&n){var a=63&e[t++>>>0];if(192!=(224&n)){var h=63&e[t++>>>0];if((n=224==(240&n)?(15&n)<<12|a<<6|h:(7&n)<<18|a<<12|h<<6|63&e[t++>>>0])<65536)o+=String.fromCharCode(n);else {var l=n-65536;o+=String.fromCharCode(55296|l>>10,56320|1023&l);}}else o+=String.fromCharCode((31&n)<<6|a);}else o+=String.fromCharCode(n);}return o}function A(e,t){return (e>>>=0)?D(S,e,t):""}function C(e,t,s,i){if(!(i>0))return 0;for(var r=s>>>=0,o=s+i-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),a<=127){if(s>=o)break;t[s++>>>0]=a;}else if(a<=2047){if(s+1>=o)break;t[s++>>>0]=192|a>>6,t[s++>>>0]=128|63&a;}else if(a<=65535){if(s+2>=o)break;t[s++>>>0]=224|a>>12,t[s++>>>0]=128|a>>6&63,t[s++>>>0]=128|63&a;}else {if(s+3>=o)break;t[s++>>>0]=240|a>>18,t[s++>>>0]=128|a>>12&63,t[s++>>>0]=128|a>>6&63,t[s++>>>0]=128|63&a;}}return t[s>>>0]=0,s-r}function I(e,t,s){return C(e,S,t,s)}function F(e){for(var t=0,s=0;s<e.length;++s){var i=e.charCodeAt(s);i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++s)),i<=127?++t:t+=i<=2047?2:i<=65535?3:4;}return t}var B,E,S,R,O,L,N,k,j,G="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function H(e,t){for(var s=e,i=s>>1,r=i+t/2;!(i>=r)&&O[i>>>0];)++i;if((s=i<<1)-e>32&&G)return G.decode(S.subarray(e>>>0,s>>>0));for(var o="",n=0;!(n>=t/2);++n){var a=R[e+2*n>>>1];if(0==a)break;o+=String.fromCharCode(a);}return o}function V(e,t,s){if(void 0===s&&(s=2147483647),s<2)return 0;for(var i=t,r=(s-=2)<2*e.length?s/2:e.length,o=0;o<r;++o){var n=e.charCodeAt(o);R[t>>>1]=n,t+=2;}return R[t>>>1]=0,t-i}function U(e){return 2*e.length}function z(e,t){for(var s=0,i="";!(s>=t/4);){var r=L[e+4*s>>>2];if(0==r)break;if(++s,r>=65536){var o=r-65536;i+=String.fromCharCode(55296|o>>10,56320|1023&o);}else i+=String.fromCharCode(r);}return i}function W(e,t,s){if(void 0===s&&(s=2147483647),s<4)return 0;for(var i=t>>>=0,r=i+s-4,o=0;o<e.length;++o){var n=e.charCodeAt(o);if(n>=55296&&n<=57343&&(n=65536+((1023&n)<<10)|1023&e.charCodeAt(++o)),L[t>>>2]=n,(t+=4)+4>r)break}return L[t>>>2]=0,t-i}function X(e){for(var t=0,s=0;s<e.length;++s){var i=e.charCodeAt(s);i>=55296&&i<=57343&&++s,t+=4;}return t}function Y(e,t){return e%t>0&&(e+=t-e%t),e}function K(e){B=e,r.HEAP8=E=new Int8Array(e),r.HEAP16=R=new Int16Array(e),r.HEAP32=L=new Int32Array(e),r.HEAPU8=S=new Uint8Array(e),r.HEAPU16=O=new Uint16Array(e),r.HEAPU32=N=new Uint32Array(e),r.HEAPF32=k=new Float32Array(e),r.HEAPF64=j=new Float64Array(e);}var J,Z=r.INITIAL_MEMORY||16777216;(b=r.wasmMemory?r.wasmMemory:new WebAssembly.Memory({initial:Z/65536,maximum:65536}))&&(B=b.buffer),Z=B.byteLength,K(B);var Q=[],q=[],$=[],ee=[],te=0,se=null;function ie(e){te++,r.monitorRunDependencies&&r.monitorRunDependencies(te);}function re(e){if(te--,r.monitorRunDependencies&&r.monitorRunDependencies(te),0==te&&se){var t=se;se=null,t();}}function oe(e){r.onAbort&&r.onAbort(e),P(e+=""),T=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}function ne(e,t){return String.prototype.startsWith?e.startsWith(t):0===e.indexOf(t)}function ae(e){return ne(e,"data:application/octet-stream;base64,")}function he(e){return ne(e,"file://")}r.preloadedImages={},r.preloadedAudios={};var le,ue,ce="web-ifc.wasm";function pe(){try{if(y)return new Uint8Array(y);if(f)return f(ce);throw "both async and sync fetching of the wasm failed"}catch(e){oe(e);}}function de(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var s=t.func;"number"==typeof s?void 0===t.arg?J.get(s)():J.get(s)(t.arg):s(void 0===t.arg?null:t.arg);}else t(r);}}function fe(e,t,s){return -1!=e.indexOf("j")?function(e,t,s){return s&&s.length?r["dynCall_"+e].apply(null,[t].concat(s)):r["dynCall_"+e].call(null,t)}(e,t,s):J.get(t).apply(null,s)}ae(ce)||(ce=function(e){return r.locateFile?r.locateFile(e,_):_+e}(ce));var me=0,ge=4,_e=8,ye=12,ve=13,be=16;function we(e){this.excPtr=e,this.ptr=e-be,this.set_type=function(e){L[this.ptr+_e>>>2]=e;},this.get_type=function(){return L[this.ptr+_e>>>2]},this.set_destructor=function(e){L[this.ptr+me>>>2]=e;},this.get_destructor=function(){return L[this.ptr+me>>>2]},this.set_refcount=function(e){L[this.ptr+ge>>>2]=e;},this.set_caught=function(e){e=e?1:0,E[this.ptr+ye>>>0]=e;},this.get_caught=function(){return 0!=E[this.ptr+ye>>>0]},this.set_rethrown=function(e){e=e?1:0,E[this.ptr+ve>>>0]=e;},this.get_rethrown=function(){return 0!=E[this.ptr+ve>>>0]},this.init=function(e,t){this.set_type(e),this.set_destructor(t),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1);},this.add_ref=function(){var e=L[this.ptr+ge>>>2];L[this.ptr+ge>>>2]=e+1;},this.release_ref=function(){var e=L[this.ptr+ge>>>2];return L[this.ptr+ge>>>2]=e-1,1===e};}var Pe={splitPath:function(e){return /^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1)},normalizeArray:function(e,t){for(var s=0,i=e.length-1;i>=0;i--){var r=e[i];"."===r?e.splice(i,1):".."===r?(e.splice(i,1),s++):s&&(e.splice(i,1),s--);}if(t)for(;s;s--)e.unshift("..");return e},normalize:function(e){var t="/"===e.charAt(0),s="/"===e.substr(-1);return e=Pe.normalizeArray(e.split("/").filter((function(e){return !!e})),!t).join("/"),e||t||(e="."),e&&s&&(e+="/"),(t?"/":"")+e},dirname:function(e){var t=Pe.splitPath(e),s=t[0],i=t[1];return s||i?(i&&(i=i.substr(0,i.length-1)),s+i):"."},basename:function(e){if("/"===e)return "/";var t=(e=(e=Pe.normalize(e)).replace(/\/$/,"")).lastIndexOf("/");return -1===t?e:e.substr(t+1)},extname:function(e){return Pe.splitPath(e)[3]},join:function(){var e=Array.prototype.slice.call(arguments,0);return Pe.normalize(e.join("/"))},join2:function(e,t){return Pe.normalize(e+"/"+t)}},Te={resolve:function(){for(var e="",t=!1,s=arguments.length-1;s>=-1&&!t;s--){var i=s>=0?arguments[s]:Ae.cwd();if("string"!=typeof i)throw new TypeError("Arguments to path.resolve must be strings");if(!i)return "";e=i+"/"+e,t="/"===i.charAt(0);}return e=Pe.normalizeArray(e.split("/").filter((function(e){return !!e})),!t).join("/"),(t?"/":"")+e||"."},relative:function(e,t){function s(e){for(var t=0;t<e.length&&""===e[t];t++);for(var s=e.length-1;s>=0&&""===e[s];s--);return t>s?[]:e.slice(t,s-t+1)}e=Te.resolve(e).substr(1),t=Te.resolve(t).substr(1);for(var i=s(e.split("/")),r=s(t.split("/")),o=Math.min(i.length,r.length),n=o,a=0;a<o;a++)if(i[a]!==r[a]){n=a;break}var h=[];for(a=n;a<i.length;a++)h.push("..");return (h=h.concat(r.slice(n))).join("/")}},xe={ttys:[],init:function(){},shutdown:function(){},register:function(e,t){xe.ttys[e]={input:[],output:[],ops:t},Ae.registerDevice(e,xe.stream_ops);},stream_ops:{open:function(e){var t=xe.ttys[e.node.rdev];if(!t)throw new Ae.ErrnoError(43);e.tty=t,e.seekable=!1;},close:function(e){e.tty.ops.flush(e.tty);},flush:function(e){e.tty.ops.flush(e.tty);},read:function(e,t,s,i,r){if(!e.tty||!e.tty.ops.get_char)throw new Ae.ErrnoError(60);for(var o=0,n=0;n<i;n++){var a;try{a=e.tty.ops.get_char(e.tty);}catch(e){throw new Ae.ErrnoError(29)}if(void 0===a&&0===o)throw new Ae.ErrnoError(6);if(null==a)break;o++,t[s+n]=a;}return o&&(e.node.timestamp=Date.now()),o},write:function(e,t,s,i,r){if(!e.tty||!e.tty.ops.put_char)throw new Ae.ErrnoError(60);try{for(var o=0;o<i;o++)e.tty.ops.put_char(e.tty,t[s+o]);}catch(e){throw new Ae.ErrnoError(29)}return i&&(e.node.timestamp=Date.now()),o}},default_tty_ops:{get_char:function(e){if(!e.input.length){var t=null;if(l){var s=Buffer.alloc?Buffer.alloc(256):new Buffer(256),i=0;try{i=m.readSync(process.stdin.fd,s,0,256,null);}catch(e){if(-1==e.toString().indexOf("EOF"))throw e;i=0;}t=i>0?s.slice(0,i).toString("utf-8"):null;}else "undefined"!=typeof window&&"function"==typeof window.prompt?null!==(t=window.prompt("Input: "))&&(t+="\n"):"function"==typeof readline&&null!==(t=readline())&&(t+="\n");if(!t)return null;e.input=us(t,!0);}return e.input.shift()},put_char:function(e,t){null===t||10===t?(w(D(e.output,0)),e.output=[]):0!=t&&e.output.push(t);},flush:function(e){e.output&&e.output.length>0&&(w(D(e.output,0)),e.output=[]);}},default_tty1_ops:{put_char:function(e,t){null===t||10===t?(P(D(e.output,0)),e.output=[]):0!=t&&e.output.push(t);},flush:function(e){e.output&&e.output.length>0&&(P(D(e.output,0)),e.output=[]);}}};function Me(e){for(var t=function(e,t){return t||(t=16),Math.ceil(e/t)*t}(e,16384),s=ds(t);e<t;)E[s+e++>>>0]=0;return s}var De={ops_table:null,mount:function(e){return De.createNode(null,"/",16895,0)},createNode:function(e,t,s,i){if(Ae.isBlkdev(s)||Ae.isFIFO(s))throw new Ae.ErrnoError(63);De.ops_table||(De.ops_table={dir:{node:{getattr:De.node_ops.getattr,setattr:De.node_ops.setattr,lookup:De.node_ops.lookup,mknod:De.node_ops.mknod,rename:De.node_ops.rename,unlink:De.node_ops.unlink,rmdir:De.node_ops.rmdir,readdir:De.node_ops.readdir,symlink:De.node_ops.symlink},stream:{llseek:De.stream_ops.llseek}},file:{node:{getattr:De.node_ops.getattr,setattr:De.node_ops.setattr},stream:{llseek:De.stream_ops.llseek,read:De.stream_ops.read,write:De.stream_ops.write,allocate:De.stream_ops.allocate,mmap:De.stream_ops.mmap,msync:De.stream_ops.msync}},link:{node:{getattr:De.node_ops.getattr,setattr:De.node_ops.setattr,readlink:De.node_ops.readlink},stream:{}},chrdev:{node:{getattr:De.node_ops.getattr,setattr:De.node_ops.setattr},stream:Ae.chrdev_stream_ops}});var r=Ae.createNode(e,t,s,i);return Ae.isDir(r.mode)?(r.node_ops=De.ops_table.dir.node,r.stream_ops=De.ops_table.dir.stream,r.contents={}):Ae.isFile(r.mode)?(r.node_ops=De.ops_table.file.node,r.stream_ops=De.ops_table.file.stream,r.usedBytes=0,r.contents=null):Ae.isLink(r.mode)?(r.node_ops=De.ops_table.link.node,r.stream_ops=De.ops_table.link.stream):Ae.isChrdev(r.mode)&&(r.node_ops=De.ops_table.chrdev.node,r.stream_ops=De.ops_table.chrdev.stream),r.timestamp=Date.now(),e&&(e.contents[t]=r),r},getFileDataAsRegularArray:function(e){if(e.contents&&e.contents.subarray){for(var t=[],s=0;s<e.usedBytes;++s)t.push(e.contents[s]);return t}return e.contents},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0)},expandFileStorage:function(e,t){t>>>=0;var s=e.contents?e.contents.length:0;if(!(s>=t)){t=Math.max(t,s*(s<1048576?2:1.125)>>>0),0!=s&&(t=Math.max(t,256));var i=e.contents;e.contents=new Uint8Array(t),e.usedBytes>0&&e.contents.set(i.subarray(0,e.usedBytes),0);}},resizeFileStorage:function(e,t){if(t>>>=0,e.usedBytes!=t){if(0==t)return e.contents=null,void(e.usedBytes=0);if(!e.contents||e.contents.subarray){var s=e.contents;return e.contents=new Uint8Array(t),s&&e.contents.set(s.subarray(0,Math.min(t,e.usedBytes))),void(e.usedBytes=t)}if(e.contents||(e.contents=[]),e.contents.length>t)e.contents.length=t;else for(;e.contents.length<t;)e.contents.push(0);e.usedBytes=t;}},node_ops:{getattr:function(e){var t={};return t.dev=Ae.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,Ae.isDir(e.mode)?t.size=4096:Ae.isFile(e.mode)?t.size=e.usedBytes:Ae.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr:function(e,t){void 0!==t.mode&&(e.mode=t.mode),void 0!==t.timestamp&&(e.timestamp=t.timestamp),void 0!==t.size&&De.resizeFileStorage(e,t.size);},lookup:function(e,t){throw Ae.genericErrors[44]},mknod:function(e,t,s,i){return De.createNode(e,t,s,i)},rename:function(e,t,s){if(Ae.isDir(e.mode)){var i;try{i=Ae.lookupNode(t,s);}catch(e){}if(i)for(var r in i.contents)throw new Ae.ErrnoError(55)}delete e.parent.contents[e.name],e.name=s,t.contents[s]=e,e.parent=t;},unlink:function(e,t){delete e.contents[t];},rmdir:function(e,t){var s=Ae.lookupNode(e,t);for(var i in s.contents)throw new Ae.ErrnoError(55);delete e.contents[t];},readdir:function(e){var t=[".",".."];for(var s in e.contents)e.contents.hasOwnProperty(s)&&t.push(s);return t},symlink:function(e,t,s){var i=De.createNode(e,t,41471,0);return i.link=s,i},readlink:function(e){if(!Ae.isLink(e.mode))throw new Ae.ErrnoError(28);return e.link}},stream_ops:{read:function(e,t,s,i,r){var o=e.node.contents;if(r>=e.node.usedBytes)return 0;var n=Math.min(e.node.usedBytes-r,i);if(n>8&&o.subarray)t.set(o.subarray(r,r+n),s);else for(var a=0;a<n;a++)t[s+a]=o[r+a];return n},write:function(e,t,s,i,r,o){if(t.buffer===E.buffer&&(o=!1),!i)return 0;var n=e.node;if(n.timestamp=Date.now(),t.subarray&&(!n.contents||n.contents.subarray)){if(o)return n.contents=t.subarray(s,s+i),n.usedBytes=i,i;if(0===n.usedBytes&&0===r)return n.contents=t.slice(s,s+i),n.usedBytes=i,i;if(r+i<=n.usedBytes)return n.contents.set(t.subarray(s,s+i),r),i}if(De.expandFileStorage(n,r+i),n.contents.subarray&&t.subarray)n.contents.set(t.subarray(s,s+i),r);else for(var a=0;a<i;a++)n.contents[r+a]=t[s+a];return n.usedBytes=Math.max(n.usedBytes,r+i),i},llseek:function(e,t,s){var i=t;if(1===s?i+=e.position:2===s&&Ae.isFile(e.node.mode)&&(i+=e.node.usedBytes),i<0)throw new Ae.ErrnoError(28);return i},allocate:function(e,t,s){De.expandFileStorage(e.node,t+s),e.node.usedBytes=Math.max(e.node.usedBytes,t+s);},mmap:function(e,t,s,i,r,o){if(x(0===t),!Ae.isFile(e.node.mode))throw new Ae.ErrnoError(43);var n,a,h=e.node.contents;if(2&o||h.buffer!==B){if((i>0||i+s<h.length)&&(h=h.subarray?h.subarray(i,i+s):Array.prototype.slice.call(h,i,i+s)),a=!0,!(n=Me(s)))throw new Ae.ErrnoError(48);n>>>=0,E.set(h,n>>>0);}else a=!1,n=h.byteOffset;return {ptr:n,allocated:a}},msync:function(e,t,s,i,r){if(!Ae.isFile(e.node.mode))throw new Ae.ErrnoError(43);return 2&r||De.stream_ops.write(e,t,0,i,s,!1),0}}},Ae={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,trackingDelegate:{},tracking:{openFlags:{READ:1,WRITE:2}},ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:function(e,t){if(t=t||{},!(e=Te.resolve(Ae.cwd(),e)))return {path:"",node:null};var s={follow_mount:!0,recurse_count:0};for(var i in s)void 0===t[i]&&(t[i]=s[i]);if(t.recurse_count>8)throw new Ae.ErrnoError(32);for(var r=Pe.normalizeArray(e.split("/").filter((function(e){return !!e})),!1),o=Ae.root,n="/",a=0;a<r.length;a++){var h=a===r.length-1;if(h&&t.parent)break;if(o=Ae.lookupNode(o,r[a]),n=Pe.join2(n,r[a]),Ae.isMountpoint(o)&&(!h||h&&t.follow_mount)&&(o=o.mounted.root),!h||t.follow)for(var l=0;Ae.isLink(o.mode);){var u=Ae.readlink(n);if(n=Te.resolve(Pe.dirname(n),u),o=Ae.lookupPath(n,{recurse_count:t.recurse_count}).node,l++>40)throw new Ae.ErrnoError(32)}}return {path:n,node:o}},getPath:function(e){for(var t;;){if(Ae.isRoot(e)){var s=e.mount.mountpoint;return t?"/"!==s[s.length-1]?s+"/"+t:s+t:s}t=t?e.name+"/"+t:e.name,e=e.parent;}},hashName:function(e,t){for(var s=0,i=0;i<t.length;i++)s=(s<<5)-s+t.charCodeAt(i)|0;return (e+s>>>0)%Ae.nameTable.length},hashAddNode:function(e){var t=Ae.hashName(e.parent.id,e.name);e.name_next=Ae.nameTable[t],Ae.nameTable[t]=e;},hashRemoveNode:function(e){var t=Ae.hashName(e.parent.id,e.name);if(Ae.nameTable[t]===e)Ae.nameTable[t]=e.name_next;else for(var s=Ae.nameTable[t];s;){if(s.name_next===e){s.name_next=e.name_next;break}s=s.name_next;}},lookupNode:function(e,t){var s=Ae.mayLookup(e);if(s)throw new Ae.ErrnoError(s,e);for(var i=Ae.hashName(e.id,t),r=Ae.nameTable[i];r;r=r.name_next){var o=r.name;if(r.parent.id===e.id&&o===t)return r}return Ae.lookup(e,t)},createNode:function(e,t,s,i){var r=new Ae.FSNode(e,t,s,i);return Ae.hashAddNode(r),r},destroyNode:function(e){Ae.hashRemoveNode(e);},isRoot:function(e){return e===e.parent},isMountpoint:function(e){return !!e.mounted},isFile:function(e){return 32768==(61440&e)},isDir:function(e){return 16384==(61440&e)},isLink:function(e){return 40960==(61440&e)},isChrdev:function(e){return 8192==(61440&e)},isBlkdev:function(e){return 24576==(61440&e)},isFIFO:function(e){return 4096==(61440&e)},isSocket:function(e){return 49152==(49152&e)},flagModes:{r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},modeStringToFlags:function(e){var t=Ae.flagModes[e];if(void 0===t)throw new Error("Unknown file open mode: "+e);return t},flagsToPermissionString:function(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t},nodePermissions:function(e,t){return Ae.ignorePermissions||(-1===t.indexOf("r")||292&e.mode)&&(-1===t.indexOf("w")||146&e.mode)&&(-1===t.indexOf("x")||73&e.mode)?0:2},mayLookup:function(e){var t=Ae.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:2)},mayCreate:function(e,t){try{return Ae.lookupNode(e,t),20}catch(e){}return Ae.nodePermissions(e,"wx")},mayDelete:function(e,t,s){var i;try{i=Ae.lookupNode(e,t);}catch(e){return e.errno}var r=Ae.nodePermissions(e,"wx");if(r)return r;if(s){if(!Ae.isDir(i.mode))return 54;if(Ae.isRoot(i)||Ae.getPath(i)===Ae.cwd())return 10}else if(Ae.isDir(i.mode))return 31;return 0},mayOpen:function(e,t){return e?Ae.isLink(e.mode)?32:Ae.isDir(e.mode)&&("r"!==Ae.flagsToPermissionString(t)||512&t)?31:Ae.nodePermissions(e,Ae.flagsToPermissionString(t)):44},MAX_OPEN_FDS:4096,nextfd:function(e,t){e=e||0,t=t||Ae.MAX_OPEN_FDS;for(var s=e;s<=t;s++)if(!Ae.streams[s])return s;throw new Ae.ErrnoError(33)},getStream:function(e){return Ae.streams[e]},createStream:function(e,t,s){Ae.FSStream||(Ae.FSStream=function(){},Ae.FSStream.prototype={object:{get:function(){return this.node},set:function(e){this.node=e;}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}}});var i=new Ae.FSStream;for(var r in e)i[r]=e[r];e=i;var o=Ae.nextfd(t,s);return e.fd=o,Ae.streams[o]=e,e},closeStream:function(e){Ae.streams[e]=null;},chrdev_stream_ops:{open:function(e){var t=Ae.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open&&e.stream_ops.open(e);},llseek:function(){throw new Ae.ErrnoError(70)}},major:function(e){return e>>8},minor:function(e){return 255&e},makedev:function(e,t){return e<<8|t},registerDevice:function(e,t){Ae.devices[e]={stream_ops:t};},getDevice:function(e){return Ae.devices[e]},getMounts:function(e){for(var t=[],s=[e];s.length;){var i=s.pop();t.push(i),s.push.apply(s,i.mounts);}return t},syncfs:function(e,t){"function"==typeof e&&(t=e,e=!1),Ae.syncFSRequests++,Ae.syncFSRequests>1&&P("warning: "+Ae.syncFSRequests+" FS.syncfs operations in flight at once, probably just doing extra work");var s=Ae.getMounts(Ae.root.mount),i=0;function r(e){return Ae.syncFSRequests--,t(e)}function o(e){if(e)return o.errored?void 0:(o.errored=!0,r(e));++i>=s.length&&r(null);}s.forEach((function(t){if(!t.type.syncfs)return o(null);t.type.syncfs(t,e,o);}));},mount:function(e,t,s){var i,r="/"===s,o=!s;if(r&&Ae.root)throw new Ae.ErrnoError(10);if(!r&&!o){var n=Ae.lookupPath(s,{follow_mount:!1});if(s=n.path,i=n.node,Ae.isMountpoint(i))throw new Ae.ErrnoError(10);if(!Ae.isDir(i.mode))throw new Ae.ErrnoError(54)}var a={type:e,opts:t,mountpoint:s,mounts:[]},h=e.mount(a);return h.mount=a,a.root=h,r?Ae.root=h:i&&(i.mounted=a,i.mount&&i.mount.mounts.push(a)),h},unmount:function(e){var t=Ae.lookupPath(e,{follow_mount:!1});if(!Ae.isMountpoint(t.node))throw new Ae.ErrnoError(28);var s=t.node,i=s.mounted,r=Ae.getMounts(i);Object.keys(Ae.nameTable).forEach((function(e){for(var t=Ae.nameTable[e];t;){var s=t.name_next;-1!==r.indexOf(t.mount)&&Ae.destroyNode(t),t=s;}})),s.mounted=null;var o=s.mount.mounts.indexOf(i);s.mount.mounts.splice(o,1);},lookup:function(e,t){return e.node_ops.lookup(e,t)},mknod:function(e,t,s){var i=Ae.lookupPath(e,{parent:!0}).node,r=Pe.basename(e);if(!r||"."===r||".."===r)throw new Ae.ErrnoError(28);var o=Ae.mayCreate(i,r);if(o)throw new Ae.ErrnoError(o);if(!i.node_ops.mknod)throw new Ae.ErrnoError(63);return i.node_ops.mknod(i,r,t,s)},create:function(e,t){return t=void 0!==t?t:438,t&=4095,t|=32768,Ae.mknod(e,t,0)},mkdir:function(e,t){return t=void 0!==t?t:511,t&=1023,t|=16384,Ae.mknod(e,t,0)},mkdirTree:function(e,t){for(var s=e.split("/"),i="",r=0;r<s.length;++r)if(s[r]){i+="/"+s[r];try{Ae.mkdir(i,t);}catch(e){if(20!=e.errno)throw e}}},mkdev:function(e,t,s){return void 0===s&&(s=t,t=438),t|=8192,Ae.mknod(e,t,s)},symlink:function(e,t){if(!Te.resolve(e))throw new Ae.ErrnoError(44);var s=Ae.lookupPath(t,{parent:!0}).node;if(!s)throw new Ae.ErrnoError(44);var i=Pe.basename(t),r=Ae.mayCreate(s,i);if(r)throw new Ae.ErrnoError(r);if(!s.node_ops.symlink)throw new Ae.ErrnoError(63);return s.node_ops.symlink(s,i,e)},rename:function(e,t){var s,i,r=Pe.dirname(e),o=Pe.dirname(t),n=Pe.basename(e),a=Pe.basename(t);if(s=Ae.lookupPath(e,{parent:!0}).node,i=Ae.lookupPath(t,{parent:!0}).node,!s||!i)throw new Ae.ErrnoError(44);if(s.mount!==i.mount)throw new Ae.ErrnoError(75);var h,l=Ae.lookupNode(s,n),u=Te.relative(e,o);if("."!==u.charAt(0))throw new Ae.ErrnoError(28);if("."!==(u=Te.relative(t,r)).charAt(0))throw new Ae.ErrnoError(55);try{h=Ae.lookupNode(i,a);}catch(e){}if(l!==h){var c=Ae.isDir(l.mode),p=Ae.mayDelete(s,n,c);if(p)throw new Ae.ErrnoError(p);if(p=h?Ae.mayDelete(i,a,c):Ae.mayCreate(i,a))throw new Ae.ErrnoError(p);if(!s.node_ops.rename)throw new Ae.ErrnoError(63);if(Ae.isMountpoint(l)||h&&Ae.isMountpoint(h))throw new Ae.ErrnoError(10);if(i!==s&&(p=Ae.nodePermissions(s,"w")))throw new Ae.ErrnoError(p);try{Ae.trackingDelegate.willMovePath&&Ae.trackingDelegate.willMovePath(e,t);}catch(s){P("FS.trackingDelegate['willMovePath']('"+e+"', '"+t+"') threw an exception: "+s.message);}Ae.hashRemoveNode(l);try{s.node_ops.rename(l,i,a);}catch(e){throw e}finally{Ae.hashAddNode(l);}try{Ae.trackingDelegate.onMovePath&&Ae.trackingDelegate.onMovePath(e,t);}catch(s){P("FS.trackingDelegate['onMovePath']('"+e+"', '"+t+"') threw an exception: "+s.message);}}},rmdir:function(e){var t=Ae.lookupPath(e,{parent:!0}).node,s=Pe.basename(e),i=Ae.lookupNode(t,s),r=Ae.mayDelete(t,s,!0);if(r)throw new Ae.ErrnoError(r);if(!t.node_ops.rmdir)throw new Ae.ErrnoError(63);if(Ae.isMountpoint(i))throw new Ae.ErrnoError(10);try{Ae.trackingDelegate.willDeletePath&&Ae.trackingDelegate.willDeletePath(e);}catch(t){P("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message);}t.node_ops.rmdir(t,s),Ae.destroyNode(i);try{Ae.trackingDelegate.onDeletePath&&Ae.trackingDelegate.onDeletePath(e);}catch(t){P("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message);}},readdir:function(e){var t=Ae.lookupPath(e,{follow:!0}).node;if(!t.node_ops.readdir)throw new Ae.ErrnoError(54);return t.node_ops.readdir(t)},unlink:function(e){var t=Ae.lookupPath(e,{parent:!0}).node,s=Pe.basename(e),i=Ae.lookupNode(t,s),r=Ae.mayDelete(t,s,!1);if(r)throw new Ae.ErrnoError(r);if(!t.node_ops.unlink)throw new Ae.ErrnoError(63);if(Ae.isMountpoint(i))throw new Ae.ErrnoError(10);try{Ae.trackingDelegate.willDeletePath&&Ae.trackingDelegate.willDeletePath(e);}catch(t){P("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message);}t.node_ops.unlink(t,s),Ae.destroyNode(i);try{Ae.trackingDelegate.onDeletePath&&Ae.trackingDelegate.onDeletePath(e);}catch(t){P("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message);}},readlink:function(e){var t=Ae.lookupPath(e).node;if(!t)throw new Ae.ErrnoError(44);if(!t.node_ops.readlink)throw new Ae.ErrnoError(28);return Te.resolve(Ae.getPath(t.parent),t.node_ops.readlink(t))},stat:function(e,t){var s=Ae.lookupPath(e,{follow:!t}).node;if(!s)throw new Ae.ErrnoError(44);if(!s.node_ops.getattr)throw new Ae.ErrnoError(63);return s.node_ops.getattr(s)},lstat:function(e){return Ae.stat(e,!0)},chmod:function(e,t,s){var i;if(!(i="string"==typeof e?Ae.lookupPath(e,{follow:!s}).node:e).node_ops.setattr)throw new Ae.ErrnoError(63);i.node_ops.setattr(i,{mode:4095&t|-4096&i.mode,timestamp:Date.now()});},lchmod:function(e,t){Ae.chmod(e,t,!0);},fchmod:function(e,t){var s=Ae.getStream(e);if(!s)throw new Ae.ErrnoError(8);Ae.chmod(s.node,t);},chown:function(e,t,s,i){var r;if(!(r="string"==typeof e?Ae.lookupPath(e,{follow:!i}).node:e).node_ops.setattr)throw new Ae.ErrnoError(63);r.node_ops.setattr(r,{timestamp:Date.now()});},lchown:function(e,t,s){Ae.chown(e,t,s,!0);},fchown:function(e,t,s){var i=Ae.getStream(e);if(!i)throw new Ae.ErrnoError(8);Ae.chown(i.node,t,s);},truncate:function(e,t){if(t<0)throw new Ae.ErrnoError(28);var s;if(!(s="string"==typeof e?Ae.lookupPath(e,{follow:!0}).node:e).node_ops.setattr)throw new Ae.ErrnoError(63);if(Ae.isDir(s.mode))throw new Ae.ErrnoError(31);if(!Ae.isFile(s.mode))throw new Ae.ErrnoError(28);var i=Ae.nodePermissions(s,"w");if(i)throw new Ae.ErrnoError(i);s.node_ops.setattr(s,{size:t,timestamp:Date.now()});},ftruncate:function(e,t){var s=Ae.getStream(e);if(!s)throw new Ae.ErrnoError(8);if(0==(2097155&s.flags))throw new Ae.ErrnoError(28);Ae.truncate(s.node,t);},utime:function(e,t,s){var i=Ae.lookupPath(e,{follow:!0}).node;i.node_ops.setattr(i,{timestamp:Math.max(t,s)});},open:function(e,t,s,i,o){if(""===e)throw new Ae.ErrnoError(44);var n;if(s=void 0===s?438:s,s=64&(t="string"==typeof t?Ae.modeStringToFlags(t):t)?4095&s|32768:0,"object"==typeof e)n=e;else {e=Pe.normalize(e);try{n=Ae.lookupPath(e,{follow:!(131072&t)}).node;}catch(e){}}var a=!1;if(64&t)if(n){if(128&t)throw new Ae.ErrnoError(20)}else n=Ae.mknod(e,s,0),a=!0;if(!n)throw new Ae.ErrnoError(44);if(Ae.isChrdev(n.mode)&&(t&=-513),65536&t&&!Ae.isDir(n.mode))throw new Ae.ErrnoError(54);if(!a){var h=Ae.mayOpen(n,t);if(h)throw new Ae.ErrnoError(h)}512&t&&Ae.truncate(n,0),t&=-131713;var l=Ae.createStream({node:n,path:Ae.getPath(n),flags:t,seekable:!0,position:0,stream_ops:n.stream_ops,ungotten:[],error:!1},i,o);l.stream_ops.open&&l.stream_ops.open(l),!r.logReadFiles||1&t||(Ae.readFiles||(Ae.readFiles={}),e in Ae.readFiles||(Ae.readFiles[e]=1,P("FS.trackingDelegate error on read file: "+e)));try{if(Ae.trackingDelegate.onOpenFile){var u=0;1!=(2097155&t)&&(u|=Ae.tracking.openFlags.READ),0!=(2097155&t)&&(u|=Ae.tracking.openFlags.WRITE),Ae.trackingDelegate.onOpenFile(e,u);}}catch(t){P("FS.trackingDelegate['onOpenFile']('"+e+"', flags) threw an exception: "+t.message);}return l},close:function(e){if(Ae.isClosed(e))throw new Ae.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e);}catch(e){throw e}finally{Ae.closeStream(e.fd);}e.fd=null;},isClosed:function(e){return null===e.fd},llseek:function(e,t,s){if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new Ae.ErrnoError(70);if(0!=s&&1!=s&&2!=s)throw new Ae.ErrnoError(28);return e.position=e.stream_ops.llseek(e,t,s),e.ungotten=[],e.position},read:function(e,t,s,i,r){if(s>>>=0,i<0||r<0)throw new Ae.ErrnoError(28);if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(1==(2097155&e.flags))throw new Ae.ErrnoError(8);if(Ae.isDir(e.node.mode))throw new Ae.ErrnoError(31);if(!e.stream_ops.read)throw new Ae.ErrnoError(28);var o=void 0!==r;if(o){if(!e.seekable)throw new Ae.ErrnoError(70)}else r=e.position;var n=e.stream_ops.read(e,t,s,i,r);return o||(e.position+=n),n},write:function(e,t,s,i,r,o){if(s>>>=0,i<0||r<0)throw new Ae.ErrnoError(28);if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(0==(2097155&e.flags))throw new Ae.ErrnoError(8);if(Ae.isDir(e.node.mode))throw new Ae.ErrnoError(31);if(!e.stream_ops.write)throw new Ae.ErrnoError(28);e.seekable&&1024&e.flags&&Ae.llseek(e,0,2);var n=void 0!==r;if(n){if(!e.seekable)throw new Ae.ErrnoError(70)}else r=e.position;var a=e.stream_ops.write(e,t,s,i,r,o);n||(e.position+=a);try{e.path&&Ae.trackingDelegate.onWriteToFile&&Ae.trackingDelegate.onWriteToFile(e.path);}catch(t){P("FS.trackingDelegate['onWriteToFile']('"+e.path+"') threw an exception: "+t.message);}return a},allocate:function(e,t,s){if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(t<0||s<=0)throw new Ae.ErrnoError(28);if(0==(2097155&e.flags))throw new Ae.ErrnoError(8);if(!Ae.isFile(e.node.mode)&&!Ae.isDir(e.node.mode))throw new Ae.ErrnoError(43);if(!e.stream_ops.allocate)throw new Ae.ErrnoError(138);e.stream_ops.allocate(e,t,s);},mmap:function(e,t,s,i,r,o){if(t>>>=0,0!=(2&r)&&0==(2&o)&&2!=(2097155&e.flags))throw new Ae.ErrnoError(2);if(1==(2097155&e.flags))throw new Ae.ErrnoError(2);if(!e.stream_ops.mmap)throw new Ae.ErrnoError(43);return e.stream_ops.mmap(e,t,s,i,r,o)},msync:function(e,t,s,i,r){return s>>>=0,e&&e.stream_ops.msync?e.stream_ops.msync(e,t,s,i,r):0},munmap:function(e){return 0},ioctl:function(e,t,s){if(!e.stream_ops.ioctl)throw new Ae.ErrnoError(59);return e.stream_ops.ioctl(e,t,s)},readFile:function(e,t){if((t=t||{}).flags=t.flags||0,t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error('Invalid encoding type "'+t.encoding+'"');var s,i=Ae.open(e,t.flags),r=Ae.stat(e).size,o=new Uint8Array(r);return Ae.read(i,o,0,r,0),"utf8"===t.encoding?s=D(o,0):"binary"===t.encoding&&(s=o),Ae.close(i),s},writeFile:function(e,t,s){(s=s||{}).flags=s.flags||577;var i=Ae.open(e,s.flags,s.mode);if("string"==typeof t){var r=new Uint8Array(F(t)+1),o=C(t,r,0,r.length);Ae.write(i,r,0,o,void 0,s.canOwn);}else {if(!ArrayBuffer.isView(t))throw new Error("Unsupported data type");Ae.write(i,t,0,t.byteLength,void 0,s.canOwn);}Ae.close(i);},cwd:function(){return Ae.currentPath},chdir:function(e){var t=Ae.lookupPath(e,{follow:!0});if(null===t.node)throw new Ae.ErrnoError(44);if(!Ae.isDir(t.node.mode))throw new Ae.ErrnoError(54);var s=Ae.nodePermissions(t.node,"x");if(s)throw new Ae.ErrnoError(s);Ae.currentPath=t.path;},createDefaultDirectories:function(){Ae.mkdir("/tmp"),Ae.mkdir("/home"),Ae.mkdir("/home/web_user");},createDefaultDevices:function(){Ae.mkdir("/dev"),Ae.registerDevice(Ae.makedev(1,3),{read:function(){return 0},write:function(e,t,s,i,r){return i}}),Ae.mkdev("/dev/null",Ae.makedev(1,3)),xe.register(Ae.makedev(5,0),xe.default_tty_ops),xe.register(Ae.makedev(6,0),xe.default_tty1_ops),Ae.mkdev("/dev/tty",Ae.makedev(5,0)),Ae.mkdev("/dev/tty1",Ae.makedev(6,0));var e=function(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues){var e=new Uint8Array(1);return function(){return crypto.getRandomValues(e),e[0]}}if(l)try{var t=x_();return function(){return t.randomBytes(1)[0]}}catch(e){}return function(){oe("randomDevice");}}();Ae.createDevice("/dev","random",e),Ae.createDevice("/dev","urandom",e),Ae.mkdir("/dev/shm"),Ae.mkdir("/dev/shm/tmp");},createSpecialDirectories:function(){Ae.mkdir("/proc"),Ae.mkdir("/proc/self"),Ae.mkdir("/proc/self/fd"),Ae.mount({mount:function(){var e=Ae.createNode("/proc/self","fd",16895,73);return e.node_ops={lookup:function(e,t){var s=+t,i=Ae.getStream(s);if(!i)throw new Ae.ErrnoError(8);var r={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:function(){return i.path}}};return r.parent=r,r}},e}},{},"/proc/self/fd");},createStandardStreams:function(){r.stdin?Ae.createDevice("/dev","stdin",r.stdin):Ae.symlink("/dev/tty","/dev/stdin"),r.stdout?Ae.createDevice("/dev","stdout",null,r.stdout):Ae.symlink("/dev/tty","/dev/stdout"),r.stderr?Ae.createDevice("/dev","stderr",null,r.stderr):Ae.symlink("/dev/tty1","/dev/stderr"),Ae.open("/dev/stdin",0),Ae.open("/dev/stdout",1),Ae.open("/dev/stderr",1);},ensureErrnoError:function(){Ae.ErrnoError||(Ae.ErrnoError=function(e,t){this.node=t,this.setErrno=function(e){this.errno=e;},this.setErrno(e),this.message="FS error";},Ae.ErrnoError.prototype=new Error,Ae.ErrnoError.prototype.constructor=Ae.ErrnoError,[44].forEach((function(e){Ae.genericErrors[e]=new Ae.ErrnoError(e),Ae.genericErrors[e].stack="<generic error, no stack>";})));},staticInit:function(){Ae.ensureErrnoError(),Ae.nameTable=new Array(4096),Ae.mount(De,{},"/"),Ae.createDefaultDirectories(),Ae.createDefaultDevices(),Ae.createSpecialDirectories(),Ae.filesystems={MEMFS:De};},init:function(e,t,s){Ae.init.initialized=!0,Ae.ensureErrnoError(),r.stdin=e||r.stdin,r.stdout=t||r.stdout,r.stderr=s||r.stderr,Ae.createStandardStreams();},quit:function(){Ae.init.initialized=!1;var e=r._fflush;e&&e(0);for(var t=0;t<Ae.streams.length;t++){var s=Ae.streams[t];s&&Ae.close(s);}},getMode:function(e,t){var s=0;return e&&(s|=365),t&&(s|=146),s},findObject:function(e,t){var s=Ae.analyzePath(e,t);return s.exists?s.object:null},analyzePath:function(e,t){try{e=(i=Ae.lookupPath(e,{follow:!t})).path;}catch(e){}var s={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var i=Ae.lookupPath(e,{parent:!0});s.parentExists=!0,s.parentPath=i.path,s.parentObject=i.node,s.name=Pe.basename(e),i=Ae.lookupPath(e,{follow:!t}),s.exists=!0,s.path=i.path,s.object=i.node,s.name=i.node.name,s.isRoot="/"===i.path;}catch(e){s.error=e.errno;}return s},createPath:function(e,t,s,i){e="string"==typeof e?e:Ae.getPath(e);for(var r=t.split("/").reverse();r.length;){var o=r.pop();if(o){var n=Pe.join2(e,o);try{Ae.mkdir(n);}catch(e){}e=n;}}return n},createFile:function(e,t,s,i,r){var o=Pe.join2("string"==typeof e?e:Ae.getPath(e),t),n=Ae.getMode(i,r);return Ae.create(o,n)},createDataFile:function(e,t,s,i,r,o){var n=t?Pe.join2("string"==typeof e?e:Ae.getPath(e),t):e,a=Ae.getMode(i,r),h=Ae.create(n,a);if(s){if("string"==typeof s){for(var l=new Array(s.length),u=0,c=s.length;u<c;++u)l[u]=s.charCodeAt(u);s=l;}Ae.chmod(h,146|a);var p=Ae.open(h,577);Ae.write(p,s,0,s.length,0,o),Ae.close(p),Ae.chmod(h,a);}return h},createDevice:function(e,t,s,i){var r=Pe.join2("string"==typeof e?e:Ae.getPath(e),t),o=Ae.getMode(!!s,!!i);Ae.createDevice.major||(Ae.createDevice.major=64);var n=Ae.makedev(Ae.createDevice.major++,0);return Ae.registerDevice(n,{open:function(e){e.seekable=!1;},close:function(e){i&&i.buffer&&i.buffer.length&&i(10);},read:function(e,t,i,r,o){for(var n=0,a=0;a<r;a++){var h;try{h=s();}catch(e){throw new Ae.ErrnoError(29)}if(void 0===h&&0===n)throw new Ae.ErrnoError(6);if(null==h)break;n++,t[i+a]=h;}return n&&(e.node.timestamp=Date.now()),n},write:function(e,t,s,r,o){for(var n=0;n<r;n++)try{i(t[s+n]);}catch(e){throw new Ae.ErrnoError(29)}return r&&(e.node.timestamp=Date.now()),n}}),Ae.mkdev(r,o,n)},forceLoadFile:function(e){if(e.isDevice||e.isFolder||e.link||e.contents)return !0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!d)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=us(d(e.url),!0),e.usedBytes=e.contents.length;}catch(e){throw new Ae.ErrnoError(29)}},createLazyFile:function(e,t,s,i,r){function o(){this.lengthKnown=!1,this.chunks=[];}if(o.prototype.get=function(e){if(!(e>this.length-1||e<0)){var t=e%this.chunkSize,s=e/this.chunkSize|0;return this.getter(s)[t]}},o.prototype.setDataGetter=function(e){this.getter=e;},o.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",s,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+s+". Status: "+e.status);var t,i=Number(e.getResponseHeader("Content-length")),r=(t=e.getResponseHeader("Accept-Ranges"))&&"bytes"===t,o=(t=e.getResponseHeader("Content-Encoding"))&&"gzip"===t,n=1048576;r||(n=i);var a=this;a.setDataGetter((function(e){var t=e*n,r=(e+1)*n-1;if(r=Math.min(r,i-1),void 0===a.chunks[e]&&(a.chunks[e]=function(e,t){if(e>t)throw new Error("invalid range ("+e+", "+t+") or no bytes requested!");if(t>i-1)throw new Error("only "+i+" bytes available! programmer error!");var r=new XMLHttpRequest;if(r.open("GET",s,!1),i!==n&&r.setRequestHeader("Range","bytes="+e+"-"+t),"undefined"!=typeof Uint8Array&&(r.responseType="arraybuffer"),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),!(r.status>=200&&r.status<300||304===r.status))throw new Error("Couldn't load "+s+". Status: "+r.status);return void 0!==r.response?new Uint8Array(r.response||[]):us(r.responseText||"",!0)}(t,r)),void 0===a.chunks[e])throw new Error("doXHR failed!");return a.chunks[e]})),!o&&i||(n=i=1,i=this.getter(0).length,n=i,w("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=i,this._chunkSize=n,this.lengthKnown=!0;},"undefined"!=typeof XMLHttpRequest){if(!h)throw "Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var n=new o;Object.defineProperties(n,{length:{get:function(){return this.lengthKnown||this.cacheLength(),this._length}},chunkSize:{get:function(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}});var a={isDevice:!1,contents:n};}else a={isDevice:!1,url:s};var l=Ae.createFile(e,t,a,i,r);a.contents?l.contents=a.contents:a.url&&(l.contents=null,l.url=a.url),Object.defineProperties(l,{usedBytes:{get:function(){return this.contents.length}}});var u={};return Object.keys(l.stream_ops).forEach((function(e){var t=l.stream_ops[e];u[e]=function(){return Ae.forceLoadFile(l),t.apply(null,arguments)};})),u.read=function(e,t,s,i,r){Ae.forceLoadFile(l);var o=e.node.contents;if(r>=o.length)return 0;var n=Math.min(o.length-r,i);if(o.slice)for(var a=0;a<n;a++)t[s+a]=o[r+a];else for(a=0;a<n;a++)t[s+a]=o.get(r+a);return n},l.stream_ops=u,l},createPreloadedFile:function(e,t,s,i,o,n,a,h,l,u){Browser.init();var c=t?Te.resolve(Pe.join2(e,t)):e;function p(s){function p(s){u&&u(),h||Ae.createDataFile(e,t,s,i,o,l),n&&n(),re();}var d=!1;r.preloadPlugins.forEach((function(e){d||e.canHandle(c)&&(e.handle(s,c,p,(function(){a&&a(),re();})),d=!0);})),d||p(s);}ie(),"string"==typeof s?Browser.asyncLoad(s,(function(e){p(e);}),a):p(s);},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return "EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(e,t,s){t=t||function(){},s=s||function(){};var i=Ae.indexedDB();try{var r=i.open(Ae.DB_NAME(),Ae.DB_VERSION);}catch(e){return s(e)}r.onupgradeneeded=function(){w("creating db"),r.result.createObjectStore(Ae.DB_STORE_NAME);},r.onsuccess=function(){var i=r.result.transaction([Ae.DB_STORE_NAME],"readwrite"),o=i.objectStore(Ae.DB_STORE_NAME),n=0,a=0,h=e.length;function l(){0==a?t():s();}e.forEach((function(e){var t=o.put(Ae.analyzePath(e).object.contents,e);t.onsuccess=function(){++n+a==h&&l();},t.onerror=function(){a++,n+a==h&&l();};})),i.onerror=s;},r.onerror=s;},loadFilesFromDB:function(e,t,s){t=t||function(){},s=s||function(){};var i=Ae.indexedDB();try{var r=i.open(Ae.DB_NAME(),Ae.DB_VERSION);}catch(e){return s(e)}r.onupgradeneeded=s,r.onsuccess=function(){var i=r.result;try{var o=i.transaction([Ae.DB_STORE_NAME],"readonly");}catch(e){return void s(e)}var n=o.objectStore(Ae.DB_STORE_NAME),a=0,h=0,l=e.length;function u(){0==h?t():s();}e.forEach((function(e){var t=n.get(e);t.onsuccess=function(){Ae.analyzePath(e).exists&&Ae.unlink(e),Ae.createDataFile(Pe.dirname(e),Pe.basename(e),t.result,!0,!0,!0),++a+h==l&&u();},t.onerror=function(){h++,a+h==l&&u();};})),o.onerror=s;},r.onerror=s;}},Ce={mappings:{},DEFAULT_POLLMASK:5,umask:511,calculateAt:function(e,t){if("/"!==t[0]){var s;if(-100===e)s=Ae.cwd();else {var i=Ae.getStream(e);if(!i)throw new Ae.ErrnoError(8);s=i.path;}t=Pe.join2(s,t);}return t},doStat:function(e,t,s){try{var i=e(t);}catch(e){if(e&&e.node&&Pe.normalize(t)!==Pe.normalize(Ae.getPath(e.node)))return -54;throw e}return L[s>>>2]=i.dev,L[s+4>>>2]=0,L[s+8>>>2]=i.ino,L[s+12>>>2]=i.mode,L[s+16>>>2]=i.nlink,L[s+20>>>2]=i.uid,L[s+24>>>2]=i.gid,L[s+28>>>2]=i.rdev,L[s+32>>>2]=0,ue=[i.size>>>0,(le=i.size,+Math.abs(le)>=1?le>0?(0|Math.min(+Math.floor(le/4294967296),4294967295))>>>0:~~+Math.ceil((le-+(~~le>>>0))/4294967296)>>>0:0)],L[s+40>>>2]=ue[0],L[s+44>>>2]=ue[1],L[s+48>>>2]=4096,L[s+52>>>2]=i.blocks,L[s+56>>>2]=i.atime.getTime()/1e3|0,L[s+60>>>2]=0,L[s+64>>>2]=i.mtime.getTime()/1e3|0,L[s+68>>>2]=0,L[s+72>>>2]=i.ctime.getTime()/1e3|0,L[s+76>>>2]=0,ue=[i.ino>>>0,(le=i.ino,+Math.abs(le)>=1?le>0?(0|Math.min(+Math.floor(le/4294967296),4294967295))>>>0:~~+Math.ceil((le-+(~~le>>>0))/4294967296)>>>0:0)],L[s+80>>>2]=ue[0],L[s+84>>>2]=ue[1],0},doMsync:function(e,t,s,i,r){var o=S.slice(e,e+s);Ae.msync(t,o,r,s,i);},doMkdir:function(e,t){return "/"===(e=Pe.normalize(e))[e.length-1]&&(e=e.substr(0,e.length-1)),Ae.mkdir(e,t,0),0},doMknod:function(e,t,s){switch(61440&t){case 32768:case 8192:case 24576:case 4096:case 49152:break;default:return -28}return Ae.mknod(e,t,s),0},doReadlink:function(e,t,s){if(s<=0)return -28;var i=Ae.readlink(e),r=Math.min(s,F(i)),o=E[t+r>>>0];return I(i,t,s+1),E[t+r>>>0]=o,r},doAccess:function(e,t){if(-8&t)return -28;var s;if(!(s=Ae.lookupPath(e,{follow:!0}).node))return -44;var i="";return 4&t&&(i+="r"),2&t&&(i+="w"),1&t&&(i+="x"),i&&Ae.nodePermissions(s,i)?-2:0},doDup:function(e,t,s){var i=Ae.getStream(s);return i&&Ae.close(i),Ae.open(e,t,0,s,s).fd},doReadv:function(e,t,s,i){for(var r=0,o=0;o<s;o++){var n=L[t+8*o>>>2],a=L[t+(8*o+4)>>>2],h=Ae.read(e,E,n,a,i);if(h<0)return -1;if(r+=h,h<a)break}return r},doWritev:function(e,t,s,i){for(var r=0,o=0;o<s;o++){var n=L[t+8*o>>>2],a=L[t+(8*o+4)>>>2],h=Ae.write(e,E,n,a,i);if(h<0)return -1;r+=h;}return r},varargs:void 0,get:function(){return Ce.varargs+=4,L[Ce.varargs-4>>>2]},getStr:function(e){return A(e)},getStreamFromFD:function(e){var t=Ae.getStream(e);if(!t)throw new Ae.ErrnoError(8);return t},get64:function(e,t){return e}},Ie={};function Fe(e){for(;e.length;){var t=e.pop();e.pop()(t);}}function Be(e){return this.fromWireType(N[e>>>2])}var Ee={},Se={},Re={};function Oe(e){if(void 0===e)return "_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function Le(e,t){return e=Oe(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function Ne(e,t){var s=Le(t,(function(e){this.name=t,this.message=e;var s=new Error(e).stack;void 0!==s&&(this.stack=this.toString()+"\n"+s.replace(/^Error(:[^\n]*)?\n/,""));}));return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},s}var ke=void 0;function je(e){throw new ke(e)}function Ge(e,t,s){function i(t){var i=s(t);i.length!==e.length&&je("Mismatched type converter count");for(var r=0;r<e.length;++r)Ye(e[r],i[r]);}e.forEach((function(e){Re[e]=t;}));var r=new Array(t.length),o=[],n=0;t.forEach((function(e,t){Se.hasOwnProperty(e)?r[t]=Se[e]:(o.push(e),Ee.hasOwnProperty(e)||(Ee[e]=[]),Ee[e].push((function(){r[t]=Se[e],++n===o.length&&i(r);})));})),0===o.length&&i(r);}var He={};function Ve(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var Ue=void 0;function ze(e){for(var t="",s=e;S[s>>>0];)t+=Ue[S[s++>>>0]];return t}var We=void 0;function Xe(e){throw new We(e)}function Ye(e,t,s){if(s=s||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var i=t.name;if(e||Xe('type "'+i+'" must have a positive integer typeid pointer'),Se.hasOwnProperty(e)){if(s.ignoreDuplicateRegistrations)return;Xe("Cannot register type '"+i+"' twice");}if(Se[e]=t,delete Re[e],Ee.hasOwnProperty(e)){var r=Ee[e];delete Ee[e],r.forEach((function(e){e();}));}}function Ke(e){if(!(this instanceof ht))return !1;if(!(e instanceof ht))return !1;for(var t=this.$$.ptrType.registeredClass,s=this.$$.ptr,i=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)s=t.upcast(s),t=t.baseClass;for(;i.baseClass;)r=i.upcast(r),i=i.baseClass;return t===i&&s===r}function Je(e){return {count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType}}function Ze(e){Xe(e.$$.ptrType.registeredClass.name+" instance already deleted");}var Qe=!1;function qe(e){}function $e(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr);}(e);}function et(e){return "undefined"==typeof FinalizationGroup?(et=function(e){return e},e):(Qe=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var s=t.value;s.ptr?$e(s):console.warn("object already deleted: "+s.ptr);}})),qe=function(e){Qe.unregister(e.$$);},(et=function(e){return Qe.register(e,e.$$,e.$$),e})(e))}function tt(){if(this.$$.ptr||Ze(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e=et(Object.create(Object.getPrototypeOf(this),{$$:{value:Je(this.$$)}}));return e.$$.count.value+=1,e.$$.deleteScheduled=!1,e}function st(){this.$$.ptr||Ze(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Xe("Object already scheduled for deletion"),qe(this),$e(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0);}function it(){return !this.$$.ptr}var rt=void 0,ot=[];function nt(){for(;ot.length;){var e=ot.pop();e.$$.deleteScheduled=!1,e.delete();}}function at(){return this.$$.ptr||Ze(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Xe("Object already scheduled for deletion"),ot.push(this),1===ot.length&&rt&&rt(nt),this.$$.deleteScheduled=!0,this}function ht(){}var lt={};function ut(e,t,s){if(void 0===e[t].overloadTable){var i=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||Xe("Function '"+s+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[i.argCount]=i;}}function ct(e,t,s){r.hasOwnProperty(e)?((void 0===s||void 0!==r[e].overloadTable&&void 0!==r[e].overloadTable[s])&&Xe("Cannot register public name '"+e+"' twice"),ut(r,e,e),r.hasOwnProperty(s)&&Xe("Cannot register multiple overloads of a function with the same number of arguments ("+s+")!"),r[e].overloadTable[s]=t):(r[e]=t,void 0!==s&&(r[e].numArguments=s));}function pt(e,t,s,i,r,o,n,a){this.name=e,this.constructor=t,this.instancePrototype=s,this.rawDestructor=i,this.baseClass=r,this.getActualType=o,this.upcast=n,this.downcast=a,this.pureVirtualFunctions=[];}function dt(e,t,s){for(;t!==s;)t.upcast||Xe("Expected null or instance of "+s.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function ft(e,t){if(null===t)return this.isReference&&Xe("null is not a valid "+this.name),0;t.$$||Xe('Cannot pass "'+zt(t)+'" as a '+this.name),t.$$.ptr||Xe("Cannot pass deleted object as a pointer of type "+this.name);var s=t.$$.ptrType.registeredClass;return dt(t.$$.ptr,s,this.registeredClass)}function mt(e,t){var s;if(null===t)return this.isReference&&Xe("null is not a valid "+this.name),this.isSmartPointer?(s=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,s),s):0;t.$$||Xe('Cannot pass "'+zt(t)+'" as a '+this.name),t.$$.ptr||Xe("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&Xe("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;if(s=dt(t.$$.ptr,i,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&Xe("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?s=t.$$.smartPtr:Xe("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:s=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)s=t.$$.smartPtr;else {var r=t.clone();s=this.rawShare(s,Ht((function(){r.delete();}))),null!==e&&e.push(this.rawDestructor,s);}break;default:Xe("Unsupporting sharing policy");}return s}function gt(e,t){if(null===t)return this.isReference&&Xe("null is not a valid "+this.name),0;t.$$||Xe('Cannot pass "'+zt(t)+'" as a '+this.name),t.$$.ptr||Xe("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&Xe("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var s=t.$$.ptrType.registeredClass;return dt(t.$$.ptr,s,this.registeredClass)}function _t(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function yt(e){this.rawDestructor&&this.rawDestructor(e);}function vt(e){null!==e&&e.delete();}function bt(e,t,s){if(t===s)return e;if(void 0===s.baseClass)return null;var i=bt(e,t,s.baseClass);return null===i?null:s.downcast(i)}function wt(){return Object.keys(xt).length}function Pt(){var e=[];for(var t in xt)xt.hasOwnProperty(t)&&e.push(xt[t]);return e}function Tt(e){rt=e,ot.length&&rt&&rt(nt);}var xt={};function Mt(e,t){return t=function(e,t){for(void 0===t&&Xe("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),xt[t]}function Dt(e,t){return t.ptrType&&t.ptr||je("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!=!!t.smartPtr&&je("Both smartPtrType and smartPtr must be specified"),t.count={value:1},et(Object.create(e,{$$:{value:t}}))}function At(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var s=Mt(this.registeredClass,t);if(void 0!==s){if(0===s.$$.count.value)return s.$$.ptr=t,s.$$.smartPtr=e,s.clone();var i=s.clone();return this.destructor(e),i}function r(){return this.isSmartPointer?Dt(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Dt(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var o,n=this.registeredClass.getActualType(t),a=lt[n];if(!a)return r.call(this);o=this.isConst?a.constPointerType:a.pointerType;var h=bt(t,this.registeredClass,o.registeredClass);return null===h?r.call(this):this.isSmartPointer?Dt(o.registeredClass.instancePrototype,{ptrType:o,ptr:h,smartPtrType:this,smartPtr:e}):Dt(o.registeredClass.instancePrototype,{ptrType:o,ptr:h})}function Ct(e,t,s,i,r,o,n,a,h,l,u){this.name=e,this.registeredClass=t,this.isReference=s,this.isConst=i,this.isSmartPointer=r,this.pointeeType=o,this.sharingPolicy=n,this.rawGetPointee=a,this.rawConstructor=h,this.rawShare=l,this.rawDestructor=u,r||void 0!==t.baseClass?this.toWireType=mt:i?(this.toWireType=ft,this.destructorFunction=null):(this.toWireType=gt,this.destructorFunction=null);}function It(e,t,s){r.hasOwnProperty(e)||je("Replacing nonexistant public symbol"),void 0!==r[e].overloadTable&&void 0!==s?r[e].overloadTable[s]=t:(r[e]=t,r[e].argCount=s);}function Ft(e,t){var s=-1!=(e=ze(e)).indexOf("j")?function(e,t){x(e.indexOf("j")>=0,"getDynCaller should only be called with i64 sigs");var s=[];return function(){s.length=arguments.length;for(var i=0;i<arguments.length;i++)s[i]=arguments[i];return fe(e,t,s)}}(e,t):J.get(t);return "function"!=typeof s&&Xe("unknown function pointer with signature "+e+": "+t),s}var Bt=void 0;function Et(e){var t=ms(e),s=ze(t);return fs(t),s}function St(e,t){var s=[],i={};throw t.forEach((function e(t){i[t]||Se[t]||(Re[t]?Re[t].forEach(e):(s.push(t),i[t]=!0));})),new Bt(e+": "+s.map(Et).join([", "]))}function Rt(e,t){for(var s=[],i=0;i<e;i++)s.push(L[(t>>2)+i>>>0]);return s}function Ot(e,t,s,i,r){var o=t.length;o<2&&Xe("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var n=null!==t[1]&&null!==s,a=!1,h=1;h<t.length;++h)if(null!==t[h]&&void 0===t[h].destructorFunction){a=!0;break}var l="void"!==t[0].name,u="",c="";for(h=0;h<o-2;++h)u+=(0!==h?", ":"")+"arg"+h,c+=(0!==h?", ":"")+"arg"+h+"Wired";var p="return function "+Oe(e)+"("+u+") {\nif (arguments.length !== "+(o-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(o-2)+" args!');\n}\n";a&&(p+="var destructors = [];\n");var d=a?"destructors":"null",f=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],m=[Xe,i,r,Fe,t[0],t[1]];for(n&&(p+="var thisWired = classParam.toWireType("+d+", this);\n"),h=0;h<o-2;++h)p+="var arg"+h+"Wired = argType"+h+".toWireType("+d+", arg"+h+"); // "+t[h+2].name+"\n",f.push("argType"+h),m.push(t[h+2]);if(n&&(c="thisWired"+(c.length>0?", ":"")+c),p+=(l?"var rv = ":"")+"invoker(fn"+(c.length>0?", ":"")+c+");\n",a)p+="runDestructors(destructors);\n";else for(h=n?1:2;h<t.length;++h){var g=1===h?"thisWired":"arg"+(h-2)+"Wired";null!==t[h].destructorFunction&&(p+=g+"_dtor("+g+"); // "+t[h].name+"\n",f.push(g+"_dtor"),m.push(t[h].destructorFunction));}l&&(p+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),p+="}\n",f.push(p);var _=function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var s=Le(e.name||"unknownFunctionName",(function(){}));s.prototype=e.prototype;var i=new s,r=e.apply(i,t);return r instanceof Object?r:i}(Function,f).apply(null,m);return _}var Lt=[],Nt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function kt(e){e>4&&0==--Nt[e].refcount&&(Nt[e]=void 0,Lt.push(e));}function jt(){for(var e=0,t=5;t<Nt.length;++t)void 0!==Nt[t]&&++e;return e}function Gt(){for(var e=5;e<Nt.length;++e)if(void 0!==Nt[e])return Nt[e];return null}function Ht(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Lt.length?Lt.pop():Nt.length;return Nt[t]={refcount:1,value:e},t}}function Vt(e,t,s){switch(t){case 0:return function(e){var t=s?E:S;return this.fromWireType(t[e>>>0])};case 1:return function(e){var t=s?R:O;return this.fromWireType(t[e>>>1])};case 2:return function(e){var t=s?L:N;return this.fromWireType(t[e>>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function Ut(e,t){var s=Se[e];return void 0===s&&Xe(t+" has unknown type "+Et(e)),s}function zt(e){if(null===e)return "null";var t=typeof e;return "object"===t||"array"===t||"function"===t?e.toString():""+e}function Wt(e,t){switch(t){case 2:return function(e){return this.fromWireType(k[e>>>2])};case 3:return function(e){return this.fromWireType(j[e>>>3])};default:throw new TypeError("Unknown float type: "+e)}}function Xt(e,t,s){switch(t){case 0:return s?function(e){return E[e>>>0]}:function(e){return S[e>>>0]};case 1:return s?function(e){return R[e>>>1]}:function(e){return O[e>>>1]};case 2:return s?function(e){return L[e>>>2]}:function(e){return N[e>>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Yt(e){return e||Xe("Cannot use deleted val. handle = "+e),Nt[e].value}var Kt,Jt={};function Zt(e){var t=Jt[e];return void 0===t?ze(e):t}function Qt(){return "object"==typeof globalThis?globalThis:Function("return this")()}function qt(e){try{return b.grow(e-B.byteLength+65535>>>16),K(b.buffer),1}catch(e){}}Kt=l?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof dateNow?dateNow:function(){return performance.now()};var $t={};function es(){if(!es.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:c||"./this.program"};for(var t in $t)e[t]=$t[t];var s=[];for(var t in e)s.push(t+"="+e[t]);es.strings=s;}return es.strings}function ts(e){return e%4==0&&(e%100!=0||e%400==0)}function ss(e,t){for(var s=0,i=0;i<=t;s+=e[i++]);return s}var is=[31,29,31,30,31,30,31,31,30,31,30,31],rs=[31,28,31,30,31,30,31,31,30,31,30,31];function os(e,t){for(var s=new Date(e.getTime());t>0;){var i=ts(s.getFullYear()),r=s.getMonth(),o=(i?is:rs)[r];if(!(t>o-s.getDate()))return s.setDate(s.getDate()+t),s;t-=o-s.getDate()+1,s.setDate(1),r<11?s.setMonth(r+1):(s.setMonth(0),s.setFullYear(s.getFullYear()+1));}return s}function ns(e,t,s,i){var r=L[i+40>>>2],o={tm_sec:L[i>>>2],tm_min:L[i+4>>>2],tm_hour:L[i+8>>>2],tm_mday:L[i+12>>>2],tm_mon:L[i+16>>>2],tm_year:L[i+20>>>2],tm_wday:L[i+24>>>2],tm_yday:L[i+28>>>2],tm_isdst:L[i+32>>>2],tm_gmtoff:L[i+36>>>2],tm_zone:r?A(r):""},n=A(s),a={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var h in a)n=n.replace(new RegExp(h,"g"),a[h]);var l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],u=["January","February","March","April","May","June","July","August","September","October","November","December"];function c(e,t,s){for(var i="number"==typeof e?e.toString():e||"";i.length<t;)i=s[0]+i;return i}function p(e,t){return c(e,t,"0")}function d(e,t){function s(e){return e<0?-1:e>0?1:0}var i;return 0===(i=s(e.getFullYear()-t.getFullYear()))&&0===(i=s(e.getMonth()-t.getMonth()))&&(i=s(e.getDate()-t.getDate())),i}function f(e){switch(e.getDay()){case 0:return new Date(e.getFullYear()-1,11,29);case 1:return e;case 2:return new Date(e.getFullYear(),0,3);case 3:return new Date(e.getFullYear(),0,2);case 4:return new Date(e.getFullYear(),0,1);case 5:return new Date(e.getFullYear()-1,11,31);case 6:return new Date(e.getFullYear()-1,11,30)}}function m(e){var t=os(new Date(e.tm_year+1900,0,1),e.tm_yday),s=new Date(t.getFullYear(),0,4),i=new Date(t.getFullYear()+1,0,4),r=f(s),o=f(i);return d(r,t)<=0?d(o,t)<=0?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}var g={"%a":function(e){return l[e.tm_wday].substring(0,3)},"%A":function(e){return l[e.tm_wday]},"%b":function(e){return u[e.tm_mon].substring(0,3)},"%B":function(e){return u[e.tm_mon]},"%C":function(e){return p((e.tm_year+1900)/100|0,2)},"%d":function(e){return p(e.tm_mday,2)},"%e":function(e){return c(e.tm_mday,2," ")},"%g":function(e){return m(e).toString().substring(2)},"%G":function(e){return m(e)},"%H":function(e){return p(e.tm_hour,2)},"%I":function(e){var t=e.tm_hour;return 0==t?t=12:t>12&&(t-=12),p(t,2)},"%j":function(e){return p(e.tm_mday+ss(ts(e.tm_year+1900)?is:rs,e.tm_mon-1),3)},"%m":function(e){return p(e.tm_mon+1,2)},"%M":function(e){return p(e.tm_min,2)},"%n":function(){return "\n"},"%p":function(e){return e.tm_hour>=0&&e.tm_hour<12?"AM":"PM"},"%S":function(e){return p(e.tm_sec,2)},"%t":function(){return "\t"},"%u":function(e){return e.tm_wday||7},"%U":function(e){var t=new Date(e.tm_year+1900,0,1),s=0===t.getDay()?t:os(t,7-t.getDay()),i=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(d(s,i)<0){var r=ss(ts(i.getFullYear())?is:rs,i.getMonth()-1)-31,o=31-s.getDate()+r+i.getDate();return p(Math.ceil(o/7),2)}return 0===d(s,t)?"01":"00"},"%V":function(e){var t,s=new Date(e.tm_year+1900,0,4),i=new Date(e.tm_year+1901,0,4),r=f(s),o=f(i),n=os(new Date(e.tm_year+1900,0,1),e.tm_yday);return d(n,r)<0?"53":d(o,n)<=0?"01":(t=r.getFullYear()<e.tm_year+1900?e.tm_yday+32-r.getDate():e.tm_yday+1-r.getDate(),p(Math.ceil(t/7),2))},"%w":function(e){return e.tm_wday},"%W":function(e){var t=new Date(e.tm_year,0,1),s=1===t.getDay()?t:os(t,0===t.getDay()?1:7-t.getDay()+1),i=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(d(s,i)<0){var r=ss(ts(i.getFullYear())?is:rs,i.getMonth()-1)-31,o=31-s.getDate()+r+i.getDate();return p(Math.ceil(o/7),2)}return 0===d(s,t)?"01":"00"},"%y":function(e){return (e.tm_year+1900).toString().substring(2)},"%Y":function(e){return e.tm_year+1900},"%z":function(e){var t=e.tm_gmtoff,s=t>=0;return t=(t=Math.abs(t)/60)/60*100+t%60,(s?"+":"-")+String("0000"+t).slice(-4)},"%Z":function(e){return e.tm_zone},"%%":function(){return "%"}};for(var h in g)n.indexOf(h)>=0&&(n=n.replace(new RegExp(h,"g"),g[h](o)));var _,y,v=us(n,!1);return v.length>t?0:(_=v,y=e,E.set(_,y>>>0),v.length-1)}var as=function(e,t,s,i){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=Ae.nextInode++,this.name=t,this.mode=s,this.node_ops={},this.stream_ops={},this.rdev=i;},hs=365,ls=146;function us(e,t,s){var i=s>0?s:F(e)+1,r=new Array(i),o=C(e,r,0,r.length);return t&&(r.length=o),r}Object.defineProperties(as.prototype,{read:{get:function(){return (this.mode&hs)===hs},set:function(e){e?this.mode|=hs:this.mode&=-366;}},write:{get:function(){return (this.mode&ls)===ls},set:function(e){e?this.mode|=ls:this.mode&=-147;}},isFolder:{get:function(){return Ae.isDir(this.mode)}},isDevice:{get:function(){return Ae.isChrdev(this.mode)}}}),Ae.FSNode=as,Ae.staticInit(),r.FS_createPath=Ae.createPath,r.FS_createDataFile=Ae.createDataFile,r.FS_createPreloadedFile=Ae.createPreloadedFile,r.FS_createLazyFile=Ae.createLazyFile,r.FS_createDevice=Ae.createDevice,r.FS_unlink=Ae.unlink,ke=r.InternalError=Ne(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);Ue=e;}(),We=r.BindingError=Ne(Error,"BindingError"),ht.prototype.isAliasOf=Ke,ht.prototype.clone=tt,ht.prototype.delete=st,ht.prototype.isDeleted=it,ht.prototype.deleteLater=at,Ct.prototype.getPointee=_t,Ct.prototype.destructor=yt,Ct.prototype.argPackAdvance=8,Ct.prototype.readValueFromPointer=Be,Ct.prototype.deleteObject=vt,Ct.prototype.fromWireType=At,r.getInheritedInstanceCount=wt,r.getLiveInheritedInstances=Pt,r.flushPendingDeletes=nt,r.setDelayFunction=Tt,Bt=r.UnboundTypeError=Ne(Error,"UnboundTypeError"),r.count_emval_handles=jt,r.get_first_emval=Gt,q.push({func:function(){ps();}});var cs={z:function(e,t,s,i){oe("Assertion failed: "+A(e)+", at: "+[t?A(t):"unknown filename",s,i?A(i):"unknown function"]);},y:function(e){return ds(e+be)+be},x:function(e,t,s){throw new we(e).init(t,s),e},V:function(e,t,s){Ce.varargs=s;try{var i=Ce.getStreamFromFD(e);switch(t){case 21509:case 21505:case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:case 21523:case 21524:return i.tty?0:-59;case 21519:if(!i.tty)return -59;var r=Ce.get();return L[r>>>2]=0,0;case 21520:return i.tty?-28:-59;case 21531:return r=Ce.get(),Ae.ioctl(i,t,r);default:oe("bad ioctl syscall "+t);}}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),-e.errno}},W:function(e,t,s){Ce.varargs=s;try{var i=Ce.getStr(e),r=Ce.get();return Ae.open(i,t,r).fd}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),-e.errno}},$:function(e){var t=Ie[e];delete Ie[e];var s=t.elements,i=s.length,r=s.map((function(e){return e.getterReturnType})).concat(s.map((function(e){return e.setterArgumentType}))),o=t.rawConstructor,n=t.rawDestructor;Ge([e],r,(function(e){return s.forEach((function(t,s){var r=e[s],o=t.getter,n=t.getterContext,a=e[s+i],h=t.setter,l=t.setterContext;t.read=function(e){return r.fromWireType(o(n,e))},t.write=function(e,t){var s=[];h(l,e,a.toWireType(s,t)),Fe(s);};})),[{name:t.name,fromWireType:function(e){for(var t=new Array(i),r=0;r<i;++r)t[r]=s[r].read(e);return n(e),t},toWireType:function(e,r){if(i!==r.length)throw new TypeError("Incorrect number of tuple elements for "+t.name+": expected="+i+", actual="+r.length);for(var a=o(),h=0;h<i;++h)s[h].write(a,r[h]);return null!==e&&e.push(n,a),a},argPackAdvance:8,readValueFromPointer:Be,destructorFunction:n}]}));},q:function(e){var t=He[e];delete He[e];var s=t.rawConstructor,i=t.rawDestructor,r=t.fields;Ge([e],r.map((function(e){return e.getterReturnType})).concat(r.map((function(e){return e.setterArgumentType}))),(function(e){var o={};return r.forEach((function(t,s){var i=t.fieldName,n=e[s],a=t.getter,h=t.getterContext,l=e[s+r.length],u=t.setter,c=t.setterContext;o[i]={read:function(e){return n.fromWireType(a(h,e))},write:function(e,t){var s=[];u(c,e,l.toWireType(s,t)),Fe(s);}};})),[{name:t.name,fromWireType:function(e){var t={};for(var s in o)t[s]=o[s].read(e);return i(e),t},toWireType:function(e,t){for(var r in o)if(!(r in t))throw new TypeError('Missing field:  "'+r+'"');var n=s();for(r in o)o[r].write(n,t[r]);return null!==e&&e.push(i,n),n},argPackAdvance:8,readValueFromPointer:Be,destructorFunction:i}]}));},Y:function(e,t,s,i,r){var o=Ve(s);Ye(e,{name:t=ze(t),fromWireType:function(e){return !!e},toWireType:function(e,t){return t?i:r},argPackAdvance:8,readValueFromPointer:function(e){var i;if(1===s)i=E;else if(2===s)i=R;else {if(4!==s)throw new TypeError("Unknown boolean type size: "+t);i=L;}return this.fromWireType(i[e>>>o])},destructorFunction:null});},t:function(e,t,s,i,r,o,n,a,h,l,u,c,p){u=ze(u),o=Ft(r,o),a&&(a=Ft(n,a)),l&&(l=Ft(h,l)),p=Ft(c,p);var d=Oe(u);ct(d,(function(){St("Cannot construct "+u+" due to unbound types",[i]);})),Ge([e,t,s],i?[i]:[],(function(t){var s,r;t=t[0],r=i?(s=t.registeredClass).instancePrototype:ht.prototype;var n=Le(d,(function(){if(Object.getPrototypeOf(this)!==h)throw new We("Use 'new' to construct "+u);if(void 0===c.constructor_body)throw new We(u+" has no accessible constructor");var e=c.constructor_body[arguments.length];if(void 0===e)throw new We("Tried to invoke ctor of "+u+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(c.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),h=Object.create(r,{constructor:{value:n}});n.prototype=h;var c=new pt(u,n,h,p,s,o,a,l),f=new Ct(u,c,!0,!1,!1),m=new Ct(u+"*",c,!1,!1,!1),g=new Ct(u+" const*",c,!1,!0,!1);return lt[e]={pointerType:m,constPointerType:g},It(d,n),[f,m,g]}));},s:function(e,t,s,i,r,o){x(t>0);var n=Rt(t,s);r=Ft(i,r);var a=[o],h=[];Ge([],[e],(function(e){var s="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new We("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){St("Cannot construct "+e.name+" due to unbound types",n);},Ge([],n,(function(i){return e.registeredClass.constructor_body[t-1]=function(){arguments.length!==t-1&&Xe(s+" called with "+arguments.length+" arguments, expected "+(t-1)),h.length=0,a.length=t;for(var e=1;e<t;++e)a[e]=i[e].toWireType(h,arguments[e-1]);var o=r.apply(null,a);return Fe(h),i[0].fromWireType(o)},[]})),[]}));},c:function(e,t,s,i,r,o,n,a){var h=Rt(s,i);t=ze(t),o=Ft(r,o),Ge([],[e],(function(e){var i=(e=e[0]).name+"."+t;function r(){St("Cannot call "+i+" due to unbound types",h);}a&&e.registeredClass.pureVirtualFunctions.push(t);var l=e.registeredClass.instancePrototype,u=l[t];return void 0===u||void 0===u.overloadTable&&u.className!==e.name&&u.argCount===s-2?(r.argCount=s-2,r.className=e.name,l[t]=r):(ut(l,t,i),l[t].overloadTable[s-2]=r),Ge([],h,(function(r){var a=Ot(i,r,e,o,n);return void 0===l[t].overloadTable?(a.argCount=s-2,l[t]=a):l[t].overloadTable[s-2]=a,[]})),[]}));},X:function(e,t){Ye(e,{name:t=ze(t),fromWireType:function(e){var t=Nt[e].value;return kt(e),t},toWireType:function(e,t){return Ht(t)},argPackAdvance:8,readValueFromPointer:Be,destructorFunction:null});},_:function(e,t,s,i){var r=Ve(s);function o(){}t=ze(t),o.values={},Ye(e,{name:t,constructor:o,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:Vt(t,r,i),destructorFunction:null}),ct(t,o);},v:function(e,t,s){var i=Ut(e,"enum");t=ze(t);var r=i.constructor,o=Object.create(i.constructor.prototype,{value:{value:s},constructor:{value:Le(i.name+"_"+t,(function(){}))}});r.values[s]=o,r[t]=o;},F:function(e,t,s){var i=Ve(s);Ye(e,{name:t=ze(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+zt(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Wt(t,i),destructorFunction:null});},f:function(e,t,s,i,r,o){var n=Rt(t,s);e=ze(e),r=Ft(i,r),ct(e,(function(){St("Cannot call "+e+" due to unbound types",n);}),t-1),Ge([],n,(function(s){var i=[s[0],null].concat(s.slice(1));return It(e,Ot(e,i,null,r,o),t-1),[]}));},o:function(e,t,s,i,r){t=ze(t),-1===r&&(r=4294967295);var o=Ve(s),n=function(e){return e};if(0===i){var a=32-8*s;n=function(e){return e<<a>>>a};}var h=-1!=t.indexOf("unsigned");Ye(e,{name:t,fromWireType:n,toWireType:function(e,s){if("number"!=typeof s&&"boolean"!=typeof s)throw new TypeError('Cannot convert "'+zt(s)+'" to '+this.name);if(s<i||s>r)throw new TypeError('Passing a number "'+zt(s)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+i+", "+r+"]!");return h?s>>>0:0|s},argPackAdvance:8,readValueFromPointer:Xt(t,o,0!==i),destructorFunction:null});},k:function(e,t,s){var i=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=N,s=t[(e>>=2)>>>0],r=t[e+1>>>0];return new i(B,r,s)}Ye(e,{name:s=ze(s),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0});},G:function(e,t){var s="std::string"===(t=ze(t));Ye(e,{name:t,fromWireType:function(e){var t,i=N[e>>>2];if(s)for(var r=e+4,o=0;o<=i;++o){var n=e+4+o;if(o==i||0==S[n>>>0]){var a=A(r,n-r);void 0===t?t=a:(t+=String.fromCharCode(0),t+=a),r=n+1;}}else {var h=new Array(i);for(o=0;o<i;++o)h[o]=String.fromCharCode(S[e+4+o>>>0]);t=h.join("");}return fs(e),t},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var i="string"==typeof t;i||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||Xe("Cannot pass non-string to std::string");var r=(s&&i?function(){return F(t)}:function(){return t.length})(),o=ds(4+r+1);if(N[(o>>>=0)>>>2]=r,s&&i)I(t,o+4,r+1);else if(i)for(var n=0;n<r;++n){var a=t.charCodeAt(n);a>255&&(fs(o),Xe("String has UTF-16 code units that do not fit in 8 bits")),S[o+4+n>>>0]=a;}else for(n=0;n<r;++n)S[o+4+n>>>0]=t[n];return null!==e&&e.push(fs,o),o},argPackAdvance:8,readValueFromPointer:Be,destructorFunction:function(e){fs(e);}});},w:function(e,t,s){var i,r,o,n,a;s=ze(s),2===t?(i=H,r=V,n=U,o=function(){return O},a=1):4===t&&(i=z,r=W,n=X,o=function(){return N},a=2),Ye(e,{name:s,fromWireType:function(e){for(var s,r=N[e>>>2],n=o(),h=e+4,l=0;l<=r;++l){var u=e+4+l*t;if(l==r||0==n[u>>>a]){var c=i(h,u-h);void 0===s?s=c:(s+=String.fromCharCode(0),s+=c),h=u+t;}}return fs(e),s},toWireType:function(e,i){"string"!=typeof i&&Xe("Cannot pass non-string to C++ string type "+s);var o=n(i),h=ds(4+o+t);return N[(h>>>=0)>>>2]=o>>a,r(i,h+4,o+t),null!==e&&e.push(fs,h),h},argPackAdvance:8,readValueFromPointer:Be,destructorFunction:function(e){fs(e);}});},aa:function(e,t,s,i,r,o){Ie[e]={name:ze(t),rawConstructor:Ft(s,i),rawDestructor:Ft(r,o),elements:[]};},h:function(e,t,s,i,r,o,n,a,h){Ie[e].elements.push({getterReturnType:t,getter:Ft(s,i),getterContext:r,setterArgumentType:o,setter:Ft(n,a),setterContext:h});},r:function(e,t,s,i,r,o){He[e]={name:ze(t),rawConstructor:Ft(s,i),rawDestructor:Ft(r,o),fields:[]};},e:function(e,t,s,i,r,o,n,a,h,l){He[e].fields.push({fieldName:ze(t),getterReturnType:s,getter:Ft(i,r),getterContext:o,setterArgumentType:n,setter:Ft(a,h),setterContext:l});},Z:function(e,t){Ye(e,{isVoid:!0,name:t=ze(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}});},m:function(e,t,s){e=Yt(e),t=Ut(t,"emval::as");var i=[],r=Ht(i);return L[s>>>2]=r,t.toWireType(i,e)},H:function(e,t,s,i){e=Yt(e);for(var r=function(e,t){for(var s=new Array(e),i=0;i<e;++i)s[i]=Ut(L[(t>>2)+i>>>0],"parameter "+i);return s}(t,s),o=new Array(t),n=0;n<t;++n){var a=r[n];o[n]=a.readValueFromPointer(i),i+=a.argPackAdvance;}return Ht(e.apply(void 0,o))},b:kt,J:function(e){return 0===e?Ht(Qt()):(e=Zt(e),Ht(Qt()[e]))},n:function(e,t){return Ht((e=Yt(e))[t=Yt(t)])},j:function(e){e>4&&(Nt[e].refcount+=1);},N:function(e,t){return (e=Yt(e))instanceof(t=Yt(t))},I:function(e){return "number"==typeof(e=Yt(e))},A:function(){return Ht([])},g:function(e){return Ht(Zt(e))},u:function(){return Ht({})},l:function(e){Fe(Nt[e].value),kt(e);},i:function(e,t,s){e=Yt(e),t=Yt(t),s=Yt(s),e[t]=s;},d:function(e,t){return Ht((e=Ut(e,"_emval_take_value")).readValueFromPointer(t))},C:function(){oe();},T:function(e,t){var s,i;if(0===e)s=Date.now();else {if(1!==e&&4!==e)return i=28,L[_s()>>>2]=i,-1;s=Kt();}return L[t>>>2]=s/1e3|0,L[t+4>>>2]=s%1e3*1e3*1e3|0,0},M:function(e,t,s){S.copyWithin(e>>>0,t>>>0,t+s>>>0);},p:function(e){e>>>=0;var t=S.length,s=4294967296;if(e>s)return !1;for(var i=1;i<=4;i*=2){var r=t*(1+.2/i);if(r=Math.min(r,e+100663296),qt(Math.min(s,Y(Math.max(16777216,e,r),65536))))return !0}return !1},R:function(e,t){try{var s=0;return es().forEach((function(i,r){var o=t+s;L[e+4*r>>>2]=o,function(e,t,s){for(var i=0;i<e.length;++i)E[t++>>>0]=e.charCodeAt(i);s||(E[t>>>0]=0);}(i,o),s+=i.length+1;})),0}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),e.errno}},S:function(e,t){try{var s=es();L[e>>>2]=s.length;var i=0;return s.forEach((function(e){i+=e.length+1;})),L[t>>>2]=i,0}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),e.errno}},E:function(e){try{var t=Ce.getStreamFromFD(e);return Ae.close(t),0}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),e.errno}},U:function(e,t,s,i){try{var r=Ce.getStreamFromFD(e),o=Ce.doReadv(r,t,s);return L[i>>>2]=o,0}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),e.errno}},K:function(e,t,s,i,r){try{var o=Ce.getStreamFromFD(e),n=4294967296*s+(t>>>0),a=9007199254740992;return n<=-a||n>=a?-61:(Ae.llseek(o,n,i),ue=[o.position>>>0,(le=o.position,+Math.abs(le)>=1?le>0?(0|Math.min(+Math.floor(le/4294967296),4294967295))>>>0:~~+Math.ceil((le-+(~~le>>>0))/4294967296)>>>0:0)],L[r>>>2]=ue[0],L[r+4>>>2]=ue[1],o.getdents&&0===n&&0===i&&(o.getdents=null),0)}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),e.errno}},D:function(e,t,s,i){try{var r=Ce.getStreamFromFD(e),o=Ce.doWritev(r,t,s);return L[i>>>2]=o,0}catch(e){return void 0!==Ae&&e instanceof Ae.ErrnoError||oe(e),e.errno}},a:b,B:function(){},P:function(){},O:function(){},L:function(e){},Q:function(e,t,s,i){return ns(e,t,s,i)}};!function(){var e={a:cs};function t(e,t){var s=e.exports;r.asm=s,J=r.asm.ba,re();}function s(e){t(e.instance);}function o(t){return (y||!a&&!h||"function"!=typeof fetch||he(ce)?Promise.resolve().then(pe):fetch(ce,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw "failed to load wasm binary file at '"+ce+"'";return e.arrayBuffer()})).catch((function(){return pe()}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){P("failed to asynchronously prepare wasm: "+e),oe(e);}))}if(ie(),r.instantiateWasm)try{return r.instantiateWasm(e,t)}catch(e){return P("Module.instantiateWasm callback failed with error: "+e),!1}(y||"function"!=typeof WebAssembly.instantiateStreaming||ae(ce)||he(ce)||"function"!=typeof fetch?o(s):fetch(ce,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(s,(function(e){return P("wasm streaming compile failed: "+e),P("falling back to ArrayBuffer instantiation"),o(s)}))}))).catch(i);}();var ps=r.___wasm_call_ctors=function(){return (ps=r.___wasm_call_ctors=r.asm.ca).apply(null,arguments)};r._main=function(){return (r._main=r.asm.da).apply(null,arguments)};var ds=r._malloc=function(){return (ds=r._malloc=r.asm.ea).apply(null,arguments)},fs=r._free=function(){return (fs=r._free=r.asm.fa).apply(null,arguments)},ms=r.___getTypeName=function(){return (ms=r.___getTypeName=r.asm.ga).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return (r.___embind_register_native_and_builtin_types=r.asm.ha).apply(null,arguments)};var gs,_s=r.___errno_location=function(){return (_s=r.___errno_location=r.asm.ia).apply(null,arguments)};function ys(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e;}function vs(e){var t,s=r._main;try{t=s(0,0),!0&&v&&0===t||(v||(r.onExit&&r.onExit(t),T=!0),p(t,new ys(t)));}catch(e){if(e instanceof ys)return;if("unwind"==e)return void(v=!0);var i=e;e&&"object"==typeof e&&e.stack&&(i=[e,e.stack]),P("exception thrown: "+i),p(1,e);}}function bs(e){function s(){gs||(gs=!0,r.calledRun=!0,T||(r.noFSInit||Ae.init.initialized||Ae.init(),de(q),Ae.ignorePermissions=!1,de($),t(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),ws&&vs(),function(){if(r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)e=r.postRun.shift(),ee.unshift(e);var e;de(ee);}()));}te>0||(function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)e=r.preRun.shift(),Q.unshift(e);var e;de(Q);}(),te>0||(r.setStatus?(r.setStatus("Running..."),setTimeout((function(){setTimeout((function(){r.setStatus("");}),1),s();}),1)):s()));}if(r.dynCall_jiji=function(){return (r.dynCall_jiji=r.asm.ja).apply(null,arguments)},r.dynCall_viijii=function(){return (r.dynCall_viijii=r.asm.ka).apply(null,arguments)},r.dynCall_iiiiiijj=function(){return (r.dynCall_iiiiiijj=r.asm.la).apply(null,arguments)},r.dynCall_iiiiij=function(){return (r.dynCall_iiiiij=r.asm.ma).apply(null,arguments)},r.dynCall_iiiiijj=function(){return (r.dynCall_iiiiijj=r.asm.na).apply(null,arguments)},r.addRunDependency=ie,r.removeRunDependency=re,r.FS_createPath=Ae.createPath,r.FS_createDataFile=Ae.createDataFile,r.FS_createPreloadedFile=Ae.createPreloadedFile,r.FS_createLazyFile=Ae.createLazyFile,r.FS_createDevice=Ae.createDevice,r.FS_unlink=Ae.unlink,r.FS=Ae,se=function e(){gs||bs(),gs||(se=e);},r.run=bs,r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();var ws=!0;return r.noInitialRun&&(ws=!1),v=!0,bs(),e.ready});"object"==typeof e&&"object"==typeof t?t.exports=i:"function"==typeof define&&define.amd?define([],(function(){return i})):"object"==typeof e&&(e.WebIFCWasm=i);}});f_="undefined"!=typeof self&&self.crossOriginIsolated?M_():D_();class jE{constructor(e={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=e.messages,this.locale=e.locale;}set messages(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this);}loadMessages(e={}){for(let t in e)this._messages[t]=e[t];this.messages=this._messages;}clearMessages(){this.messages={};}get locales(){return this._locales}set locale(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e));}get locale(){return this._locale}translate(e,t){const s=this._messages[this._locale];if(!s)return null;const i=GE(e,s);return i?t?HE(i,t):i:null}translatePlurals(e,t,s){const i=this._messages[this._locale];if(!i)return null;let r=GE(e,i);return r=0===(t=parseInt(""+t,10))?r.zero:t>1?r.other:r.one,r?(r=HE(r,[t]),s&&(r=HE(r,s)),r):null}fire(e,t,s){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==s&&(this._events[e]=t||!0);const i=this._eventSubs[e];if(i)for(const e in i)if(i.hasOwnProperty(e)){i[e].callback(t);}}on(e,t){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new s),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let i=this._eventSubs[e];i||(i={},this._eventSubs[e]=i);const r=this._eventSubIDMap.addItem();i[r]={callback:t},this._eventSubEvents[r]=e;const o=this._events[e];return void 0!==o&&t(o),r}off(e){if(null==e)return;if(!this._eventSubEvents)return;const t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];const s=this._eventSubs[t];s&&delete s[e],this._eventSubIDMap.removeItem(e);}}}function GE(e,t){if(t[e])return t[e];const s=e.split(".");let i=t;for(let e=0,t=s.length;i&&e<t;e++){i=i[s[e]];}return i}function HE(e,t=[]){return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,s){return "{{"===e?"{":"}}"===e?"}":t[s]}))}const zE=f.vec3();const XE=f.vec3(),YE=f.vec3(),KE=f.vec3(),JE=f.vec3(),ZE=f.vec3();class QE extends B{get type(){return "CameraFlightAnimation"}constructor(e,t={}){super(e,t),this._look1=f.vec3(),this._eye1=f.vec3(),this._up1=f.vec3(),this._look2=f.vec3(),this._eye2=f.vec3(),this._up2=f.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==t.easing,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail;}flyTo(e,t,s){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=s;const i=this.scene.camera,r=!!e.projection&&e.projection!==i.projection;let o,n,a,h,l;if(this._eye1[0]=i.eye[0],this._eye1[1]=i.eye[1],this._eye1[2]=i.eye[2],this._look1[0]=i.look[0],this._look1[1]=i.look[1],this._look1[2]=i.look[2],this._up1[0]=i.up[0],this._up1[1]=i.up[1],this._up1[2]=i.up[2],this._orthoScale1=i.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)o=e.aabb;else if(6===e.length)o=e;else if(e.eye&&e.look||e.up)n=e.eye,a=e.look,h=e.up;else if(e.eye)n=e.eye;else if(e.look)a=e.look;else {let i=e;if((b.isNumeric(i)||b.isString(i))&&(l=i,i=this.scene.components[l],!i))return this.error("Component not found: "+b.inQuotes(l)),void(t&&(s?t.call(s):t()));r||(o=i.aabb||this.scene.aabb);}const u=e.poi;if(o){if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return;if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return;o=o.slice();const t=f.getAABB3Center(o);this._look2=u||t;const s=f.subVec3(this._eye1,this._look1,XE),i=f.normalizeVec3(s),r=u?f.getAABB3DiagPoint(o,u):f.getAABB3Diag(o),n=e.fitFOV||this._fitFOV,a=Math.abs(r/Math.tan(n*f.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+i[0]*a,this._eye2[1]=this._look2[1]+i[1]*a,this._eye2[2]=this._look2[2]+i[2]*a,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0;}else (n||a||h)&&(this._flyingEyeLookUp=!!n&&!!a&&!!h,this._flyingEye=!!n&&!a,this._flyingLook=!!a&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),a&&(this._look2[0]=a[0],this._look2[1]=a[1],this._look2[2]=a[2]),h&&(this._up2[0]=h[0],this._up2[1]=h[1],this._up2[2]=h[2]));r?("ortho"===e.projection&&"ortho"!==i.projection&&(this._projection2="ortho",this._projMatrix1=i.projMatrix.slice(),this._projMatrix2=i.ortho.matrix.slice(),i.projection="customProjection"),"perspective"===e.projection&&"perspective"!==i.projection&&(this._projection2="perspective",this._projMatrix1=i.projMatrix.slice(),this._projMatrix2=i.perspective.matrix.slice(),i.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,I.scheduleTask(this._update,this);}jumpTo(e){this._jumpTo(e);}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var s,i,r,o,n;if(e.aabb)s=e.aabb;else if(6===e.length)s=e;else if(e.eye||e.look||e.up)r=e.eye,o=e.look,n=e.up;else {let t=e;if((b.isNumeric(t)||b.isString(t))&&(i=t,t=this.scene.components[i],!t))return void this.error("Component not found: "+b.inQuotes(i));s=t.aabb||this.scene.aabb;}const a=e.poi;if(s){if(s[3]<=s[0]||s[4]<=s[1]||s[5]<=s[2])return;var h=a?f.getAABB3DiagPoint(s,a):f.getAABB3Diag(s);let i;o=a||f.getAABB3Center(s,o),this._trail?f.subVec3(t.look,o,ZE):f.subVec3(t.eye,t.look,ZE),f.normalizeVec3(ZE);i=(void 0!==e.fit?e.fit:this._fit)?Math.abs(h/Math.tan((e.fitFOV||this._fitFOV)*f.DEGTORAD)):f.lenVec3(f.subVec3(t.eye,t.look,XE)),f.mulVec3Scalar(ZE,i),t.eye=f.addVec3(o,ZE,XE),t.look=o,this.scene.camera.ortho.scale=1.1*h;}else (r||o||n)&&(r&&(t.eye=r),o&&(t.look=o),n&&(t.up=n));e.projection&&(t.projection=e.projection);}_update(){if(!this._flying)return;let e=(Date.now()-this._time1)/(this._time2-this._time1);const t=e>=1;e>1&&(e=1);const s=this.easing?QE._ease(e,0,1,1):e,i=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(f.subVec3(i.eye,i.look,ZE),i.eye=f.lerpVec3(s,0,1,this._eye1,this._eye2,KE),i.look=f.subVec3(KE,ZE,YE)):this._flyingLook&&(i.look=f.lerpVec3(s,0,1,this._look1,this._look2,YE),i.up=f.lerpVec3(s,0,1,this._up1,this._up2,JE)):this._flyingEyeLookUp&&(i.eye=f.lerpVec3(s,0,1,this._eye1,this._eye2,KE),i.look=f.lerpVec3(s,0,1,this._look1,this._look2,YE),i.up=f.lerpVec3(s,0,1,this._up1,this._up2,JE)),this._projection2){const t="ortho"===this._projection2?QE._easeOutExpo(e,0,1,1):QE._easeInCubic(e,0,1,1);i.customProjection.matrix=f.lerpMat4(t,0,1,this._projMatrix1,this._projMatrix2);}else i.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1);if(t)return i.ortho.scale=this._orthoScale2,void this.stop();I.scheduleTask(this._update,this);}static _ease(e,t,s,i){return -s*(e/=i)*(e-2)+t}static _easeInCubic(e,t,s,i){return s*(e/=i)*e*e+t}static _easeOutExpo(e,t,s,i){return s*(1-Math.pow(2,-10*e/i))+t}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0);}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0));}set duration(e){this._duration=e?1e3*e:500,this.stop();}get duration(){return this._duration/1e3}set fit(e){this._fit=!1!==e;}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45;}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e;}get trail(){return this._trail}destroy(){this.stop(),super.destroy();}}var $E={};$E.load=function(e,t){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(e){t(e.target.response);},s.send();},$E.save=function(e,t){var s="data:application/octet-stream;base64,"+btoa($E.parse._buffToStr(e));window.location.href=s;},$E.clone=function(e){return JSON.parse(JSON.stringify(e))},$E.bin={},$E.bin.f=new Float32Array(1),$E.bin.fb=new Uint8Array($E.bin.f.buffer),$E.bin.rf=function(e,t){for(var s=$E.bin.f,i=$E.bin.fb,r=0;r<4;r++)i[r]=e[t+r];return s[0]},$E.bin.rsl=function(e,t){return e[t]|e[t+1]<<8},$E.bin.ril=function(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24},$E.bin.rASCII0=function(e,t){for(var s="";0!=e[t];)s+=String.fromCharCode(e[t++]);return s},$E.bin.wf=function(e,t,s){new Float32Array(e.buffer,t,1)[0]=s;},$E.bin.wsl=function(e,t,s){e[t]=s,e[t+1]=s>>8;},$E.bin.wil=function(e,t,s){e[t]=s,e[t+1]=s>>8,e[t+2]=s>>16,e[t+3];},$E.parse={},$E.parse._buffToStr=function(e){for(var t=new Uint8Array(e),s="",i=0;i<t.length;i++)s=s.concat(String.fromCharCode(t[i]));return s},$E.parse._strToBuff=function(e){for(var t=new ArrayBuffer(e.length),s=new Uint8Array(t),i=0;i<e.length;i++)s[i]=e.charCodeAt(i);return t},$E.parse._readLine=function(e,t){for(var s="";10!=e[t];)s+=String.fromCharCode(e[t++]);return s},$E.parse.fromJSON=function(e){return JSON.parse($E.parse._buffToStr(e))},$E.parse.toJSON=function(e){var t=JSON.stringify(e);return $E.parse._strToBuff(t)},$E.parse.fromOBJ=function(e){for(var t={groups:{},c_verts:[],c_uvt:[],c_norms:[],i_verts:[],i_uvt:[],i_norms:[]},s={from:0,to:0},i=0,r=new Uint8Array(e);i<r.length;){var o=$E.parse._readLine(r,i);i+=o.length+1;var n=(o=(o=o.replace(/ +(?= )/g,"")).replace(/(^\s+|\s+$)/g,"")).split(" ");if("g"==n[0]&&(s.to=t.i_verts.length,null==t.groups[n[1]]&&(t.groups[n[1]]={from:t.i_verts.length,to:0}),s=t.groups[n[1]]),"v"==n[0]){var a=parseFloat(n[1]),h=parseFloat(n[2]),l=parseFloat(n[3]);t.c_verts.push(a,h,l);}if("vt"==n[0]){a=parseFloat(n[1]),h=1-parseFloat(n[2]);t.c_uvt.push(a,h);}if("vn"==n[0]){a=parseFloat(n[1]),h=parseFloat(n[2]),l=parseFloat(n[3]);t.c_norms.push(a,h,l);}if("f"==n[0]){var u=n[1].split("/"),c=n[2].split("/"),p=n[3].split("/"),d=parseInt(u[0])-1,f=parseInt(c[0])-1,m=parseInt(p[0])-1,g=parseInt(u[1])-1,_=parseInt(c[1])-1,y=parseInt(p[1])-1,v=parseInt(u[2])-1,b=parseInt(c[2])-1,w=parseInt(p[2])-1,P=t.c_verts.length/3,T=t.c_uvt.length/2,x=t.c_norms.length/3;if(d<0&&(d=P+d+1),f<0&&(f=P+f+1),m<0&&(m=P+m+1),g<0&&(g=T+g+1),_<0&&(_=T+_+1),y<0&&(y=T+y+1),v<0&&(v=x+v+1),b<0&&(b=x+b+1),w<0&&(w=x+w+1),t.i_verts.push(d,f,m),t.i_uvt.push(g,_,y),t.i_norms.push(v,b,w),5==n.length){var M=n[4].split("/"),D=parseInt(M[0])-1,A=parseInt(M[1])-1,C=parseInt(M[2])-1;D<0&&(D=P+D+1),A<0&&(A=T+A+1),C<0&&(C=x+C+1),t.i_verts.push(d,m,D),t.i_uvt.push(g,y,A),t.i_norms.push(v,w,C);}}}return s.to=t.i_verts.length,t},$E.parse.fromMD2=function(e){e=new Uint8Array(e);var t={},s={};s.ident=$E.bin.ril(e,0),s.version=$E.bin.ril(e,4),s.skinwidth=$E.bin.ril(e,8),s.skinheight=$E.bin.ril(e,12),s.framesize=$E.bin.ril(e,16),s.num_skins=$E.bin.ril(e,20),s.num_vertices=$E.bin.ril(e,24),s.num_st=$E.bin.ril(e,28),s.num_tris=$E.bin.ril(e,32),s.num_glcmds=$E.bin.ril(e,36),s.num_frames=$E.bin.ril(e,40),s.offset_skins=$E.bin.ril(e,44),s.offset_st=$E.bin.ril(e,48),s.offset_tris=$E.bin.ril(e,52),s.offset_frames=$E.bin.ril(e,56),s.offset_glcmds=$E.bin.ril(e,60),s.offset_end=$E.bin.ril(e,64);var i=s.offset_st;t.c_uvt=[];for(var r=0;r<s.num_st;r++){var o=$E.bin.rsl(e,i)/s.skinwidth,n=$E.bin.rsl(e,i+2)/s.skinheight;t.c_uvt.push(o,n),i+=4;}i=s.offset_tris;var a=[],h=[];t.i_verts=a,t.i_uvt=h;for(r=0;r<s.num_tris;r++)a.push($E.bin.rsl(e,i),$E.bin.rsl(e,i+2),$E.bin.rsl(e,i+4)),h.push($E.bin.rsl(e,i+6),$E.bin.rsl(e,i+8),$E.bin.rsl(e,i+10)),i+=12;i=s.offset_skins;t.skins=[];for(r=0;r<s.num_skins;r++)t.skins.push($E.bin.rASCII0(e,i)),i+=64;i=s.offset_frames;t.frames=[];var l=$E.parse.fromMD2._normals;for(r=0;r<s.num_frames;r++){var u={},c=$E.bin.rf(e,i),p=$E.bin.rf(e,i+4),d=$E.bin.rf(e,i+8);i+=12;var f=$E.bin.rf(e,i),m=$E.bin.rf(e,i+4),g=$E.bin.rf(e,i+8);i+=12,u.name=$E.bin.rASCII0(e,i),i+=16,u.verts=[],u.norms=[];for(var _=0;_<s.num_vertices;_++)u.verts.push(e[i]*c+f,e[i+1]*p+m,e[i+2]*d+g),u.norms.push(l[3*e[i+3]],l[3*e[i+3]+1],l[3*e[i+3]+2]),i+=4;t.frames.push(u);}return t},$E.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325],$E.parse.fromCollada=function(e){var t=$E.parse._buffToStr(e),s=(new DOMParser).parseFromString(t,"text/xml"),i={},r=(s=s.childNodes[0]).getElementsByTagName("asset")[0],o=s.getElementsByTagName("library_geometries")[0],n=s.getElementsByTagName("library_images")[0],a=s.getElementsByTagName("library_materials")[0],h=s.getElementsByTagName("library_effects")[0];return r&&(i.asset=$E.parse.fromCollada._asset(r)),o&&(i.geometries=$E.parse.fromCollada._libGeometries(o)),n&&(i.images=$E.parse.fromCollada._libImages(n)),a&&(i.materials=$E.parse.fromCollada._libMaterials(a)),h&&(i.effects=$E.parse.fromCollada._libEffects(h)),i},$E.parse.fromCollada._asset=function(e){return {created:e.getElementsByTagName("created")[0].textContent,modified:e.getElementsByTagName("modified")[0].textContent,up_axis:e.getElementsByTagName("up_axis")[0].textContent}},$E.parse.fromCollada._libGeometries=function(e){e=e.getElementsByTagName("geometry");for(var t=[],s=0;s<e.length;s++){var i=e[s],r=$E.parse.fromCollada._getMesh(i.getElementsByTagName("mesh")[0]);t.push(r);}return t},$E.parse.fromCollada._getMesh=function(e){for(var t={},s=e.getElementsByTagName("source"),i=t.sources={},r=0;r<s.length;r++){for(var o=s[r].getElementsByTagName("float_array")[0].textContent.split(" "),n=o.length-(""==o[o.length-1]?1:0),a=new Array(n),h=0;h<n;h++)a[h]=parseFloat(o[h]);i[s[r].getAttribute("id")]=a;}t.triangles=[];var l=e.getElementsByTagName("triangles");if(null==l)return t;for(r=0;r<l.length;r++){var u={},c=l[r];u.material=c.getAttribute("material");var p=c.getElementsByTagName("input"),d=[];for(h=0;h<p.length;h++){var f=p[h];a=[];d[parseInt(f.getAttribute("offset"))]=a;var m=f.getAttribute("semantic");u["s_"+m]="VERTEX"==m?e.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):f.getAttribute("source").substring(1),u["i_"+m]=a,i[u["s_"+m]];}var g=c.getElementsByTagName("p")[0].textContent.split(" "),_=3*Math.floor(g.length/3);for(h=0;h<_;h++)d[h%p.length].push(parseInt(g[h]));t.triangles.push(u);}return t},$E.parse.fromCollada._libImages=function(e){e=e.getElementsByTagName("image");for(var t={},s=0;s<e.length;s++)t[e[s].getAttribute("id")]=e[s].getElementsByTagName("init_from")[0].textContent;return t},$E.parse.fromCollada._libMaterials=function(e){e=e.getElementsByTagName("material");for(var t={},s=0;s<e.length;s++)t[e[s].getAttribute("name")]=e[s].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return t},$E.parse.fromCollada._libEffects=function(e){e=e.getElementsByTagName("effect");for(var t={},s=0;s<e.length;s++){for(var i={},r=e[s].getElementsByTagName("newparam"),o=0;o<r.length;o++){var n=r[o].getElementsByTagName("surface")[0];n&&(i.surface=n.getElementsByTagName("init_from")[0].textContent);}t[e[s].getAttribute("id")]=i;}return t},$E.parse.from3DS=function(e){e=new Uint8Array(e);var t={};if(19789!=$E.bin.rsl(e,0))return null;for(var s=$E.bin.ril(e,2),i=6;i<s;){var r=$E.bin.rsl(e,i),o=$E.bin.ril(e,i+2);15677==r&&(t.edit=$E.parse.from3DS._edit3ds(e,i,o)),45056==r&&(t.keyf=$E.parse.from3DS._keyf3ds(e,i,o)),i+=o;}return t},$E.parse.from3DS._edit3ds=function(e,t,s){for(var i={},r=t+6;r<t+s;){var o=$E.bin.rsl(e,r),n=$E.bin.ril(e,r+2);16384==o&&(null==i.objects&&(i.objects=[]),i.objects.push($E.parse.from3DS._edit_object(e,r,n))),r+=n;}return i},$E.parse.from3DS._keyf3ds=function(e,t,s){for(var i={},r=t+6;r<t+s;){var o=$E.bin.rsl(e,r),n=$E.bin.ril(e,r+2);45058==o&&(null==i.desc&&(i.desc=[]),i.desc.push($E.parse.from3DS._keyf_objdes(e,r,n))),r+=n;}return i},$E.parse.from3DS._keyf_objdes=function(e,t,s){for(var i={},r=t+6;r<t+s;){var o=$E.bin.rsl(e,r),n=$E.bin.ril(e,r+2);45072==o&&(i.hierarchy=$E.parse.from3DS._keyf_objhierarch(e,r,n)),45073==o&&(i.dummy_name=$E.bin.rASCII0(e,r+6)),r+=n;}return i},$E.parse.from3DS._keyf_objhierarch=function(e,t,s){var i={},r=t+6;return i.name=$E.bin.rASCII0(e,r),r+=i.name.length+1,i.hierarchy=$E.bin.rsl(e,r+4),i},$E.parse.from3DS._edit_object=function(e,t,s){var i={},r=t+6;for(i.name=$E.bin.rASCII0(e,r),r+=i.name.length+1;r<t+s;){var o=$E.bin.rsl(e,r),n=$E.bin.ril(e,r+2);16640==o&&(i.mesh=$E.parse.from3DS._obj_trimesh(e,r,n)),r+=n;}return i},$E.parse.from3DS._obj_trimesh=function(e,t,s){for(var i={},r=t+6;r<t+s;){var o=$E.bin.rsl(e,r),n=$E.bin.ril(e,r+2);16656==o&&(i.vertices=$E.parse.from3DS._tri_vertexl(e,r,n)),16672==o&&(i.indices=$E.parse.from3DS._tri_facel1(e,r,n)),16704==o&&(i.uvt=$E.parse.from3DS._tri_mappingcoors(e,r,n)),16736==o&&(i.local=$E.parse.from3DS._tri_local(e,r,n)),r+=n;}return i},$E.parse.from3DS._tri_vertexl=function(e,t,s){var i=[],r=t+6,o=$E.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)i.push($E.bin.rf(e,r)),i.push($E.bin.rf(e,r+4)),i.push($E.bin.rf(e,r+8)),r+=12;return i},$E.parse.from3DS._tri_facel1=function(e,t,s){var i=[],r=t+6,o=$E.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)i.push($E.bin.rsl(e,r)),i.push($E.bin.rsl(e,r+2)),i.push($E.bin.rsl(e,r+4)),r+=8;return i},$E.parse.from3DS._tri_mappingcoors=function(e,t,s){var i=[],r=t+6,o=$E.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)i.push($E.bin.rf(e,r)),i.push(1-$E.bin.rf(e,r+4)),r+=8;return i},$E.parse.from3DS._tri_local=function(e,t,s){var i={},r=t+6;return i.X=[$E.bin.rf(e,r),$E.bin.rf(e,r+4),$E.bin.rf(e,r+8)],r+=12,i.Y=[$E.bin.rf(e,r),$E.bin.rf(e,r+4),$E.bin.rf(e,r+8)],r+=12,i.Z=[$E.bin.rf(e,r),$E.bin.rf(e,r+4),$E.bin.rf(e,r+8)],r+=12,i.C=[$E.bin.rf(e,r),$E.bin.rf(e,r+4),$E.bin.rf(e,r+8)],r+=12,i},$E.parse.fromBIV=function(e){e=new Uint8Array(e);var t={},s={};return s.id=$E.bin.ril(e,0),s.verS=$E.bin.ril(e,4),s.texS=$E.bin.ril(e,8),s.indS=$E.bin.ril(e,12),s.verO=$E.bin.ril(e,16),s.verL=$E.bin.ril(e,20),s.texO=$E.bin.ril(e,24),s.texL=$E.bin.ril(e,28),s.indO=$E.bin.ril(e,32),s.indL=$E.bin.ril(e,36),0!=s.verO&&(t.vertices=$E.parse.fromBIV._readFloats(e,s.verO,s.verL)),0!=s.texO&&(t.uvt=$E.parse.fromBIV._readFloats(e,s.texO,s.texL)),0!=s.indO&&(t.indices=$E.parse.fromBIV._readInts(e,s.indO,s.indL,s.indS)),t},$E.parse.toBIV=function(e){for(var t=0,s=0;s<e.indices.length;s++)t=Math.max(t,e.indices[s]);var i=32;t<=65535&&(i=16);var r=40;e.vertices&&(r+=4*e.vertices.length),e.uvt&&(r+=4*e.uvt.length),e.indices&&(r+=e.indices.length*i/8);var o=new Uint8Array(r);$E.bin.wil(o,0,1769365870),$E.bin.wil(o,4,32),$E.bin.wil(o,8,32),$E.bin.wil(o,12,i);var n=40;return e.vertices&&($E.bin.wil(o,16,n),$E.bin.wil(o,20,4*e.vertices.length),$E.parse.fromBIV._writeFloats(o,n,e.vertices),n+=4*e.vertices.length),e.uvt&&($E.bin.wil(o,24,n),$E.bin.wil(o,28,4*e.uvt.length),$E.parse.fromBIV._writeFloats(o,n,e.uvt),n+=4*e.uvt.length),e.indices&&($E.bin.wil(o,32,n),$E.bin.wil(o,36,4*e.indices.length),$E.parse.fromBIV._writeInts(o,n,e.indices,i)),o.buffer},$E.parse.fromBIV._readFloats=function(e,t,s){for(var i=[],r=0;r<s/4;r++)i.push($E.bin.rf(e,t+4*r));return i},$E.parse.fromBIV._writeFloats=function(e,t,s){for(var i=0;i<s.length;i++)$E.bin.wf(e,t+4*i,s[i]);},$E.parse.fromBIV._readInts=function(e,t,s,i){for(var r=[],o=0;o<s/4;o++)16==i&&r.push($E.bin.rsl(e,t+2*o)),32==i&&r.push($E.bin.ril(e,t+4*o));return r},$E.parse.fromBIV._writeInts=function(e,t,s,i){for(var r=0;r<s.length;r++)16==i&&$E.bin.wsl(e,t+2*r,s[r]),32==i&&$E.bin.wil(e,t+4*r,s[r]);},$E.gen={},$E.gen.Plane=function(e,t,s,i){s||(s=1),i||(i=1);for(var r={verts:[],inds:[],uvt:[]},o=e+1,n=t+1,a=0;a<n;a++)for(var h=0;h<o;h++){var l=h*(2/e)-1,u=a*(2/t)-1;r.verts.push(l,u,0),r.uvt.push(s*h/e,i*a/t),a<t&&h<e&&r.inds.push(a*o+h,a*o+h+1,(a+1)*o+h,a*o+h+1,(a+1)*o+h,(a+1)*o+h+1);}return r},$E.gen.Cube=function(){return {verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,.5,1/4,1/4,.5,.5,.5,1,1/4,3/4,1/4,1,.5,3/4,.5,0,1/4,1/4,1/4,0,.5,1/4,.5,3/4,1/4,.5,1/4,3/4,.5,.5,.5,1/4,1/4,.5,1/4,1/4,0,.5,0,1/4,.5,.5,.5,1/4,3/4,.5,3/4]}},$E.gen.Sphere=function(e,t){for(var s={verts:[],inds:[],uvt:[]},i=e+1,r=t+1,o=0;o<r;o++)for(var n=0;n<i;n++){var a=-Math.PI/2+o*Math.PI/t,h=2*n*Math.PI/e,l=Math.cos(a)*Math.cos(h),u=Math.sin(a),c=Math.cos(a)*Math.sin(h);s.verts.push(l,u,c),s.uvt.push(n/e,o/t),o<t&&n<e&&s.inds.push(i*o+n,i*o+n+1,i*(o+1)+n,i*o+n+1,i*(o+1)+n,i*(o+1)+n+1);}return s},$E.mat={},$E.mat.scale=function(e,t,s){return [e,0,0,0,0,t,0,0,0,0,s,0,0,0,0,1]},$E.mat.translate=function(e,t,s){return [1,0,0,0,0,1,0,0,0,0,1,0,e,t,s,1]},$E.mat.rotateDeg=function(e,t,s){var i=Math.PI/180;return $E.mat.rotate(e*i,t*i,s*i)},$E.mat.rotate=function(e,t,s){var i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=e,o=t,n=s,a=Math.cos(r),h=Math.cos(o),l=Math.cos(n),u=Math.sin(r),c=Math.sin(o),p=Math.sin(n);return i[0]=h*l,i[1]=-h*p,i[2]=c,i[4]=a*p+u*c*l,i[5]=a*l-u*c*p,i[6]=-u*h,i[8]=u*p-a*c*l,i[9]=u*l+a*c*p,i[10]=a*h,i},$E.edit={},$E.edit.interpolate=function(e,t,s,i){for(var r=0;r<e.length;r++)s[r]=e[r]+i*(t[r]-e[r]);},$E.edit.transform=function(e,t){for(var s=0;s<e.length;s+=3){var i=e[s],r=e[s+1],o=e[s+2];e[s+0]=t[0]*i+t[4]*r+t[8]*o+t[12],e[s+1]=t[1]*i+t[5]*r+t[9]*o+t[13],e[s+2]=t[2]*i+t[6]*r+t[10]*o+t[14];}},$E.edit.unwrap=function(e,t,s){for(var i=new Array(Math.floor(e.length/3)*s),r=0;r<e.length;r++)for(var o=0;o<s;o++)i[r*s+o]=t[e[r]*s+o];return i},$E.edit.remap=function(e,t,s,i){for(var r=new Array(s.length),o=0;o<e.length;o++)for(var n=0;n<i;n++)r[t[o]*i+n]=s[e[o]*i+n];return r},$E.utils={},$E.utils.getAABB=function(e){var t,s,i,r,o,n;r=o=n=-(t=s=i=999999999);for(var a=0;a<e.length;a+=3){var h=e[a+0],l=e[a+1],u=e[a+2];h<t&&(t=h),h>r&&(r=h),l<s&&(s=l),l>o&&(o=l),u<i&&(i=u),l>n&&(n=u);}return {min:{x:t,y:s,z:i},max:{x:r,y:o,z:n}}};const oS=f.vec3(),nS=f.vec3();f.vec3();const aS=f.vec3([0,-1,0]),hS=f.vec4([0,0,0,1]);const vS=f.vec3();class bS{constructor(e){if(this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,e){const t=e.metaScene.scene;this.saveObjects(t,e);}}saveObjects(e,t,s){const i=t.rootMetaObject;if(!i)return;const r=i.getObjectIDsInSubtree();this.numObjects=0,this._mask=s?b.apply(s,{}):null;const o=e.objects,n=!s||s.visible,a=!s||s.edges,h=!s||s.xrayed,l=!s||s.highlighted,u=!s||s.selected,c=!s||s.clippable,p=!s||s.pickable,d=!s||s.colorize,f=!s||s.opacity;for(var m=0,g=r.length;m<g;m++){const e=o[r[m]];if(e){if(n&&(this.objectsVisible[m]=e.visible),a&&(this.objectsEdges[m]=e.edges),h&&(this.objectsXrayed[m]=e.xrayed),l&&(this.objectsHighlighted[m]=e.highlighted),u&&(this.objectsSelected[m]=e.selected),c&&(this.objectsClippable[m]=e.clippable),p&&(this.objectsPickable[m]=e.pickable),d){const t=e.colorize;this.objectsColorize[3*m+0]=t[0],this.objectsColorize[3*m+1]=t[1],this.objectsColorize[3*m+2]=t[2];}f&&(this.objectsOpacity[m]=e.opacity),this.numObjects++;}}}restoreObjects(e,t){const s=t.rootMetaObject;if(!s)return;const i=s.getObjectIDsInSubtree(),r=this._mask,o=!r||r.visible,n=!r||r.edges,a=!r||r.xrayed,h=!r||r.highlighted,l=!r||r.selected,u=!r||r.clippable,c=!r||r.pickable,p=!r||r.colorize,d=!r||r.opacity,f=e.objects;for(var m=0,g=i.length;m<g;m++){const e=f[i[m]];e&&(o&&(e.visible=this.objectsVisible[m]),n&&(e.edges=this.objectsEdges[m]),a&&(e.xrayed=this.objectsXrayed[m]),h&&(e.highlighted=this.objectsHighlighted[m]),l&&(e.selected=this.objectsSelected[m]),u&&(e.clippable=this.objectsClippable[m]),c&&(e.pickable=this.objectsPickable[m]),p&&(vS[0]=this.objectsColorize[3*m+0],vS[1]=this.objectsColorize[3*m+1],vS[2]=this.objectsColorize[3*m+2],e.colorize=vS),d&&(e.opacity=this.objectsOpacity[m]));}}}const MS=f.vec4(),DS=f.vec4(),AS=f.vec3(),CS=f.vec3(),IS=f.vec3(),FS=f.vec4(),BS=f.vec4(),ES=f.vec4();class SS{constructor(e){this._scene=e;}dollyToCanvasPos(e,t,s){let i=!1;const r=this._scene.camera;if(e){const t=f.subVec3(e,r.eye,AS);i=f.lenVec3(t)<s;}if("perspective"===r.projection){r.ortho.scale=r.ortho.scale-s;const i=this._unproject(t,FS),o=f.subVec3(i,r.eye,ES),n=f.mulVec3Scalar(f.normalizeVec3(o),-s,[]);if(r.eye=[r.eye[0]-n[0],r.eye[1]-n[1],r.eye[2]-n[2]],r.look=[r.look[0]-n[0],r.look[1]-n[1],r.look[2]-n[2]],e){const t=f.subVec3(e,r.eye,AS),s=f.lenVec3(t),i=f.mulVec3Scalar(f.normalizeVec3(f.subVec3(r.look,r.eye,CS)),s);r.look=[r.eye[0]+i[0],r.eye[1]+i[1],r.eye[2]+i[2]];}}else if("ortho"===r.projection){const e=this._unproject(t,FS);r.ortho.scale=r.ortho.scale-s,r.ortho._update();const i=this._unproject(t,BS),o=f.subVec3(i,e,ES),n=f.mulVec3Scalar(f.normalizeVec3(f.subVec3(r.look,r.eye,AS)),-s,CS),a=f.addVec3(o,n,IS);r.eye=[r.eye[0]-a[0],r.eye[1]-a[1],r.eye[2]-a[2]],r.look=[r.look[0]-a[0],r.look[1]-a[1],r.look[2]-a[2]];}return i}_unproject(e,t){const s=this._scene.camera,i=s.project.transposedMatrix,r=i.subarray(8,12),o=i.subarray(12),n=[0,0,-1,1],a=f.dotVec4(n,r)/f.dotVec4(n,o);return s.project.unproject(e,a,MS,DS,t),t}destroy(){}}const RS=f.vec3(),OS=f.vec3(),LS=f.vec3(),NS=f.vec4(),kS=f.vec4(),jS=f.vec4();class GS{constructor(e,t){this._scene=e,this._configs=t,this._pivotWorldPos=f.vec3(),this._cameraOffset=f.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotViewPos=f.vec4(),this._pivotProjPos=f.vec4(),this._pivotCanvasPos=f.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(()=>{this._cameraDirty=!0;})),this._onProjMatrix=this._scene.camera.on("projMatrix",(()=>{this._cameraDirty=!0;})),this._onTick=this._scene.on("tick",(()=>{this.updatePivotElement();}));}updatePivotElement(){const e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){f.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,f.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);const s=t.boundary,i=s[2],r=s[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*i/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*r/2);const o=t.canvas.getBoundingClientRect();this._pivotElement&&(this._pivotElement.style.left=Math.floor(o.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(o.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1;}}setPivotElement(e){this._pivotElement=e;}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const e=this._scene.camera;let t=f.lookAtMat4v(e.eye,e.look,e.worldUp);f.transformPoint3(t,this.getPivotPos(),this._cameraOffset);const s=this.getPivotPos();this._cameraOffset[2]+=f.distVec3(e.eye,s),t=f.inverseMat4(t);const i=f.transformVec3(t,this._cameraOffset),r=f.vec3();if(f.subVec3(e.eye,s,r),f.addVec3(r,i),e.zUp){const e=r[1];r[1]=r[2],r[2]=e;}this._radius=f.lenVec3(r),this._polar=Math.acos(r[1]/this._radius),this._azimuth=Math.atan2(r[0],r[2]),this._pivoting=!0;}_cameraLookingDownwards(){const e=this._scene.camera,t=f.normalizeVec3(f.subVec3(e.look,e.eye,RS)),s=f.cross3Vec3(t,e.worldUp,OS);return f.sqLenVec3(s)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0;}setCanvasPivotPos(e){const t=this._scene.camera,s=Math.abs(f.distVec3(this._scene.center,t.eye)),i=t.project.transposedMatrix,r=i.subarray(8,12),o=i.subarray(12),n=[0,0,-1,1],a=f.dotVec4(n,r)/f.dotVec4(n,o),h=NS;t.project.unproject(e,a,kS,jS,h);const l=f.normalizeVec3(f.subVec3(h,t.eye,RS)),u=f.addVec3(t.eye,f.mulVec3Scalar(l,s,OS),LS);this.setPivotPos(u);}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(e,t){if(!this._pivoting)return;if(0===e&&0===t)return;const s=this._scene.camera;var i=-e;const r=-t;1===s.worldUp[2]&&(i=-i),this._azimuth+=.01*-i,this._polar+=.01*r,this._polar=f.clamp(this._polar,.001,Math.PI-.001);const o=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===s.worldUp[2]){const e=o[1];o[1]=o[2],o[2]=e;}const n=f.lenVec3(f.subVec3(s.look,s.eye,f.vec3())),a=this.getPivotPos();f.addVec3(o,a);let h=f.lookAtMat4v(o,a,s.worldUp);h=f.inverseMat4(h);const l=f.transformVec3(h,this._cameraOffset);h[12]-=l[0],h[13]-=l[1],h[14]-=l[2];const u=[h[8],h[9],h[10]];s.eye=[h[12],h[13],h[14]],f.subVec3(s.eye,f.mulVec3Scalar(u,n),s.look),s.up=[h[4],h[5],h[6]],this.showPivot();}showPivot(){this._shown||(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible",this._shown=!0,this._hideTimeout=window.setTimeout((()=>{this.hidePivot();}),1e3)));}hidePivot(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._shown=!1);}endPivot(){this._pivoting=!1;}destroy(){this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick);}}class HS{constructor(e,t){this._scene=e.scene,this._cameraControl=e,this._scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault();},this._configs=t,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=f.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1;}update(){if(!this._configs.pointerEnabled)return;if(!this.schedulePickEntity&&!this.schedulePickSurface)return;this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;const e=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const t=this.pickResult.canvasPos;if(t[0]===this.pickCursorPos[0]&&t[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=e,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){const e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1;}fireEvents(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){const e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0));}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1;}}destroy(){}}const VS=f.vec2();class US{constructor(e,t,s,i,r){this._scene=e;const o=t.pickController;let n,a,h,l=0,u=0,c=0,p=0,d=!1;const m=f.vec3();let g=!0;const _=this._scene.canvas.canvas,y=[];function v(e=!0){_.style.cursor="move",l=i.pointerCanvasPos[0],u=i.pointerCanvasPos[1],c=i.pointerCanvasPos[0],p=i.pointerCanvasPos[1],e&&(o.pickCursorPos=i.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(d=!0,m.set(o.pickResult.worldPos)):d=!1);}document.addEventListener("keydown",this._documentKeyDownHandler=t=>{if(!s.active||!s.pointerEnabled||!e.input.keyboardEnabled)return;const i=t.keyCode;y[i]=!0;}),document.addEventListener("keyup",this._documentKeyUpHandler=t=>{if(!s.active||!s.pointerEnabled||!e.input.keyboardEnabled)return;const i=t.keyCode;y[i]=!1;}),_.addEventListener("mousedown",this._mouseDownHandler=t=>{if(s.active&&s.pointerEnabled)switch(t.which){case 1:y[e.input.KEY_SHIFT]||s.planView?(n=!0,v()):(n=!0,v(!1));break;case 2:a=!0,v();break;case 3:h=!0,s.panRightClick&&v();}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{if(!s.active||!s.pointerEnabled)return;if(!n&&!a&&!h)return;const t=e.canvas.boundary,o=t[2]-t[0],c=t[3]-t[1],p=i.pointerCanvasPos[0],g=i.pointerCanvasPos[1];if(y[e.input.KEY_SHIFT]||s.planView||!s.panRightClick&&a||s.panRightClick&&h){const t=p-l,s=g-u,i=e.camera;if("perspective"===i.projection){const o=Math.abs(d?f.lenVec3(f.subVec3(m,e.camera.eye,[])):e.camera.eyeLookDist)*Math.tan(i.perspective.fov/2*Math.PI/180);r.panDeltaX+=1.5*t*o/c,r.panDeltaY+=1.5*s*o/c;}else r.panDeltaX+=.5*i.ortho.scale*(t/c),r.panDeltaY+=.5*i.ortho.scale*(s/c);}else !n||a||h||s.planView||(s.firstPerson?(r.rotateDeltaY-=(p-l)/o*s.dragRotationRate/2,r.rotateDeltaX+=(g-u)/c*(s.dragRotationRate/4)):(r.rotateDeltaY-=(p-l)/o*(1.5*s.dragRotationRate),r.rotateDeltaX+=(g-u)/c*(1.5*s.dragRotationRate)));l=p,u=g;}),_.addEventListener("mousemove",this._canvasMouseMoveHandler=e=>{s.active&&s.pointerEnabled&&i.mouseover&&(g=!0);}),document.addEventListener("mouseup",this._documentMouseUpHandler=e=>{if(s.active&&s.pointerEnabled)switch(e.which){case 1:case 2:case 3:n=!1,a=!1,h=!1;}}),_.addEventListener("mouseup",this._mouseUpHandler=e=>{if(s.active&&s.pointerEnabled){if(3===e.which){!function(e,t){if(e){let s=e.target,i=0,r=0;for(;s.offsetParent;)i+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;t[0]=e.pageX-i,t[1]=e.pageY-r;}else e=window.event,t[0]=e.x,t[1]=e.y;}(e,VS);const s=VS[0],i=VS[1];Math.abs(s-c)<3&&Math.abs(i-p)<3&&t.cameraControl.fire("rightClick",{pagePos:[Math.round(e.pageX),Math.round(e.pageY)],canvasPos:VS,event:e},!0);}_.style.removeProperty("cursor");}}),_.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.active&&s.pointerEnabled;});const b=1/60;let w=null;_.addEventListener("wheel",this._mouseWheelHandler=e=>{if(!s.active||!s.pointerEnabled)return;const t=performance.now()/1e3;var o=null!==w?t-w:0;w=t,o>.05&&(o=.05),o<b&&(o=b);const n=Math.max(-1,Math.min(1,40*-e.deltaY));if(0===n)return;const a=n/Math.abs(n);r.dollyDelta+=-a*o*s.mouseWheelDollyRate,g&&(i.followPointerDirty=!0,g=!1);},{passive:!0});}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler);}}const zS=f.vec3(),WS=f.vec3(),XS=f.vec3(),YS=f.vec3(),KS=f.vec3(),JS={eye:f.vec3(),look:f.vec3(),up:f.vec3()};class ZS{constructor(e,t,s,i){this._scene=e;const r=t.cameraControl,o=e.camera;this._onSceneKeyDown=e.input.on("keydown",(()=>{if(!s.active||!s.pointerEnabled||!e.input.keyboardEnabled)return;if(!i.mouseover)return;const n=r._isKeyDownForAction(r.AXIS_VIEW_RIGHT),a=r._isKeyDownForAction(r.AXIS_VIEW_BACK),h=r._isKeyDownForAction(r.AXIS_VIEW_LEFT),l=r._isKeyDownForAction(r.AXIS_VIEW_FRONT),u=r._isKeyDownForAction(r.AXIS_VIEW_TOP),c=r._isKeyDownForAction(r.AXIS_VIEW_BOTTOM);if(!(n||a||h||l||u||c))return;const p=e.aabb,d=f.getAABB3Diag(p);f.getAABB3Center(p,zS);const m=Math.abs(d/Math.tan(t.cameraFlight.fitFOV*f.DEGTORAD)),g=1.1*d;JS.orthoScale=g,n?(JS.eye.set(f.addVec3(zS,f.mulVec3Scalar(o.worldRight,m,WS),KS)),JS.look.set(zS),JS.up.set(o.worldUp)):a?(JS.eye.set(f.addVec3(zS,f.mulVec3Scalar(o.worldForward,m,WS),KS)),JS.look.set(zS),JS.up.set(o.worldUp)):h?(JS.eye.set(f.addVec3(zS,f.mulVec3Scalar(o.worldRight,-m,WS),KS)),JS.look.set(zS),JS.up.set(o.worldUp)):l?(JS.eye.set(f.addVec3(zS,f.mulVec3Scalar(o.worldForward,-m,WS),KS)),JS.look.set(zS),JS.up.set(o.worldUp)):u?(JS.eye.set(f.addVec3(zS,f.mulVec3Scalar(o.worldUp,m,WS),KS)),JS.look.set(zS),JS.up.set(f.normalizeVec3(f.mulVec3Scalar(o.worldForward,1,XS),YS))):c&&(JS.eye.set(f.addVec3(zS,f.mulVec3Scalar(o.worldUp,-m,WS),KS)),JS.look.set(zS),JS.up.set(f.normalizeVec3(f.mulVec3Scalar(o.worldForward,-1,XS)))),!s.firstPerson&&s.followPointer&&t.pivotController.setPivotPos(zS),t.cameraFlight.duration>0?t.cameraFlight.flyTo(JS,(()=>{t.pivotController.getPivoting()&&s.followPointer&&t.pivotController.showPivot();})):(t.cameraFlight.jumpTo(JS),t.pivotController.getPivoting()&&s.followPointer&&t.pivotController.showPivot());}));}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown);}}class QS{constructor(e,t,s,i,r){this._scene=e;const o=t.pickController,n=t.pivotController,a=t.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let h=!1,l=!1;const u=this._scene.canvas.canvas,c=s=>{let i;s&&s.worldPos&&(i=s.worldPos);const r=s&&s.entity?s.entity.aabb:e.aabb;if(i){const s=e.camera;f.subVec3(s.eye,s.look,[]),t.cameraFlight.flyTo({aabb:r});}else t.cameraFlight.flyTo({aabb:r});};u.addEventListener("mousemove",this._canvasMouseMoveHandler=t=>{if(!s.active||!s.pointerEnabled)return;if(h||l)return;const r=a.hasSubs("hover"),n=a.hasSubs("hoverOut"),u=a.hasSubs("hoverOff"),c=a.hasSubs("hoverSurface");if(r||n||u||c)if(o.pickCursorPos=i.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=c,o.update(),o.pickResult){const t=o.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&a.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),a.fire("hoverEnter",o.pickResult,!0),this._lastPickedEntityId=t),a.fire("hover",o.pickResult,!0),o.pickResult.worldPos&&a.fire("hoverSurface",o.pickResult,!0);}else void 0!==this._lastPickedEntityId&&(a.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),a.fire("hoverOff",{canvasPos:o.pickCursorPos},!0);}),u.addEventListener("mousedown",this._canvasMouseDownHandler=t=>{1===t.which&&(h=!0),3===t.which&&(l=!0);if(1===t.which&&s.active&&s.pointerEnabled&&(i.mouseDownClientX=t.clientX,i.mouseDownClientY=t.clientY,i.mouseDownCursorX=i.pointerCanvasPos[0],i.mouseDownCursorY=i.pointerCanvasPos[1],!s.firstPerson&&s.followPointer&&(o.pickCursorPos=i.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),1===t.which))){const t=o.pickResult;t&&t.worldPos?(n.setPivotPos(t.worldPos),n.startPivot()):(s.smartPivot?n.setCanvasPivotPos(i.pointerCanvasPos):n.setPivotPos(e.camera.look),n.startPivot());}}),document.addEventListener("mouseup",this._documentMouseUpHandler=e=>{1===e.which&&(h=!1),3===e.which&&(l=!1);}),u.addEventListener("mouseup",this._canvasMouseUpHandler=r=>{if(!s.active||!s.pointerEnabled)return;if(!(1===r.which))return;if(n.hidePivot(),Math.abs(r.clientX-i.mouseDownClientX)>3||Math.abs(r.clientY-i.mouseDownClientY)>3)return;const h=a.hasSubs("picked"),l=a.hasSubs("pickedNothing"),u=a.hasSubs("pickedSurface"),p=a.hasSubs("doublePicked"),d=a.hasSubs("doublePickedSurface"),m=a.hasSubs("doublePickedNothing");if(!(s.doublePickFlyTo||p||d||m))return (h||l||u)&&(o.pickCursorPos=i.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=u,o.update(),o.pickResult?(a.fire("picked",o.pickResult,!0),o.pickedSurface&&a.fire("pickedSurface",o.pickResult,!0)):a.fire("pickedNothing",{canvasPos:i.pointerCanvasPos},!0)),void(this._clicks=0);if(this._clicks++,1===this._clicks){o.pickCursorPos=i.pointerCanvasPos,o.schedulePickEntity=s.doublePickFlyTo,o.schedulePickSurface=u,o.update();const e=o.pickResult,r=o.pickedSurface;this._timeout=setTimeout((()=>{e?(a.fire("picked",e,!0),r&&(a.fire("pickedSurface",e,!0),!s.firstPerson&&s.followPointer&&(t.pivotController.setPivotPos(e.worldPos),t.pivotController.startPivot()&&t.pivotController.showPivot()))):a.fire("pickedNothing",{canvasPos:i.pointerCanvasPos},!0),this._clicks=0;}),s.doubleClickTimeFrame);}else {if(null!==this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),o.pickCursorPos=i.pointerCanvasPos,o.schedulePickEntity=s.doublePickFlyTo||p||d,o.schedulePickSurface=o.schedulePickEntity&&d,o.update(),o.pickResult){if(a.fire("doublePicked",o.pickResult,!0),o.pickedSurface&&a.fire("doublePickedSurface",o.pickResult,!0),s.doublePickFlyTo&&(c(o.pickResult),!s.firstPerson&&s.followPointer)){const e=o.pickResult.entity.aabb,s=f.getAABB3Center(e);t.pivotController.setPivotPos(s),t.pivotController.startPivot()&&t.pivotController.showPivot();}}else if(a.fire("doublePickedNothing",{canvasPos:i.pointerCanvasPos},!0),s.doublePickFlyTo&&(c(),!s.firstPerson&&s.followPointer)){const s=e.aabb,i=f.getAABB3Center(s);t.pivotController.setPivotPos(i),t.pivotController.startPivot()&&t.pivotController.showPivot();}this._clicks=0;}},!1);}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null);}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null);}}class qS{constructor(e,t,s,i,r){this._scene=e;const o=e.input,n=[],a=e.canvas.canvas;let h=!0;this._onSceneMouseMove=o.on("mousemove",(()=>{h=!0;})),this._onSceneKeyDown=o.on("keydown",(t=>{s.active&&s.pointerEnabled&&e.input.keyboardEnabled&&i.mouseover&&(n[t]=!0,t===o.KEY_SHIFT&&(a.style.cursor="move"));})),this._onSceneKeyUp=o.on("keyup",(t=>{s.active&&s.pointerEnabled&&e.input.keyboardEnabled&&i.mouseover&&(n[t]=!1,t===o.KEY_SHIFT&&(a.style.cursor=null));})),this._onTick=e.on("tick",(a=>{if(!s.active||!s.pointerEnabled||!e.input.keyboardEnabled)return;if(!i.mouseover)return;const l=t.cameraControl,u=a.deltaTime/1e3;if(!s.planView){const e=l._isKeyDownForAction(l.ROTATE_Y_POS,n),i=l._isKeyDownForAction(l.ROTATE_Y_NEG,n),o=l._isKeyDownForAction(l.ROTATE_X_POS,n),a=l._isKeyDownForAction(l.ROTATE_X_NEG,n),h=u*s.keyboardRotationRate;(e||i||o||a)&&(!s.firstPerson&&s.followPointer&&t.pivotController.startPivot(),e?r.rotateDeltaY+=h:i&&(r.rotateDeltaY-=h),o?r.rotateDeltaX+=h:a&&(r.rotateDeltaX-=h),!s.firstPerson&&s.followPointer&&t.pivotController.startPivot());}if(!n[o.KEY_CTRL]&&!n[o.KEY_ALT]){const e=l._isKeyDownForAction(l.DOLLY_BACKWARDS,n),o=l._isKeyDownForAction(l.DOLLY_FORWARDS,n);if(e||o){const n=u*s.keyboardDollyRate;!s.firstPerson&&s.followPointer&&t.pivotController.startPivot(),o?r.dollyDelta-=n:e&&(r.dollyDelta+=n),h&&(i.followPointerDirty=!0,h=!1);}}const c=l._isKeyDownForAction(l.PAN_FORWARDS,n),p=l._isKeyDownForAction(l.PAN_BACKWARDS,n),d=l._isKeyDownForAction(l.PAN_LEFT,n),f=l._isKeyDownForAction(l.PAN_RIGHT,n),m=l._isKeyDownForAction(l.PAN_UP,n),g=l._isKeyDownForAction(l.PAN_DOWN,n),_=(n[o.KEY_ALT]?.3:1)*u*s.keyboardPanRate;(c||p||d||f||m||g)&&(!s.firstPerson&&s.followPointer&&t.pivotController.startPivot(),g?r.panDeltaY+=_:m&&(r.panDeltaY+=-_),f?r.panDeltaX+=-_:d&&(r.panDeltaX+=_),p?r.panDeltaZ+=_:c&&(r.panDeltaZ+=-_));}));}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp);}}const $S=f.vec3();class eR{constructor(e,t,s,i,r){this._scene=e;const o=e.camera,n=t.pickController,a=t.pivotController,h=t.panController;let l=1,u=1,c=null;this._onTick=e.on("tick",(()=>{if(!s.active||!s.pointerEnabled)return;let t="default";if(Math.abs(r.dollyDelta)<.001&&(r.dollyDelta=0),Math.abs(r.rotateDeltaX)<.001&&(r.rotateDeltaX=0),Math.abs(r.rotateDeltaY)<.001&&(r.rotateDeltaY=0),0===r.rotateDeltaX&&0===r.rotateDeltaY||(r.dollyDelta=0),s.followPointer&&--l<=0&&(l=1,0!==r.dollyDelta)){if(0===r.rotateDeltaY&&0===r.rotateDeltaX&&s.followPointer&&i.followPointerDirty&&(n.pickCursorPos=i.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.pickResult&&n.pickResult.worldPos?c=n.pickResult.worldPos:(u=1,c=null),i.followPointerDirty=!1),c){const t=Math.abs(f.lenVec3(f.subVec3(c,e.camera.eye,$S)));u=t/s.dollyProximityThreshold;}u<s.dollyMinSpeed&&(u=s.dollyMinSpeed);}const p=r.dollyDelta*u;if(0===r.rotateDeltaY&&0===r.rotateDeltaX||(!s.firstPerson&&s.followPointer&&a.getPivoting()?(a.continuePivot(r.rotateDeltaY,r.rotateDeltaX),a.showPivot()):(0!==r.rotateDeltaX&&(s.firstPerson?o.pitch(-r.rotateDeltaX):o.orbitPitch(r.rotateDeltaX)),0!==r.rotateDeltaY&&(s.firstPerson?o.yaw(r.rotateDeltaY):o.orbitYaw(r.rotateDeltaY))),r.rotateDeltaX*=s.rotationInertia,r.rotateDeltaY*=s.rotationInertia,t="grabbing"),Math.abs(r.panDeltaX)<.001&&(r.panDeltaX=0),Math.abs(r.panDeltaY)<.001&&(r.panDeltaY=0),Math.abs(r.panDeltaZ)<.001&&(r.panDeltaZ=0),0!==r.panDeltaX||0!==r.panDeltaY||0!==r.panDeltaZ){const e=f.vec3();let i,n;if(e[0]=r.panDeltaX,e[1]=r.panDeltaY,e[2]=r.panDeltaZ,s.constrainVertical){o.xUp?(i=o.eye[0],n=o.look[0]):o.yUp?(i=o.eye[1],n=o.look[1]):o.zUp&&(i=o.eye[2],n=o.look[2]),o.pan(e);const t=o.eye,s=o.look;o.xUp?(t[0]=i,s[0]=n):o.yUp?(t[1]=i,s[1]=n):o.zUp&&(t[2]=i,s[2]=n),o.eye=t,o.look=s;}else o.pan(e);t="grabbing";}if(r.panDeltaX*=s.panInertia,r.panDeltaY*=s.panInertia,r.panDeltaZ*=s.panInertia,0!==p){if(t=p<0?"zoom-in":"zoom-out",s.firstPerson){let e,t;if(s.constrainVertical&&(o.xUp?(e=o.eye[0],t=o.look[0]):o.yUp?(e=o.eye[1],t=o.look[1]):o.zUp&&(e=o.eye[2],t=o.look[2])),s.followPointer){h.dollyToCanvasPos(c,i.pointerCanvasPos,-p)&&(i.followPointerDirty=!0);}else o.pan([0,0,p]),o.ortho.scale=o.ortho.scale-p;if(s.constrainVertical){const s=o.eye,i=o.look;o.xUp?(s[0]=e,i[0]=t):o.yUp?(s[1]=e,i[1]=t):o.zUp&&(s[2]=e,i[2]=t),o.eye=s,o.look=i;}}else if(s.planView)if(s.followPointer){h.dollyToCanvasPos(c,i.pointerCanvasPos,-p)&&(i.followPointerDirty=!0);}else o.ortho.scale=o.ortho.scale+p,o.zoom(p);else if(s.followPointer){h.dollyToCanvasPos(c,i.pointerCanvasPos,-p)&&(i.followPointerDirty=!0);}else o.ortho.scale=o.ortho.scale+p,o.zoom(p);r.dollyDelta*=s.dollyInertia;}n.fireEvents(),document.body.style.cursor=t;}));}destroy(){this._scene.off(this._onTick);}}class tR{constructor(e,t,s,i,r){this._scene=e;const o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.mouseover=!0;}),o.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{i.mouseover=!1,o.style.cursor=null;}),document.addEventListener("mousemove",this._mouseMoveHandler=e=>{sR(e,o,i.pointerCanvasPos);}),o.addEventListener("mousedown",this._mouseDownHandler=e=>{s.active&&s.pointerEnabled&&(sR(e,o,i.pointerCanvasPos),i.mouseover=!0);}),o.addEventListener("mouseup",this._mouseUpHandler=e=>{s.active&&s.pointerEnabled;});}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler);}}function sR(e,t,s){if(e){const{x:i,y:r}=t.getBoundingClientRect();s[0]=e.clientX-i,s[1]=e.clientY-r;}else e=window.event,s[0]=e.x,s[1]=e.y;return s}const iR=function(e,t){if(e){let s=e.target,i=0,r=0;for(;s.offsetParent;)i+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;t[0]=e.pageX-i,t[1]=e.pageY-r;}else e=window.event,t[0]=e.x,t[1]=e.y;return t};class rR{constructor(e,t,s,i,r){this._scene=e;const o=t.pickController,n=t.pivotController,a=f.vec2(),h=f.vec2(),l=f.vec2(),u=f.vec2(),c=[],p=this._scene.canvas.canvas;let d=0,m=!1;this._onTick=e.on("tick",(()=>{m=!1;})),p.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{if(!s.active||!s.pointerEnabled)return;t.preventDefault();const r=t.touches,h=t.changedTouches;for(i.touchStartTime=Date.now(),1===r.length&&1===h.length&&(iR(r[0],a),s.followPointer&&(o.pickCursorPos=a,o.schedulePickSurface=!0,o.update(),s.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(n.setPivotPos(o.pickResult.worldPos),!s.firstPerson&&n.startPivot()&&n.showPivot()):(s.smartPivot?n.setCanvasPivotPos(i.pointerCanvasPos):n.setPivotPos(e.camera.look),!s.firstPerson&&n.startPivot()&&n.showPivot()))));c.length<r.length;)c.push(f.vec2());for(let e=0,t=r.length;e<t;++e)iR(r[e],c[e]);d=r.length;}),p.addEventListener("touchmove",this._canvasTouchMoveHandler=t=>{if(!s.active||!s.pointerEnabled)return;if(t.stopPropagation(),t.preventDefault(),m)return;m=!0;const n=e.canvas.boundary,a=n[2]-n[0],p=n[3]-n[1],g=t.touches;if(t.touches.length===d){if(1===d){iR(g[0],h),f.subVec2(h,c[0],u);const t=u[0],o=u[1];if(null!==i.longTouchTimeout&&(Math.abs(t)>s.longTapRadius||Math.abs(o)>s.longTapRadius)&&(clearTimeout(i.longTouchTimeout),i.longTouchTimeout=null),s.planView){const i=e.camera;if("perspective"===i.projection){const n=Math.abs(e.camera.eyeLookDist)*Math.tan(i.perspective.fov/2*Math.PI/180);r.panDeltaX+=t*n/p*s.touchPanRate,r.panDeltaY+=o*n/p*s.touchPanRate;}else r.panDeltaX+=.5*i.ortho.scale*(t/p)*s.touchPanRate,r.panDeltaY+=.5*i.ortho.scale*(o/p)*s.touchPanRate;}else r.rotateDeltaY-=t/a*(1*s.dragRotationRate),r.rotateDeltaX+=o/p*(1.5*s.dragRotationRate);}else if(2===d){const t=g[0],n=g[1];iR(t,h),iR(n,l);const a=f.geometricMeanVec2(c[0],c[1]),u=f.geometricMeanVec2(h,l),d=f.vec2();f.subVec2(a,u,d);const m=d[0],_=d[1],y=e.camera,v=f.distVec2([t.pageX,t.pageY],[n.pageX,n.pageY]),b=(f.distVec2(c[0],c[1])-v)*s.touchDollyRate;if(r.dollyDelta=b,Math.abs(b)<1)if("perspective"===y.projection){const t=o.pickResult?o.pickResult.worldPos:e.center,i=Math.abs(f.lenVec3(f.subVec3(t,e.camera.eye,[])))*Math.tan(y.perspective.fov/2*Math.PI/180);r.panDeltaX-=m*i/p*s.touchPanRate,r.panDeltaY-=_*i/p*s.touchPanRate;}else r.panDeltaX-=.5*y.ortho.scale*(m/p)*s.touchPanRate,r.panDeltaY-=.5*y.ortho.scale*(_/p)*s.touchPanRate;i.pointerCanvasPos=u;}for(let e=0;e<d;++e)iR(g[e],c[e]);}});}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick);}}const oR=function(e,t){if(e){let s=e.target,i=0,r=0;for(;s.offsetParent;)i+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;t[0]=e.pageX-i,t[1]=e.pageY-r;}else e=window.event,t[0]=e.x,t[1]=e.y;return t};class nR{constructor(e,t,s,i,r){this._scene=e;const o=t.pickController,n=t.cameraControl;let a;const h=[],l=new Float32Array(2);let u=-1,c=-1;const p=this._scene.canvas.canvas,d=s=>{let i;s&&s.worldPos&&(i=s.worldPos);const r=s?s.entity.aabb:e.aabb;if(i){const s=e.camera;f.subVec3(s.eye,s.look,[]),t.cameraFlight.flyTo({aabb:r});}else t.cameraFlight.flyTo({aabb:r});};p.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{if(!s.active||!s.pointerEnabled)return;null!==i.longTouchTimeout&&(clearTimeout(i.longTouchTimeout),i.longTouchTimeout=null);const r=e.touches,o=e.changedTouches;if(a=Date.now(),1===r.length&&1===o.length){u=a,oR(r[0],l);const o=l[0],n=l[1],h=r[0].pageX,c=r[0].pageY;i.longTouchTimeout=setTimeout((()=>{t.cameraControl.fire("rightClick",{pagePos:[Math.round(h),Math.round(c)],canvasPos:[Math.round(o),Math.round(n)],event:e},!0),i.longTouchTimeout=null;}),s.longTapTimeout);}else u=-1;for(;h.length<r.length;)h.push(new Float32Array(2));for(let e=0,t=r.length;e<t;++e)oR(r[e],h[e]);h.length=r.length;},{passive:!0}),p.addEventListener("touchend",this._canvasTouchEndHandler=e=>{if(!s.active||!s.pointerEnabled)return;const t=Date.now(),r=e.touches,a=e.changedTouches,p=n.hasSubs("pickedSurface");null!==i.longTouchTimeout&&(clearTimeout(i.longTouchTimeout),i.longTouchTimeout=null),0===r.length&&1===a.length&&u>-1&&t-u<150&&(c>-1&&u-c<325?(oR(a[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=p,o.update(),o.pickResult?(n.fire("doublePicked",o.pickResult),o.pickedSurface&&n.fire("doublePickedSurface",o.pickResult),s.doublePickFlyTo&&d(o.pickResult)):(n.fire("doublePickedNothing"),s.doublePickFlyTo&&d()),c=-1):f.distVec2(h[0],l)<4&&(oR(a[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=p,o.update(),o.pickResult?(n.fire("picked",o.pickResult),o.pickedSurface&&n.fire("pickedSurface",o.pickResult)):n.fire("pickedNothing"),c=t),u=-1),h.length=r.length;for(let e=0,t=r.length;e<t;++e)h[e][0]=r[e].pageX,h[e][1]=r[e].pageY;e.stopPropagation();},{passive:!0});}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler);}}class aR extends B{constructor(e,t={}){super(e,t),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=e=>{e.preventDefault();},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:f.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:f.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const s=this.scene;this._controllers={cameraControl:this,pickController:new HS(this,this._configs),pivotController:new GS(s,this._configs),panController:new SS(s),cameraFlight:new QE(this,{duration:.5})},this._handlers=[new tR(this.scene,this._controllers,this._configs,this._states,this._updates),new rR(this.scene,this._controllers,this._configs,this._states,this._updates),new US(this.scene,this._controllers,this._configs,this._states,this._updates),new ZS(this.scene,this._controllers,this._configs,this._states,this._updates),new QS(this.scene,this._controllers,this._configs,this._states,this._updates),new nR(this.scene,this._controllers,this._configs,this._states,this._updates),new qS(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new eR(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=t.navMode,t.planView&&(this.planView=t.planView),this.constrainVertical=t.constrainVertical,t.keyboardLayout?this.keyboardLayout=t.keyboardLayout:this.keyMap=t.keyMap,this.doublePickFlyTo=t.doublePickFlyTo,this.panRightClick=t.panRightClick,this.active=t.active,this.followPointer=t.followPointer,this.rotationInertia=t.rotationInertia,this.keyboardPanRate=t.keyboardPanRate,this.touchPanRate=t.touchPanRate,this.keyboardRotationRate=t.keyboardRotationRate,this.dragRotationRate=t.dragRotationRate,this.touchDollyRate=t.touchDollyRate,this.dollyInertia=t.dollyInertia,this.dollyProximityThreshold=t.dollyProximityThreshold,this.dollyMinSpeed=t.dollyMinSpeed,this.panInertia=t.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=t.keyboardDollyRate,this.mouseWheelDollyRate=t.mouseWheelDollyRate;}set keyMap(e){if(e=e||"qwerty",b.isString(e)){const t=this.scene.input,s={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":s[this.PAN_LEFT]=[t.KEY_A],s[this.PAN_RIGHT]=[t.KEY_D],s[this.PAN_UP]=[t.KEY_Z],s[this.PAN_DOWN]=[t.KEY_X],s[this.PAN_BACKWARDS]=[],s[this.PAN_FORWARDS]=[],s[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],s[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],s[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],s[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],s[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],s[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],s[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],s[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],s[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],s[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],s[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],s[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6];break;case"azerty":s[this.PAN_LEFT]=[t.KEY_Q],s[this.PAN_RIGHT]=[t.KEY_D],s[this.PAN_UP]=[t.KEY_W],s[this.PAN_DOWN]=[t.KEY_X],s[this.PAN_BACKWARDS]=[],s[this.PAN_FORWARDS]=[],s[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],s[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],s[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],s[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],s[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],s[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],s[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],s[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],s[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],s[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],s[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],s[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6];}this._keyMap=s;}else {const t=e;this._keyMap=t;}}get keyMap(){return this._keyMap}_isKeyDownForAction(e,t){const s=this._keyMap[e];if(!s)return !1;t||(t=this.scene.input.keyDown);for(let e=0,i=s.length;e<i;e++){if(t[s[e]])return !0}return !1}set pivotElement(e){this._controllers.pivotController.setPivotElement(e);}set active(e){this._configs.active=!1!==e;}get active(){return this._configs.active}set navMode(e){"firstPerson"!==(e=e||"orbit")&&"orbit"!==e&&"planView"!==e&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson="firstPerson"===e,this._configs.planView="planView"===e,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e;}get navMode(){return this._configs.navMode}set pointerEnabled(e){this._reset(),this._configs.pointerEnabled=!!e;}_reset(){for(let e=0,t=this._handlers.length;e<t;e++){const t=this._handlers[e];t.reset&&t.reset();}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0;}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(e){this._configs.followPointer=!1!==e;}get followPointer(){return this._configs.followPointer}set pivotPos(e){this._controllers.pivotController.setPivotPos(e);}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e;}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(e){this.warn("panToPointer property is deprecated - replaced with followPointer");}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode");}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot());}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(e){this._configs.constrainVertical=!!e;}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(e){this._configs.doublePickFlyTo=!1!==e;}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(e){this._configs.panRightClick=!1!==e;}get panRightClick(){return this._configs.panRightClick}set rotationInertia(e){this._configs.rotationInertia=null!=e?e:0;}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(e){this._configs.keyboardPanRate=null!=e?e:5;}set touchPanRate(e){this._configs.touchPanRate=null!=e?e:1;}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(e){this._configs.keyboardRotationRate=null!=e?e:90;}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(e){this._configs.dragRotationRate=null!=e?e:360;}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(e){this._configs.keyboardDollyRate=null!=e?e:15;}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(e){this._configs.touchDollyRate=null!=e?e:.2;}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(e){this._configs.mouseWheelDollyRate=null!=e?e:100;}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(e){this._configs.dollyInertia=null!=e?e:0;}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(e){this._configs.dollyProximityThreshold=null!=e?e:35;}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(e){this._configs.dollyMinSpeed=null!=e?e:.04;}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(e){this._configs.panInertia=null!=e?e:.5;}get panInertia(){return this._configs.panInertia}set keyboardLayout(e){"qwerty"!==(e=e||"qwerty")&&"azerty"!==e&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout;}get keyboardLayout(){return this._configs.keyboardLayout}set smartPivot(e){this._configs.smartPivot=!1!==e;}get smartPivot(){return this._configs.smartPivot}set doubleClickTimeFrame(e){this._configs.doubleClickTimeFrame=null!=e?e:250;}get doubleClickTimeFrame(){return this._configs.doubleClickTimeFrame}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy();}_destroyHandlers(){for(let e=0,t=this._handlers.length;e<t;e++){const t=this._handlers[e];t.destroy&&t.destroy();}}_destroyControllers(){for(let e=0,t=this._controllers.length;e<t;e++){const t=this._controllers[e];t.destroy&&t.destroy();}}}class hR{constructor(e,t,s,i,r,o,n,a,h,l){this.id=t,this.projectId=s,this.revisionId=i,this.author=r,this.createdAt=o,this.creatingApplication=n,this.schema=a,this.metaScene=e,this.propertySets=h,this.rootMetaObject=l;}getJSON(){const e=[];!function t(s){const i={id:s.id,extId:s.extId,type:s.type,name:s.name};s.parent&&(i.parent=s.parent.id),e.push(i);const r=s.children;if(r)for(let e=0,s=r.length;e<s;e++)t(r[e]);}(this.rootMetaObject);return {id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:e}}}class lR{constructor(e,t,s,i,r,o,n,a,h){this.metaModel=e,this.id=t,this.originalSystemId=s,this.name=i,this.type=r,this.propertySets=o,null!=n&&(this.parent=n),null!=a&&(this.children=a),null!=h&&(this.external=h);}getObjectIDsInSubtree(){const e=[];return function t(s){if(!s)return;e.push(s.id);const i=s.children;if(i)for(var r=0,o=i.length;r<o;r++)t(i[r]);}(this),e}withMetaObjectsInSubtree(e){!function t(s){if(!s)return;e(s);const i=s.children;if(i)for(var r=0,o=i.length;r<o;r++)t(i[r]);}(this);}getObjectIDsInSubtreeByType(e){const t={};for(var s=0,i=e.length;s<i;s++)t[e[s]]=e[s];const r=[];return function e(s){if(!s)return;t[s.type]&&r.push(s.id);const i=s.children;if(i)for(var o=0,n=i.length;o<n;o++)e(i[o]);}(this),r}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class uR{constructor(e,t,s,i,r){this.name=e,this.type=s,this.value=t,this.valueType=i,this.description=r;}}class cR{constructor(e,t,s,i,r){if(this.id=e,this.originalSystemId=t,this.name=s,this.type=i,this.properties=[],r)for(let e=0,t=r.length;e<t;e++){const t=r[e];this.properties.push(new uR(t.name,t.value,t.type,t.valueType,t.description));}}}class pR{constructor(e,t){this.viewer=e,this.scene=t,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={};}on(e,t){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(t);}fire(e,t){const s=this._eventSubs[e];if(s)for(let e=0,i=s.length;e<i;e++)s[e](t);}off(e){}createMetaModel(e,t,s={}){const i=t.projectId||"none",r=t.revisionId||"none",o=t.propertySets||[],n=t.metaObjects||[],a=t.author,h=t.createdAt,l=t.creatingApplication,u=t.schema,c=new hR(this,e,i,r,a,h,l,u,[],null);this.metaModels[e]=c;for(let e=0,t=o.length;e<t;e++){const t=o[e],s=t.id,i=new cR(s,t.originalSystemId,t.name,t.type,t.properties);c.propertySets[s]=i,this.propertySets[s]=i;}const p=[];for(let e=0,t=n.length;e<t;e++){const t=n[e];void 0!==t.parent&&null!==t.parent||p.push(t);}if(0===p.length){this.scene.error("Cyclic containment hierarchy found in metamodel - will flatten the hierarchy and insert fake 'Model' root");const t={id:e+".fakeRoot",name:e,type:"Model",parent:null};for(let e=0,s=n.length;e<s;e++)n[e].parent=t.id;n.push(t);}if(p.length>1){this.scene.error("Multiple containment hierarchy root found in metamodel - will insert fake 'Model' root");const t={id:e+".fakeRoot",name:e,type:"Model",parent:null};n.push(t);for(let e=0,s=p.length;e<s;e++)p[e].parent=t.id;}for(let t=0,i=n.length;t<i;t++){const i=n[t],r=i.type,o=s.globalizeObjectIds?f.globalizeObjectId(e,i.id):i.id,a=i.id,h=i.name,l=[];if(i.propertySetIds&&i.propertySetIds.length>0)for(let e=0,t=i.propertySetIds.length;e<t;e++){const t=i.propertySetIds[e],s=c.propertySets[t];s&&l.push(s);}const u=null,p=null,d=i.external,m=new lR(c,o,a,h,r,l,u,p,d);this.metaObjects[o]=m,(this.metaObjectsByType[r]||(this.metaObjectsByType[r]={}))[o]=m,void 0===this._typeCounts[r]?this._typeCounts[r]=1:this._typeCounts[r]++;}for(let t=0,i=n.length;t<i;t++){const i=n[t],r=s.globalizeObjectIds?f.globalizeObjectId(e,i.id):i.id,o=this.metaObjects[r];if(o)if(void 0===i.parent||null===i.parent)c.rootMetaObject=o;else if(i.parent){const t=s.globalizeObjectIds?f.globalizeObjectId(e,i.parent):i.parent;let r=this.metaObjects[t];r&&(o.parent=r,r.children=r.children||[],r.children.push(o));}}return this.fire("metaModelCreated",e),c}destroyMetaModel(e){const t=this.metaModels[e];t&&(this._removeMetaModel(t),this.fire("metaModelDestroyed",e));}_removeMetaModel(e){const t=this.metaObjects,s=this.metaObjectsByType;let i=e=>{delete t[e.id];const r=s[e.type];r&&r[e.id]&&(delete r[e.id],0==--this._typeCounts[e.type]&&(delete this._typeCounts[e.type],delete s[e.type]));const o=e.children;if(o)for(let e=0,t=o.length;e<t;e++){const t=o[e];i(t);}};i(e.rootMetaObject);for(let t in e.propertySets)e.propertySets.hasOwnProperty(t)&&delete this.propertySets[t];delete this.metaModels[e.id];}getObjectIDsByType(e){const t=this.metaObjectsByType[e];return t?Object.keys(t):[]}getObjectIDsInSubtree(e,t,s){const i=[],r=this.metaObjects[e],o=t&&t.length>0?dR(t):null,n=s&&s.length>0?dR(s):null;return function e(t){if(!t)return;var s=!0;(n&&n[t.type]||o&&!o[t.type])&&(s=!1),s&&i.push(t.id);const r=t.children;if(r)for(var a=0,h=r.length;a<h;a++)e(r[a]);}(r),i}withMetaObjectsInSubtree(e,t){const s=this.metaObjects[e];s&&s.withMetaObjectsInSubtree(t);}}function dR(e){const t={};for(var s=0,i=e.length;s<i;s++)t[e[s]]=!0;return t}class fR{constructor(e){this.language="en",this.localeService=e.localeService||new jE,this.scene=new Ut(this,{canvasId:e.canvasId,canvasElement:e.canvasElement,keyboardEventsElement:e.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:!1!==e.preserveDrawingBuffer,premultipliedAlpha:!!e.premultipliedAlpha,antialias:!1!==e.antialias},spinnerElementId:e.spinnerElementId,transparent:!1!==e.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:e.units,scale:e.scale,origin:e.origin,saoEnabled:e.saoEnabled,alphaDepthMask:!1!==e.alphaDepthMask,entityOffsetsEnabled:!!e.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!e.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!e.logarithmicDepthBufferEnabled,pbrEnabled:!!e.pbrEnabled,colorTextureEnabled:!1!==e.colorTextureEnabled}),this.metaScene=new pR(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new QE(this.scene,{duration:.5}),this.cameraControl=new aR(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={};}get capabilities(){return this.scene.capabilities}on(e,t){let s=this._eventSubs[e];s||(s=[],this._eventSubs[e]=s),s.push(t);}fire(e,t){const s=this._eventSubs[e];if(s)for(let e=0,i=s.length;e<i;e++)s[e](t);}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`);}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`);}addPlugin(e){this._plugins.push(e);}removePlugin(e){for(let t=0,s=this._plugins.length;t<s;t++){const s=this._plugins[t];if(s===e)return s.clear&&s.clear(),void this._plugins.splice(t,1)}}sendToPlugins(e,t){for(let s=0,i=this._plugins.length;s<i;s++){const i=this._plugins[s];i.send&&i.send(e,t);}}clear(){throw 'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}resetView(){throw "Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0);}getSnapshot(e={}){const t=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting");const s=void 0!==e.width&&void 0!==e.height,i=this.scene.canvas.canvas,r=i.clientWidth,o=i.clientHeight,n=i.style.width,a=i.style.height,h=e.width?Math.floor(e.width):i.width,l=e.height?Math.floor(e.height):i.height;s&&(i.style.width=h+"px",i.style.height=l+"px"),this.scene._renderer.renderSnapshot();const u=this.scene._renderer.readSnapshot(e);return s&&(i.style.width=n,i.style.height=a,i.width=r,i.height=o,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),u}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1);}destroy(){const e=this._plugins.slice();for(let t=0,s=e.length;t<s;t++){e[t].destroy();}this.scene.destroy();}}const YR=f.vec2(),KR=f.vec3(),JR=f.vec3(),ZR=f.vec3();

/**
 * Default server client which loads content for a {@link BIMViewer} via HTTP from the file system.
 *
 * A BIMViewer is instantiated with an instance of this class.
 *
 * To load content from an alternative source, instantiate BIMViewer with your own custom implementation of this class.
 */
class Server {

    /**
     * Constructs a Server.
     *
     * @param {*} [cfg] Server configuration.
     * @param {String} [cfg.dataDir] Base directory for content.
     * @param {String} [cfg.organization] FM organization.
     * @param {String} [cfg.building] FM building.
     */
    constructor(cfg) {
        this._organization = cfg.organization;
        this._building = cfg.building;
        this._prefix = `${this._organization}.${this._building}`;
        this._dataDir = cfg.dataDir;
    }

    /**
     * Gets information on all available projects.
     *
     * @param {Function} done Callback through which the JSON result is returned.
     * @param {Function} error Callback through which an error message is returned on error.
     */
    getProjects(done, error) {
        const url = this._dataDir + "/projects/index.json";
        b.loadJSON(url, done, error);
    }

    /**
     * Gets information for a project.
     *
     * @param {String} projectId ID of the project.
     * @param {Function} done Callback through which the JSON result is returned.
     * @param {Function} error Callback through which an error message is returned on error.
     */
    getProject(projectId, done, error) {
        const url = this._dataDir + "/projects/" + projectId + "/index.json";
        b.loadJSON(url, done, error);
    }

    /**
     * Gets metadata for a model within a project.
     *
     * @param {String} projectId ID of the project.
     * @param {String} modelId ID of the model.
     * @param {Function} done Callback through which the JSON result is returned.
     * @param {Function} error Callback through which an error message is returned on error.
     */
    getMetadata(projectId, modelId, done, error) {
        const url = this._dataDir + "/projects/" + projectId + "/models/" + modelId + "/metadata.json";
        b.loadJSON(url, done, error);
    }

    /**
     * Gets geometry for a model within a project.
     *
     * @param {String} projectId ID of the project.
     * @param {String} modelId ID of the model.
     * @param {Function} done Callback through which the JSON result is returned.
     * @param {Function} error Callback through which an error message is returned on error.
     */
    getGeometry(projectId, modelId, done, error) {
        const url = this._dataDir + "/projects/" + projectId + "/models/" + modelId + "/geometry.xkt";
        b.loadArraybuffer(url, done, error);
    }

    /**
     * Gets metadata for an object within a model within a project.
     *
     * @param {String} projectId ID of the project.
     * @param {String} modelId ID of the model.
     * @param {String} objectId ID of the object.
     * @param {Function} done Callback through which the JSON result is returned.
     * @param {Function} error Callback through which an error message is returned on error.
     */
    getObjectInfo(projectId, modelId, objectId, done, error) {
        const url = this._dataDir + "/projects/" + projectId + "/models/" + modelId + "/props/" + objectId + ".json";
        b.loadJSON(url, done, error);
    }

    /**
     * Gets existing issues for a model within a project.
     *
     * @param {String} projectId ID of the project.
     * @param {String} modelId ID of the model.
     * @param {Function} done Callback through which the JSON result is returned.
     * @param {Function} error Callback through which an error message is returned on error.
     */
    getIssues(projectId, modelId, done, error) {
        const url = this._dataDir + "/projects/" + projectId + "/models/" + modelId + "/issues.json";
        b.loadJSON(url, done, error);
    }
}

/** @private */
class Map$1 {

    constructor(items, baseId) {
        this.items = items || [];
        this._lastUniqueId = (baseId || 0) + 1;
    }

    /**
     * Usage:
     *
     * id = myMap.addItem("foo") // ID internally generated
     * id = myMap.addItem("foo", "bar") // ID is "foo"
     */
    addItem() {
        let item;
        if (arguments.length === 2) {
            const id = arguments[0];
            item = arguments[1];
            if (this.items[id]) { // Won't happen if given ID is string
                throw "ID clash: '" + id + "'";
            }
            this.items[id] = item;
            return id;

        } else {
            item = arguments[0] || {};
            while (true) {
                const findId = this._lastUniqueId++;
                if (!this.items[findId]) {
                    this.items[findId] = item;
                    return findId;
                }
            }
        }
    }

    removeItem(id) {
        const item = this.items[id];
        delete this.items[id];
        return item;
    }
}

/** @private */
class Controller {

    /**
     * @protected
     */
    constructor(parent, cfg, server, viewer) {

        this.bimViewer = (parent ? (parent.bimViewer || parent) : this);
        this.server = parent ? parent.server : server;
        this.viewer = parent ? parent.viewer : viewer;

        this._children = [];

        if (parent) {
            parent._children.push(this);
        }

        this._subIdMap = null; // Subscription subId pool
        this._subIdEvents = null; // Subscription subIds mapped to event names
        this._eventSubs = null; // Event names mapped to subscribers
        this._events = null; // Maps names to events
        this._eventCallDepth = 0; // Helps us catch stack overflows from recursive events

        this._enabled = null; // Used by #setEnabled() and #getEnabled()
        this._active = null; // Used by #setActive() and #getActive()
    }

    /**
     * Fires an event on this Controller.
     *
     * @protected
     *
     * @param {String} event The event type name
     * @param {Object} value The event parameters
     * @param {Boolean} [forget=false] When true, does not retain for subsequent subscribers
     */
    fire(event, value, forget) {
        if (!this._events) {
            this._events = {};
        }
        if (!this._eventSubs) {
            this._eventSubs = {};
        }
        if (forget !== true) {
            this._events[event] = value || true; // Save notification
        }
        const subs = this._eventSubs[event];
        let sub;
        if (subs) { // Notify subscriptions
            for (const subId in subs) {
                if (subs.hasOwnProperty(subId)) {
                    sub = subs[subId];
                    this._eventCallDepth++;
                    if (this._eventCallDepth < 300) {
                        sub.callback.call(sub.scope, value);
                    } else {
                        this.error("fire: potential stack overflow from recursive event '" + event + "' - dropping this event");
                    }
                    this._eventCallDepth--;
                }
            }
        }
    }

    /**
     * Subscribes to an event on this Controller.
     *
     * The callback is be called with this component as scope.
     *
     * @param {String} event The event
     * @param {Function} callback Called fired on the event
     * @param {Object} [scope=this] Scope for the callback
     * @return {String} Handle to the subscription, which may be used to unsubscribe with {@link #off}.
     */
    on(event, callback, scope) {
        if (!this._events) {
            this._events = {};
        }
        if (!this._subIdMap) {
            this._subIdMap = new Map$1(); // Subscription subId pool
        }
        if (!this._subIdEvents) {
            this._subIdEvents = {};
        }
        if (!this._eventSubs) {
            this._eventSubs = {};
        }
        let subs = this._eventSubs[event];
        if (!subs) {
            subs = {};
            this._eventSubs[event] = subs;
        }
        const subId = this._subIdMap.addItem(); // Create unique subId
        subs[subId] = {
            callback: callback,
            scope: scope || this
        };
        this._subIdEvents[subId] = event;
        const value = this._events[event];
        if (value !== undefined) { // A publication exists, notify callback immediately
            callback.call(scope || this, value);
        }
        return subId;
    }

    /**
     * Cancels an event subscription that was previously made with {@link Controller#on} or {@link Controller#once}.
     *
     * @param {String} subId Subscription ID
     */
    off(subId) {
        if (subId === undefined || subId === null) {
            return;
        }
        if (!this._subIdEvents) {
            return;
        }
        const event = this._subIdEvents[subId];
        if (event) {
            delete this._subIdEvents[subId];
            const subs = this._eventSubs[event];
            if (subs) {
                delete subs[subId];
            }
            this._subIdMap.removeItem(subId); // Release subId
        }
    }

    /**
     * Subscribes to the next occurrence of the given event, then un-subscribes as soon as the event is handled.
     *
     * This is equivalent to calling {@link Controller#on}, and then calling {@link Controller#off} inside the callback function.
     *
     * @param {String} event Data event to listen to
     * @param {Function} callback Called when fresh data is available at the event
     * @param {Object} [scope=this] Scope for the callback
     */
    once(event, callback, scope) {
        const self = this;
        const subId = this.on(event,
            function (value) {
                self.off(subId);
                callback.call(scope || this, value);
            },
            scope);
    }

    /**
     * Logs a console debugging message for this Controller.
     *
     * The console message will have this format: *````[LOG] [<component type> <component id>: <message>````*
     *
     * @protected
     *
     * @param {String} message The message to log
     */
    log(message) {
        message = "[LOG] " + message;
        window.console.log(message);
    }

    /**
     * Logs a warning for this Controller to the JavaScript console.
     *
     * The console message will have this format: *````[WARN] [<component type> =<component id>: <message>````*
     *
     * @protected
     *
     * @param {String} message The message to log
     */
    warn(message) {
        message = "[WARN] " + message;
        window.console.warn(message);
    }

    /**
     * Logs an error for this Controller to the JavaScript console.
     *
     * The console message will have this format: *````[ERROR] [<component type> =<component id>: <message>````*
     *
     * @protected
     *
     * @param {String} message The message to log
     */
    error(message) {
        message = "[ERROR] " + message;
        window.console.error(message);
    }

    _mutexActivation(controllers) {
        const numControllers = controllers.length;
        for (let i = 0; i < numControllers; i++) {
            const controller = controllers[i];
            controller.on("active", (function () {
                const _i = i;
                return function (active) {
                    if (!active) {
                        return;
                    }
                    for (let j = 0; j < numControllers; j++) {
                        if (j === _i) {
                            continue;
                        }
                        controllers[j].setActive(false);
                    }
                };
            })());
        }
    }

    /**
     * Enables or disables this Controller.
     *
     * Fires an "enabled" event on update.
     *
     * @protected
     * @param {boolean} enabled Whether or not to enable.
     */
    setEnabled(enabled) {
        if (this._enabled === enabled) {
            return;
        }
        this._enabled = enabled;
        this.fire("enabled", this._enabled);
    }

    /**
     * Gets whether or not this Controller is enabled.
     *
     * @protected
     *
     * @returns {boolean}
     */
    getEnabled() {
        return this._enabled;
    }

    /**
     * Activates or deactivates this Controller.
     *
     * Fires an "active" event on update.
     *
     * @protected
     *
     * @param {boolean} active Whether or not to activate.
     */
    setActive(active) {
        if (this._active === active) {
            return;
        }
        this._active = active;
        this.fire("active", this._active);
    }

    /**
     * Gets whether or not this Controller is active.
     *
     * @protected
     *
     * @returns {boolean}
     */
    getActive() {
        return this._active;
    }

    /**
     * Destroys this Controller.
     *
     * @protected
     *
     */
    destroy() {
        if (this.destroyed) {
            return;
        }
        /**
         * Fired when this Controller is destroyed.
         * @event destroyed
         */
        this.fire("destroyed", this.destroyed = true);
        this._subIdMap = null;
        this._subIdEvents = null;
        this._eventSubs = null;
        this._events = null;
        this._eventCallDepth = 0;
        for (let i = 0, len = this._children.length; i < len; i++) {
            this._children[i].destroy();
        }
        this._children = [];
    }
}

/** @private */
class BusyModal extends Controller {

    constructor(parent, cfg = {}) {

        super(parent, cfg);

        const busyModalBackdropElement = cfg.busyModalBackdropElement || document.body;

        if (!busyModalBackdropElement) {
            throw "Missing config: busyModalBackdropElement";
        }

        this._modal = document.createElement("div");
        this._modal.classList.add("xeokit-busy-modal");
        this._modal.innerHTML = '<div class="xeokit-busy-modal-content"><div class="xeokit-busy-modal-body"><div class="xeokit-busy-modal-message">Default text</div></div></div>';

        busyModalBackdropElement.appendChild(this._modal);

        this._modalVisible = false;
        this._modal.style.display = 'hidden';
    }

    show(message) {
        this._modalVisible = true;
        this._modal.querySelector('.xeokit-busy-modal-message').innerText = message;
        this._modal.style.display = 'block';
    }

    hide() {
        this._modalVisible = false;
        this._modal.style.display = 'none';
    }

    destroy() {
        super.destroy();
        if (this._modal) {
            this._modal.parentNode.removeChild(this._modal);
            this._modal = null;
        }
    }
}

const tempVec3a = f.vec3();

/** @private */
class ResetAction extends Controller {

    constructor(parent, cfg = {}) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        const buttonElement = cfg.buttonElement;
        const camera = this.viewer.camera;

        this._modelMementos = {};

        // Initial camera position - looking down negative diagonal

        camera.eye = [0.577, 0.577, 0.577];
        camera.look = [0,0,0];
        camera.up = [-1, 1, -1];

        this.bimViewer._modelsExplorer.on("modelLoaded", (modelId) => {
            this._saveModelMemento(modelId);
        });

        this.bimViewer._modelsExplorer.on("modelUnloaded", (modelId) => {
            this._destroyModelMemento(modelId);
        });

        this.on("enabled", (enabled) => {
            if (!enabled) {
                buttonElement.classList.add("disabled");
            } else {
                buttonElement.classList.remove("disabled");
            }
        });

        this.on("active", (active) => {
            if (active) {
                buttonElement.classList.add("active");
            } else {
                buttonElement.classList.remove("active");
            }
        });

        buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.reset();
            }
            event.preventDefault();
        });
    }

    _saveModelMemento(modelId) {
        const metaModel = this.viewer.metaScene.metaModels[modelId];
        if (!metaModel) {
            return;
        }
        const modelMemento = new bS();
        modelMemento.saveObjects(this.viewer.scene, metaModel, {
            visible: true,
            edges: true,
            xrayed: true,
            highlighted: true,
            selected: true,
            clippable: true,
            pickable: true,
            colorize: false, // We don't colorize objects yet - also messes up point clouds
            opacity: false // FIXME: Restoring opacity broken by colorize fix - details at https://github.com/xeokit/xeokit-sdk/issues/239
        });
        this._modelMementos[modelId] = modelMemento;
    }

    _restoreModelMemento(modelId) {
        const metaModel = this.viewer.metaScene.metaModels[modelId];
        if (!metaModel) {
            return;
        }
        const modelMemento = this._modelMementos[modelId];
        modelMemento.restoreObjects(this.viewer.scene, metaModel);
    }

    _destroyModelMemento(modelId) {
        delete this._modelMementos[modelId];
    }

    reset() {
        const scene = this.viewer.scene;
        const modelIds = scene.modelIds;
        for (var i = 0, len = modelIds.length; i < len; i++) {
            const modelId = modelIds[i];
            this._restoreModelMemento(modelId);
        }
        this.bimViewer.unShowObjectInExplorers();
        this.fire("reset", true);
        this._resetCamera();
    }

    _resetCamera() {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const aabb = scene.getAABB(scene.visibleObjectIds);
        const diag = f.getAABB3Diag(aabb);
        const center = f.getAABB3Center(aabb, tempVec3a);
        const camera = scene.camera;
        const fitFOV = camera.perspective.fov;
        const dist = Math.abs(diag / Math.tan(45 * f.DEGTORAD));
        const dir = f.normalizeVec3((camera.yUp) ? [-0.5, -0.7071, -0.5] : [-1, 1, -1]);
        const up = f.normalizeVec3((camera.yUp) ? [-0.5, 0.7071, -0.5] : [-1, 1, 1]);
        viewer.cameraControl.pivotPos = center;
        viewer.cameraControl.planView = false;
        viewer.cameraFlight.flyTo({
            look: center,
            eye: [center[0] - (dist * dir[0]), center[1] - (dist * dir[1]), center[2] - (dist * dir[2])],
            up: up,
            orthoScale: diag * 1.3,
            projection: "perspective",
            duration: 1
        });
    }
}

const tempVec3 = f.vec3();

/** @private */
class FitAction extends Controller {

    constructor(parent, cfg={}) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        const buttonElement = cfg.buttonElement;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                buttonElement.classList.add("disabled");
            } else {
                buttonElement.classList.remove("disabled");
            }
        });

        this.on("active", (active) => {
            if (active) {
                buttonElement.classList.add("active");
            } else {
                buttonElement.classList.remove("active");
            }
        });

        buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.fit();
            }
            event.preventDefault();
        });
    }

    fit() {
        const scene = this.viewer.scene;
        const aabb = scene.getAABB(scene.visibleObjectIds);
        this.viewer.cameraFlight.flyTo({
            aabb: aabb
        });
        this.viewer.cameraControl.pivotPos = f.getAABB3Center(aabb, tempVec3);
    }

    set fov(fov) {
        this.viewer.scene.cameraFlight.fitFOV = fov;
    }

    get fov() {
        return this.viewer.scene.cameraFlight.fitFOV;
    }

    set duration(duration) {
        this.viewer.scene.cameraFlight.duration = duration;
    }

    get duration() {
        return this.viewer.scene.cameraFlight.duration;
    }
}

/** @private */
class FirstPersonMode extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        const buttonElement = cfg.buttonElement;
        const cameraControl = this.viewer.cameraControl;
        const cameraControlNavModeMediator = cfg.cameraControlNavModeMediator;

        cameraControl.navMode = "orbit";
        cameraControl.followPointer = true;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                buttonElement.classList.add("disabled");
            } else {
                buttonElement.classList.remove("disabled");
            }
        });

        this.on("active", (active) => {
            if (active) {
                buttonElement.classList.add("active");
            } else {
                buttonElement.classList.remove("active");
            }
        });

        this.on("active", (active) => {
            cameraControlNavModeMediator.setFirstPersonModeActive(active);
            if (active) {
                cameraControl.followPointer = true;
                cameraControl.pivoting = false;
            } else {
                cameraControl.pivoting = true;
            }
        });

        buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                const active = this.getActive();
                this.setActive(!active);
            }
            event.preventDefault();
        });

        this.bimViewer.on("reset", ()=>{
            this.setActive(false);
        });
    }
}

/** @private */
class HideTool extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        const buttonElement = cfg.buttonElement;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                buttonElement.classList.add("disabled");
            } else {
                buttonElement.classList.remove("disabled");
            }
        });

        this.on("active", (active) => {
            if (active) {
                buttonElement.classList.add("active");
                this.viewer.cameraControl.doublePickFlyTo = false;
                this._onPick = this.viewer.cameraControl.on("picked", (pickResult) => {
                    if (!pickResult.entity) {
                        return;
                    }
                    pickResult.entity.visible = false;
                });
            } else {
                buttonElement.classList.remove("active");
                this.viewer.cameraControl.doublePickFlyTo = false;
                if (this._onPick !== undefined) {
                    this.viewer.cameraControl.off(this._onPick);
                    this._onPick = undefined;
                }
            }
        });

        buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.bimViewer._sectionTool.hideControl();
                const active = this.getActive();
                this.setActive(!active);
            }
            event.preventDefault();
        });

        this.bimViewer.on("reset", () => {
            this.setActive(false);
        });
    }
}

/** @private */
class SelectionTool extends Controller {

    constructor(parent, cfg) {

        super(parent);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        const buttonElement = cfg.buttonElement;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                buttonElement.classList.add("disabled");
            } else {
                buttonElement.classList.remove("disabled");
            }
        });

        this.on("active", (active) => {
            if (active) {
                buttonElement.classList.add("active");
                this._onPick = this.viewer.cameraControl.on("picked", (pickResult) => {
                    if (!pickResult.entity) {
                        return;
                    }
                  pickResult.entity.selected = !pickResult.entity.selected;
                });
            } else {
                buttonElement.classList.remove("active");
                if (this._onPick !== undefined) {
                    this.viewer.cameraControl.off(this._onPick);
                    this._onPick = undefined;
                }
            }
        });

        buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.bimViewer._sectionTool.hideControl();
                const active = this.getActive();
                this.setActive(!active);
            }
            event.preventDefault();
        });

        this.bimViewer.on("reset", () => {
            this.setActive(false);
        });
    }
}

/** @private */
class ShowSpacesMode extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        this._buttonElement = cfg.buttonElement;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                this._buttonElement.classList.add("disabled");
            } else {
                this._buttonElement.classList.remove("disabled");
            }
        });

        this._buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.setActive(!this.getActive(), () => {
                });
            }
            event.preventDefault();
        });

        this.bimViewer.on("reset", () => {
            this.setActive(false); // IfcSpaces hidden by default
        });

        this.viewer.scene.on("modelLoaded", (modelId) => {
            if (!this._active) {
                const objectIds = this.viewer.metaScene.getObjectIDsByType("IfcSpace");
                this.viewer.scene.setObjectsCulled(objectIds, true);
            }
        });
        
        this._active = false;
        this._buttonElement.classList.remove("active");
    }

    setActive(active) {
        if (this._active === active) {
            return;
        }
        this._active = active;
        if (active) {
            this._buttonElement.classList.add("active");
            this._enterShowSpacesMode();
            this.fire("active", this._active);
        } else {
            this._buttonElement.classList.remove("active");
            this._exitShowSpacesMode();
            this.fire("active", this._active);
        }
    }

    _enterShowSpacesMode() {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const metaScene = viewer.metaScene;
        const objectIds = metaScene.getObjectIDsByType("IfcSpace");
        scene.setObjectsCulled(objectIds, false);
    }

    _exitShowSpacesMode() {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const metaScene = viewer.metaScene;
        const objectIds = metaScene.getObjectIDsByType("IfcSpace");
        scene.setObjectsCulled(objectIds, true);
    }
}

/** @private */
class QueryTool extends Controller {

    constructor(parent, cfg) {

        super(parent);

       //  this.on("active", (active) => {
       //      if (active) {
       //          this._onPick = this.viewer.cameraControl.on("picked", (pickResult) => {
       //              if (!pickResult.entity) {
       //                  return;
       //              }
       // //             this.queryEntity(pickResult.entity);
       //          });
       //          this._onPickedNothing = this.viewer.cameraControl.on("pickedNothing", () => {
       //              this.fire("queryNotPicked", false);
       //          });
       //      } else {
       //
       //          if (this._onPick !== undefined) {
       //              this.viewer.cameraControl.off(this._onPick);
       //              this.viewer.cameraControl.off(this._onPickedNothing);
       //              this._onPick = undefined;
       //              this._onPickedNothing = undefined;
       //          }
       //      }
       //  });
       //
       //  this.bimViewer.on("reset", () => {
       //      this.setActive(false);
       //  });
    }
}

const tempAABB = f.AABB3();
const tempVec3$1 = f.vec3();

/**
 * @private
 */
class SectionToolContextMenu extends a {

    constructor(cfg = {}) {

        if (!cfg.sectionPlanesPlugin) {
            throw "Missing config: sectionPlanesPlugin";
        }

        super(b.apply({}, cfg));

        this._sectionPlanesPlugin = cfg.sectionPlanesPlugin;
        this._viewer = this._sectionPlanesPlugin.viewer;

        this._onSceneSectionPlaneCreated = this._viewer.scene.on("sectionPlaneCreated", () => {
            this._buildMenu();
        });

        this._onSceneSectionPlaneDestroyed = this._viewer.scene.on("sectionPlaneDestroyed", () => {
            this._buildMenu();
        });

        this._buildMenu();
    }

    _buildMenu() {

        const sectionPlanesPlugin = this._sectionPlanesPlugin;
        const sectionPlanes = Object.values(sectionPlanesPlugin.sectionPlanes);

        const sectionPlanesMenuItems = [];

        for (let i = 0, len = sectionPlanes.length; i < len; i++) {

            const sectionPlane = sectionPlanes[i];

            sectionPlanesMenuItems.push({

                getTitle: (context) => {
                    return `${context.viewer.localeService.translate("sectionToolContextMenu.slice") || "Slice"} #` + (i + 1);
                },

                doHoverEnter(context) {
                    sectionPlanesPlugin.hideControl();
                    sectionPlanesPlugin.showControl(sectionPlane.id);
                },

                doHoverLeave(context) {
                    sectionPlanesPlugin.hideControl();
                },

                items: [ // Submenu
                    [ // Group
                        {
                            getTitle: (context) => {
                                return context.viewer.localeService.translate("sectionToolContextMenu.edit") || "Edit";
                            },
                            doAction: (context) => {

                                sectionPlanesPlugin.hideControl();
                                sectionPlanesPlugin.showControl(sectionPlane.id);

                                const sectionPlanePos = sectionPlane.pos;
                                tempAABB.set(this._viewer.scene.aabb);
                                f.getAABB3Center(tempAABB, tempVec3$1);
                                tempAABB[0] += sectionPlanePos[0] - tempVec3$1[0];
                                tempAABB[1] += sectionPlanePos[1] - tempVec3$1[1];
                                tempAABB[2] += sectionPlanePos[2] - tempVec3$1[2];
                                tempAABB[3] += sectionPlanePos[0] - tempVec3$1[0];
                                tempAABB[4] += sectionPlanePos[1] - tempVec3$1[1];
                                tempAABB[5] += sectionPlanePos[2] - tempVec3$1[2];

                                this._viewer.cameraFlight.flyTo({
                                    aabb: tempAABB,
                                    fitFOV: 65
                                });
                            }
                        },
                        {
                            getTitle: (context) => {
                                return context.viewer.localeService.translate("sectionToolContextMenu.flip") || "Flip";
                            },
                            doAction: (context) => {
                                sectionPlane.flipDir();
                            }
                        },
                        {
                            getTitle: (context) => {
                                return context.viewer.localeService.translate("sectionToolContextMenu.delete") || "Delete";
                            },
                            doAction: (context) => {
                                sectionPlane.destroy();
                            }
                        }
                    ]
                ]
            });
        }

        this.items = [
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("sectionToolContextMenu.clearSlices") || "Clear Slices";
                    },
                    getEnabled: (context) => {
                        return (context.bimViewer.getNumSections() > 0);
                    },
                    doAction: (context) => {
                        context.bimViewer.clearSections();
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("sectionToolContextMenu.flipSlices") || "Flip Slices";
                    },
                    getEnabled: (context) => {
                        return (context.bimViewer.getNumSections() > 0);
                    },
                    doAction: (context) => {
                        context.bimViewer.flipSections();
                    }
                }
            ],

            sectionPlanesMenuItems
        ];
    }

    destroy() {
        super.destroy();
        const scene = this._viewer.scene;
        scene.off(this._onSceneSectionPlaneCreated);
        scene.off(this._onSceneSectionPlaneDestroyed);
    }
}

/** @private */
class SectionTool extends Controller { // XX

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        if (!cfg.menuButtonElement) {
            throw "Missing config: menuButtonElement";
        }

        this._buttonElement = cfg.buttonElement;
        this._counterElement = cfg.counterElement;
        this._menuButtonElement = cfg.menuButtonElement;
        this._menuButtonArrowElement = cfg.menuButtonArrowElement;

        this._sectionPlanesPlugin = new wf(this.viewer, {});

        this._sectionToolContextMenu = new SectionToolContextMenu({
            sectionPlanesPlugin: this._sectionPlanesPlugin,
            hideOnMouseDown: false
        });

        this._sectionPlanesPlugin.setOverviewVisible(false);

        this.on("enabled", (enabled) => {
            if (!enabled) {
                this._buttonElement.classList.add("disabled");
                if (this._counterElement) {
                    this._counterElement.classList.add("disabled");
                }
                this._menuButtonElement.classList.add("disabled");
                this._menuButtonArrowElement.classList.add("disabled");
            } else {
                this._buttonElement.classList.remove("disabled");
                if (this._counterElement) {
                    this._counterElement.classList.remove("disabled");
                }
                this._menuButtonElement.classList.remove("disabled");
                this._menuButtonArrowElement.classList.remove("disabled");
            }
        });

        this.on("active", (active) => {
            if (active) {
                this._buttonElement.classList.add("active");
                if (this._counterElement) {
                    this._counterElement.classList.add("active");
                }
                this._menuButtonElement.classList.add("active");
                this._menuButtonArrowElement.classList.add("active");
            } else {
                this._buttonElement.classList.remove("active");
                if (this._counterElement) {
                    this._counterElement.classList.remove("active");
                }
                this._menuButtonElement.classList.remove("active");
                this._menuButtonArrowElement.classList.remove("active");
            }
        });

        this.on("active", (active) => {
            if (!active) {
                this._sectionPlanesPlugin.hideControl();
            }
        });

        this._buttonElement.addEventListener("click", (e) => {
            if (!this.getEnabled()) {
                return;
            }
            if (e.target === this._menuButtonElement || e.target.parentNode === this._menuButtonElement) {
                return;
            }
            const active = this.getActive();
            this.setActive(!active);
            e.preventDefault();
        });

        document.addEventListener("mousedown", (e) => {

            if (e.target.classList.contains("xeokit-context-menu-item")) {
                // Allow click on menu item
                return;
            }

            if (e.target === this._menuButtonElement || e.target.parentNode === this._menuButtonElement) {
                e.preventDefault();
                if (this._sectionToolContextMenu.shown) {
                    this._sectionToolContextMenu.hide();
                } else {
                    this._sectionToolContextMenu.context = {
                        bimViewer: this.bimViewer,
                        viewer: this.viewer,
                        sectionTool: this
                    };

                    const rect = this._menuButtonElement.getBoundingClientRect();

                    this._sectionToolContextMenu.show(rect.left, rect.bottom + 5);
                }
            } else {
                this._sectionToolContextMenu.hide();
            }
        });

        this._sectionToolContextMenu.on("shown", () => {
            this._menuButtonArrowElement.classList.remove("xeokit-arrow-down");
            this._menuButtonArrowElement.classList.add("xeokit-arrow-up");
        });

        this._sectionToolContextMenu.on("hidden", () => {
            this._menuButtonArrowElement.classList.remove("xeokit-arrow-up");
            this._menuButtonArrowElement.classList.add("xeokit-arrow-down");
        });

        this.bimViewer.on("reset", () => {
            this.clear();
            this.setActive(false);
        });

        this.viewer.scene.on("sectionPlaneCreated", ()=> {
            this._updateSectionPlanesCount();
        });

        this.viewer.scene.on("sectionPlaneDestroyed", ()=> {
            this._updateSectionPlanesCount();
        });

        this._initSectionMode();
    }

    _initSectionMode() {

        this.viewer.scene.input.on("mouseclicked", (coords) => {

            if (!this.getActive() || !this.getEnabled()) {
                return;
            }

            const pickResult = this.viewer.scene.pick({
                canvasPos: coords,
                pickSurface: true  // <<------ This causes picking to find the intersection point on the entity
            });

            if (pickResult) {

                const sectionPlane = this._sectionPlanesPlugin.createSectionPlane({
                    pos: pickResult.worldPos,
                    dir: f.mulVec3Scalar(pickResult.worldNormal, -1)
                });

                this._sectionPlanesPlugin.showControl(sectionPlane.id);
            }
        });

        this._updateSectionPlanesCount();
    }

    _updateSectionPlanesCount() {
        if (this._counterElement) {
            this._counterElement.innerText = ("" + this.getNumSections());
        }
    }

    getNumSections() {
        return Object.keys(this.viewer.scene.sectionPlanes).length;
    }

    clear() {
        this._sectionPlanesPlugin.clear();
        this._updateSectionPlanesCount();
    }

    flipSections() {
        this._sectionPlanesPlugin.flipSectionPlanes();
    }

    hideControl() {
        this._sectionPlanesPlugin.hideControl();
    }

    destroy() {
        this._sectionPlanesPlugin.destroy();
        this._sectionToolContextMenu.destroy();
        super.destroy();
    }
}

/** @private */
class NavCubeMode extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.navCubeCanvasElement) {
            throw "Missing config: navCubeCanvasElement";
        }

        const navCubeCanvasElement = cfg.navCubeCanvasElement;

        this._navCube = new sf(this.viewer, {
            canvasElement: navCubeCanvasElement,
            fitVisible: true,
            color: "#CFCFCF"
        });

        this._navCube.setVisible(this._active);

        this.on("active", (active) => {
            this._navCube.setVisible(active);
        });
    }

    destroy() {
        this._navCube.destroy();
        super.destroy();
    }
}

/**
 * @desc Default initial properties for {@link Entity}s loaded from models accompanied by metadata.
 *
 * When loading a model, a loader plugins such as {@link GLTFLoaderPlugin} and {@link BIMServerLoaderPlugin} create
 * a tree of {@link Entity}s that represent the model. These loaders can optionally load metadata, to create
 * a {@link MetaModel} corresponding to the root {@link Entity}, with a {@link MetaObject} corresponding to each
 * object {@link Entity} within the tree.
 *
 * @private
 * @type {{String:Object}}
 */
const ModelIFCObjectColors = {
    IfcSpace: {
        opacity: 0.3
    },
    IfcWindow: { // Some IFC models have opaque windows
        opacity: 0.4
    },
    IfcOpeningElement: { // These tend to obscure windows
        opacity: 0.3
    },
    IfcPlate: { // These sometimes obscure windows
        opacity: 0.3
    }
};

/**
 * @desc Default initial properties for {@link Entity}s loaded from models accompanied by metadata.
 *
 * When loading a model, a loader plugins such as {@link GLTFLoaderPlugin} and {@link BIMServerLoaderPlugin} create
 * a tree of {@link Entity}s that represent the model. These loaders can optionally load metadata, to create
 * a {@link MetaModel} corresponding to the root {@link Entity}, with a {@link MetaObject} corresponding to each
 * object {@link Entity} within the tree.
 *
 * @private
 * @type {{String:Object}}
 */
const ViewerIFCObjectColors = {

    // Priority 0

    IfcRoof: {
        colorize: [0.837255, 0.203922, 0.270588],
        priority: 0
    },
    IfcSlab: {
        colorize: [0.637255, 0.603922, 0.670588],
        priority: 0
    },
    IfcWall: {
        colorize: [0.537255, 0.337255, 0.237255],
        priority: 0
    },
    IfcWallStandardCase: {
        colorize: [0.537255, 0.337255, 0.237255],
        priority: 0
    },
    IfcCovering: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 0
    },

    // Priority 1

    IfcDoor: {
        colorize: [0.637255, 0.603922, 0.670588],
        priority: 1
    },

    // Priority 2

    IfcStair: {
        colorize: [0.637255, 0.603922, 0.670588],
        priority: 2
    },
    IfcStairFlight: {
        colorize: [0.637255, 0.603922, 0.670588],
        priority: 2
    },
    IfcProxy: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 2
    },
    IfcRamp: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 2
    },

    // Priority 3

    IfcColumn: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 3
    },
    IfcBeam: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 3
    },
    IfcCurtainWall: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 3
    },
    IfcPlate: {
        colorize: [0.8470588235, 0.427450980392, 0, 0.5],
        opacity: 0.5,
        priority: 3
    },
    IfcTransportElement: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 3
    },
    IfcFooting: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 3
    },

    // Priority 4

    IfcRailing: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 4
    },
    IfcFurnishingElement: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 4
    },
    IfcFurniture: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 4
    },
    IfcSystemFurnitureElement: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 4
    },

    // Priority 5

    IfcFlowSegment: {
        colorize: [0, 0.6, 1],
        priority: 5
    },
    IfcFlowitting: {
        colorize: [0.137255, 0.403922, 0.870588],
        priority: 5
    },
    IfcFlowTerminal: {
        colorize: [0.8, 1, 0.4],
        priority: 5
    },
    IfcFlowController: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 5
    },
    IfcFlowFitting: {
        colorize: [1, 0.8, 0.6],
        priority: 5
    },
    IfcDuctSegment: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 5
    },
    IfcDistributionFlowElement: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 5
    },
    IfcDuctFitting: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 5
    },
    IfcLightFixture: {
        colorize: [0.8470588235, 0.8470588235, 0.870588],
        priority: 5
    },

    // Priority 6

    IfcAirTerminal: {
        colorize: [0.8470588235, 0.427450980392, 0],
        priority: 6
    },

    IfcOpeningElement: {
        colorize: [0.137255, 0.403922, 0.870588],
        opacity: 0.3,
        priority: 6
    },
    IfcSpace: {
        opacity: 0.5
    },

    IfcWindow: {
        colorize: [0.137255, 0.403922, 0.870588],
        opacity: 0.4,
        priority: 6 // FIXME: transparent objects need to be last in order to avoid strange wireframe effect
    },

    //

    IfcBuildingElementProxy: {
        colorize: [0.8, 0.4, 0.6]
    },

    IfcSite: {
        colorize: [0.137255, 0.403922, 0.870588]
    },

    IfcMember: {
        colorize: [0.8470588235, 0.427450980392, 0]
    },

    DEFAULT: {
        colorize: [0.5, 0.5, 0.5],
        priority: 10
    }
};

/**
 * @private
 * @param {*} cfg Configs
 * @param {Boolean} [cfg.enableEditModels=false] Set true to show Add/Edit/Delete options in the menu.
 */
class ModelsContextMenu extends a {

    constructor(cfg = {}) {

        const enableEditModels = (!!cfg.enableEditModels);

        const items = [
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("modelsContextMenu.loadModel") || "Load";
                    },
                    getEnabled: (context) => {
                        return (!context.bimViewer.isModelLoaded(context.modelId));
                    },
                    doAction: (context) => {
                        context.bimViewer.loadModel(context.modelId);
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("modelsContextMenu.unloadModel") || "Unload";
                    },
                    getEnabled: (context) => {
                        return context.bimViewer.isModelLoaded(context.modelId);
                    },
                    doAction: (context) => {
                        context.bimViewer.unloadModel(context.modelId);
                    }
                }
            ]
        ];

        if (enableEditModels) {

            items.push([
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("modelsContextMenu.editModel") || "Edit";
                    },
                    getEnabled: (context) => {
                        return true;
                    },
                    doAction: (context) => {
                        context.bimViewer.editModel(context.modelId);
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("modelsContextMenu.deleteModel") || "Delete";
                    },
                    getEnabled: (context) => {
                        return true;
                    },
                    doAction: (context) => {
                        context.bimViewer.deleteModel(context.modelId);
                    }
                }
            ]);
        }

        items.push([
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("modelsContextMenu.loadAllModels") || "Load All";
                },
                getEnabled: (context) => {
                    const bimViewer = context.bimViewer;
                    const modelIds = bimViewer.getModelIds();
                    const loadedModelIds = bimViewer.getLoadedModelIds();
                    return (loadedModelIds.length < modelIds.length);
                },
                doAction: (context) => {
                    context.bimViewer.loadAllModels();
                }
            },
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("modelsContextMenu.unloadAllModels") || "Unload All";
                },
                getEnabled: (context) => {
                    const loadedModelIds = context.bimViewer.getLoadedModelIds();
                    return (loadedModelIds.length > 0);
                },
                doAction: (context) => {
                    context.bimViewer.unloadAllModels();
                }
            }
        ]);

        items.push([
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("modelsContextMenu.clearSlices") || "Clear Slices";
                },
                getEnabled: (context) => {
                    return (context.bimViewer.getNumSections() > 0);
                },
                doAction: (context) => {
                    context.bimViewer.clearSections();
                }
            }
        ]);

        super({
            context: cfg.context,
            items: items
        });
    }
}

const tempVec3a$1 = f.vec3();

/** @private */
class ModelsExplorer extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.modelsTabElement) {
            throw "Missing config: modelsTabElement";
        }

        if (!cfg.unloadModelsButtonElement) {
            throw "Missing config: unloadModelsButtonElement";
        }

        if (!cfg.modelsElement) {
            throw "Missing config: modelsElement";
        }

        this._enableAddModels = !!cfg.enableEditModels;
        this._modelsTabElement = cfg.modelsTabElement;
        this._loadModelsButtonElement = cfg.loadModelsButtonElement;
        this._unloadModelsButtonElement = cfg.unloadModelsButtonElement;
        this._addModelButtonElement = cfg.addModelButtonElement;
        this._modelsElement = cfg.modelsElement;
        this._modelsTabButtonElement = this._modelsTabElement.querySelector(".xeokit-tab-btn");

        if (!this._modelsTabButtonElement) {
            throw "Missing DOM element: ,xeokit-tab-btn";
        }

        this._xktLoader = new Qg(this.viewer, {
            objectDefaults: ModelIFCObjectColors
        });

        this._modelsContextMenu = new ModelsContextMenu({
            enableEditModels: cfg.enableEditModels
        });

        this._modelsInfo = {};
        this._numModels = 0;
        this._numModelsLoaded = 0;
        this._projectId = null;
    }

    loadProject(projectId, done, error) {
        this.server.getProject(projectId, (projectInfo) => {
            this.unloadProject();
            this._projectId = projectId;
            this._modelsInfo = {};
            this._numModels = 0;
            this._parseProject(projectInfo, done);
            if (this._numModelsLoaded < this._numModels) {
                this._loadModelsButtonElement.classList.remove("disabled");
            }
            if (this._numModelsLoaded > 0) {
                this._unloadModelsButtonElement.classList.remove("disabled");
            }
            if (this._enableAddModels) {
                this._addModelButtonElement.classList.remove("disabled");
            }
        }, (errMsg) => {
            this.error(errMsg);
            if (error) {
                error(errMsg);
            }
        });
    }

    _parseProject(projectInfo, done) {
        this._buildModelsMenu(projectInfo);
        this._parseViewerConfigs(projectInfo);
        this._parseViewerContent(projectInfo, () => {
            this._parseViewerState(projectInfo, () => {
                done();
            });
        });
    }

    _buildModelsMenu(projectInfo) {
        var html = "";
        const modelsInfo = projectInfo.models || [];
        this._modelsInfo = {};
        this._numModels = modelsInfo.length;
        for (let i = 0, len = modelsInfo.length; i < len; i++) {
            const modelInfo = modelsInfo[i];
            this._modelsInfo[modelInfo.id] = modelInfo;
            html += "<div class='xeokit-form-check'>";
            html += "<input id='" + modelInfo.id + "' type='checkbox' value=''><span id='span-" + modelInfo.id + "' class='disabled'>" + modelInfo.name + "</span>";
            html += "</div>";
        }
        this._modelsElement.innerHTML = html;
        for (let i = 0, len = modelsInfo.length; i < len; i++) {
            const modelInfo = modelsInfo[i];
            const modelId = modelInfo.id;
            const checkBox = document.getElementById("" + modelId);
            const span = document.getElementById("span-" + modelId);
            checkBox.addEventListener("click", () => {
                if (checkBox.checked) {
                    this.loadModel(modelId);
                } else {
                    this.unloadModel(modelInfo.id);
                }
            });
            span.addEventListener("click", () => {
                const model = this.viewer.scene.models[modelId];
                const modelLoaded = (!!model);
                if (!modelLoaded) {
                    this.loadModel(modelId);
                } else {
                    this.unloadModel(modelInfo.id);
                }
            });
            span.oncontextmenu = (e) => {
                this._modelsContextMenu.context = {
                    bimViewer: this.bimViewer,
                    viewer: this.viewer,
                    modelId: modelId
                };
                this._modelsContextMenu.show(e.pageX, e.pageY);
                e.preventDefault();
            };
        }
    }

    _parseViewerConfigs(projectInfo) {
        const viewerConfigs = projectInfo.viewerConfigs;
        if (viewerConfigs) {
            this.bimViewer.setConfigs(viewerConfigs);
        }
    }

    _parseViewerContent(projectInfo, done) {
        const viewerContent = projectInfo.viewerContent;
        if (!viewerContent) {
            done();
            return;
        }
        this._parseModelsLoaded(viewerContent, () => {
            done();
        });
    }

    _parseModelsLoaded(viewerContent, done) {
        const modelsLoaded = viewerContent.modelsLoaded;
        if (!modelsLoaded || (modelsLoaded.length === 0)) {
            done();
            return;
        }
        this._loadNextModel(modelsLoaded.slice(0), done);
    }

    _loadNextModel(modelsLoaded, done) {
        if (modelsLoaded.length === 0) {
            done();
            return;
        }
        const modelId = modelsLoaded.pop();
        this.loadModel(modelId,
            () => { // Done
                this._loadNextModel(modelsLoaded, done);
            },
            () => { // Error - recover and attempt to load next model
                this._loadNextModel(modelsLoaded, done);
            });
    }

    _parseViewerState(projectInfo, done) {
        const viewerState = projectInfo.viewerState;
        if (!viewerState) {
            done();
            return;
        }
        this.bimViewer.setViewerState(viewerState, done);
    }

    unloadProject() {
        if (!this._projectId) {
            return;
        }
        const models = this.viewer.scene.models;
        for (var modelId in models) {
            if (models.hasOwnProperty(modelId)) {
                const model = models[modelId];
                model.destroy();
            }
        }
        this._modelsElement.innerHTML = "";
        this._numModelsLoaded = 0;

        this._loadModelsButtonElement.classList.add("disabled");
        this._unloadModelsButtonElement.classList.add("disabled");
        if (this._enableAddModels) {
            this._addModelButtonElement.classList.add("disabled");
        }
        const lastProjectId = this._projectId;
        this._projectId = null;
        this.fire("projectUnloaded", {
            projectId: lastProjectId
        });
    }

    getLoadedProjectId() {
        return this._projectId;
    }

    getModelIds() {
        return Object.keys(this._modelsInfo);
    }

    loadModel(modelId, done, error) {
        if (!this._projectId) {
            const errMsg = "No project currently loaded";
            this.error(errMsg);
            if (error) {
                error(errMsg);
            }
            return;
        }
        const modelInfo = this._modelsInfo[modelId];
        if (!modelInfo) {
            const errMsg = "Model not in currently loaded project";
            this.error(errMsg);
            if (error) {
                error(errMsg);
            }
            return;
        }

        this.bimViewer._busyModal.show(`${this.viewer.localeService.translate("busyModal.loading") || "Loading"} ${modelInfo.name}`);

        const externalMetadata = this.bimViewer.getConfig("externalMetadata");

        if (externalMetadata) {
            this.server.getMetadata(this._projectId, modelId, (json) => {
                    this._loadGeometry(modelId, modelInfo, json, done, error);
                },
                (errMsg) => {
                    this.bimViewer._busyModal.hide();
                    this.error(errMsg);
                    if (error) {
                        error(errMsg);
                    }
                });
        } else {
            this._loadGeometry(modelId, modelInfo, null, done, error);
        }
    }

    _loadGeometry(modelId, modelInfo, json, done, error) {
        this.server.getGeometry(this._projectId, modelId, (arraybuffer) => {
                const objectColorSource = (modelInfo.objectColorSource || this.bimViewer.getObjectColorSource());
                const objectDefaults = (objectColorSource === "model") ? ModelIFCObjectColors : ViewerIFCObjectColors;
                const model = this._xktLoader.load({
                    id: modelId,
                    metaModelData: json,
                    xkt: arraybuffer,
                    objectDefaults: objectDefaults,
                    excludeUnclassifiedObjects: true,
                    origin: modelInfo.origin || modelInfo.position,
                    scale: modelInfo.scale,
                    rotation: modelInfo.rotation,
                    matrix: modelInfo.matrix,
                    edges: (modelInfo.edges !== false),
                    saoEnabled: modelInfo.saoEnabled,
                    pbrEnabled: modelInfo.pbrEnabled,
                    backfaces: modelInfo.backfaces,
                    globalizeObjectIds: modelInfo.globalizeObjectIds,
                    reuseGeometries: (modelInfo.reuseGeometries !== false)
                });
                model.on("loaded", () => {
                    const checkbox = document.getElementById("" + modelId);
                    checkbox.checked = true;
                    const scene = this.viewer.scene;
                    this._numModelsLoaded++;
                    this._unloadModelsButtonElement.classList.remove("disabled");
                    if (this._numModelsLoaded < this._numModels) {
                        this._loadModelsButtonElement.classList.remove("disabled");
                    } else {
                        this._loadModelsButtonElement.classList.add("disabled");
                    }
                    if (this._numModelsLoaded === 1) { // Jump camera to view-fit first model loaded
                        this._jumpToInitialCamera();
                        this.fire("modelLoaded", modelId);
                        this.bimViewer._busyModal.hide();
                        if (done) {
                            done();
                        }
                    } else {
                        this.fire("modelLoaded", modelId);
                        this.bimViewer._busyModal.hide();
                        if (done) {
                            done();
                        }
                    }
                });
            },
            (errMsg) => {
                this.bimViewer._busyModal.hide();
                this.error(errMsg);
                if (error) {
                    error(errMsg);
                }
            });
    }

    _jumpToInitialCamera() {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const aabb = scene.getAABB(scene.visibleObjectIds);
        const diag = f.getAABB3Diag(aabb);
        const center = f.getAABB3Center(aabb, tempVec3a$1);
        const camera = scene.camera;
        const fitFOV = camera.perspective.fov;
        const dist = Math.abs(diag / Math.tan(45 * f.DEGTORAD));
        const dir = f.normalizeVec3((camera.yUp) ? [-0.5, -0.7071, -0.5] : [-1, 1, -1]);
        const up = f.normalizeVec3((camera.yUp) ? [-0.5, 0.7071, -0.5] : [-1, 1, 1]);
        viewer.cameraControl.pivotPos = center;
        viewer.cameraControl.planView = false;
        viewer.cameraFlight.jumpTo({
            look: center,
            eye: [center[0] - (dist * dir[0]), center[1] - (dist * dir[1]), center[2] - (dist * dir[2])],
            up: up,
            orthoScale: diag * 1.1
        });
    }

    unloadModel(modelId) {
        const model = this.viewer.scene.models[modelId];
        if (!model) {
            this.error("Model not loaded: " + modelId);
            return;
        }
        model.destroy();
        const checkbox = document.getElementById("" + modelId);
        checkbox.checked = false;
        const span = document.getElementById("span-" + modelId);
        this._numModelsLoaded--;
        if (this._numModelsLoaded > 0) {
            this._unloadModelsButtonElement.classList.remove("disabled");
        } else {
            this._unloadModelsButtonElement.classList.add("disabled");
        }
        if (this._numModelsLoaded < this._numModels) {
            this._loadModelsButtonElement.classList.remove("disabled");
        } else {
            this._loadModelsButtonElement.classList.add("disabled");
        }
        this.fire("modelUnloaded", modelId);
    }

    unloadAllModels() {
        const models = this.viewer.scene.models;
        const modelIds = Object.keys(models);
        for (var i = 0, len = modelIds.length; i < len; i++) {
            const modelId = modelIds[i];
            this.unloadModel(modelId);
        }
    }

    getNumModelsLoaded() {
        return this._numModelsLoaded;
    }

    _getLoadedModelIds() {
        return Object.keys(this.viewer.scene.models);
    }

    isModelLoaded(modelId) {
        return (!!this.viewer.scene.models[modelId]);
    }

    getModelsInfo() {
        return this._modelsInfo;
    }

    getModelInfo(modelId) {
        return this._modelsInfo[modelId];
    }

    setEnabled(enabled) {
        if (!enabled) {
            this._modelsTabButtonElement.classList.add("disabled");
            this._unloadModelsButtonElement.classList.add("disabled");
        } else {
            this._modelsTabButtonElement.classList.remove("disabled");
            this._unloadModelsButtonElement.classList.remove("disabled");
        }
    }

    /** @private */
    destroy() {
        super.destroy();
        this._xktLoader.destroy();
    }
}

const tempVec3$2 = f.vec3();

/**
 * @private
 */
class TreeViewContextMenu extends a {

    constructor(bimViewer) {
        super();
        this._bimViewer = bimViewer;
        this._buildMenu();
    }

    _buildMenu() {

        const showObjectItems = [];
        const focusObjectItems = [];

        if (this._bimViewer._enablePropertiesInspector) {
            showObjectItems.push({
                getTitle: (context) => {
                    return context.viewer.localeService.translate("treeViewContextMenu.inspectProperties") || "Inspect Properties";
                },
                getShown(context) {
                    return !!context.viewer.metaScene.metaObjects[context.treeViewNode.objectId];
                },
                doAction: (context) => {
                    const objectId = context.treeViewNode.objectId;
                    context.bimViewer.showObjectProperties(objectId);
                }
            });
        }

        focusObjectItems.push(...[
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("treeViewContextMenu.viewFit") || "View Fit";
                },
                doAction: function (context) {
                    const viewer = context.viewer;
                    const scene = viewer.scene;
                    const objectIds = [];
                    context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                        if (treeViewNode.objectId) {
                            objectIds.push(treeViewNode.objectId);
                        }
                    });
                    scene.setObjectsVisible(objectIds, true);
                    scene.setObjectsHighlighted(objectIds, true);
                    const aabb = scene.getAABB(objectIds);
                    viewer.cameraFlight.flyTo({
                        aabb: aabb,
                        duration: 0.5
                    }, () => {
                        setTimeout(function () {
                            scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                        }, 500);
                    });
                    viewer.cameraControl.pivotPos = f.getAABB3Center(aabb);
                }
            },
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("treeViewContextMenu.viewFitAll") || "View Fit All";
                },
                doAction: function (context) {
                    const viewer = context.viewer;
                    const scene = viewer.scene;
                    const sceneAABB = scene.getAABB(scene.visibleObjectIds);
                    viewer.cameraFlight.flyTo({
                        aabb: sceneAABB,
                        duration: 0.5
                    });
                    viewer.cameraControl.pivotPos = f.getAABB3Center(sceneAABB);
                }
            }
        ]);

        this.items = [
            showObjectItems,
            focusObjectItems,
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.isolate") || "Isolate";
                    },
                    doAction: function (context) {
                        const viewer = context.viewer;
                        const scene = viewer.scene;
                        const objectIds = [];
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                objectIds.push(treeViewNode.objectId);
                            }
                        });
                        const aabb = scene.getAABB(objectIds);

                        viewer.cameraControl.pivotPos = f.getAABB3Center(aabb, tempVec3$2);

                        scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                        scene.setObjectsVisible(scene.visibleObjectIds, false);
                        // scene.setObjectsPickable(scene.objectIds, false);
                        scene.setObjectsSelected(scene.selectedObjectIds, false);

                        scene.setObjectsVisible(objectIds, true);
                        // scene.setObjectsPickable(objectIds, true);

                        viewer.cameraFlight.flyTo({
                            aabb: aabb
                        }, () => {
                        });
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.hide") || "Hide";
                    },
                    doAction: function (context) {
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = context.viewer.scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.visible = false;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.hideOthers") || "Hide Others";
                    },
                    doAction: function (context) {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.visibleObjectIds, false);
                        scene.setObjectsPickable(scene.xrayedObjectIds, true);
                        scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.visible = true;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.hideAll") || "Hide All";
                    },
                    getEnabled: function (context) {
                        return (context.viewer.scene.visibleObjectIds.length > 0);
                    },
                    doAction: function (context) {
                        context.viewer.scene.setObjectsVisible(context.viewer.scene.visibleObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.show") || "Show";
                    },
                    doAction: function (context) {
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = context.viewer.scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.visible = true;
                                    if (entity.xrayed) {
                                        entity.pickable = true;
                                    }
                                    entity.xrayed = false;
                                    entity.selected = false;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.showOthers") || "Shows Others";
                    },
                    doAction: function (context) {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.objectIds, true);
                        scene.setObjectsPickable(scene.xrayedObjectIds, true);
                        scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.visible = false;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.showAll") || "Show All";
                    },
                    getEnabled: function (context) {
                        const scene = context.viewer.scene;
                        return ((scene.numVisibleObjects < scene.numObjects) || (context.viewer.scene.numXRayedObjects > 0));
                    },
                    doAction: function (context) {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.objectIds, true);
                        scene.setObjectsPickable(scene.xrayedObjectIds, true);
                        scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.xray") || "X-Ray";
                    },
                    doAction: function (context) {
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = context.viewer.scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.selected = false;
                                    entity.xrayed = true;
                                    entity.visible = true;
                                    entity.pickable = context.bimViewer.getConfig("xrayPickable");
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.undoXray") || "Undo X-Ray";
                    },
                    doAction: function (context) {
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = context.viewer.scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.xrayed = false;
                                    entity.pickable = true;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.xrayOthers") || "X-Ray Others";
                    },
                    doAction: function (context) {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.objectIds, true);
                        if (!context.bimViewer.getConfig("xrayPickable")) {
                            scene.setObjectsPickable(scene.objectIds, false);
                        }
                        scene.setObjectsXRayed(scene.objectIds, true);
                        scene.setObjectsSelected(scene.selectedObjectIds, false);
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.xrayed = false;
                                    entity.pickable = true;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.xrayAll") || "X-Ray All";
                    },
                    doAction: function (context) {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.objectIds, true);
                        scene.setObjectsXRayed(scene.objectIds, true);
                        scene.setObjectsSelected(scene.selectedObjectIds, false);
                        scene.setObjectsPickable(scene.objectIds, false);
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.xrayNone") || "X-Ray None";
                    },
                    getEnabled: function (context) {
                        return (context.viewer.scene.numXRayedObjects > 0);
                    },
                    doAction: function (context) {
                        const scene = context.viewer.scene;
                        const xrayedObjectIds = scene.xrayedObjectIds;
                        scene.setObjectsPickable(xrayedObjectIds, true);
                        scene.setObjectsXRayed(xrayedObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.select") || "Select";
                    },
                    doAction: function (context) {
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = context.viewer.scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.selected = true;
                                    entity.visible = true;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.undoSelect") || "Undo Select";
                    },
                    doAction: function (context) {
                        context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                            if (treeViewNode.objectId) {
                                const entity = context.viewer.scene.objects[treeViewNode.objectId];
                                if (entity) {
                                    entity.selected = false;
                                }
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.selectNone") || "Select None";
                    },
                    getEnabled: function (context) {
                        return (context.viewer.scene.numSelectedObjects > 0);
                    },
                    doAction: function (context) {
                        context.viewer.scene.setObjectsSelected(context.viewer.scene.selectedObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("treeViewContextMenu.clearSlices") || "Clear Slices";
                    },
                    getEnabled: function (context) {
                        return (context.bimViewer.getNumSections() > 0);
                    },
                    doAction: function (context) {
                        context.bimViewer.clearSections();
                    }
                }]
        ];
    }
}

/** @private */
class ObjectsExplorer extends Controller {

    constructor(parent, cfg = {}) {

        super(parent);

        if (!cfg.objectsTabElement) {
            throw "Missing config: objectsTabElement";
        }

        if (!cfg.showAllObjectsButtonElement) {
            throw "Missing config: showAllObjectsButtonElement";
        }

        if (!cfg.hideAllObjectsButtonElement) {
            throw "Missing config: hideAllObjectsButtonElement";
        }

        if (!cfg.objectsElement) {
            throw "Missing config: objectsElement";
        }

        this._objectsTabElement = cfg.objectsTabElement;
        this._showAllObjectsButtonElement = cfg.showAllObjectsButtonElement;
        this._hideAllObjectsButtonElement = cfg.hideAllObjectsButtonElement;
        this._objectsTabButtonElement = this._objectsTabElement.querySelector(".xeokit-tab-btn");

        if (!this._objectsTabButtonElement) {
            throw "Missing DOM element: ,xeokit-tab-btn";
        }

        const objectsElement = cfg.objectsElement;

        this._treeView = new Yf(this.viewer, {
            containerElement: objectsElement,
            hierarchy: "containment",
            autoAddModels: false,
            pruneEmptyNodes: true
        });

        this._treeViewContextMenu = new TreeViewContextMenu(this.bimViewer);

        this._treeView.on("contextmenu", (e) => {
            this._treeViewContextMenu.context = {
                bimViewer: this.bimViewer,
                viewer: e.viewer,
                treeViewPlugin: e.treeViewPlugin,
                treeViewNode: e.treeViewNode
            };
            this._treeViewContextMenu.show(e.event.pageX, e.event.pageY);
        });

        this._treeView.on("nodeTitleClicked", (e) => {
            const scene = this.viewer.scene;
            const objectIds = [];
            e.treeViewPlugin.withNodeTree(e.treeViewNode, (treeViewNode) => {
                if (treeViewNode.objectId) {
                    objectIds.push(treeViewNode.objectId);
                }
            });
            const checked = e.treeViewNode.checked;
            if (checked) {
                scene.setObjectsXRayed(objectIds, false);
                scene.setObjectsVisible(objectIds, false);
                scene.setObjectsPickable(objectIds, true);
            } else {
                scene.setObjectsXRayed(objectIds, false);
                scene.setObjectsVisible(objectIds, true);
                scene.setObjectsPickable(objectIds, true);
            }
        });

        this._onModelLoaded = this.viewer.scene.on("modelLoaded", (modelId) => {
            if (this.viewer.metaScene.metaModels[modelId]) {
                const modelInfo = this.bimViewer._modelsExplorer.getModelInfo(modelId);
                if (!modelInfo) {
                    return;
                }
                this._treeView.addModel(modelId, {
                    rootName: modelInfo.name
                });
            }
        });

        this._onModelUnloaded = this.viewer.scene.on("modelUnloaded", (modelId) => {
            if (this.viewer.metaScene.metaModels[modelId]) {
                this._treeView.removeModel(modelId);
            }
        });

        this.bimViewer.on("reset", () => {
            this._treeView.collapse();
        });
    }

    setEnabled(enabled) {
        if (!enabled) {
            this._objectsTabButtonElement.classList.add("disabled");
            this._showAllObjectsButtonElement.classList.add("disabled");
            this._hideAllObjectsButtonElement.classList.add("disabled");
        } else {
            this._objectsTabButtonElement.classList.remove("disabled");
            this._showAllObjectsButtonElement.classList.remove("disabled");
            this._hideAllObjectsButtonElement.classList.remove("disabled");
        }
    }

    expandTreeViewToDepth(depth) {
        this._treeView.expandToDepth(depth);
    }

    showNodeInTreeView(objectId) {
        this._treeView.collapse();
        this._treeView.showNode(objectId);
    }

    unShowNodeInTreeView() {
        this._treeView.unShowNode();
    }

    destroy() {
        super.destroy();
        this._treeView.destroy();
        this._treeViewContextMenu.destroy();
        this.viewer.scene.off(this._onModelLoaded);
        this.viewer.scene.off(this._onModelUnloaded);
    }
}

/** @private */
class ClassesExplorer extends Controller {

    constructor(parent, cfg = {}) {

        super(parent);

        if (!cfg.classesTabElement) {
            throw "Missing config: classesTabElement";
        }

        if (!cfg.showAllClassesButtonElement) {
            throw "Missing config: showAllClassesButtonElement";
        }

        if (!cfg.hideAllClassesButtonElement) {
            throw "Missing config: hideAllClassesButtonElement";
        }

        if (!cfg.classesElement) {
            throw "Missing config: classesElement";
        }

        this._classesTabElement = cfg.classesTabElement;
        this._showAllClassesButtonElement = cfg.showAllClassesButtonElement;
        this._hideAllClassesButtonElement = cfg.hideAllClassesButtonElement;
        this._classesTabButtonElement = this._classesTabElement.querySelector(".xeokit-tab-btn");

        if (!this._classesTabButtonElement) {
            throw "Missing DOM element: xeokit-tab-btn";
        }

        const classesElement = cfg.classesElement;

        this._treeView = new Yf(this.viewer, {
            containerElement: classesElement,
            hierarchy: "types",
            autoAddModels: false,
            pruneEmptyNodes: true
        });

        this._treeViewContextMenu = new TreeViewContextMenu(this.bimViewer);

        this._treeView.on("contextmenu", (e) => {
            this._treeViewContextMenu.context = {
                bimViewer: this.bimViewer,
                viewer: e.viewer,
                treeViewPlugin: e.treeViewPlugin,
                treeViewNode: e.treeViewNode
            };
            this._treeViewContextMenu.show(e.event.pageX, e.event.pageY);
        });

        this._treeView.on("nodeTitleClicked", (e) => {
            const scene = this.viewer.scene;
            const objectIds = [];
            e.treeViewPlugin.withNodeTree(e.treeViewNode, (treeViewNode) => {
                if (treeViewNode.objectId) {
                    objectIds.push(treeViewNode.objectId);
                }
            });
            const checked = e.treeViewNode.checked;
            if (checked) {
                scene.setObjectsXRayed(objectIds, false);
                scene.setObjectsVisible(objectIds, false);
                scene.setObjectsPickable(objectIds, true);
            } else {
                scene.setObjectsXRayed(objectIds, false);
                scene.setObjectsVisible(objectIds, true);
                scene.setObjectsPickable(objectIds, true);
            }
        });

        this._onModelLoaded = this.viewer.scene.on("modelLoaded", (modelId) => {
            if (this.viewer.metaScene.metaModels[modelId]) {
                const modelInfo = this.bimViewer._modelsExplorer.getModelInfo(modelId);
                if (!modelInfo) {
                    return;
                }
                this._treeView.addModel(modelId, {
                    rootName: modelInfo.name
                });
            }
        });

        this._onModelUnloaded = this.viewer.scene.on("modelUnloaded", (modelId) => {
            if (this.viewer.metaScene.metaModels[modelId]) {
                this._treeView.removeModel(modelId);
            }
        });

        this.bimViewer.on("reset", () => {
            this._treeView.collapse();
        });
    }

    setEnabled(enabled) {
        if (!enabled) {
            this._classesTabButtonElement.classList.add("disabled");
            this._showAllClassesButtonElement.classList.add("disabled");
            this._hideAllClassesButtonElement.classList.add("disabled");
        } else {
            this._classesTabButtonElement.classList.remove("disabled");
            this._showAllClassesButtonElement.classList.remove("disabled");
            this._hideAllClassesButtonElement.classList.remove("disabled");
        }
    }

    expandTreeViewToDepth(depth) {
        this._treeView.expandToDepth(depth);
    }

    showNodeInTreeView(objectId) {
        this._treeView.collapse();
        this._treeView.showNode(objectId);
    }

    unShowNodeInTreeView() {
        this._treeView.unShowNode();
    }

    destroy() {
        super.destroy();
        this._treeView.destroy();
        this._treeViewContextMenu.destroy();
        this.viewer.scene.off(this._onModelLoaded);
        this.viewer.scene.off(this._onModelUnloaded);
    }
}

const tempVec3$3 = f.vec3();

/** @private */
class StoreysExplorer extends Controller {

    constructor(parent, cfg = {}) {

        super(parent);

        if (!cfg.storeysTabElement) {
            throw "Missing config: storeysTabElement";
        }

        if (!cfg.showAllStoreysButtonElement) {
            throw "Missing config: showAllStoreysButtonElement";
        }

        if (!cfg.hideAllStoreysButtonElement) {
            throw "Missing config: hideAllStoreysButtonElement";
        }

        if (!cfg.storeysElement) {
            throw "Missing config: storeysElement";
        }

        this._storeysTabElement = cfg.storeysTabElement;
        this._showAllStoreysButtonElement = cfg.showAllStoreysButtonElement;
        this._hideAllStoreysButtonElement = cfg.hideAllStoreysButtonElement;
        this._storeysTabButtonElement = this._storeysTabElement.querySelector(".xeokit-tab-btn");

        if (!this._storeysTabButtonElement) {
            throw "Missing DOM element: .xeokit-tab-btn";
        }

        const storeysElement = cfg.storeysElement;

        this._treeView = new Yf(this.viewer, {
            containerElement: storeysElement,
            autoAddModels: false,
            hierarchy: "storeys",
            autoExpandDepth: 1
        });

        this._treeViewContextMenu = new TreeViewContextMenu(this.bimViewer);

        this._treeView.on("contextmenu", (e) => {
            this._treeViewContextMenu.context = {
                bimViewer: this.bimViewer,
                viewer: e.viewer,
                treeViewPlugin: e.treeViewPlugin,
                treeViewNode: e.treeViewNode,
                pruneEmptyNodes: true
            };
            this._treeViewContextMenu.show(e.event.pageX, e.event.pageY);
        });

        this._treeView.on("nodeTitleClicked", (e) => {
            const scene = this.viewer.scene;
            const objectIds = [];
            e.treeViewPlugin.withNodeTree(e.treeViewNode, (treeViewNode) => {
                if (treeViewNode.objectId) {
                    objectIds.push(treeViewNode.objectId);
                }
            });
            const checked = e.treeViewNode.checked;
            if (checked) {
                scene.setObjectsXRayed(objectIds, false);
                scene.setObjectsVisible(objectIds, false);
                scene.setObjectsPickable(objectIds, true);
            } else {
                scene.setObjectsXRayed(objectIds, false);
                scene.setObjectsVisible(objectIds, true);
                scene.setObjectsPickable(objectIds, true);
            }
        });

        this._onModelLoaded = this.viewer.scene.on("modelLoaded", (modelId) =>{
            const modelInfo = this.bimViewer._modelsExplorer.getModelInfo(modelId);
            if (!modelInfo) {
                return;
            }
            this._treeView.addModel(modelId, {
                rootName: modelInfo.name
            });
        });

        this._onModelUnloaded = this.viewer.scene.on("modelUnloaded", (modelId) => {
            if (this.viewer.metaScene.metaModels[modelId]) {
                this._treeView.removeModel(modelId);
            }
        });

        this.bimViewer.on("reset", () => {
            this._treeView.collapse();
            this._treeView.expandToDepth(1);
        });
    }

    setEnabled(enabled) {
        if (!enabled) {
            this._storeysTabButtonElement.classList.add("disabled");
            this._showAllStoreysButtonElement.classList.add("disabled");
            this._hideAllStoreysButtonElement.classList.add("disabled");
        } else {
            this._storeysTabButtonElement.classList.remove("disabled");
            this._showAllStoreysButtonElement.classList.remove("disabled");
            this._hideAllStoreysButtonElement.classList.remove("disabled");
        }
    }

    expandTreeViewToDepth(depth) {
        this._treeView.expandToDepth(depth);
    }

    showNodeInTreeView(objectId) {
        this._treeView.collapse();
        this._treeView.showNode(objectId);
    }

    unShowNodeInTreeView() {
        this._treeView.unShowNode();
    }

    selectStorey(storeyObjectId, done) {
        const metaScene = this.viewer.metaScene;
        const storeyMetaObject = metaScene.metaObjects[storeyObjectId];
        if (!storeyMetaObject) {
            this.error("selectStorey() - object is not found: '" + storeyObjectId + "'");
            return;
        }
        if (storeyMetaObject.type !== "IfcBuildingStorey") {
            this.error("selectStorey() - object is not found: '" + storeyObjectId + "'");
            return;
        }
        const objectIds = storeyMetaObject.getObjectIDsInSubtree();
        this._selectObjects(objectIds, done);
    }

    _selectObjects(objectIds, done) {
        const scene = this.viewer.scene;
        const aabb = scene.getAABB(objectIds);

        this.viewer.cameraControl.pivotPos = f.getAABB3Center(aabb, tempVec3$3);

        if (done) {

            scene.setObjectsXRayed(scene.objectIds, true);
            scene.setObjectsVisible(scene.objectIds, true);
            scene.setObjectsPickable(scene.objectIds, false);
            scene.setObjectsSelected(scene.selectedObjectIds, false);

            scene.setObjectsXRayed(objectIds, false);
            scene.setObjectsVisible(objectIds, true);
            scene.setObjectsPickable(objectIds, true);

            this.viewer.cameraFlight.flyTo({
                aabb: aabb
            }, () => {
                setTimeout(function () {
                    scene.setObjectsVisible(scene.xrayedObjectIds, false);
                    scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                }, 500);
                done();
            });
        } else {

            scene.setObjectsVisible(scene.objectIds, false);
            scene.setObjectsPickable(scene.xrayedObjectIds, true);
            scene.setObjectsXRayed(scene.xrayedObjectIds, false);
            scene.setObjectsSelected(scene.selectedObjectIds, false);

            scene.setObjectsVisible(objectIds, true);

            this.viewer.cameraFlight.jumpTo({
                aabb: aabb
            });
        }
    }

    destroy() {
        super.destroy();
        this._treeView.destroy();
        this._treeViewContextMenu.destroy();
        this.viewer.scene.off(this._onModelLoaded);
        this.viewer.scene.off(this._onModelUnloaded);
    }
}

const tempVec3a$2 = f.vec3();

/** @private */
class ThreeDMode extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        this._saveOrthoActive = null;
        this._buttonElement = cfg.buttonElement;

        this._cameraControlNavModeMediator = cfg.cameraControlNavModeMediator;

        this._active = false;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                this._buttonElement.classList.add("disabled");
            } else {
                this._buttonElement.classList.remove("disabled");
            }
        });

        this._buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.bimViewer._sectionTool.hideControl();
                this.setActive(!this.getActive(), () => { // Animated
                });
            }
            event.preventDefault();
        });

        this.bimViewer.on("reset", () => {
            this.setActive(true, () => { // Animated
            });
        });
    }

    setEnabled(enabled) {
        super.setEnabled(enabled);
        this._saveOrthoActive = this.bimViewer._orthoMode.getActive();
    }

    setActive(active, done) {
        if (this._active === active) {
            if (done) {
                done();
            }
            return;
        }
        this._active = active;
        if (active) {
            this._buttonElement.classList.add("active");
            if (done) {
                this._enterThreeDMode(() => {
                    this.fire("active", this._active);
                    done();
                });
            } else {
                this._enterThreeDMode();
                this.fire("active", this._active);
            }
        } else {
            this._buttonElement.classList.remove("active");
            if (done) {
                this._exitThreeDMode(() => {
                    this.fire("active", this._active);
                    done();
                });
            } else {
                this._exitThreeDMode();
                this.fire("active", this._active);
            }
        }
    }

    _enterThreeDMode(done) {

        const viewer = this.viewer;
        const scene = viewer.scene;
        const aabb = scene.getAABB(scene.visibleObjectIds);
        const diag = f.getAABB3Diag(aabb);
        const center = f.getAABB3Center(aabb, tempVec3a$2);
        const dist = Math.abs(diag / Math.tan(65.0 / 2));     // TODO: fovy match with CameraFlight
        const camera = scene.camera;
        const dir = (camera.yUp) ? [-1, -1, -1] : [1, 1, 1];
        const up = (camera.yUp) ? [-1, 1, -1] : [-1, 1, 1];

        viewer.cameraControl.pivotPos = center;

        this.bimViewer._navCubeMode.setActive(true);
        this.bimViewer._firstPersonMode.setEnabled(true);
        this._cameraControlNavModeMediator.setThreeDModeActive(true);
        this.bimViewer._sectionTool.setEnabled(true);
        this.bimViewer._orthoMode.setEnabled(true);

        if (done) {
            viewer.cameraFlight.flyTo({
                look: center,
                eye: [center[0] - (dist * dir[0]), center[1] - (dist * dir[1]), center[2] - (dist * dir[2])],
                up: up,
                orthoScale: diag * 1.3,
                duration: 1,
                projection: this._saveOrthoActive ? "ortho" : "perspective"
            }, () => {
                done();
            });
        } else {
            viewer.cameraFlight.jumpTo({
                look: center,
                eye: [center[0] - (dist * dir[0]), center[1] - (dist * dir[1]), center[2] - (dist * dir[2])],
                up: up,
                orthoScale: diag * 1.3,
                projection: this._saveOrthoActive ? "ortho" : "perspective"
            });
        }
    }

    _exitThreeDMode(done) {

        const viewer = this.viewer;
        const scene = viewer.scene;
        const camera = scene.camera;
        const aabb = scene.getAABB(scene.visibleObjectIds);
        const look2 = f.getAABB3Center(aabb);
        const diag = f.getAABB3Diag(aabb);
        const fitFOV = 45; // fitFOV;
        const sca = Math.abs(diag / Math.tan(fitFOV * f.DEGTORAD));
        const orthoScale2 = diag * 1.3;
        const eye2 = tempVec3a$2;

        eye2[0] = look2[0] + (camera.worldUp[0] * sca);
        eye2[1] = look2[1] + (camera.worldUp[1] * sca);
        eye2[2] = look2[2] + (camera.worldUp[2] * sca);

        const up2 = f.mulVec3Scalar(camera.worldForward, -1, []);

        this.bimViewer._sectionTool.setActive(false);
        this.bimViewer._firstPersonMode.setEnabled(false);

        this._saveOrthoActive = this.bimViewer._orthoMode.getActive();
         this.bimViewer._orthoMode.setEnabled(false);

        this._cameraControlNavModeMediator.setThreeDModeActive(false);

        if (done) {
            viewer.cameraFlight.flyTo({
                eye: eye2,
                look: look2,
                up: up2,
                orthoScale: orthoScale2,
                projection: "ortho"
            }, () => {
                this.bimViewer._navCubeMode.setActive(false);
            });
        } else {
            viewer.cameraFlight.jumpTo({
                eye: eye2,
                look: look2,
                up: up2,
                orthoScale: orthoScale2,
                projection: "ortho"
            });
            this.bimViewer._navCubeMode.setActive(false);
        }
    }
}

/**
 * @private
 */
class ObjectContextMenu extends a {

    constructor(bimViewer) {
        super();
        this._bimViewer = bimViewer;
        this._buildMenu();
    }

    _buildMenu() {

        const showObjectItems = [];
        const focusObjectItems = [];

        if (this._bimViewer._enablePropertiesInspector) {
            showObjectItems.push(...[{
                getTitle: (context) => {
                    return context.viewer.localeService.translate("objectContextMenu.inspectProperties") || "Inspect Properties";
                },
                doAction: (context) => {
                    const objectId = context.entity.id;
                    context.bimViewer.showObjectProperties(objectId);
                }
            }]);
        }

        showObjectItems.push(...[
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("objectContextMenu.showInTree") || "Show in Explorer";
                },
                doAction: (context) => {
                    const objectId = context.entity.id;
                    context.showObjectInExplorers(objectId);
                }
            }
        ]);

        focusObjectItems.push(...[
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("objectContextMenu.viewFit") || "View Fit";
                },
                doAction: (context) => {
                    const viewer = context.viewer;
                    const scene = viewer.scene;
                    const entity = context.entity;
                    viewer.cameraFlight.flyTo({
                        aabb: entity.aabb,
                        duration: 0.5
                    }, () => {
                        setTimeout(function () {
                            scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                        }, 500);
                    });
                    viewer.cameraControl.pivotPos = f.getAABB3Center(entity.aabb);
                }
            },
            {
                getTitle: (context) => {
                    return context.viewer.localeService.translate("objectContextMenu.viewFitAll") || "View Fit All";
                },
                doAction: (context) => {
                    const viewer = context.viewer;
                    const scene = viewer.scene;
                    const sceneAABB = scene.getAABB(scene.visibleObjectIds);
                    viewer.cameraFlight.flyTo({
                        aabb: sceneAABB,
                        duration: 0.5
                    });
                    viewer.cameraControl.pivotPos = f.getAABB3Center(sceneAABB);
                }
            }
        ]);

        this.items = [
            showObjectItems,
            focusObjectItems,
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.hide") || "Hide";
                    },
                    getEnabled: (context) => {
                        return context.entity.visible;
                    },
                    doAction: (context) => {
                        context.entity.visible = false;
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.hideOthers") || "Hide Others";
                    },
                    doAction: (context) => {
                        const viewer = context.viewer;
                        const scene = viewer.scene;
                        const entity = context.entity;
                        const metaObject = viewer.metaScene.metaObjects[entity.id];
                        if (!metaObject) {
                            return;
                        }
                        scene.setObjectsVisible(scene.visibleObjectIds, false);
                        metaObject.withMetaObjectsInSubtree((metaObject) => {
                            const entity = scene.objects[metaObject.id];
                            if (entity) {
                                entity.visible = true;
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.hideAll") || "Hide All";
                    },
                    getEnabled: (context) => {
                        return (context.viewer.scene.numVisibleObjects > 0);
                    },
                    doAction: (context) => {
                        context.viewer.scene.setObjectsVisible(context.viewer.scene.visibleObjectIds, false);
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.showAll") || "Show All";
                    },
                    getEnabled: (context) => {
                        const scene = context.viewer.scene;
                        return ((scene.numVisibleObjects < scene.numObjects) || (context.viewer.scene.numXRayedObjects > 0));
                    },
                    doAction: (context) => {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.objectIds, true);
                        scene.setObjectsPickable(scene.xrayedObjectIds, true);
                        scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.xray") || "X-Ray";
                    },
                    getEnabled: (context) => {
                        return (!context.entity.xrayed);
                    },
                    doAction: (context) => {
                        const entity = context.entity;
                        entity.xrayed = true;
                        entity.pickable = context.bimViewer.getConfig("xrayPickable");
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.xrayOthers") || "X-Ray Others";
                    },
                    doAction: (context) => {
                        const viewer = context.viewer;
                        const scene = viewer.scene;
                        const entity = context.entity;
                        const metaObject = viewer.metaScene.metaObjects[entity.id];
                        if (!metaObject) {
                            return;
                        }
                        scene.setObjectsVisible(scene.objectIds, true);
                        scene.setObjectsXRayed(scene.objectIds, true);
                        if (!context.bimViewer.getConfig("xrayPickable")) {
                            scene.setObjectsPickable(scene.objectIds, false);
                        }
                        metaObject.withMetaObjectsInSubtree((metaObject) => {
                            const entity = scene.objects[metaObject.id];
                            if (entity) {
                                entity.xrayed = false;
                                entity.pickable = true;
                            }
                        });
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.xrayAll") || "X-Ray All";
                    },
                    getEnabled: (context) => {
                        const scene = context.viewer.scene;
                        return (scene.numXRayedObjects < scene.numObjects);
                    },
                    doAction: (context) => {
                        const scene = context.viewer.scene;
                        scene.setObjectsVisible(scene.objectIds, true);
                        if (!context.bimViewer.getConfig("xrayPickable")) {
                            scene.setObjectsPickable(scene.objectIds, false);
                        }
                        scene.setObjectsXRayed(scene.objectIds, true);
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.xrayNone") || "X-Ray None";
                    },
                    getEnabled: (context) => {
                        return (context.viewer.scene.numXRayedObjects > 0);
                    },
                    doAction: (context) => {
                        const scene = context.viewer.scene;
                        const xrayedObjectIds = scene.xrayedObjectIds;
                        scene.setObjectsPickable(xrayedObjectIds, true);
                        scene.setObjectsXRayed(xrayedObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.select") || "Select";
                    },
                    getEnabled: (context) => {
                        return (!context.entity.selected);
                    },
                    doAction: (context) => {
                        context.entity.selected = true;

                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.undoSelect") || "Undo Select";
                    },
                    getEnabled: (context) => {
                        return context.entity.selected;
                    },
                    doAction: (context) => {
                        context.entity.selected = false;
                    }
                },
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.selectNone") || "Select None";
                    },
                    getEnabled: (context) => {
                        return (context.viewer.scene.numSelectedObjects > 0);
                    },
                    doAction: (context) => {
                        context.viewer.scene.setObjectsSelected(context.viewer.scene.selectedObjectIds, false);
                    }
                }
            ],
            [
                {
                    getTitle: (context) => {
                        return context.viewer.localeService.translate("objectContextMenu.clearSlices") || "Clear Slices";
                    },
                    getEnabled: (context) => {
                        return (context.bimViewer.getNumSections() > 0);
                    },
                    doAction: (context) => {
                        context.bimViewer.clearSections();
                    }
                }
            ]
        ];
    }
}

/**
 * @private
 */
class CanvasContextMenu extends a {
    constructor(cfg = {}) {
        super({
            context: cfg.context,
            items: [
                [
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.viewFitAll") || "View Fit All";
                        },
                        doAction: (context) => {
                            const viewer = context.viewer;
                            const scene = viewer.scene;
                            const sceneAABB = scene.getAABB(scene.visibleObjectIds);
                            viewer.cameraFlight.flyTo({
                                aabb: sceneAABB,
                                duration: 0.5
                            });
                            viewer.cameraControl.pivotPos = f.getAABB3Center(sceneAABB);
                        }
                    }
                ],
                [
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.hideAll") || "Hide All";
                        },
                        getEnabled: (context) => {
                            return (context.viewer.scene.numVisibleObjects > 0);
                        },
                        doAction: (context) => {
                            context.viewer.scene.setObjectsVisible(context.viewer.scene.visibleObjectIds, false);
                        }
                    },
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.showAll") || "Show All";
                        },
                        getEnabled: (context) => {
                            const scene = context.viewer.scene;
                            return ((scene.numVisibleObjects < scene.numObjects) || (context.viewer.scene.numXRayedObjects > 0));
                        },
                        doAction: (context) => {
                            const scene = context.viewer.scene;
                            scene.setObjectsVisible(scene.objectIds, true);
                            scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                        }
                    }
                ],
                [
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.xRayAll") || "X-Ray All";
                        },
                        getEnabled: (context) => {
                            const scene = context.viewer.scene;
                            return (scene.numXRayedObjects < scene.numObjects);
                        },
                        doAction: (context) => {
                            const scene = context.viewer.scene;
                            scene.setObjectsVisible(scene.objectIds, true);
                            scene.setObjectsXRayed(scene.objectIds, true);
                            if (!context.bimViewer.getConfig("xrayPickable")) {
                                scene.setObjectsPickable(scene.objectIds, false);
                            }
                        }
                    },
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.xRayNone") || "X-Ray None";
                        },
                        getEnabled: (context) => {
                            return (context.viewer.scene.numXRayedObjects > 0);
                        },
                        doAction: (context) => {
                            const xrayedObjectIds = context.viewer.scene.xrayedObjectIds;
                            context.viewer.scene.setObjectsPickable(xrayedObjectIds, true);
                            context.viewer.scene.setObjectsXRayed(xrayedObjectIds, false);
                        }
                    }
                ],
                [
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.selectNone") || "Select None";
                        },
                        getEnabled: (context) => {
                            return (context.viewer.scene.numSelectedObjects > 0);
                        },
                        doAction: (context) => {
                            context.viewer.scene.setObjectsSelected(context.viewer.scene.selectedObjectIds, false);
                        }
                    }
                ],
                [
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.resetView") || "Reset View";
                        },
                        doAction: (context) => {
                            context.bimViewer.resetView();
                        }
                    }
                ],
                [
                    {
                        getTitle: (context) => {
                            return context.viewer.localeService.translate("canvasContextMenu.clearSlices") || "Clear Slices";
                        },
                        getEnabled: (context) => {
                            return (context.bimViewer.getNumSections() > 0);
                        },
                        doAction: (context) => {
                            context.bimViewer.clearSections();
                        }
                    }
                ]
            ]
        });
    }
}

/** @private */
class OrthoMode extends Controller {

    constructor(parent, cfg) {

        super(parent, cfg);

        if (!cfg.buttonElement) {
            throw "Missing config: buttonElement";
        }

        this._buttonElement = cfg.buttonElement;

        this.on("enabled", (enabled) => {
            if (!enabled) {
                this._buttonElement.classList.add("disabled");
            } else {
                this._buttonElement.classList.remove("disabled");
            }
        });

        this._buttonElement.addEventListener("click", (event) => {
            if (this.getEnabled()) {
                this.setActive(!this.getActive(), () => {
                });
            }
            event.preventDefault();
        });

        this.bimViewer.on("reset", () => {
            this.setActive(false);
        });

        this.viewer.camera.on("projection", () => {
            const isOrtho = (this.viewer.camera.projection === "ortho");
            this._active = isOrtho;
            if (this._active) {
                this._buttonElement.classList.add("active");
            } else {
                this._buttonElement.classList.remove("active");
            }
        });

        this._active = false;
        this._buttonElement.classList.remove("active");
    }

    setActive(active, done) {
        if (this._active === active) {
            if (done) {
                done();
            }
            return;
        }
        this._active = active;
        if (active) {
            this._buttonElement.classList.add("active");
            if (done) {
                this._enterOrthoMode(() => {
                    this.fire("active", this._active);
                    done();
                });
            } else {
                this._enterOrthoMode();
                this.fire("active", this._active);
            }
        } else {
            this._buttonElement.classList.remove("active");
            if (done) {
                this._exitOrthoMode(() => {
                    this.fire("active", this._active);
                    done();
                });
            } else {
                this._exitOrthoMode();
                this.fire("active", this._active);
            }
        }
    }

    _enterOrthoMode(done) {
        if (done) {
            this.viewer.cameraFlight.flyTo({projection: "ortho", duration: 0.5}, done);
        } else {
            this.viewer.cameraFlight.jumpTo({projection: "ortho"});
        }
    }

    _exitOrthoMode(done) {
        if (done) {
            this.viewer.cameraFlight.flyTo({projection: "perspective", duration: 0.5}, done);
        } else {
            this.viewer.cameraFlight.jumpTo({projection: "perspective"});
        }
    }
}

/** @private */
class PropertiesInspector extends Controller {

    constructor(parent, cfg = {}) {

        super(parent);

        if (!cfg.propertiesTabElement) {
            throw "Missing config: propertiesTabElement";
        }

        if (!cfg.propertiesElement) {
            throw "Missing config: propertiesElement";
        }

        this._metaObject = null;

        this._propertiesTabElement = cfg.propertiesTabElement;
        this._propertiesElement = cfg.propertiesElement;
        this._propertiesTabButtonElement = this._propertiesTabElement.querySelector(".xeokit-tab-btn");

        if (!this._propertiesTabButtonElement) {
            throw "Missing DOM element: ,xeokit-tab-btn";
        }

        this._onModelUnloaded = this.viewer.scene.on("modelUnloaded", (modelId) => {
            if (this._metaObject && this._metaObject.metaModel.id === modelId) {
                this.clear();
            }
        });

        this.bimViewer.on("reset", () => {
            this.clear();
        });

        document.addEventListener('click', this._clickListener = (e) => {
            if (!e.target.matches('.xeokit-accordion .xeokit-accordion-button')) {
                return;
            } else {
                if (!e.target.parentElement.classList.contains('active')) {
                    e.target.parentElement.classList.add('active');
                } else {
                    e.target.parentElement.classList.remove('active');
                }
            }
        });

        this.clear();
    }

    showObjectPropertySets(objectId) {
        const metaObject = this.viewer.metaScene.metaObjects[objectId];
        if (!metaObject) {
            return;
        }
        const propertySets = metaObject.propertySets;
        if (propertySets && propertySets.length > 0) {
            this._setPropertySets(metaObject, propertySets);
        } else {
            this._setPropertySets(metaObject);
        }
        this._metaObject = metaObject;
    }

    clear() {
        const html = [];
        html.push(`<div class="element-attributes">`);
        html.push(`<p class="subsubtitle no-object-selected-warning">No object inspected. Right-click or long-tab an object and select \'Inspect Properties\' to view its properties here.</p>`);
        html.push(`</div>`);
        const htmlStr = html.join("");
       this._propertiesElement.innerHTML = htmlStr;
    }

    _setPropertySets(metaObject, propertySets) {
        const html = [];
        html.push(`<div class="element-attributes">`);
        if (!metaObject) {
            html.push(`<p class="subsubtitle">No object selected</p>`);
        } else {
            html.push('<table class="xeokit-table">');
            html.push(`<tr><td class="td1">Name:</td><td class="td2">${metaObject.name}</td></tr>`);
            if (metaObject.type) {
                html.push(`<tr><td class="td1">Class:</td><td class="td2">${metaObject.type}</td></tr>`);
            }
            html.push(`<tr><td class="td1">UUID:</td><td class="td2">${metaObject.originalSystemId}</td></tr>`);
            html.push(`<tr><td class="td1">Viewer ID:</td><td class="td2">${metaObject.id}</td></tr>`);
            html.push('</table>');
            if (!propertySets || propertySets.length === 0) {
                html.push(`<p class="subtitle xeokit-no-prop-set-warning">No properties sets found for this object.</p>`);
                html.push(`</div>`);
            } else {
                html.push(`</div>`);
                html.push(`<div class="xeokit-accordion">`);
                for (let i = 0, len = propertySets.length; i < len; i++) {
                    const propertySet = propertySets[i];
                    const properties = propertySet.properties || [];
                    if (properties.length > 0) {
                        html.push(`<div class="xeokit-accordion-container">
                                        <p class="xeokit-accordion-button"><span></span>${propertySet.name}</p>                                       
                                        <div class="xeokit-accordion-panel">                                           
                                            <table class="xeokit-table"><tbody>`);
                        for (let i = 0, len = properties.length; i < len; i++) {
                            const property = properties[i];
                            html.push(`<tr><td class="td1">${property.name || property.label}:</td><td class="td2">${property.value}</td></tr>`);
                        }
                        html.push(`</tbody></table>
                        </div>
                        </div>`);
                    }
                }
                html.push(`</div>`);
            }
        }
        this._propertiesElement.innerHTML = html.join("");
    }

    setEnabled(enabled) {
        if (!enabled) {
            this._propertiesTabButtonElement.classList.add("disabled");
        } else {
            this._propertiesTabButtonElement.classList.remove("disabled");
        }
    }

    destroy() {
        super.destroy();
        this.viewer.scene.off(this._onModelLoaded);
        this.viewer.scene.off(this._onModelUnloaded);
        document.removeEventListener('click', this._clickListener);
    }
}

const hideEdgesMinDrawCount = 5; // FastNavPlugin enables dynamic edges when xeokit's per-frame draw count drops below this
const scaleCanvasResolutionMinDrawCount = 1000; // FastNavPlugin switches to low-res canvas when xeokit's per-frame draw count rises above this

function createExplorerTemplate(cfg) {
    const explorerTemplate = `<div class="xeokit-tabs"> 
    <div class="xeokit-tab xeokit-modelsTab">
        <a class="xeokit-i18n xeokit-tab-btn" href="#" data-xeokit-i18n="modelsExplorer.title">Models</a>
        <div class="xeokit-tab-content">
            <div class="xeokit-btn-group">
                <button type="button" class="xeokit-i18n xeokit-loadAllModels xeokit-btn disabled" data-xeokit-i18n="modelsExplorer.loadAll" data-xeokit-i18ntip="modelsExplorer.loadAllTip" data-tippy-content="Load all models">Load all</button>
                <button type="button" class="xeokit-i18n xeokit-unloadAllModels xeokit-btn disabled" data-xeokit-i18n="modelsExplorer.unloadAll"  data-xeokit-i18ntip="modelsExplorer.unloadAllTip" data-tippy-content="Unload all models">Unload all</button>` +
        (cfg.enableEditModels ? `<button type="button" class="xeokit-i18n xeokit-addModel xeokit-btn disabled" data-xeokit-i18n="modelsExplorer.add"  data-xeokit-i18ntip="modelsExplorer.addTip" data-tippy-content="Add model">Add</button>` : ``) + `</div>
            <div class="xeokit-models" ></div>
        </div>
    </div>
    <div class="xeokit-tab xeokit-objectsTab">
        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="objectsExplorer.title">Objects</a>
        <div class="xeokit-tab-content">
         <div class="xeokit-btn-group">
            <button type="button" class="xeokit-i18n xeokit-showAllObjects xeokit-btn disabled" data-xeokit-i18n="objectsExplorer.showAll" data-xeokit-i18ntip="objectsExplorer.showAllTip" data-tippy-content="Show all objects">Show all</button>
            <button type="button" class="xeokit-i18n xeokit-hideAllObjects xeokit-btn disabled" data-xeokit-i18n="objectsExplorer.hideAll" data-xeokit-i18ntip="objectsExplorer.hideAllTip" data-tippy-content="Hide all objects">Hide all</button>
        </div>
        <div class="xeokit-objects xeokit-tree-panel" ></div>
        </div>
    </div>
    <div class="xeokit-i18n xeokit-tab xeokit-classesTab">
        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="classesExplorer.title">Classes</a>
        <div class="xeokit-tab-content">
            <div class="xeokit-btn-group">
                <button type="button" class="xeokit-i18n xeokit-showAllClasses xeokit-btn disabled" data-xeokit-i18n="classesExplorer.showAll"  data-xeokit-i18ntip="classesExplorer.hideAllTip" data-tippy-content="Show all classes">Show all</button>
                <button type="button" class="xeokit-i18n xeokit-hideAllClasses xeokit-btn disabled" data-xeokit-i18n="classesExplorer.hideAll" data-xeokit-i18ntip="classesExplorer.hideAllTip" data-tippy-content="Hide all classes">Hide all</button>
            </div>
            <div class="xeokit-classes xeokit-tree-panel" ></div>
        </div>
    </div>
     <div class="xeokit-tab xeokit-storeysTab">
        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="storeysExplorer.title">Storeys</a>
        <div class="xeokit-tab-content">
         <div class="xeokit-btn-group">
                <button type="button" class="xeokit-i18n xeokit-showAllStoreys xeokit-btn disabled" data-xeokit-i18n="storeysExplorer.showAll" data-xeokit-i18ntip="storeysExplorer.showAllTip" data-tippy-content="Show all storeys">Show all</button>
                <button type="button" class="xeokit-i18n xeokit-hideAllStoreys xeokit-btn disabled" data-xeokit-i18n="storeysExplorer.hideAll" data-xeokit-i18ntip="storeysExplorer.hideAllTip" data-tippy-content="Hide all storeys">Hide all</button>
            </div>
             <div class="xeokit-storeys xeokit-tree-panel"></div>
        </div>
    </div>
</div>`;
    return explorerTemplate;
}

function createToolbarTemplate() {
    const toolbarTemplate = `<div class="xeokit-toolbar">
    <!-- Reset button -->
    <div class="xeokit-btn-group">
        <button type="button" class="xeokit-i18n xeokit-reset xeokit-btn fa fa-home fa-2x disabled" data-xeokit-i18ntip="toolbar.resetViewTip" data-tippy-content="Reset view"></button>
    </div>
    <div class="xeokit-btn-group" role="group">
        <!-- 3D Mode button -->
        <button type="button" class="xeokit-i18n xeokit-threeD xeokit-btn fa fa-cube fa-2x disabled" data-xeokit-i18ntip="toolbar.toggle2d3dTip" data-tippy-content="Toggle 2D/3D"></button>
        <!-- Perspective/Ortho Mode button -->
        <button type="button" class="xeokit-i18n xeokit-ortho xeokit-btn fa fa-th fa-2x  disabled" data-xeokit-i18ntip="toolbar.togglePerspectiveTip" data-tippy-content="Toggle Perspective/Ortho"></button>
        <!-- Fit button -->
        <button type="button" class="xeokit-i18n xeokit-fit xeokit-btn fa fa-crop fa-2x disabled" data-xeokit-i18ntip="toolbar.viewFitTip" data-tippy-content="View fit"></button>
        <!-- First Person mode button -->
        <button type="button" class="xeokit-i18n xeokit-firstPerson xeokit-btn fa fa-male fa-2x disabled" data-xeokit-i18ntip="toolbar.firstPersonTip" data-tippy-content="Toggle first-person mode"></button>
          <!-- Show/hide IFCSpaces -->
        <button type="button" class="xeokit-i18n xeokit-showSpaces xeokit-btn fab fa-codepen fa-2x disabled" data-xeokit-i18ntip="toolbar.showSpacesTip" data-tippy-content="Show IFCSpaces"></button>   
    </div>
    <!-- Tools button group -->
    <div class="xeokit-btn-group" role="group">
        <!-- Hide tool button -->
        <button type="button" class="xeokit-i18n xeokit-hide xeokit-btn fa fa-eraser fa-2x disabled" data-xeokit-i18ntip="toolbar.hideObjectsTip" data-tippy-content="Hide objects"></button>
        <!-- Select tool button -->
        <button type="button" class="xeokit-i18n xeokit-select xeokit-btn fa fa-mouse-pointer fa-2x disabled" data-xeokit-i18ntip="toolbar.selectObjectsTip" data-tippy-content="Select objects"></button>    
        <!-- section tool button -->
        <button type="button" class="xeokit-i18n xeokit-section xeokit-btn fa fa-cut fa-2x disabled" data-xeokit-i18ntip="toolbar.sliceObjectsTip" data-tippy-content="Slice objects">
            <div class="xeokit-i18n xeokit-section-menu-button disabled" data-xeokit-i18ntip="toolbar.slicesMenuTip"  data-tippy-content="Slices menu">
                <span class="xeokit-arrow-down xeokit-section-menu-button-arrow"></span>
            </div>
            <div class="xeokit-i18n xeokit-section-counter" data-xeokit-i18ntip="toolbar.numSlicesTip" data-tippy-content="Number of existing slices"></div>
        </button>
    </div>
</div>`;
    return toolbarTemplate;
}

function createInspectorTemplate() {
    const inspectorTemplate = `<div class="xeokit-tabs">  
    <div class="xeokit-tab xeokit-propertiesTab">
        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="propertiesInspector.title">Properties</a>
        <div class="xeokit-tab-content">        
        <div class="xeokit-properties"></div>
        </div>
    </div>
</div>`;
    return inspectorTemplate;
}

function initTabs(containerElement) {

    const tabsClass = 'xeokit-tabs';
    const tabClass = 'xeokit-tab';
    const tabButtonClass = 'xeokit-tab-btn';
    const activeClass = 'active';

    // Activates the chosen tab and deactivates the rest
    function activateTab(chosenTabElement) {
        let tabList = chosenTabElement.parentNode.querySelectorAll('.' + tabClass);
        for (let i = 0; i < tabList.length; i++) {
            let tabElement = tabList[i];
            if (tabElement.isEqualNode(chosenTabElement)) {
                tabElement.classList.add(activeClass);
            } else {
                tabElement.classList.remove(activeClass);
            }
        }
    }

    // Initialize each tabbed container
    let tabbedContainers = containerElement.querySelectorAll('.' + tabsClass);
    for (let i = 0; i < tabbedContainers.length; i++) {
        let tabbedContainer = tabbedContainers[i];
        let tabList = tabbedContainer.querySelectorAll('.' + tabClass);
        activateTab(tabList[0]);
        for (let i = 0; i < tabList.length; i++) {
            let tabElement = tabList[i];
            let tabButton = tabElement.querySelector('.' + tabButtonClass);
            tabButton.addEventListener('click', function (event) {
                event.preventDefault();
                if (this.classList.contains("disabled")) {
                    return;
                }
                activateTab(event.target.parentNode);
            });
        }
    }
}


/**
 * @desc A BIM viewer based on the [xeokit SDK](http://xeokit.io).
 *
 *
 */
class BIMViewer extends Controller {

    /**
     * Constructs a BIMViewer.
     * @param {Server} server Data access strategy.
     * @param {*} cfg Configuration.
     * @param {Boolean} [cfg.enableEditModels=false] Set ````true```` to show "Add", "Edit" and "Delete" options in the Models tab's context menu.
     * @param {Boolean} [cfg.keyboardEventsElement] Optional reference to HTML element on which key events should be handled. Defaults to the HTML Document.
     */
    constructor(server, cfg = {}) {

        if (!cfg.canvasElement) {
            throw "Config expected: canvasElement";
        }

        if (!cfg.explorerElement) {
            throw "Config expected: explorerElement";
        }

        if (!cfg.toolbarElement) {
            throw "Config expected: toolbarElement";
        }

        if (!cfg.navCubeCanvasElement) {
            throw "Config expected: navCubeCanvasElement";
        }

        const canvasElement = cfg.canvasElement;
        const explorerElement = cfg.explorerElement;
        const inspectorElement = cfg.inspectorElement;
        const toolbarElement = cfg.toolbarElement;
        const navCubeCanvasElement = cfg.navCubeCanvasElement;
        const busyModelBackdropElement = cfg.busyModelBackdropElement;

        explorerElement.oncontextmenu = (e) => {
            e.preventDefault();
        };

        toolbarElement.oncontextmenu = (e) => {
            e.preventDefault();
        };

        navCubeCanvasElement.oncontextmenu = (e) => {
            e.preventDefault();
        };

        const viewer = new fR({
            localeService: cfg.localeService,
            canvasElement: canvasElement,
            keyboardEventsElement: cfg.keyboardEventsElement,
            transparent: false,
            backgroundColor: [0.96078431372549, 0.992156862745098, 1],
            backgroundColorFromAmbientLight: false,
            saoEnabled: true,
            pbrEnabled: true
        });

        super(null, cfg, server, viewer);

        this._configs = {};

        this._enableAddModels = !!cfg.enableEditModels;
        this._enablePropertiesInspector = !!cfg.inspectorElement;

        /**
         * The xeokit [Viewer](https://xeokit.github.io/xeokit-sdk/docs/class/src/viewer/Viewer.js~Viewer.html) at the core of this BIMViewer.
         *
         * @type {Viewer}
         */
        this.viewer = viewer;

        this._customizeViewer();
        this._initCanvasContextMenus();

        explorerElement.innerHTML = createExplorerTemplate(cfg);
        toolbarElement.innerHTML = createToolbarTemplate();
        if (this._enablePropertiesInspector) {
            inspectorElement.innerHTML = createInspectorTemplate();
        }

        this._explorerElement = explorerElement;
        this._inspectorElement = inspectorElement;

        initTabs(explorerElement);
        if (this._enablePropertiesInspector) {
            initTabs(inspectorElement);
        }

        this._modelsExplorer = new ModelsExplorer(this, {
            modelsTabElement: explorerElement.querySelector(".xeokit-modelsTab"),
            loadModelsButtonElement: explorerElement.querySelector(".xeokit-loadAllModels"), // Can be undefined
            unloadModelsButtonElement: explorerElement.querySelector(".xeokit-unloadAllModels"),
            addModelButtonElement: explorerElement.querySelector(".xeokit-addModel"), // Can be undefined
            modelsElement: explorerElement.querySelector(".xeokit-models"),
            enableEditModels: this._enableAddModels
        });

        this._objectsExplorer = new ObjectsExplorer(this, {
            objectsTabElement: explorerElement.querySelector(".xeokit-objectsTab"),
            showAllObjectsButtonElement: explorerElement.querySelector(".xeokit-showAllObjects"),
            hideAllObjectsButtonElement: explorerElement.querySelector(".xeokit-hideAllObjects"),
            objectsElement: explorerElement.querySelector(".xeokit-objects")
        });

        this._classesExplorer = new ClassesExplorer(this, {
            classesTabElement: explorerElement.querySelector(".xeokit-classesTab"),
            showAllClassesButtonElement: explorerElement.querySelector(".xeokit-showAllClasses"),
            hideAllClassesButtonElement: explorerElement.querySelector(".xeokit-hideAllClasses"),
            classesElement: explorerElement.querySelector(".xeokit-classes")
        });

        this._storeysExplorer = new StoreysExplorer(this, {
            storeysTabElement: explorerElement.querySelector(".xeokit-storeysTab"),
            showAllStoreysButtonElement: explorerElement.querySelector(".xeokit-showAllStoreys"),
            hideAllStoreysButtonElement: explorerElement.querySelector(".xeokit-hideAllStoreys"),
            storeysElement: explorerElement.querySelector(".xeokit-storeys")
        });

        if (this._enablePropertiesInspector) {
            this._propertiesInspector = new PropertiesInspector(this, {
                propertiesTabElement: inspectorElement.querySelector(".xeokit-propertiesTab"),
                propertiesElement: inspectorElement.querySelector(".xeokit-properties")
            });
        }

        this._resetAction = new ResetAction(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-reset"),
            active: false
        });

        this._fitAction = new FitAction(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-fit"),
            active: false
        });

        // Allows Three-D and First Person toggle buttons to cooperatively switch
        // CameraControl#navMode between "orbit", "firstPerson" and "planView" modes

        const cameraControlNavModeMediator = new (function (bimViewer) {

            let threeDActive = false;

            this.setThreeDModeActive = (active) => {
                if (active) {
                    bimViewer._firstPersonMode.setActive(false);
                    bimViewer.viewer.cameraControl.navMode = "orbit";
                } else {
                    bimViewer._firstPersonMode.setActive(false);
                    bimViewer.viewer.cameraControl.navMode = "planView";
                }
                threeDActive = active;
            };

            this.setFirstPersonModeActive = (active) => {
                bimViewer.viewer.cameraControl.navMode = active ? "firstPerson" : (threeDActive ? "orbit" : "planView");
            };
        })(this);

        this._threeDMode = new ThreeDMode(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-threeD"),
            cameraControlNavModeMediator: cameraControlNavModeMediator,
            active: false
        });

        this._orthoMode = new OrthoMode(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-ortho"),
            active: false
        });

        this._firstPersonMode = new FirstPersonMode(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-firstPerson"),
            cameraControlNavModeMediator: cameraControlNavModeMediator,
            active: false
        });

        this._hideTool = new HideTool(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-hide"),
            active: false
        });

        this._selectionTool = new SelectionTool(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-select"),
            active: false
        });

        this._showSpacesMode = new ShowSpacesMode(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-showSpaces"),
            active: false
        });

        this._queryTool = new QueryTool(this, {
            active: false
        });

        this._sectionTool = new SectionTool(this, {
            buttonElement: toolbarElement.querySelector(".xeokit-section"),
            counterElement: toolbarElement.querySelector(".xeokit-section-counter"),
            menuButtonElement: toolbarElement.querySelector(".xeokit-section-menu-button"),
            menuButtonArrowElement: toolbarElement.querySelector(".xeokit-section-menu-button-arrow"),
            active: false
        });

        this._navCubeMode = new NavCubeMode(this, {
            navCubeCanvasElement: navCubeCanvasElement,
            active: true
        });

        this._busyModal = new BusyModal(this, {
            busyModalBackdropElement: busyModelBackdropElement
        });

        this._threeDMode.setActive(true);
        this._firstPersonMode.setActive(false);
        this._navCubeMode.setActive(true);

        this._modelsExplorer.on("modelLoaded", (modelId) => {
            if (this._modelsExplorer.getNumModelsLoaded() > 0) {
                this.setControlsEnabled(true);
            }
            this.fire("modelLoaded", modelId);
        });

        this._modelsExplorer.on("modelUnloaded", (modelId) => {
            if (this._modelsExplorer.getNumModelsLoaded() === 0) {
                this.setControlsEnabled(false);
                this.openTab("models");
            }
            this.fire("modelUnloaded", modelId);
        });

        this._resetAction.on("reset", () => {
            this.fire("reset", true);
        });

        this._mutexActivation([this._hideTool, this._selectionTool, this._sectionTool]);

        explorerElement.querySelector(".xeokit-showAllObjects").addEventListener("click", (event) => {
            this.setAllObjectsVisible(true);
            this.setAllObjectsXRayed(false);
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-hideAllObjects").addEventListener("click", (event) => {
            this.setAllObjectsVisible(false);
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-showAllClasses").addEventListener("click", (event) => {
            this.setAllObjectsVisible(true);
            this.setAllObjectsXRayed(false);
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-hideAllClasses").addEventListener("click", (event) => {
            this.setAllObjectsVisible(false);
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-showAllStoreys").addEventListener("click", (event) => {
            this.setAllObjectsVisible(true);
            this.setAllObjectsXRayed(false);
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-hideAllStoreys").addEventListener("click", (event) => {
            this.setAllObjectsVisible(false);
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-loadAllModels").addEventListener("click", (event) => {
            this.setControlsEnabled(false); // For quick UI feedback
            this.loadAllModels();
            event.preventDefault();
        });

        explorerElement.querySelector(".xeokit-unloadAllModels").addEventListener("click", (event) => {
            this.setControlsEnabled(false); // For quick UI feedback
            this._modelsExplorer.unloadAllModels();
            event.preventDefault();
        });

        if (this._enableAddModels) {
            explorerElement.querySelector(".xeokit-addModel").addEventListener("click", (event) => {
                this.fire("addModel", {});
                event.preventDefault();
            });
        }

        this._bcfViewpointsPlugin = new sr(this.viewer, {});

        this._fastNavPlugin = new pr(viewer, {
            hideEdges: true,
            hideSAO: true,
            hidePBR: false,
            hideTransparentObjects: false,
            scaleCanvasResolution: false,
            scaleCanvasResolutionFactor: 0.6
        });

        this.viewer.scene.on("rendered", () => {
            const fastNavPlugin = this._fastNavPlugin;
            fastNavPlugin.hideEdges = (hideEdgesMinDrawCount < (g.frame.drawElements + g.frame.drawArrays));
            fastNavPlugin.scaleCanvasResolution = (scaleCanvasResolutionMinDrawCount < (g.frame.drawElements + g.frame.drawArrays));
        });

        this._initConfigs();
        this.setControlsEnabled(false);
    }

    /**
     * Returns the LocaleService that was configured on this Viewer.
     *
     * @return {LocaleService} The LocaleService.
     */
    get localeService() {
        return this.viewer.localeService;
    }

    _customizeViewer() {

        const scene = this.viewer.scene;

        // Emphasis effects

        scene.xrayMaterial.fill = false;
        scene.xrayMaterial.fillAlpha = 0.3;
        scene.xrayMaterial.fillColor = [0, 0, 0];
        scene.xrayMaterial.edges = true;
        scene.xrayMaterial.edgeAlpha = 0.1;
        scene.xrayMaterial.edgeColor = [0, 0, 0];

        scene.highlightMaterial.edges = true;
        scene.highlightMaterial.edgeColor = [1, 1, 0];
        scene.highlightMaterial.edgeAlpha = 0.9;
        scene.highlightMaterial.fill = true;
        scene.highlightMaterial.fillAlpha = 0.1;
        scene.highlightMaterial.fillColor = [1, 0, 0];

        //------------------------------------------------------------------------------------------------------------------
        // Configure points material
        //------------------------------------------------------------------------------------------------------------------

        scene.pointsMaterial.pointSize = 1;
        scene.pointsMaterial.roundPoints = true;
        scene.pointsMaterial.perspectivePoints = true;
        scene.pointsMaterial.minPerspectivePointSize = 2;
        scene.pointsMaterial.maxPerspectivePointSize = 4;

        // Camera control

        this.viewer.cameraControl.panRightClick = true;
        this.viewer.cameraControl.followPointer = true;
        this.viewer.cameraControl.doublePickFlyTo = false;
        this.viewer.cameraControl.smartPivot = true;

        // Dolly tweaks for best precision when aligning camera for BCF snapshots

        this.viewer.cameraControl.keyboardDollyRate = 100.0;
        this.viewer.cameraControl.mouseWheelDollyRate = 100.0;
        this.viewer.cameraControl.dollyInertia = 0;
        this.viewer.cameraControl.dollyMinSpeed = 0.04;
        this.viewer.cameraControl.dollyProximityThreshold = 30.0;

        const cameraPivotElement = document.createRange().createContextualFragment("<div class='xeokit-camera-pivot-marker'></div>").firstChild;
        document.body.appendChild(cameraPivotElement);
        this.viewer.cameraControl.pivotElement = cameraPivotElement;

        scene.camera.perspective.near = 0.01;
        scene.camera.perspective.far = 3000.0;
        scene.camera.ortho.near = 0.01;
        scene.camera.ortho.far = 2000.0; //

        // Scalable Ambient Obscurance (SAO) defaults
        // Since SAO is non-interactive, set to higher-quality

        const sao = scene.sao;
        sao.enabled = true;
        sao.numSamples = 50;
        sao.kernelRadius = 200;
    }

    _initCanvasContextMenus() {

        this._canvasContextMenu = new CanvasContextMenu(this);
        this._objectContextMenu = new ObjectContextMenu(this);

        this.viewer.cameraControl.on("rightClick", (e) => {

            const event = e.event;

            const hit = this.viewer.scene.pick({
                canvasPos: e.canvasPos
            });

            if (hit && hit.entity.isObject) {
                this._canvasContextMenu.hide();
                this._objectContextMenu.context = {
                    viewer: this.viewer,
                    bimViewer: this,
                    showObjectInExplorers: (objectId) => {
                        const openTabId = this.getOpenTab();
                        if (openTabId !== "objects" && openTabId !== "classes" && openTabId !== "storeys") {
                            // Scroll won't work if tab not open
                            this.openTab("objects");
                        }
                        this.showObjectInExplorers(objectId);
                    },
                    entity: hit.entity
                };
                this._objectContextMenu.show(e.pagePos[0], e.pagePos[1]);
            } else {
                this._objectContextMenu.hide();
                this._canvasContextMenu.context = {
                    viewer: this.viewer,
                    bimViewer: this
                };
                this._canvasContextMenu.show(e.pagePos[0], e.pagePos[1]);
            }
        });
    }

    _initConfigs() {
        this.setConfigs({
            "cameraNear": "0.05",
            "cameraFar": "3000.0",
            "smartPivot": "true",
            "saoEnabled": "true",
            "pbrEnabled": "false",
            "saoBias": "0.5",
            "saoIntensity": "0.15",
            "saoNumSamples": "40",
            "saoKernelRadius": "100",
            "edgesEnabled": true,
            "xrayContext": true,
            "xrayPickable": false,
            "selectedGlowThrough": true,
            "highlightGlowThrough": true,
            "backgroundColor": [1.0, 1.0, 1.0],
            "objectColorSource": "model",
            "externalMetadata": false
        });
    }

    /**
     * Sets a batch of viewer configurations.
     *
     * Note that this method is not to be confused with {@link BIMViewer#setViewerState}, which batch-updates various states of the viewer's UI and 3D view.
     *
     * See [Viewer Configurations](https://xeokit.github.io/xeokit-bim-viewer/docs/#viewer-configurations) for the list of available configurations.
     *
     * @param {*} viewerConfigs Map of key-value configuration pairs.
     */
    setConfigs(viewerConfigs) {
        for (let name in viewerConfigs) {
            if (viewerConfigs.hasOwnProperty(name)) {
                const value = viewerConfigs[name];
                this.setConfig(name, value);
            }
        }
    }

    /**
     * Sets a viewer configuration.
     *
     * See [Viewer Configurations](https://xeokit.github.io/xeokit-bim-viewer/docs/#viewer-configurations) for the list of available configurations.
     *
     * @param {String} name Configuration name.
     * @param {*} value Configuration value.
     */
    setConfig(name, value) {

        function parseBool(value) {
            return ((value === true) || (value === "true"));
        }

        try {
            switch (name) {

                case "backgroundColor":
                    const rgbColor = value;
                    this.setBackgroundColor(rgbColor);
                    this._configs[name] = rgbColor;
                    break;

                case "cameraNear":
                    const near = parseFloat(value);
                    this.viewer.scene.camera.perspective.near = near;
                    this.viewer.scene.camera.ortho.near = near;
                    this._configs[name] = near;
                    break;

                case "cameraFar":
                    const far = parseFloat(value);
                    this.viewer.scene.camera.perspective.far = far;
                    // this.viewer.scene.camera.ortho.far = far;
                    this._configs[name] = far;
                    break;

                case "smartPivot":
                    this.viewer.cameraControl.smartPivot = this._configs[name] = parseBool(value);
                    break;

                case "saoEnabled":
                    this._fastNavPlugin.saoEnabled = this._configs[name] = parseBool(value);
                    break;

                case "saoBias":
                    this.viewer.scene.sao.bias = parseFloat(value);
                    break;

                case "saoIntensity":
                    this.viewer.scene.sao.intensity = parseFloat(value);
                    break;

                case "saoKernelRadius":
                    this.viewer.scene.sao.kernelRadius = this._configs[name] = parseFloat(value);
                    break;

                case "saoNumSamples":
                    this.viewer.scene.sao.numSamples = this._configs[name] = parseFloat(value);
                    break;

                case "saoBlur":
                    this.viewer.scene.sao.blur = this._configs[name] = parseBool(value);
                    break;

                case "edgesEnabled":
                    this._fastNavPlugin.edgesEnabled = this._configs[name] = parseBool(value);
                    break;

                case "pbrEnabled":
                    this._fastNavPlugin.pbrEnabled = this._configs[name] = parseBool(value);
                    break;

                case "viewFitFOV":
                    this.viewer.cameraFlight.fitFOV = this._configs[name] = parseFloat(value);
                    break;

                case "viewFitDuration":
                    this.viewer.cameraFlight.duration = this._configs[name] = parseFloat(value);
                    break;

                case "perspectiveFOV":
                    this.viewer.camera.perspective.fov = this._configs[name] = parseFloat(value);
                    break;

                case "excludeUnclassifiedObjects":
                    this._configs[name] = parseBool(value);
                    break;

                case "objectColorSource":
                    this.setObjectColorSource(value);
                    this._configs[name] = value;
                    break;

                case "xrayContext":
                    this._configs[name] = value;
                    break;

                case "xrayPickable":
                    this._configs[name] = parseBool(value);
                    break;

                case "selectedGlowThrough":
                    const selectedGlowThrough = this._configs[name] = parseBool(value);
                    const selectedMaterial = this.viewer.scene.selectedMaterial;
                    selectedMaterial.glowThrough = selectedGlowThrough;
                    selectedMaterial.fillAlpha = selectedGlowThrough ? 0.5 : 1.0;
                    selectedMaterial.edgeAlpha = selectedGlowThrough ? 0.5 : 1.0;
                    break;

                case "highlightGlowThrough":
                    const highlightGlowThrough = this._configs[name] = parseBool(value);
                    const highlightMaterial = this.viewer.scene.highlightMaterial;
                    highlightMaterial.glowThrough = highlightGlowThrough;
                    highlightMaterial.fillAlpha = highlightGlowThrough ? 0.5 : 1.0;
                    highlightMaterial.edgeAlpha = highlightGlowThrough ? 0.5 : 1.0;
                    break;

                case "externalMetadata":
                    this._configs[name] = parseBool(value);
                    break;

                case "showSpaces":
                    this._configs[name] = parseBool(value);
                    this._showSpacesMode.setActive(value);
                    break;

                default:
                    this.error("setConfig() - unsupported configuration: '" + name + "'");
            }

        } catch (e) {
            this.error("setConfig() - failed to configure '" + name + "': " + e);
        }
    }

    /**
     * Gets the value of a viewer configuration.
     *
     * These are set with {@link BIMViewer#setConfig} and {@link BIMViewer#setConfigs}.
     *
     * @param {String} name Configuration name.
     * @ereturns {*} Configuration value.
     */
    getConfig(name) {
        return this._configs[name];
    }

    //------------------------------------------------------------------------------------------------------------------
    // Content querying methods
    //------------------------------------------------------------------------------------------------------------------

    /**
     * Gets information on all available projects.
     * Gets information on all available projects.
     *
     * See [Getting Info on Available Projects](https://xeokit.github.io/xeokit-bim-viewer/docs/#getting-info-on-available-projects) for usage.
     *
     * @param {Function} done Callback invoked on success, into which the projects information JSON is passed.
     * @param {Function} error Callback invoked on failure, into which the error message string is passed.
     */
    getProjectsInfo(done, error) {
        if (!done) {
            this.error("getProjectsInfo() - Argument expected: 'done'");
            return;
        }
        this.server.getProjects(done, (errorMsg) => {
            this.error("getProjectsInfo() - " + errorMsg);
            if (error) {
                error(errorMsg);
            }
        });
    }

    /**
     * Gets information on the given project.
     *
     * See [Getting Info on a Project](https://xeokit.github.io/xeokit-bim-viewer/docs/#getting-info-on-a-project) for usage.
     *
     * @param {String} projectId ID of the project to get information on. Must be the ID of one of the projects in the information obtained by {@link BIMViewer#getProjects}.
     * @param {Function} done Callback invoked on success, into which the project information JSON is passed.
     * @param {Function} error Callback invoked on failure, into which the error message string is passed.
     */
    getProjectInfo(projectId, done, error) {
        if (!projectId) {
            this.error("getProjectInfo() - Argument expected: projectId");
            return;
        }
        if (!done) {
            this.error("getProjectInfo() - Argument expected: 'done'");
            return;
        }
        this.server.getProject(projectId,
            done, (errorMsg) => {
                this.error("getProjectInfo() - " + errorMsg);
                if (error) {
                    error(errorMsg);
                }
            });
    }

    /**
     * Gets information on the given object, belonging to the given model, within the given project.
     *
     * See [Getting Info on an Object](https://xeokit.github.io/xeokit-bim-viewer/docs/#getting-info-on-an-object) for usage.
     *
     * @param {String} projectId ID of the project to get information on. Must be the ID of one of the projects in the information obtained by {@link BIMViewer#getProjects}.
     * @param {String} modelId ID of a model within the project. Must be the ID of one of the models in the information obtained by {@link BIMViewer#getProjectInfo}.
     * @param {String} objectId ID of an object in the model.
     * @param {Function} done Callback invoked on success, into which the object information JSON is passed.
     * @param {Function} error Callback invoked on failure, into which the error message string is passed.
     */
    getObjectInfo(projectId, modelId, objectId, done, error) {
        if (!projectId) {
            this.error("getObjectInfo() - Argument expected: projectId");
            return;
        }
        if (!modelId) {
            this.error("getObjectInfo() - Argument expected: modelId");
            return;
        }
        if (!objectId) {
            this.error("getObjectInfo() - Argument expected: objectId");
            return;
        }
        if (!done) {
            this.error("getProjectInfo() - Argument expected: 'done'");
            return;
        }
        this.server.getObjectInfo(projectId, modelId, objectId,
            done,
            (errorMsg) => {
                if (error) {
                    error(errorMsg);
                }
            });
    }

    //------------------------------------------------------------------------------------------------------------------
    // Content loading methods
    //------------------------------------------------------------------------------------------------------------------

    /**
     * Loads a project into the viewer.
     *
     * Unloads any currently loaded project and its models first. If the given project is already loaded, will unload that project first.
     *
     * @param {String} projectId ID of the project to load. Must be the ID of one of the projects in the information obtained by {@link BIMViewer#getProjects}.
     * @param {Function} done Callback invoked on success.
     * @param {Function} error Callback invoked on failure, into which the error message string is passed.
     */
    loadProject(projectId, done, error) {
        if (!projectId) {
            this.error("loadProject() - Argument expected: objectId");
            return;
        }
        this._modelsExplorer.loadProject(projectId,
            () => {
                if (done) {
                    done();
                }
            }, (errorMsg) => {
                this.error("loadProject() - " + errorMsg);
                if (error) {
                    error(errorMsg);
                }
            });
    }

    /**
     * Unloads whatever project is currently loaded.
     */
    unloadProject() {
        this._modelsExplorer.unloadProject();
        this.openTab("models");
        this.setControlsEnabled(false); // For quick UI feedback
    }

    /**
     * Returns the ID of the currently loaded project, if any.
     *
     * @returns {String} The ID of the currently loaded project, otherwise ````null```` if no project is currently loaded.
     */
    getLoadedProjectId() {
        return this._modelsExplorer.getLoadedProjectId();
    }

    /**
     * Returns the IDs of the models in the currently loaded project.
     *
     * @returns {String[]} The IDs of the models in the currently loaded project.
     */
    getModelIds() {
        return this._modelsExplorer.getModelIds();
    }

    /**
     * Loads a model into the viewer.
     *
     * Assumes that the project containing the model is currently loaded.
     *
     * @param {String} modelId ID of the model to load. Must be the ID of one of the models in the currently loaded project.
     * @param {Function} done Callback invoked on success.
     * @param {Function} error Callback invoked on failure, into which the error message string is passed.
     */
    loadModel(modelId, done, error) {
        if (!modelId) {
            this.error("loadModel() - Argument expected: modelId");
            return;
        }
        this._modelsExplorer.loadModel(modelId,
            () => {
                if (done) {
                    done();
                }
            }, (errorMsg) => {
                this.error("loadModel() - " + errorMsg);
                if (error) {
                    error(errorMsg);
                }
            });
    }

    /**
     * Load all models in the currently loaded project.
     *
     * Doesn't reload any models that are currently loaded.
     *
     * @param {Function} done Callback invoked on successful loading of the models.
     */
    loadAllModels(done = function () {
    }) {
        const modelIds = this._modelsExplorer.getModelIds();
        const loadNextModel = (i, done2) => {
            if (i >= modelIds.length) {
                done2();
            } else {
                const modelId = modelIds[i];
                if (!this._modelsExplorer.isModelLoaded(modelId)) {
                    this._modelsExplorer.loadModel(modelId, () => {
                        loadNextModel(i + 1, done2);
                    }, (errorMsg) => {
                        this.error("loadAllModels() - " + errorMsg);
                        loadNextModel(i + 1, done2);
                    });
                } else {
                    loadNextModel(i + 1, done2);
                }
            }
        };
        loadNextModel(0, done);
    }

    /**
     * Returns the IDs of the currently loaded models, if any.
     *
     * @returns {String[]} The IDs of the currently loaded models, otherwise an empty array if no models are currently loaded.
     */
    getLoadedModelIds() {
        return this._modelsExplorer._getLoadedModelIds();
    }

    /**
     * Gets if the given model is loaded.
     *
     * @param {String} modelId ID of the model to check. Must be the ID of one of the models in the currently loaded project.
     * @returns {Boolean} True if the given model is loaded.
     */
    isModelLoaded(modelId) {
        if (!modelId) {
            this.error("unloadModel() - Argument expected: modelId");
            return;
        }
        return this._modelsExplorer.isModelLoaded(modelId);
    }

    /**
     * Unloads a model from the viewer.
     *
     * Does nothing if the model is not currently loaded.
     *
     * @param {String} modelId ID of the model to unload.
     */
    unloadModel(modelId) {
        if (!modelId) {
            this.error("unloadModel() - Argument expected: modelId");
            return;
        }
        this._modelsExplorer.unloadModel(modelId);
    }

    /**
     * Unloads all currently loaded models.
     */
    unloadAllModels() {
        this._modelsExplorer.unloadAllModels();
    }

    /**
     * Edits a model.
     *
     * Assumes that the project containing the model is currently loaded.
     *
     * @param {String} modelId ID of the model to edit. Must be the ID of one of the models in the currently loaded project.
     */
    editModel(modelId) {
        this.fire("editModel", {
            modelId: modelId
        });
    }

    /**
     * Deletes a model.
     *
     * Assumes that the project containing the model is currently loaded.
     *
     * @param {String} modelId ID of the model to delete. Must be the ID of one of the models in the currently loaded project.
     */
    deleteModel(modelId) {
        this.fire("deleteModel", {
            modelId: modelId
        });
    }

    /**
     * Adds a model.
     *
     */
    addModel() {
        this.fire("addModel", {});
    }

    /**
     * Sets the viewer's background color.
     *
     * @param {Number[]} rgbColor Three-element array of RGB values, each in range ````[0..1]````.
     */
    setBackgroundColor(rgbColor) {
        this.viewer.scene.canvas.backgroundColor = rgbColor;
    }

    /**
     * Sets where the colors for model objects will be loaded from.
     *
     * Options are:
     *
     * * "model" - (default) load colors from models, and
     * * "viewer" - load colors from the viewer's inbuilt table of colors for IFC types.
     *
     * This is "model" by default.
     *
     * @param {String} source Where colors will be loaded from - "model" or "viewer".
     */
    setObjectColorSource(source) {
        switch (source) {
            case "model":
                break;
            case "viewer":
                break;
            default:
                source = "model";
                this.error("setObjectColorSource() - Unsupported value - accepted values are 'model' and 'viewer' - defaulting to 'model'");
                return;
        }
        this._objectColorSource = source;
    }

    /**
     * Gets where the colors for model objects will be loaded from.
     *
     * This is "model" by default.
     *
     * @return {String} Where colors will be loaded from - "model" to get colors from the model, or "viewer" to get them from the viewer's built-in table of colors for IFC types.
     */
    getObjectColorSource() {
        return this._objectColorSource || "model";
    }

    /**
     * Updates viewer UI state according to the properties in the given object.
     *
     * Note that, since some updates could be animated (e.g. flying the camera to fit objects to view) this
     * method optionally takes a callback, which it invokes after updating the UI.
     *
     * Also, this method is not to be confused with {@link BIMViewer#setConfigs}, which is used to batch-update various configurations and user preferences on the viewer.
     *
     * See [Viewer States](https://xeokit.github.io/xeokit-bim-viewer/docs/#viewer_states) for the list of states that may be batch-updated with this method.
     *
     * @param {Object} viewerState Specifies the viewer UI state updates.
     * @param {Function} done Callback invoked on successful update of the viewer states.
     */
    setViewerState(viewerState, done = () => {
    }) {
        if (viewerState.tabOpen) {
            this.openTab(viewerState.tabOpen);
        }
        if (viewerState.expandObjectsTree) {
            this._objectsExplorer.expandTreeViewToDepth(viewerState.expandObjectsTree);
        }
        if (viewerState.expandClassesTree) {
            this._classesExplorer.expandTreeViewToDepth(viewerState.expandClassesTree);
        }
        if (viewerState.expandStoreysTree) {
            this._storeysExplorer.expandTreeViewToDepth(viewerState.expandStoreysTree);
        }
        if (viewerState.setCamera) {
            this.setCamera(viewerState.setCamera);
        }
        this._parseSelectedStorey(viewerState, () => {
            this._parseThreeDMode(viewerState, () => {
                done();
            });
        });
    }

    _parseSelectedStorey(viewerState, done) {
        if (viewerState.selectedStorey) {
            this.selectStorey(viewerState.selectedStorey);
            done();
        } else {
            done();
        }
    }

    _parseThreeDMode(viewerState, done) {
        const activateThreeDMode = (viewerState.threeDActive !== false);
        this.set3DEnabled(activateThreeDMode, done);
    }

    /**
     * Highlights the given object in the tree views within the Objects, Classes and Storeys tabs.
     *
     * Also scrolls the object's node into view within each tree, then highlights it.
     *
     * De-highlights whatever node is currently highlighted in each of those trees.
     *
     * @param {String} objectId ID of the object
     */
    showObjectInExplorers(objectId) {
        if (!objectId) {
            this.error("showObjectInExplorers() - Argument expected: objectId");
            return;
        }
        this._objectsExplorer.showNodeInTreeView(objectId);
        this._classesExplorer.showNodeInTreeView(objectId);
        this._storeysExplorer.showNodeInTreeView(objectId);
        this.fire("openExplorer", {});
    }

    /**
     * De-highlights the object previously highlighted with {@link BIMViewer#showObjectInExplorers}.
     *
     * This only de-highlights the node. If the node is currently scrolled into view, then the node will remain in view.
     *
     * For each tab, does nothing if a node is currently highlighted.
     */
    unShowObjectInExplorers() {
        this._objectsExplorer.unShowNodeInTreeView();
        this._classesExplorer.unShowNodeInTreeView();
        this._storeysExplorer.unShowNodeInTreeView();
    }

    /**
     * Shows the properties of the given object in the Properties tab.
     *
     * @param {String} objectId ID of the object
     */
    showObjectProperties(objectId) {
        if (!objectId) {
            this.error("showObjectInExplorers() - Argument expected: objectId");
            return;
        }
        if (this._enablePropertiesInspector) {
            this._propertiesInspector.showObjectPropertySets(objectId);
        }
        this.fire("openInspector", {});
    }

    /**
     * Sets whether or not the given objects are visible.
     *
     * @param {String[]} objectIds IDs of objects.
     * @param {Boolean} visible True to set objects visible, false to set them invisible.
     */
    setObjectsVisible(objectIds, visible) {
        this._withObjectsInSubtree(objectIds, (entity) => {
            entity.visible = visible;
        });
    }

    /**
     * Sets the visibility of all objects.
     *
     * @param {Boolean} visible True to set objects visible, false to set them invisible.
     */
    setAllObjectsVisible(visible) {
        if (visible) {
            this.viewer.scene.setObjectsVisible(this.viewer.scene.objectIds, true);
        } else {
            this.viewer.scene.setObjectsVisible(this.viewer.scene.visibleObjectIds, false);
        }
    }

    /**
     * Sets whether or not the given objects are X-rayed.
     *
     * @param {String[]} objectIds IDs of objects.
     * @param {Boolean} xrayed Whether or not to X-ray the objects.
     */
    setObjectsXRayed(objectIds, xrayed) {
        this._withObjectsInSubtree(objectIds, (entity) => {
            entity.xrayed = xrayed;
        });
    }

    /**
     * Sets whether or not all objects are X-rayed.
     *
     * @param {Boolean} xrayed Whether or not to set all objects X-rayed.
     */
    setAllObjectsXRayed(xrayed) {
        if (xrayed) {
            this.viewer.scene.setObjectsXRayed(this.viewer.scene.objectIds, true);
        } else {
            this.viewer.scene.setObjectsXRayed(this.viewer.scene.xrayedObjectIds, false);
        }
    }

    /**
     * Sets whether or not the given objects are selected.
     *
     * @param {String[]} objectIds IDs of objects.
     * @param {Boolean} selected Whether or not to set the objects selected.
     */
    setObjectsSelected(objectIds, selected) {
        this._withObjectsInSubtree(objectIds, (entity) => {
            entity.selected = selected;
        });
    }

    /**
     * Sets whether or not all objects are selected.
     *
     * @param {Boolean} selected Whether or not to set all objects selected.
     */
    setAllObjectsSelected(selected) {
        if (selected) {
            this.viewer.scene.setObjectsSelected(this.viewer.scene.objectIds, true);
        } else {
            this.viewer.scene.setObjectsSelected(this.viewer.scene.selectedObjectIds, false);
        }
    }

    _withObjectsInSubtree(objectIds, callback) {
        if (!objectIds) {
            this.error("Argument expected: objectIds");
            return;
        }
        for (let i = 0, len = objectIds.length; i < len; i++) {
            const objectId = objectIds[i];
            this.viewer.metaScene.withMetaObjectsInSubtree(objectId, (metaObject) => {
                const entity = this.viewer.scene.objects[metaObject.id];
                if (entity) {
                    callback(entity);
                }
            });
        }
    }

    /**
     * Flies the camera to fit the given object in view.
     *
     * @param {String} objectId ID of the object
     * @param {Function} done Callback invoked on completion
     */
    flyToObject(objectId, done) {
        if (!objectId) {
            this.error("flyToObject() - Argument expected: objectId");
            return;
        }
        const viewer = this.viewer;
        const scene = viewer.scene;
        const objectIds = [];
        this.viewer.metaScene.withMetaObjectsInSubtree(objectId, (metaObject) => {
            if (scene.objects[metaObject.id]) {
                objectIds.push(metaObject.id);
            }
        });
        if (objectIds.length === 0) {
            this.error("Object not found in viewer: '" + objectId + "'");
            if (done) {
                done();
            }
            return;
        }
        scene.setObjectsVisible(objectIds, true);
        scene.setObjectsHighlighted(objectIds, true);
        const aabb = scene.getAABB(objectIds);
        viewer.cameraFlight.flyTo({
            aabb: aabb
        }, () => {
            if (done) {
                done();
            }
            setTimeout(function () {
                scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
            }, 500);
        });
        viewer.cameraControl.pivotPos = f.getAABB3Center(aabb);
    }

    /**
     * Flies the camera to fit the given objects in view.
     *
     * @param {String[]} objectIds IDs of the objects
     * @param {Function} done Callback invoked on completion
     */
    viewFitObjects(objectIds, done) {
        if (!objectIds) {
            this.error("flyToObject() - Argument expected: objectIds");
            return;
        }
        const viewer = this.viewer;
        const scene = viewer.scene;

        const entityIds = [];

        for (var i = 0, len = objectIds.length; i < len; i++) {
            const objectId = objectIds[i];
            this.viewer.metaScene.withMetaObjectsInSubtree(objectId, (metaObject) => {
                if (scene.objects[metaObject.id]) {
                    entityIds.push(metaObject.id);
                }
            });
        }
        if (entityIds.length === 0) {
            if (done) {
                done();
            }
            return;
        }
        scene.setObjectsVisible(entityIds, true);
        scene.setObjectsHighlighted(entityIds, true);
        const aabb = scene.getAABB(entityIds);
        viewer.cameraFlight.flyTo({
            aabb: aabb
        }, () => {
            if (done) {
                done();
            }
            setTimeout(function () {
                scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
            }, 500);
        });
        viewer.cameraControl.pivotPos = f.getAABB3Center(aabb);
    }

    /**
     * Flies the camera to fit all objects in view.
     *
     * @param {Function} done Callback invoked on completion
     */
    viewFitAll(done) {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const aabb = scene.getAABB();
        viewer.cameraFlight.flyTo({
            aabb: aabb
        }, () => {
            if (done) {
                done();
            }
        });
        viewer.cameraControl.pivotPos = f.getAABB3Center(aabb);
    }

    /**
     * Jumps the camera to fit the given object in view.
     *
     * @param {String} objectId ID of the object
     */
    jumpToObject(objectId) {
        if (!objectId) {
            this.error("jumpToObject() - Argument expected: objectId");
            return;
        }
        const viewer = this.viewer;
        const scene = viewer.scene;
        const objectIds = [];
        this.viewer.metaScene.withMetaObjectsInSubtree(objectId, (metaObject) => {
            if (scene.objects[metaObject.id]) {
                objectIds.push(metaObject.id);
            }
        });
        if (objectIds.length === 0) {
            this.error("Object not found in viewer: '" + objectId + "'");
            return;
        }
        scene.setObjectsVisible(objectIds, true);
        const aabb = scene.getAABB(objectIds);
        viewer.cameraFlight.jumpTo({
            aabb: aabb
        });
        viewer.cameraControl.pivotPos = f.getAABB3Center(aabb);
    }

    /**
     * Sets the camera to the given position.
     *
     * @param {Number[]} [params.eye] Eye position.
     * @param {Number[]} [params.look] Point of interest.
     * @param {Number[]} [params.up] Direction of "up".
     */
    setCamera(params) {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const camera = scene.camera;
        if (params.eye) {
            camera.eye = params.eye;
        }
        if (params.look) {
            camera.look = params.look;
        }
        if (params.up) {
            camera.up = params.up;
        }
    }

    /**
     * Fits the given models in view.
     *
     * @param {String[]} modelIds ID of the models.
     * @param {Function} [done] Callback invoked on completion. Will be animated if this is given, otherwise will be instantaneous.
     */
    viewFitModels(modelIds, done) {
        if (!modelIds) {
            this.error("viewFitModels() - Argument expected: modelIds");
            return;
        }
        const viewer = this.viewer;
        const scene = viewer.scene;
        const aabb = f.AABB3();
        f.collapseAABB3(aabb);
        for (var i = 0, len = modelIds.length; i < len; i++) {
            const modelId = modelIds[i];
            const model = scene.models[modelId];
            if (!model) {
                this.error("Model not found in viewer: '" + modelId + "'");
                continue;
            }
            model.visible = true;
            model.highlighted = true;
            f.expandAABB3(aabb, model.aabb);
        }
        if (done) {
            viewer.cameraFlight.flyTo({
                aabb: aabb
            }, () => {
                done();
                setTimeout(function () {
                    scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                }, 500);
            });
        } else {
            viewer.cameraFlight.jumpTo({
                aabb: aabb
            });
            setTimeout(function () {
                scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
            }, 500);
        }
        viewer.cameraControl.pivotPos = f.getAABB3Center(aabb);
    }

    /**
     * Opens the specified viewer tab.
     *
     * The available tabs are:
     *
     *  * "models" - the Models tab, which lists the models available within the currently loaded project,
     *  * "objects" - the Objects tab, which contains a tree view for each loaded model, organized to indicate the containment hierarchy of their objects,
     *  * "classes" - the Classes tab, which contains a tree view for each loaded model, with nodes grouped by IFC types of their objects,
     *  * "storeys" - the Storeys tab, which contains a tree view for each loaded model, with nodes grouped within ````IfcBuildingStoreys````, sub-grouped by their IFC types, and
     *  * "properties" - the Properties tab, which shows property sets for a given object.
     *
     * @param {String} tabId ID of the tab to open - see method description.
     */
    openTab(tabId) {
        if (!tabId) {
            this.error("openTab() - Argument expected: tabId");
            return;
        }
        let tabSelector;
        switch (tabId) {
            case "models":
                tabSelector = "xeokit-modelsTab";
                break;
            case "objects":
                tabSelector = "xeokit-objectsTab";
                break;
            case "classes":
                tabSelector = "xeokit-classesTab";
                break;
            case "storeys":
                tabSelector = "xeokit-storeysTab";
                break;
            case "properties":
                tabSelector = "xeokit-propertiesTab";
                break;
            default:
                this.error("openTab() - tab not recognized: '" + tabId + "'");
                return;
        }
        this._openTab(this._explorerElement, tabSelector);
        //     this._openTab(this._inspectorElement, tabSelector);
    }

    _openTab(element, tabSelector) {
        const tabClass = 'xeokit-tab';
        const activeClass = 'active';
        let tabs = element.querySelectorAll("." + tabClass);
        let tab = element.querySelector("." + tabSelector);
        for (let i = 0; i < tabs.length; i++) {
            let tabElement = tabs[i];
            if (tabElement.isEqualNode(tab)) {
                tabElement.classList.add(activeClass);
            } else {
                tabElement.classList.remove(activeClass);
            }
        }
    }

    /**
     * Returns the ID of the currently open viewer tab.
     *
     * The available tabs are:
     *
     *  * "models" - the Models tab, which lists the models available within the currently loaded project,
     *  * "objects" - the Objects tab, which contains a tree view for each loaded model, organized to indicate the containment hierarchy of their objects,
     *  * "classes" - the Classes tab, which contains a tree view for each loaded model, with nodes grouped by IFC types of their objects,
     *  * "storeys" - the Storeys tab, which contains a tree view for each loaded model, with nodes grouped within ````IfcBuildingStoreys````, sub-grouped by their IFC types,
     *  * "properties" - the Properties tab, which shows property sets for a given object, and
     *  * "none" - no tab is open; this is unlikely, since one of the above tabs should be open at a any time, but here for robustness.
     */
    getOpenTab() {
        function hasClass(element, className) {
            if (!element) {
                return false;
            }
            return (" " + element.className + " ").indexOf(" " + className + " ") > -1;
        }

        const activeClass = 'active';
        let modelsTab = this._explorerElement.querySelector(".xeokit-modelsTab");
        if (hasClass(modelsTab, activeClass)) {
            return "models";
        }
        let objectsTab = this._explorerElement.querySelector(".xeokit-objectsTab");
        if (hasClass(objectsTab, activeClass)) {
            return "objects";
        }
        let classesTab = this._explorerElement.querySelector(".xeokit-classesTab");
        if (hasClass(classesTab, activeClass)) {
            return "classes";
        }
        let storeysTab = this._explorerElement.querySelector(".xeokit-storeysTab");
        if (hasClass(storeysTab, activeClass)) {
            return "storeys";
        }
        let propertiesTab = this._inspectorElement.querySelector(".xeokit-propertiesTab");
        if (hasClass(propertiesTab, activeClass)) {
            return "properties";
        }
        return "none";
    }

    /**
     * Switches the viewer between 2D and 3D viewing modes.
     *
     * @param {Boolean} enabled Set true to switch into 3D mode, else false to switch into 2D mode.
     * @param {Function} done Callback to invoke when switch complete. Supplying this callback causes an animated transition. Otherwise, the transition will be instant.
     */
    set3DEnabled(enabled, done) {
        this._threeDMode.setActive(enabled, done);
    }

    /**
     * Gets whether the viewer is in 3D or 2D viewing mode.
     *
     * @returns {boolean} True when in 3D mode, else false.
     */
    get3DEnabled() {
        return this._threeDMode.getActive();
    }

    /**
     * Sets whether IFCSpace types are ever shown.
     *
     * @param {Boolean} shown Set true to allow IFCSpaces to be shown, else false to always keep them hidden.
     */
    setSpacesShown(shown) {
        this._showSpacesMode.setActive(shown);
    }

    /**
     * Gets whether the viewer allows IFCSpace types to be shown.
     *
     * @returns {boolean} True to allow IFCSpaces to be shown, else false to always keep them hidden.
     */
    getSpacesShown() {
        return this._showSpacesMode.getActive();
    }

    /**
     * Sets whether the viewer is in orthographic viewing mode.
     *
     * The viewer is either in orthographic mode or perspective mode. The viewer is in perspective mode by default.
     *
     * @param {Boolean} enabled Set true to switch into ortho mode, else false to switch into perspective mode.
     * @param {Function} done Callback to invoke when switch complete. Supplying this callback causes an animated transition. Otherwise, the transition will be instant.
     */
    setOrthoEnabled(enabled, done) {
        this._orthoMode.setActive(enabled, done);
    }

    /**
     * Gets whether the viewer is in orthographic viewing mode.
     *
     * The viewer is either in orthographic mode or perspective mode. The viewer is in perspective mode by default.
     *
     * @returns {boolean} True when in ortho mode, else false when in perspective mode.
     */
    getOrthoEnabled() {
        return this._orthoMode.getActive();
    }

    /**
     * Transitions the viewer into an isolated view of the given building storey.
     *
     * Does nothing and logs an error if no object of the given ID is in the viewer, or if the object is not an ````IfcBuildingStorey````.
     *
     * @param {String} storeyObjectId ID of an ````IfcBuildingStorey```` object.
     * @param {Function} [done] Optional callback to invoke on completion. When provided, the transition will be animated, with the camera flying into position. Otherwise, the transition will be instant, with the camera jumping into position.
     */
    selectStorey(storeyObjectId, done) {
        const metaScene = this.viewer.metaScene;
        const storeyMetaObject = metaScene.metaObjects[storeyObjectId];
        if (!storeyMetaObject) {
            this.error("selectStorey() - Object is not found: '" + storeyObjectId + "'");
            return;
        }
        if (storeyMetaObject.type !== "IfcBuildingStorey") {
            this.error("selectStorey() - Object is not an IfcBuildingStorey: '" + storeyObjectId + "'");
            return;
        }
        this._storeysExplorer.selectStorey(storeyObjectId, done);
    }

    /**
     * Saves viewer state to a BCF viewpoint.
     *
     * This does not save information about the project and model(s) that are currently loaded. When loading the viewpoint,
     * the viewer will assume that the same project and models will be currently loaded (the BCF viewpoint specification
     * does not contain that information).
     *
     * Note that xeokit's {@link Camera#look} is the **point-of-interest**, whereas the BCF ````camera_direction```` is a
     * direction vector. Therefore, we save ````camera_direction```` as the vector from {@link Camera#eye} to {@link Camera#look}.
     *
     * @param {*} [options] Options for getting the viewpoint.
     * @param {Boolean} [options.spacesVisible=false] Indicates whether ````IfcSpace```` types should be forced visible in the viewpoint.
     * @param {Boolean} [options.openingsVisible=false] Indicates whether ````IfcOpening```` types should be forced visible in the viewpoint.
     * @param {Boolean} [options.spaceBoundariesVisible=false] Indicates whether the boundaries of ````IfcSpace```` types should be visible in the viewpoint.
     * @param {Boolean} [options.reverseClippingPlanes=false] When ````true````, clipping planes are reversed (https://github.com/buildingSMART/BCF-XML/issues/193)
     * @param {Boolean} [options.defaultInvisible=false] When ````true````, will save the default visibility of all objects
     * as ````false````. This means that when we load the viewpoint again, and there are additional models loaded that
     * were not saved in the viewpoint, those models will be hidden when we load the viewpoint, and that only the
     * objects in the viewpoint will be visible.
     * @returns {*} BCF JSON viewpoint object
     * @example
     *
     * const viewpoint = bimViewer.saveBCFViewpoint({
     *     spacesVisible: false,          // Default
     *     spaceBoundariesVisible: false, // Default
     *     openingsVisible: false         // Default
     * });
     *
     * // viewpoint will resemble the following:
     *
     * {
     *     perspective_camera: {
     *         camera_view_point: {
     *             x: 0.0,
     *             y: 0.0,
     *             z: 0.0
     *         },
     *         camera_direction: {
     *             x: 1.0,
     *             y: 1.0,
     *             z: 2.0
     *         },
     *         camera_up_vector: {
     *             x: 0.0,
     *             y: 0.0,
     *             z: 1.0
     *         },
     *         field_of_view: 90.0
     *     },
     *     lines: [],
     *     clipping_planes: [{
     *         location: {
     *             x: 0.5,
     *             y: 0.5,
     *             z: 0.5
     *         },
     *         direction: {
     *             x: 1.0,
     *             y: 0.0,
     *             z: 0.0
     *         }
     *     }],
     *     bitmaps: [],
     *     snapshot: {
     *         snapshot_type: png,
     *         snapshot_data: "data:image/png;base64,......"
     *     },
     *     components: {
     *         visibility: {
     *             default_visibility: false,
     *             exceptions: [{
     *                 ifc_guid: 4$cshxZO9AJBebsni$z9Yk,
     *                 originating_system: xeokit.io,
     *                 authoring_tool_id: xeokit/v1.0
     *             }]
     *        },
     *         selection: [{
     *            ifc_guid: "4$cshxZO9AJBebsni$z9Yk",
     *         }]
     *     }
     * }
     */
    saveBCFViewpoint(options) {
        return this._bcfViewpointsPlugin.getViewpoint(options);
    }

    /**
     * Sets viewer state to the given BCF viewpoint.
     *
     * This assumes that the viewer currently contains the same project and model(s) that were loaded at the time that the
     * viewpoint was originally saved (the BCF viewpoint specification does not contain that information).
     *
     * Note that xeokit's {@link Camera#look} is the **point-of-interest**, whereas the BCF ````camera_direction```` is a
     * direction vector. Therefore, when loading a BCF viewpoint, we set {@link Camera#look} to the absolute position
     * obtained by offsetting the BCF ````camera_view_point````  along ````camera_direction````.
     *
     * When loading a viewpoint, we also have the option to find {@link Camera#look} as the closest point of intersection
     * (on the surface of any visible and pickable {@link Entity}) with a 3D ray fired from ````camera_view_point```` in
     * the direction of ````camera_direction````.
     *
     * @param {*} bcfViewpoint  BCF JSON viewpoint object or "reset" / "RESET" to reset the viewer, which clears SectionPlanes,
     * shows default visible entities and restores camera to initial default position.
     * @param {*} [options] Options for setting the viewpoint.
     * @param {Boolean} [options.rayCast=true] When ````true```` (default), will attempt to set {@link Camera#look} to the closest
     * point of surface intersection with a ray fired from the BCF ````camera_view_point```` in the direction of ````camera_direction````.
     * @param {Boolean} [options.immediate=true] When ````true```` (default), immediately set camera position.
     * @param {Boolean} [options.duration] Flight duration in seconds.  Overrides {@link CameraFlightAnimation#duration}.
     * @param {Boolean} [options.reset=true] When ````true```` (default), set {@link Entity#xrayed} and {@link Entity#highlighted} ````false```` on all scene objects.
     * @param {Boolean} [options.reverseClippingPlanes=false] When ````true````, clipping planes are reversed (https://github.com/buildingSMART/BCF-XML/issues/193)
     * @param {Boolean} [options.updateCompositeObjects=false] When ````true````, then when visibility and selection updates refer to composite objects (eg. an IfcBuildingStorey),
     * then this method will apply the updates to objects within those composites.
     */
    loadBCFViewpoint(bcfViewpoint, options) {
        if (!bcfViewpoint) {
            this.error("loadBCFViewpoint() - Argument expected: bcfViewpoint");
            return;
        }
        this._orthoMode.setActive(this.viewer.camera.projection === "ortho");
        this._bcfViewpointsPlugin.setViewpoint(bcfViewpoint, options);
    }

    /**
     * Resets the view.
     *
     * This resets object appearances (visibility, selection, highlight and X-ray), sets camera to
     * default position, and removes section planes.
     */
    resetView() {
        this._resetAction.reset();
    }

    /**
     * Enables or disables the various buttons and controls throughout the viewer.
     *
     * This also makes various buttons appear disabled.
     *
     * @param {Boolean} enabled Whether or not to disable the controls.
     */
    setControlsEnabled(enabled) {

        // Explorer

        // Models tab is always enabled
        this._objectsExplorer.setEnabled(enabled);
        this._classesExplorer.setEnabled(enabled);
        this._storeysExplorer.setEnabled(enabled);

        // Toolbar

        this._resetAction.setEnabled(enabled);
        this._fitAction.setEnabled(enabled);
        this._threeDMode.setEnabled(enabled);
        this._orthoMode.setEnabled(enabled);
        this._firstPersonMode.setEnabled(enabled);
        this._queryTool.setEnabled(enabled);
        this._hideTool.setEnabled(enabled);
        this._selectionTool.setEnabled(enabled);
        this._showSpacesMode.setEnabled(enabled);
        this._sectionTool.setEnabled(enabled);

        //
        if (this._enablePropertiesInspector) {
            this._propertiesInspector.setEnabled(enabled);
        }
    }

    /**
     * Sets whether or not keyboard camera control is enabled.
     *
     * This is useful when we don't want key events over the canvas to clash with other UI elements outside the canvas.
     *
     * Default value is ````true````.
     *
     * @param {Boolean} enabled Set ````true```` to enable keyboard input.
     */
    setKeyboardEnabled(enabled) {
        this.viewer.scene.input.keyboardEnabled = enabled;
    }

    /**
     * Gets whether keyboard camera control is enabled.
     *
     * This is useful when we don't want key events over the canvas to clash with other UI elements outside the canvas.
     *
     * Default value is ````true````.
     *
     * @returns {Boolean} Returns ````true```` if keyboard input is enabled.
     */
    getKeyboardEnabled() {
        return this.viewer.scene.input.keyboardEnabled;
    }

    /**
     * Clears sections.
     *
     * Sections are the slicing planes, that we use to section models in order to see interior structures.
     */
    clearSections() {
        this._sectionTool.clear();
    }


    /**
     * Inverts the direction of sections.
     */
    flipSections() {
        this._sectionTool.flipSections();
    }

    /**
     * Hides the section edition control, if currently shown.
     */
    hideSectionEditControl() {
        this._sectionTool.hideControl();
    }

    /**
     * Returns the number of sections that currently exist.
     *
     * sections are the sliceing planes, that we use to slice models in order to see interior structures.
     *
     * @returns {Number} The number of sections.
     */
    getNumSections() {
        return this._sectionTool.getNumSections();
    }

    /**
     * Destroys the viewer, freeing all resources.
     */
    destroy() {
        this.viewer.destroy();
        this._bcfViewpointsPlugin.destroy();
        this._canvasContextMenu.destroy();
        this._objectContextMenu.destroy();
    }
}

// export { BIMViewer, jE as LocaleService, Server };
